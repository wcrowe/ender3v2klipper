var vg=Object.defineProperty;var xg=(a,e,t)=>e in a?vg(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t;var Gt=(a,e,t)=>(xg(a,typeof e!="symbol"?e+"":e,t),t);import{b1 as Hp,b2 as Xp,bx as Tg,by as bg,bz as Sg,bA as Eg,bB as Cg,bC as yg,bD as Ag,bE as Rg,bF as Ig,bG as Pg,bH as Mg,bI as Dg,bJ as Og,bK as V0,bd as $t,bL as Yp,be as Kp,bf as $p,bM as wg,bN as jp,bi as ss,bj as Sr,bk as k0,bg as dh,bh as pa,bp as Ng,bO as Fg,bP as G0,bQ as Lg,bR as Bg,bS as yn,bn as An,bo as Ug,bT as z0,bU as Tu,bs as Vg,bV as kg,bW as Gg,bX as zg,bu as Wg,bv as Hg,bw as qp}from"./index.244641ff.js";class Qp{constructor(e,t=!1,i,s){this.initialize(e,t,i,s)}initialize(e,t=!1,i,s){return this.mask=e,this.skipNextObservers=t,this.target=i,this.currentTarget=s,this}}class Xg{constructor(e,t,i=null){this.callback=e,this.mask=t,this.scope=i,this._willBeUnregistered=!1,this.unregisterOnNextCall=!1}}class X{constructor(e){this._observers=new Array,this._eventState=new Qp(0),e&&(this._onObserverAdded=e)}static FromPromise(e,t){const i=new X;return e.then(s=>{i.notifyObservers(s)}).catch(s=>{if(t)t.notifyObservers(s);else throw s}),i}get observers(){return this._observers}add(e,t=-1,i=!1,s=null,r=!1){if(!e)return null;const n=new Xg(e,t,s);return n.unregisterOnNextCall=r,i?this._observers.unshift(n):this._observers.push(n),this._onObserverAdded&&this._onObserverAdded(n),n}addOnce(e){return this.add(e,void 0,void 0,void 0,!0)}remove(e){return e&&this._observers.indexOf(e)!==-1?(this._deferUnregister(e),!0):!1}removeCallback(e,t){for(let i=0;i<this._observers.length;i++){const s=this._observers[i];if(!s._willBeUnregistered&&s.callback===e&&(!t||t===s.scope))return this._deferUnregister(s),!0}return!1}_deferUnregister(e){e.unregisterOnNextCall=!1,e._willBeUnregistered=!0,setTimeout(()=>{this._remove(e)},0)}_remove(e){if(!e)return!1;const t=this._observers.indexOf(e);return t!==-1?(this._observers.splice(t,1),!0):!1}makeObserverTopPriority(e){this._remove(e),this._observers.unshift(e)}makeObserverBottomPriority(e){this._remove(e),this._observers.push(e)}notifyObservers(e,t=-1,i,s,r){if(!this._observers.length)return!0;const n=this._eventState;n.mask=t,n.target=i,n.currentTarget=s,n.skipNextObservers=!1,n.lastReturnValue=e,n.userInfo=r;for(const o of this._observers)if(!o._willBeUnregistered&&(o.mask&t&&(o.scope?n.lastReturnValue=o.callback.apply(o.scope,[e,n]):n.lastReturnValue=o.callback(e,n),o.unregisterOnNextCall&&this._deferUnregister(o)),n.skipNextObservers))return!1;return!0}notifyObserver(e,t,i=-1){if(e._willBeUnregistered)return;const s=this._eventState;s.mask=i,s.skipNextObservers=!1,e.callback(t,s),e.unregisterOnNextCall&&this._deferUnregister(e)}hasObservers(){return this._observers.length>0}clear(){this._observers=new Array,this._onObserverAdded=null}clone(){const e=new X;return e._observers=this._observers.slice(0),e}hasSpecificMask(e=-1){for(const t of this._observers)if(t.mask&e||t.mask===e)return!0;return!1}}class Zp{constructor(){this.samplingMode=-1,this._useMipMaps=!0,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this._comparisonFunction=0}get wrapU(){return this._cachedWrapU}set wrapU(e){this._cachedWrapU=e}get wrapV(){return this._cachedWrapV}set wrapV(e){this._cachedWrapV=e}get wrapR(){return this._cachedWrapR}set wrapR(e){this._cachedWrapR=e}get anisotropicFilteringLevel(){return this._cachedAnisotropicFilteringLevel}set anisotropicFilteringLevel(e){this._cachedAnisotropicFilteringLevel=e}get comparisonFunction(){return this._comparisonFunction}set comparisonFunction(e){this._comparisonFunction=e}get useMipMaps(){return this._useMipMaps}set useMipMaps(e){this._useMipMaps=e}setParameters(e=1,t=1,i=1,s=1,r=2,n=0){return this._cachedWrapU=e,this._cachedWrapV=t,this._cachedWrapR=i,this._cachedAnisotropicFilteringLevel=s,this.samplingMode=r,this._comparisonFunction=n,this}compareSampler(e){return this._cachedWrapU===e._cachedWrapU&&this._cachedWrapV===e._cachedWrapV&&this._cachedWrapR===e._cachedWrapR&&this._cachedAnisotropicFilteringLevel===e._cachedAnisotropicFilteringLevel&&this.samplingMode===e.samplingMode&&this._comparisonFunction===e._comparisonFunction&&this._useMipMaps===e._useMipMaps}}var We;(function(a){a[a.Unknown=0]="Unknown",a[a.Url=1]="Url",a[a.Temp=2]="Temp",a[a.Raw=3]="Raw",a[a.Dynamic=4]="Dynamic",a[a.RenderTarget=5]="RenderTarget",a[a.MultiRenderTarget=6]="MultiRenderTarget",a[a.Cube=7]="Cube",a[a.CubeRaw=8]="CubeRaw",a[a.CubePrefiltered=9]="CubePrefiltered",a[a.Raw3D=10]="Raw3D",a[a.Raw2DArray=11]="Raw2DArray",a[a.DepthStencil=12]="DepthStencil",a[a.CubeRawRGBD=13]="CubeRawRGBD",a[a.Depth=14]="Depth"})(We||(We={}));class gt extends Zp{constructor(e,t,i=!1){super(),this.isReady=!1,this.isCube=!1,this.is3D=!1,this.is2DArray=!1,this.isMultiview=!1,this.url="",this.generateMipMaps=!1,this.samples=0,this.type=-1,this.format=-1,this.onLoadedObservable=new X,this.onErrorObservable=new X,this.onRebuildCallback=null,this.width=0,this.height=0,this.depth=0,this.baseWidth=0,this.baseHeight=0,this.baseDepth=0,this.invertY=!1,this._invertVScale=!1,this._associatedChannel=-1,this._source=We.Unknown,this._buffer=null,this._bufferView=null,this._bufferViewArray=null,this._bufferViewArrayArray=null,this._size=0,this._extension="",this._files=null,this._workingCanvas=null,this._workingContext=null,this._cachedCoordinatesMode=null,this._isDisabled=!1,this._compression=null,this._sphericalPolynomial=null,this._sphericalPolynomialPromise=null,this._sphericalPolynomialComputed=!1,this._lodGenerationScale=0,this._lodGenerationOffset=0,this._useSRGBBuffer=!1,this._lodTextureHigh=null,this._lodTextureMid=null,this._lodTextureLow=null,this._isRGBD=!1,this._linearSpecularLOD=!1,this._irradianceTexture=null,this._hardwareTexture=null,this._maxLodLevel=null,this._references=1,this._gammaSpace=null,this._engine=e,this._source=t,this._uniqueId=gt._Counter++,i||(this._hardwareTexture=e._createHardwareTexture())}get useMipMaps(){return this.generateMipMaps}set useMipMaps(e){this.generateMipMaps=e}get uniqueId(){return this._uniqueId}getEngine(){return this._engine}get source(){return this._source}incrementReferences(){this._references++}updateSize(e,t,i=1){this._engine.updateTextureDimensions(this,e,t,i),this.width=e,this.height=t,this.depth=i,this.baseWidth=e,this.baseHeight=t,this.baseDepth=i,this._size=e*t*i}_rebuild(){var e;if(this.isReady=!1,this._cachedCoordinatesMode=null,this._cachedWrapU=null,this._cachedWrapV=null,this._cachedWrapR=null,this._cachedAnisotropicFilteringLevel=null,this.onRebuildCallback){const i=this.onRebuildCallback(this),s=r=>{r._swapAndDie(this,!1),this.isReady=i.isReady};i.isAsync?i.proxy.then(s):s(i.proxy);return}let t;switch(this.source){case We.Temp:break;case We.Url:t=this._engine.createTexture((e=this._originalUrl)!==null&&e!==void 0?e:this.url,!this.generateMipMaps,this.invertY,null,this.samplingMode,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this._buffer,void 0,this.format,this._extension,void 0,void 0,void 0,this._useSRGBBuffer);return;case We.Raw:t=this._engine.createRawTexture(this._bufferView,this.baseWidth,this.baseHeight,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type,void 0,this._useSRGBBuffer),t._swapAndDie(this,!1),this.isReady=!0;break;case We.Raw3D:t=this._engine.createRawTexture3D(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case We.Raw2DArray:t=this._engine.createRawTexture2DArray(this._bufferView,this.baseWidth,this.baseHeight,this.baseDepth,this.format,this.generateMipMaps,this.invertY,this.samplingMode,this._compression,this.type),t._swapAndDie(this,!1),this.isReady=!0;break;case We.Dynamic:t=this._engine.createDynamicTexture(this.baseWidth,this.baseHeight,this.generateMipMaps,this.samplingMode),t._swapAndDie(this,!1),this._engine.updateDynamicTexture(this,this._engine.getRenderingCanvas(),this.invertY,void 0,void 0,!0);break;case We.Cube:t=this._engine.createCubeTexture(this.url,null,this._files,!this.generateMipMaps,()=>{t._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension,!1,0,0,null,void 0,this._useSRGBBuffer);return;case We.CubeRaw:t=this._engine.createRawCubeTexture(this._bufferViewArray,this.width,this.format,this.type,this.generateMipMaps,this.invertY,this.samplingMode,this._compression),t._swapAndDie(this,!1),this.isReady=!0;break;case We.CubeRawRGBD:return;case We.CubePrefiltered:t=this._engine.createPrefilteredCubeTexture(this.url,null,this._lodGenerationScale,this._lodGenerationOffset,i=>{i&&i._swapAndDie(this,!1),this.isReady=!0},null,this.format,this._extension),t._sphericalPolynomial=this._sphericalPolynomial;return}}_swapAndDie(e,t=!0){var i;(i=this._hardwareTexture)===null||i===void 0||i.setUsage(e._source,this.generateMipMaps,this.isCube,this.width,this.height),e._hardwareTexture=this._hardwareTexture,t&&(e._isRGBD=this._isRGBD),this._lodTextureHigh&&(e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureHigh=this._lodTextureHigh),this._lodTextureMid&&(e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureMid=this._lodTextureMid),this._lodTextureLow&&(e._lodTextureLow&&e._lodTextureLow.dispose(),e._lodTextureLow=this._lodTextureLow),this._irradianceTexture&&(e._irradianceTexture&&e._irradianceTexture.dispose(),e._irradianceTexture=this._irradianceTexture);const s=this._engine.getLoadedTexturesCache();let r=s.indexOf(this);r!==-1&&s.splice(r,1),r=s.indexOf(e),r===-1&&s.push(e)}dispose(){this._references--,this.onLoadedObservable.clear(),this.onErrorObservable.clear(),this._references===0&&(this._engine._releaseTexture(this),this._hardwareTexture=null)}}gt._Counter=0;function Ht(){return typeof window<"u"}function Jp(){return typeof navigator<"u"}function Bh(){return typeof document<"u"}function _c(a){let e="",t=a.firstChild;for(;t;)t.nodeType===3&&(e+=t.textContent),t=t.nextSibling;return e}const Ku={IsWindowObjectExist:Ht,IsNavigatorAvailable:Jp,IsDocumentAvailable:Bh,GetDOMTextContent:_c};class ye{static get LastCreatedEngine(){return this.Instances.length===0?null:this.Instances[this.Instances.length-1]}static get LastCreatedScene(){return this._LastCreatedScene}}ye.Instances=new Array;ye._LastCreatedScene=null;ye.UseFallbackTexture=!0;ye.FallbackTexture="";function Ve(a){return`${a} needs to be imported before as it contains a side-effect required by your code.`}class B{static _CheckLimit(e,t){let i=B._LogLimitOutputs[e];return i?i.current++:(i={limit:t,current:1},B._LogLimitOutputs[e]=i),i.current<=i.limit}static _GenerateLimitMessage(e,t=1){var i;const s=B._LogLimitOutputs[e];if(!s||!B.MessageLimitReached)return;const r=this._Levels[t];s.current===s.limit&&B[r.name](B.MessageLimitReached.replace(/%LIMIT%/g,""+s.limit).replace(/%TYPE%/g,(i=r.name)!==null&&i!==void 0?i:""))}static _AddLogEntry(e){B._LogCache=e+B._LogCache,B.OnNewCacheEntry&&B.OnNewCacheEntry(e)}static _FormatMessage(e){const t=s=>s<10?"0"+s:""+s,i=new Date;return"["+t(i.getHours())+":"+t(i.getMinutes())+":"+t(i.getSeconds())+"]: "+e}static _LogDisabled(e,t){}static _LogEnabled(e=1,t,i){if(i!==void 0&&!B._CheckLimit(t,i))return;const s=B._FormatMessage(t),r=this._Levels[e];r.logFunc&&r.logFunc("BJS - "+s);const n=`<div style='color:${r.color}'>${s}</div><br>`;B._AddLogEntry(n),B._GenerateLimitMessage(t,e)}static get LogCache(){return B._LogCache}static ClearLogCache(){B._LogCache="",B._LogLimitOutputs={},B.errorsCount=0}static set LogLevels(e){B.Log=B._LogDisabled,B.Warn=B._LogDisabled,B.Error=B._LogDisabled,[B.MessageLogLevel,B.WarningLogLevel,B.ErrorLogLevel].forEach(t=>{if((e&t)===t){const i=this._Levels[t];B[i.name]=B._LogEnabled.bind(B,t)}})}}B.NoneLogLevel=0;B.MessageLogLevel=1;B.WarningLogLevel=2;B.ErrorLogLevel=4;B.AllLogLevel=7;B.MessageLimitReached="Too many %TYPE%s (%LIMIT%), no more %TYPE%s will be reported for this message.";B._LogCache="";B._LogLimitOutputs={};B._Levels=[{},{color:"white",logFunc:console.log,name:"Log"},{color:"orange",logFunc:console.warn,name:"Warn"},{},{color:"red",logFunc:console.error,name:"Error"}];B.errorsCount=0;B.Log=B._LogEnabled.bind(B,B.MessageLogLevel);B.Warn=B._LogEnabled.bind(B,B.WarningLogLevel);B.Error=B._LogEnabled.bind(B,B.ErrorLogLevel);class rl{constructor(){this.children=[]}isValid(e){return!0}process(e,t){let i="";if(this.line){let s=this.line;const r=t.processor;r&&(r.lineProcessor&&(s=r.lineProcessor(s,t.isFragment,t.processingContext)),r.attributeProcessor&&this.line.startsWith("attribute")?s=r.attributeProcessor(this.line,e,t.processingContext):r.varyingProcessor&&this.line.startsWith("varying")?s=r.varyingProcessor(this.line,t.isFragment,e,t.processingContext):r.uniformProcessor&&r.uniformRegexp&&r.uniformRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(s=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&r.uniformBufferRegexp&&r.uniformBufferRegexp.test(this.line)?t.lookForClosingBracketForUniformBuffer||(s=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0):r.textureProcessor&&r.textureRegexp&&r.textureRegexp.test(this.line)?s=r.textureProcessor(this.line,t.isFragment,e,t.processingContext):(r.uniformProcessor||r.uniformBufferProcessor)&&this.line.startsWith("uniform")&&!t.lookForClosingBracketForUniformBuffer&&(/uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/.test(this.line)?r.uniformProcessor&&(s=r.uniformProcessor(this.line,t.isFragment,e,t.processingContext)):r.uniformBufferProcessor&&(s=r.uniformBufferProcessor(this.line,t.isFragment,t.processingContext),t.lookForClosingBracketForUniformBuffer=!0)),t.lookForClosingBracketForUniformBuffer&&this.line.indexOf("}")!==-1&&(t.lookForClosingBracketForUniformBuffer=!1,r.endOfUniformBufferProcessor&&(s=r.endOfUniformBufferProcessor(this.line,t.isFragment,t.processingContext)))),i+=s+`\r
`}return this.children.forEach(s=>{i+=s.process(e,t)}),this.additionalDefineKey&&(e[this.additionalDefineKey]=this.additionalDefineValue||"true"),i}}class Yg{constructor(){this._lines=[]}get currentLine(){return this._lines[this.lineIndex]}get canRead(){return this.lineIndex<this._lines.length-1}set lines(e){this._lines.length=0;for(const t of e){if(t[0]==="#"){this._lines.push(t);continue}if(t.trim().startsWith("//")){this._lines.push(t);continue}const i=t.split(";");for(let s=0;s<i.length;s++){let r=i[s];r=r.trim(),r&&this._lines.push(r+(s!==i.length-1?";":""))}}}}class bu extends rl{process(e,t){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.isValid(e))return s.process(e,t)}return""}}class Kg extends rl{isValid(e){return this.testExpression.isTrue(e)}}class xs{isTrue(e){return!0}static postfixToInfix(e){const t=[];for(const i of e)if(xs._OperatorPriority[i]===void 0)t.push(i);else{const s=t[t.length-1],r=t[t.length-2];t.length-=2,t.push(`(${r}${i}${s})`)}return t[t.length-1]}static infixToPostfix(e){const t=[];let i=-1;const s=()=>{h=h.trim(),h!==""&&(t.push(h),h="")},r=c=>{i<xs._Stack.length-1&&(xs._Stack[++i]=c)},n=()=>xs._Stack[i],o=()=>i===-1?"!!INVALID EXPRESSION!!":xs._Stack[i--];let l=0,h="";for(;l<e.length;){const c=e.charAt(l),u=l<e.length-1?e.substr(l,2):"";if(c==="(")h="",r(c);else if(c===")"){for(s();i!==-1&&n()!=="(";)t.push(o());o()}else if(xs._OperatorPriority[u]>1){for(s();i!==-1&&xs._OperatorPriority[n()]>=xs._OperatorPriority[u];)t.push(o());r(u),l++}else h+=c;l++}for(s();i!==-1;)n()==="("?o():t.push(o());return t}}xs._OperatorPriority={")":0,"(":1,"||":2,"&&":3};xs._Stack=["","","","","","","","","","","","","","","","","","","",""];class fh extends xs{constructor(e,t=!1){super(),this.define=e,this.not=t}isTrue(e){let t=e[this.define]!==void 0;return this.not&&(t=!t),t}}class $g extends xs{isTrue(e){return this.leftOperand.isTrue(e)||this.rightOperand.isTrue(e)}}class jg extends xs{isTrue(e){return this.leftOperand.isTrue(e)&&this.rightOperand.isTrue(e)}}class qg extends xs{constructor(e,t,i){super(),this.define=e,this.operand=t,this.testValue=i}isTrue(e){let t=e[this.define];t===void 0&&(t=this.define);let i=!1;const s=parseInt(t),r=parseInt(this.testValue);switch(this.operand){case">":i=s>r;break;case"<":i=s<r;break;case"<=":i=s<=r;break;case">=":i=s>=r;break;case"==":i=s===r;break}return i}}var Xt;(function(a){a[a.GLSL=0]="GLSL",a[a.WGSL=1]="WGSL"})(Xt||(Xt={}));const Qg=/defined\s*?\((.+?)\)/g,Su=/defined\s*?\[(.+?)\]/g,W0=/#include\s?<(.+)>(\((.*)\))*(\[(.*)\])*/g;class kr{static Initialize(e){e.processor&&e.processor.initializeShaders&&e.processor.initializeShaders(e.processingContext)}static Process(e,t,i,s){var r;!((r=t.processor)===null||r===void 0)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const o=this._ProcessShaderConversion(n,t,s);i(o)})}static PreProcess(e,t,i,s){var r;!((r=t.processor)===null||r===void 0)&&r.preProcessShaderCode&&(e=t.processor.preProcessShaderCode(e,t.isFragment)),this._ProcessIncludes(e,t,n=>{t.processCodeAfterIncludes&&(n=t.processCodeAfterIncludes(t.isFragment?"fragment":"vertex",n));const o=this._ApplyPreProcessing(n,t,s);i(o)})}static Finalize(e,t,i){return!i.processor||!i.processor.finalizeShaders?{vertexCode:e,fragmentCode:t}:i.processor.finalizeShaders(e,t,i.processingContext)}static _ProcessPrecision(e,t){var i;if(!((i=t.processor)===null||i===void 0)&&i.noPrecision)return e;const s=t.shouldUseHighPrecisionShader;return e.indexOf("precision highp float")===-1?s?e=`precision highp float;
`+e:e=`precision mediump float;
`+e:s||(e=e.replace("precision highp float","precision mediump float")),e}static _ExtractOperation(e){const i=/defined\((.+)\)/.exec(e);if(i&&i.length)return new fh(i[1].trim(),e[0]==="!");const s=["==",">=","<=","<",">"];let r="",n=0;for(r of s)if(n=e.indexOf(r),n>-1)break;if(n===-1)return new fh(e);const o=e.substring(0,n).trim(),l=e.substring(n+r.length).trim();return new qg(o,r,l)}static _BuildSubExpression(e){e=e.replace(Qg,"defined[$1]");const t=xs.infixToPostfix(e),i=[];for(const r of t)if(r!=="||"&&r!=="&&")i.push(r);else if(i.length>=2){let n=i[i.length-1],o=i[i.length-2];i.length-=2;const l=r=="&&"?new jg:new $g;typeof n=="string"&&(n=n.replace(Su,"defined($1)")),typeof o=="string"&&(o=o.replace(Su,"defined($1)")),l.leftOperand=typeof o=="string"?this._ExtractOperation(o):o,l.rightOperand=typeof n=="string"?this._ExtractOperation(n):n,i.push(l)}let s=i[i.length-1];return typeof s=="string"&&(s=s.replace(Su,"defined($1)")),typeof s=="string"?this._ExtractOperation(s):s}static _BuildExpression(e,t){const i=new Kg,s=e.substring(0,t);let r=e.substring(t);return r=r.substring(0,(r.indexOf("//")+1||r.length+1)-1).trim(),s==="#ifdef"?i.testExpression=new fh(r):s==="#ifndef"?i.testExpression=new fh(r,!0):i.testExpression=this._BuildSubExpression(r),i}static _MoveCursorWithinIf(e,t,i){let s=e.currentLine;for(;this._MoveCursor(e,i);){s=e.currentLine;const r=s.substring(0,5).toLowerCase();if(r==="#else"){const n=new rl;t.children.push(n),this._MoveCursor(e,n);return}else if(r==="#elif"){const n=this._BuildExpression(s,5);t.children.push(n),i=n}}}static _MoveCursor(e,t){for(;e.canRead;){e.lineIndex++;const i=e.currentLine,r=/(#ifdef)|(#else)|(#elif)|(#endif)|(#ifndef)|(#if)/.exec(i);if(r&&r.length)switch(r[0]){case"#ifdef":{const o=new bu;t.children.push(o);const l=this._BuildExpression(i,6);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#else":case"#elif":return!0;case"#endif":return!1;case"#ifndef":{const o=new bu;t.children.push(o);const l=this._BuildExpression(i,7);o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}case"#if":{const o=new bu,l=this._BuildExpression(i,3);t.children.push(o),o.children.push(l),this._MoveCursorWithinIf(e,o,l);break}}else{const n=new rl;if(n.line=i,t.children.push(n),i[0]==="#"&&i[1]==="d"){const o=i.replace(";","").split(" ");n.additionalDefineKey=o[1],o.length===3&&(n.additionalDefineValue=o[2])}}}return!1}static _EvaluatePreProcessors(e,t,i){const s=new rl,r=new Yg;return r.lineIndex=-1,r.lines=e.split(`
`),this._MoveCursor(r,s),s.process(t,i)}static _PreparePreProcessors(e,t){var i;const s=e.defines,r={};for(const n of s){const l=n.replace("#define","").replace(";","").trim().split(" ");r[l[0]]=l.length>1?l[1]:""}return((i=e.processor)===null||i===void 0?void 0:i.shaderLanguage)===Xt.GLSL&&(r.GL_ES="true"),r.__VERSION__=e.version,r[e.platformName]="true",t._getGlobalDefines(r),r}static _ProcessShaderConversion(e,t,i){let s=this._ProcessPrecision(e,t);if(!t.processor)return s;if(t.processor.shaderLanguage===Xt.GLSL&&s.indexOf("#version 3")!==-1)return s.replace("#version 300 es","");const r=t.defines,n=this._PreparePreProcessors(t,i);return t.processor.preProcessor&&(s=t.processor.preProcessor(s,r,t.isFragment,t.processingContext)),s=this._EvaluatePreProcessors(s,n,t),t.processor.postProcessor&&(s=t.processor.postProcessor(s,r,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(s=i.inlineShaderCode(s)),s}static _ApplyPreProcessing(e,t,i){var s,r;let n=e;const o=t.defines,l=this._PreparePreProcessors(t,i);return!((s=t.processor)===null||s===void 0)&&s.preProcessor&&(n=t.processor.preProcessor(n,o,t.isFragment,t.processingContext)),n=this._EvaluatePreProcessors(n,l,t),!((r=t.processor)===null||r===void 0)&&r.postProcessor&&(n=t.processor.postProcessor(n,o,t.isFragment,t.processingContext,i)),i._features.needShaderCodeInlining&&(n=i.inlineShaderCode(n)),n}static _ProcessIncludes(e,t,i){let s=W0.exec(e),r=new String(e),n=!1;for(;s!=null;){let o=s[1];if(o.indexOf("__decl__")!==-1&&(o=o.replace(/__decl__/,""),t.supportsUniformBuffers&&(o=o.replace(/Vertex/,"Ubo"),o=o.replace(/Fragment/,"Ubo")),o=o+"Declaration"),t.includesShadersStore[o]){let l=t.includesShadersStore[o];if(s[2]){const h=s[3].split(",");for(let c=0;c<h.length;c+=2){const u=new RegExp(h[c],"g"),d=h[c+1];l=l.replace(u,d)}}if(s[4]){const h=s[5];if(h.indexOf("..")!==-1){const c=h.split(".."),u=parseInt(c[0]);let d=parseInt(c[1]),f=l.slice(0);l="",isNaN(d)&&(d=t.indexParameters[c[1]]);for(let p=u;p<d;p++)t.supportsUniformBuffers||(f=f.replace(/light\{X\}.(\w*)/g,(_,m)=>m+"{X}")),l+=f.replace(/\{X\}/g,p.toString())+`
`}else t.supportsUniformBuffers||(l=l.replace(/light\{X\}.(\w*)/g,(c,u)=>u+"{X}")),l=l.replace(/\{X\}/g,h)}r=r.replace(s[0],l),n=n||l.indexOf("#include<")>=0||l.indexOf("#include <")>=0}else{const l=t.shadersRepository+"ShadersInclude/"+o+".fx";kr._FileToolsLoadFile(l,h=>{t.includesShadersStore[o]=h,this._ProcessIncludes(r,t,i)});return}s=W0.exec(e)}n?this._ProcessIncludes(r.toString(),t,i):i(r)}static _FileToolsLoadFile(e,t,i,s,r,n){throw Ve("FileTools")}}class Y{static GetShadersRepository(e=Xt.GLSL){return e===Xt.GLSL?Y.ShadersRepository:Y.ShadersRepositoryWGSL}static GetShadersStore(e=Xt.GLSL){return e===Xt.GLSL?Y.ShadersStore:Y.ShadersStoreWGSL}static GetIncludesShadersStore(e=Xt.GLSL){return e===Xt.GLSL?Y.IncludesShadersStore:Y.IncludesShadersStoreWGSL}}Y.ShadersRepository="src/Shaders/";Y.ShadersStore={};Y.IncludesShadersStore={};Y.ShadersRepositoryWGSL="src/ShadersWGSL/";Y.ShadersStoreWGSL={};Y.IncludesShadersStoreWGSL={};class Rt{constructor(e,t,i,s=null,r,n=null,o=null,l=null,h=null,c,u="",d=Xt.GLSL){var f,p,_;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.onBind=null,this.uniqueId=0,this.onCompileObservable=new X,this.onErrorObservable=new X,this._onBindObservable=null,this._wasPreviouslyReady=!1,this._wasPreviouslyUsingInstances=null,this._isDisposed=!1,this._bonesComputationForcedToCPU=!1,this._uniformBuffersNames={},this._multiTarget=!1,this._samplers={},this._isReady=!1,this._compilationError="",this._allFallbacksProcessed=!1,this._uniforms={},this._key="",this._fallbacks=null,this._vertexSourceCodeOverride="",this._fragmentSourceCodeOverride="",this._transformFeedbackVaryings=null,this._pipelineContext=null,this._vertexSourceCode="",this._fragmentSourceCode="",this._rawVertexSourceCode="",this._rawFragmentSourceCode="",this.name=e,this._key=u;let m,v=null;if(t.attributes){const D=t;if(this._engine=i,this._attributesNames=D.attributes,this._uniformsNames=D.uniformsNames.concat(D.samplers),this._samplerList=D.samplers.slice(),this.defines=D.defines,this.onError=D.onError,this.onCompiled=D.onCompiled,this._fallbacks=D.fallbacks,this._indexParameters=D.indexParameters,this._transformFeedbackVaryings=D.transformFeedbackVaryings||null,this._multiTarget=!!D.multiTarget,this._shaderLanguage=(f=D.shaderLanguage)!==null&&f!==void 0?f:Xt.GLSL,D.uniformBuffersNames){this._uniformBuffersNamesList=D.uniformBuffersNames.slice();for(let P=0;P<D.uniformBuffersNames.length;P++)this._uniformBuffersNames[D.uniformBuffersNames[P]]=P}v=(p=D.processFinalCode)!==null&&p!==void 0?p:null,m=(_=D.processCodeAfterIncludes)!==null&&_!==void 0?_:void 0}else this._engine=r,this.defines=n==null?"":n,this._uniformsNames=i.concat(s),this._samplerList=s?s.slice():[],this._attributesNames=t,this._uniformBuffersNamesList=[],this._shaderLanguage=d,this.onError=h,this.onCompiled=l,this._indexParameters=c,this._fallbacks=o;this._attributeLocationByName={},this.uniqueId=Rt._UniqueIdSeed++;let x,b;const S=Ht()?this._engine.getHostDocument():null;e.vertexSource?x="source:"+e.vertexSource:e.vertexElement?(x=S?S.getElementById(e.vertexElement):null,x||(x=e.vertexElement)):x=e.vertex||e,e.fragmentSource?b="source:"+e.fragmentSource:e.fragmentElement?(b=S?S.getElementById(e.fragmentElement):null,b||(b=e.fragmentElement)):b=e.fragment||e,this._processingContext=this._engine._getShaderProcessingContext(this._shaderLanguage);const C={defines:this.defines.split(`
`),indexParameters:this._indexParameters,isFragment:!1,shouldUseHighPrecisionShader:this._engine._shouldUseHighPrecisionShader,processor:this._engine._getShaderProcessor(this._shaderLanguage),supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:Y.GetShadersRepository(this._shaderLanguage),includesShadersStore:Y.GetIncludesShadersStore(this._shaderLanguage),version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:this._processingContext,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer,processCodeAfterIncludes:m},E=[void 0,void 0],A=()=>{if(E[0]&&E[1]){C.isFragment=!0;const[D,P]=E;kr.Process(P,C,O=>{v&&(O=v("fragment",O));const N=kr.Finalize(D,O,C);this._useFinalCode(N.vertexCode,N.fragmentCode,e)},this._engine)}};this._loadShader(x,"Vertex","",D=>{kr.Initialize(C),kr.Process(D,C,P=>{this._rawVertexSourceCode=D,v&&(P=v("vertex",P)),E[0]=P,A()},this._engine)}),this._loadShader(b,"Fragment","Pixel",D=>{this._rawFragmentSourceCode=D,E[1]=D,A()});const M=function(D){return function(){return this._pipelineContext&&this._pipelineContext[D].apply(this._pipelineContext,arguments),this}};["Int?","IntArray?","Array?","Color?","Vector?","Float?","Matrices","Matrix","Matrix3x3","Matrix2x2","Quaternion","DirectColor4"].forEach(D=>{const P=`set${D}`;P.endsWith("?")?["",2,3,4].forEach(O=>{this[P.slice(0,-1)+O]=this[P.slice(0,-1)+O]||M(P.slice(0,-1)+O).bind(this)}):this[P]=this[P]||M(P).bind(this)})}static get ShadersRepository(){return Y.ShadersRepository}static set ShadersRepository(e){Y.ShadersRepository=e}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new X),this._onBindObservable}_useFinalCode(e,t,i){if(i){const s=i.vertexElement||i.vertex||i.spectorName||i,r=i.fragmentElement||i.fragment||i.spectorName||i;this._vertexSourceCode=(this._shaderLanguage===Xt.WGSL?"//":"")+"#define SHADER_NAME vertex:"+s+`
`+e,this._fragmentSourceCode=(this._shaderLanguage===Xt.WGSL?"//":"")+"#define SHADER_NAME fragment:"+r+`
`+t}else this._vertexSourceCode=e,this._fragmentSourceCode=t;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getAttributesNames(){return this._attributesNames}getAttributeLocation(e){return this._attributes[e]}getAttributeLocationByName(e){return this._attributeLocationByName[e]}getAttributesCount(){return this._attributes.length}getUniformIndex(e){return this._uniformsNames.indexOf(e)}getUniform(e){return this._uniforms[e]}getSamplers(){return this._samplerList}getUniformNames(){return this._uniformsNames}getUniformBuffersNames(){return this._uniformBuffersNamesList}getIndexParameters(){return this._indexParameters}getCompilationError(){return this._compilationError}allFallbacksProcessed(){return this._allFallbacksProcessed}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}this._isDisposed||setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,s){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const o=_c(e);s(o);return}if(e.substr(0,7)==="source:"){s(e.substr(7));return}if(e.substr(0,7)==="base64:"){const o=window.atob(e.substr(7));s(o);return}const r=Y.GetShadersStore(this._shaderLanguage);if(r[e+t+"Shader"]){s(r[e+t+"Shader"]);return}if(i&&r[e+i+"Shader"]){s(r[e+i+"Shader"]);return}let n;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?n=e:n=Y.GetShadersRepository(this._shaderLanguage)+e,this._engine._loadFile(n+"."+t.toLowerCase()+".fx",s)}get vertexSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._vertexSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getVertexShaderCode())!==null&&t!==void 0?t:this._vertexSourceCode}get fragmentSourceCode(){var e,t;return this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?this._fragmentSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getFragmentShaderCode())!==null&&t!==void 0?t:this._fragmentSourceCode}get rawVertexSourceCode(){return this._rawVertexSourceCode}get rawFragmentSourceCode(){return this._rawFragmentSourceCode}_rebuildProgram(e,t,i,s){this._isReady=!1,this._vertexSourceCodeOverride=e,this._fragmentSourceCodeOverride=t,this.onError=(r,n)=>{s&&s(n)},this.onCompiled=()=>{const r=this.getEngine().scenes;if(r)for(let n=0;n<r.length;n++)r[n].markAllMaterialsAsDirty(63);this._pipelineContext._handlesSpectorRebuildCallback(i)},this._fallbacks=null,this._prepareEffect()}_prepareEffect(){const e=this._attributesNames,t=this.defines,i=this._pipelineContext;this._isReady=!1;try{const s=this._engine;this._pipelineContext=s.createPipelineContext(this._processingContext),this._pipelineContext._name=this._key;const r=this._rebuildProgram.bind(this);this._vertexSourceCodeOverride&&this._fragmentSourceCodeOverride?s._preparePipelineContext(this._pipelineContext,this._vertexSourceCodeOverride,this._fragmentSourceCodeOverride,!0,this._rawVertexSourceCode,this._rawFragmentSourceCode,r,null,this._transformFeedbackVaryings,this._key):s._preparePipelineContext(this._pipelineContext,this._vertexSourceCode,this._fragmentSourceCode,!1,this._rawVertexSourceCode,this._rawFragmentSourceCode,r,t,this._transformFeedbackVaryings,this._key),s._executeWhenRenderingStateIsCompiled(this._pipelineContext,()=>{if(this._attributes=[],this._pipelineContext._fillEffectInformation(this,this._uniformBuffersNames,this._uniformsNames,this._uniforms,this._samplerList,this._samplers,e,this._attributes),e)for(let n=0;n<e.length;n++){const o=e[n];this._attributeLocationByName[o]=this._attributes[n]}s.bindSamplers(this),this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh(),i&&this.getEngine()._deletePipelineContext(i)}),this._pipelineContext.isAsync&&this._checkIsReady(i)}catch(s){this._processCompilationErrors(s,i)}}_getShaderCodeAndErrorLine(e,t,i){const s=i?/FRAGMENT SHADER ERROR: 0:(\d+?):/:/VERTEX SHADER ERROR: 0:(\d+?):/;let r=null;if(t&&e){const n=t.match(s);if(n&&n.length===2){const o=parseInt(n[1]),l=e.split(`
`,-1);l.length>=o&&(r=`Offending line [${o}] in ${i?"fragment":"vertex"} code: ${l[o-1]}`)}}return[e,r]}_processCompilationErrors(e,t=null){var i,s,r;this._compilationError=e.message;const n=this._attributesNames,o=this._fallbacks;if(B.Error("Unable to compile effect:"),B.Error("Uniforms: "+this._uniformsNames.map(function(h){return" "+h})),B.Error("Attributes: "+n.map(function(h){return" "+h})),B.Error(`Defines:\r
`+this.defines),Rt.LogShaderCodeOnCompilationError){let h=null,c=null,u=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getVertexShaderCode()&&([u,h]=this._getShaderCodeAndErrorLine(this._pipelineContext._getVertexShaderCode(),this._compilationError,!1),u&&(B.Error("Vertex code:"),B.Error(u))),!((s=this._pipelineContext)===null||s===void 0)&&s._getFragmentShaderCode()&&([u,c]=this._getShaderCodeAndErrorLine((r=this._pipelineContext)===null||r===void 0?void 0:r._getFragmentShaderCode(),this._compilationError,!0),u&&(B.Error("Fragment code:"),B.Error(u))),h&&B.Error(h),c&&B.Error(c)}B.Error("Error: "+this._compilationError);const l=()=>{this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this)};t&&(this._pipelineContext=t,this._isReady=!0,l()),o?(this._pipelineContext=null,o.hasMoreFallbacks?(this._allFallbacksProcessed=!1,B.Error("Trying next fallback."),this.defines=o.reduce(this.defines,this),this._prepareEffect()):(this._allFallbacksProcessed=!0,l(),this.onErrorObservable.clear(),this._fallbacks&&this._fallbacks.unBindMesh())):(this._allFallbacksProcessed=!0,t||l())}get isSupported(){return this._compilationError===""}_bindTexture(e,t){this._engine._bindTexture(this._samplers[e],t,e)}setTexture(e,t){this._engine.setTexture(this._samplers[e],this._uniforms[e],t,e)}setDepthStencilTexture(e,t){this._engine.setDepthStencilTexture(this._samplers[e],this._uniforms[e],t,e)}setTextureArray(e,t){const i=e+"Ex";if(this._samplerList.indexOf(i+"0")===-1){const s=this._samplerList.indexOf(e);for(let n=1;n<t.length;n++){const o=i+(n-1).toString();this._samplerList.splice(s+n,0,o)}let r=0;for(const n of this._samplerList)this._samplers[n]=r,r+=1}this._engine.setTextureArray(this._samplers[e],this._uniforms[e],t,e)}setTextureFromPostProcess(e,t){this._engine.setTextureFromPostProcess(this._samplers[e],t,e)}setTextureFromPostProcessOutput(e,t){this._engine.setTextureFromPostProcessOutput(this._samplers[e],t,e)}bindUniformBuffer(e,t){const i=this._uniformBuffersNames[t];i===void 0||Rt._BaseCache[i]===e&&this._engine._features.useUBOBindingCache||(Rt._BaseCache[i]=e,this._engine.bindUniformBufferBase(e,i,t))}bindUniformBlock(e,t){this._engine.bindUniformBlock(this._pipelineContext,e,t)}setFloatArray(e,t){return this._pipelineContext.setArray(e,t),this}setFloatArray2(e,t){return this._pipelineContext.setArray2(e,t),this}setFloatArray3(e,t){return this._pipelineContext.setArray3(e,t),this}setFloatArray4(e,t){return this._pipelineContext.setArray4(e,t),this}setBool(e,t){return this._pipelineContext.setInt(e,t?1:0),this}dispose(){var e;(e=this._pipelineContext)===null||e===void 0||e.dispose(),this._engine._releaseEffect(this),this._isDisposed=!0}static RegisterShader(e,t,i,s=Xt.GLSL){t&&(Y.GetShadersStore(s)[`${e}PixelShader`]=t),i&&(Y.GetShadersStore(s)[`${e}VertexShader`]=i)}static ResetCache(){Rt._BaseCache={}}}Rt.LogShaderCodeOnCompilationError=!0;Rt._UniqueIdSeed=0;Rt._BaseCache={};Rt.ShadersStore=Y.ShadersStore;Rt.IncludesShadersStore=Y.IncludesShadersStore;class e_{constructor(e=!0){this._isDepthTestDirty=!1,this._isDepthMaskDirty=!1,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!1,this._isFrontFaceDirty=!1,e&&this.reset()}get isDirty(){return this._isDepthFuncDirty||this._isDepthTestDirty||this._isDepthMaskDirty||this._isCullFaceDirty||this._isCullDirty||this._isZOffsetDirty||this._isFrontFaceDirty}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0)}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0)}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0)}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0)}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0)}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0)}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0)}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0)}reset(){this._depthMask=!0,this._depthTest=!0,this._depthFunc=null,this._cullFace=null,this._cull=null,this._zOffset=0,this._zOffsetUnits=0,this._frontFace=null,this._isDepthTestDirty=!0,this._isDepthMaskDirty=!0,this._isDepthFuncDirty=!1,this._isCullFaceDirty=!1,this._isCullDirty=!1,this._isZOffsetDirty=!0,this._isFrontFaceDirty=!1}apply(e){!this.isDirty||(this._isCullDirty&&(this.cull?e.enable(e.CULL_FACE):e.disable(e.CULL_FACE),this._isCullDirty=!1),this._isCullFaceDirty&&(e.cullFace(this.cullFace),this._isCullFaceDirty=!1),this._isDepthMaskDirty&&(e.depthMask(this.depthMask),this._isDepthMaskDirty=!1),this._isDepthTestDirty&&(this.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this._isDepthTestDirty=!1),this._isDepthFuncDirty&&(e.depthFunc(this.depthFunc),this._isDepthFuncDirty=!1),this._isZOffsetDirty&&(this.zOffset||this.zOffsetUnits?(e.enable(e.POLYGON_OFFSET_FILL),e.polygonOffset(this.zOffset,this.zOffsetUnits)):e.disable(e.POLYGON_OFFSET_FILL),this._isZOffsetDirty=!1),this._isFrontFaceDirty&&(e.frontFace(this.frontFace),this._isFrontFaceDirty=!1))}}class pn{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=pn.ALWAYS,this.funcRef=1,this.funcMask=255,this.opStencilFail=pn.KEEP,this.opDepthFail=pn.KEEP,this.opStencilDepthPass=pn.REPLACE}get stencilFunc(){return this.func}set stencilFunc(e){this.func=e}get stencilFuncRef(){return this.funcRef}set stencilFuncRef(e){this.funcRef=e}get stencilFuncMask(){return this.funcMask}set stencilFuncMask(e){this.funcMask=e}get stencilOpStencilFail(){return this.opStencilFail}set stencilOpStencilFail(e){this.opStencilFail=e}get stencilOpDepthFail(){return this.opDepthFail}set stencilOpDepthFail(e){this.opDepthFail=e}get stencilOpStencilDepthPass(){return this.opStencilDepthPass}set stencilOpStencilDepthPass(e){this.opStencilDepthPass=e}get stencilMask(){return this.mask}set stencilMask(e){this.mask=e}get stencilTest(){return this.enabled}set stencilTest(e){this.enabled=e}}pn.ALWAYS=519;pn.KEEP=7680;pn.REPLACE=7681;class Zg{constructor(){this._blendFunctionParameters=new Array(4),this._blendEquationParameters=new Array(2),this._blendConstants=new Array(4),this._isBlendConstantsDirty=!1,this._alphaBlend=!1,this._isAlphaBlendDirty=!1,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this.reset()}get isDirty(){return this._isAlphaBlendDirty||this._isBlendFunctionParametersDirty||this._isBlendEquationParametersDirty}get alphaBlend(){return this._alphaBlend}set alphaBlend(e){this._alphaBlend!==e&&(this._alphaBlend=e,this._isAlphaBlendDirty=!0)}setAlphaBlendConstants(e,t,i,s){this._blendConstants[0]===e&&this._blendConstants[1]===t&&this._blendConstants[2]===i&&this._blendConstants[3]===s||(this._blendConstants[0]=e,this._blendConstants[1]=t,this._blendConstants[2]=i,this._blendConstants[3]=s,this._isBlendConstantsDirty=!0)}setAlphaBlendFunctionParameters(e,t,i,s){this._blendFunctionParameters[0]===e&&this._blendFunctionParameters[1]===t&&this._blendFunctionParameters[2]===i&&this._blendFunctionParameters[3]===s||(this._blendFunctionParameters[0]=e,this._blendFunctionParameters[1]=t,this._blendFunctionParameters[2]=i,this._blendFunctionParameters[3]=s,this._isBlendFunctionParametersDirty=!0)}setAlphaEquationParameters(e,t){this._blendEquationParameters[0]===e&&this._blendEquationParameters[1]===t||(this._blendEquationParameters[0]=e,this._blendEquationParameters[1]=t,this._isBlendEquationParametersDirty=!0)}reset(){this._alphaBlend=!1,this._blendFunctionParameters[0]=null,this._blendFunctionParameters[1]=null,this._blendFunctionParameters[2]=null,this._blendFunctionParameters[3]=null,this._blendEquationParameters[0]=null,this._blendEquationParameters[1]=null,this._blendConstants[0]=null,this._blendConstants[1]=null,this._blendConstants[2]=null,this._blendConstants[3]=null,this._isAlphaBlendDirty=!0,this._isBlendFunctionParametersDirty=!1,this._isBlendEquationParametersDirty=!1,this._isBlendConstantsDirty=!1}apply(e){!this.isDirty||(this._isAlphaBlendDirty&&(this._alphaBlend?e.enable(e.BLEND):e.disable(e.BLEND),this._isAlphaBlendDirty=!1),this._isBlendFunctionParametersDirty&&(e.blendFuncSeparate(this._blendFunctionParameters[0],this._blendFunctionParameters[1],this._blendFunctionParameters[2],this._blendFunctionParameters[3]),this._isBlendFunctionParametersDirty=!1),this._isBlendEquationParametersDirty&&(e.blendEquationSeparate(this._blendEquationParameters[0],this._blendEquationParameters[1]),this._isBlendEquationParametersDirty=!1),this._isBlendConstantsDirty&&(e.blendColor(this._blendConstants[0],this._blendConstants[1],this._blendConstants[2],this._blendConstants[3]),this._isBlendConstantsDirty=!1))}}class Jg{constructor(){this.shaderLanguage=Xt.GLSL}postProcessor(e,t,i,s,r){if(!r.getCaps().drawBuffersExtension){const n=/#extension.+GL_EXT_draw_buffers.+(enable|require)/g;e=e.replace(n,"")}return e}}class t_{constructor(){this.shaderLanguage=Xt.GLSL}attributeProcessor(e){return e.replace("attribute","in")}varyingProcessor(e,t){return e.replace("varying",t?"in":"out")}postProcessor(e,t,i){const s=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,r=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(r,""),e=e.replace(/texture2D\s*\(/g,"texture("),i)e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/void\s+?main\s*\(/g,(s?"":`out vec4 glFragColor;
`)+"void main(");else if(t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;return e}}class Ga{constructor(){this.references=0,this.capacity=0,this.is32Bits=!1,this.uniqueId=Ga._Counter++}get underlyingResource(){return null}}Ga._Counter=0;class yl extends Ga{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}const ev=["Int2","Int","Int3","Int4","Vector2","Vector3","Vector4","Float2","Float","Float3","Float4","Quaternion","Color3","Color4","DirectColor4"];class tv{constructor(){this._valueCache={},this.vertexCompilationError=null,this.fragmentCompilationError=null,this.programLinkError=null,this.programValidationError=null;const e=[],t=function(){e.length=0,Array.prototype.push.apply(e,arguments),e[0]=this._uniforms[e[0]]},i=s=>{const r=ev.includes(s.substring(3))&&"FloatN";if(r){const n=this[`_cache${r}`];return function(){const o=this.engine[s];t.apply(this,arguments),n.apply(this,arguments)&&(o.apply(this.engine,e)||(this._valueCache[arguments[0]]=null))}}else return function(){const n=this.engine[s];t.apply(this,arguments),arguments[1]!==void 0&&(this._valueCache[arguments[0]]=null,n.apply(this.engine,e))}};["Int?","IntArray?","Array?","Float?","Matrices","Matrix3x3","Matrix2x2"].forEach(s=>{const r=`set${s}`;this[r]||(r.endsWith("?")?["",2,3,4].forEach(n=>{this[r.slice(0,-1)+n]=this[r.slice(0,-1)+n]||i(r.slice(0,-1)+n).bind(this)}):this[r]=this[r]||i(r).bind(this))})}get isAsync(){return this.isParallelCompiled}get isReady(){return this.program?this.isParallelCompiled?this.engine._isRenderingStateCompiled(this):!0:!1}_handlesSpectorRebuildCallback(e){e&&this.program&&e(this.program)}_fillEffectInformation(e,t,i,s,r,n,o,l){const h=this.engine;if(h.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this.engine.getUniforms(this,i).forEach((d,f)=>{s[i[f]]=d}),this._uniforms=s;let u;for(u=0;u<r.length;u++)e.getUniform(r[u])==null&&(r.splice(u,1),u--);r.forEach((d,f)=>{n[d]=f});for(const d of h.getAttributes(this,o))l.push(d)}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[e]=s,!0)}_cacheFloatN(e,t,i,s,r){let n=this._valueCache[arguments[0]];if(!n||n.length!==arguments.length-1)return n=Array.prototype.slice.call(arguments,1),this._valueCache[arguments[0]]=n,!0;let o=!1;for(let l=0;l<n.length;++l)n[l]!==arguments[l+1]&&(n[l]=arguments[l+1],o=!0);return o}_cacheFloat2(e,t,i){return this._cacheFloatN(e,t,i)}_cacheFloat3(e,t,i,s){return this._cacheFloatN(e,t,i,s)}_cacheFloat4(e,t,i,s,r){return this._cacheFloatN(e,t,i,s,r)}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){return this.vertexShader?this.engine._getShaderSource(this.vertexShader):null}_getFragmentShaderCode(){return this.fragmentShader?this.engine._getShaderSource(this.fragmentShader):null}}class Pi{static SetMatrixPrecision(e){if(Pi.MatrixTrackPrecisionChange=!1,e&&!Pi.MatrixUse64Bits&&Pi.MatrixTrackedMatrices)for(let t=0;t<Pi.MatrixTrackedMatrices.length;++t){const i=Pi.MatrixTrackedMatrices[t],s=i._m;i._m=new Array(16);for(let r=0;r<16;++r)i._m[r]=s[r]}Pi.MatrixUse64Bits=e,Pi.MatrixCurrentType=Pi.MatrixUse64Bits?Array:Float32Array,Pi.MatrixTrackedMatrices=null}}Pi.MatrixUse64Bits=!1;Pi.MatrixTrackPrecisionChange=!0;Pi.MatrixCurrentType=Float32Array;Pi.MatrixTrackedMatrices=[];class zl{constructor(e=null,t){if(this._MSAARenderBuffer=null,this._context=t,!e&&(e=t.createTexture(),!e))throw new Error("Unable to create webGL texture");this.set(e)}get underlyingResource(){return this._webGLTexture}setUsage(){}set(e){this._webGLTexture=e}reset(){this._webGLTexture=null,this._MSAARenderBuffer=null}release(){this._MSAARenderBuffer&&(this._context.deleteRenderbuffer(this._MSAARenderBuffer),this._MSAARenderBuffer=null),this._webGLTexture&&this._context.deleteTexture(this._webGLTexture),this.reset()}}class Vi{constructor(e,t=!0){this.effect=null,this.defines=null,this.drawContext=e.createDrawContext(),t&&(this.materialContext=e.createMaterialContext())}static IsWrapper(e){return e.getPipelineContext===void 0}static GetEffect(e){return e.getPipelineContext===void 0?e.effect:e}setEffect(e,t,i=!0){var s;this.effect=e,t!==void 0&&(this.defines=t),i&&((s=this.drawContext)===null||s===void 0||s.reset())}dispose(){var e;(e=this.drawContext)===null||e===void 0||e.dispose()}}class i_{constructor(e=!0){this._isStencilTestDirty=!1,this._isStencilMaskDirty=!1,this._isStencilFuncDirty=!1,this._isStencilOpDirty=!1,this.useStencilGlobalOnly=!1,e&&this.reset()}get isDirty(){return this._isStencilTestDirty||this._isStencilMaskDirty||this._isStencilFuncDirty||this._isStencilOpDirty}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._isStencilFuncDirty=!0)}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef!==e&&(this._funcRef=e,this._isStencilFuncDirty=!0)}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._isStencilFuncDirty=!0)}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._isStencilOpDirty=!0)}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._isStencilOpDirty=!0)}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._isStencilOpDirty=!0)}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._isStencilMaskDirty=!0)}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._isStencilTestDirty=!0)}reset(){var e;this.stencilMaterial=void 0,(e=this.stencilGlobal)===null||e===void 0||e.reset(),this._isStencilTestDirty=!0,this._isStencilMaskDirty=!0,this._isStencilFuncDirty=!0,this._isStencilOpDirty=!0}apply(e){var t;if(!e)return;const i=!this.useStencilGlobalOnly&&!!(!((t=this.stencilMaterial)===null||t===void 0)&&t.enabled);this.enabled=i?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.func=i?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=i?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=i?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=i?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=i?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=i?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=i?this.stencilMaterial.mask:this.stencilGlobal.mask,this.isDirty&&(this._isStencilTestDirty&&(this.enabled?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this._isStencilTestDirty=!1),this._isStencilMaskDirty&&(e.stencilMask(this.mask),this._isStencilMaskDirty=!1),this._isStencilFuncDirty&&(e.stencilFunc(this.func,this.funcRef,this.funcMask),this._isStencilFuncDirty=!1),this._isStencilOpDirty&&(e.stencilOp(this.opStencilFail,this.opDepthFail,this.opStencilDepthPass),this._isStencilOpDirty=!1))}}class iv{}class Te{constructor(e,t,i,s){this._name="WebGL",this.forcePOTTextures=!1,this.isFullscreen=!1,this.cullBackFaces=null,this.renderEvenInBackground=!0,this.preventCacheWipeBetweenFrames=!1,this.validateShaderPrograms=!1,this._useReverseDepthBuffer=!1,this.isNDCHalfZRange=!1,this.hasOriginBottomLeft=!0,this.disableUniformBuffers=!1,this.onDisposeObservable=new X,this._frameId=0,this._uniformBuffers=new Array,this._storageBuffers=new Array,this._webGLVersion=1,this._windowIsBackground=!1,this._highPrecisionShadersAllowed=!0,this._badOS=!1,this._badDesktopOS=!1,this._renderingQueueLaunched=!1,this._activeRenderLoops=new Array,this.onContextLostObservable=new X,this.onContextRestoredObservable=new X,this._contextWasLost=!1,this._doNotHandleContextLost=!1,this.disableVertexArrayObjects=!1,this._colorWrite=!0,this._colorWriteChanged=!0,this._depthCullingState=new e_,this._stencilStateComposer=new i_,this._stencilState=new pn,this._alphaState=new Zg,this._alphaMode=1,this._alphaEquation=0,this._internalTexturesCache=new Array,this._renderTargetWrapperCache=new Array,this._activeChannel=0,this._currentTextureChannel=-1,this._boundTexturesCache={},this._compiledEffects={},this._vertexAttribArraysEnabled=[],this._uintIndicesCurrentlySet=!1,this._currentBoundBuffer=new Array,this._currentFramebuffer=null,this._dummyFramebuffer=null,this._currentBufferPointers=new Array,this._currentInstanceLocations=new Array,this._currentInstanceBuffers=new Array,this._vaoRecordInProgress=!1,this._mustWipeVertexAttributes=!1,this._nextFreeTextureSlots=new Array,this._maxSimultaneousTextures=0,this._maxMSAASamplesOverride=null,this._activeRequests=new Array,this.adaptToDeviceRatio=!1,this._lastDevicePixelRatio=1,this._transformTextureUrl=null,this.hostInformation={isMobile:!1},this.premultipliedAlpha=!0,this.onBeforeTextureInitObservable=new X,this._isWebGPU=!1,this._snapshotRenderingMode=0,this._useExactSrgbConversions=!1,this._viewportCached={x:0,y:0,z:0,w:0},this._unpackFlipYCached=null,this.enableUnpackFlipYCached=!0,this._boundUniforms={};let r=null;if(i=i||{},this._creationOptions=i,this.adaptToDeviceRatio=s!=null?s:!1,this._stencilStateComposer.stencilGlobal=this._stencilState,Pi.SetMatrixPrecision(!!i.useHighPrecisionMatrix),!e)return;if(s=s||i.adaptToDeviceRatio||!1,e.getContext){if(r=e,this._renderingCanvas=r,t!==void 0&&(i.antialias=t),i.deterministicLockstep===void 0&&(i.deterministicLockstep=!1),i.lockstepMaxSteps===void 0&&(i.lockstepMaxSteps=4),i.timeStep===void 0&&(i.timeStep=1/60),i.preserveDrawingBuffer===void 0&&(i.preserveDrawingBuffer=!1),i.audioEngine===void 0&&(i.audioEngine=!0),i.audioEngineOptions!==void 0&&i.audioEngineOptions.audioContext!==void 0&&(this._audioContext=i.audioEngineOptions.audioContext),i.audioEngineOptions!==void 0&&i.audioEngineOptions.audioDestination!==void 0&&(this._audioDestination=i.audioEngineOptions.audioDestination),i.stencil===void 0&&(i.stencil=!0),i.premultipliedAlpha===!1&&(this.premultipliedAlpha=!1),i.xrCompatible===void 0&&(i.xrCompatible=!0),i.useExactSrgbConversions!==void 0&&(this._useExactSrgbConversions=i.useExactSrgbConversions),this._doNotHandleContextLost=!!i.doNotHandleContextLost,navigator&&navigator.userAgent){this._checkForMobile=()=>{const c=navigator.userAgent;this.hostInformation.isMobile=c.indexOf("Mobile")!==-1||c.indexOf("Mac")!==-1&&Bh()&&"ontouchend"in document},this._checkForMobile(),Ht()&&window.addEventListener("resize",this._checkForMobile);const h=navigator.userAgent;for(const c of Te.ExceptionList){const u=c.key,d=c.targets;if(new RegExp(u).test(h)){if(c.capture&&c.captureConstraint){const p=c.capture,_=c.captureConstraint,v=new RegExp(p).exec(h);if(v&&v.length>0&&parseInt(v[v.length-1])>=_)continue}for(const p of d)switch(p){case"uniformBuffer":this.disableUniformBuffers=!0;break;case"vao":this.disableVertexArrayObjects=!0;break;case"antialias":i.antialias=!1;break;case"maxMSAASamples":this._maxMSAASamplesOverride=1;break}}}}if(this._doNotHandleContextLost||(this._onContextLost=h=>{h.preventDefault(),this._contextWasLost=!0,B.Warn("WebGL context lost."),this.onContextLostObservable.notifyObservers(this)},this._onContextRestored=()=>{this._restoreEngineAfterContextLost(this._initGLContext.bind(this))},r.addEventListener("webglcontextlost",this._onContextLost,!1),r.addEventListener("webglcontextrestored",this._onContextRestored,!1),i.powerPreference="high-performance"),this._badDesktopOS=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this._badDesktopOS&&(i.xrCompatible=!1),!i.disableWebGL2Support)try{this._gl=r.getContext("webgl2",i)||r.getContext("experimental-webgl2",i),this._gl&&(this._webGLVersion=2,this._shaderPlatformName="WEBGL2",this._gl.deleteQuery||(this._webGLVersion=1,this._shaderPlatformName="WEBGL1"))}catch{}if(!this._gl){if(!r)throw new Error("The provided canvas is null or undefined.");try{this._gl=r.getContext("webgl",i)||r.getContext("experimental-webgl",i)}catch{throw new Error("WebGL not supported")}}if(!this._gl)throw new Error("WebGL not supported")}else{this._gl=e,this._renderingCanvas=this._gl.canvas,this._gl.renderbufferStorageMultisample?(this._webGLVersion=2,this._shaderPlatformName="WEBGL2"):this._shaderPlatformName="WEBGL1";const h=this._gl.getContextAttributes();h&&(i.stencil=h.stencil)}this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),i.useHighPrecisionFloats!==void 0&&(this._highPrecisionShadersAllowed=i.useHighPrecisionFloats);const n=Ht()&&window.devicePixelRatio||1,o=i.limitDeviceRatio||n;this._hardwareScalingLevel=s?1/Math.min(o,n):1,this._lastDevicePixelRatio=n,this.resize(),this._isStencilEnable=!!i.stencil,this._initGLContext(),this._initFeatures();for(let h=0;h<this._caps.maxVertexAttribs;h++)this._currentBufferPointers[h]=new iv;this._shaderProcessor=this.webGLVersion>1?new t_:new Jg,this._badOS=/iPad/i.test(navigator.userAgent)||/iPhone/i.test(navigator.userAgent);const l=`Babylon.js v${Te.Version}`;console.log(l+` - ${this.description}`),this._renderingCanvas&&this._renderingCanvas.setAttribute&&this._renderingCanvas.setAttribute("data-engine",l)}static get NpmPackage(){return"babylonjs@5.28.0"}static get Version(){return"5.28.0"}get description(){let e=this.name+this.webGLVersion;return this._caps.parallelShaderCompile&&(e+=" - Parallel shader compilation"),e}get name(){return this._name}set name(e){this._name=e}get version(){return this._webGLVersion}static get ShadersRepository(){return Rt.ShadersRepository}static set ShadersRepository(e){Rt.ShadersRepository=e}_getShaderProcessor(e){return this._shaderProcessor}get useReverseDepthBuffer(){return this._useReverseDepthBuffer}set useReverseDepthBuffer(e){e!==this._useReverseDepthBuffer&&(this._useReverseDepthBuffer=e,e?this._depthCullingState.depthFunc=518:this._depthCullingState.depthFunc=515)}get frameId(){return this._frameId}get supportsUniformBuffers(){return this.webGLVersion>1&&!this.disableUniformBuffers}getCreationOptions(){return this._creationOptions}get _shouldUseHighPrecisionShader(){return!!(this._caps.highPrecisionShaderSupported&&this._highPrecisionShadersAllowed)}get needPOTTextures(){return this._webGLVersion<2||this.forcePOTTextures}get activeRenderLoops(){return this._activeRenderLoops}get doNotHandleContextLost(){return this._doNotHandleContextLost}set doNotHandleContextLost(e){this._doNotHandleContextLost=e}get _supportsHardwareTextureRescaling(){return!1}set framebufferDimensionsObject(e){this._framebufferDimensionsObject=e}get currentViewport(){return this._cachedViewport}get emptyTexture(){return this._emptyTexture||(this._emptyTexture=this.createRawTexture(new Uint8Array(4),1,1,5,!1,!1,1)),this._emptyTexture}get emptyTexture3D(){return this._emptyTexture3D||(this._emptyTexture3D=this.createRawTexture3D(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture3D}get emptyTexture2DArray(){return this._emptyTexture2DArray||(this._emptyTexture2DArray=this.createRawTexture2DArray(new Uint8Array(4),1,1,1,5,!1,!1,1)),this._emptyTexture2DArray}get emptyCubeTexture(){if(!this._emptyCubeTexture){const e=new Uint8Array(4),t=[e,e,e,e,e,e];this._emptyCubeTexture=this.createRawCubeTexture(t,1,5,0,!1,!1,1)}return this._emptyCubeTexture}get isWebGPU(){return this._isWebGPU}get shaderPlatformName(){return this._shaderPlatformName}get snapshotRendering(){return!1}set snapshotRendering(e){}get snapshotRenderingMode(){return this._snapshotRenderingMode}set snapshotRenderingMode(e){this._snapshotRenderingMode=e}get useExactSrgbConversions(){return this._useExactSrgbConversions}snapshotRenderingReset(){this.snapshotRendering=!1}static _CreateCanvas(e,t){if(typeof document>"u")return new OffscreenCanvas(e,t);const i=document.createElement("canvas");return i.width=e,i.height=t,i}createCanvas(e,t){return Te._CreateCanvas(e,t)}createCanvasImage(){return document.createElement("img")}_restoreEngineAfterContextLost(e){setTimeout(async()=>{var t;this._dummyFramebuffer=null;const i=this._depthCullingState.depthTest,s=this._depthCullingState.depthFunc,r=this._depthCullingState.depthMask,n=this._stencilState.stencilTest;await e(),this._rebuildEffects(),(t=this._rebuildComputeEffects)===null||t===void 0||t.call(this),this._rebuildInternalTextures(),this._rebuildRenderTargetWrappers(),this._rebuildBuffers(),this.wipeCaches(!0),this._depthCullingState.depthTest=i,this._depthCullingState.depthFunc=s,this._depthCullingState.depthMask=r,this._stencilState.stencilTest=n,B.Warn(this.name+" context successfully restored."),this.onContextRestoredObservable.notifyObservers(this),this._contextWasLost=!1},0)}_sharedInit(e,t,i){this._renderingCanvas=e}_getShaderProcessingContext(e){return null}_rebuildInternalTextures(){const e=this._internalTexturesCache.slice();for(const t of e)t._rebuild()}_rebuildRenderTargetWrappers(){const e=this._renderTargetWrapperCache.slice();for(const t of e)t._rebuild()}_rebuildEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e];t._pipelineContext=null,t._wasPreviouslyReady=!1,t._prepareEffect()}Rt.ResetCache()}areAllEffectsReady(){for(const e in this._compiledEffects)if(!this._compiledEffects[e].isReady())return!1;return!0}_rebuildBuffers(){for(const e of this._uniformBuffers)e._rebuild();for(const e of this._storageBuffers)e._rebuild()}_initGLContext(){var e;this._caps={maxTexturesImageUnits:this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),maxCombinedTexturesImageUnits:this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),maxVertexTextureImageUnits:this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxTextureSize:this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),maxSamples:this._webGLVersion>1?this._gl.getParameter(this._gl.MAX_SAMPLES):1,maxCubemapTextureSize:this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),maxRenderTextureSize:this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),maxVertexAttribs:this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),maxVaryingVectors:this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),maxFragmentUniformVectors:this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),maxVertexUniformVectors:this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),parallelShaderCompile:this._gl.getExtension("KHR_parallel_shader_compile")||void 0,standardDerivatives:this._webGLVersion>1||this._gl.getExtension("OES_standard_derivatives")!==null,maxAnisotropy:1,astc:this._gl.getExtension("WEBGL_compressed_texture_astc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_astc"),bptc:this._gl.getExtension("EXT_texture_compression_bptc")||this._gl.getExtension("WEBKIT_EXT_texture_compression_bptc"),s3tc:this._gl.getExtension("WEBGL_compressed_texture_s3tc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),s3tc_srgb:this._gl.getExtension("WEBGL_compressed_texture_s3tc_srgb")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc_srgb"),pvrtc:this._gl.getExtension("WEBGL_compressed_texture_pvrtc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),etc1:this._gl.getExtension("WEBGL_compressed_texture_etc1")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc1"),etc2:this._gl.getExtension("WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBKIT_WEBGL_compressed_texture_etc")||this._gl.getExtension("WEBGL_compressed_texture_es3_0"),textureAnisotropicFilterExtension:this._gl.getExtension("EXT_texture_filter_anisotropic")||this._gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this._gl.getExtension("MOZ_EXT_texture_filter_anisotropic"),uintIndices:this._webGLVersion>1||this._gl.getExtension("OES_element_index_uint")!==null,fragmentDepthSupported:this._webGLVersion>1||this._gl.getExtension("EXT_frag_depth")!==null,highPrecisionShaderSupported:!1,timerQuery:this._gl.getExtension("EXT_disjoint_timer_query_webgl2")||this._gl.getExtension("EXT_disjoint_timer_query"),supportOcclusionQuery:this._webGLVersion>1,canUseTimestampForTimerQuery:!1,drawBuffersExtension:!1,maxMSAASamples:1,colorBufferFloat:!!(this._webGLVersion>1&&this._gl.getExtension("EXT_color_buffer_float")),textureFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_float")),textureHalfFloat:!!(this._webGLVersion>1||this._gl.getExtension("OES_texture_half_float")),textureHalfFloatRender:!1,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloatLinearFiltering:!1,vertexArrayObject:!1,instancedArrays:!1,textureLOD:!!(this._webGLVersion>1||this._gl.getExtension("EXT_shader_texture_lod")),blendMinMax:!1,multiview:this._gl.getExtension("OVR_multiview2"),oculusMultiview:this._gl.getExtension("OCULUS_multiview"),depthTextureExtension:!1,canUseGLInstanceID:this._webGLVersion>1,canUseGLVertexID:this._webGLVersion>1,supportComputeShaders:!1,supportSRGBBuffers:!1,supportTransformFeedbacks:this._webGLVersion>1,textureMaxLevel:this._webGLVersion>1,texture2DArrayMaxLayerCount:this._webGLVersion>1?256:128},this._glVersion=this._gl.getParameter(this._gl.VERSION);const t=this._gl.getExtension("WEBGL_debug_renderer_info");if(t!=null&&(this._glRenderer=this._gl.getParameter(t.UNMASKED_RENDERER_WEBGL),this._glVendor=this._gl.getParameter(t.UNMASKED_VENDOR_WEBGL)),this._glVendor||(this._glVendor=this._gl.getParameter(this._gl.VENDOR)||"Unknown vendor"),this._glRenderer||(this._glRenderer=this._gl.getParameter(this._gl.RENDERER)||"Unknown renderer"),this._gl.HALF_FLOAT_OES!==36193&&(this._gl.HALF_FLOAT_OES=36193),this._gl.RGBA16F!==34842&&(this._gl.RGBA16F=34842),this._gl.RGBA32F!==34836&&(this._gl.RGBA32F=34836),this._gl.DEPTH24_STENCIL8!==35056&&(this._gl.DEPTH24_STENCIL8=35056),this._caps.timerQuery&&(this._webGLVersion===1&&(this._gl.getQuery=this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery)),this._caps.canUseTimestampForTimerQuery=((e=this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT,this._caps.timerQuery.QUERY_COUNTER_BITS_EXT))!==null&&e!==void 0?e:0)>0),this._caps.maxAnisotropy=this._caps.textureAnisotropicFilterExtension?this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,this._caps.textureFloatLinearFiltering=!!(this._caps.textureFloat&&this._gl.getExtension("OES_texture_float_linear")),this._caps.textureFloatRender=!!(this._caps.textureFloat&&this._canRenderToFloatFramebuffer()),this._caps.textureHalfFloatLinearFiltering=!!(this._webGLVersion>1||this._caps.textureHalfFloat&&this._gl.getExtension("OES_texture_half_float_linear")),this._caps.astc&&(this._gl.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=this._caps.astc.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR),this._caps.bptc&&(this._gl.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=this._caps.bptc.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT),this._caps.s3tc_srgb&&(this._gl.COMPRESSED_SRGB_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT,this._gl.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=this._caps.s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT),this._caps.etc2&&(this._gl.COMPRESSED_SRGB8_ETC2=this._caps.etc2.COMPRESSED_SRGB8_ETC2,this._gl.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=this._caps.etc2.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC),this._webGLVersion>1&&this._gl.HALF_FLOAT_OES!==5131&&(this._gl.HALF_FLOAT_OES=5131),this._caps.textureHalfFloatRender=this._caps.textureHalfFloat&&this._canRenderToHalfFloatFramebuffer(),this._webGLVersion>1)this._caps.drawBuffersExtension=!0,this._caps.maxMSAASamples=this._maxMSAASamplesOverride!==null?this._maxMSAASamplesOverride:this._gl.getParameter(this._gl.MAX_SAMPLES);else{const i=this._gl.getExtension("WEBGL_draw_buffers");if(i!==null){this._caps.drawBuffersExtension=!0,this._gl.drawBuffers=i.drawBuffersWEBGL.bind(i),this._gl.DRAW_FRAMEBUFFER=this._gl.FRAMEBUFFER;for(let s=0;s<16;s++)this._gl["COLOR_ATTACHMENT"+s+"_WEBGL"]=i["COLOR_ATTACHMENT"+s+"_WEBGL"]}}if(this._webGLVersion>1)this._caps.depthTextureExtension=!0;else{const i=this._gl.getExtension("WEBGL_depth_texture");i!=null&&(this._caps.depthTextureExtension=!0,this._gl.UNSIGNED_INT_24_8=i.UNSIGNED_INT_24_8_WEBGL)}if(this.disableVertexArrayObjects)this._caps.vertexArrayObject=!1;else if(this._webGLVersion>1)this._caps.vertexArrayObject=!0;else{const i=this._gl.getExtension("OES_vertex_array_object");i!=null&&(this._caps.vertexArrayObject=!0,this._gl.createVertexArray=i.createVertexArrayOES.bind(i),this._gl.bindVertexArray=i.bindVertexArrayOES.bind(i),this._gl.deleteVertexArray=i.deleteVertexArrayOES.bind(i))}if(this._webGLVersion>1)this._caps.instancedArrays=!0;else{const i=this._gl.getExtension("ANGLE_instanced_arrays");i!=null?(this._caps.instancedArrays=!0,this._gl.drawArraysInstanced=i.drawArraysInstancedANGLE.bind(i),this._gl.drawElementsInstanced=i.drawElementsInstancedANGLE.bind(i),this._gl.vertexAttribDivisor=i.vertexAttribDivisorANGLE.bind(i)):this._caps.instancedArrays=!1}if(this._gl.getShaderPrecisionFormat){const i=this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER,this._gl.HIGH_FLOAT),s=this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER,this._gl.HIGH_FLOAT);i&&s&&(this._caps.highPrecisionShaderSupported=i.precision!==0&&s.precision!==0)}if(this._webGLVersion>1)this._caps.blendMinMax=!0;else{const i=this._gl.getExtension("EXT_blend_minmax");i!=null&&(this._caps.blendMinMax=!0,this._gl.MAX=i.MAX_EXT,this._gl.MIN=i.MIN_EXT)}if(!this._caps.supportSRGBBuffers){if(this._webGLVersion>1)this._caps.supportSRGBBuffers=!0;else{const i=this._gl.getExtension("EXT_sRGB");i!=null&&(this._caps.supportSRGBBuffers=!0,this._gl.SRGB=i.SRGB_EXT,this._gl.SRGB8=i.SRGB_ALPHA_EXT,this._gl.SRGB8_ALPHA8=i.SRGB_ALPHA_EXT)}this._caps.supportSRGBBuffers=this._caps.supportSRGBBuffers&&!!(this._creationOptions&&this._creationOptions.forceSRGBBufferSupportState)}this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=this._gl.LEQUAL,this._depthCullingState.depthMask=!0,this._maxSimultaneousTextures=this._caps.maxCombinedTexturesImageUnits;for(let i=0;i<this._maxSimultaneousTextures;i++)this._nextFreeTextureSlots.push(i)}_initFeatures(){this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:this._webGLVersion!==1,supportDepthStencilTexture:this._webGLVersion!==1,supportShadowSamplers:this._webGLVersion!==1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:this._webGLVersion!==1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:this._webGLVersion!==1,basisNeedsPOT:this._webGLVersion===1,support3DTextures:this._webGLVersion!==1,needTypeSuffixInShaderConstants:this._webGLVersion!==1,supportMSAA:this._webGLVersion!==1,supportSSAO2:this._webGLVersion!==1,supportExtendedTextureFormats:this._webGLVersion!==1,supportSwitchCaseInShader:this._webGLVersion!==1,supportSyncTextureRead:!0,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!1,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!1,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}get webGLVersion(){return this._webGLVersion}getClassName(){return"ThinEngine"}get isStencilEnable(){return this._isStencilEnable}_prepareWorkingCanvas(){if(this._workingCanvas)return;this._workingCanvas=this.createCanvas(1,1);const e=this._workingCanvas.getContext("2d");e&&(this._workingContext=e)}resetTextureCache(){for(const e in this._boundTexturesCache)!Object.prototype.hasOwnProperty.call(this._boundTexturesCache,e)||(this._boundTexturesCache[e]=null);this._currentTextureChannel=-1}getInfo(){return this.getGlInfo()}getGlInfo(){return{vendor:this._glVendor,renderer:this._glRenderer,version:this._glVersion}}setHardwareScalingLevel(e){this._hardwareScalingLevel=e,this.resize()}getHardwareScalingLevel(){return this._hardwareScalingLevel}getLoadedTexturesCache(){return this._internalTexturesCache}getCaps(){return this._caps}stopRenderLoop(e){if(!e){this._activeRenderLoops=[];return}const t=this._activeRenderLoops.indexOf(e);t>=0&&this._activeRenderLoops.splice(t,1)}_renderLoop(){if(!this._contextWasLost){let e=!0;if(!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e){this.beginFrame();for(let t=0;t<this._activeRenderLoops.length;t++){const i=this._activeRenderLoops[t];i()}this.endFrame()}}this._activeRenderLoops.length>0?this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}getRenderingCanvas(){return this._renderingCanvas}getAudioContext(){return this._audioContext}getAudioDestination(){return this._audioDestination}getHostWindow(){return Ht()?this._renderingCanvas&&this._renderingCanvas.ownerDocument&&this._renderingCanvas.ownerDocument.defaultView?this._renderingCanvas.ownerDocument.defaultView:window:null}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferWidth:this._gl.drawingBufferWidth}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._framebufferDimensionsObject?this._framebufferDimensionsObject.framebufferHeight:this._gl.drawingBufferHeight}_queueNewFrame(e,t){return Te.QueueNewFrame(e,t)}runRenderLoop(e){this._activeRenderLoops.indexOf(e)===-1&&(this._activeRenderLoops.push(e),this._renderingQueueLaunched||(this._renderingQueueLaunched=!0,this._boundRenderFunction=this._renderLoop.bind(this),this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow())))}clear(e,t,i,s=!1){const r=this.stencilStateComposer.useStencilGlobalOnly;this.stencilStateComposer.useStencilGlobalOnly=!0,this.applyStates(),this.stencilStateComposer.useStencilGlobalOnly=r;let n=0;t&&e&&(this._gl.clearColor(e.r,e.g,e.b,e.a!==void 0?e.a:1),n|=this._gl.COLOR_BUFFER_BIT),i&&(this.useReverseDepthBuffer?(this._depthCullingState.depthFunc=this._gl.GEQUAL,this._gl.clearDepth(0)):this._gl.clearDepth(1),n|=this._gl.DEPTH_BUFFER_BIT),s&&(this._gl.clearStencil(0),n|=this._gl.STENCIL_BUFFER_BIT),this._gl.clear(n)}_viewport(e,t,i,s){(e!==this._viewportCached.x||t!==this._viewportCached.y||i!==this._viewportCached.z||s!==this._viewportCached.w)&&(this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s,this._gl.viewport(e,t,i,s))}setViewport(e,t,i){const s=t||this.getRenderWidth(),r=i||this.getRenderHeight(),n=e.x||0,o=e.y||0;this._cachedViewport=e,this._viewport(n*s,o*r,s*e.width,r*e.height)}beginFrame(){}endFrame(){this._badOS&&this.flushFramebuffer(),this._frameId++}resize(e=!1){let t,i;if(this.adaptToDeviceRatio){const s=Ht()&&window.devicePixelRatio||1,r=this._lastDevicePixelRatio/s;this._lastDevicePixelRatio=s,this._hardwareScalingLevel*=r}Ht()?(t=this._renderingCanvas?this._renderingCanvas.clientWidth||this._renderingCanvas.width:window.innerWidth,i=this._renderingCanvas?this._renderingCanvas.clientHeight||this._renderingCanvas.height:window.innerHeight):(t=this._renderingCanvas?this._renderingCanvas.width:100,i=this._renderingCanvas?this._renderingCanvas.height:100),this.setSize(t/this._hardwareScalingLevel,i/this._hardwareScalingLevel,e)}setSize(e,t,i=!1){return!this._renderingCanvas||(e=e|0,t=t|0,!i&&this._renderingCanvas.width===e&&this._renderingCanvas.height===t)?!1:(this._renderingCanvas.width=e,this._renderingCanvas.height=t,!0)}bindFramebuffer(e,t=0,i,s,r,n=0,o=0){var l,h,c,u,d;const f=e;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,this._bindUnboundFramebuffer(f._MSAAFramebuffer?f._MSAAFramebuffer:f._framebuffer);const p=this._gl;e.is2DArray?p.framebufferTextureLayer(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,(l=e.texture._hardwareTexture)===null||l===void 0?void 0:l.underlyingResource,n,o):e.isCube&&p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_CUBE_MAP_POSITIVE_X+t,(h=e.texture._hardwareTexture)===null||h===void 0?void 0:h.underlyingResource,n);const _=e._depthStencilTexture;if(_){const m=e._depthStencilTextureWithStencil?p.DEPTH_STENCIL_ATTACHMENT:p.DEPTH_ATTACHMENT;e.is2DArray?p.framebufferTextureLayer(p.FRAMEBUFFER,m,(c=_._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,n,o):e.isCube?p.framebufferTexture2D(p.FRAMEBUFFER,m,p.TEXTURE_CUBE_MAP_POSITIVE_X+t,(u=_._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,n):p.framebufferTexture2D(p.FRAMEBUFFER,m,p.TEXTURE_2D,(d=_._hardwareTexture)===null||d===void 0?void 0:d.underlyingResource,n)}this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),s||(s=e.height,n&&(s=s/Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches()}setState(e,t=0,i,s=!1,r,n,o=0){var l,h;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const c=!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:r)!==null&&h!==void 0)||h?this._gl.BACK:this._gl.FRONT;(this._depthCullingState.cullFace!==c||i)&&(this._depthCullingState.cullFace=c),this.setZOffset(t),this.setZOffsetUnits(o);const u=s?this._gl.CW:this._gl.CCW;(this._depthCullingState.frontFace!==u||i)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=n}getDepthBuffer(){return this._depthCullingState.depthTest}setDepthBuffer(e){this._depthCullingState.depthTest=e}setZOffset(e){this._depthCullingState.zOffset=this.useReverseDepthBuffer?-e:e}getZOffset(){const e=this._depthCullingState.zOffset;return this.useReverseDepthBuffer?-e:e}setZOffsetUnits(e){this._depthCullingState.zOffsetUnits=this.useReverseDepthBuffer?-e:e}getZOffsetUnits(){const e=this._depthCullingState.zOffsetUnits;return this.useReverseDepthBuffer?-e:e}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,e),this._currentFramebuffer=e)}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentFramebuffer===null}generateMipmaps(e){this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)}unBindFramebuffer(e,t=!1,i){var s;const r=e;this._currentRenderTarget=null;const n=this._gl;if(r._MSAAFramebuffer){if(e.isMulti){this.unBindMultiColorAttachmentFramebuffer(e,t,i);return}n.bindFramebuffer(n.READ_FRAMEBUFFER,r._MSAAFramebuffer),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,r._framebuffer),n.blitFramebuffer(0,0,e.width,e.height,0,0,e.width,e.height,n.COLOR_BUFFER_BIT,n.NEAREST)}((s=e.texture)===null||s===void 0?void 0:s.generateMipMaps)&&!t&&!e.isCube&&this.generateMipmaps(e.texture),i&&(r._MSAAFramebuffer&&this._bindUnboundFramebuffer(r._framebuffer),i()),this._bindUnboundFramebuffer(null)}flushFramebuffer(){this._gl.flush()}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):this._bindUnboundFramebuffer(null),this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_resetVertexBufferBinding(){this.bindArrayBuffer(null),this._cachedVertexBuffers=null}createVertexBuffer(e){return this._createVertexBuffer(e,this._gl.STATIC_DRAW)}_createVertexBuffer(e,t){const i=this._gl.createBuffer();if(!i)throw new Error("Unable to create vertex buffer");const s=new yl(i);return this.bindArrayBuffer(s),e instanceof Array?this._gl.bufferData(this._gl.ARRAY_BUFFER,new Float32Array(e),t):this._gl.bufferData(this._gl.ARRAY_BUFFER,e,t),this._resetVertexBufferBinding(),s.references=1,s}createDynamicVertexBuffer(e){return this._createVertexBuffer(e,this._gl.DYNAMIC_DRAW)}_resetIndexBufferBinding(){this.bindIndexBuffer(null),this._cachedIndexBuffer=null}createIndexBuffer(e,t){const i=this._gl.createBuffer(),s=new yl(i);if(!i)throw new Error("Unable to create index buffer");this.bindIndexBuffer(s);const r=this._normalizeIndexData(e);return this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,r,t?this._gl.DYNAMIC_DRAW:this._gl.STATIC_DRAW),this._resetIndexBufferBinding(),s.references=1,s.is32Bits=r.BYTES_PER_ELEMENT===4,s}_normalizeIndexData(e){if(e.BYTES_PER_ELEMENT===2)return e;if(this._caps.uintIndices){if(e instanceof Uint32Array)return e;for(let i=0;i<e.length;i++)if(e[i]>=65535)return new Uint32Array(e);return new Uint16Array(e)}return new Uint16Array(e)}bindArrayBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ARRAY_BUFFER)}bindUniformBlock(e,t,i){const s=e.program,r=this._gl.getUniformBlockIndex(s,t);this._gl.uniformBlockBinding(s,r,i)}bindIndexBuffer(e){this._vaoRecordInProgress||this._unbindVertexArrayObject(),this._bindBuffer(e,this._gl.ELEMENT_ARRAY_BUFFER)}_bindBuffer(e,t){(this._vaoRecordInProgress||this._currentBoundBuffer[t]!==e)&&(this._gl.bindBuffer(t,e?e.underlyingResource:null),this._currentBoundBuffer[t]=e)}updateArrayBuffer(e){this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)}_vertexAttribPointer(e,t,i,s,r,n,o){const l=this._currentBufferPointers[t];if(!l)return;let h=!1;l.active?(l.buffer!==e&&(l.buffer=e,h=!0),l.size!==i&&(l.size=i,h=!0),l.type!==s&&(l.type=s,h=!0),l.normalized!==r&&(l.normalized=r,h=!0),l.stride!==n&&(l.stride=n,h=!0),l.offset!==o&&(l.offset=o,h=!0)):(h=!0,l.active=!0,l.index=t,l.size=i,l.type=s,l.normalized=r,l.stride=n,l.offset=o,l.buffer=e),(h||this._vaoRecordInProgress)&&(this.bindArrayBuffer(e),s===this._gl.UNSIGNED_INT||s===this._gl.INT?this._gl.vertexAttribIPointer(t,i,s,n,o):this._gl.vertexAttribPointer(t,i,s,r,n,o))}_bindIndexBufferWithCache(e){e!=null&&this._cachedIndexBuffer!==e&&(this._cachedIndexBuffer=e,this.bindIndexBuffer(e),this._uintIndicesCurrentlySet=e.is32Bits)}_bindVertexBuffersAttributes(e,t,i){const s=t.getAttributesNames();this._vaoRecordInProgress||this._unbindVertexArrayObject(),this.unbindAllAttributes();for(let r=0;r<s.length;r++){const n=t.getAttributeLocation(r);if(n>=0){const o=s[r];let l=null;if(i&&(l=i[o]),l||(l=e[o]),!l)continue;this._gl.enableVertexAttribArray(n),this._vaoRecordInProgress||(this._vertexAttribArraysEnabled[n]=!0);const h=l.getBuffer();h&&(this._vertexAttribPointer(h,n,l.getSize(),l.type,l.normalized,l.byteStride,l.byteOffset),l.getIsInstanced()&&(this._gl.vertexAttribDivisor(n,l.getInstanceDivisor()),this._vaoRecordInProgress||(this._currentInstanceLocations.push(n),this._currentInstanceBuffers.push(h))))}}}recordVertexArrayObject(e,t,i,s){const r=this._gl.createVertexArray();if(!r)throw new Error("Unable to create VAO");return this._vaoRecordInProgress=!0,this._gl.bindVertexArray(r),this._mustWipeVertexAttributes=!0,this._bindVertexBuffersAttributes(e,i,s),this.bindIndexBuffer(t),this._vaoRecordInProgress=!1,this._gl.bindVertexArray(null),r}bindVertexArrayObject(e,t){this._cachedVertexArrayObject!==e&&(this._cachedVertexArrayObject=e,this._gl.bindVertexArray(e),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._uintIndicesCurrentlySet=t!=null&&t.is32Bits,this._mustWipeVertexAttributes=!0)}bindBuffersDirectly(e,t,i,s,r){if(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==r){this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=r;const n=r.getAttributesCount();this._unbindVertexArrayObject(),this.unbindAllAttributes();let o=0;for(let l=0;l<n;l++)if(l<i.length){const h=r.getAttributeLocation(l);h>=0&&(this._gl.enableVertexAttribArray(h),this._vertexAttribArraysEnabled[h]=!0,this._vertexAttribPointer(e,h,i[l],this._gl.FLOAT,!1,s,o)),o+=i[l]*4}}this._bindIndexBufferWithCache(t)}_unbindVertexArrayObject(){!this._cachedVertexArrayObject||(this._cachedVertexArrayObject=null,this._gl.bindVertexArray(null))}bindBuffers(e,t,i,s){(this._cachedVertexBuffers!==e||this._cachedEffectForVertexBuffers!==i)&&(this._cachedVertexBuffers=e,this._cachedEffectForVertexBuffers=i,this._bindVertexBuffersAttributes(e,i,s)),this._bindIndexBufferWithCache(t)}unbindInstanceAttributes(){let e;for(let t=0,i=this._currentInstanceLocations.length;t<i;t++){const s=this._currentInstanceBuffers[t];e!=s&&s.references&&(e=s,this.bindArrayBuffer(s));const r=this._currentInstanceLocations[t];this._gl.vertexAttribDivisor(r,0)}this._currentInstanceBuffers.length=0,this._currentInstanceLocations.length=0}releaseVertexArrayObject(e){this._gl.deleteVertexArray(e)}_releaseBuffer(e){return e.references--,e.references===0?(this._deleteBuffer(e),!0):!1}_deleteBuffer(e){this._gl.deleteBuffer(e.underlyingResource)}updateAndBindInstancesBuffer(e,t,i){if(this.bindArrayBuffer(e),t&&this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,t),i[0].index!==void 0)this.bindInstancesBuffer(e,i,!0);else for(let s=0;s<4;s++){const r=i[s];this._vertexAttribArraysEnabled[r]||(this._gl.enableVertexAttribArray(r),this._vertexAttribArraysEnabled[r]=!0),this._vertexAttribPointer(e,r,4,this._gl.FLOAT,!1,64,s*16),this._gl.vertexAttribDivisor(r,1),this._currentInstanceLocations.push(r),this._currentInstanceBuffers.push(e)}}bindInstancesBuffer(e,t,i=!0){this.bindArrayBuffer(e);let s=0;if(i)for(let r=0;r<t.length;r++)s+=t[r].attributeSize*4;for(let r=0;r<t.length;r++){const n=t[r];n.index===void 0&&(n.index=this._currentEffect.getAttributeLocationByName(n.attributeName)),!(n.index<0)&&(this._vertexAttribArraysEnabled[n.index]||(this._gl.enableVertexAttribArray(n.index),this._vertexAttribArraysEnabled[n.index]=!0),this._vertexAttribPointer(e,n.index,n.attributeSize,n.attributeType||this._gl.FLOAT,n.normalized||!1,s,n.offset),this._gl.vertexAttribDivisor(n.index,n.divisor===void 0?1:n.divisor),this._currentInstanceLocations.push(n.index),this._currentInstanceBuffers.push(e))}}disableInstanceAttributeByName(e){if(!this._currentEffect)return;const t=this._currentEffect.getAttributeLocationByName(e);this.disableInstanceAttribute(t)}disableInstanceAttribute(e){let t=!1,i;for(;(i=this._currentInstanceLocations.indexOf(e))!==-1;)this._currentInstanceLocations.splice(i,1),this._currentInstanceBuffers.splice(i,1),t=!0,i=this._currentInstanceLocations.indexOf(e);t&&(this._gl.vertexAttribDivisor(e,0),this.disableAttributeByIndex(e))}disableAttributeByIndex(e){this._gl.disableVertexAttribArray(e),this._vertexAttribArraysEnabled[e]=!1,this._currentBufferPointers[e].active=!1}draw(e,t,i,s){this.drawElementsType(e?0:1,t,i,s)}drawPointClouds(e,t,i){this.drawArraysType(2,e,t,i)}drawUnIndexed(e,t,i,s){this.drawArraysType(e?0:1,t,i,s)}drawElementsType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e),n=this._uintIndicesCurrentlySet?this._gl.UNSIGNED_INT:this._gl.UNSIGNED_SHORT,o=this._uintIndicesCurrentlySet?4:2;s?this._gl.drawElementsInstanced(r,i,n,t*o,s):this._gl.drawElements(r,i,n,t*o)}drawArraysType(e,t,i,s){this.applyStates(),this._reportDrawCall();const r=this._drawMode(e);s?this._gl.drawArraysInstanced(r,t,i,s):this._gl.drawArrays(r,t,i)}_drawMode(e){switch(e){case 0:return this._gl.TRIANGLES;case 2:return this._gl.POINTS;case 1:return this._gl.LINES;case 3:return this._gl.POINTS;case 4:return this._gl.LINES;case 5:return this._gl.LINE_LOOP;case 6:return this._gl.LINE_STRIP;case 7:return this._gl.TRIANGLE_STRIP;case 8:return this._gl.TRIANGLE_FAN;default:return this._gl.TRIANGLES}}_reportDrawCall(){}_releaseEffect(e){this._compiledEffects[e._key]&&delete this._compiledEffects[e._key];const t=e.getPipelineContext();t&&this._deletePipelineContext(t)}_deletePipelineContext(e){const t=e;t&&t.program&&(t.program.__SPECTOR_rebuildProgram=null,this._gl.deleteProgram(t.program))}_getGlobalDefines(e){if(e){this.isNDCHalfZRange?e.IS_NDC_HALF_ZRANGE="":delete e.IS_NDC_HALF_ZRANGE,this.useReverseDepthBuffer?e.USE_REVERSE_DEPTHBUFFER="":delete e.USE_REVERSE_DEPTHBUFFER,this.useExactSrgbConversions?e.USE_EXACT_SRGB_CONVERSIONS="":delete e.USE_EXACT_SRGB_CONVERSIONS;return}else{let t="";return this.isNDCHalfZRange&&(t+="#define IS_NDC_HALF_ZRANGE"),this.useReverseDepthBuffer&&(t&&(t+=`
`),t+="#define USE_REVERSE_DEPTHBUFFER"),this.useExactSrgbConversions&&(t&&(t+=`
`),t+="#define USE_EXACT_SRGB_CONVERSIONS"),t}}createEffect(e,t,i,s,r,n,o,l,h,c=Xt.GLSL){var u;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines();let _=(u=r!=null?r:t.defines)!==null&&u!==void 0?u:"";p&&(_+=p);const m=d+"+"+f+"@"+_;if(this._compiledEffects[m]){const x=this._compiledEffects[m];return o&&x.isReady()&&o(x),x}const v=new Rt(e,t,i,s,this,r,n,o,l,h,m,c);return this._compiledEffects[m]=v,v}static _ConcatenateShader(e,t,i=""){return i+(t?t+`
`:"")+e}_compileShader(e,t,i,s){return this._compileRawShader(Te._ConcatenateShader(e,i,s),t)}_compileRawShader(e,t){const i=this._gl,s=i.createShader(t==="vertex"?i.VERTEX_SHADER:i.FRAGMENT_SHADER);if(!s){let r=i.NO_ERROR,n=i.NO_ERROR;for(;(n=i.getError())!==i.NO_ERROR;)r=n;throw new Error(`Something went wrong while creating a gl ${t} shader object. gl error=${r}, gl isContextLost=${i.isContextLost()}, _contextWasLost=${this._contextWasLost}`)}return i.shaderSource(s,e),i.compileShader(s),s}_getShaderSource(e){return this._gl.getShaderSource(e)}createRawShaderProgram(e,t,i,s,r=null){s=s||this._gl;const n=this._compileRawShader(t,"vertex"),o=this._compileRawShader(i,"fragment");return this._createShaderProgram(e,n,o,s,r)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl;const o=this._webGLVersion>1?`#version 300 es
#define WEBGL2 
`:"",l=this._compileShader(t,"vertex",s,o),h=this._compileShader(i,"fragment",s,o);return this._createShaderProgram(e,l,h,r,n)}inlineShaderCode(e){return e}createPipelineContext(e){const t=new tv;return t.engine=this,this._caps.parallelShaderCompile&&(t.isParallelCompiled=!0),t}createMaterialContext(){}createDrawContext(){}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");return s.attachShader(n,t),s.attachShader(n,i),s.linkProgram(n),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_finalizePipelineContext(e){const t=e.context,i=e.vertexShader,s=e.fragmentShader,r=e.program;if(!t.getProgramParameter(r,t.LINK_STATUS)){if(!this._gl.getShaderParameter(i,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(i);if(l)throw e.vertexCompilationError=l,new Error("VERTEX SHADER "+l)}if(!this._gl.getShaderParameter(s,this._gl.COMPILE_STATUS)){const l=this._gl.getShaderInfoLog(s);if(l)throw e.fragmentCompilationError=l,new Error("FRAGMENT SHADER "+l)}const o=t.getProgramInfoLog(r);if(o)throw e.programLinkError=o,new Error(o)}if(this.validateShaderPrograms&&(t.validateProgram(r),!t.getProgramParameter(r,t.VALIDATE_STATUS))){const l=t.getProgramInfoLog(r);if(l)throw e.programValidationError=l,new Error(l)}t.deleteShader(i),t.deleteShader(s),e.vertexShader=void 0,e.fragmentShader=void 0,e.onCompiled&&(e.onCompiled(),e.onCompiled=void 0)}_preparePipelineContext(e,t,i,s,r,n,o,l,h,c){const u=e;s?u.program=this.createRawShaderProgram(u,t,i,void 0,h):u.program=this.createShaderProgram(u,t,i,l,void 0,h),u.program.__SPECTOR_rebuildProgram=o}_isRenderingStateCompiled(e){const t=e;return this._gl.getProgramParameter(t.program,this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)?(this._finalizePipelineContext(t),!0):!1}_executeWhenRenderingStateIsCompiled(e,t){const i=e;if(!i.isParallelCompiled){t();return}const s=i.onCompiled;s?i.onCompiled=()=>{s(),t()}:i.onCompiled=t}getUniforms(e,t){const i=new Array,s=e;for(let r=0;r<t.length;r++)i.push(this._gl.getUniformLocation(s.program,t[r]));return i}getAttributes(e,t){const i=[],s=e;for(let r=0;r<t.length;r++)try{i.push(this._gl.getAttribLocation(s.program,t[r]))}catch{i.push(-1)}return i}enableEffect(e){e=e!==null&&Vi.IsWrapper(e)?e.effect:e,!(!e||e===this._currentEffect)&&(this._stencilStateComposer.stencilMaterial=void 0,e=e,this.bindSamplers(e),this._currentEffect=e,e.onBind&&e.onBind(e),e._onBindObservable&&e._onBindObservable.notifyObservers(e))}setInt(e,t){return e?(this._gl.uniform1i(e,t),!0):!1}setInt2(e,t,i){return e?(this._gl.uniform2i(e,t,i),!0):!1}setInt3(e,t,i,s){return e?(this._gl.uniform3i(e,t,i,s),!0):!1}setInt4(e,t,i,s,r){return e?(this._gl.uniform4i(e,t,i,s,r),!0):!1}setIntArray(e,t){return e?(this._gl.uniform1iv(e,t),!0):!1}setIntArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2iv(e,t),!0)}setIntArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3iv(e,t),!0)}setIntArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4iv(e,t),!0)}setArray(e,t){return!e||t.length<1?!1:(this._gl.uniform1fv(e,t),!0)}setArray2(e,t){return!e||t.length%2!==0?!1:(this._gl.uniform2fv(e,t),!0)}setArray3(e,t){return!e||t.length%3!==0?!1:(this._gl.uniform3fv(e,t),!0)}setArray4(e,t){return!e||t.length%4!==0?!1:(this._gl.uniform4fv(e,t),!0)}setMatrices(e,t){return e?(this._gl.uniformMatrix4fv(e,!1,t),!0):!1}setMatrix3x3(e,t){return e?(this._gl.uniformMatrix3fv(e,!1,t),!0):!1}setMatrix2x2(e,t){return e?(this._gl.uniformMatrix2fv(e,!1,t),!0):!1}setFloat(e,t){return e?(this._gl.uniform1f(e,t),!0):!1}setFloat2(e,t,i){return e?(this._gl.uniform2f(e,t,i),!0):!1}setFloat3(e,t,i,s){return e?(this._gl.uniform3f(e,t,i,s),!0):!1}setFloat4(e,t,i,s,r){return e?(this._gl.uniform4f(e,t,i,s,r),!0):!1}applyStates(){if(this._depthCullingState.apply(this._gl),this._stencilStateComposer.apply(this._gl),this._alphaState.apply(this._gl),this._colorWriteChanged){this._colorWriteChanged=!1;const e=this._colorWrite;this._gl.colorMask(e,e,e,e)}}setColorWrite(e){e!==this._colorWrite&&(this._colorWriteChanged=!0,this._colorWrite=e)}getColorWrite(){return this._colorWrite}get depthCullingState(){return this._depthCullingState}get alphaState(){return this._alphaState}get stencilState(){return this._stencilState}get stencilStateComposer(){return this._stencilStateComposer}clearInternalTexturesCache(){this._internalTexturesCache.length=0}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._currentEffect=null,this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0,this._unbindVertexArrayObject(),e&&(this._currentProgram=null,this.resetTextureCache(),this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=this._gl.LEQUAL,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._colorWrite=!0,this._colorWriteChanged=!0,this._unpackFlipYCached=null,this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL,this._gl.NONE),this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),this._mustWipeVertexAttributes=!0,this.unbindAllAttributes()),this._resetVertexBufferBinding(),this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null,this.bindIndexBuffer(null))}_getSamplingParameters(e,t){const i=this._gl;let s=i.NEAREST,r=i.NEAREST;switch(e){case 11:s=i.LINEAR,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 3:s=i.LINEAR,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 8:s=i.NEAREST,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 4:s=i.NEAREST,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 5:s=i.NEAREST,t?r=i.LINEAR_MIPMAP_NEAREST:r=i.LINEAR;break;case 6:s=i.NEAREST,t?r=i.LINEAR_MIPMAP_LINEAR:r=i.LINEAR;break;case 7:s=i.NEAREST,r=i.LINEAR;break;case 1:s=i.NEAREST,r=i.NEAREST;break;case 9:s=i.LINEAR,t?r=i.NEAREST_MIPMAP_NEAREST:r=i.NEAREST;break;case 10:s=i.LINEAR,t?r=i.NEAREST_MIPMAP_LINEAR:r=i.NEAREST;break;case 2:s=i.LINEAR,r=i.LINEAR;break;case 12:s=i.LINEAR,r=i.NEAREST;break}return{min:r,mag:s}}_createTexture(){const e=this._gl.createTexture();if(!e)throw new Error("Unable to create texture");return e}_createHardwareTexture(){return new zl(this._createTexture(),this._gl)}_createInternalTexture(e,t,i=!0,s=We.Unknown){const r={};t!==void 0&&typeof t=="object"?(r.generateMipMaps=t.generateMipMaps,r.type=t.type===void 0?0:t.type,r.samplingMode=t.samplingMode===void 0?3:t.samplingMode,r.format=t.format===void 0?5:t.format,r.useSRGBBuffer=t.useSRGBBuffer===void 0?!1:t.useSRGBBuffer):(r.generateMipMaps=t,r.type=0,r.samplingMode=3,r.format=5,r.useSRGBBuffer=!1),r.useSRGBBuffer=r.useSRGBBuffer&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU),(r.type===1&&!this._caps.textureFloatLinearFiltering||r.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(r.samplingMode=1),r.type===1&&!this._caps.textureFloat&&(r.type=0,B.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const n=this._gl,o=new gt(this,s);o._useSRGBBuffer=!!r.useSRGBBuffer;const l=e.width||e,h=e.height||e,c=e.layers||0,u=this._getSamplingParameters(r.samplingMode,!!r.generateMipMaps),d=c!==0?n.TEXTURE_2D_ARRAY:n.TEXTURE_2D,f=this._getRGBABufferInternalSizedFormat(r.type,r.format,r.useSRGBBuffer),p=this._getInternalFormat(r.format),_=this._getWebGLTextureType(r.type);return this._bindTextureDirectly(d,o),c!==0?(o.is2DArray=!0,n.texImage3D(d,0,f,l,h,c,0,p,_,null)):n.texImage2D(d,0,f,l,h,0,p,_,null),n.texParameteri(d,n.TEXTURE_MAG_FILTER,u.mag),n.texParameteri(d,n.TEXTURE_MIN_FILTER,u.min),n.texParameteri(d,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(d,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),r.generateMipMaps&&this._gl.generateMipmap(d),this._bindTextureDirectly(d,null),o.baseWidth=l,o.baseHeight=h,o.width=l,o.height=h,o.depth=c,o.isReady=!0,o.samples=1,o.generateMipMaps=!!r.generateMipMaps,o.samplingMode=r.samplingMode,o.type=r.type,o.format=r.format,this._internalTexturesCache.push(o),o}_getUseSRGBBuffer(e,t){return e&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||t)}_createTextureBase(e,t,i,s,r=3,n=null,o=null,l,h,c=null,u=null,d=null,f=null,p,_,m){e=e||"";const v=e.substr(0,5)==="data:",x=e.substr(0,5)==="blob:",b=v&&e.indexOf(";base64,")!==-1,S=u||new gt(this,We.Url),C=e;this._transformTextureUrl&&!b&&!u&&!c&&(e=this._transformTextureUrl(e)),C!==e&&(S._originalUrl=C);const E=e.lastIndexOf(".");let A=f||(E>-1?e.substring(E).toLowerCase():""),M=null;A.indexOf("?")>-1&&(A=A.split("?")[0]);for(const N of Te._TextureLoaders)if(N.canLoad(A,p)){M=N;break}s&&s.addPendingData(S),S.url=e,S.generateMipMaps=!t,S.samplingMode=r,S.invertY=i,S._useSRGBBuffer=this._getUseSRGBBuffer(!!m,t),this._doNotHandleContextLost||(S._buffer=c);let P=null;n&&!u&&(P=S.onLoadedObservable.add(n)),u||this._internalTexturesCache.push(S);const O=(N,$)=>{s&&s.removePendingData(S),e===C?(P&&S.onLoadedObservable.remove(P),ye.UseFallbackTexture&&this._createTextureBase(ye.FallbackTexture,t,S.invertY,s,r,null,o,l,h,c,S),N=(N||"Unknown error")+(ye.UseFallbackTexture?" - Fallback texture was used":""),S.onErrorObservable.notifyObservers({message:N,exception:$}),o&&o(N,$)):(B.Warn(`Failed to load ${e}, falling back to ${C}`),this._createTextureBase(C,t,S.invertY,s,r,n,o,l,h,c,S,d,f,p,_,m))};if(M){const N=$=>{M.loadData($,S,(W,K,te,ve,_e,j)=>{j?O("TextureLoader failed to load data"):l(S,A,s,{width:W,height:K},S.invertY,!te,ve,()=>(_e(),!1),r)},_)};c?c instanceof ArrayBuffer?N(new Uint8Array(c)):ArrayBuffer.isView(c)?N(c):o&&o("Unable to load: only ArrayBuffer or ArrayBufferView is supported",null):this._loadFile(e,$=>N(new Uint8Array($)),void 0,s?s.offlineProvider:void 0,!0,($,W)=>{O("Unable to load "+($&&$.responseURL,W))})}else{const N=$=>{x&&!this._doNotHandleContextLost&&(S._buffer=$),l(S,A,s,$,S.invertY,t,!1,h,r)};!v||b?c&&(typeof c.decoding=="string"||c.close)?N(c):Te._FileToolsLoadImage(e,N,O,s?s.offlineProvider:null,p,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):typeof c=="string"||c instanceof ArrayBuffer||ArrayBuffer.isView(c)||c instanceof Blob?Te._FileToolsLoadImage(c,N,O,s?s.offlineProvider:null,p,S.invertY&&this._features.needsInvertingBitmap?{imageOrientation:"flipY"}:void 0):c&&N(c)}return S}createTexture(e,t,i,s,r=3,n=null,o=null,l=null,h=null,c=null,u=null,d,f,p,_){return this._createTextureBase(e,t,i,s,r,n,o,this._prepareWebGLTexture.bind(this),(m,v,x,b,S,C)=>{const E=this._gl,A=x.width===m&&x.height===v,M=c?this._getInternalFormat(c,S._useSRGBBuffer):b===".jpg"&&!S._useSRGBBuffer?E.RGB:S._useSRGBBuffer?E.SRGB8_ALPHA8:E.RGBA;let D=c?this._getInternalFormat(c):b===".jpg"&&!S._useSRGBBuffer?E.RGB:E.RGBA;if(S._useSRGBBuffer&&this.webGLVersion===1&&(D=M),A)return E.texImage2D(E.TEXTURE_2D,0,M,D,E.UNSIGNED_BYTE,x),!1;const P=this._caps.maxTextureSize;if(x.width>P||x.height>P||!this._supportsHardwareTextureRescaling)return this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext||(this._workingCanvas.width=m,this._workingCanvas.height=v,this._workingContext.drawImage(x,0,0,x.width,x.height,0,0,m,v),E.texImage2D(E.TEXTURE_2D,0,M,D,E.UNSIGNED_BYTE,this._workingCanvas),S.width=m,S.height=v),!1;{const O=new gt(this,We.Temp);this._bindTextureDirectly(E.TEXTURE_2D,O,!0),E.texImage2D(E.TEXTURE_2D,0,M,D,E.UNSIGNED_BYTE,x),this._rescaleTexture(O,S,s,M,()=>{this._releaseTexture(O),this._bindTextureDirectly(E.TEXTURE_2D,S,!0),C()})}return!0},l,h,c,u,d,f,_)}static _FileToolsLoadImage(e,t,i,s,r,n){throw Ve("FileTools")}_rescaleTexture(e,t,i,s,r){}createRawTexture(e,t,i,s,r,n,o,l=null,h=0,c=0,u=!1){throw Ve("Engine.RawTexture")}createRawCubeTexture(e,t,i,s,r,n,o,l=null){throw Ve("Engine.RawTexture")}createRawTexture3D(e,t,i,s,r,n,o,l,h=null,c=0){throw Ve("Engine.RawTexture")}createRawTexture2DArray(e,t,i,s,r,n,o,l,h=null,c=0){throw Ve("Engine.RawTexture")}_unpackFlipY(e){this._unpackFlipYCached!==e&&(this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL,e?1:0),this.enableUnpackFlipYCached&&(this._unpackFlipYCached=e))}_getUnpackAlignement(){return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT)}_getTextureTarget(e){return e.isCube?this._gl.TEXTURE_CUBE_MAP:e.is3D?this._gl.TEXTURE_3D:e.is2DArray||e.isMultiview?this._gl.TEXTURE_2D_ARRAY:this._gl.TEXTURE_2D}updateTextureSamplingMode(e,t,i=!1){const s=this._getTextureTarget(t),r=this._getSamplingParameters(e,t.generateMipMaps||i);this._setTextureParameterInteger(s,this._gl.TEXTURE_MAG_FILTER,r.mag,t),this._setTextureParameterInteger(s,this._gl.TEXTURE_MIN_FILTER,r.min),i&&(t.generateMipMaps=!0,this._gl.generateMipmap(s)),this._bindTextureDirectly(s,null),t.samplingMode=e}updateTextureDimensions(e,t,i,s=1){}updateTextureWrappingMode(e,t,i=null,s=null){const r=this._getTextureTarget(e);t!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t),e),e._cachedWrapU=t),i!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(i),e),e._cachedWrapV=i),(e.is2DArray||e.is3D)&&s!==null&&(this._setTextureParameterInteger(r,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(s),e),e._cachedWrapR=s),this._bindTextureDirectly(r,null)}_setupDepthStencilTexture(e,t,i,s,r,n=1){const o=t.width||t,l=t.height||t,h=t.layers||0;e.baseWidth=o,e.baseHeight=l,e.width=o,e.height=l,e.is2DArray=h>0,e.depth=h,e.isReady=!0,e.samples=n,e.generateMipMaps=!1,e.samplingMode=s?2:1,e.type=0,e._comparisonFunction=r;const c=this._gl,u=this._getTextureTarget(e),d=this._getSamplingParameters(e.samplingMode,!1);c.texParameteri(u,c.TEXTURE_MAG_FILTER,d.mag),c.texParameteri(u,c.TEXTURE_MIN_FILTER,d.min),c.texParameteri(u,c.TEXTURE_WRAP_S,c.CLAMP_TO_EDGE),c.texParameteri(u,c.TEXTURE_WRAP_T,c.CLAMP_TO_EDGE),this.webGLVersion>1&&(r===0?(c.texParameteri(u,c.TEXTURE_COMPARE_FUNC,515),c.texParameteri(u,c.TEXTURE_COMPARE_MODE,c.NONE)):(c.texParameteri(u,c.TEXTURE_COMPARE_FUNC,r),c.texParameteri(u,c.TEXTURE_COMPARE_MODE,c.COMPARE_REF_TO_TEXTURE)))}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){const l=this._gl;let h=l.TEXTURE_2D;if(e.isCube&&(h=l.TEXTURE_CUBE_MAP_POSITIVE_X+n),e._useSRGBBuffer)switch(t){case 37492:case 36196:this._caps.etc2?t=l.COMPRESSED_SRGB8_ETC2:e._useSRGBBuffer=!1;break;case 37496:this._caps.etc2?t=l.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:e._useSRGBBuffer=!1;break;case 36492:t=l.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT;break;case 37808:t=l.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case 33776:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33777:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:e._useSRGBBuffer=!1;break;case 33779:this._caps.s3tc_srgb?t=l.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:e._useSRGBBuffer=!1;break;default:e._useSRGBBuffer=!1;break}this._gl.compressedTexImage2D(h,o,t,i,s,0,r)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){const o=this._gl,l=this._getWebGLTextureType(e.type),h=this._getInternalFormat(e.format),c=r===void 0?this._getRGBABufferInternalSizedFormat(e.type,e.format,e._useSRGBBuffer):this._getInternalFormat(r,e._useSRGBBuffer);this._unpackFlipY(e.invertY);let u=o.TEXTURE_2D;e.isCube&&(u=o.TEXTURE_CUBE_MAP_POSITIVE_X+i);const d=Math.round(Math.log(e.width)*Math.LOG2E),f=Math.round(Math.log(e.height)*Math.LOG2E),p=n?e.width:Math.pow(2,Math.max(d-s,0)),_=n?e.height:Math.pow(2,Math.max(f-s,0));o.texImage2D(u,s,c,p,_,0,h,l,t)}updateTextureData(e,t,i,s,r,n,o=0,l=0,h=!1){const c=this._gl,u=this._getWebGLTextureType(e.type),d=this._getInternalFormat(e.format);this._unpackFlipY(e.invertY);let f=c.TEXTURE_2D;e.isCube&&(f=c.TEXTURE_CUBE_MAP_POSITIVE_X+o),this._bindTextureDirectly(f,e,!0),c.texSubImage2D(f,l,i,s,r,n,d,u,t),h&&this._gl.generateMipmap(f),this._bindTextureDirectly(f,null)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){const r=this._gl,n=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(n,e,!0),this._uploadDataToTextureDirectly(e,t,i,s),this._bindTextureDirectly(n,null,!0)}_prepareWebGLTextureContinuation(e,t,i,s,r){const n=this._gl;if(!n)return;const o=this._getSamplingParameters(r,!i);n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,o.mag),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,o.min),!i&&!s&&n.generateMipmap(n.TEXTURE_2D),this._bindTextureDirectly(n.TEXTURE_2D,null),t&&t.removePendingData(e),e.onLoadedObservable.notifyObservers(e),e.onLoadedObservable.clear()}_prepareWebGLTexture(e,t,i,s,r,n,o,l,h=3){const c=this.getCaps().maxTextureSize,u=Math.min(c,this.needPOTTextures?Te.GetExponentOfTwo(s.width,c):s.width),d=Math.min(c,this.needPOTTextures?Te.GetExponentOfTwo(s.height,c):s.height),f=this._gl;if(!!f){if(!e._hardwareTexture){i&&i.removePendingData(e);return}this._bindTextureDirectly(f.TEXTURE_2D,e,!0),this._unpackFlipY(r===void 0?!0:!!r),e.baseWidth=s.width,e.baseHeight=s.height,e.width=u,e.height=d,e.isReady=!0,!l(u,d,s,t,e,()=>{this._prepareWebGLTextureContinuation(e,i,n,o,h)})&&this._prepareWebGLTextureContinuation(e,i,n,o,h)}}_setupFramebufferDepthAttachments(e,t,i,s,r=1){const n=this._gl;if(e&&t)return this._createRenderBuffer(i,s,r,n.DEPTH_STENCIL,n.DEPTH24_STENCIL8,n.DEPTH_STENCIL_ATTACHMENT);if(t){let o=n.DEPTH_COMPONENT16;return this._webGLVersion>1&&(o=n.DEPTH_COMPONENT32F),this._createRenderBuffer(i,s,r,o,o,n.DEPTH_ATTACHMENT)}return e?this._createRenderBuffer(i,s,r,n.STENCIL_INDEX8,n.STENCIL_INDEX8,n.STENCIL_ATTACHMENT):null}_createRenderBuffer(e,t,i,s,r,n,o=!0){const h=this._gl.createRenderbuffer();return this._updateRenderBuffer(h,e,t,i,s,r,n,o)}_updateRenderBuffer(e,t,i,s,r,n,o,l=!0){const h=this._gl;return h.bindRenderbuffer(h.RENDERBUFFER,e),s>1&&h.renderbufferStorageMultisample?h.renderbufferStorageMultisample(h.RENDERBUFFER,s,n,t,i):h.renderbufferStorage(h.RENDERBUFFER,r,t,i),h.framebufferRenderbuffer(h.FRAMEBUFFER,o,h.RENDERBUFFER,e),l&&h.bindRenderbuffer(h.RENDERBUFFER,null),e}_releaseTexture(e){var t;this._deleteTexture((t=e._hardwareTexture)===null||t===void 0?void 0:t.underlyingResource),this.unbindAllTextures();const i=this._internalTexturesCache.indexOf(e);i!==-1&&this._internalTexturesCache.splice(i,1),e._lodTextureHigh&&e._lodTextureHigh.dispose(),e._lodTextureMid&&e._lodTextureMid.dispose(),e._lodTextureLow&&e._lodTextureLow.dispose(),e._irradianceTexture&&e._irradianceTexture.dispose()}_releaseRenderTargetWrapper(e){const t=this._renderTargetWrapperCache.indexOf(e);t!==-1&&this._renderTargetWrapperCache.splice(t,1)}_deleteTexture(e){e&&this._gl.deleteTexture(e)}_setProgram(e){this._currentProgram!==e&&(this._gl.useProgram(e),this._currentProgram=e)}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.program);const i=e.getSamplers();for(let s=0;s<i.length;s++){const r=e.getUniform(i[s]);r&&(this._boundUniforms[s]=r)}this._currentEffect=null}_activateCurrentTexture(){this._currentTextureChannel!==this._activeChannel&&(this._gl.activeTexture(this._gl.TEXTURE0+this._activeChannel),this._currentTextureChannel=this._activeChannel)}_bindTextureDirectly(e,t,i=!1,s=!1){var r,n;let o=!1;const l=t&&t._associatedChannel>-1;if(i&&l&&(this._activeChannel=t._associatedChannel),this._boundTexturesCache[this._activeChannel]!==t||s){if(this._activateCurrentTexture(),t&&t.isMultiview)throw console.error(e,t),"_bindTextureDirectly called with a multiview texture!";this._gl.bindTexture(e,(n=(r=t==null?void 0:t._hardwareTexture)===null||r===void 0?void 0:r.underlyingResource)!==null&&n!==void 0?n:null),this._boundTexturesCache[this._activeChannel]=t,t&&(t._associatedChannel=this._activeChannel)}else i&&(o=!0,this._activateCurrentTexture());return l&&!i&&this._bindSamplerUniformToChannel(t._associatedChannel,this._activeChannel),o}_bindTexture(e,t,i){if(e===void 0)return;t&&(t._associatedChannel=e),this._activeChannel=e;const s=t?this._getTextureTarget(t):this._gl.TEXTURE_2D;this._bindTextureDirectly(s,t)}unbindAllTextures(){for(let e=0;e<this._maxSimultaneousTextures;e++)this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))}setTexture(e,t,i,s){e!==void 0&&(t&&(this._boundUniforms[e]=t),this._setTexture(e,i))}_bindSamplerUniformToChannel(e,t){const i=this._boundUniforms[e];!i||i._currentState===t||(this._gl.uniform1i(i,t),i._currentState=t)}_getTextureWrapMode(e){switch(e){case 1:return this._gl.REPEAT;case 0:return this._gl.CLAMP_TO_EDGE;case 2:return this._gl.MIRRORED_REPEAT}return this._gl.REPEAT}_setTexture(e,t,i=!1,s=!1,r=""){if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),this.webGLVersion>1&&(this._bindTextureDirectly(this._gl.TEXTURE_3D,null),this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY,null))),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;s?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,!i&&n&&(n._associatedChannel=e);let o=!0;this._boundTexturesCache[e]===n&&(i||this._bindSamplerUniformToChannel(n._associatedChannel,e),o=!1),this._activeChannel=e;const l=this._getTextureTarget(n);if(o&&this._bindTextureDirectly(l,n,i),n&&!n.isMultiview){if(n.isCube&&n._cachedCoordinatesMode!==t.coordinatesMode){n._cachedCoordinatesMode=t.coordinatesMode;const h=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=h,t.wrapV=h}n._cachedWrapU!==t.wrapU&&(n._cachedWrapU=t.wrapU,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_S,this._getTextureWrapMode(t.wrapU),n)),n._cachedWrapV!==t.wrapV&&(n._cachedWrapV=t.wrapV,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_T,this._getTextureWrapMode(t.wrapV),n)),n.is3D&&n._cachedWrapR!==t.wrapR&&(n._cachedWrapR=t.wrapR,this._setTextureParameterInteger(l,this._gl.TEXTURE_WRAP_R,this._getTextureWrapMode(t.wrapR),n)),this._setAnisotropicLevel(l,n,t.anisotropicFilteringLevel)}return!0}setTextureArray(e,t,i,s){if(!(e===void 0||!t)){(!this._textureUnits||this._textureUnits.length!==i.length)&&(this._textureUnits=new Int32Array(i.length));for(let r=0;r<i.length;r++){const n=i[r].getInternalTexture();n?(this._textureUnits[r]=e+r,n._associatedChannel=e+r):this._textureUnits[r]=-1}this._gl.uniform1iv(t,this._textureUnits);for(let r=0;r<i.length;r++)this._setTexture(this._textureUnits[r],i[r],!0)}}_setAnisotropicLevel(e,t,i){const s=this._caps.textureAnisotropicFilterExtension;t.samplingMode!==11&&t.samplingMode!==3&&t.samplingMode!==2&&(i=1),s&&t._cachedAnisotropicFilteringLevel!==i&&(this._setTextureParameterFloat(e,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(i,this._caps.maxAnisotropy),t),t._cachedAnisotropicFilteringLevel=i)}_setTextureParameterFloat(e,t,i,s){this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameterf(e,t,i)}_setTextureParameterInteger(e,t,i,s){s&&this._bindTextureDirectly(e,s,!0,!0),this._gl.texParameteri(e,t,i)}unbindAllAttributes(){if(this._mustWipeVertexAttributes){this._mustWipeVertexAttributes=!1;for(let e=0;e<this._caps.maxVertexAttribs;e++)this.disableAttributeByIndex(e);return}for(let e=0,t=this._vertexAttribArraysEnabled.length;e<t;e++)e>=this._caps.maxVertexAttribs||!this._vertexAttribArraysEnabled[e]||this.disableAttributeByIndex(e)}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}dispose(){var e;this.stopRenderLoop(),this.onBeforeTextureInitObservable&&this.onBeforeTextureInitObservable.clear(),this._emptyTexture&&(this._releaseTexture(this._emptyTexture),this._emptyTexture=null),this._emptyCubeTexture&&(this._releaseTexture(this._emptyCubeTexture),this._emptyCubeTexture=null),this._dummyFramebuffer&&this._gl.deleteFramebuffer(this._dummyFramebuffer),this.releaseEffects(),(e=this.releaseComputeEffects)===null||e===void 0||e.call(this),this.unbindAllAttributes(),this._boundUniforms={},Ht()&&this._renderingCanvas&&(this._doNotHandleContextLost||(this._renderingCanvas.removeEventListener("webglcontextlost",this._onContextLost),this._renderingCanvas.removeEventListener("webglcontextrestored",this._onContextRestored)),window.removeEventListener("resize",this._checkForMobile)),this._workingCanvas=null,this._workingContext=null,this._currentBufferPointers.length=0,this._renderingCanvas=null,this._currentProgram=null,this._boundRenderFunction=null,Rt.ResetCache();for(const t of this._activeRequests)t.abort();this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}attachContextLostEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextlost",e,!1)}attachContextRestoredEvent(e){this._renderingCanvas&&this._renderingCanvas.addEventListener("webglcontextrestored",e,!1)}getError(){return this._gl.getError()}_canRenderToFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(1)}_canRenderToHalfFloatFramebuffer(){return this._webGLVersion>1?this._caps.colorBufferFloat:this._canRenderToFramebuffer(2)}_canRenderToFramebuffer(e){const t=this._gl;for(;t.getError()!==t.NO_ERROR;);let i=!0;const s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texImage2D(t.TEXTURE_2D,0,this._getRGBABufferInternalSizedFormat(e),1,1,0,t.RGBA,this._getWebGLTextureType(e),null),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST);const r=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,r),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0);const n=t.checkFramebufferStatus(t.FRAMEBUFFER);if(i=i&&n===t.FRAMEBUFFER_COMPLETE,i=i&&t.getError()===t.NO_ERROR,i&&(t.clear(t.COLOR_BUFFER_BIT),i=i&&t.getError()===t.NO_ERROR),i){t.bindFramebuffer(t.FRAMEBUFFER,null);const o=t.RGBA,l=t.UNSIGNED_BYTE,h=new Uint8Array(4);t.readPixels(0,0,1,1,o,l,h),i=i&&t.getError()===t.NO_ERROR}for(t.deleteTexture(s),t.deleteFramebuffer(r),t.bindFramebuffer(t.FRAMEBUFFER,null);!i&&t.getError()!==t.NO_ERROR;);return i}_getWebGLTextureType(e){if(this._webGLVersion===1){switch(e){case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT_OES;case 0:return this._gl.UNSIGNED_BYTE;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5}return this._gl.UNSIGNED_BYTE}switch(e){case 3:return this._gl.BYTE;case 0:return this._gl.UNSIGNED_BYTE;case 4:return this._gl.SHORT;case 5:return this._gl.UNSIGNED_SHORT;case 6:return this._gl.INT;case 7:return this._gl.UNSIGNED_INT;case 1:return this._gl.FLOAT;case 2:return this._gl.HALF_FLOAT;case 8:return this._gl.UNSIGNED_SHORT_4_4_4_4;case 9:return this._gl.UNSIGNED_SHORT_5_5_5_1;case 10:return this._gl.UNSIGNED_SHORT_5_6_5;case 11:return this._gl.UNSIGNED_INT_2_10_10_10_REV;case 12:return this._gl.UNSIGNED_INT_24_8;case 13:return this._gl.UNSIGNED_INT_10F_11F_11F_REV;case 14:return this._gl.UNSIGNED_INT_5_9_9_9_REV;case 15:return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV}return this._gl.UNSIGNED_BYTE}_getInternalFormat(e,t=!1){let i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;switch(e){case 0:i=this._gl.ALPHA;break;case 1:i=this._gl.LUMINANCE;break;case 2:i=this._gl.LUMINANCE_ALPHA;break;case 6:i=this._gl.RED;break;case 7:i=this._gl.RG;break;case 4:i=t?this._gl.SRGB:this._gl.RGB;break;case 5:i=t?this._gl.SRGB8_ALPHA8:this._gl.RGBA;break}if(this._webGLVersion>1)switch(e){case 8:i=this._gl.RED_INTEGER;break;case 9:i=this._gl.RG_INTEGER;break;case 10:i=this._gl.RGB_INTEGER;break;case 11:i=this._gl.RGBA_INTEGER;break}return i}_getRGBABufferInternalSizedFormat(e,t,i=!1){if(this._webGLVersion===1){if(t!==void 0)switch(t){case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;case 4:return i?this._gl.SRGB:this._gl.RGB}return this._gl.RGBA}switch(e){case 3:switch(t){case 6:return this._gl.R8_SNORM;case 7:return this._gl.RG8_SNORM;case 4:return this._gl.RGB8_SNORM;case 8:return this._gl.R8I;case 9:return this._gl.RG8I;case 10:return this._gl.RGB8I;case 11:return this._gl.RGBA8I;default:return this._gl.RGBA8_SNORM}case 0:switch(t){case 6:return this._gl.R8;case 7:return this._gl.RG8;case 4:return i?this._gl.SRGB8:this._gl.RGB8;case 5:return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8;case 8:return this._gl.R8UI;case 9:return this._gl.RG8UI;case 10:return this._gl.RGB8UI;case 11:return this._gl.RGBA8UI;case 0:return this._gl.ALPHA;case 1:return this._gl.LUMINANCE;case 2:return this._gl.LUMINANCE_ALPHA;default:return this._gl.RGBA8}case 4:switch(t){case 8:return this._gl.R16I;case 9:return this._gl.RG16I;case 10:return this._gl.RGB16I;case 11:return this._gl.RGBA16I;default:return this._gl.RGBA16I}case 5:switch(t){case 8:return this._gl.R16UI;case 9:return this._gl.RG16UI;case 10:return this._gl.RGB16UI;case 11:return this._gl.RGBA16UI;default:return this._gl.RGBA16UI}case 6:switch(t){case 8:return this._gl.R32I;case 9:return this._gl.RG32I;case 10:return this._gl.RGB32I;case 11:return this._gl.RGBA32I;default:return this._gl.RGBA32I}case 7:switch(t){case 8:return this._gl.R32UI;case 9:return this._gl.RG32UI;case 10:return this._gl.RGB32UI;case 11:return this._gl.RGBA32UI;default:return this._gl.RGBA32UI}case 1:switch(t){case 6:return this._gl.R32F;case 7:return this._gl.RG32F;case 4:return this._gl.RGB32F;case 5:return this._gl.RGBA32F;default:return this._gl.RGBA32F}case 2:switch(t){case 6:return this._gl.R16F;case 7:return this._gl.RG16F;case 4:return this._gl.RGB16F;case 5:return this._gl.RGBA16F;default:return this._gl.RGBA16F}case 10:return this._gl.RGB565;case 13:return this._gl.R11F_G11F_B10F;case 14:return this._gl.RGB9_E5;case 8:return this._gl.RGBA4;case 9:return this._gl.RGB5_A1;case 11:switch(t){case 5:return this._gl.RGB10_A2;case 11:return this._gl.RGB10_A2UI;default:return this._gl.RGB10_A2}}return i?this._gl.SRGB8_ALPHA8:this._gl.RGBA8}_getRGBAMultiSampleBufferFormat(e){return e===1?this._gl.RGBA32F:e===2?this._gl.RGBA16F:this._gl.RGBA8}_loadFile(e,t,i,s,r,n){const o=Te._FileToolsLoadFile(e,t,i,s,r,n);return this._activeRequests.push(o),o.onCompleteObservable.add(l=>{this._activeRequests.splice(this._activeRequests.indexOf(l),1)}),o}static _FileToolsLoadFile(e,t,i,s,r,n){throw Ve("FileTools")}readPixels(e,t,i,s,r=!0,n=!0){const o=r?4:3,l=r?this._gl.RGBA:this._gl.RGB,h=new Uint8Array(s*i*o);return n&&this.flushFramebuffer(),this._gl.readPixels(e,t,i,s,l,this._gl.UNSIGNED_BYTE,h),Promise.resolve(h)}static get IsSupportedAsync(){return Promise.resolve(this.isSupported())}static get IsSupported(){return this.isSupported()}static isSupported(){if(this._HasMajorPerformanceCaveat!==null)return!this._HasMajorPerformanceCaveat;if(this._IsSupported===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl")||e.getContext("experimental-webgl");this._IsSupported=t!=null&&!!window.WebGLRenderingContext}catch{this._IsSupported=!1}return this._IsSupported}static get HasMajorPerformanceCaveat(){if(this._HasMajorPerformanceCaveat===null)try{const e=this._CreateCanvas(1,1),t=e.getContext("webgl",{failIfMajorPerformanceCaveat:!0})||e.getContext("experimental-webgl",{failIfMajorPerformanceCaveat:!0});this._HasMajorPerformanceCaveat=!t}catch{this._HasMajorPerformanceCaveat=!1}return this._HasMajorPerformanceCaveat}static CeilingPOT(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e++,e}static FloorPOT(e){return e=e|e>>1,e=e|e>>2,e=e|e>>4,e=e|e>>8,e=e|e>>16,e-(e>>1)}static NearestPOT(e){const t=Te.CeilingPOT(e),i=Te.FloorPOT(e);return t-e>e-i?i:t}static GetExponentOfTwo(e,t,i=2){let s;switch(i){case 1:s=Te.FloorPOT(e);break;case 2:s=Te.NearestPOT(e);break;case 3:default:s=Te.CeilingPOT(e);break}return Math.min(s,t)}static QueueNewFrame(e,t){return Ht()?(t||(t=window),t.requestPostAnimationFrame?t.requestPostAnimationFrame(e):t.requestAnimationFrame?t.requestAnimationFrame(e):window.setTimeout(e,16)):typeof requestAnimationFrame<"u"?requestAnimationFrame(e):setTimeout(e,16)}getHostDocument(){return this._renderingCanvas&&this._renderingCanvas.ownerDocument?this._renderingCanvas.ownerDocument:Bh()?document:null}}Te.ExceptionList=[{key:"Chrome/63.0",capture:"63\\.0\\.3239\\.(\\d+)",captureConstraint:108,targets:["uniformBuffer"]},{key:"Firefox/58",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Firefox/59",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:"Chrome/72.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/73.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Chrome/74.+?Mobile",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/71",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome/72",capture:null,captureConstraint:null,targets:["vao"]},{key:"Mac OS.+Chrome",capture:null,captureConstraint:null,targets:["uniformBuffer"]},{key:".*AppleWebKit.*(15.4).*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]},{key:".*(15.4).*AppleWebKit.*Safari",capture:null,captureConstraint:null,targets:["antialias","maxMSAASamples"]}];Te._TextureLoaders=[];Te.CollisionsEpsilon=.001;Te._IsSupported=null;Te._HasMajorPerformanceCaveat=null;class ps{static get Now(){return Ku.IsWindowObjectExist()&&window.performance&&window.performance.now?window.performance.now():Date.now()}}class sv{constructor(e=30){this._enabled=!0,this._rollingFrameTime=new rv(e)}sampleFrame(e=ps.Now){if(!!this._enabled){if(this._lastFrameTimeMs!=null){const t=e-this._lastFrameTimeMs;this._rollingFrameTime.add(t)}this._lastFrameTimeMs=e}}get averageFrameTime(){return this._rollingFrameTime.average}get averageFrameTimeVariance(){return this._rollingFrameTime.variance}get instantaneousFrameTime(){return this._rollingFrameTime.history(0)}get averageFPS(){return 1e3/this._rollingFrameTime.average}get instantaneousFPS(){const e=this._rollingFrameTime.history(0);return e===0?0:1e3/e}get isSaturated(){return this._rollingFrameTime.isSaturated()}enable(){this._enabled=!0}disable(){this._enabled=!1,this._lastFrameTimeMs=null}get isEnabled(){return this._enabled}reset(){this._lastFrameTimeMs=null,this._rollingFrameTime.reset()}}class rv{constructor(e){this._samples=new Array(e),this.reset()}add(e){let t;if(this.isSaturated()){const i=this._samples[this._pos];t=i-this.average,this.average-=t/(this._sampleCount-1),this._m2-=t*(i-this.average)}else this._sampleCount++;t=e-this.average,this.average+=t/this._sampleCount,this._m2+=t*(e-this.average),this.variance=this._m2/(this._sampleCount-1),this._samples[this._pos]=e,this._pos++,this._pos%=this._samples.length}history(e){if(e>=this._sampleCount||e>=this._samples.length)return 0;const t=this._wrapPosition(this._pos-1);return this._samples[this._wrapPosition(t-e)]}isSaturated(){return this._sampleCount>=this._samples.length}reset(){this.average=0,this.variance=0,this._sampleCount=0,this._pos=0,this._m2=0}_wrapPosition(e){const t=this._samples.length;return(e%t+t)%t}}class _r{constructor(){this._startMonitoringTime=0,this._min=0,this._max=0,this._average=0,this._lastSecAverage=0,this._current=0,this._totalValueCount=0,this._totalAccumulated=0,this._lastSecAccumulated=0,this._lastSecTime=0,this._lastSecValueCount=0}get min(){return this._min}get max(){return this._max}get average(){return this._average}get lastSecAverage(){return this._lastSecAverage}get current(){return this._current}get total(){return this._totalAccumulated}get count(){return this._totalValueCount}fetchNewFrame(){this._totalValueCount++,this._current=0,this._lastSecValueCount++}addCount(e,t){!_r.Enabled||(this._current+=e,t&&this._fetchResult())}beginMonitoring(){!_r.Enabled||(this._startMonitoringTime=ps.Now)}endMonitoring(e=!0){if(!_r.Enabled)return;e&&this.fetchNewFrame();const t=ps.Now;this._current=t-this._startMonitoringTime,e&&this._fetchResult()}_fetchResult(){this._totalAccumulated+=this._current,this._lastSecAccumulated+=this._current,this._min=Math.min(this._min,this._current),this._max=Math.max(this._max,this._current),this._average=this._totalAccumulated/this._totalValueCount;const e=ps.Now;e-this._lastSecTime>1e3&&(this._lastSecAverage=this._lastSecAccumulated/this._lastSecValueCount,this._lastSecTime=e,this._lastSecAccumulated=0,this._lastSecValueCount=0)}}_r.Enabled=!0;Te.prototype.setAlphaConstants=function(a,e,t,i){this._alphaState.setAlphaBlendConstants(a,e,t,i)};Te.prototype.setAlphaMode=function(a,e=!1){if(this._alphaMode!==a){switch(a){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ZERO,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_COLOR,this._gl.ZERO,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(this._gl.CONSTANT_COLOR,this._gl.ONE_MINUS_CONSTANT_COLOR,this._gl.CONSTANT_ALPHA,this._gl.ONE_MINUS_CONSTANT_ALPHA),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(this._gl.DST_ALPHA,this._gl.ONE,this._gl.ZERO,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ONE_MINUS_DST_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE,this._gl.ONE,this._gl.ONE,this._gl.ZERO),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(this._gl.ONE_MINUS_DST_COLOR,this._gl.ONE_MINUS_SRC_COLOR,this._gl.ZERO,this._gl.ONE),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(this._gl.SRC_ALPHA,this._gl.ONE_MINUS_SRC_ALPHA,this._gl.ONE,this._gl.ONE_MINUS_SRC_ALPHA),this._alphaState.alphaBlend=!0;break}e||(this.depthCullingState.depthMask=a===0),this._alphaMode=a}};Te.prototype.getAlphaMode=function(){return this._alphaMode};Te.prototype.setAlphaEquation=function(a){if(this._alphaEquation!==a){switch(a){case 0:this._alphaState.setAlphaEquationParameters(32774,32774);break;case 1:this._alphaState.setAlphaEquationParameters(32778,32778);break;case 2:this._alphaState.setAlphaEquationParameters(32779,32779);break;case 3:this._alphaState.setAlphaEquationParameters(32776,32776);break;case 4:this._alphaState.setAlphaEquationParameters(32775,32775);break;case 5:this._alphaState.setAlphaEquationParameters(32775,32774);break}this._alphaEquation=a}};Te.prototype.getAlphaEquation=function(){return this._alphaEquation};function $u(a,e,t=!1,i){switch(a){case 3:{const r=e instanceof ArrayBuffer?new Int8Array(e):new Int8Array(e);return i&&r.set(new Int8Array(i)),r}case 0:{const r=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&r.set(new Uint8Array(i)),r}case 4:{const r=e instanceof ArrayBuffer?new Int16Array(e):new Int16Array(t?e/2:e);return i&&r.set(new Int16Array(i)),r}case 5:case 8:case 9:case 10:case 2:{const r=e instanceof ArrayBuffer?new Uint16Array(e):new Uint16Array(t?e/2:e);return i&&r.set(new Uint16Array(i)),r}case 6:{const r=e instanceof ArrayBuffer?new Int32Array(e):new Int32Array(t?e/4:e);return i&&r.set(new Int32Array(i)),r}case 7:case 11:case 12:case 13:case 14:case 15:{const r=e instanceof ArrayBuffer?new Uint32Array(e):new Uint32Array(t?e/4:e);return i&&r.set(new Uint32Array(i)),r}case 1:{const r=e instanceof ArrayBuffer?new Float32Array(e):new Float32Array(t?e/4:e);return i&&r.set(new Float32Array(i)),r}}const s=e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e);return i&&s.set(new Uint8Array(i)),s}Te.prototype._readTexturePixelsSync=function(a,e,t,i=-1,s=0,r=null,n=!0,o=!1,l=0,h=0){var c,u;const d=this._gl;if(!d)throw new Error("Engine does not have gl rendering context.");if(!this._dummyFramebuffer){const p=d.createFramebuffer();if(!p)throw new Error("Unable to create dummy framebuffer");this._dummyFramebuffer=p}d.bindFramebuffer(d.FRAMEBUFFER,this._dummyFramebuffer),i>-1?d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_CUBE_MAP_POSITIVE_X+i,(c=a._hardwareTexture)===null||c===void 0?void 0:c.underlyingResource,s):d.framebufferTexture2D(d.FRAMEBUFFER,d.COLOR_ATTACHMENT0,d.TEXTURE_2D,(u=a._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,s);let f=a.type!==void 0?this._getWebGLTextureType(a.type):d.UNSIGNED_BYTE;if(o)r||(r=$u(a.type,4*e*t));else switch(f){case d.UNSIGNED_BYTE:r||(r=new Uint8Array(4*e*t)),f=d.UNSIGNED_BYTE;break;default:r||(r=new Float32Array(4*e*t)),f=d.FLOAT;break}return n&&this.flushFramebuffer(),d.readPixels(l,h,e,t,d.RGBA,f,r),d.bindFramebuffer(d.FRAMEBUFFER,this._currentFramebuffer),r};Te.prototype._readTexturePixels=function(a,e,t,i=-1,s=0,r=null,n=!0,o=!1,l=0,h=0){return Promise.resolve(this._readTexturePixelsSync(a,e,t,i,s,r,n,o,l,h))};Te.prototype.updateDynamicIndexBuffer=function(a,e,t=0){this._currentBoundBuffer[this._gl.ELEMENT_ARRAY_BUFFER]=null,this.bindIndexBuffer(a);let i;a.is32Bits?i=e instanceof Uint32Array?e:new Uint32Array(e):i=e instanceof Uint16Array?e:new Uint16Array(e),this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER,i,this._gl.DYNAMIC_DRAW),this._resetIndexBufferBinding()};Te.prototype.updateDynamicVertexBuffer=function(a,e,t,i){this.bindArrayBuffer(a),t===void 0&&(t=0);const s=e.byteLength||e.length;i===void 0||i>=s&&t===0?e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,new Float32Array(e)):this._gl.bufferSubData(this._gl.ARRAY_BUFFER,t,e):e instanceof Array?this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,new Float32Array(e).subarray(t,t+i)):(e instanceof ArrayBuffer?e=new Uint8Array(e,t,i):e=new Uint8Array(e.buffer,e.byteOffset+t,i),this._gl.bufferSubData(this._gl.ARRAY_BUFFER,0,e)),this._resetVertexBufferBinding()};class k extends Te{constructor(e,t,i,s=!1){if(super(e,t,i,s),this.enableOfflineSupport=!1,this.disableManifestCheck=!1,this.disableContextMenu=!0,this.scenes=new Array,this._virtualScenes=new Array,this.onNewSceneAddedObservable=new X,this.postProcesses=new Array,this.isPointerLock=!1,this.onResizeObservable=new X,this.onCanvasBlurObservable=new X,this.onCanvasFocusObservable=new X,this.onCanvasPointerOutObservable=new X,this.onBeginFrameObservable=new X,this.customAnimationFrameRequester=null,this.onEndFrameObservable=new X,this.onBeforeShaderCompilationObservable=new X,this.onAfterShaderCompilationObservable=new X,this._deterministicLockstep=!1,this._lockstepMaxSteps=4,this._timeStep=1/60,this._fps=60,this._deltaTime=0,this._drawCalls=new _r,this.canvasTabIndex=1,this.disablePerformanceMonitorInBackground=!1,this._performanceMonitor=new sv,this._compatibilityMode=!0,this.currentRenderPassId=0,this._renderPassNames=["main"],k.Instances.push(this),!!e){if(this._features.supportRenderPasses=!0,i=this._creationOptions,e.getContext){const r=e;this._sharedInit(r,!!i.doNotHandleTouchAction,i.audioEngine),Ht()&&(this._onFullscreenChange=()=>{this.isFullscreen=!!document.fullscreenElement,this.isFullscreen&&this._pointerLockRequested&&r&&k._RequestPointerlock(r)},document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),document.addEventListener("webkitfullscreenchange",this._onFullscreenChange,!1),this._onPointerLockChange=()=>{this.isPointerLock=document.pointerLockElement===r},document.addEventListener("pointerlockchange",this._onPointerLockChange,!1),document.addEventListener("webkitpointerlockchange",this._onPointerLockChange,!1),!k.audioEngine&&i.audioEngine&&k.AudioEngineFactory&&(k.audioEngine=k.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))),this._connectVREvents(),this.enableOfflineSupport=k.OfflineProviderFactory!==void 0,this._deterministicLockstep=!!i.deterministicLockstep,this._lockstepMaxSteps=i.lockstepMaxSteps||0,this._timeStep=i.timeStep||1/60}this._prepareVRComponent(),i.autoEnableWebVR&&this.initWebVR()}}static get NpmPackage(){return Te.NpmPackage}static get Version(){return Te.Version}static get Instances(){return ye.Instances}static get LastCreatedEngine(){return ye.LastCreatedEngine}static get LastCreatedScene(){return ye.LastCreatedScene}_createImageBitmapFromSource(e,t){return new Promise((s,r)=>{const n=new Image;n.onload=()=>{n.decode().then(()=>{this.createImageBitmap(n,t).then(o=>{s(o)})})},n.onerror=()=>{r(`Error loading image ${n.src}`)},n.src=e})}createImageBitmap(e,t){return createImageBitmap(e,t)}resizeImageBitmap(e,t,i){const r=this.createCanvas(t,i).getContext("2d");if(!r)throw new Error("Unable to get 2d context for resizeImageBitmap");return r.drawImage(e,0,0),r.getImageData(0,0,t,i).data}static MarkAllMaterialsAsDirty(e,t){for(let i=0;i<k.Instances.length;i++){const s=k.Instances[i];for(let r=0;r<s.scenes.length;r++)s.scenes[r].markAllMaterialsAsDirty(e,t)}}static DefaultLoadingScreenFactory(e){throw Ve("LoadingScreen")}get _supportsHardwareTextureRescaling(){return!!k._RescalePostProcessFactory}get performanceMonitor(){return this._performanceMonitor}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=!0}getInputElement(){return this._renderingCanvas}_sharedInit(e,t,i){if(super._sharedInit(e,t,i),this._onCanvasFocus=()=>{this.onCanvasFocusObservable.notifyObservers(this)},this._onCanvasBlur=()=>{this.onCanvasBlurObservable.notifyObservers(this)},this._onCanvasContextMenu=s=>{this.disableContextMenu&&s.preventDefault()},e.addEventListener("focus",this._onCanvasFocus),e.addEventListener("blur",this._onCanvasBlur),e.addEventListener("contextmenu",this._onCanvasContextMenu),this._onBlur=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.disable(),this._windowIsBackground=!0},this._onFocus=()=>{this.disablePerformanceMonitorInBackground&&this._performanceMonitor.enable(),this._windowIsBackground=!1},this._onCanvasPointerOut=s=>{document.elementFromPoint(s.clientX,s.clientY)!==e&&this.onCanvasPointerOutObservable.notifyObservers(s)},Ht()){const s=this.getHostWindow();s&&(s.addEventListener("blur",this._onBlur),s.addEventListener("focus",this._onFocus))}e.addEventListener("pointerout",this._onCanvasPointerOut),t||this._disableTouchAction(),!k.audioEngine&&i&&k.AudioEngineFactory&&(k.audioEngine=k.AudioEngineFactory(this.getRenderingCanvas(),this.getAudioContext(),this.getAudioDestination()))}getAspectRatio(e,t=!1){const i=e.viewport;return this.getRenderWidth(t)*i.width/(this.getRenderHeight(t)*i.height)}getScreenAspectRatio(){return this.getRenderWidth(!0)/this.getRenderHeight(!0)}getRenderingCanvasClientRect(){return this._renderingCanvas?this._renderingCanvas.getBoundingClientRect():null}getInputElementClientRect(){return this._renderingCanvas?this.getInputElement().getBoundingClientRect():null}isDeterministicLockStep(){return this._deterministicLockstep}getLockstepMaxSteps(){return this._lockstepMaxSteps}getTimeStep(){return this._timeStep*1e3}generateMipMapsForCubemap(e,t=!0){if(e.generateMipMaps){const i=this._gl;this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,e,!0),i.generateMipmap(i.TEXTURE_CUBE_MAP),t&&this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)}}getDepthWrite(){return this._depthCullingState.depthMask}setDepthWrite(e){this._depthCullingState.depthMask=e}getStencilBuffer(){return this._stencilState.stencilTest}setStencilBuffer(e){this._stencilState.stencilTest=e}getStencilMask(){return this._stencilState.stencilMask}setStencilMask(e){this._stencilState.stencilMask=e}getStencilFunction(){return this._stencilState.stencilFunc}getStencilFunctionReference(){return this._stencilState.stencilFuncRef}getStencilFunctionMask(){return this._stencilState.stencilFuncMask}setStencilFunction(e){this._stencilState.stencilFunc=e}setStencilFunctionReference(e){this._stencilState.stencilFuncRef=e}setStencilFunctionMask(e){this._stencilState.stencilFuncMask=e}getStencilOperationFail(){return this._stencilState.stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilState.stencilOpDepthFail}getStencilOperationPass(){return this._stencilState.stencilOpStencilDepthPass}setStencilOperationFail(e){this._stencilState.stencilOpStencilFail=e}setStencilOperationDepthFail(e){this._stencilState.stencilOpDepthFail=e}setStencilOperationPass(e){this._stencilState.stencilOpStencilDepthPass=e}setDitheringState(e){e?this._gl.enable(this._gl.DITHER):this._gl.disable(this._gl.DITHER)}setRasterizerState(e){e?this._gl.disable(this._gl.RASTERIZER_DISCARD):this._gl.enable(this._gl.RASTERIZER_DISCARD)}getDepthFunction(){return this._depthCullingState.depthFunc}setDepthFunction(e){this._depthCullingState.depthFunc=e}setDepthFunctionToGreater(){this.setDepthFunction(516)}setDepthFunctionToGreaterOrEqual(){this.setDepthFunction(518)}setDepthFunctionToLess(){this.setDepthFunction(513)}setDepthFunctionToLessOrEqual(){this.setDepthFunction(515)}cacheStencilState(){this._cachedStencilBuffer=this.getStencilBuffer(),this._cachedStencilFunction=this.getStencilFunction(),this._cachedStencilMask=this.getStencilMask(),this._cachedStencilOperationPass=this.getStencilOperationPass(),this._cachedStencilOperationFail=this.getStencilOperationFail(),this._cachedStencilOperationDepthFail=this.getStencilOperationDepthFail(),this._cachedStencilReference=this.getStencilFunctionReference()}restoreStencilState(){this.setStencilFunction(this._cachedStencilFunction),this.setStencilMask(this._cachedStencilMask),this.setStencilBuffer(this._cachedStencilBuffer),this.setStencilOperationPass(this._cachedStencilOperationPass),this.setStencilOperationFail(this._cachedStencilOperationFail),this.setStencilOperationDepthFail(this._cachedStencilOperationDepthFail),this.setStencilFunctionReference(this._cachedStencilReference)}setDirectViewport(e,t,i,s){const r=this._cachedViewport;return this._cachedViewport=null,this._viewport(e,t,i,s),r}scissorClear(e,t,i,s,r){this.enableScissor(e,t,i,s),this.clear(r,!0,!0,!0),this.disableScissor()}enableScissor(e,t,i,s){const r=this._gl;r.enable(r.SCISSOR_TEST),r.scissor(e,t,i,s)}disableScissor(){const e=this._gl;e.disable(e.SCISSOR_TEST)}_reportDrawCall(e=1){this._drawCalls.addCount(e,!1)}initWebVR(){throw Ve("WebVRCamera")}_prepareVRComponent(){}_connectVREvents(e,t){}_submitVRFrame(){}disableVR(){}isVRPresenting(){return!1}_requestVRFrame(){}_loadFileAsync(e,t,i){return new Promise((s,r)=>{this._loadFile(e,n=>{s(n)},void 0,t,i,(n,o)=>{r(o)})})}getVertexShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[0]):null}getFragmentShaderSource(e){const t=this._gl.getAttachedShaders(e);return t?this._gl.getShaderSource(t[1]):null}setDepthStencilTexture(e,t,i,s){e!==void 0&&(t&&(this._boundUniforms[e]=t),!i||!i.depthStencilTexture?this._setTexture(e,null,void 0,void 0,s):this._setTexture(e,i,!1,!0,s))}setTextureFromPostProcess(e,t,i){var s;let r=null;t&&(t._textures.data[t._currentRenderTextureInd]?r=t._textures.data[t._currentRenderTextureInd]:t._forcedOutputTexture&&(r=t._forcedOutputTexture)),this._bindTexture(e,(s=r==null?void 0:r.texture)!==null&&s!==void 0?s:null,i)}setTextureFromPostProcessOutput(e,t,i){var s,r;this._bindTexture(e,(r=(s=t==null?void 0:t._outputTexture)===null||s===void 0?void 0:s.texture)!==null&&r!==void 0?r:null,i)}_rebuildBuffers(){for(const e of this.scenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();for(const e of this._virtualScenes)e.resetCachedMaterial(),e._rebuildGeometries(),e._rebuildTextures();super._rebuildBuffers()}_renderFrame(){for(let e=0;e<this._activeRenderLoops.length;e++){const t=this._activeRenderLoops[e];t()}}_renderLoop(){if(!this._contextWasLost){let e=!0;!this.renderEvenInBackground&&this._windowIsBackground&&(e=!1),e&&(this.beginFrame(),this._renderViews()||this._renderFrame(),this.endFrame())}this._activeRenderLoops.length>0?this.customAnimationFrameRequester?(this.customAnimationFrameRequester.requestID=this._queueNewFrame(this.customAnimationFrameRequester.renderFunction||this._boundRenderFunction,this.customAnimationFrameRequester),this._frameHandler=this.customAnimationFrameRequester.requestID):this.isVRPresenting()?this._requestVRFrame():this._frameHandler=this._queueNewFrame(this._boundRenderFunction,this.getHostWindow()):this._renderingQueueLaunched=!1}_renderViews(){return!1}switchFullscreen(e){this.isFullscreen?this.exitFullscreen():this.enterFullscreen(e)}enterFullscreen(e){this.isFullscreen||(this._pointerLockRequested=e,this._renderingCanvas&&k._RequestFullscreen(this._renderingCanvas))}exitFullscreen(){this.isFullscreen&&k._ExitFullscreen()}enterPointerlock(){this._renderingCanvas&&k._RequestPointerlock(this._renderingCanvas)}exitPointerlock(){k._ExitPointerlock()}beginFrame(){this._measureFps(),this.onBeginFrameObservable.notifyObservers(this),super.beginFrame()}endFrame(){super.endFrame(),this._submitVRFrame(),this.onEndFrameObservable.notifyObservers(this)}resize(e=!1){this.isVRPresenting()||super.resize(e)}setSize(e,t,i=!1){if(!this._renderingCanvas||!super.setSize(e,t,i))return!1;if(this.scenes){for(let s=0;s<this.scenes.length;s++){const r=this.scenes[s];for(let n=0;n<r.cameras.length;n++){const o=r.cameras[n];o._currentRenderId=0}}this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this)}return!0}_deletePipelineContext(e){const t=e;t&&t.program&&t.transformFeedback&&(this.deleteTransformFeedback(t.transformFeedback),t.transformFeedback=null),super._deletePipelineContext(e)}createShaderProgram(e,t,i,s,r,n=null){r=r||this._gl,this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=super.createShaderProgram(e,t,i,s,r,n);return this.onAfterShaderCompilationObservable.notifyObservers(this),o}_createShaderProgram(e,t,i,s,r=null){const n=s.createProgram();if(e.program=n,!n)throw new Error("Unable to create program");if(s.attachShader(n,t),s.attachShader(n,i),this.webGLVersion>1&&r){const o=this.createTransformFeedback();this.bindTransformFeedback(o),this.setTranformFeedbackVaryings(n,r),e.transformFeedback=o}return s.linkProgram(n),this.webGLVersion>1&&r&&this.bindTransformFeedback(null),e.context=s,e.vertexShader=t,e.fragmentShader=i,e.isParallelCompiled||this._finalizePipelineContext(e),n}_releaseTexture(e){super._releaseTexture(e)}_releaseRenderTargetWrapper(e){super._releaseRenderTargetWrapper(e),this.scenes.forEach(t=>{t.postProcesses.forEach(i=>{i._outputTexture===e&&(i._outputTexture=null)}),t.cameras.forEach(i=>{i._postProcesses.forEach(s=>{s&&s._outputTexture===e&&(s._outputTexture=null)})})})}getRenderPassNames(){return this._renderPassNames}getCurrentRenderPassName(){return this._renderPassNames[this.currentRenderPassId]}createRenderPassId(e){const t=++k._RenderPassIdCounter;return this._renderPassNames[t]=e!=null?e:"NONAME",t}releaseRenderPassId(e){this._renderPassNames[e]=void 0;for(let t=0;t<this.scenes.length;++t){const i=this.scenes[t];for(let s=0;s<i.meshes.length;++s){const r=i.meshes[s];if(r.subMeshes)for(let n=0;n<r.subMeshes.length;++n)r.subMeshes[n]._removeDrawWrapper(e)}}}_rescaleTexture(e,t,i,s,r){this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,this._gl.LINEAR),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_S,this._gl.CLAMP_TO_EDGE),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_WRAP_T,this._gl.CLAMP_TO_EDGE);const n=this.createRenderTargetTexture({width:t.width,height:t.height},{generateMipMaps:!1,type:0,samplingMode:2,generateDepthBuffer:!1,generateStencilBuffer:!1});!this._rescalePostProcess&&k._RescalePostProcessFactory&&(this._rescalePostProcess=k._RescalePostProcessFactory(this)),this._rescalePostProcess.externalTextureSamplerBinding=!0,this._rescalePostProcess.getEffect().executeWhenCompiled(()=>{this._rescalePostProcess.onApply=function(l){l._bindTexture("textureSampler",e)};let o=i;o||(o=this.scenes[this.scenes.length-1]),o.postProcessManager.directRender([this._rescalePostProcess],n,!0),this._bindTextureDirectly(this._gl.TEXTURE_2D,t,!0),this._gl.copyTexImage2D(this._gl.TEXTURE_2D,0,s,0,0,t.width,t.height,0),this.unBindFramebuffer(n),n.dispose(),r&&r()})}getFps(){return this._fps}getDeltaTime(){return this._deltaTime}_measureFps(){this._performanceMonitor.sampleFrame(),this._fps=this._performanceMonitor.averageFPS,this._deltaTime=this._performanceMonitor.instantaneousFrameTime||0}wrapWebGLTexture(e){const t=new zl(e,this._gl),i=new gt(this,We.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}_uploadImageToTexture(e,t,i=0,s=0){const r=this._gl,n=this._getWebGLTextureType(e.type),o=this._getInternalFormat(e.format),l=this._getRGBABufferInternalSizedFormat(e.type,o),h=e.isCube?r.TEXTURE_CUBE_MAP:r.TEXTURE_2D;this._bindTextureDirectly(h,e,!0),this._unpackFlipY(e.invertY);let c=r.TEXTURE_2D;e.isCube&&(c=r.TEXTURE_CUBE_MAP_POSITIVE_X+i),r.texImage2D(c,s,l,o,n,t),this._bindTextureDirectly(h,null,!0)}updateTextureComparisonFunction(e,t){if(this.webGLVersion===1){B.Error("WebGL 1 does not support texture comparison.");return}const i=this._gl;e.isCube?(this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,e,!0),t===0?(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null)):(this._bindTextureDirectly(this._gl.TEXTURE_2D,e,!0),t===0?(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,515),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.NONE)):(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_FUNC,t),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE)),this._bindTextureDirectly(this._gl.TEXTURE_2D,null)),e._comparisonFunction=t}createInstancesBuffer(e){const t=this._gl.createBuffer();if(!t)throw new Error("Unable to create instance buffer");const i=new yl(t);return i.capacity=e,this.bindArrayBuffer(i),this._gl.bufferData(this._gl.ARRAY_BUFFER,e,this._gl.DYNAMIC_DRAW),i.references=1,i}deleteInstancesBuffer(e){this._gl.deleteBuffer(e)}_clientWaitAsync(e,t=0,i=10){const s=this._gl;return new Promise((r,n)=>{const o=()=>{const l=s.clientWaitSync(e,t,0);if(l==s.WAIT_FAILED){n();return}if(l==s.TIMEOUT_EXPIRED){setTimeout(o,i);return}r()};o()})}_readPixelsAsync(e,t,i,s,r,n,o){if(this._webGLVersion<2)throw new Error("_readPixelsAsync only work on WebGL2+");const l=this._gl,h=l.createBuffer();l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.bufferData(l.PIXEL_PACK_BUFFER,o.byteLength,l.STREAM_READ),l.readPixels(e,t,i,s,r,n,0),l.bindBuffer(l.PIXEL_PACK_BUFFER,null);const c=l.fenceSync(l.SYNC_GPU_COMMANDS_COMPLETE,0);return c?(l.flush(),this._clientWaitAsync(c,0,10).then(()=>(l.deleteSync(c),l.bindBuffer(l.PIXEL_PACK_BUFFER,h),l.getBufferSubData(l.PIXEL_PACK_BUFFER,0,o),l.bindBuffer(l.PIXEL_PACK_BUFFER,null),l.deleteBuffer(h),o))):null}dispose(){for(this.hideLoadingUI(),this.onNewSceneAddedObservable.clear();this.postProcesses.length;)this.postProcesses[0].dispose();for(this._rescalePostProcess&&this._rescalePostProcess.dispose();this.scenes.length;)this.scenes[0].dispose();for(;this._virtualScenes.length;)this._virtualScenes[0].dispose();k.Instances.length===1&&k.audioEngine&&(k.audioEngine.dispose(),k.audioEngine=null),this.disableVR(),Ht()&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._renderingCanvas&&(this._renderingCanvas.removeEventListener("focus",this._onCanvasFocus),this._renderingCanvas.removeEventListener("blur",this._onCanvasBlur),this._renderingCanvas.removeEventListener("pointerout",this._onCanvasPointerOut),this._renderingCanvas.removeEventListener("contextmenu",this._onCanvasContextMenu)),Bh()&&(document.removeEventListener("fullscreenchange",this._onFullscreenChange),document.removeEventListener("mozfullscreenchange",this._onFullscreenChange),document.removeEventListener("webkitfullscreenchange",this._onFullscreenChange),document.removeEventListener("msfullscreenchange",this._onFullscreenChange),document.removeEventListener("pointerlockchange",this._onPointerLockChange),document.removeEventListener("mspointerlockchange",this._onPointerLockChange),document.removeEventListener("mozpointerlockchange",this._onPointerLockChange),document.removeEventListener("webkitpointerlockchange",this._onPointerLockChange))),super.dispose();const e=k.Instances.indexOf(this);e>=0&&k.Instances.splice(e,1),this.onResizeObservable.clear(),this.onCanvasBlurObservable.clear(),this.onCanvasFocusObservable.clear(),this.onCanvasPointerOutObservable.clear(),this.onBeginFrameObservable.clear(),this.onEndFrameObservable.clear()}_disableTouchAction(){!this._renderingCanvas||!this._renderingCanvas.setAttribute||(this._renderingCanvas.setAttribute("touch-action","none"),this._renderingCanvas.style.touchAction="none",this._renderingCanvas.style.webkitTapHighlightColor="transparent")}displayLoadingUI(){if(!Ht())return;const e=this.loadingScreen;e&&e.displayLoadingUI()}hideLoadingUI(){if(!Ht())return;const e=this._loadingScreen;e&&e.hideLoadingUI()}get loadingScreen(){return!this._loadingScreen&&this._renderingCanvas&&(this._loadingScreen=k.DefaultLoadingScreenFactory(this._renderingCanvas)),this._loadingScreen}set loadingScreen(e){this._loadingScreen=e}set loadingUIText(e){this.loadingScreen.loadingUIText=e}set loadingUIBackgroundColor(e){this.loadingScreen.loadingUIBackgroundColor=e}createVideoElement(e){return document.createElement("video")}static _RequestPointerlock(e){e.requestPointerLock&&(e.requestPointerLock(),e.focus())}static _ExitPointerlock(){document.exitPointerLock&&document.exitPointerLock()}static _RequestFullscreen(e){const t=e.requestFullscreen||e.webkitRequestFullscreen;!t||t.call(e)}static _ExitFullscreen(){const e=document;document.exitFullscreen?document.exitFullscreen():e.webkitCancelFullScreen&&e.webkitCancelFullScreen()}getFontOffset(e){const t=document.createElement("span");t.innerHTML="Hg",t.setAttribute("style",`font: ${e} !important`);const i=document.createElement("div");i.style.display="inline-block",i.style.width="1px",i.style.height="0px",i.style.verticalAlign="bottom";const s=document.createElement("div");s.style.whiteSpace="nowrap",s.appendChild(t),s.appendChild(i),document.body.appendChild(s);let r=0,n=0;try{n=i.getBoundingClientRect().top-t.getBoundingClientRect().top,i.style.verticalAlign="baseline",r=i.getBoundingClientRect().top-t.getBoundingClientRect().top}finally{document.body.removeChild(s)}return{ascent:r,height:n,descent:n-r}}}k.ALPHA_DISABLE=0;k.ALPHA_ADD=1;k.ALPHA_COMBINE=2;k.ALPHA_SUBTRACT=3;k.ALPHA_MULTIPLY=4;k.ALPHA_MAXIMIZED=5;k.ALPHA_ONEONE=6;k.ALPHA_PREMULTIPLIED=7;k.ALPHA_PREMULTIPLIED_PORTERDUFF=8;k.ALPHA_INTERPOLATE=9;k.ALPHA_SCREENMODE=10;k.DELAYLOADSTATE_NONE=0;k.DELAYLOADSTATE_LOADED=1;k.DELAYLOADSTATE_LOADING=2;k.DELAYLOADSTATE_NOTLOADED=4;k.NEVER=512;k.ALWAYS=519;k.LESS=513;k.EQUAL=514;k.LEQUAL=515;k.GREATER=516;k.GEQUAL=518;k.NOTEQUAL=517;k.KEEP=7680;k.REPLACE=7681;k.INCR=7682;k.DECR=7683;k.INVERT=5386;k.INCR_WRAP=34055;k.DECR_WRAP=34056;k.TEXTURE_CLAMP_ADDRESSMODE=0;k.TEXTURE_WRAP_ADDRESSMODE=1;k.TEXTURE_MIRROR_ADDRESSMODE=2;k.TEXTUREFORMAT_ALPHA=0;k.TEXTUREFORMAT_LUMINANCE=1;k.TEXTUREFORMAT_LUMINANCE_ALPHA=2;k.TEXTUREFORMAT_RGB=4;k.TEXTUREFORMAT_RGBA=5;k.TEXTUREFORMAT_RED=6;k.TEXTUREFORMAT_R=6;k.TEXTUREFORMAT_RG=7;k.TEXTUREFORMAT_RED_INTEGER=8;k.TEXTUREFORMAT_R_INTEGER=8;k.TEXTUREFORMAT_RG_INTEGER=9;k.TEXTUREFORMAT_RGB_INTEGER=10;k.TEXTUREFORMAT_RGBA_INTEGER=11;k.TEXTURETYPE_UNSIGNED_BYTE=0;k.TEXTURETYPE_UNSIGNED_INT=0;k.TEXTURETYPE_FLOAT=1;k.TEXTURETYPE_HALF_FLOAT=2;k.TEXTURETYPE_BYTE=3;k.TEXTURETYPE_SHORT=4;k.TEXTURETYPE_UNSIGNED_SHORT=5;k.TEXTURETYPE_INT=6;k.TEXTURETYPE_UNSIGNED_INTEGER=7;k.TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4=8;k.TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1=9;k.TEXTURETYPE_UNSIGNED_SHORT_5_6_5=10;k.TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV=11;k.TEXTURETYPE_UNSIGNED_INT_24_8=12;k.TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV=13;k.TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV=14;k.TEXTURETYPE_FLOAT_32_UNSIGNED_INT_24_8_REV=15;k.TEXTURE_NEAREST_SAMPLINGMODE=1;k.TEXTURE_BILINEAR_SAMPLINGMODE=2;k.TEXTURE_TRILINEAR_SAMPLINGMODE=3;k.TEXTURE_NEAREST_NEAREST_MIPLINEAR=8;k.TEXTURE_LINEAR_LINEAR_MIPNEAREST=11;k.TEXTURE_LINEAR_LINEAR_MIPLINEAR=3;k.TEXTURE_NEAREST_NEAREST_MIPNEAREST=4;k.TEXTURE_NEAREST_LINEAR_MIPNEAREST=5;k.TEXTURE_NEAREST_LINEAR_MIPLINEAR=6;k.TEXTURE_NEAREST_LINEAR=7;k.TEXTURE_NEAREST_NEAREST=1;k.TEXTURE_LINEAR_NEAREST_MIPNEAREST=9;k.TEXTURE_LINEAR_NEAREST_MIPLINEAR=10;k.TEXTURE_LINEAR_LINEAR=2;k.TEXTURE_LINEAR_NEAREST=12;k.TEXTURE_EXPLICIT_MODE=0;k.TEXTURE_SPHERICAL_MODE=1;k.TEXTURE_PLANAR_MODE=2;k.TEXTURE_CUBIC_MODE=3;k.TEXTURE_PROJECTION_MODE=4;k.TEXTURE_SKYBOX_MODE=5;k.TEXTURE_INVCUBIC_MODE=6;k.TEXTURE_EQUIRECTANGULAR_MODE=7;k.TEXTURE_FIXED_EQUIRECTANGULAR_MODE=8;k.TEXTURE_FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;k.SCALEMODE_FLOOR=1;k.SCALEMODE_NEAREST=2;k.SCALEMODE_CEILING=3;k._RescalePostProcessFactory=null;k._RenderPassIdCounter=0;class oe{static WithinEpsilon(e,t,i=1401298e-51){return Math.abs(e-t)<=i}static ToHex(e){const t=e.toString(16);return e<=15?("0"+t).toUpperCase():t.toUpperCase()}static Sign(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1}static Clamp(e,t=0,i=1){return Math.min(i,Math.max(t,e))}static Log2(e){return Math.log(e)*Math.LOG2E}static ILog2(e){if(Math.log2)return Math.floor(Math.log2(e));if(e<0)return NaN;if(e===0)return-1/0;let t=0;if(e<1){for(;e<1;)t++,e=e*2;t=-t}else if(e>1)for(;e>1;)t++,e=Math.floor(e/2);return t}static Repeat(e,t){return e-Math.floor(e/t)*t}static Normalize(e,t,i){return(e-t)/(i-t)}static Denormalize(e,t,i){return e*(i-t)+t}static DeltaAngle(e,t){let i=oe.Repeat(t-e,360);return i>180&&(i-=360),i}static PingPong(e,t){const i=oe.Repeat(e,t*2);return t-Math.abs(i-t)}static SmoothStep(e,t,i){let s=oe.Clamp(i);return s=-2*s*s*s+3*s*s,t*s+e*(1-s)}static MoveTowards(e,t,i){let s=0;return Math.abs(t-e)<=i?s=t:s=e+oe.Sign(t-e)*i,s}static MoveTowardsAngle(e,t,i){const s=oe.DeltaAngle(e,t);let r=0;return-i<s&&s<i?r=t:(t=e+s,r=oe.MoveTowards(e,t,i)),r}static Lerp(e,t,i){return e+(t-e)*i}static LerpAngle(e,t,i){let s=oe.Repeat(t-e,360);return s>180&&(s-=360),e+s*oe.Clamp(i)}static InverseLerp(e,t,i){let s=0;return e!=t?s=oe.Clamp((i-e)/(t-e)):s=0,s}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,l=2*o-3*n+1,h=-2*o+3*n,c=o-2*n+r,u=o-n;return e*l+i*h+t*c+s*u}static Hermite1stDerivative(e,t,i,s,r){const n=r*r;return(n-r)*6*e+(3*n-4*r+1)*t+(-n+r)*6*i+(3*n-2*r)*s}static RandomRange(e,t){return e===t?e:Math.random()*(t-e)+e}static RangeToPercent(e,t,i){return(e-t)/(i-t)}static PercentToRange(e,t,i){return(i-t)*e+t}static NormalizeRadians(e){return e-=oe.TwoPi*Math.floor((e+Math.PI)/oe.TwoPi),e}static HCF(e,t){const i=e%t;return i===0?t:oe.HCF(t,i)}}oe.TwoPi=Math.PI*2;const Wr=1/2.2,gn=2.2,_i=(1+Math.sqrt(5))/2,tt=.001;class gi{static BuildArray(e,t){const i=[];for(let s=0;s<e;++s)i.push(t());return i}static BuildTuple(e,t){return gi.BuildArray(e,t)}}function nv(a,e,t){const i=a[e];if(typeof i!="function")return null;const s=function(){const r=a.length,n=s.previous.apply(a,arguments);return t(e,r),n};return i.next=s,s.previous=i,a[e]=s,()=>{const r=s.previous;if(!r)return;const n=s.next;n?(r.next=n,n.previous=r):(r.next=void 0,a[e]=r),s.next=void 0,s.previous=void 0}}const av=["push","splice","pop","shift","unshift"];function s_(a,e){const t=av.map(i=>nv(a,i,e));return()=>{t.forEach(i=>{i==null||i()})}}const r_={};function he(a,e){r_[a]=e}function Si(a){return r_[a]}const Ds=a=>parseInt(a.toString().replace(/\W/g,""));class le{constructor(e=0,t=0){this.x=e,this.y=t}toString(){return`{X: ${this.x} Y: ${this.y}}`}getClassName(){return"Vector2"}getHashCode(){const e=Ds(this.x),t=Ds(this.y);let i=e;return i=i*397^t,i}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,this}fromArray(e,t=0){return le.FromArrayToRef(e,t,this),this}asArray(){const e=new Array;return this.toArray(e,0),e}copyFrom(e){return this.x=e.x,this.y=e.y,this}copyFromFloats(e,t){return this.x=e,this.y=t,this}set(e,t){return this.copyFromFloats(e,t)}add(e){return new le(this.x+e.x,this.y+e.y)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this}addVector3(e){return new le(this.x+e.x,this.y+e.y)}subtract(e){return new le(this.x-e.x,this.y-e.y)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,this}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this}multiply(e){return new le(this.x*e.x,this.y*e.y)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,this}multiplyByFloats(e,t){return new le(this.x*e,this.y*t)}divide(e){return new le(this.x/e.x,this.y/e.y)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,this}divideInPlace(e){return this.divideToRef(e,this)}negate(){return new le(-this.x,-this.y)}negateInPlace(){return this.x*=-1,this.y*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this}scale(e){const t=new le(0,0);return this.scaleToRef(e,t),t}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,this}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,this}equals(e){return e&&this.x===e.x&&this.y===e.y}equalsWithEpsilon(e,t=tt){return e&&oe.WithinEpsilon(this.x,e.x,t)&&oe.WithinEpsilon(this.y,e.y,t)}floor(){return new le(Math.floor(this.x),Math.floor(this.y))}fract(){return new le(this.x-Math.floor(this.x),this.y-Math.floor(this.y))}rotateToRef(e,t){const i=Math.cos(e),s=Math.sin(e);return t.x=i*this.x-s*this.y,t.y=s*this.x+i*this.y,this}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}lengthSquared(){return this.x*this.x+this.y*this.y}normalize(){return le.NormalizeToRef(this,this),this}clone(){return new le(this.x,this.y)}static Zero(){return new le(0,0)}static One(){return new le(1,1)}static get ZeroReadOnly(){return le._ZeroReadOnly}static FromArray(e,t=0){return new le(e[t],e[t+1])}static FromArrayToRef(e,t,i){i.x=e[t],i.y=e[t+1]}static CatmullRom(e,t,i,s,r){const n=r*r,o=r*n,l=.5*(2*t.x+(-e.x+i.x)*r+(2*e.x-5*t.x+4*i.x-s.x)*n+(-e.x+3*t.x-3*i.x+s.x)*o),h=.5*(2*t.y+(-e.y+i.y)*r+(2*e.y-5*t.y+4*i.y-s.y)*n+(-e.y+3*t.y-3*i.y+s.y)*o);return new le(l,h)}static Clamp(e,t,i){let s=e.x;s=s>i.x?i.x:s,s=s<t.x?t.x:s;let r=e.y;return r=r>i.y?i.y:r,r=r<t.y?t.y:r,new le(s,r)}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,l=2*o-3*n+1,h=-2*o+3*n,c=o-2*n+r,u=o-n,d=e.x*l+i.x*h+t.x*c+s.x*u,f=e.y*l+i.y*h+t.y*c+s.y*u;return new le(d,f)}static Hermite1stDerivative(e,t,i,s,r){const n=le.Zero();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.x=(o-r)*6*e.x+(3*o-4*r+1)*t.x+(-o+r)*6*i.x+(3*o-2*r)*s.x,n.y=(o-r)*6*e.y+(3*o-4*r+1)*t.y+(-o+r)*6*i.y+(3*o-2*r)*s.y}static Lerp(e,t,i){const s=e.x+(t.x-e.x)*i,r=e.y+(t.y-e.y)*i;return new le(s,r)}static Dot(e,t){return e.x*t.x+e.y*t.y}static Normalize(e){const t=le.Zero();return this.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){const i=e.length();i!==0&&(t.x=e.x/i,t.y=e.y/i)}static Minimize(e,t){const i=e.x<t.x?e.x:t.x,s=e.y<t.y?e.y:t.y;return new le(i,s)}static Maximize(e,t){const i=e.x>t.x?e.x:t.x,s=e.y>t.y?e.y:t.y;return new le(i,s)}static Transform(e,t){const i=le.Zero();return le.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+s[12],n=e.x*s[1]+e.y*s[5]+s[13];i.x=r,i.y=n}static PointInTriangle(e,t,i,s){const r=.5*(-i.y*s.x+t.y*(-i.x+s.x)+t.x*(i.y-s.y)+i.x*s.y),n=r<0?-1:1,o=(t.y*s.x-t.x*s.y+(s.y-t.y)*e.x+(t.x-s.x)*e.y)*n,l=(t.x*i.y-t.y*i.x+(t.y-i.y)*e.x+(i.x-t.x)*e.y)*n;return o>0&&l>0&&o+l<2*r*n}static Distance(e,t){return Math.sqrt(le.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y;return i*i+s*s}static Center(e,t){return le.CenterToRef(e,t,le.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2)}static DistanceOfPointFromSegment(e,t,i){const s=le.DistanceSquared(t,i);if(s===0)return le.Distance(e,t);const r=i.subtract(t),n=Math.max(0,Math.min(1,le.Dot(e.subtract(t),r)/s)),o=t.add(r.multiplyByFloats(n,n));return le.Distance(e,o)}}le._ZeroReadOnly=le.Zero();class g{constructor(e=0,t=0,i=0){this._isDirty=!0,this._x=e,this._y=t,this._z=i}get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z}}`}getClassName(){return"Vector3"}getHashCode(){const e=Ds(this._x),t=Ds(this._y),i=Ds(this._z);let s=e;return s=s*397^t,s=s*397^i,s}asArray(){const e=[];return this.toArray(e,0),e}toArray(e,t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,this}fromArray(e,t=0){return g.FromArrayToRef(e,t,this),this}toQuaternion(){return Q.RotationYawPitchRoll(this._y,this._x,this._z)}addInPlace(e){return this.addInPlaceFromFloats(e._x,e._y,e._z)}addInPlaceFromFloats(e,t,i){return this.x+=e,this.y+=t,this.z+=i,this}add(e){return new g(this._x+e._x,this._y+e._y,this._z+e._z)}addToRef(e,t){return t.copyFromFloats(this._x+e._x,this._y+e._y,this._z+e._z)}subtractInPlace(e){return this.x-=e._x,this.y-=e._y,this.z-=e._z,this}subtract(e){return new g(this._x-e._x,this._y-e._y,this._z-e._z)}subtractToRef(e,t){return this.subtractFromFloatsToRef(e._x,e._y,e._z,t)}subtractFromFloats(e,t,i){return new g(this._x-e,this._y-t,this._z-i)}subtractFromFloatsToRef(e,t,i,s){return s.copyFromFloats(this._x-e,this._y-t,this._z-i)}negate(){return new g(-this._x,-this._y,-this._z)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this}negateToRef(e){return e.copyFromFloats(this._x*-1,this._y*-1,this._z*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this}scale(e){return new g(this._x*e,this._y*e,this._z*e)}scaleToRef(e,t){return t.copyFromFloats(this._x*e,this._y*e,this._z*e)}_getNormalToRef(e){const t=this.length();let i=Math.acos(this.y/t);const s=Math.atan2(this.z,this.x);i>Math.PI/2?i-=Math.PI/2:i+=Math.PI/2;const r=t*Math.sin(i)*Math.cos(s),n=t*Math.cos(i),o=t*Math.sin(i)*Math.sin(s);return e.set(r,n,o),e}applyRotationQuaternionToRef(e,t){const i=e.w*this.x+e.y*this.z-e.z*this.y,s=e.w*this.y+e.z*this.x-e.x*this.z,r=e.w*this.z+e.x*this.y-e.y*this.x,n=-e.x*this.x-e.y*this.y-e.z*this.z;return t.x=i*e.w+n*-e.x+s*-e.z-r*-e.y,t.y=s*e.w+n*-e.y+r*-e.x-i*-e.z,t.z=r*e.w+n*-e.z+i*-e.y-s*-e.x,t}applyRotationQuaternionInPlace(e){return this.applyRotationQuaternionToRef(e,this)}applyRotationQuaternion(e){return this.applyRotationQuaternionToRef(e,g.Zero())}scaleAndAddToRef(e,t){return t.addInPlaceFromFloats(this._x*e,this._y*e,this._z*e)}projectOnPlane(e,t){const i=g.Zero();return this.projectOnPlaneToRef(e,t,i),i}projectOnPlaneToRef(e,t,i){const s=e.normal,r=e.d,n=we.Vector3[0];this.subtractToRef(t,n),n.normalize();const o=g.Dot(n,s);if(Math.abs(o)<Math.pow(10,-10))i.setAll(1/0);else{const l=-(g.Dot(t,s)+r)/o,h=n.scaleInPlace(l);t.addToRef(h,i)}}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z}equalsWithEpsilon(e,t=tt){return e&&oe.WithinEpsilon(this._x,e._x,t)&&oe.WithinEpsilon(this._y,e._y,t)&&oe.WithinEpsilon(this._z,e._z,t)}equalsToFloats(e,t,i){return this._x===e&&this._y===t&&this._z===i}multiplyInPlace(e){return this.x*=e._x,this.y*=e._y,this.z*=e._z,this}multiply(e){return this.multiplyByFloats(e._x,e._y,e._z)}multiplyToRef(e,t){return t.copyFromFloats(this._x*e._x,this._y*e._y,this._z*e._z)}multiplyByFloats(e,t,i){return new g(this._x*e,this._y*t,this._z*i)}divide(e){return new g(this._x/e._x,this._y/e._y,this._z/e._z)}divideToRef(e,t){return t.copyFromFloats(this._x/e._x,this._y/e._y,this._z/e._z)}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return this.minimizeInPlaceFromFloats(e._x,e._y,e._z)}maximizeInPlace(e){return this.maximizeInPlaceFromFloats(e._x,e._y,e._z)}minimizeInPlaceFromFloats(e,t,i){return e<this._x&&(this.x=e),t<this._y&&(this.y=t),i<this._z&&(this.z=i),this}maximizeInPlaceFromFloats(e,t,i){return e>this._x&&(this.x=e),t>this._y&&(this.y=t),i>this._z&&(this.z=i),this}isNonUniformWithinEpsilon(e){const t=Math.abs(this._x),i=Math.abs(this._y);if(!oe.WithinEpsilon(t,i,e))return!0;const s=Math.abs(this._z);return!oe.WithinEpsilon(t,s,e)||!oe.WithinEpsilon(i,s,e)}get isNonUniform(){const e=Math.abs(this._x),t=Math.abs(this._y);if(e!==t)return!0;const i=Math.abs(this._z);return e!==i}floor(){return new g(Math.floor(this._x),Math.floor(this._y),Math.floor(this._z))}fract(){return new g(this._x-Math.floor(this._x),this._y-Math.floor(this._y),this._z-Math.floor(this._z))}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z}get hasAZeroComponent(){return this._x*this._y*this._z===0}normalize(){return this.normalizeFromLength(this.length())}reorderInPlace(e){return e=e.toLowerCase(),e==="xyz"?this:(we.Vector3[0].copyFrom(this),["x","y","z"].forEach((t,i)=>{this[t]=we.Vector3[0][e[i]]}),this)}rotateByQuaternionToRef(e,t){return e.toRotationMatrix(we.Matrix[0]),g.TransformCoordinatesToRef(this,we.Matrix[0],t),t}rotateByQuaternionAroundPointToRef(e,t,i){return this.subtractToRef(t,we.Vector3[0]),we.Vector3[0].rotateByQuaternionToRef(e,we.Vector3[0]),t.addToRef(we.Vector3[0],i),i}cross(e){return g.Cross(this,e)}normalizeFromLength(e){return e===0||e===1?this:this.scaleInPlace(1/e)}normalizeToNew(){const e=new g(0,0,0);return this.normalizeToRef(e),e}normalizeToRef(e){const t=this.length();return t===0||t===1?e.copyFromFloats(this._x,this._y,this._z):this.scaleToRef(1/t,e)}clone(){return new g(this._x,this._y,this._z)}copyFrom(e){return this.copyFromFloats(e._x,e._y,e._z)}copyFromFloats(e,t,i){return this.x=e,this.y=t,this.z=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}setAll(e){return this.x=this.y=this.z=e,this}static GetClipFactor(e,t,i,s){const r=g.Dot(e,i)-s,n=g.Dot(t,i)-s;return r/(r-n)}static GetAngleBetweenVectors(e,t,i){const s=e.normalizeToRef(we.Vector3[1]),r=t.normalizeToRef(we.Vector3[2]);let n=g.Dot(s,r);n=oe.Clamp(n,-1,1);const o=Math.acos(n),l=we.Vector3[3];return g.CrossToRef(s,r,l),g.Dot(l,i)>0?isNaN(o)?0:o:isNaN(o)?-Math.PI:-Math.acos(n)}static GetAngleBetweenVectorsOnPlane(e,t,i){we.Vector3[0].copyFrom(e);const s=we.Vector3[0];we.Vector3[1].copyFrom(t);const r=we.Vector3[1];we.Vector3[2].copyFrom(i);const n=we.Vector3[2],o=we.Vector3[3],l=we.Vector3[4];s.normalize(),r.normalize(),n.normalize(),g.CrossToRef(n,s,o),g.CrossToRef(o,n,l);const h=Math.atan2(g.Dot(r,o),g.Dot(r,l));return oe.NormalizeRadians(h)}static PitchYawRollToMoveBetweenPointsToRef(e,t,i){const s=G.Vector3[0];return t.subtractToRef(e,s),i.y=Math.atan2(s.x,s.z)||0,i.x=Math.atan2(Math.sqrt(s.x**2+s.z**2),s.y)||0,i.z=0,i}static PitchYawRollToMoveBetweenPoints(e,t){const i=g.Zero();return g.PitchYawRollToMoveBetweenPointsToRef(e,t,i)}static SlerpToRef(e,t,i,s){i=oe.Clamp(i,0,1);const r=we.Vector3[0],n=we.Vector3[1];r.copyFrom(e);const o=r.length();r.normalizeFromLength(o),n.copyFrom(t);const l=n.length();n.normalizeFromLength(l);const h=g.Dot(r,n);let c,u;if(h<1-tt){const d=Math.acos(h),f=1/Math.sin(d);c=Math.sin((1-i)*d)*f,u=Math.sin(i*d)*f}else c=1-i,u=i;r.scaleInPlace(c),n.scaleInPlace(u),s.copyFrom(r).addInPlace(n),s.scaleInPlace(oe.Lerp(o,l,i))}static SmoothToRef(e,t,i,s,r){g.SlerpToRef(e,t,s===0?1:i/s,r)}static FromArray(e,t=0){return new g(e[t],e[t+1],e[t+2])}static FromFloatArray(e,t){return g.FromArray(e,t)}static FromArrayToRef(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2]}static FromFloatArrayToRef(e,t,i){return g.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s){s.copyFromFloats(e,t,i)}static Zero(){return new g(0,0,0)}static One(){return new g(1,1,1)}static Up(){return new g(0,1,0)}static get UpReadOnly(){return g._UpReadOnly}static get DownReadOnly(){return g._DownReadOnly}static get RightReadOnly(){return g._RightReadOnly}static get LeftReadOnly(){return g._LeftReadOnly}static get LeftHandedForwardReadOnly(){return g._LeftHandedForwardReadOnly}static get RightHandedForwardReadOnly(){return g._RightHandedForwardReadOnly}static get ZeroReadOnly(){return g._ZeroReadOnly}static Down(){return new g(0,-1,0)}static Forward(e=!1){return new g(0,0,e?-1:1)}static Backward(e=!1){return new g(0,0,e?1:-1)}static Right(){return new g(1,0,0)}static Left(){return new g(-1,0,0)}static TransformCoordinates(e,t){const i=g.Zero();return g.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){g.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i)}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],c=1/(e*n[3]+t*n[7]+i*n[11]+n[15]);r.x=o*c,r.y=l*c,r.z=h*c}static TransformNormal(e,t){const i=g.Zero();return g.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){this.TransformNormalFromFloatsToRef(e._x,e._y,e._z,t,i)}static TransformNormalFromFloatsToRef(e,t,i,s,r){const n=s.m;r.x=e*n[0]+t*n[4]+i*n[8],r.y=e*n[1]+t*n[5]+i*n[9],r.z=e*n[2]+t*n[6]+i*n[10]}static CatmullRom(e,t,i,s,r){const n=r*r,o=r*n,l=.5*(2*t._x+(-e._x+i._x)*r+(2*e._x-5*t._x+4*i._x-s._x)*n+(-e._x+3*t._x-3*i._x+s._x)*o),h=.5*(2*t._y+(-e._y+i._y)*r+(2*e._y-5*t._y+4*i._y-s._y)*n+(-e._y+3*t._y-3*i._y+s._y)*o),c=.5*(2*t._z+(-e._z+i._z)*r+(2*e._z-5*t._z+4*i._z-s._z)*n+(-e._z+3*t._z-3*i._z+s._z)*o);return new g(l,h,c)}static Clamp(e,t,i){const s=new g;return g.ClampToRef(e,t,i,s),s}static ClampToRef(e,t,i,s){let r=e._x;r=r>i._x?i._x:r,r=r<t._x?t._x:r;let n=e._y;n=n>i._y?i._y:n,n=n<t._y?t._y:n;let o=e._z;o=o>i._z?i._z:o,o=o<t._z?t._z:o,s.copyFromFloats(r,n,o)}static CheckExtends(e,t,i){t.minimizeInPlace(e),i.maximizeInPlace(e)}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,l=2*o-3*n+1,h=-2*o+3*n,c=o-2*n+r,u=o-n,d=e._x*l+i._x*h+t._x*c+s._x*u,f=e._y*l+i._y*h+t._y*c+s._y*u,p=e._z*l+i._z*h+t._z*c+s._z*u;return new g(d,f,p)}static Hermite1stDerivative(e,t,i,s,r){const n=g.Zero();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.x=(o-r)*6*e.x+(3*o-4*r+1)*t.x+(-o+r)*6*i.x+(3*o-2*r)*s.x,n.y=(o-r)*6*e.y+(3*o-4*r+1)*t.y+(-o+r)*6*i.y+(3*o-2*r)*s.y,n.z=(o-r)*6*e.z+(3*o-4*r+1)*t.z+(-o+r)*6*i.z+(3*o-2*r)*s.z}static Lerp(e,t,i){const s=new g(0,0,0);return g.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.x=e._x+(t._x-e._x)*i,s.y=e._y+(t._y-e._y)*i,s.z=e._z+(t._z-e._z)*i}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z}static Cross(e,t){const i=g.Zero();return g.CrossToRef(e,t,i),i}static CrossToRef(e,t,i){const s=e._y*t._z-e._z*t._y,r=e._z*t._x-e._x*t._z,n=e._x*t._y-e._y*t._x;i.copyFromFloats(s,r,n)}static Normalize(e){const t=g.Zero();return g.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){e.normalizeToRef(t)}static Project(e,t,i,s){const r=new g;return g.ProjectToRef(e,t,i,s,r),r}static ProjectToRef(e,t,i,s,r){const n=s.width,o=s.height,l=s.x,h=s.y,c=we.Matrix[1];L.FromValuesToRef(n/2,0,0,0,0,-o/2,0,0,0,0,.5,0,l+n/2,o/2+h,.5,1,c);const u=we.Matrix[0];return t.multiplyToRef(i,u),u.multiplyToRef(c,u),g.TransformCoordinatesToRef(e,u,r),r}static _UnprojectFromInvertedMatrixToRef(e,t,i){g.TransformCoordinatesToRef(e,t,i);const s=t.m,r=e._x*s[3]+e._y*s[7]+e._z*s[11]+s[15];oe.WithinEpsilon(r,1)&&i.scaleInPlace(1/r)}static UnprojectFromTransform(e,t,i,s,r){return this.Unproject(e,t,i,s,r,L.IdentityReadOnly)}static Unproject(e,t,i,s,r,n){const o=g.Zero();return g.UnprojectToRef(e,t,i,s,r,n,o),o}static UnprojectToRef(e,t,i,s,r,n,o){g.UnprojectFloatsToRef(e._x,e._y,e._z,t,i,s,r,n,o)}static UnprojectFloatsToRef(e,t,i,s,r,n,o,l,h){var c;const u=we.Matrix[0];n.multiplyToRef(o,u),u.multiplyToRef(l,u),u.invert();const d=we.Vector3[0];d.x=e/s*2-1,d.y=-(t/r*2-1),!((c=ye.LastCreatedEngine)===null||c===void 0)&&c.isNDCHalfZRange?d.z=i:d.z=2*i-1,g._UnprojectFromInvertedMatrixToRef(d,u,h)}static Minimize(e,t){const i=e.clone();return i.minimizeInPlace(t),i}static Maximize(e,t){const i=e.clone();return i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(g.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e._x-t._x,s=e._y-t._y,r=e._z-t._z;return i*i+s*s+r*r}static ProjectOnTriangleToRef(e,t,i,s,r){const n=we.Vector3[0],o=we.Vector3[1],l=we.Vector3[2],h=we.Vector3[3],c=we.Vector3[4];i.subtractToRef(t,n),s.subtractToRef(t,o),s.subtractToRef(i,l);const u=n.length(),d=o.length(),f=l.length();if(u<tt||d<tt||f<tt)return r.copyFrom(t),g.Distance(e,t);e.subtractToRef(t,c),g.CrossToRef(n,o,h);const p=h.length();if(p<tt)return r.copyFrom(t),g.Distance(e,t);h.normalizeFromLength(p);let _=c.length();if(_<tt)return r.copyFrom(t),0;c.normalizeFromLength(_);const m=g.Dot(h,c),v=we.Vector3[5],x=we.Vector3[6];v.copyFrom(h).scaleInPlace(-_*m),x.copyFrom(e).addInPlace(v);const b=we.Vector3[4],S=we.Vector3[5],C=we.Vector3[7],E=we.Vector3[8];b.copyFrom(n).scaleInPlace(1/u),E.copyFrom(o).scaleInPlace(1/d),b.addInPlace(E).scaleInPlace(-1),S.copyFrom(n).scaleInPlace(-1/u),E.copyFrom(l).scaleInPlace(1/f),S.addInPlace(E).scaleInPlace(-1),C.copyFrom(l).scaleInPlace(-1/f),E.copyFrom(o).scaleInPlace(-1/d),C.addInPlace(E).scaleInPlace(-1);const A=we.Vector3[9];let M;A.copyFrom(x).subtractInPlace(t),g.CrossToRef(b,A,E),M=g.Dot(E,h);const D=M;A.copyFrom(x).subtractInPlace(i),g.CrossToRef(S,A,E),M=g.Dot(E,h);const P=M;A.copyFrom(x).subtractInPlace(s),g.CrossToRef(C,A,E),M=g.Dot(E,h);const O=M,N=we.Vector3[10];let $,W;D>0&&P<0?(N.copyFrom(n),$=t,W=i):P>0&&O<0?(N.copyFrom(l),$=i,W=s):(N.copyFrom(o).scaleInPlace(-1),$=s,W=t);const K=we.Vector3[9],te=we.Vector3[4];if($.subtractToRef(x,E),W.subtractToRef(x,K),g.CrossToRef(E,K,te),!(g.Dot(te,h)<0))return r.copyFrom(x),Math.abs(_*m);const _e=we.Vector3[5];g.CrossToRef(N,te,_e),_e.normalize();const j=we.Vector3[9];j.copyFrom($).subtractInPlace(x);const ee=j.length();if(ee<tt)return r.copyFrom($),g.Distance(e,$);j.normalizeFromLength(ee);const F=g.Dot(_e,j),z=we.Vector3[7];z.copyFrom(x).addInPlace(_e.scaleInPlace(ee*F)),E.copyFrom(z).subtractInPlace($),_=N.length(),N.normalizeFromLength(_);let Z=g.Dot(E,N)/Math.max(_,tt);return Z=oe.Clamp(Z,0,1),z.copyFrom($).addInPlace(N.scaleInPlace(Z*_)),r.copyFrom(z),g.Distance(e,z)}static Center(e,t){return g.CenterToRef(e,t,g.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e._x+t._x)/2,(e._y+t._y)/2,(e._z+t._z)/2)}static RotationFromAxis(e,t,i){const s=g.Zero();return g.RotationFromAxisToRef(e,t,i,s),s}static RotationFromAxisToRef(e,t,i,s){const r=we.Quaternion[0];Q.RotationQuaternionFromAxisToRef(e,t,i,r),r.toEulerAnglesToRef(s)}}g._UpReadOnly=g.Up();g._DownReadOnly=g.Down();g._LeftHandedForwardReadOnly=g.Forward(!1);g._RightHandedForwardReadOnly=g.Forward(!0);g._RightReadOnly=g.Right();g._LeftReadOnly=g.Left();g._ZeroReadOnly=g.Zero();class Ge{constructor(e,t,i,s){this.x=e,this.y=t,this.z=i,this.w=s}toString(){return`{X: ${this.x} Y: ${this.y} Z: ${this.z} W: ${this.w}}`}getClassName(){return"Vector4"}getHashCode(){const e=Ds(this.x),t=Ds(this.y),i=Ds(this.z),s=Ds(this.w);let r=e;return r=r*397^t,r=r*397^i,r=r*397^s,r}asArray(){const e=new Array;return this.toArray(e,0),e}toArray(e,t){return t===void 0&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}fromArray(e,t=0){return Ge.FromArrayToRef(e,t,this),this}addInPlace(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}add(e){return new Ge(this.x+e.x,this.y+e.y,this.z+e.z,this.w+e.w)}addToRef(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t.w=this.w+e.w,this}subtractInPlace(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subtract(e){return new Ge(this.x-e.x,this.y-e.y,this.z-e.z,this.w-e.w)}subtractToRef(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t.w=this.w-e.w,this}subtractFromFloats(e,t,i,s){return new Ge(this.x-e,this.y-t,this.z-i,this.w-s)}subtractFromFloatsToRef(e,t,i,s,r){return r.x=this.x-e,r.y=this.y-t,r.z=this.z-i,r.w=this.w-s,this}negate(){return new Ge(-this.x,-this.y,-this.z,-this.w)}negateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this.w*=-1,this}negateToRef(e){return e.copyFromFloats(this.x*-1,this.y*-1,this.z*-1,this.w*-1)}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scale(e){return new Ge(this.x*e,this.y*e,this.z*e,this.w*e)}scaleToRef(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e,this}scaleAndAddToRef(e,t){return t.x+=this.x*e,t.y+=this.y*e,t.z+=this.z*e,t.w+=this.w*e,this}equals(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}equalsWithEpsilon(e,t=tt){return e&&oe.WithinEpsilon(this.x,e.x,t)&&oe.WithinEpsilon(this.y,e.y,t)&&oe.WithinEpsilon(this.z,e.z,t)&&oe.WithinEpsilon(this.w,e.w,t)}equalsToFloats(e,t,i,s){return this.x===e&&this.y===t&&this.z===i&&this.w===s}multiplyInPlace(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiply(e){return new Ge(this.x*e.x,this.y*e.y,this.z*e.z,this.w*e.w)}multiplyToRef(e,t){return t.x=this.x*e.x,t.y=this.y*e.y,t.z=this.z*e.z,t.w=this.w*e.w,this}multiplyByFloats(e,t,i,s){return new Ge(this.x*e,this.y*t,this.z*i,this.w*s)}divide(e){return new Ge(this.x/e.x,this.y/e.y,this.z/e.z,this.w/e.w)}divideToRef(e,t){return t.x=this.x/e.x,t.y=this.y/e.y,t.z=this.z/e.z,t.w=this.w/e.w,this}divideInPlace(e){return this.divideToRef(e,this)}minimizeInPlace(e){return e.x<this.x&&(this.x=e.x),e.y<this.y&&(this.y=e.y),e.z<this.z&&(this.z=e.z),e.w<this.w&&(this.w=e.w),this}maximizeInPlace(e){return e.x>this.x&&(this.x=e.x),e.y>this.y&&(this.y=e.y),e.z>this.z&&(this.z=e.z),e.w>this.w&&(this.w=e.w),this}floor(){return new Ge(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return new Ge(this.x-Math.floor(this.x),this.y-Math.floor(this.y),this.z-Math.floor(this.z),this.w-Math.floor(this.w))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}normalize(){const e=this.length();return e===0?this:this.scaleInPlace(1/e)}toVector3(){return new g(this.x,this.y,this.z)}clone(){return new Ge(this.x,this.y,this.z,this.w)}copyFrom(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}setAll(e){return this.x=this.y=this.z=this.w=e,this}static FromArray(e,t){return t||(t=0),new Ge(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3]}static FromFloatArrayToRef(e,t,i){Ge.FromArrayToRef(e,t,i)}static FromFloatsToRef(e,t,i,s,r){r.x=e,r.y=t,r.z=i,r.w=s}static Zero(){return new Ge(0,0,0,0)}static One(){return new Ge(1,1,1,1)}static get ZeroReadOnly(){return Ge._ZeroReadOnly}static Normalize(e){const t=Ge.Zero();return Ge.NormalizeToRef(e,t),t}static NormalizeToRef(e,t){t.copyFrom(e),t.normalize()}static Minimize(e,t){const i=e.clone();return i.minimizeInPlace(t),i}static Maximize(e,t){const i=e.clone();return i.maximizeInPlace(t),i}static Distance(e,t){return Math.sqrt(Ge.DistanceSquared(e,t))}static DistanceSquared(e,t){const i=e.x-t.x,s=e.y-t.y,r=e.z-t.z,n=e.w-t.w;return i*i+s*s+r*r+n*n}static Center(e,t){return Ge.CenterToRef(e,t,Ge.Zero())}static CenterToRef(e,t,i){return i.copyFromFloats((e.x+t.x)/2,(e.y+t.y)/2,(e.z+t.z)/2,(e.w+t.w)/2)}static TransformCoordinates(e,t){const i=Ge.Zero();return Ge.TransformCoordinatesToRef(e,t,i),i}static TransformCoordinatesToRef(e,t,i){Ge.TransformCoordinatesFromFloatsToRef(e._x,e._y,e._z,t,i)}static TransformCoordinatesFromFloatsToRef(e,t,i,s,r){const n=s.m,o=e*n[0]+t*n[4]+i*n[8]+n[12],l=e*n[1]+t*n[5]+i*n[9]+n[13],h=e*n[2]+t*n[6]+i*n[10]+n[14],c=e*n[3]+t*n[7]+i*n[11]+n[15];r.x=o,r.y=l,r.z=h,r.w=c}static TransformNormal(e,t){const i=Ge.Zero();return Ge.TransformNormalToRef(e,t,i),i}static TransformNormalToRef(e,t,i){const s=t.m,r=e.x*s[0]+e.y*s[4]+e.z*s[8],n=e.x*s[1]+e.y*s[5]+e.z*s[9],o=e.x*s[2]+e.y*s[6]+e.z*s[10];i.x=r,i.y=n,i.z=o,i.w=e.w}static TransformNormalFromFloatsToRef(e,t,i,s,r,n){const o=r.m;n.x=e*o[0]+t*o[4]+i*o[8],n.y=e*o[1]+t*o[5]+i*o[9],n.z=e*o[2]+t*o[6]+i*o[10],n.w=s}static FromVector3(e,t=0){return new Ge(e._x,e._y,e._z,t)}}Ge._ZeroReadOnly=Ge.Zero();class Q{constructor(e=0,t=0,i=0,s=1){this._isDirty=!0,this._x=e,this._y=t,this._z=i,this._w=s}get x(){return this._x}set x(e){this._x=e,this._isDirty=!0}get y(){return this._y}set y(e){this._y=e,this._isDirty=!0}get z(){return this._z}set z(e){this._z=e,this._isDirty=!0}get w(){return this._w}set w(e){this._w=e,this._isDirty=!0}toString(){return`{X: ${this._x} Y: ${this._y} Z: ${this._z} W: ${this._w}}`}getClassName(){return"Quaternion"}getHashCode(){const e=Ds(this._x),t=Ds(this._y),i=Ds(this._z),s=Ds(this._w);let r=e;return r=r*397^t,r=r*397^i,r=r*397^s,r}asArray(){return[this._x,this._y,this._z,this._w]}toArray(e,t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,this}equals(e){return e&&this._x===e._x&&this._y===e._y&&this._z===e._z&&this._w===e._w}equalsWithEpsilon(e,t=tt){return e&&oe.WithinEpsilon(this._x,e._x,t)&&oe.WithinEpsilon(this._y,e._y,t)&&oe.WithinEpsilon(this._z,e._z,t)&&oe.WithinEpsilon(this._w,e._w,t)}clone(){return new Q(this._x,this._y,this._z,this._w)}copyFrom(e){return this.x=e._x,this.y=e._y,this.z=e._z,this.w=e._w,this}copyFromFloats(e,t,i,s){return this.x=e,this.y=t,this.z=i,this.w=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}add(e){return new Q(this._x+e._x,this._y+e._y,this._z+e._z,this._w+e._w)}addInPlace(e){return this._x+=e._x,this._y+=e._y,this._z+=e._z,this._w+=e._w,this}subtract(e){return new Q(this._x-e._x,this._y-e._y,this._z-e._z,this._w-e._w)}subtractInPlace(e){return this._x-=e._x,this._y-=e._y,this._z-=e._z,this._w-=e._w,this}scale(e){return new Q(this._x*e,this._y*e,this._z*e,this._w*e)}scaleToRef(e,t){return t.x=this._x*e,t.y=this._y*e,t.z=this._z*e,t.w=this._w*e,this}scaleInPlace(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}scaleAndAddToRef(e,t){return t.x+=this._x*e,t.y+=this._y*e,t.z+=this._z*e,t.w+=this._w*e,this}multiply(e){const t=new Q(0,0,0,1);return this.multiplyToRef(e,t),t}multiplyToRef(e,t){const i=this._x*e._w+this._y*e._z-this._z*e._y+this._w*e._x,s=-this._x*e._z+this._y*e._w+this._z*e._x+this._w*e._y,r=this._x*e._y-this._y*e._x+this._z*e._w+this._w*e._z,n=-this._x*e._x-this._y*e._y-this._z*e._z+this._w*e._w;return t.copyFromFloats(i,s,r,n),this}multiplyInPlace(e){return this.multiplyToRef(e,this),this}conjugateToRef(e){return e.copyFromFloats(-this._x,-this._y,-this._z,this._w),this}conjugateInPlace(){return this.x*=-1,this.y*=-1,this.z*=-1,this}conjugate(){return new Q(-this._x,-this._y,-this._z,this._w)}invert(){const e=this.conjugate(),t=this.lengthSquared();return t==0||t==1||e.scaleInPlace(1/t),e}invertInPlace(){this.conjugateInPlace();const e=this.lengthSquared();return e==0||e==1?this:(this.scaleInPlace(1/e),this)}lengthSquared(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this.lengthSquared())}normalize(){const e=this.length();if(e===0)return this;const t=1/e;return this.scaleInPlace(t),this}normalizeToNew(){const e=this.length();if(e===0)return this.clone();const t=1/e;return this.scale(t)}toEulerAngles(){const e=g.Zero();return this.toEulerAnglesToRef(e),e}toEulerAnglesToRef(e){const t=this._z,i=this._x,s=this._y,r=this._w,n=s*t-i*r,o=.4999999;if(n<-o)e.y=2*Math.atan2(s,r),e.x=Math.PI/2,e.z=0;else if(n>o)e.y=2*Math.atan2(s,r),e.x=-Math.PI/2,e.z=0;else{const l=r*r,h=t*t,c=i*i,u=s*s;e.z=Math.atan2(2*(i*s+t*r),-h-c+u+l),e.x=Math.asin(-2*n),e.y=Math.atan2(2*(t*i+s*r),h-c-u+l)}return this}toRotationMatrix(e){return L.FromQuaternionToRef(this,e),this}fromRotationMatrix(e){return Q.FromRotationMatrixToRef(e,this),this}static FromRotationMatrix(e){const t=new Q;return Q.FromRotationMatrixToRef(e,t),t}static FromRotationMatrixToRef(e,t){const i=e.m,s=i[0],r=i[4],n=i[8],o=i[1],l=i[5],h=i[9],c=i[2],u=i[6],d=i[10],f=s+l+d;let p;f>0?(p=.5/Math.sqrt(f+1),t.w=.25/p,t.x=(u-h)*p,t.y=(n-c)*p,t.z=(o-r)*p):s>l&&s>d?(p=2*Math.sqrt(1+s-l-d),t.w=(u-h)/p,t.x=.25*p,t.y=(r+o)/p,t.z=(n+c)/p):l>d?(p=2*Math.sqrt(1+l-s-d),t.w=(n-c)/p,t.x=(r+o)/p,t.y=.25*p,t.z=(h+u)/p):(p=2*Math.sqrt(1+d-s-l),t.w=(o-r)/p,t.x=(n+c)/p,t.y=(h+u)/p,t.z=.25*p)}static RotationQuaternionFromOnto(e,t){const i=Q.Zero();return Q.RotationQuaternionFromOntoToRef(e,t,i)}static RotationQuaternionFromOntoToRef(e,t,i){const s=G.Vector3[0];g.CrossToRef(e,t,s),s.equals(g.ZeroReadOnly)&&e._getNormalToRef(s);const r=g.GetAngleBetweenVectors(e,t,s);return Q.RotationAxisToRef(s,r,i)}static Dot(e,t){return e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w}static AreClose(e,t,i=.1){const s=Q.Dot(e,t);return 1-s*s<=i}static SmoothToRef(e,t,i,s,r){let n=s===0?1:i/s;n=oe.Clamp(n,0,1),Q.SlerpToRef(e,t,n,r)}static Zero(){return new Q(0,0,0,0)}static Inverse(e){return new Q(-e._x,-e._y,-e._z,e._w)}static InverseToRef(e,t){return t.set(-e._x,-e._y,-e._z,e._w),t}static Identity(){return new Q(0,0,0,1)}static IsIdentity(e){return e&&e._x===0&&e._y===0&&e._z===0&&e._w===1}static RotationAxis(e,t){return Q.RotationAxisToRef(e,t,new Q)}static RotationAxisToRef(e,t,i){const s=Math.sin(t/2);return e.normalize(),i.w=Math.cos(t/2),i.x=e._x*s,i.y=e._y*s,i.z=e._z*s,i}static FromArray(e,t){return t||(t=0),new Q(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t,i){i.x=e[t],i.y=e[t+1],i.z=e[t+2],i.w=e[t+3]}static FromEulerAngles(e,t,i){const s=new Q;return Q.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerAnglesToRef(e,t,i,s){return Q.RotationYawPitchRollToRef(t,e,i,s),s}static FromEulerVector(e){const t=new Q;return Q.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromEulerVectorToRef(e,t){return Q.RotationYawPitchRollToRef(e._y,e._x,e._z,t),t}static FromUnitVectorsToRef(e,t,i){const s=g.Dot(e,t)+1;return s<tt?Math.abs(e.x)>Math.abs(e.z)?i.set(-e.y,e.x,0,0):i.set(0,-e.z,e.y,0):(g.CrossToRef(e,t,G.Vector3[0]),i.set(G.Vector3[0].x,G.Vector3[0].y,G.Vector3[0].z,s)),i.normalize()}static RotationYawPitchRoll(e,t,i){const s=new Q;return Q.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){const r=i*.5,n=t*.5,o=e*.5,l=Math.sin(r),h=Math.cos(r),c=Math.sin(n),u=Math.cos(n),d=Math.sin(o),f=Math.cos(o);s.x=f*c*h+d*u*l,s.y=d*u*h-f*c*l,s.z=f*u*l-d*c*h,s.w=f*u*h+d*c*l}static RotationAlphaBetaGamma(e,t,i){const s=new Q;return Q.RotationAlphaBetaGammaToRef(e,t,i,s),s}static RotationAlphaBetaGammaToRef(e,t,i,s){const r=(i+e)*.5,n=(i-e)*.5,o=t*.5;s.x=Math.cos(n)*Math.sin(o),s.y=Math.sin(n)*Math.sin(o),s.z=Math.sin(r)*Math.cos(o),s.w=Math.cos(r)*Math.cos(o)}static RotationQuaternionFromAxis(e,t,i){const s=new Q(0,0,0,0);return Q.RotationQuaternionFromAxisToRef(e,t,i,s),s}static RotationQuaternionFromAxisToRef(e,t,i,s){const r=we.Matrix[0];L.FromXYZAxesToRef(e.normalize(),t.normalize(),i.normalize(),r),Q.FromRotationMatrixToRef(r,s)}static FromLookDirectionLH(e,t){const i=new Q;return Q.FromLookDirectionLHToRef(e,t,i),i}static FromLookDirectionLHToRef(e,t,i){const s=we.Matrix[0];L.LookDirectionLHToRef(e,t,s),Q.FromRotationMatrixToRef(s,i)}static FromLookDirectionRH(e,t){const i=new Q;return Q.FromLookDirectionRHToRef(e,t,i),i}static FromLookDirectionRHToRef(e,t,i){const s=we.Matrix[0];return L.LookDirectionRHToRef(e,t,s),Q.FromRotationMatrixToRef(s,i)}static Slerp(e,t,i){const s=Q.Identity();return Q.SlerpToRef(e,t,i,s),s}static SlerpToRef(e,t,i,s){let r,n,o=e._x*t._x+e._y*t._y+e._z*t._z+e._w*t._w,l=!1;if(o<0&&(l=!0,o=-o),o>.999999)n=1-i,r=l?-i:i;else{const h=Math.acos(o),c=1/Math.sin(h);n=Math.sin((1-i)*h)*c,r=l?-Math.sin(i*h)*c:Math.sin(i*h)*c}s.x=n*e._x+r*t._x,s.y=n*e._y+r*t._y,s.z=n*e._z+r*t._z,s.w=n*e._w+r*t._w}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,l=2*o-3*n+1,h=-2*o+3*n,c=o-2*n+r,u=o-n,d=e._x*l+i._x*h+t._x*c+s._x*u,f=e._y*l+i._y*h+t._y*c+s._y*u,p=e._z*l+i._z*h+t._z*c+s._z*u,_=e._w*l+i._w*h+t._w*c+s._w*u;return new Q(d,f,p,_)}static Hermite1stDerivative(e,t,i,s,r){const n=Q.Zero();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.x=(o-r)*6*e.x+(3*o-4*r+1)*t.x+(-o+r)*6*i.x+(3*o-2*r)*s.x,n.y=(o-r)*6*e.y+(3*o-4*r+1)*t.y+(-o+r)*6*i.y+(3*o-2*r)*s.y,n.z=(o-r)*6*e.z+(3*o-4*r+1)*t.z+(-o+r)*6*i.z+(3*o-2*r)*s.z,n.w=(o-r)*6*e.w+(3*o-4*r+1)*t.w+(-o+r)*6*i.w+(3*o-2*r)*s.w}}class L{constructor(){this._isIdentity=!1,this._isIdentityDirty=!0,this._isIdentity3x2=!0,this._isIdentity3x2Dirty=!0,this.updateFlag=-1,Pi.MatrixTrackPrecisionChange&&Pi.MatrixTrackedMatrices.push(this),this._m=new Pi.MatrixCurrentType(16),this.markAsUpdated()}static get Use64Bits(){return Pi.MatrixUse64Bits}get m(){return this._m}markAsUpdated(){this.updateFlag=L._UpdateFlagSeed++,this._isIdentity=!1,this._isIdentity3x2=!1,this._isIdentityDirty=!0,this._isIdentity3x2Dirty=!0}_updateIdentityStatus(e,t=!1,i=!1,s=!0){this._isIdentity=e,this._isIdentity3x2=e||i,this._isIdentityDirty=this._isIdentity?!1:t,this._isIdentity3x2Dirty=this._isIdentity3x2?!1:s}isIdentity(){if(this._isIdentityDirty){this._isIdentityDirty=!1;const e=this._m;this._isIdentity=e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1}return this._isIdentity}isIdentityAs3x2(){return this._isIdentity3x2Dirty&&(this._isIdentity3x2Dirty=!1,this._m[0]!==1||this._m[5]!==1||this._m[15]!==1?this._isIdentity3x2=!1:this._m[1]!==0||this._m[2]!==0||this._m[3]!==0||this._m[4]!==0||this._m[6]!==0||this._m[7]!==0||this._m[8]!==0||this._m[9]!==0||this._m[10]!==0||this._m[11]!==0||this._m[12]!==0||this._m[13]!==0||this._m[14]!==0?this._isIdentity3x2=!1:this._isIdentity3x2=!0),this._isIdentity3x2}determinant(){if(this._isIdentity===!0)return 1;const e=this._m,t=e[0],i=e[1],s=e[2],r=e[3],n=e[4],o=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],f=e[11],p=e[12],_=e[13],m=e[14],v=e[15],x=d*v-m*f,b=u*v-_*f,S=u*m-_*d,C=c*v-p*f,E=c*m-d*p,A=c*_-p*u,M=+(o*x-l*b+h*S),D=-(n*x-l*C+h*E),P=+(n*b-o*C+h*A),O=-(n*S-o*E+l*A);return t*M+i*D+s*P+r*O}toArray(){return this._m}asArray(){return this._m}invert(){return this.invertToRef(this),this}reset(){return L.FromValuesToRef(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,this),this._updateIdentityStatus(!1),this}add(e){const t=new L;return this.addToRef(e,t),t}addToRef(e,t){const i=this._m,s=t._m,r=e.m;for(let n=0;n<16;n++)s[n]=i[n]+r[n];return t.markAsUpdated(),this}addToSelf(e){const t=this._m,i=e.m;for(let s=0;s<16;s++)t[s]+=i[s];return this.markAsUpdated(),this}invertToRef(e){if(this._isIdentity===!0)return L.IdentityToRef(e),this;const t=this._m,i=t[0],s=t[1],r=t[2],n=t[3],o=t[4],l=t[5],h=t[6],c=t[7],u=t[8],d=t[9],f=t[10],p=t[11],_=t[12],m=t[13],v=t[14],x=t[15],b=f*x-v*p,S=d*x-m*p,C=d*v-m*f,E=u*x-_*p,A=u*v-f*_,M=u*m-_*d,D=+(l*b-h*S+c*C),P=-(o*b-h*E+c*A),O=+(o*S-l*E+c*M),N=-(o*C-l*A+h*M),$=i*D+s*P+r*O+n*N;if($===0)return e.copyFrom(this),this;const W=1/$,K=h*x-v*c,te=l*x-m*c,ve=l*v-m*h,_e=o*x-_*c,j=o*v-_*h,ee=o*m-_*l,F=h*p-f*c,z=l*p-d*c,Z=l*f-d*h,Ee=o*p-u*c,He=o*f-u*h,ut=o*d-u*l,me=-(s*b-r*S+n*C),Se=+(i*b-r*E+n*A),it=-(i*S-s*E+n*M),Zt=+(i*C-s*A+r*M),Xe=+(s*K-r*te+n*ve),Re=-(i*K-r*_e+n*j),rt=+(i*te-s*_e+n*ee),xt=-(i*ve-s*j+r*ee),At=-(s*F-r*z+n*Z),Ut=+(i*F-r*Ee+n*He),ms=-(i*z-s*Ee+n*ut),wi=+(i*Z-s*He+r*ut);return L.FromValuesToRef(D*W,me*W,Xe*W,At*W,P*W,Se*W,Re*W,Ut*W,O*W,it*W,rt*W,ms*W,N*W,Zt*W,xt*W,wi*W,e),this}addAtIndex(e,t){return this._m[e]+=t,this.markAsUpdated(),this}multiplyAtIndex(e,t){return this._m[e]*=t,this.markAsUpdated(),this}setTranslationFromFloats(e,t,i){return this._m[12]=e,this._m[13]=t,this._m[14]=i,this.markAsUpdated(),this}addTranslationFromFloats(e,t,i){return this._m[12]+=e,this._m[13]+=t,this._m[14]+=i,this.markAsUpdated(),this}setTranslation(e){return this.setTranslationFromFloats(e._x,e._y,e._z)}getTranslation(){return new g(this._m[12],this._m[13],this._m[14])}getTranslationToRef(e){return e.x=this._m[12],e.y=this._m[13],e.z=this._m[14],this}removeRotationAndScaling(){const e=this.m;return L.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e[12],e[13],e[14],e[15],this),this._updateIdentityStatus(e[12]===0&&e[13]===0&&e[14]===0&&e[15]===1),this}multiply(e){const t=new L;return this.multiplyToRef(e,t),t}copyFrom(e){e.copyToArray(this._m);const t=e;return this.updateFlag=t.updateFlag,this._updateIdentityStatus(t._isIdentity,t._isIdentityDirty,t._isIdentity3x2,t._isIdentity3x2Dirty),this}copyToArray(e,t=0){const i=this._m;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],this}multiplyToRef(e,t){return this._isIdentity?(t.copyFrom(e),this):e._isIdentity?(t.copyFrom(this),this):(this.multiplyToArray(e,t._m,0),t.markAsUpdated(),this)}multiplyToArray(e,t,i){const s=this._m,r=e.m,n=s[0],o=s[1],l=s[2],h=s[3],c=s[4],u=s[5],d=s[6],f=s[7],p=s[8],_=s[9],m=s[10],v=s[11],x=s[12],b=s[13],S=s[14],C=s[15],E=r[0],A=r[1],M=r[2],D=r[3],P=r[4],O=r[5],N=r[6],$=r[7],W=r[8],K=r[9],te=r[10],ve=r[11],_e=r[12],j=r[13],ee=r[14],F=r[15];return t[i]=n*E+o*P+l*W+h*_e,t[i+1]=n*A+o*O+l*K+h*j,t[i+2]=n*M+o*N+l*te+h*ee,t[i+3]=n*D+o*$+l*ve+h*F,t[i+4]=c*E+u*P+d*W+f*_e,t[i+5]=c*A+u*O+d*K+f*j,t[i+6]=c*M+u*N+d*te+f*ee,t[i+7]=c*D+u*$+d*ve+f*F,t[i+8]=p*E+_*P+m*W+v*_e,t[i+9]=p*A+_*O+m*K+v*j,t[i+10]=p*M+_*N+m*te+v*ee,t[i+11]=p*D+_*$+m*ve+v*F,t[i+12]=x*E+b*P+S*W+C*_e,t[i+13]=x*A+b*O+S*K+C*j,t[i+14]=x*M+b*N+S*te+C*ee,t[i+15]=x*D+b*$+S*ve+C*F,this}equals(e){const t=e;if(!t)return!1;if((this._isIdentity||t._isIdentity)&&!this._isIdentityDirty&&!t._isIdentityDirty)return this._isIdentity&&t._isIdentity;const i=this.m,s=t.m;return i[0]===s[0]&&i[1]===s[1]&&i[2]===s[2]&&i[3]===s[3]&&i[4]===s[4]&&i[5]===s[5]&&i[6]===s[6]&&i[7]===s[7]&&i[8]===s[8]&&i[9]===s[9]&&i[10]===s[10]&&i[11]===s[11]&&i[12]===s[12]&&i[13]===s[13]&&i[14]===s[14]&&i[15]===s[15]}clone(){const e=new L;return e.copyFrom(this),e}getClassName(){return"Matrix"}getHashCode(){let e=Ds(this._m[0]);for(let t=1;t<16;t++)e=e*397^Ds(this._m[t]);return e}decomposeToTransformNode(e){return e.rotationQuaternion=e.rotationQuaternion||new Q,this.decompose(e.scaling,e.rotationQuaternion,e.position)}decompose(e,t,i,s){if(this._isIdentity)return i&&i.setAll(0),e&&e.setAll(1),t&&t.copyFromFloats(0,0,0,1),!0;const r=this._m;if(i&&i.copyFromFloats(r[12],r[13],r[14]),e=e||we.Vector3[0],e.x=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),e.y=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),e.z=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),s){const n=s.scaling.x<0?-1:1,o=s.scaling.y<0?-1:1,l=s.scaling.z<0?-1:1;e.x*=n,e.y*=o,e.z*=l}else this.determinant()<=0&&(e.y*=-1);if(e._x===0||e._y===0||e._z===0)return t&&t.copyFromFloats(0,0,0,1),!1;if(t){const n=1/e._x,o=1/e._y,l=1/e._z;L.FromValuesToRef(r[0]*n,r[1]*n,r[2]*n,0,r[4]*o,r[5]*o,r[6]*o,0,r[8]*l,r[9]*l,r[10]*l,0,0,0,0,1,we.Matrix[0]),Q.FromRotationMatrixToRef(we.Matrix[0],t)}return!0}getRow(e){if(e<0||e>3)return null;const t=e*4;return new Ge(this._m[t+0],this._m[t+1],this._m[t+2],this._m[t+3])}getRowToRef(e,t){if(e>=0&&e<3){const i=e*4;t.x=this._m[i+0],t.y=this._m[i+1],t.z=this._m[i+2],t.w=this._m[i+3]}return this}setRow(e,t){return this.setRowFromFloats(e,t.x,t.y,t.z,t.w)}transpose(){return L.Transpose(this)}transposeToRef(e){return L.TransposeToRef(this,e),this}setRowFromFloats(e,t,i,s,r){if(e<0||e>3)return this;const n=e*4;return this._m[n+0]=t,this._m[n+1]=i,this._m[n+2]=s,this._m[n+3]=r,this.markAsUpdated(),this}scale(e){const t=new L;return this.scaleToRef(e,t),t}scaleToRef(e,t){for(let i=0;i<16;i++)t._m[i]=this._m[i]*e;return t.markAsUpdated(),this}scaleAndAddToRef(e,t){for(let i=0;i<16;i++)t._m[i]+=this._m[i]*e;return t.markAsUpdated(),this}toNormalMatrix(e){const t=we.Matrix[0];this.invertToRef(t),t.transposeToRef(e);const i=e._m;L.FromValuesToRef(i[0],i[1],i[2],0,i[4],i[5],i[6],0,i[8],i[9],i[10],0,0,0,0,1,e)}getRotationMatrix(){const e=new L;return this.getRotationMatrixToRef(e),e}getRotationMatrixToRef(e){const t=we.Vector3[0];if(!this.decompose(t))return L.IdentityToRef(e),this;const i=this._m,s=1/t._x,r=1/t._y,n=1/t._z;return L.FromValuesToRef(i[0]*s,i[1]*s,i[2]*s,0,i[4]*r,i[5]*r,i[6]*r,0,i[8]*n,i[9]*n,i[10]*n,0,0,0,0,1,e),this}toggleModelMatrixHandInPlace(){const e=this._m;e[2]*=-1,e[6]*=-1,e[8]*=-1,e[9]*=-1,e[14]*=-1,this.markAsUpdated()}toggleProjectionMatrixHandInPlace(){const e=this._m;e[8]*=-1,e[9]*=-1,e[10]*=-1,e[11]*=-1,this.markAsUpdated()}static FromArray(e,t=0){const i=new L;return L.FromArrayToRef(e,t,i),i}static FromArrayToRef(e,t,i){for(let s=0;s<16;s++)i._m[s]=e[s+t];i.markAsUpdated()}static FromFloat32ArrayToRefScaled(e,t,i,s){for(let r=0;r<16;r++)s._m[r]=e[r+t]*i;s.markAsUpdated()}static get IdentityReadOnly(){return L._IdentityReadOnly}static FromValuesToRef(e,t,i,s,r,n,o,l,h,c,u,d,f,p,_,m,v){const x=v._m;x[0]=e,x[1]=t,x[2]=i,x[3]=s,x[4]=r,x[5]=n,x[6]=o,x[7]=l,x[8]=h,x[9]=c,x[10]=u,x[11]=d,x[12]=f,x[13]=p,x[14]=_,x[15]=m,v.markAsUpdated()}static FromValues(e,t,i,s,r,n,o,l,h,c,u,d,f,p,_,m){const v=new L,x=v._m;return x[0]=e,x[1]=t,x[2]=i,x[3]=s,x[4]=r,x[5]=n,x[6]=o,x[7]=l,x[8]=h,x[9]=c,x[10]=u,x[11]=d,x[12]=f,x[13]=p,x[14]=_,x[15]=m,v.markAsUpdated(),v}static Compose(e,t,i){const s=new L;return L.ComposeToRef(e,t,i,s),s}static ComposeToRef(e,t,i,s){const r=s._m,n=t._x,o=t._y,l=t._z,h=t._w,c=n+n,u=o+o,d=l+l,f=n*c,p=n*u,_=n*d,m=o*u,v=o*d,x=l*d,b=h*c,S=h*u,C=h*d,E=e._x,A=e._y,M=e._z;r[0]=(1-(m+x))*E,r[1]=(p+C)*E,r[2]=(_-S)*E,r[3]=0,r[4]=(p-C)*A,r[5]=(1-(f+x))*A,r[6]=(v+b)*A,r[7]=0,r[8]=(_+S)*M,r[9]=(v-b)*M,r[10]=(1-(f+m))*M,r[11]=0,r[12]=i._x,r[13]=i._y,r[14]=i._z,r[15]=1,s.markAsUpdated()}static Identity(){const e=L.FromValues(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);return e._updateIdentityStatus(!0),e}static IdentityToRef(e){L.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,e),e._updateIdentityStatus(!0)}static Zero(){const e=L.FromValues(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);return e._updateIdentityStatus(!1),e}static RotationX(e){const t=new L;return L.RotationXToRef(e,t),t}static Invert(e){const t=new L;return e.invertToRef(t),t}static RotationXToRef(e,t){const i=Math.sin(e),s=Math.cos(e);L.FromValuesToRef(1,0,0,0,0,s,i,0,0,-i,s,0,0,0,0,1,t),t._updateIdentityStatus(s===1&&i===0)}static RotationY(e){const t=new L;return L.RotationYToRef(e,t),t}static RotationYToRef(e,t){const i=Math.sin(e),s=Math.cos(e);L.FromValuesToRef(s,0,-i,0,0,1,0,0,i,0,s,0,0,0,0,1,t),t._updateIdentityStatus(s===1&&i===0)}static RotationZ(e){const t=new L;return L.RotationZToRef(e,t),t}static RotationZToRef(e,t){const i=Math.sin(e),s=Math.cos(e);L.FromValuesToRef(s,i,0,0,-i,s,0,0,0,0,1,0,0,0,0,1,t),t._updateIdentityStatus(s===1&&i===0)}static RotationAxis(e,t){const i=new L;return L.RotationAxisToRef(e,t,i),i}static RotationAxisToRef(e,t,i){const s=Math.sin(-t),r=Math.cos(-t),n=1-r;e.normalize();const o=i._m;o[0]=e._x*e._x*n+r,o[1]=e._x*e._y*n-e._z*s,o[2]=e._x*e._z*n+e._y*s,o[3]=0,o[4]=e._y*e._x*n+e._z*s,o[5]=e._y*e._y*n+r,o[6]=e._y*e._z*n-e._x*s,o[7]=0,o[8]=e._z*e._x*n-e._y*s,o[9]=e._z*e._y*n+e._x*s,o[10]=e._z*e._z*n+r,o[11]=0,o[12]=0,o[13]=0,o[14]=0,o[15]=1,i.markAsUpdated()}static RotationAlignToRef(e,t,i){const s=g.Dot(t,e),r=i._m;if(s<-1+tt)r[0]=-1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=-1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0;else{const n=g.Cross(t,e),o=1/(1+s);r[0]=n._x*n._x*o+s,r[1]=n._y*n._x*o-n._z,r[2]=n._z*n._x*o+n._y,r[3]=0,r[4]=n._x*n._y*o+n._z,r[5]=n._y*n._y*o+s,r[6]=n._z*n._y*o-n._x,r[7]=0,r[8]=n._x*n._z*o-n._y,r[9]=n._y*n._z*o+n._x,r[10]=n._z*n._z*o+s,r[11]=0}r[12]=0,r[13]=0,r[14]=0,r[15]=1,i.markAsUpdated()}static RotationYawPitchRoll(e,t,i){const s=new L;return L.RotationYawPitchRollToRef(e,t,i,s),s}static RotationYawPitchRollToRef(e,t,i,s){Q.RotationYawPitchRollToRef(e,t,i,we.Quaternion[0]),we.Quaternion[0].toRotationMatrix(s)}static Scaling(e,t,i){const s=new L;return L.ScalingToRef(e,t,i,s),s}static ScalingToRef(e,t,i,s){L.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1,s),s._updateIdentityStatus(e===1&&t===1&&i===1)}static Translation(e,t,i){const s=new L;return L.TranslationToRef(e,t,i,s),s}static TranslationToRef(e,t,i,s){L.FromValuesToRef(1,0,0,0,0,1,0,0,0,0,1,0,e,t,i,1,s),s._updateIdentityStatus(e===0&&t===0&&i===0)}static Lerp(e,t,i){const s=new L;return L.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){const r=s._m,n=e.m,o=t.m;for(let l=0;l<16;l++)r[l]=n[l]*(1-i)+o[l]*i;s.markAsUpdated()}static DecomposeLerp(e,t,i){const s=new L;return L.DecomposeLerpToRef(e,t,i,s),s}static DecomposeLerpToRef(e,t,i,s){const r=we.Vector3[0],n=we.Quaternion[0],o=we.Vector3[1];e.decompose(r,n,o);const l=we.Vector3[2],h=we.Quaternion[1],c=we.Vector3[3];t.decompose(l,h,c);const u=we.Vector3[4];g.LerpToRef(r,l,i,u);const d=we.Quaternion[2];Q.SlerpToRef(n,h,i,d);const f=we.Vector3[5];g.LerpToRef(o,c,i,f),L.ComposeToRef(u,d,f,s)}static LookAtLH(e,t,i){const s=new L;return L.LookAtLHToRef(e,t,i,s),s}static LookAtLHToRef(e,t,i,s){const r=we.Vector3[0],n=we.Vector3[1],o=we.Vector3[2];t.subtractToRef(e,o),o.normalize(),g.CrossToRef(i,o,r);const l=r.lengthSquared();l===0?r.x=1:r.normalizeFromLength(Math.sqrt(l)),g.CrossToRef(o,r,n),n.normalize();const h=-g.Dot(r,e),c=-g.Dot(n,e),u=-g.Dot(o,e);L.FromValuesToRef(r._x,n._x,o._x,0,r._y,n._y,o._y,0,r._z,n._z,o._z,0,h,c,u,1,s)}static LookAtRH(e,t,i){const s=new L;return L.LookAtRHToRef(e,t,i,s),s}static LookAtRHToRef(e,t,i,s){const r=we.Vector3[0],n=we.Vector3[1],o=we.Vector3[2];e.subtractToRef(t,o),o.normalize(),g.CrossToRef(i,o,r);const l=r.lengthSquared();l===0?r.x=1:r.normalizeFromLength(Math.sqrt(l)),g.CrossToRef(o,r,n),n.normalize();const h=-g.Dot(r,e),c=-g.Dot(n,e),u=-g.Dot(o,e);L.FromValuesToRef(r._x,n._x,o._x,0,r._y,n._y,o._y,0,r._z,n._z,o._z,0,h,c,u,1,s)}static LookDirectionLH(e,t){const i=new L;return L.LookDirectionLHToRef(e,t,i),i}static LookDirectionLHToRef(e,t,i){const s=we.Vector3[0];s.copyFrom(e),s.scaleInPlace(-1);const r=we.Vector3[1];g.CrossToRef(t,s,r),L.FromValuesToRef(r._x,r._y,r._z,0,t._x,t._y,t._z,0,s._x,s._y,s._z,0,0,0,0,1,i)}static LookDirectionRH(e,t){const i=new L;return L.LookDirectionRHToRef(e,t,i),i}static LookDirectionRHToRef(e,t,i){const s=we.Vector3[2];g.CrossToRef(t,e,s),L.FromValuesToRef(s._x,s._y,s._z,0,t._x,t._y,t._z,0,e._x,e._y,e._z,0,0,0,0,1,i)}static OrthoLH(e,t,i,s,r){const n=new L;return L.OrthoLHToRef(e,t,i,s,n,r),n}static OrthoLHToRef(e,t,i,s,r,n){const o=i,l=s,h=2/e,c=2/t,u=2/(l-o),d=-(l+o)/(l-o);L.FromValuesToRef(h,0,0,0,0,c,0,0,0,0,u,0,0,0,d,1,r),n&&r.multiplyToRef(Rn,r),r._updateIdentityStatus(h===1&&c===1&&u===1&&d===0)}static OrthoOffCenterLH(e,t,i,s,r,n,o){const l=new L;return L.OrthoOffCenterLHToRef(e,t,i,s,r,n,l,o),l}static OrthoOffCenterLHToRef(e,t,i,s,r,n,o,l){const h=r,c=n,u=2/(t-e),d=2/(s-i),f=2/(c-h),p=-(c+h)/(c-h),_=(e+t)/(e-t),m=(s+i)/(i-s);L.FromValuesToRef(u,0,0,0,0,d,0,0,0,0,f,0,_,m,p,1,o),l&&o.multiplyToRef(Rn,o),o.markAsUpdated()}static OrthoOffCenterRH(e,t,i,s,r,n,o){const l=new L;return L.OrthoOffCenterRHToRef(e,t,i,s,r,n,l,o),l}static OrthoOffCenterRHToRef(e,t,i,s,r,n,o,l){L.OrthoOffCenterLHToRef(e,t,i,s,r,n,o,l),o._m[10]*=-1}static PerspectiveLH(e,t,i,s,r,n=0){const o=new L,l=i,h=s,c=2*l/e,u=2*l/t,d=(h+l)/(h-l),f=-2*h*l/(h-l),p=Math.tan(n);return L.FromValuesToRef(c,0,0,0,0,u,0,p,0,0,d,1,0,0,f,0,o),r&&o.multiplyToRef(Rn,o),o._updateIdentityStatus(!1),o}static PerspectiveFovLH(e,t,i,s,r,n=0,o=!1){const l=new L;return L.PerspectiveFovLHToRef(e,t,i,s,l,!0,r,n,o),l}static PerspectiveFovLHToRef(e,t,i,s,r,n=!0,o,l=0,h=!1){const c=i,u=s,d=1/Math.tan(e*.5),f=n?d/t:d,p=n?d:d*t,_=h&&c===0?-1:u!==0?(u+c)/(u-c):1,m=h&&c===0?2*u:u!==0?-2*u*c/(u-c):-2*c,v=Math.tan(l);L.FromValuesToRef(f,0,0,0,0,p,0,v,0,0,_,1,0,0,m,0,r),o&&r.multiplyToRef(Rn,r),r._updateIdentityStatus(!1)}static PerspectiveFovReverseLHToRef(e,t,i,s,r,n=!0,o,l=0){const h=1/Math.tan(e*.5),c=n?h/t:h,u=n?h:h*t,d=Math.tan(l);L.FromValuesToRef(c,0,0,0,0,u,0,d,0,0,-i,1,0,0,1,0,r),o&&r.multiplyToRef(Rn,r),r._updateIdentityStatus(!1)}static PerspectiveFovRH(e,t,i,s,r,n=0,o=!1){const l=new L;return L.PerspectiveFovRHToRef(e,t,i,s,l,!0,r,n,o),l}static PerspectiveFovRHToRef(e,t,i,s,r,n=!0,o,l=0,h=!1){const c=i,u=s,d=1/Math.tan(e*.5),f=n?d/t:d,p=n?d:d*t,_=h&&c===0?1:u!==0?-(u+c)/(u-c):-1,m=h&&c===0?2*u:u!==0?-2*u*c/(u-c):-2*c,v=Math.tan(l);L.FromValuesToRef(f,0,0,0,0,p,0,v,0,0,_,-1,0,0,m,0,r),o&&r.multiplyToRef(Rn,r),r._updateIdentityStatus(!1)}static PerspectiveFovReverseRHToRef(e,t,i,s,r,n=!0,o,l=0){const h=1/Math.tan(e*.5),c=n?h/t:h,u=n?h:h*t,d=Math.tan(l);L.FromValuesToRef(c,0,0,0,0,u,0,d,0,0,-i,-1,0,0,-1,0,r),o&&r.multiplyToRef(Rn,r),r._updateIdentityStatus(!1)}static PerspectiveFovWebVRToRef(e,t,i,s,r=!1,n,o=0){const l=r?-1:1,h=Math.tan(e.upDegrees*Math.PI/180),c=Math.tan(e.downDegrees*Math.PI/180),u=Math.tan(e.leftDegrees*Math.PI/180),d=Math.tan(e.rightDegrees*Math.PI/180),f=2/(u+d),p=2/(h+c),_=Math.tan(o),m=s._m;m[0]=f,m[1]=m[2]=m[3]=m[4]=0,m[5]=p,m[6]=0,m[7]=_,m[8]=(u-d)*f*.5,m[9]=-((h-c)*p*.5),m[10]=-i/(t-i),m[11]=1*l,m[12]=m[13]=m[15]=0,m[14]=-(2*i*t)/(i-t),n&&s.multiplyToRef(Rn,s),s.markAsUpdated()}static GetFinalMatrix(e,t,i,s,r,n){const o=e.width,l=e.height,h=e.x,c=e.y,u=L.FromValues(o/2,0,0,0,0,-l/2,0,0,0,0,n-r,0,h+o/2,l/2+c,r,1),d=we.Matrix[0];return t.multiplyToRef(i,d),d.multiplyToRef(s,d),d.multiply(u)}static GetAsMatrix2x2(e){const t=e.m,i=[t[0],t[1],t[4],t[5]];return Pi.MatrixUse64Bits?i:new Float32Array(i)}static GetAsMatrix3x3(e){const t=e.m,i=[t[0],t[1],t[2],t[4],t[5],t[6],t[8],t[9],t[10]];return Pi.MatrixUse64Bits?i:new Float32Array(i)}static Transpose(e){const t=new L;return L.TransposeToRef(e,t),t}static TransposeToRef(e,t){const i=t._m,s=e.m;i[0]=s[0],i[1]=s[4],i[2]=s[8],i[3]=s[12],i[4]=s[1],i[5]=s[5],i[6]=s[9],i[7]=s[13],i[8]=s[2],i[9]=s[6],i[10]=s[10],i[11]=s[14],i[12]=s[3],i[13]=s[7],i[14]=s[11],i[15]=s[15],t.markAsUpdated(),t._updateIdentityStatus(e._isIdentity,e._isIdentityDirty)}static Reflection(e){const t=new L;return L.ReflectionToRef(e,t),t}static ReflectionToRef(e,t){e.normalize();const i=e.normal.x,s=e.normal.y,r=e.normal.z,n=-2*i,o=-2*s,l=-2*r;L.FromValuesToRef(n*i+1,o*i,l*i,0,n*s,o*s+1,l*s,0,n*r,o*r,l*r+1,0,n*e.d,o*e.d,l*e.d,1,t)}static FromXYZAxesToRef(e,t,i,s){L.FromValuesToRef(e._x,e._y,e._z,0,t._x,t._y,t._z,0,i._x,i._y,i._z,0,0,0,0,1,s)}static FromQuaternionToRef(e,t){const i=e._x*e._x,s=e._y*e._y,r=e._z*e._z,n=e._x*e._y,o=e._z*e._w,l=e._z*e._x,h=e._y*e._w,c=e._y*e._z,u=e._x*e._w;t._m[0]=1-2*(s+r),t._m[1]=2*(n+o),t._m[2]=2*(l-h),t._m[3]=0,t._m[4]=2*(n-o),t._m[5]=1-2*(r+i),t._m[6]=2*(c+u),t._m[7]=0,t._m[8]=2*(l+h),t._m[9]=2*(c-u),t._m[10]=1-2*(s+i),t._m[11]=0,t._m[12]=0,t._m[13]=0,t._m[14]=0,t._m[15]=1,t.markAsUpdated()}}L._UpdateFlagSeed=0;L._IdentityReadOnly=L.Identity();class we{}we.Vector3=gi.BuildTuple(11,g.Zero);we.Matrix=gi.BuildTuple(2,L.Identity);we.Quaternion=gi.BuildTuple(3,Q.Zero);class G{}G.Vector2=gi.BuildTuple(3,le.Zero);G.Vector3=gi.BuildTuple(13,g.Zero);G.Vector4=gi.BuildTuple(3,Ge.Zero);G.Quaternion=gi.BuildTuple(2,Q.Zero);G.Matrix=gi.BuildTuple(8,L.Identity);he("BABYLON.Vector2",le);he("BABYLON.Vector3",g);he("BABYLON.Vector4",Ge);he("BABYLON.Matrix",L);const Rn=L.FromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);var Ze;(function(a){a[a.LOCAL=0]="LOCAL",a[a.WORLD=1]="WORLD",a[a.BONE=2]="BONE"})(Ze||(Ze={}));class ti{}ti.X=new g(1,0,0);ti.Y=new g(0,1,0);ti.Z=new g(0,0,1);var va;(function(a){a[a.X=0]="X",a[a.Y=1]="Y",a[a.Z=2]="Z"})(va||(va={}));class re{constructor(e=0,t=0,i=0){this.r=e,this.g=t,this.b=i}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+"}"}getClassName(){return"Color3"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,this}fromArray(e,t=0){return re.FromArrayToRef(e,t,this),this}toColor4(e=1){return new J(this.r,this.g,this.b,e)}asArray(){return[this.r,this.g,this.b]}toLuminance(){return this.r*.3+this.g*.59+this.b*.11}multiply(e){return new re(this.r*e.r,this.g*e.g,this.b*e.b)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b}equalsFloats(e,t,i){return this.r===e&&this.g===t&&this.b===i}scale(e){return new re(this.r*e,this.g*e,this.b*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,this}clampToRef(e=0,t=1,i){return i.r=oe.Clamp(this.r,e,t),i.g=oe.Clamp(this.g,e,t),i.b=oe.Clamp(this.b,e,t),this}add(e){return new re(this.r+e.r,this.g+e.g,this.b+e.b)}addToRef(e,t){return t.r=this.r+e.r,t.g=this.g+e.g,t.b=this.b+e.b,this}subtract(e){return new re(this.r-e.r,this.g-e.g,this.b-e.b)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,this}clone(){return new re(this.r,this.g,this.b)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copyFromFloats(e,t,i){return this.r=e,this.g=t,this.b=i,this}set(e,t,i){return this.copyFromFloats(e,t,i)}toHexString(){const e=Math.round(this.r*255),t=Math.round(this.g*255),i=Math.round(this.b*255);return"#"+oe.ToHex(e)+oe.ToHex(t)+oe.ToHex(i)}toLinearSpace(){const e=new re;return this.toLinearSpaceToRef(e),e}toHSV(){const e=new re;return this.toHSVToRef(e),e}toHSVToRef(e){const t=this.r,i=this.g,s=this.b,r=Math.max(t,i,s),n=Math.min(t,i,s);let o=0,l=0;const h=r,c=r-n;r!==0&&(l=c/r),r!=n&&(r==t?(o=(i-s)/c,i<s&&(o+=6)):r==i?o=(s-t)/c+2:r==s&&(o=(t-i)/c+4),o*=60),e.r=o,e.g=l,e.b=h}toLinearSpaceToRef(e){return e.r=Math.pow(this.r,gn),e.g=Math.pow(this.g,gn),e.b=Math.pow(this.b,gn),this}toGammaSpace(){const e=new re;return this.toGammaSpaceToRef(e),e}toGammaSpaceToRef(e){return e.r=Math.pow(this.r,Wr),e.g=Math.pow(this.g,Wr),e.b=Math.pow(this.b,Wr),this}static HSVtoRGBToRef(e,t,i,s){const r=i*t,n=e/60,o=r*(1-Math.abs(n%2-1));let l=0,h=0,c=0;n>=0&&n<=1?(l=r,h=o):n>=1&&n<=2?(l=o,h=r):n>=2&&n<=3?(h=r,c=o):n>=3&&n<=4?(h=o,c=r):n>=4&&n<=5?(l=o,c=r):n>=5&&n<=6&&(l=r,c=o);const u=i-r;s.set(l+u,h+u,c+u)}static FromHSV(e,t,i){const s=new re(0,0,0);return re.HSVtoRGBToRef(e,t,i,s),s}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==7)return new re(0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16);return re.FromInts(t,i,s)}static FromArray(e,t=0){return new re(e[t],e[t+1],e[t+2])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2]}static FromInts(e,t,i){return new re(e/255,t/255,i/255)}static Lerp(e,t,i){const s=new re(0,0,0);return re.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,l=2*o-3*n+1,h=-2*o+3*n,c=o-2*n+r,u=o-n,d=e.r*l+i.r*h+t.r*c+s.r*u,f=e.g*l+i.g*h+t.g*c+s.g*u,p=e.b*l+i.b*h+t.b*c+s.b*u;return new re(d,f,p)}static Hermite1stDerivative(e,t,i,s,r){const n=re.Black();return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.r=(o-r)*6*e.r+(3*o-4*r+1)*t.r+(-o+r)*6*i.r+(3*o-2*r)*s.r,n.g=(o-r)*6*e.g+(3*o-4*r+1)*t.g+(-o+r)*6*i.g+(3*o-2*r)*s.g,n.b=(o-r)*6*e.b+(3*o-4*r+1)*t.b+(-o+r)*6*i.b+(3*o-2*r)*s.b}static Red(){return new re(1,0,0)}static Green(){return new re(0,1,0)}static Blue(){return new re(0,0,1)}static Black(){return new re(0,0,0)}static get BlackReadOnly(){return re._BlackReadOnly}static White(){return new re(1,1,1)}static Purple(){return new re(.5,0,.5)}static Magenta(){return new re(1,0,1)}static Yellow(){return new re(1,1,0)}static Gray(){return new re(.5,.5,.5)}static Teal(){return new re(0,1,1)}static Random(){return new re(Math.random(),Math.random(),Math.random())}}re._BlackReadOnly=re.Black();class J{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}addInPlace(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this.a+=e.a,this}asArray(){return[this.r,this.g,this.b,this.a]}toArray(e,t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e[t+3]=this.a,this}fromArray(e,t=0){return J.FromArrayToRef(e,t,this),this}equals(e){return e&&this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}add(e){return new J(this.r+e.r,this.g+e.g,this.b+e.b,this.a+e.a)}subtract(e){return new J(this.r-e.r,this.g-e.g,this.b-e.b,this.a-e.a)}subtractToRef(e,t){return t.r=this.r-e.r,t.g=this.g-e.g,t.b=this.b-e.b,t.a=this.a-e.a,this}scale(e){return new J(this.r*e,this.g*e,this.b*e,this.a*e)}scaleInPlace(e){return this.r*=e,this.g*=e,this.b*=e,this.a*=e,this}scaleToRef(e,t){return t.r=this.r*e,t.g=this.g*e,t.b=this.b*e,t.a=this.a*e,this}scaleAndAddToRef(e,t){return t.r+=this.r*e,t.g+=this.g*e,t.b+=this.b*e,t.a+=this.a*e,this}clampToRef(e=0,t=1,i){return i.r=oe.Clamp(this.r,e,t),i.g=oe.Clamp(this.g,e,t),i.b=oe.Clamp(this.b,e,t),i.a=oe.Clamp(this.a,e,t),this}multiply(e){return new J(this.r*e.r,this.g*e.g,this.b*e.b,this.a*e.a)}multiplyToRef(e,t){return t.r=this.r*e.r,t.g=this.g*e.g,t.b=this.b*e.b,t.a=this.a*e.a,t}toString(){return"{R: "+this.r+" G:"+this.g+" B:"+this.b+" A:"+this.a+"}"}getClassName(){return"Color4"}getHashCode(){let e=this.r*255|0;return e=e*397^(this.g*255|0),e=e*397^(this.b*255|0),e=e*397^(this.a*255|0),e}clone(){return new J(this.r,this.g,this.b,this.a)}copyFrom(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}copyFromFloats(e,t,i,s){return this.r=e,this.g=t,this.b=i,this.a=s,this}set(e,t,i,s){return this.copyFromFloats(e,t,i,s)}toHexString(e=!1){const t=Math.round(this.r*255),i=Math.round(this.g*255),s=Math.round(this.b*255);if(e)return"#"+oe.ToHex(t)+oe.ToHex(i)+oe.ToHex(s);const r=Math.round(this.a*255);return"#"+oe.ToHex(t)+oe.ToHex(i)+oe.ToHex(s)+oe.ToHex(r)}toLinearSpace(){const e=new J;return this.toLinearSpaceToRef(e),e}toLinearSpaceToRef(e){return e.r=Math.pow(this.r,gn),e.g=Math.pow(this.g,gn),e.b=Math.pow(this.b,gn),e.a=this.a,this}toGammaSpace(){const e=new J;return this.toGammaSpaceToRef(e),e}toGammaSpaceToRef(e){return e.r=Math.pow(this.r,Wr),e.g=Math.pow(this.g,Wr),e.b=Math.pow(this.b,Wr),e.a=this.a,this}static FromHexString(e){if(e.substring(0,1)!=="#"||e.length!==9&&e.length!==7)return new J(0,0,0,0);const t=parseInt(e.substring(1,3),16),i=parseInt(e.substring(3,5),16),s=parseInt(e.substring(5,7),16),r=e.length===9?parseInt(e.substring(7,9),16):255;return J.FromInts(t,i,s,r)}static Lerp(e,t,i){const s=new J(0,0,0,0);return J.LerpToRef(e,t,i,s),s}static LerpToRef(e,t,i,s){s.r=e.r+(t.r-e.r)*i,s.g=e.g+(t.g-e.g)*i,s.b=e.b+(t.b-e.b)*i,s.a=e.a+(t.a-e.a)*i}static Hermite(e,t,i,s,r){const n=r*r,o=r*n,l=2*o-3*n+1,h=-2*o+3*n,c=o-2*n+r,u=o-n,d=e.r*l+i.r*h+t.r*c+s.r*u,f=e.g*l+i.g*h+t.g*c+s.g*u,p=e.b*l+i.b*h+t.b*c+s.b*u,_=e.a*l+i.a*h+t.a*c+s.a*u;return new J(d,f,p,_)}static Hermite1stDerivative(e,t,i,s,r){const n=new J;return this.Hermite1stDerivativeToRef(e,t,i,s,r,n),n}static Hermite1stDerivativeToRef(e,t,i,s,r,n){const o=r*r;n.r=(o-r)*6*e.r+(3*o-4*r+1)*t.r+(-o+r)*6*i.r+(3*o-2*r)*s.r,n.g=(o-r)*6*e.g+(3*o-4*r+1)*t.g+(-o+r)*6*i.g+(3*o-2*r)*s.g,n.b=(o-r)*6*e.b+(3*o-4*r+1)*t.b+(-o+r)*6*i.b+(3*o-2*r)*s.b,n.a=(o-r)*6*e.a+(3*o-4*r+1)*t.a+(-o+r)*6*i.a+(3*o-2*r)*s.a}static FromColor3(e,t=1){return new J(e.r,e.g,e.b,t)}static FromArray(e,t=0){return new J(e[t],e[t+1],e[t+2],e[t+3])}static FromArrayToRef(e,t=0,i){i.r=e[t],i.g=e[t+1],i.b=e[t+2],i.a=e[t+3]}static FromInts(e,t,i,s){return new J(e/255,t/255,i/255,s/255)}static CheckColors4(e,t){if(e.length===t*3){const i=[];for(let s=0;s<e.length;s+=3){const r=s/3*4;i[r]=e[s],i[r+1]=e[s+1],i[r+2]=e[s+2],i[r+3]=1}return i}return e}}class ht{}ht.Color3=gi.BuildArray(3,re.Black);ht.Color4=gi.BuildArray(3,()=>new J(0,0,0,0));he("BABYLON.Color3",re);he("BABYLON.Color4",J);class Hi{constructor(e,t,i,s){this.normal=new g(e,t,i),this.d=s}asArray(){return[this.normal.x,this.normal.y,this.normal.z,this.d]}clone(){return new Hi(this.normal.x,this.normal.y,this.normal.z,this.d)}getClassName(){return"Plane"}getHashCode(){let e=this.normal.getHashCode();return e=e*397^(this.d|0),e}normalize(){const e=Math.sqrt(this.normal.x*this.normal.x+this.normal.y*this.normal.y+this.normal.z*this.normal.z);let t=0;return e!==0&&(t=1/e),this.normal.x*=t,this.normal.y*=t,this.normal.z*=t,this.d*=t,this}transform(e){const t=Hi._TmpMatrix;e.invertToRef(t);const i=t.m,s=this.normal.x,r=this.normal.y,n=this.normal.z,o=this.d,l=s*i[0]+r*i[1]+n*i[2]+o*i[3],h=s*i[4]+r*i[5]+n*i[6]+o*i[7],c=s*i[8]+r*i[9]+n*i[10]+o*i[11],u=s*i[12]+r*i[13]+n*i[14]+o*i[15];return new Hi(l,h,c,u)}dotCoordinate(e){return this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z+this.d}copyFromPoints(e,t,i){const s=t.x-e.x,r=t.y-e.y,n=t.z-e.z,o=i.x-e.x,l=i.y-e.y,h=i.z-e.z,c=r*h-n*l,u=n*o-s*h,d=s*l-r*o,f=Math.sqrt(c*c+u*u+d*d);let p;return f!==0?p=1/f:p=0,this.normal.x=c*p,this.normal.y=u*p,this.normal.z=d*p,this.d=-(this.normal.x*e.x+this.normal.y*e.y+this.normal.z*e.z),this}isFrontFacingTo(e,t){return g.Dot(this.normal,e)<=t}signedDistanceTo(e){return g.Dot(e,this.normal)+this.d}static FromArray(e){return new Hi(e[0],e[1],e[2],e[3])}static FromPoints(e,t,i){const s=new Hi(0,0,0,0);return s.copyFromPoints(e,t,i),s}static FromPositionAndNormal(e,t){const i=new Hi(0,0,0,0);return t.normalize(),i.normal=t,i.d=-(t.x*e.x+t.y*e.y+t.z*e.z),i}static SignedDistanceToPlaneFromPositionAndNormal(e,t,i){const s=-(t.x*e.x+t.y*e.y+t.z*e.z);return g.Dot(i,t)+s}}Hi._TmpMatrix=L.Identity();class $s{static GetPlanes(e){const t=[];for(let i=0;i<6;i++)t.push(new Hi(0,0,0,0));return $s.GetPlanesToRef(e,t),t}static GetNearPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[2],t.normal.y=i[7]+i[6],t.normal.z=i[11]+i[10],t.d=i[15]+i[14],t.normalize()}static GetFarPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[2],t.normal.y=i[7]-i[6],t.normal.z=i[11]-i[10],t.d=i[15]-i[14],t.normalize()}static GetLeftPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[0],t.normal.y=i[7]+i[4],t.normal.z=i[11]+i[8],t.d=i[15]+i[12],t.normalize()}static GetRightPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[0],t.normal.y=i[7]-i[4],t.normal.z=i[11]-i[8],t.d=i[15]-i[12],t.normalize()}static GetTopPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]-i[1],t.normal.y=i[7]-i[5],t.normal.z=i[11]-i[9],t.d=i[15]-i[13],t.normalize()}static GetBottomPlaneToRef(e,t){const i=e.m;t.normal.x=i[3]+i[1],t.normal.y=i[7]+i[5],t.normal.z=i[11]+i[9],t.d=i[15]+i[13],t.normalize()}static GetPlanesToRef(e,t){$s.GetNearPlaneToRef(e,t[0]),$s.GetFarPlaneToRef(e,t[1]),$s.GetLeftPlaneToRef(e,t[2]),$s.GetRightPlaneToRef(e,t[3]),$s.GetTopPlaneToRef(e,t[4]),$s.GetBottomPlaneToRef(e,t[5])}}var go;(function(a){a[a.CW=0]="CW",a[a.CCW=1]="CCW"})(go||(go={}));class Un{constructor(e){this._radians=e,this._radians<0&&(this._radians+=2*Math.PI)}degrees(){return this._radians*180/Math.PI}radians(){return this._radians}static BetweenTwoPoints(e,t){const i=t.subtract(e),s=Math.atan2(i.y,i.x);return new Un(s)}static FromRadians(e){return new Un(e)}static FromDegrees(e){return new Un(e*Math.PI/180)}}class ov{constructor(e,t,i){this.startPoint=e,this.midPoint=t,this.endPoint=i;const s=Math.pow(t.x,2)+Math.pow(t.y,2),r=(Math.pow(e.x,2)+Math.pow(e.y,2)-s)/2,n=(s-Math.pow(i.x,2)-Math.pow(i.y,2))/2,o=(e.x-t.x)*(t.y-i.y)-(t.x-i.x)*(e.y-t.y);this.centerPoint=new le((r*(t.y-i.y)-n*(e.y-t.y))/o,((e.x-t.x)*n-(t.x-i.x)*r)/o),this.radius=this.centerPoint.subtract(this.startPoint).length(),this.startAngle=Un.BetweenTwoPoints(this.centerPoint,this.startPoint);const l=this.startAngle.degrees();let h=Un.BetweenTwoPoints(this.centerPoint,this.midPoint).degrees(),c=Un.BetweenTwoPoints(this.centerPoint,this.endPoint).degrees();h-l>180&&(h-=360),h-l<-180&&(h+=360),c-h>180&&(c-=360),c-h<-180&&(c+=360),this.orientation=h-l<0?go.CW:go.CCW,this.angle=Un.FromDegrees(this.orientation===go.CW?l-c:c-l)}}class Cd{constructor(e,t){this._points=new Array,this._length=0,this.closed=!1,this._points.push(new le(e,t))}addLineTo(e,t){if(this.closed)return this;const i=new le(e,t),s=this._points[this._points.length-1];return this._points.push(i),this._length+=i.subtract(s).length(),this}addArcTo(e,t,i,s,r=36){if(this.closed)return this;const n=this._points[this._points.length-1],o=new le(e,t),l=new le(i,s),h=new ov(n,o,l);let c=h.angle.radians()/r;h.orientation===go.CW&&(c*=-1);let u=h.startAngle.radians()+c;for(let d=0;d<r;d++){const f=Math.cos(u)*h.radius+h.centerPoint.x,p=Math.sin(u)*h.radius+h.centerPoint.y;this.addLineTo(f,p),u+=c}return this}close(){return this.closed=!0,this}length(){let e=this._length;if(this.closed){const t=this._points[this._points.length-1];e+=this._points[0].subtract(t).length()}return e}getPoints(){return this._points}getPointAtLengthPosition(e){if(e<0||e>1)return le.Zero();const t=e*this.length();let i=0;for(let s=0;s<this._points.length;s++){const r=(s+1)%this._points.length,n=this._points[s],l=this._points[r].subtract(n),h=l.length()+i;if(t>=i&&t<=h){const c=l.normalize(),u=t-i;return new le(n.x+c.x*u,n.y+c.y*u)}i=h}return le.Zero()}static StartingAt(e,t){return new Cd(e,t)}}class Al{constructor(e,t=null,i,s=!1){this.path=e,this._curve=new Array,this._distances=new Array,this._tangents=new Array,this._normals=new Array,this._binormals=new Array,this._pointAtData={id:0,point:g.Zero(),previousPointArrayIndex:0,position:0,subPosition:0,interpolateReady:!1,interpolationMatrix:L.Identity()};for(let r=0;r<e.length;r++)this._curve[r]=e[r].clone();this._raw=i||!1,this._alignTangentsWithPath=s,this._compute(t,s)}getCurve(){return this._curve}getPoints(){return this._curve}length(){return this._distances[this._distances.length-1]}getTangents(){return this._tangents}getNormals(){return this._normals}getBinormals(){return this._binormals}getDistances(){return this._distances}getPointAt(e){return this._updatePointAtData(e).point}getTangentAt(e,t=!1){return this._updatePointAtData(e,t),t?g.TransformCoordinates(g.Forward(),this._pointAtData.interpolationMatrix):this._tangents[this._pointAtData.previousPointArrayIndex]}getNormalAt(e,t=!1){return this._updatePointAtData(e,t),t?g.TransformCoordinates(g.Right(),this._pointAtData.interpolationMatrix):this._normals[this._pointAtData.previousPointArrayIndex]}getBinormalAt(e,t=!1){return this._updatePointAtData(e,t),t?g.TransformCoordinates(g.UpReadOnly,this._pointAtData.interpolationMatrix):this._binormals[this._pointAtData.previousPointArrayIndex]}getDistanceAt(e){return this.length()*e}getPreviousPointIndexAt(e){return this._updatePointAtData(e),this._pointAtData.previousPointArrayIndex}getSubPositionAt(e){return this._updatePointAtData(e),this._pointAtData.subPosition}getClosestPositionTo(e){let t=Number.MAX_VALUE,i=0;for(let s=0;s<this._curve.length-1;s++){const r=this._curve[s+0],n=this._curve[s+1].subtract(r).normalize(),o=this._distances[s+1]-this._distances[s+0],l=Math.min(Math.max(g.Dot(n,e.subtract(r).normalize()),0)*g.Distance(r,e)/o,1),h=g.Distance(r.add(n.scale(l*o)),e);h<t&&(t=h,i=(this._distances[s+0]+o*l)/this.length())}return i}slice(e=0,t=1){if(e<0&&(e=1-e*-1%1),t<0&&(t=1-t*-1%1),e>t){const h=e;e=t,t=h}const i=this.getCurve(),s=this.getPointAt(e);let r=this.getPreviousPointIndexAt(e);const n=this.getPointAt(t),o=this.getPreviousPointIndexAt(t)+1,l=[];return e!==0&&(r++,l.push(s)),l.push(...i.slice(r,o)),(t!==1||e===1)&&l.push(n),new Al(l,this.getNormalAt(e),this._raw,this._alignTangentsWithPath)}update(e,t=null,i=!1){for(let s=0;s<e.length;s++)this._curve[s].x=e[s].x,this._curve[s].y=e[s].y,this._curve[s].z=e[s].z;return this._compute(t,i),this}_compute(e,t=!1){const i=this._curve.length;if(i<2)return;this._tangents[0]=this._getFirstNonNullVector(0),this._raw||this._tangents[0].normalize(),this._tangents[i-1]=this._curve[i-1].subtract(this._curve[i-2]),this._raw||this._tangents[i-1].normalize();const s=this._tangents[0],r=this._normalVector(s,e);this._normals[0]=r,this._raw||this._normals[0].normalize(),this._binormals[0]=g.Cross(s,this._normals[0]),this._raw||this._binormals[0].normalize(),this._distances[0]=0;let n,o,l,h,c;for(let u=1;u<i;u++)n=this._getLastNonNullVector(u),u<i-1&&(o=this._getFirstNonNullVector(u),this._tangents[u]=t?o:n.add(o),this._tangents[u].normalize()),this._distances[u]=this._distances[u-1]+this._curve[u].subtract(this._curve[u-1]).length(),l=this._tangents[u],c=this._binormals[u-1],this._normals[u]=g.Cross(c,l),this._raw||(this._normals[u].length()===0?(h=this._normals[u-1],this._normals[u]=h.clone()):this._normals[u].normalize()),this._binormals[u]=g.Cross(l,this._normals[u]),this._raw||this._binormals[u].normalize();this._pointAtData.id=NaN}_getFirstNonNullVector(e){let t=1,i=this._curve[e+t].subtract(this._curve[e]);for(;i.length()===0&&e+t+1<this._curve.length;)t++,i=this._curve[e+t].subtract(this._curve[e]);return i}_getLastNonNullVector(e){let t=1,i=this._curve[e].subtract(this._curve[e-t]);for(;i.length()===0&&e>t+1;)t++,i=this._curve[e].subtract(this._curve[e-t]);return i}_normalVector(e,t){let i,s=e.length();if(s===0&&(s=1),t==null){let r;oe.WithinEpsilon(Math.abs(e.y)/s,1,tt)?oe.WithinEpsilon(Math.abs(e.x)/s,1,tt)?oe.WithinEpsilon(Math.abs(e.z)/s,1,tt)?r=g.Zero():r=new g(0,0,1):r=new g(1,0,0):r=new g(0,-1,0),i=g.Cross(e,r)}else i=g.Cross(e,t),g.CrossToRef(i,e,i);return i.normalize(),i}_updatePointAtData(e,t=!1){if(this._pointAtData.id===e)return this._pointAtData.interpolateReady||this._updateInterpolationMatrix(),this._pointAtData;this._pointAtData.id=e;const i=this.getPoints();if(e<=0)return this._setPointAtData(0,0,i[0],0,t);if(e>=1)return this._setPointAtData(1,1,i[i.length-1],i.length-1,t);let s=i[0],r,n=0;const o=e*this.length();for(let l=1;l<i.length;l++){r=i[l];const h=g.Distance(s,r);if(n+=h,n===o)return this._setPointAtData(e,1,r,l,t);if(n>o){const u=(n-o)/h,d=s.subtract(r),f=r.add(d.scaleInPlace(u));return this._setPointAtData(e,1-u,f,l-1,t)}s=r}return this._pointAtData}_setPointAtData(e,t,i,s,r){return this._pointAtData.point=i,this._pointAtData.position=e,this._pointAtData.subPosition=t,this._pointAtData.previousPointArrayIndex=s,this._pointAtData.interpolateReady=r,r&&this._updateInterpolationMatrix(),this._pointAtData}_updateInterpolationMatrix(){this._pointAtData.interpolationMatrix=L.Identity();const e=this._pointAtData.previousPointArrayIndex;if(e!==this._tangents.length-1){const t=e+1,i=this._tangents[e].clone(),s=this._normals[e].clone(),r=this._binormals[e].clone(),n=this._tangents[t].clone(),o=this._normals[t].clone(),l=this._binormals[t].clone(),h=Q.RotationQuaternionFromAxis(s,r,i),c=Q.RotationQuaternionFromAxis(o,l,n);Q.Slerp(h,c,this._pointAtData.subPosition).toRotationMatrix(this._pointAtData.interpolationMatrix)}}}class hn{constructor(e){this._length=0,this._points=e,this._length=this._computeLength(e)}static CreateQuadraticBezier(e,t,i,s){s=s>2?s:3;const r=new Array,n=(o,l,h,c)=>(1-o)*(1-o)*l+2*o*(1-o)*h+o*o*c;for(let o=0;o<=s;o++)r.push(new g(n(o/s,e.x,t.x,i.x),n(o/s,e.y,t.y,i.y),n(o/s,e.z,t.z,i.z)));return new hn(r)}static CreateCubicBezier(e,t,i,s,r){r=r>3?r:4;const n=new Array,o=(l,h,c,u,d)=>(1-l)*(1-l)*(1-l)*h+3*l*(1-l)*(1-l)*c+3*l*l*(1-l)*u+l*l*l*d;for(let l=0;l<=r;l++)n.push(new g(o(l/r,e.x,t.x,i.x,s.x),o(l/r,e.y,t.y,i.y,s.y),o(l/r,e.z,t.z,i.z,s.z)));return new hn(n)}static CreateHermiteSpline(e,t,i,s,r){const n=new Array,o=1/r;for(let l=0;l<=r;l++)n.push(g.Hermite(e,t,i,s,l*o));return new hn(n)}static CreateCatmullRomSpline(e,t,i){const s=new Array,r=1/t;let n=0;if(i){const o=e.length;for(let l=0;l<o;l++){n=0;for(let h=0;h<t;h++)s.push(g.CatmullRom(e[l%o],e[(l+1)%o],e[(l+2)%o],e[(l+3)%o],n)),n+=r}s.push(s[0])}else{const o=new Array;o.push(e[0].clone()),Array.prototype.push.apply(o,e),o.push(e[e.length-1].clone());let l=0;for(;l<o.length-3;l++){n=0;for(let h=0;h<t;h++)s.push(g.CatmullRom(o[l],o[l+1],o[l+2],o[l+3],n)),n+=r}l--,s.push(g.CatmullRom(o[l],o[l+1],o[l+2],o[l+3],n))}return new hn(s)}static ArcThru3Points(e,t,i,s=32,r=!1,n=!1){const o=new Array,l=t.subtract(e),h=i.subtract(t),c=e.subtract(i),u=g.Cross(l,h),d=u.length();if(d<Math.pow(10,-8))return new hn(o);const f=l.lengthSquared(),p=h.lengthSquared(),_=c.lengthSquared(),m=u.lengthSquared(),v=l.length(),x=h.length(),b=c.length(),S=.5*v*x*b/d,C=g.Dot(l,c),E=g.Dot(l,h),A=g.Dot(h,c),M=-.5*p*C/m,D=-.5*_*E/m,P=-.5*f*A/m,O=e.scale(M).add(t.scale(D)).add(i.scale(P)),$=e.subtract(O).normalize(),W=g.Cross(u,$).normalize();if(n){const K=2*Math.PI/s;for(let te=0;te<=2*Math.PI;te+=K)o.push(O.add($.scale(S*Math.cos(te)).add(W.scale(S*Math.sin(te)))));o.push(e)}else{const K=1/s;let te=0,ve=g.Zero();do ve=O.add($.scale(S*Math.cos(te)).add(W.scale(S*Math.sin(te)))),o.push(ve),te+=K;while(!ve.equalsWithEpsilon(i,S*K*1.1));o.push(i),r&&o.push(e)}return new hn(o)}getPoints(){return this._points}length(){return this._length}continue(e){const t=this._points[this._points.length-1],i=this._points.slice(),s=e.getPoints();for(let n=1;n<s.length;n++)i.push(s[n].subtract(s[0]).add(t));return new hn(i)}_computeLength(e){let t=0;for(let i=1;i<e.length;i++)t+=e[i].subtract(e[i-1]).length();return t}}class js{constructor(e,t){this.width=e,this.height=t}toString(){return`{W: ${this.width}, H: ${this.height}}`}getClassName(){return"Size"}getHashCode(){let e=this.width|0;return e=e*397^(this.height|0),e}copyFrom(e){this.width=e.width,this.height=e.height}copyFromFloats(e,t){return this.width=e,this.height=t,this}set(e,t){return this.copyFromFloats(e,t)}multiplyByFloats(e,t){return new js(this.width*e,this.height*t)}clone(){return new js(this.width,this.height)}equals(e){return e?this.width===e.width&&this.height===e.height:!1}get surface(){return this.width*this.height}static Zero(){return new js(0,0)}add(e){return new js(this.width+e.width,this.height+e.height)}subtract(e){return new js(this.width-e.width,this.height-e.height)}static Lerp(e,t,i){const s=e.width+(t.width-e.width)*i,r=e.height+(t.height-e.height)*i;return new js(s,r)}}class Uh{constructor(e=g.Zero(),t=g.Up(),i=le.Zero()){this.position=e,this.normal=t,this.uv=i}clone(){return new Uh(this.position.clone(),this.normal.clone(),this.uv.clone())}}class Es{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}toGlobal(e,t){return new Es(this.x*e,this.y*t,this.width*e,this.height*t)}toGlobalToRef(e,t,i){return i.x=this.x*e,i.y=this.y*t,i.width=this.width*e,i.height=this.height*t,this}clone(){return new Es(this.x,this.y,this.width,this.height)}}var H0;(function(a){a.SRGB="srgb"})(H0||(H0={}));var X0;(function(a){a.LowPower="low-power",a.HighPerformance="high-performance"})(X0||(X0={}));var xa;(function(a){a.DepthClipControl="depth-clip-control",a.Depth24UnormStencil8="depth24unorm-stencil8",a.Depth32FloatStencil8="depth32float-stencil8",a.TextureCompressionBC="texture-compression-bc",a.TextureCompressionETC2="texture-compression-etc2",a.TextureCompressionASTC="texture-compression-astc",a.TimestampQuery="timestamp-query",a.IndirectFirstInstance="indirect-first-instance",a.ShaderF16="shader-f16",a.BGRA8UnormStorage="bgra8unorm-storage"})(xa||(xa={}));var Dt;(function(a){a[a.MapRead=1]="MapRead",a[a.MapWrite=2]="MapWrite",a[a.CopySrc=4]="CopySrc",a[a.CopyDst=8]="CopyDst",a[a.Index=16]="Index",a[a.Vertex=32]="Vertex",a[a.Uniform=64]="Uniform",a[a.Storage=128]="Storage",a[a.Indirect=256]="Indirect",a[a.QueryResolve=512]="QueryResolve"})(Dt||(Dt={}));var Aa;(function(a){a[a.Read=1]="Read",a[a.Write=2]="Write"})(Aa||(Aa={}));var Vn;(function(a){a.E1d="1d",a.E2d="2d",a.E3d="3d"})(Vn||(Vn={}));var Ft;(function(a){a[a.CopySrc=1]="CopySrc",a[a.CopyDst=2]="CopyDst",a[a.TextureBinding=4]="TextureBinding",a[a.StorageBinding=8]="StorageBinding",a[a.RenderAttachment=16]="RenderAttachment"})(Ft||(Ft={}));var Mt;(function(a){a.E1d="1d",a.E2d="2d",a.E2dArray="2d-array",a.Cube="cube",a.CubeArray="cube-array",a.E3d="3d"})(Mt||(Mt={}));var _n;(function(a){a.All="all",a.StencilOnly="stencil-only",a.DepthOnly="depth-only"})(_n||(_n={}));var w;(function(a){a.R8Unorm="r8unorm",a.R8Snorm="r8snorm",a.R8Uint="r8uint",a.R8Sint="r8sint",a.R16Uint="r16uint",a.R16Sint="r16sint",a.R16Float="r16float",a.RG8Unorm="rg8unorm",a.RG8Snorm="rg8snorm",a.RG8Uint="rg8uint",a.RG8Sint="rg8sint",a.R32Uint="r32uint",a.R32Sint="r32sint",a.R32Float="r32float",a.RG16Uint="rg16uint",a.RG16Sint="rg16sint",a.RG16Float="rg16float",a.RGBA8Unorm="rgba8unorm",a.RGBA8UnormSRGB="rgba8unorm-srgb",a.RGBA8Snorm="rgba8snorm",a.RGBA8Uint="rgba8uint",a.RGBA8Sint="rgba8sint",a.BGRA8Unorm="bgra8unorm",a.BGRA8UnormSRGB="bgra8unorm-srgb",a.RGB9E5UFloat="rgb9e5ufloat",a.RGB10A2Unorm="rgb10a2unorm",a.RG11B10UFloat="rg11b10ufloat",a.RG32Uint="rg32uint",a.RG32Sint="rg32sint",a.RG32Float="rg32float",a.RGBA16Uint="rgba16uint",a.RGBA16Sint="rgba16sint",a.RGBA16Float="rgba16float",a.RGBA32Uint="rgba32uint",a.RGBA32Sint="rgba32sint",a.RGBA32Float="rgba32float",a.Stencil8="stencil8",a.Depth16Unorm="depth16unorm",a.Depth24Plus="depth24plus",a.Depth24PlusStencil8="depth24plus-stencil8",a.Depth32Float="depth32float",a.BC1RGBAUnorm="bc1-rgba-unorm",a.BC1RGBAUnormSRGB="bc1-rgba-unorm-srgb",a.BC2RGBAUnorm="bc2-rgba-unorm",a.BC2RGBAUnormSRGB="bc2-rgba-unorm-srgb",a.BC3RGBAUnorm="bc3-rgba-unorm",a.BC3RGBAUnormSRGB="bc3-rgba-unorm-srgb",a.BC4RUnorm="bc4-r-unorm",a.BC4RSnorm="bc4-r-snorm",a.BC5RGUnorm="bc5-rg-unorm",a.BC5RGSnorm="bc5-rg-snorm",a.BC6HRGBUFloat="bc6h-rgb-ufloat",a.BC6HRGBFloat="bc6h-rgb-float",a.BC7RGBAUnorm="bc7-rgba-unorm",a.BC7RGBAUnormSRGB="bc7-rgba-unorm-srgb",a.ETC2RGB8Unorm="etc2-rgb8unorm",a.ETC2RGB8UnormSRGB="etc2-rgb8unorm-srgb",a.ETC2RGB8A1Unorm="etc2-rgb8a1unorm",a.ETC2RGB8A1UnormSRGB="etc2-rgb8a1unorm-srgb",a.ETC2RGBA8Unorm="etc2-rgba8unorm",a.ETC2RGBA8UnormSRGB="etc2-rgba8unorm-srgb",a.EACR11Unorm="eac-r11unorm",a.EACR11Snorm="eac-r11snorm",a.EACRG11Unorm="eac-rg11unorm",a.EACRG11Snorm="eac-rg11snorm",a.ASTC4x4Unorm="astc-4x4-unorm",a.ASTC4x4UnormSRGB="astc-4x4-unorm-srgb",a.ASTC5x4Unorm="astc-5x4-unorm",a.ASTC5x4UnormSRGB="astc-5x4-unorm-srgb",a.ASTC5x5Unorm="astc-5x5-unorm",a.ASTC5x5UnormSRGB="astc-5x5-unorm-srgb",a.ASTC6x5Unorm="astc-6x5-unorm",a.ASTC6x5UnormSRGB="astc-6x5-unorm-srgb",a.ASTC6x6Unorm="astc-6x6-unorm",a.ASTC6x6UnormSRGB="astc-6x6-unorm-srgb",a.ASTC8x5Unorm="astc-8x5-unorm",a.ASTC8x5UnormSRGB="astc-8x5-unorm-srgb",a.ASTC8x6Unorm="astc-8x6-unorm",a.ASTC8x6UnormSRGB="astc-8x6-unorm-srgb",a.ASTC8x8Unorm="astc-8x8-unorm",a.ASTC8x8UnormSRGB="astc-8x8-unorm-srgb",a.ASTC10x5Unorm="astc-10x5-unorm",a.ASTC10x5UnormSRGB="astc-10x5-unorm-srgb",a.ASTC10x6Unorm="astc-10x6-unorm",a.ASTC10x6UnormSRGB="astc-10x6-unorm-srgb",a.ASTC10x8Unorm="astc-10x8-unorm",a.ASTC10x8UnormSRGB="astc-10x8-unorm-srgb",a.ASTC10x10Unorm="astc-10x10-unorm",a.ASTC10x10UnormSRGB="astc-10x10-unorm-srgb",a.ASTC12x10Unorm="astc-12x10-unorm",a.ASTC12x10UnormSRGB="astc-12x10-unorm-srgb",a.ASTC12x12Unorm="astc-12x12-unorm",a.ASTC12x12UnormSRGB="astc-12x12-unorm-srgb",a.Depth24UnormStencil8="depth24unorm-stencil8",a.Depth32FloatStencil8="depth32float-stencil8"})(w||(w={}));var lo;(function(a){a.ClampToEdge="clamp-to-edge",a.Repeat="repeat",a.MirrorRepeat="mirror-repeat"})(lo||(lo={}));var st;(function(a){a.Nearest="nearest",a.Linear="linear"})(st||(st={}));var Li;(function(a){a.Never="never",a.Less="less",a.Equal="equal",a.LessEqual="less-equal",a.Greater="greater",a.NotEqual="not-equal",a.GreaterEqual="greater-equal",a.Always="always"})(Li||(Li={}));var Dn;(function(a){a[a.Vertex=1]="Vertex",a[a.Fragment=2]="Fragment",a[a.Compute=4]="Compute"})(Dn||(Dn={}));var Wn;(function(a){a.Uniform="uniform",a.Storage="storage",a.ReadOnlyStorage="read-only-storage"})(Wn||(Wn={}));var jn;(function(a){a.Filtering="filtering",a.NonFiltering="non-filtering",a.Comparison="comparison"})(jn||(jn={}));var Gs;(function(a){a.Float="float",a.UnfilterableFloat="unfilterable-float",a.Depth="depth",a.Sint="sint",a.Uint="uint"})(Gs||(Gs={}));var ju;(function(a){a.WriteOnly="write-only"})(ju||(ju={}));var Y0;(function(a){a.Error="error",a.Warning="warning",a.Info="info"})(Y0||(Y0={}));var Vh;(function(a){a.Auto="auto"})(Vh||(Vh={}));var Ys;(function(a){a.PointList="point-list",a.LineList="line-list",a.LineStrip="line-strip",a.TriangleList="triangle-list",a.TriangleStrip="triangle-strip"})(Ys||(Ys={}));var kh;(function(a){a.CCW="ccw",a.CW="cw"})(kh||(kh={}));var nl;(function(a){a.None="none",a.Front="front",a.Back="back"})(nl||(nl={}));var K0;(function(a){a[a.Red=1]="Red",a[a.Green=2]="Green",a[a.Blue=4]="Blue",a[a.Alpha=8]="Alpha",a[a.All=15]="All"})(K0||(K0={}));var rs;(function(a){a.Zero="zero",a.One="one",a.Src="src",a.OneMinusSrc="one-minus-src",a.SrcAlpha="src-alpha",a.OneMinusSrcAlpha="one-minus-src-alpha",a.Dst="dst",a.OneMinusDst="one-minus-dst",a.DstAlpha="dst-alpha",a.OneMinusDstAlpha="one-minus-dst-alpha",a.SrcAlphaSaturated="src-alpha-saturated",a.Constant="constant",a.OneMinusConstant="one-minus-constant"})(rs||(rs={}));var On;(function(a){a.Add="add",a.Subtract="subtract",a.ReverseSubtract="reverse-subtract",a.Min="min",a.Max="max"})(On||(On={}));var Er;(function(a){a.Keep="keep",a.Zero="zero",a.Replace="replace",a.Invert="invert",a.IncrementClamp="increment-clamp",a.DecrementClamp="decrement-clamp",a.IncrementWrap="increment-wrap",a.DecrementWrap="decrement-wrap"})(Er||(Er={}));var Fa;(function(a){a.Uint16="uint16",a.Uint32="uint32"})(Fa||(Fa={}));var zt;(function(a){a.Uint8x2="uint8x2",a.Uint8x4="uint8x4",a.Sint8x2="sint8x2",a.Sint8x4="sint8x4",a.Unorm8x2="unorm8x2",a.Unorm8x4="unorm8x4",a.Snorm8x2="snorm8x2",a.Snorm8x4="snorm8x4",a.Uint16x2="uint16x2",a.Uint16x4="uint16x4",a.Sint16x2="sint16x2",a.Sint16x4="sint16x4",a.Unorm16x2="unorm16x2",a.Unorm16x4="unorm16x4",a.Snorm16x2="snorm16x2",a.Snorm16x4="snorm16x4",a.Float16x2="float16x2",a.Float16x4="float16x4",a.Float32="float32",a.Float32x2="float32x2",a.Float32x3="float32x3",a.Float32x4="float32x4",a.Uint32="uint32",a.Uint32x2="uint32x2",a.Uint32x3="uint32x3",a.Uint32x4="uint32x4",a.Sint32="sint32",a.Sint32x2="sint32x2",a.Sint32x3="sint32x3",a.Sint32x4="sint32x4"})(zt||(zt={}));var Gh;(function(a){a.Vertex="vertex",a.Instance="instance"})(Gh||(Gh={}));var $0;(function(a){a.Beginning="beginning",a.End="end"})($0||($0={}));var j0;(function(a){a.Beginning="beginning",a.End="end"})(j0||(j0={}));var Ci;(function(a){a.Load="load",a.Clear="clear"})(Ci||(Ci={}));var dr;(function(a){a.Store="store",a.Discard="discard"})(dr||(dr={}));var zh;(function(a){a.Occlusion="occlusion",a.Timestamp="timestamp"})(zh||(zh={}));var Wh;(function(a){a.Opaque="opaque",a.Premultiplied="premultiplied"})(Wh||(Wh={}));var q0;(function(a){a.Destroyed="destroyed"})(q0||(q0={}));var Q0;(function(a){a.OutOfMemory="out-of-memory",a.Validation="validation"})(Q0||(Q0={}));class Hr{constructor(e,t,i,s=0,r=!1,n=!1,o=!1,l){this._isAlreadyOwned=!1,e.getScene?this._engine=e.getScene().getEngine():this._engine=e,this._updatable=i,this._instanced=n,this._divisor=l||1,t instanceof Ga?(this._data=null,this._buffer=t):(this._data=t,this._buffer=null),this.byteStride=o?s:s*Float32Array.BYTES_PER_ELEMENT,r||this.create()}createVertexBuffer(e,t,i,s,r,n=!1,o){const l=n?t:t*Float32Array.BYTES_PER_ELEMENT,h=s?n?s:s*Float32Array.BYTES_PER_ELEMENT:this.byteStride;return new y(this._engine,this,e,this._updatable,!0,h,r===void 0?this._instanced:r,l,i,void 0,void 0,!0,this._divisor||o)}isUpdatable(){return this._updatable}getData(){return this._data}getBuffer(){return this._buffer}getStrideSize(){return this.byteStride/Float32Array.BYTES_PER_ELEMENT}create(e=null){!e&&this._buffer||(e=e||this._data,e&&(this._buffer?this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e),this._data=e):this._updatable?(this._buffer=this._engine.createDynamicVertexBuffer(e),this._data=e):this._buffer=this._engine.createVertexBuffer(e)))}_rebuild(){this._buffer=null,this.create(this._data)}update(e){this.create(e)}updateDirectly(e,t,i,s=!1){!this._buffer||this._updatable&&(this._engine.updateDynamicVertexBuffer(this._buffer,e,s?t:t*Float32Array.BYTES_PER_ELEMENT,i?i*this.byteStride:void 0),t===0&&i===void 0?this._data=e:this._data=null)}_increaseReferences(){if(!!this._buffer){if(!this._isAlreadyOwned){this._isAlreadyOwned=!0;return}this._buffer.references++}}dispose(){!this._buffer||this._engine._releaseBuffer(this._buffer)&&(this._buffer=null,this._data=null)}}class y{constructor(e,t,i,s,r,n,o,l,h,c,u=!1,d=!1,f=1,p=!1){if(t instanceof Hr?(this._buffer=t,this._ownsBuffer=p):(this._buffer=new Hr(e,t,s,n,r,o,d),this._ownsBuffer=!0),this.uniqueId=y._Counter++,this._kind=i,c==null){const m=this.getData();this.type=y.FLOAT,m instanceof Int8Array?this.type=y.BYTE:m instanceof Uint8Array?this.type=y.UNSIGNED_BYTE:m instanceof Int16Array?this.type=y.SHORT:m instanceof Uint16Array?this.type=y.UNSIGNED_SHORT:m instanceof Int32Array?this.type=y.INT:m instanceof Uint32Array&&(this.type=y.UNSIGNED_INT)}else this.type=c;const _=y.GetTypeByteLength(this.type);d?(this._size=h||(n?n/_:y.DeduceStride(i)),this.byteStride=n||this._buffer.byteStride||this._size*_,this.byteOffset=l||0):(this._size=h||n||y.DeduceStride(i),this.byteStride=n?n*_:this._buffer.byteStride||this._size*_,this.byteOffset=(l||0)*_),this.normalized=u,this._instanced=o!==void 0?o:!1,this._instanceDivisor=o?f:0,this._computeHashCode()}get instanceDivisor(){return this._instanceDivisor}set instanceDivisor(e){const t=e!=0;this._instanceDivisor=e,t!==this._instanced&&(this._instanced=t,this._computeHashCode())}_computeHashCode(){this.hashCode=(this.type-5120<<0)+((this.normalized?1:0)<<3)+(this._size<<4)+((this._instanced?1:0)<<6)+(this.byteStride<<12)}_rebuild(){!this._buffer||this._buffer._rebuild()}getKind(){return this._kind}isUpdatable(){return this._buffer.isUpdatable()}getData(){return this._buffer.getData()}getFloatData(e,t){const i=this.getData();if(!i)return null;const s=this.getSize()*y.GetTypeByteLength(this.type),r=e*this.getSize();if(this.type!==y.FLOAT||this.byteStride!==s){const n=new Float32Array(r);return this.forEach(r,(o,l)=>n[l]=o),n}if(!(i instanceof Array||i instanceof Float32Array)||this.byteOffset!==0||i.length!==r)if(i instanceof Array){const n=this.byteOffset/4;return i.slice(n,n+r)}else{if(i instanceof ArrayBuffer)return new Float32Array(i,this.byteOffset,r);{let n=i.byteOffset+this.byteOffset;if(t){const l=new Float32Array(r),h=new Float32Array(i.buffer,n,r);return l.set(h),l}const o=n%4;return o&&(n=Math.max(0,n-o)),new Float32Array(i.buffer,n,r)}}return t?i.slice():i}getBuffer(){return this._buffer.getBuffer()}getStrideSize(){return this.byteStride/y.GetTypeByteLength(this.type)}getOffset(){return this.byteOffset/y.GetTypeByteLength(this.type)}getSize(e=!1){return e?this._size*y.GetTypeByteLength(this.type):this._size}getIsInstanced(){return this._instanced}getInstanceDivisor(){return this._instanceDivisor}create(e){this._buffer.create(e)}update(e){this._buffer.update(e)}updateDirectly(e,t,i=!1){this._buffer.updateDirectly(e,t,void 0,i)}dispose(){this._ownsBuffer&&this._buffer.dispose()}forEach(e,t){y.ForEach(this._buffer.getData(),this.byteOffset,this.byteStride,this._size,this.type,e,this.normalized,t)}static DeduceStride(e){switch(e){case y.UVKind:case y.UV2Kind:case y.UV3Kind:case y.UV4Kind:case y.UV5Kind:case y.UV6Kind:return 2;case y.NormalKind:case y.PositionKind:return 3;case y.ColorKind:case y.MatricesIndicesKind:case y.MatricesIndicesExtraKind:case y.MatricesWeightsKind:case y.MatricesWeightsExtraKind:case y.TangentKind:return 4;default:throw new Error("Invalid kind '"+e+"'")}}static GetTypeByteLength(e){switch(e){case y.BYTE:case y.UNSIGNED_BYTE:return 1;case y.SHORT:case y.UNSIGNED_SHORT:return 2;case y.INT:case y.UNSIGNED_INT:case y.FLOAT:return 4;default:throw new Error(`Invalid type '${e}'`)}}static ForEach(e,t,i,s,r,n,o,l){if(e instanceof Array){let h=t/4;const c=i/4;for(let u=0;u<n;u+=s){for(let d=0;d<s;d++)l(e[h+d],u+d);h+=c}}else{const h=e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),c=y.GetTypeByteLength(r);for(let u=0;u<n;u+=s){let d=t;for(let f=0;f<s;f++){const p=y._GetFloatValue(h,r,d,o);l(p,u+f),d+=c}t+=i}}}static _GetFloatValue(e,t,i,s){switch(t){case y.BYTE:{let r=e.getInt8(i);return s&&(r=Math.max(r/127,-1)),r}case y.UNSIGNED_BYTE:{let r=e.getUint8(i);return s&&(r=r/255),r}case y.SHORT:{let r=e.getInt16(i,!0);return s&&(r=Math.max(r/32767,-1)),r}case y.UNSIGNED_SHORT:{let r=e.getUint16(i,!0);return s&&(r=r/65535),r}case y.INT:return e.getInt32(i,!0);case y.UNSIGNED_INT:return e.getUint32(i,!0);case y.FLOAT:return e.getFloat32(i,!0);default:throw new Error(`Invalid component type ${t}`)}}}y._Counter=0;y.BYTE=5120;y.UNSIGNED_BYTE=5121;y.SHORT=5122;y.UNSIGNED_SHORT=5123;y.INT=5124;y.UNSIGNED_INT=5125;y.FLOAT=5126;y.PositionKind="position";y.NormalKind="normal";y.TangentKind="tangent";y.UVKind="uv";y.UV2Kind="uv2";y.UV3Kind="uv3";y.UV4Kind="uv4";y.UV5Kind="uv5";y.UV6Kind="uv6";y.ColorKind="color";y.ColorInstanceKind="instanceColor";y.MatricesIndicesKind="matricesIndices";y.MatricesWeightsKind="matricesWeights";y.MatricesIndicesExtraKind="matricesIndicesExtra";y.MatricesWeightsExtraKind="matricesWeightsExtra";const Z0=(a,e)=>!a||a.getClassName&&a.getClassName()==="Mesh"?null:a.getClassName&&a.getClassName()==="SubMesh"?a.clone(e):a.clone?a.clone():null;function lv(a){const e=[];do Object.getOwnPropertyNames(a).forEach(function(t){e.indexOf(t)===-1&&e.push(t)});while(a=Object.getPrototypeOf(a));return e}class ys{static DeepCopy(e,t,i,s){const r=lv(e);for(const n of r){if(n[0]==="_"&&(!s||s.indexOf(n)===-1)||n.endsWith("Observable")||i&&i.indexOf(n)!==-1)continue;const o=e[n],l=typeof o;if(l!=="function")try{if(l==="object")if(o instanceof Array){if(t[n]=[],o.length>0)if(typeof o[0]=="object")for(let h=0;h<o.length;h++){const c=Z0(o[h],t);t[n].indexOf(c)===-1&&t[n].push(c)}else t[n]=o.slice(0)}else t[n]=Z0(o,t);else t[n]=o}catch(h){B.Warn(h.message)}}}}function hv(){return typeof _native<"u"&&_native.XMLHttpRequest?new _native.XMLHttpRequest:new XMLHttpRequest}class Ui{constructor(){this._xhr=hv(),this._requestURL=""}_injectCustomRequestHeaders(){if(!this._shouldSkipRequestModifications(this._requestURL))for(const e in Ui.CustomRequestHeaders){const t=Ui.CustomRequestHeaders[e];t&&this._xhr.setRequestHeader(e,t)}}_shouldSkipRequestModifications(e){return Ui.SkipRequestModificationForBabylonCDN&&(e.includes("preview.babylonjs.com")||e.includes("cdn.babylonjs.com"))}get onprogress(){return this._xhr.onprogress}set onprogress(e){this._xhr.onprogress=e}get readyState(){return this._xhr.readyState}get status(){return this._xhr.status}get statusText(){return this._xhr.statusText}get response(){return this._xhr.response}get responseURL(){return this._xhr.responseURL}get responseText(){return this._xhr.responseText}get responseType(){return this._xhr.responseType}set responseType(e){this._xhr.responseType=e}get timeout(){return this._xhr.timeout}set timeout(e){this._xhr.timeout=e}addEventListener(e,t,i){this._xhr.addEventListener(e,t,i)}removeEventListener(e,t,i){this._xhr.removeEventListener(e,t,i)}abort(){this._xhr.abort()}send(e){Ui.CustomRequestHeaders&&this._injectCustomRequestHeaders(),this._xhr.send(e)}open(e,t){for(const i of Ui.CustomRequestModifiers){if(this._shouldSkipRequestModifications(t))return;i(this._xhr,t)}return t=t.replace("file:http:","http:"),t=t.replace("file:https:","https:"),this._requestURL=t,this._xhr.open(e,t,!0)}setRequestHeader(e,t){this._xhr.setRequestHeader(e,t)}getResponseHeader(e){return this._xhr.getResponseHeader(e)}}Ui.CustomRequestHeaders={};Ui.CustomRequestModifiers=new Array;Ui.SkipRequestModificationForBabylonCDN=!0;class al{}al.FilesToLoad={};class cv{static ExponentialBackoff(e=3,t=500){return(i,s,r)=>s.status!==0||r>=e||i.indexOf("file:")!==-1?-1:Math.pow(2,r)*t}}class Co extends Error{}Co._setPrototypeOf=Object.setPrototypeOf||((a,e)=>(a.__proto__=e,a));const Hn={MeshInvalidPositionsError:0,UnsupportedTextureError:1e3,GLTFLoaderUnexpectedMagicError:2e3,SceneLoaderError:3e3,LoadFileError:4e3,RequestFileError:4001,ReadFileError:4002};class Xr extends Co{constructor(e,t,i){super(e),this.errorCode=t,this.innerError=i,this.name="RuntimeError",Co._setPrototypeOf(this,Xr.prototype)}}const n_=a=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",i,s,r,n,o,l,h,c=0;const u=ArrayBuffer.isView(a)?new Uint8Array(a.buffer,a.byteOffset,a.byteLength):new Uint8Array(a);for(;c<u.length;)i=u[c++],s=c<u.length?u[c++]:Number.NaN,r=c<u.length?u[c++]:Number.NaN,n=i>>2,o=(i&3)<<4|s>>4,l=(s&15)<<2|r>>6,h=r&63,isNaN(s)?l=h=64:isNaN(r)&&(h=64),t+=e.charAt(n)+e.charAt(o)+e.charAt(l)+e.charAt(h);return t},a_=a=>atob(a),uv=a=>{const e=a_(a),t=e.length,i=new Uint8Array(new ArrayBuffer(t));for(let s=0;s<t;s++)i[s]=e.charCodeAt(s);return i.buffer};class yo{static SetImmediate(e){Ht()&&window.setImmediate?window.setImmediate(e):setTimeout(e,1)}}const o_=new RegExp(/^data:([^,]+\/[^,]+)?;base64,/i);class Hh extends Xr{constructor(e,t){super(e,Hn.LoadFileError),this.name="LoadFileError",Co._setPrototypeOf(this,Hh.prototype),t instanceof Ui?this.request=t:this.file=t}}class Xh extends Xr{constructor(e,t){super(e,Hn.RequestFileError),this.request=t,this.name="RequestFileError",Co._setPrototypeOf(this,Xh.prototype)}}class yd extends Xr{constructor(e,t){super(e,Hn.ReadFileError),this.file=t,this.name="ReadFileError",Co._setPrototypeOf(this,yd.prototype)}}const qi={DefaultRetryStrategy:cv.ExponentialBackoff(),BaseUrl:"",CorsBehavior:"anonymous",PreprocessUrl:a=>a},l_=a=>(a=a.replace(/#/gm,"%23"),a),Ad=(a,e)=>{if(!(a&&a.indexOf("data:")===0)&&qi.CorsBehavior)if(typeof qi.CorsBehavior=="string"||qi.CorsBehavior instanceof String)e.crossOrigin=qi.CorsBehavior;else{const t=qi.CorsBehavior(a);t&&(e.crossOrigin=t)}},Wl=(a,e,t,i,s="",r)=>{var n;let o,l=!1;a instanceof ArrayBuffer||ArrayBuffer.isView(a)?typeof Blob<"u"&&typeof URL<"u"?(o=URL.createObjectURL(new Blob([a],{type:s})),l=!0):o=`data:${s};base64,`+n_(a):a instanceof Blob?(o=URL.createObjectURL(a),l=!0):(o=l_(a),o=qi.PreprocessUrl(a));const h=ye.LastCreatedEngine,c=E=>{if(t){const A=o||a.toString();t(`Error while trying to load image: ${A.indexOf("http")===0||A.length<=128?A:A.slice(0,128)+"..."}`,E)}};if(typeof Image>"u"||((n=h==null?void 0:h._features.forceBitmapOverHTMLImageElement)!==null&&n!==void 0?n:!1))return qn(o,E=>{h.createImageBitmap(new Blob([E],{type:s}),{premultiplyAlpha:"none",...r}).then(A=>{e(A),l&&URL.revokeObjectURL(o)}).catch(A=>{t&&t("Error while trying to load image: "+a,A)})},void 0,i||void 0,!0,(E,A)=>{c(A)}),null;const u=new Image;Ad(o,u);const d=[],f=()=>{d.forEach(E=>{E.target.addEventListener(E.name,E.handler)})},p=()=>{d.forEach(E=>{E.target.removeEventListener(E.name,E.handler)}),d.length=0},_=()=>{p(),e(u),l&&u.src&&URL.revokeObjectURL(u.src)},m=E=>{p(),c(E),l&&u.src&&URL.revokeObjectURL(u.src)},v=E=>{p();const A=new Error(`CSP violation of policy ${E.effectiveDirective} ${E.blockedURI}. Current policy is ${E.originalPolicy}`);ye.UseFallbackTexture=!1,c(A),l&&u.src&&URL.revokeObjectURL(u.src),u.src=""};d.push({target:u,name:"load",handler:_}),d.push({target:u,name:"error",handler:m}),d.push({target:document,name:"securitypolicyviolation",handler:v}),f();const x=o.substring(0,5)==="blob:",b=o.substring(0,5)==="data:",S=()=>{x||b?u.src=o:qn(o,(E,A,M)=>{const D=!s&&M?M:s,P=new Blob([E],{type:D}),O=URL.createObjectURL(P);l=!0,u.src=O},void 0,i||void 0,!0,(E,A)=>{c(A)})},C=()=>{i&&i.loadImage(o,u)};if(!x&&!b&&i&&i.enableTexturesOffline)i.open(C,S);else{if(o.indexOf("file:")!==-1){const E=decodeURIComponent(o.substring(5).toLowerCase());if(al.FilesToLoad[E]&&typeof URL<"u"){try{let A;try{A=URL.createObjectURL(al.FilesToLoad[E])}catch{A=URL.createObjectURL(al.FilesToLoad[E])}u.src=A,l=!0}catch{u.src=""}return u}}S()}return u},Rl=(a,e,t,i,s)=>{const r=new FileReader,n={onCompleteObservable:new X,abort:()=>r.abort()};return r.onloadend=()=>n.onCompleteObservable.notifyObservers(n),s&&(r.onerror=()=>{s(new yd(`Unable to read ${a.name}`,a))}),r.onload=o=>{e(o.target.result)},t&&(r.onprogress=t),i?r.readAsArrayBuffer(a):r.readAsText(a),n},qn=(a,e,t,i,s,r,n)=>{if(a.name)return Rl(a,e,t,s,r?c=>{r(void 0,c)}:void 0);const o=a;if(o.indexOf("file:")!==-1){let c=decodeURIComponent(o.substring(5).toLowerCase());c.indexOf("./")===0&&(c=c.substring(2));const u=al.FilesToLoad[c];if(u)return Rl(u,e,t,s,r?d=>r(void 0,new Hh(d.message,d.file)):void 0)}const{match:l,type:h}=dv(o);if(l){const c={onCompleteObservable:new X,abort:()=>()=>{}};try{const u=s?Pd(o):c_(o);e(u,void 0,h)}catch(u){r?r(void 0,u):B.Error(u.message||"Failed to parse the Data URL")}return yo.SetImmediate(()=>{c.onCompleteObservable.notifyObservers(c)}),c}return Rd(o,(c,u)=>{e(c,u==null?void 0:u.responseURL,u==null?void 0:u.getResponseHeader("content-type"))},t,i,s,r?c=>{r(c.request,new Hh(c.message,c.request))}:void 0,n)},Rd=(a,e,t,i,s,r,n)=>{a=l_(a),a=qi.PreprocessUrl(a);const o=qi.BaseUrl+a;let l=!1;const h={onCompleteObservable:new X,abort:()=>l=!0},c=()=>{let u=new Ui,d=null,f;const p=()=>{!u||(t&&u.removeEventListener("progress",t),f&&u.removeEventListener("readystatechange",f),u.removeEventListener("loadend",_))};let _=()=>{p(),h.onCompleteObservable.notifyObservers(h),h.onCompleteObservable.clear(),t=void 0,f=null,_=null,r=void 0,n=void 0,e=void 0};h.abort=()=>{l=!0,_&&_(),u&&u.readyState!==(XMLHttpRequest.DONE||4)&&u.abort(),d!==null&&(clearTimeout(d),d=null),u=null};const m=x=>{const b=x.message||"Unknown error";r&&u?r(new Xh(b,u)):B.Error(b)},v=x=>{if(!!u){if(u.open("GET",o),n)try{n(u)}catch(b){m(b);return}s&&(u.responseType="arraybuffer"),t&&u.addEventListener("progress",t),_&&u.addEventListener("loadend",_),f=()=>{if(!(l||!u)&&u.readyState===(XMLHttpRequest.DONE||4)){if(f&&u.removeEventListener("readystatechange",f),u.status>=200&&u.status<300||u.status===0&&(!Ht()||h_())){try{e&&e(s?u.response:u.responseText,u)}catch(C){m(C)}return}const b=qi.DefaultRetryStrategy;if(b){const C=b(o,u,x);if(C!==-1){p(),u=new Ui,d=setTimeout(()=>v(x+1),C);return}}const S=new Xh("Error status: "+u.status+" "+u.statusText+" - Unable to load "+o,u);r&&r(S)}},u.addEventListener("readystatechange",f),u.send()}};v(0)};if(i&&i.enableSceneOffline){const u=f=>{f&&f.status>400?r&&r(f):c()},d=()=>{i&&i.loadFile(qi.BaseUrl+a,f=>{!l&&e&&e(f),h.onCompleteObservable.notifyObservers(h)},t?f=>{!l&&t&&t(f)}:void 0,u,s)};i.open(d,u)}else c();return h},h_=()=>typeof location<"u"&&location.protocol==="file:",Id=a=>o_.test(a),dv=a=>{const e=o_.exec(a);if(e===null||e.length===0)return{match:!1,type:""};{const t=e[0].replace("data:","").replace("base64,","");return{match:!0,type:t}}};function Pd(a){return uv(a.split(",")[1])}const c_=a=>a_(a.split(",")[1]),fv=()=>{Te._FileToolsLoadImage=Wl,Te._FileToolsLoadFile=qn,kr._FileToolsLoadFile=qn};fv();let Jo;const pv=(a,e,t,i,s,r,n,o,l,h)=>{Jo={DecodeBase64UrlToBinary:a,DecodeBase64UrlToString:e,DefaultRetryStrategy:t.DefaultRetryStrategy,BaseUrl:t.BaseUrl,CorsBehavior:t.CorsBehavior,PreprocessUrl:t.PreprocessUrl,IsBase64DataUrl:i,IsFileURL:s,LoadFile:r,LoadImage:n,ReadFile:o,RequestFile:l,SetCorsBehavior:h},Object.defineProperty(Jo,"DefaultRetryStrategy",{get:function(){return t.DefaultRetryStrategy},set:function(c){t.DefaultRetryStrategy=c}}),Object.defineProperty(Jo,"BaseUrl",{get:function(){return t.BaseUrl},set:function(c){t.BaseUrl=c}}),Object.defineProperty(Jo,"PreprocessUrl",{get:function(){return t.PreprocessUrl},set:function(c){t.PreprocessUrl=c}}),Object.defineProperty(Jo,"CorsBehavior",{get:function(){return t.CorsBehavior},set:function(c){t.CorsBehavior=c}})};pv(Pd,c_,qi,Id,h_,qn,Wl,Rl,Rd,Ad);class ol{static Instantiate(e){if(this.RegisteredExternalClasses&&this.RegisteredExternalClasses[e])return this.RegisteredExternalClasses[e];const t=Si(e);if(t)return t;B.Warn(e+" not found, you may have missed an import.");const i=e.split(".");let s=window||this;for(let r=0,n=i.length;r<n;r++)s=s[i[r]];return typeof s!="function"?null:s}}ol.RegisteredExternalClasses={};function Md(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const e=Math.random()*16|0;return(a==="x"?e:e&3|8).toString(16)})}class q{static get BaseUrl(){return qi.BaseUrl}static set BaseUrl(e){qi.BaseUrl=e}static get DefaultRetryStrategy(){return qi.DefaultRetryStrategy}static set DefaultRetryStrategy(e){qi.DefaultRetryStrategy=e}static get CorsBehavior(){return qi.CorsBehavior}static set CorsBehavior(e){qi.CorsBehavior=e}static get UseFallbackTexture(){return ye.UseFallbackTexture}static set UseFallbackTexture(e){ye.UseFallbackTexture=e}static get RegisteredExternalClasses(){return ol.RegisteredExternalClasses}static set RegisteredExternalClasses(e){ol.RegisteredExternalClasses=e}static get fallbackTexture(){return ye.FallbackTexture}static set fallbackTexture(e){ye.FallbackTexture=e}static FetchToRef(e,t,i,s,r,n){const o=Math.abs(e)*i%i|0,l=Math.abs(t)*s%s|0,h=(o+l*i)*4;n.r=r[h]/255,n.g=r[h+1]/255,n.b=r[h+2]/255,n.a=r[h+3]/255}static Mix(e,t,i){return e*(1-i)+t*i}static Instantiate(e){return ol.Instantiate(e)}static SetImmediate(e){yo.SetImmediate(e)}static IsExponentOfTwo(e){let t=1;do t*=2;while(t<e);return t===e}static FloatRound(e){return Math.fround?Math.fround(e):(q._TmpFloatArray[0]=e,q._TmpFloatArray[0])}static GetFilename(e){const t=e.lastIndexOf("/");return t<0?e:e.substring(t+1)}static GetFolderPath(e,t=!1){const i=e.lastIndexOf("/");return i<0?t?e:"":e.substring(0,i+1)}static ToDegrees(e){return e*180/Math.PI}static ToRadians(e){return e*Math.PI/180}static SmoothAngleChange(e,t,i=.9){const s=this.ToRadians(e),r=this.ToRadians(t);return this.ToDegrees(Math.atan2((1-i)*Math.sin(r)+i*Math.sin(s),(1-i)*Math.cos(r)+i*Math.cos(s)))}static MakeArray(e,t){return t!==!0&&(e===void 0||e==null)?null:Array.isArray(e)?e:[e]}static GetPointerPrefix(e){let t="pointer";return Ht()&&!window.PointerEvent&&(t="mouse"),e._badDesktopOS&&!e._badOS&&!(document&&"ontouchend"in document)&&(t="mouse"),t}static SetCorsBehavior(e,t){Ad(e,t)}static SetReferrerPolicyBehavior(e,t){t.referrerPolicy=e}static CleanUrl(e){return e=e.replace(/#/gm,"%23"),e}static get PreprocessUrl(){return qi.PreprocessUrl}static set PreprocessUrl(e){qi.PreprocessUrl=e}static LoadImage(e,t,i,s,r,n){return Wl(e,t,i,s,r,n)}static LoadFile(e,t,i,s,r,n){return qn(e,t,i,s,r,n)}static LoadFileAsync(e,t=!0){return new Promise((i,s)=>{qn(e,r=>{i(r)},void 0,void 0,t,(r,n)=>{s(n)})})}static LoadScript(e,t,i,s){if(typeof importScripts=="function"){try{importScripts(e),t()}catch(o){i==null||i(`Unable to load script '${e}' in worker`,o)}return}else if(!Ht()){i==null||i(`Cannot load script '${e}' outside of a window or a worker`);return}const r=document.getElementsByTagName("head")[0],n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",e),s&&(n.id=s),n.onload=()=>{t&&t()},n.onerror=o=>{i&&i(`Unable to load script '${e}'`,o)},r.appendChild(n)}static LoadScriptAsync(e){return new Promise((t,i)=>{this.LoadScript(e,()=>{t()},(s,r)=>{i(r)})})}static ReadFileAsDataURL(e,t,i){const s=new FileReader,r={onCompleteObservable:new X,abort:()=>s.abort()};return s.onloadend=()=>{r.onCompleteObservable.notifyObservers(r)},s.onload=n=>{t(n.target.result)},s.onprogress=i,s.readAsDataURL(e),r}static ReadFile(e,t,i,s,r){return Rl(e,t,i,s,r)}static FileAsURL(e){const t=new Blob([e]);return window.URL.createObjectURL(t)}static Format(e,t=2){return e.toFixed(t)}static DeepCopy(e,t,i,s){ys.DeepCopy(e,t,i,s)}static IsEmpty(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}static RegisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.addEventListener(s.name,s.handler,!1);try{window.parent&&window.parent.addEventListener(s.name,s.handler,!1)}catch{}}}static UnregisterTopRootEvents(e,t){for(let i=0;i<t.length;i++){const s=t[i];e.removeEventListener(s.name,s.handler);try{e.parent&&e.parent.removeEventListener(s.name,s.handler)}catch{}}}static async DumpFramebuffer(e,t,i,s,r="image/png",n){const o=await i.readPixels(0,0,e,t),l=new Uint8Array(o.buffer);q.DumpData(e,t,l,s,r,n,!0)}static DumpData(e,t,i,s,r="image/png",n,o=!1,l=!1,h){q._ScreenshotCanvas||(q._ScreenshotCanvas=document.createElement("canvas")),q._ScreenshotCanvas.width=e,q._ScreenshotCanvas.height=t;const c=q._ScreenshotCanvas.getContext("2d");if(c){if(i instanceof Float32Array){const p=new Uint8Array(i.length);let _=i.length;for(;_--;){const m=i[_];p[_]=m<0?0:m>1?1:Math.round(m*255)}i=p}const u=c.createImageData(e,t);u.data.set(i),c.putImageData(u,0,0);let f=q._ScreenshotCanvas;if(o){const p=document.createElement("canvas");p.width=e,p.height=t;const _=p.getContext("2d");if(!_)return;_.translate(0,t),_.scale(1,-1),_.drawImage(q._ScreenshotCanvas,0,0),f=p}l?q.ToBlob(f,p=>{const _=new FileReader;_.onload=m=>{const v=m.target.result;s&&s(v)},_.readAsArrayBuffer(p)},r,h):q.EncodeScreenshotCanvasData(s,r,n,f,h)}}static DumpDataAsync(e,t,i,s="image/png",r,n=!1,o=!1,l){return new Promise(h=>{q.DumpData(e,t,i,c=>h(c),s,r,n,o,l)})}static ToBlob(e,t,i="image/png",s){e.toBlob||(e.toBlob=function(r,n,o){setTimeout(()=>{const l=atob(this.toDataURL(n,o).split(",")[1]),h=l.length,c=new Uint8Array(h);for(let u=0;u<h;u++)c[u]=l.charCodeAt(u);r(new Blob([c]))})}),e.toBlob(function(r){t(r)},i,s)}static DownloadBlob(e,t){if("download"in document.createElement("a")){if(!t){const i=new Date,s=(i.getFullYear()+"-"+(i.getMonth()+1)).slice(2)+"-"+i.getDate()+"_"+i.getHours()+"-"+("0"+i.getMinutes()).slice(-2);t="screenshot_"+s+".png"}q.Download(e,t)}else if(e&&typeof URL<"u"){const i=URL.createObjectURL(e),s=window.open("");if(!s)return;const r=s.document.createElement("img");r.onload=function(){URL.revokeObjectURL(i)},r.src=i,s.document.body.appendChild(r)}}static EncodeScreenshotCanvasData(e,t="image/png",i,s,r){if(e){const n=(s!=null?s:q._ScreenshotCanvas).toDataURL(t,r);e(n)}else this.ToBlob(s!=null?s:q._ScreenshotCanvas,function(n){n&&q.DownloadBlob(n,i)},t,r)}static Download(e,t){if(typeof URL>"u")return;const i=window.URL.createObjectURL(e),s=document.createElement("a");document.body.appendChild(s),s.style.display="none",s.href=i,s.download=t,s.addEventListener("click",()=>{s.parentElement&&s.parentElement.removeChild(s)}),s.click(),window.URL.revokeObjectURL(i)}static BackCompatCameraNoPreventDefault(e){return typeof e[0]=="boolean"?e[0]:typeof e[1]=="boolean"?e[1]:!1}static CreateScreenshot(e,t,i,s,r="image/png"){throw Ve("ScreenshotTools")}static CreateScreenshotAsync(e,t,i,s="image/png"){throw Ve("ScreenshotTools")}static CreateScreenshotUsingRenderTarget(e,t,i,s,r="image/png",n=1,o=!1,l){throw Ve("ScreenshotTools")}static CreateScreenshotUsingRenderTargetAsync(e,t,i,s="image/png",r=1,n=!1,o){throw Ve("ScreenshotTools")}static RandomId(){return Md()}static IsBase64(e){return Id(e)}static DecodeBase64(e){return Pd(e)}static get errorsCount(){return B.errorsCount}static Log(e){B.Log(e)}static Warn(e){B.Warn(e)}static Error(e){B.Error(e)}static get LogCache(){return B.LogCache}static ClearLogCache(){B.ClearLogCache()}static set LogLevels(e){B.LogLevels=e}static set PerformanceLogLevel(e){if((e&q.PerformanceUserMarkLogLevel)===q.PerformanceUserMarkLogLevel){q.StartPerformanceCounter=q._StartUserMark,q.EndPerformanceCounter=q._EndUserMark;return}if((e&q.PerformanceConsoleLogLevel)===q.PerformanceConsoleLogLevel){q.StartPerformanceCounter=q._StartPerformanceConsole,q.EndPerformanceCounter=q._EndPerformanceConsole;return}q.StartPerformanceCounter=q._StartPerformanceCounterDisabled,q.EndPerformanceCounter=q._EndPerformanceCounterDisabled}static _StartPerformanceCounterDisabled(e,t){}static _EndPerformanceCounterDisabled(e,t){}static _StartUserMark(e,t=!0){if(!q._Performance){if(!Ht())return;q._Performance=window.performance}!t||!q._Performance.mark||q._Performance.mark(e+"-Begin")}static _EndUserMark(e,t=!0){!t||!q._Performance.mark||(q._Performance.mark(e+"-End"),q._Performance.measure(e,e+"-Begin",e+"-End"))}static _StartPerformanceConsole(e,t=!0){!t||(q._StartUserMark(e,t),console.time&&console.time(e))}static _EndPerformanceConsole(e,t=!0){!t||(q._EndUserMark(e,t),console.timeEnd(e))}static get Now(){return ps.Now}static GetClassName(e,t=!1){let i=null;return!t&&e.getClassName?i=e.getClassName():(e instanceof Object&&(i=(t?e:Object.getPrototypeOf(e)).constructor.__bjsclassName__),i||(i=typeof e)),i}static First(e,t){for(const i of e)if(t(i))return i;return null}static getFullClassName(e,t=!1){let i=null,s=null;if(!t&&e.getClassName)i=e.getClassName();else{if(e instanceof Object){const r=t?e:Object.getPrototypeOf(e);i=r.constructor.__bjsclassName__,s=r.constructor.__bjsmoduleName__}i||(i=typeof e)}return i?(s!=null?s+".":"")+i:null}static DelayAsync(e){return new Promise(t=>{setTimeout(()=>{t()},e)})}static IsSafari(){return Jp()?/^((?!chrome|android).)*safari/i.test(navigator.userAgent):!1}}q.UseCustomRequestHeaders=!1;q.CustomRequestHeaders=Ui.CustomRequestHeaders;q._TmpFloatArray=new Float32Array(1);q.GetDOMTextContent=_c;q.GetAbsoluteUrl=typeof document=="object"?a=>{const e=document.createElement("a");return e.href=a,e.href}:typeof URL=="function"&&typeof location=="object"?a=>new URL(a,location.origin).href:()=>{throw new Error("Unable to get absolute URL. Override BABYLON.Tools.GetAbsoluteUrl to a custom implementation for the current context.")};q.NoneLogLevel=B.NoneLogLevel;q.MessageLogLevel=B.MessageLogLevel;q.WarningLogLevel=B.WarningLogLevel;q.ErrorLogLevel=B.ErrorLogLevel;q.AllLogLevel=B.AllLogLevel;q.IsWindowObjectExist=Ht;q.PerformanceNoneLogLevel=0;q.PerformanceUserMarkLogLevel=1;q.PerformanceConsoleLogLevel=2;q.StartPerformanceCounter=q._StartPerformanceCounterDisabled;q.EndPerformanceCounter=q._EndPerformanceCounterDisabled;class fr{constructor(e,t,i,s=0){this.iterations=e,this.index=s-1,this._done=!1,this._fn=t,this._successCallback=i}executeNext(){this._done||(this.index+1<this.iterations?(++this.index,this._fn(this)):this.breakLoop())}breakLoop(){this._done=!0,this._successCallback()}static Run(e,t,i,s=0){const r=new fr(e,t,i,s);return r.executeNext(),r}static SyncAsyncForLoop(e,t,i,s,r,n=0){return fr.Run(Math.ceil(e/t),o=>{r&&r()?o.breakLoop():setTimeout(()=>{for(let l=0;l<t;++l){const h=o.index*t+l;if(h>=e)break;if(i(h),r&&r()){o.breakLoop();break}}o.executeNext()},n)},s)}}ye.FallbackTexture="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBmRXhpZgAATU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAAExAAIAAAAQAAAATgAAAAAAAABgAAAAAQAAAGAAAAABcGFpbnQubmV0IDQuMC41AP/bAEMABAIDAwMCBAMDAwQEBAQFCQYFBQUFCwgIBgkNCw0NDQsMDA4QFBEODxMPDAwSGBITFRYXFxcOERkbGRYaFBYXFv/bAEMBBAQEBQUFCgYGChYPDA8WFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFv/AABEIAQABAAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/APH6KKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76CiiigD5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BQooooA+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/voKKKKAPl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FCiiigD6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++gooooA+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gUKKKKAPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76Pl+iiivuj+BT6gooor4U/vo+X6KKK+6P4FPqCiiivhT++j5fooor7o/gU+oKKKK+FP76P//Z";Te.prototype.createUniformBuffer=function(a){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create uniform buffer");const t=new yl(e);return this.bindUniformBuffer(t),a instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,a,this._gl.STATIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(a),this._gl.STATIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};Te.prototype.createDynamicUniformBuffer=function(a){const e=this._gl.createBuffer();if(!e)throw new Error("Unable to create dynamic uniform buffer");const t=new yl(e);return this.bindUniformBuffer(t),a instanceof Float32Array?this._gl.bufferData(this._gl.UNIFORM_BUFFER,a,this._gl.DYNAMIC_DRAW):this._gl.bufferData(this._gl.UNIFORM_BUFFER,new Float32Array(a),this._gl.DYNAMIC_DRAW),this.bindUniformBuffer(null),t.references=1,t};Te.prototype.updateUniformBuffer=function(a,e,t,i){this.bindUniformBuffer(a),t===void 0&&(t=0),i===void 0?e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,e):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,t,new Float32Array(e)):e instanceof Float32Array?this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,e.subarray(t,t+i)):this._gl.bufferSubData(this._gl.UNIFORM_BUFFER,0,new Float32Array(e).subarray(t,t+i)),this.bindUniformBuffer(null)};Te.prototype.bindUniformBuffer=function(a){this._gl.bindBuffer(this._gl.UNIFORM_BUFFER,a?a.underlyingResource:null)};Te.prototype.bindUniformBufferBase=function(a,e,t){this._gl.bindBufferBase(this._gl.UNIFORM_BUFFER,e,a?a.underlyingResource:null)};Te.prototype.bindUniformBlock=function(a,e,t){const i=a.program,s=this._gl.getUniformBlockIndex(i,e);s!==4294967295&&this._gl.uniformBlockBinding(i,s,t)};class Pe{constructor(e,t,i,s,r=!1){this._valueCache={},this._engine=e,this._noUBO=!e.supportsUniformBuffers||r,this._dynamic=i,this._name=s!=null?s:"no-name",this._data=t||[],this._uniformLocations={},this._uniformSizes={},this._uniformArraySizes={},this._uniformLocationPointer=0,this._needSync=!1,this._engine._features.trackUbosInFrame&&(this._buffers=[],this._bufferIndex=-1,this._createBufferOnWrite=!1,this._currentFrameId=0),this._noUBO?(this.updateMatrix3x3=this._updateMatrix3x3ForEffect,this.updateMatrix2x2=this._updateMatrix2x2ForEffect,this.updateFloat=this._updateFloatForEffect,this.updateFloat2=this._updateFloat2ForEffect,this.updateFloat3=this._updateFloat3ForEffect,this.updateFloat4=this._updateFloat4ForEffect,this.updateFloatArray=this._updateFloatArrayForEffect,this.updateArray=this._updateArrayForEffect,this.updateIntArray=this._updateIntArrayForEffect,this.updateMatrix=this._updateMatrixForEffect,this.updateMatrices=this._updateMatricesForEffect,this.updateVector3=this._updateVector3ForEffect,this.updateVector4=this._updateVector4ForEffect,this.updateColor3=this._updateColor3ForEffect,this.updateColor4=this._updateColor4ForEffect,this.updateDirectColor4=this._updateDirectColor4ForEffect,this.updateInt=this._updateIntForEffect,this.updateInt2=this._updateInt2ForEffect,this.updateInt3=this._updateInt3ForEffect,this.updateInt4=this._updateInt4ForEffect):(this._engine._uniformBuffers.push(this),this.updateMatrix3x3=this._updateMatrix3x3ForUniform,this.updateMatrix2x2=this._updateMatrix2x2ForUniform,this.updateFloat=this._updateFloatForUniform,this.updateFloat2=this._updateFloat2ForUniform,this.updateFloat3=this._updateFloat3ForUniform,this.updateFloat4=this._updateFloat4ForUniform,this.updateFloatArray=this._updateFloatArrayForUniform,this.updateArray=this._updateArrayForUniform,this.updateIntArray=this._updateIntArrayForUniform,this.updateMatrix=this._updateMatrixForUniform,this.updateMatrices=this._updateMatricesForUniform,this.updateVector3=this._updateVector3ForUniform,this.updateVector4=this._updateVector4ForUniform,this.updateColor3=this._updateColor3ForUniform,this.updateColor4=this._updateColor4ForUniform,this.updateDirectColor4=this._updateDirectColor4ForUniform,this.updateInt=this._updateIntForUniform,this.updateInt2=this._updateInt2ForUniform,this.updateInt3=this._updateInt3ForUniform,this.updateInt4=this._updateInt4ForUniform)}get useUbo(){return!this._noUBO}get isSync(){return!this._needSync}isDynamic(){return this._dynamic!==void 0}getData(){return this._bufferData}getBuffer(){return this._buffer}_fillAlignment(e){let t;if(e<=2?t=e:t=4,this._uniformLocationPointer%t!==0){const i=this._uniformLocationPointer;this._uniformLocationPointer+=t-this._uniformLocationPointer%t;const s=this._uniformLocationPointer-i;for(let r=0;r<s;r++)this._data.push(0)}}addUniform(e,t,i=0){if(this._noUBO||this._uniformLocations[e]!==void 0)return;let s;if(i>0){if(t instanceof Array)throw"addUniform should not be use with Array in UBO: "+e;if(this._fillAlignment(4),this._uniformArraySizes[e]={strideSize:t,arraySize:i},t==16)t=t*i;else{const n=(4-t)*i;t=t*i+n}s=[];for(let r=0;r<t;r++)s.push(0)}else{if(t instanceof Array)s=t,t=s.length;else{t=t,s=[];for(let r=0;r<t;r++)s.push(0)}this._fillAlignment(t)}this._uniformSizes[e]=t,this._uniformLocations[e]=this._uniformLocationPointer,this._uniformLocationPointer+=t;for(let r=0;r<t;r++)this._data.push(s[r]);this._needSync=!0}addMatrix(e,t){this.addUniform(e,Array.prototype.slice.call(t.toArray()))}addFloat2(e,t,i){const s=[t,i];this.addUniform(e,s)}addFloat3(e,t,i,s){const r=[t,i,s];this.addUniform(e,r)}addColor3(e,t){const i=[t.r,t.g,t.b];this.addUniform(e,i)}addColor4(e,t,i){const s=[t.r,t.g,t.b,i];this.addUniform(e,s)}addVector3(e,t){const i=[t.x,t.y,t.z];this.addUniform(e,i)}addMatrix3x3(e){this.addUniform(e,12)}addMatrix2x2(e){this.addUniform(e,8)}create(){this._noUBO||this._buffer||(this._fillAlignment(4),this._bufferData=new Float32Array(this._data),this._rebuild(),this._needSync=!0)}_rebuild(){this._noUBO||!this._bufferData||(this._dynamic?this._buffer=this._engine.createDynamicUniformBuffer(this._bufferData):this._buffer=this._engine.createUniformBuffer(this._bufferData),this._engine._features.trackUbosInFrame&&(this._buffers.push([this._buffer,this._engine._features.checkUbosContentBeforeUpload?this._bufferData.slice():void 0]),this._bufferIndex=this._buffers.length-1,this._createBufferOnWrite=!1))}get _numBuffers(){return this._buffers.length}get _indexBuffer(){return this._bufferIndex}get name(){return this._name}_buffersEqual(e,t){for(let i=0;i<e.length;++i)if(e[i]!==t[i])return!1;return!0}_copyBuffer(e,t){for(let i=0;i<e.length;++i)t[i]=e[i]}update(){if(!this._noUBO){if(this.bindUniformBuffer(),!this._buffer){this.create();return}if(!this._dynamic&&!this._needSync){this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}if(this._buffers&&this._buffers.length>1&&this._buffers[this._bufferIndex][1])if(this._buffersEqual(this._bufferData,this._buffers[this._bufferIndex][1])){this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame;return}else this._copyBuffer(this._bufferData,this._buffers[this._bufferIndex][1]);this._engine.updateUniformBuffer(this._buffer,this._bufferData),this._engine._features._collectUbosUpdatedInFrame&&(Pe._UpdatedUbosInFrame[this._name]||(Pe._UpdatedUbosInFrame[this._name]=0),Pe._UpdatedUbosInFrame[this._name]++),this._needSync=!1,this._createBufferOnWrite=this._engine._features.trackUbosInFrame}}_createNewBuffer(){this._bufferIndex+1<this._buffers.length?(this._bufferIndex++,this._buffer=this._buffers[this._bufferIndex][0],this._createBufferOnWrite=!1,this._needSync=!0):this._rebuild()}_checkNewFrame(){this._engine._features.trackUbosInFrame&&this._currentFrameId!==this._engine.frameId&&(this._currentFrameId=this._engine.frameId,this._createBufferOnWrite=!1,this._buffers&&this._buffers.length>0?(this._needSync=this._bufferIndex!==0,this._bufferIndex=0,this._buffer=this._buffers[this._bufferIndex][0]):this._bufferIndex=-1)}updateUniform(e,t,i){this._checkNewFrame();let s=this._uniformLocations[e];if(s===void 0){if(this._buffer){B.Error("Cannot add an uniform after UBO has been created.");return}this.addUniform(e,i),s=this._uniformLocations[e]}if(this._buffer||this.create(),this._dynamic)for(let r=0;r<i;r++)this._bufferData[s+r]=t[r];else{let r=!1;for(let n=0;n<i;n++)(i===16&&!this._engine._features.uniformBufferHardCheckMatrix||this._bufferData[s+n]!==q.FloatRound(t[n]))&&(r=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+n]=t[n]);this._needSync=this._needSync||r}}updateUniformArray(e,t,i){this._checkNewFrame();const s=this._uniformLocations[e];if(s===void 0){B.Error("Cannot add an uniform Array dynamically. Please, add it using addUniform.");return}this._buffer||this.create();const r=this._uniformArraySizes[e];if(this._dynamic)for(let n=0;n<i;n++)this._bufferData[s+n]=t[n];else{let n=!1,o=0,l=0;for(let h=0;h<i;h++)if(this._bufferData[s+l*4+o]!==q.FloatRound(t[h])&&(n=!0,this._createBufferOnWrite&&this._createNewBuffer(),this._bufferData[s+l*4+o]=t[h]),o++,o===r.strideSize){for(;o<4;o++)this._bufferData[s+l*4+o]=0;o=0,l++}this._needSync=this._needSync||n}}_cacheMatrix(e,t){this._checkNewFrame();const i=this._valueCache[e],s=t.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[e]=s,!0)}_updateMatrix3x3ForUniform(e,t){for(let i=0;i<3;i++)Pe._TempBuffer[i*4]=t[i*3],Pe._TempBuffer[i*4+1]=t[i*3+1],Pe._TempBuffer[i*4+2]=t[i*3+2],Pe._TempBuffer[i*4+3]=0;this.updateUniform(e,Pe._TempBuffer,12)}_updateMatrix3x3ForEffect(e,t){this._currentEffect.setMatrix3x3(e,t)}_updateMatrix2x2ForEffect(e,t){this._currentEffect.setMatrix2x2(e,t)}_updateMatrix2x2ForUniform(e,t){for(let i=0;i<2;i++)Pe._TempBuffer[i*4]=t[i*2],Pe._TempBuffer[i*4+1]=t[i*2+1],Pe._TempBuffer[i*4+2]=0,Pe._TempBuffer[i*4+3]=0;this.updateUniform(e,Pe._TempBuffer,8)}_updateFloatForEffect(e,t){this._currentEffect.setFloat(e,t)}_updateFloatForUniform(e,t){Pe._TempBuffer[0]=t,this.updateUniform(e,Pe._TempBuffer,1)}_updateFloat2ForEffect(e,t,i,s=""){this._currentEffect.setFloat2(e+s,t,i)}_updateFloat2ForUniform(e,t,i){Pe._TempBuffer[0]=t,Pe._TempBuffer[1]=i,this.updateUniform(e,Pe._TempBuffer,2)}_updateFloat3ForEffect(e,t,i,s,r=""){this._currentEffect.setFloat3(e+r,t,i,s)}_updateFloat3ForUniform(e,t,i,s){Pe._TempBuffer[0]=t,Pe._TempBuffer[1]=i,Pe._TempBuffer[2]=s,this.updateUniform(e,Pe._TempBuffer,3)}_updateFloat4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setFloat4(e+n,t,i,s,r)}_updateFloat4ForUniform(e,t,i,s,r){Pe._TempBuffer[0]=t,Pe._TempBuffer[1]=i,Pe._TempBuffer[2]=s,Pe._TempBuffer[3]=r,this.updateUniform(e,Pe._TempBuffer,4)}_updateFloatArrayForEffect(e,t){this._currentEffect.setFloatArray(e,t)}_updateFloatArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateArrayForEffect(e,t){this._currentEffect.setArray(e,t)}_updateArrayForUniform(e,t){this.updateUniformArray(e,t,t.length)}_updateIntArrayForEffect(e,t){this._currentEffect.setIntArray(e,t)}_updateIntArrayForUniform(e,t){Pe._TempBufferInt32View.set(t),this.updateUniformArray(e,Pe._TempBuffer,t.length)}_updateMatrixForEffect(e,t){this._currentEffect.setMatrix(e,t)}_updateMatrixForUniform(e,t){this._cacheMatrix(e,t)&&this.updateUniform(e,t.toArray(),16)}_updateMatricesForEffect(e,t){this._currentEffect.setMatrices(e,t)}_updateMatricesForUniform(e,t){this.updateUniform(e,t,t.length)}_updateVector3ForEffect(e,t){this._currentEffect.setVector3(e,t)}_updateVector3ForUniform(e,t){Pe._TempBuffer[0]=t.x,Pe._TempBuffer[1]=t.y,Pe._TempBuffer[2]=t.z,this.updateUniform(e,Pe._TempBuffer,3)}_updateVector4ForEffect(e,t){this._currentEffect.setVector4(e,t)}_updateVector4ForUniform(e,t){Pe._TempBuffer[0]=t.x,Pe._TempBuffer[1]=t.y,Pe._TempBuffer[2]=t.z,Pe._TempBuffer[3]=t.w,this.updateUniform(e,Pe._TempBuffer,4)}_updateColor3ForEffect(e,t,i=""){this._currentEffect.setColor3(e+i,t)}_updateColor3ForUniform(e,t){Pe._TempBuffer[0]=t.r,Pe._TempBuffer[1]=t.g,Pe._TempBuffer[2]=t.b,this.updateUniform(e,Pe._TempBuffer,3)}_updateColor4ForEffect(e,t,i,s=""){this._currentEffect.setColor4(e+s,t,i)}_updateDirectColor4ForEffect(e,t,i=""){this._currentEffect.setDirectColor4(e+i,t)}_updateColor4ForUniform(e,t,i){Pe._TempBuffer[0]=t.r,Pe._TempBuffer[1]=t.g,Pe._TempBuffer[2]=t.b,Pe._TempBuffer[3]=i,this.updateUniform(e,Pe._TempBuffer,4)}_updateDirectColor4ForUniform(e,t){Pe._TempBuffer[0]=t.r,Pe._TempBuffer[1]=t.g,Pe._TempBuffer[2]=t.b,Pe._TempBuffer[3]=t.a,this.updateUniform(e,Pe._TempBuffer,4)}_updateIntForEffect(e,t,i=""){this._currentEffect.setInt(e+i,t)}_updateIntForUniform(e,t){Pe._TempBufferInt32View[0]=t,this.updateUniform(e,Pe._TempBuffer,1)}_updateInt2ForEffect(e,t,i,s=""){this._currentEffect.setInt2(e+s,t,i)}_updateInt2ForUniform(e,t,i){Pe._TempBufferInt32View[0]=t,Pe._TempBufferInt32View[1]=i,this.updateUniform(e,Pe._TempBuffer,2)}_updateInt3ForEffect(e,t,i,s,r=""){this._currentEffect.setInt3(e+r,t,i,s)}_updateInt3ForUniform(e,t,i,s){Pe._TempBufferInt32View[0]=t,Pe._TempBufferInt32View[1]=i,Pe._TempBufferInt32View[2]=s,this.updateUniform(e,Pe._TempBuffer,3)}_updateInt4ForEffect(e,t,i,s,r,n=""){this._currentEffect.setInt4(e+n,t,i,s,r)}_updateInt4ForUniform(e,t,i,s,r){Pe._TempBufferInt32View[0]=t,Pe._TempBufferInt32View[1]=i,Pe._TempBufferInt32View[2]=s,Pe._TempBufferInt32View[3]=r,this.updateUniform(e,Pe._TempBuffer,4)}setTexture(e,t){this._currentEffect.setTexture(e,t)}updateUniformDirectly(e,t){this.updateUniform(e,t,t.length),this.update()}bindToEffect(e,t){this._currentEffect=e,this._currentEffectName=t}bindUniformBuffer(){!this._noUBO&&this._buffer&&this._currentEffect&&this._currentEffect.bindUniformBuffer(this._buffer,this._currentEffectName)}unbindEffect(){this._currentEffect=void 0,this._currentEffectName=void 0}setDataBuffer(e){if(!this._buffers)return this._buffer===e;for(let t=0;t<this._buffers.length;++t)if(this._buffers[t][0]===e)return this._bufferIndex=t,this._buffer=e,this._createBufferOnWrite=!1,this._currentEffect=void 0,!0;return!1}dispose(){if(this._noUBO)return;const e=this._engine._uniformBuffers,t=e.indexOf(this);if(t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._features.trackUbosInFrame&&this._buffers)for(let i=0;i<this._buffers.length;++i){const s=this._buffers[i][0];this._engine._releaseBuffer(s)}else this._buffer&&this._engine._releaseBuffer(this._buffer)&&(this._buffer=null)}}Pe._UpdatedUbosInFrame={};Pe._MAX_UNIFORM_SIZE=256;Pe._TempBuffer=new Float32Array(Pe._MAX_UNIFORM_SIZE);Pe._TempBufferInt32View=new Uint32Array(Pe._TempBuffer.buffer);class Vt{constructor(){this.shaderLanguage=Xt.GLSL}_addUniformToLeftOverUBO(e,t,i){let s=0;[e,t,s]=this._getArraySize(e,t,i);for(let r=0;r<this._webgpuProcessingContext.leftOverUniforms.length;r++)if(this._webgpuProcessingContext.leftOverUniforms[r].name===e)return;this._webgpuProcessingContext.leftOverUniforms.push({name:e,type:t,length:s})}_buildLeftOverUBO(){if(!this._webgpuProcessingContext.leftOverUniforms.length)return"";const e=Vt.LeftOvertUBOName;let t=this._webgpuProcessingContext.availableBuffers[e];return t||(t={binding:this._webgpuProcessingContext.getNextFreeUBOBinding()},this._webgpuProcessingContext.availableBuffers[e]=t,this._addBufferBindingDescription(e,t,Wn.Uniform,!0),this._addBufferBindingDescription(e,t,Wn.Uniform,!1)),this._generateLeftOverUBOCode(e,t)}_collectBindingNames(){for(let e=0;e<this._webgpuProcessingContext.bindGroupLayoutEntries.length;e++){const t=this._webgpuProcessingContext.bindGroupLayoutEntries[e];if(t===void 0){this._webgpuProcessingContext.bindGroupLayoutEntries[e]=[];continue}for(let i=0;i<t.length;i++){const s=this._webgpuProcessingContext.bindGroupLayoutEntries[e][i],r=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][s.binding].name,n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[e][s.binding].nameInArrayOfTexture;s&&(s.texture||s.externalTexture||s.storageTexture?this._webgpuProcessingContext.textureNames.push(n):s.sampler?this._webgpuProcessingContext.samplerNames.push(r):s.buffer&&this._webgpuProcessingContext.bufferNames.push(r))}}}_preCreateBindGroupEntries(){const e=this._webgpuProcessingContext.bindGroupEntries;for(let t=0;t<this._webgpuProcessingContext.bindGroupLayoutEntries.length;t++){const i=this._webgpuProcessingContext.bindGroupLayoutEntries[t],s=[];for(let r=0;r<i.length;r++){const n=this._webgpuProcessingContext.bindGroupLayoutEntries[t][r];n.sampler||n.texture||n.storageTexture||n.externalTexture?s.push({binding:n.binding,resource:void 0}):n.buffer&&s.push({binding:n.binding,resource:{buffer:void 0,offset:0,size:0}})}e[t]=s}}_addTextureBindingDescription(e,t,i,s,r,n){let{groupIndex:o,bindingIndex:l}=t.textures[i];if(this._webgpuProcessingContext.bindGroupLayoutEntries[o]||(this._webgpuProcessingContext.bindGroupLayoutEntries[o]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]){let h;s===null?h=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,externalTexture:{}}):r?h=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,storageTexture:{access:ju.WriteOnly,format:r,viewDimension:s}}):h=this._webgpuProcessingContext.bindGroupLayoutEntries[o].push({binding:l,visibility:0,texture:{sampleType:t.sampleType,viewDimension:s,multisampled:!1}});const c=t.isTextureArray?e+i:e;this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l]={name:e,index:h-1,nameInArrayOfTexture:c}}l=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[o][l].index,n?this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=Dn.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[o][l].visibility|=Dn.Fragment}_addSamplerBindingDescription(e,t,i){let{groupIndex:s,bindingIndex:r}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[s]||(this._webgpuProcessingContext.bindGroupLayoutEntries[s]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][r]){const n=this._webgpuProcessingContext.bindGroupLayoutEntries[s].push({binding:r,visibility:0,sampler:{type:t.type}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][r]={name:e,index:n-1}}r=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[s][r].index,i?this._webgpuProcessingContext.bindGroupLayoutEntries[s][r].visibility|=Dn.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[s][r].visibility|=Dn.Fragment}_addBufferBindingDescription(e,t,i,s){let{groupIndex:r,bindingIndex:n}=t.binding;if(this._webgpuProcessingContext.bindGroupLayoutEntries[r]||(this._webgpuProcessingContext.bindGroupLayoutEntries[r]=[],this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r]=[]),!this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]){const o=this._webgpuProcessingContext.bindGroupLayoutEntries[r].push({binding:n,visibility:0,buffer:{type:i}});this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n]={name:e,index:o-1}}n=this._webgpuProcessingContext.bindGroupLayoutEntryInfo[r][n].index,s?this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=Dn.Vertex:this._webgpuProcessingContext.bindGroupLayoutEntries[r][n].visibility|=Dn.Fragment}_injectStartingAndEndingCode(e,t,i,s){if(i){let r=e.indexOf(t);if(r>=0){for(;r++<e.length&&e.charAt(r)!="{";);if(r<e.length){for(;r++<e.length&&e.charAt(r)!=`
`;);if(r<e.length){const n=e.substring(0,r+1),o=e.substring(r+1);e=n+i+o}}}}if(s){const r=e.lastIndexOf("}");e=e.substring(0,r),e+=s+`
}`}return e}}Vt.AutoSamplerSuffix="Sampler";Vt.LeftOvertUBOName="LeftOver";Vt.InternalsUBOName="Internals";Vt.UniformSizes={bool:1,int:1,float:1,vec2:2,ivec2:2,vec3:3,ivec3:3,vec4:4,ivec4:4,mat2:4,mat3:12,mat4:16,i32:1,u32:1,f32:1,mat2x2:4,mat3x3:12,mat4x4:16};Vt._SamplerFunctionByWebGLSamplerType={sampler2D:"sampler2D",sampler2DArray:"sampler2DArray",sampler2DShadow:"sampler2DShadow",sampler2DArrayShadow:"sampler2DArrayShadow",samplerCube:"samplerCube",sampler3D:"sampler3D"};Vt._TextureTypeByWebGLSamplerType={sampler2D:"texture2D",sampler2DArray:"texture2DArray",sampler2DShadow:"texture2D",sampler2DArrayShadow:"texture2DArray",samplerCube:"textureCube",samplerCubeArray:"textureCubeArray",sampler3D:"texture3D"};Vt._GpuTextureViewDimensionByWebGPUTextureType={textureCube:Mt.Cube,textureCubeArray:Mt.CubeArray,texture2D:Mt.E2d,texture2DArray:Mt.E2dArray,texture3D:Mt.E3d};Vt._SamplerTypeByWebGLSamplerType={sampler2DShadow:"samplerShadow",sampler2DArrayShadow:"samplerShadow"};Vt._IsComparisonSamplerByWebGPUSamplerType={samplerShadow:!0,samplerArrayShadow:!0,sampler:!1};class _v{constructor(e,t){this._name="unnamed",this.shaderProcessingContext=e,this._leftOverUniformsByName={},this.engine=t}get isAsync(){return!1}get isReady(){return!!this.stages}_handlesSpectorRebuildCallback(){}_fillEffectInformation(e,t,i,s,r,n,o,l){const h=this.engine;e._fragmentSourceCode="",e._vertexSourceCode="";const c=this.shaderProcessingContext.availableTextures;let u;for(u=0;u<r.length;u++){const p=r[u],_=c[r[u]];_==null||_==null?(r.splice(u,1),u--):n[p]=u}for(const p of h.getAttributes(this,o))l.push(p);this.buildUniformLayout();const d=[],f=[];for(u=0;u<o.length;u++){const p=l[u];p>=0&&(d.push(o[u]),f.push(p))}this.shaderProcessingContext.attributeNamesFromEffect=d,this.shaderProcessingContext.attributeLocationsFromEffect=f}buildUniformLayout(){if(!!this.shaderProcessingContext.leftOverUniforms.length){this.uniformBuffer=new Pe(this.engine,void 0,void 0,"leftOver-"+this._name);for(const e of this.shaderProcessingContext.leftOverUniforms){const t=e.type.replace(/^(.*?)(<.*>)?$/,"$1"),i=Vt.UniformSizes[t];this.uniformBuffer.addUniform(e.name,i,e.length),this._leftOverUniformsByName[e.name]=e.type}this.uniformBuffer.create()}}dispose(){this.uniformBuffer&&this.uniformBuffer.dispose()}setInt(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt(e,t)}setInt2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt2(e,t,i)}setInt3(e,t,i,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt3(e,t,i,s)}setInt4(e,t,i,s,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateInt4(e,t,i,s,r)}setIntArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateIntArray(e,t)}setIntArray2(e,t){this.setIntArray(e,t)}setIntArray3(e,t){this.setIntArray(e,t)}setIntArray4(e,t){this.setIntArray(e,t)}setArray(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateArray(e,t)}setArray2(e,t){this.setArray(e,t)}setArray3(e,t){this.setArray(e,t)}setArray4(e,t){this.setArray(e,t)}setMatrices(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrices(e,t)}setMatrix(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix(e,t)}setMatrix3x3(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix3x3(e,t)}setMatrix2x2(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateMatrix2x2(e,t)}setFloat(e,t){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat(e,t)}setVector2(e,t){this.setFloat2(e,t.x,t.y)}setFloat2(e,t,i){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat2(e,t,i)}setVector3(e,t){this.setFloat3(e,t.x,t.y,t.z)}setFloat3(e,t,i,s){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat3(e,t,i,s)}setVector4(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setQuaternion(e,t){this.setFloat4(e,t.x,t.y,t.z,t.w)}setFloat4(e,t,i,s,r){!this.uniformBuffer||!this._leftOverUniformsByName[e]||this.uniformBuffer.updateFloat4(e,t,i,s,r)}setColor3(e,t){this.setFloat3(e,t.r,t.g,t.b)}setColor4(e,t,i){this.setFloat4(e,t.r,t.g,t.b,i)}setDirectColor4(e,t){this.setFloat4(e,t.r,t.g,t.b,t.a)}_getVertexShaderCode(){var e;return(e=this.sources)===null||e===void 0?void 0:e.vertex}_getFragmentShaderCode(){var e;return(e=this.sources)===null||e===void 0?void 0:e.fragment}}const mv=4,gv=1<<16,J0={mat2:2,mat3:3,mat4:4,mat2x2:2,mat3x3:3,mat4x4:4};class qs{constructor(e){this.shaderLanguage=e,this._attributeNextLocation=0,this._varyingNextLocation=0,this.freeGroupIndex=0,this.freeBindingIndex=0,this.availableVaryings={},this.availableAttributes={},this.availableBuffers={},this.availableTextures={},this.availableSamplers={},this.orderedAttributes=[],this.bindGroupLayoutEntries=[],this.bindGroupLayoutEntryInfo=[],this.bindGroupEntries=[],this.bufferNames=[],this.textureNames=[],this.samplerNames=[],this.leftOverUniforms=[],this._findStartingGroupBinding()}static get KnownUBOs(){return qs._SimplifiedKnownBindings?qs._SimplifiedKnownUBOs:qs._KnownUBOs}_findStartingGroupBinding(){const e=qs.KnownUBOs,t=[];for(const i in e){const s=e[i].binding;s.groupIndex!==-1&&(t[s.groupIndex]===void 0?t[s.groupIndex]=s.bindingIndex:t[s.groupIndex]=Math.max(t[s.groupIndex],s.bindingIndex))}this.freeGroupIndex=t.length-1,this.freeGroupIndex===0?(this.freeGroupIndex++,this.freeBindingIndex=0):this.freeBindingIndex=t[t.length-1]+1}getAttributeNextLocation(e,t=0){var i;const s=this._attributeNextLocation;return this._attributeNextLocation+=((i=J0[e])!==null&&i!==void 0?i:1)*(t||1),s}getVaryingNextLocation(e,t=0){var i;const s=this._varyingNextLocation;return this._varyingNextLocation+=((i=J0[e])!==null&&i!==void 0?i:1)*(t||1),s}getNextFreeUBOBinding(){return this._getNextFreeBinding(1)}_getNextFreeBinding(e){if(this.freeBindingIndex>gv-e&&(this.freeGroupIndex++,this.freeBindingIndex=0),this.freeGroupIndex===mv)throw"Too many textures or UBOs have been declared and it is not supported in WebGPU.";const t={groupIndex:this.freeGroupIndex,bindingIndex:this.freeBindingIndex};return this.freeBindingIndex+=e,t}}qs._SimplifiedKnownBindings=!0;qs._SimplifiedKnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:-1,bindingIndex:-1}},Light1:{binding:{groupIndex:-1,bindingIndex:-1}},Light2:{binding:{groupIndex:-1,bindingIndex:-1}},Light3:{binding:{groupIndex:-1,bindingIndex:-1}},Light4:{binding:{groupIndex:-1,bindingIndex:-1}},Light5:{binding:{groupIndex:-1,bindingIndex:-1}},Light6:{binding:{groupIndex:-1,bindingIndex:-1}},Light7:{binding:{groupIndex:-1,bindingIndex:-1}},Light8:{binding:{groupIndex:-1,bindingIndex:-1}},Light9:{binding:{groupIndex:-1,bindingIndex:-1}},Light10:{binding:{groupIndex:-1,bindingIndex:-1}},Light11:{binding:{groupIndex:-1,bindingIndex:-1}},Light12:{binding:{groupIndex:-1,bindingIndex:-1}},Light13:{binding:{groupIndex:-1,bindingIndex:-1}},Light14:{binding:{groupIndex:-1,bindingIndex:-1}},Light15:{binding:{groupIndex:-1,bindingIndex:-1}},Light16:{binding:{groupIndex:-1,bindingIndex:-1}},Light17:{binding:{groupIndex:-1,bindingIndex:-1}},Light18:{binding:{groupIndex:-1,bindingIndex:-1}},Light19:{binding:{groupIndex:-1,bindingIndex:-1}},Light20:{binding:{groupIndex:-1,bindingIndex:-1}},Light21:{binding:{groupIndex:-1,bindingIndex:-1}},Light22:{binding:{groupIndex:-1,bindingIndex:-1}},Light23:{binding:{groupIndex:-1,bindingIndex:-1}},Light24:{binding:{groupIndex:-1,bindingIndex:-1}},Light25:{binding:{groupIndex:-1,bindingIndex:-1}},Light26:{binding:{groupIndex:-1,bindingIndex:-1}},Light27:{binding:{groupIndex:-1,bindingIndex:-1}},Light28:{binding:{groupIndex:-1,bindingIndex:-1}},Light29:{binding:{groupIndex:-1,bindingIndex:-1}},Light30:{binding:{groupIndex:-1,bindingIndex:-1}},Light31:{binding:{groupIndex:-1,bindingIndex:-1}},Material:{binding:{groupIndex:-1,bindingIndex:-1}},Mesh:{binding:{groupIndex:-1,bindingIndex:-1}},Internals:{binding:{groupIndex:-1,bindingIndex:-1}}};qs._KnownUBOs={Scene:{binding:{groupIndex:0,bindingIndex:0}},Light0:{binding:{groupIndex:1,bindingIndex:0}},Light1:{binding:{groupIndex:1,bindingIndex:1}},Light2:{binding:{groupIndex:1,bindingIndex:2}},Light3:{binding:{groupIndex:1,bindingIndex:3}},Light4:{binding:{groupIndex:1,bindingIndex:4}},Light5:{binding:{groupIndex:1,bindingIndex:5}},Light6:{binding:{groupIndex:1,bindingIndex:6}},Light7:{binding:{groupIndex:1,bindingIndex:7}},Light8:{binding:{groupIndex:1,bindingIndex:8}},Light9:{binding:{groupIndex:1,bindingIndex:9}},Light10:{binding:{groupIndex:1,bindingIndex:10}},Light11:{binding:{groupIndex:1,bindingIndex:11}},Light12:{binding:{groupIndex:1,bindingIndex:12}},Light13:{binding:{groupIndex:1,bindingIndex:13}},Light14:{binding:{groupIndex:1,bindingIndex:14}},Light15:{binding:{groupIndex:1,bindingIndex:15}},Light16:{binding:{groupIndex:1,bindingIndex:16}},Light17:{binding:{groupIndex:1,bindingIndex:17}},Light18:{binding:{groupIndex:1,bindingIndex:18}},Light19:{binding:{groupIndex:1,bindingIndex:19}},Light20:{binding:{groupIndex:1,bindingIndex:20}},Light21:{binding:{groupIndex:1,bindingIndex:21}},Light22:{binding:{groupIndex:1,bindingIndex:22}},Light23:{binding:{groupIndex:1,bindingIndex:23}},Light24:{binding:{groupIndex:1,bindingIndex:24}},Light25:{binding:{groupIndex:1,bindingIndex:25}},Light26:{binding:{groupIndex:1,bindingIndex:26}},Light27:{binding:{groupIndex:1,bindingIndex:27}},Light28:{binding:{groupIndex:1,bindingIndex:28}},Light29:{binding:{groupIndex:1,bindingIndex:29}},Light30:{binding:{groupIndex:1,bindingIndex:30}},Light31:{binding:{groupIndex:1,bindingIndex:31}},Material:{binding:{groupIndex:2,bindingIndex:0}},Mesh:{binding:{groupIndex:2,bindingIndex:1}},Internals:{binding:{groupIndex:2,bindingIndex:2}}};class vv extends Vt{constructor(){super(...arguments),this._missingVaryings=[],this._textureArrayProcessing=[],this.shaderLanguage=Xt.GLSL}_getArraySize(e,t,i){let s=0;const r=e.indexOf("["),n=e.indexOf("]");if(r>0&&n>0){const o=e.substring(r+1,n);s=+o,isNaN(s)&&(s=+i[o.trim()]),e=e.substr(0,r)}return[e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._missingVaryings.length=0,this._textureArrayProcessing.length=0}preProcessShaderCode(e,t){const i=`uniform ${Vt.InternalsUBOName} {
float yFactor_;
float textureOutputHeight_;
};
`;return t?i+`##INJECTCODE##
`+e:i+e}varyingProcessor(e,t,i){this._preProcessors=i;const r=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(r!=null){const n=r[1],o=r[2];let l;t?(l=this._webgpuProcessingContext.availableVaryings[o],this._missingVaryings[l]="",l===void 0&&B.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(n,this._getArraySize(o,n,i)[2]),this._webgpuProcessingContext.availableVaryings[o]=l,this._missingVaryings[l]=`layout(location = ${l}) in ${n} ${o};`),e=e.replace(r[0],l===void 0?"":`layout(location = ${l}) ${t?"in":"out"} ${n} ${o};`)}return e}attributeProcessor(e,t){this._preProcessors=t;const s=/\s*attribute\s+(\S+)\s+(\S+)\s*;/gm.exec(e);if(s!=null){const r=s[1],n=s[2],o=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(n,r,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=o,this._webgpuProcessingContext.orderedAttributes[o]=n,e=e.replace(s[0],`layout(location = ${o}) in ${r} ${n};`)}return e}uniformProcessor(e,t,i){var s;this._preProcessors=i;const n=/\s*uniform\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s+(\S+)\s*;/gm.exec(e);if(n!=null){let o=n[1],l=n[2];if(o.indexOf("sampler")===0||o.indexOf("sampler")===1){let h=0;[l,o,h]=this._getArraySize(l,o,i);let c=this._webgpuProcessingContext.availableTextures[l];if(!c){c={autoBindSampler:!0,isTextureArray:h>0,isStorageTexture:!1,textures:[],sampleType:Gs.Float};for(let M=0;M<(h||1);++M)c.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}const u=(s=Vt._SamplerTypeByWebGLSamplerType[o])!==null&&s!==void 0?s:"sampler",d=!!Vt._IsComparisonSamplerByWebGPUSamplerType[u],f=d?jn.Comparison:jn.Filtering,p=l+Vt.AutoSamplerSuffix;let _=this._webgpuProcessingContext.availableSamplers[p];_||(_={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:f});const m=o.charAt(0)==="u"?"u":o.charAt(0)==="i"?"i":"";m&&(o=o.substr(1));const v=d?Gs.Depth:m==="u"?Gs.Uint:m==="i"?Gs.Sint:Gs.Float;c.sampleType=v;const x=h>0,b=_.binding.groupIndex,S=_.binding.bindingIndex,C=Vt._SamplerFunctionByWebGLSamplerType[o],E=Vt._TextureTypeByWebGLSamplerType[o],A=Vt._GpuTextureViewDimensionByWebGPUTextureType[E];if(!x)h=1,e=`layout(set = ${b}, binding = ${S}) uniform ${m}${u} ${p};
                        layout(set = ${c.textures[0].groupIndex}, binding = ${c.textures[0].bindingIndex}) uniform ${E} ${l}Texture;
                        #define ${l} ${m}${C}(${l}Texture, ${p})`;else{const M=[];M.push(`layout(set = ${b}, binding = ${S}) uniform ${m}${u} ${p};`),e=`\r
`;for(let D=0;D<h;++D){const P=c.textures[D].groupIndex,O=c.textures[D].bindingIndex;M.push(`layout(set = ${P}, binding = ${O}) uniform ${E} ${l}Texture${D};`),e+=`${D>0?`\r
`:""}#define ${l}${D} ${m}${C}(${l}Texture${D}, ${p})`}e=M.join(`\r
`)+e,this._textureArrayProcessing.push(l)}this._webgpuProcessingContext.availableTextures[l]=c,this._webgpuProcessingContext.availableSamplers[p]=_,this._addSamplerBindingDescription(p,_,!t);for(let M=0;M<h;++M)this._addTextureBindingDescription(l,c,M,A,null,!t)}else this._addUniformToLeftOverUBO(l,o,i),e=""}return e}uniformBufferProcessor(e,t){const s=/uniform\s+(\w+)/gm.exec(e);if(s!=null){const r=s[1];let n=this._webgpuProcessingContext.availableBuffers[r];if(!n){const o=qs.KnownUBOs[r];let l;o&&o.binding.groupIndex!==-1?l=o.binding:l=this._webgpuProcessingContext.getNextFreeUBOBinding(),n={binding:l},this._webgpuProcessingContext.availableBuffers[r]=n}this._addBufferBindingDescription(r,n,Wn.Uniform,!t),e=e.replace("uniform",`layout(set = ${n.binding.groupIndex}, binding = ${n.binding.bindingIndex}) uniform`)}return e}postProcessor(e,t,i,s,r){const n=e.search(/#extension.+GL_EXT_draw_buffers.+require/)!==-1,o=/#extension.+(GL_OVR_multiview2|GL_OES_standard_derivatives|GL_EXT_shader_texture_lod|GL_EXT_frag_depth|GL_EXT_draw_buffers).+(enable|require)/g;if(e=e.replace(o,""),e=e.replace(/texture2D\s*\(/g,"texture("),i){const l=e.indexOf("gl_FragCoord")>=0,h=`
                glFragCoord_ = gl_FragCoord;
                if (yFactor_ == 1.) {
                    glFragCoord_.y = textureOutputHeight_ - glFragCoord_.y;
                }
            `,c=l?`vec4 glFragCoord_;
`:"";e=e.replace(/texture2DLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCubeLodEXT\s*\(/g,"textureLod("),e=e.replace(/textureCube\s*\(/g,"texture("),e=e.replace(/gl_FragDepthEXT/g,"gl_FragDepth"),e=e.replace(/gl_FragColor/g,"glFragColor"),e=e.replace(/gl_FragData/g,"glFragData"),e=e.replace(/gl_FragCoord/g,"glFragCoord_"),e=e.replace(/void\s+?main\s*\(/g,(n?"":`layout(location = 0) out vec4 glFragColor;
`)+"void main("),e=e.replace(/dFdy/g,"(-yFactor_)*dFdy"),e=e.replace("##INJECTCODE##",c),l&&(e=this._injectStartingAndEndingCode(e,"void main",h))}else if(e=e.replace(/gl_InstanceID/g,"gl_InstanceIndex"),e=e.replace(/gl_VertexID/g,"gl_VertexIndex"),t.indexOf("#define MULTIVIEW")!==-1)return`#extension GL_OVR_multiview2 : require
layout (num_views = 2) in;
`+e;if(!i){const l=e.lastIndexOf("}");e=e.substring(0,l),e+=`gl_Position.y *= yFactor_;
`,r.isNDCHalfZRange||(e+=`gl_Position.z = (gl_Position.z + gl_Position.w) / 2.0;
`),e+="}"}return e}_applyTextureArrayProcessing(e,t){const i=new RegExp(t+"\\s*\\[(.+)?\\]","gm");let s=i.exec(e);for(;s!=null;){const r=s[1];let n=+r;this._preProcessors&&isNaN(n)&&(n=+this._preProcessors[r.trim()]),e=e.replace(s[0],t+n),s=i.exec(e)}return e}_generateLeftOverUBOCode(e,t){let i=`layout(set = ${t.binding.groupIndex}, binding = ${t.binding.bindingIndex}) uniform ${e} {
    `;for(const s of this._webgpuProcessingContext.leftOverUniforms)s.length>0?i+=`    ${s.type} ${s.name}[${s.length}];
`:i+=`    ${s.type} ${s.name};
`;return i+=`};

`,i}finalizeShaders(e,t){for(let s=0;s<this._textureArrayProcessing.length;++s){const r=this._textureArrayProcessing[s];e=this._applyTextureArrayProcessing(e,r),t=this._applyTextureArrayProcessing(t,r)}for(let s=0;s<this._missingVaryings.length;++s){const r=this._missingVaryings[s];r&&r.length>0&&(t=r+`
`+t)}const i=this._buildLeftOverUBO();return e=i+e,t=i+t,this._collectBindingNames(),this._preCreateBindGroupEntries(),this._preProcessors=null,{vertexCode:e,fragmentCode:t}}}function ph(a,e,t,i){let s=i,r=0,n="";for(;s<t.length;){const o=t.charAt(s);if(n)o===n?n==='"'||n==="'"?t.charAt(s-1)!=="\\"&&(n=""):n="":n==="*/"&&o==="*"&&s+1<t.length&&(t.charAt(s+1)==="/"&&(n=""),n===""&&s++);else switch(o){case a:r++;break;case e:r--;break;case'"':case"'":case"`":n=o;break;case"/":if(s+1<t.length){const l=t.charAt(s+1);l==="/"?n=`
`:l==="*"&&(n="*/")}break}if(s++,r===0)break}return r===0?s-1:-1}function ef(a,e){for(;e<a.length;){const t=a[e];if(t!==" "&&t!==`
`&&t!=="\r"&&t!=="	"&&t!==`
`&&t!=="\xA0")break;e++}return e}function Eu(a){const e=a.charCodeAt(0);return e>=48&&e<=57||e>=65&&e<=90||e>=97&&e<=122||e==95}function qu(a){let e=0,t="",i=!1;const s=[];for(;e<a.length;){const r=a.charAt(e);if(t)r===t?t==='"'||t==="'"?(a.charAt(e-1)!=="\\"&&(t=""),s.push(r)):(t="",i=!1):t==="*/"&&r==="*"&&e+1<a.length?(a.charAt(e+1)==="/"&&(t=""),t===""&&(i=!1,e++)):i||s.push(r);else{switch(r){case'"':case"'":case"`":t=r;break;case"/":if(e+1<a.length){const n=a.charAt(e+1);n==="/"?(t=`
`,i=!0):n==="*"&&(t="*/",i=!0)}break}i||s.push(r)}e++}return s.join("")}function xv(a,e,t){for(;e>=0&&a.charAt(e)!==t;)e--;return e}function Tv(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}const bv="bonesDeclaration",Sv=`#if NUM_BONE_INFLUENCERS>0
attribute matricesIndices : vec4<f32>;
attribute matricesWeights : vec4<f32>;
#if NUM_BONE_INFLUENCERS>4
attribute matricesIndicesExtra : vec4<f32>;
attribute matricesWeightsExtra : vec4<f32>;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
var boneSampler : texture_2d<f32>;
uniform boneTextureWidth : f32;
#else
uniform mBones : array<mat4x4,BonesPerMesh>;
#ifdef BONES_VELOCITY_ENABLED
uniform mPreviousBones : array<mat4x4,BonesPerMesh>;
#endif
#endif
#ifdef BONETEXTURE
fn readMatrixFromRawSampler(smp : texture_2d<f32>,index : f32)->mat4x4<f32>
{
let offset=i32(index) *4; 
let m0=textureLoad(smp,vec2<i32>(offset+0,0),0);
let m1=textureLoad(smp,vec2<i32>(offset+1,0),0);
let m2=textureLoad(smp,vec2<i32>(offset+2,0),0);
let m3=textureLoad(smp,vec2<i32>(offset+3,0),0);
return mat4x4<f32>(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;Y.IncludesShadersStoreWGSL[bv]=Sv;const Ev="bonesVertex",Cv=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
var influence : mat4x4<f32>;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif 
#else 
influence=uniforms.mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence=influence+uniforms.mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
influence=influence+uniforms.mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
influence=influence+uniforms.mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif 
#if NUM_BONE_INFLUENCERS>4
influence=influence+uniforms.mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
influence=influence+uniforms.mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
influence=influence+uniforms.mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
influence=influence+uniforms.mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif 
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;Y.IncludesShadersStoreWGSL[Ev]=Cv;const yv="bakedVertexAnimationDeclaration",Av=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform bakedVertexAnimationTime: f32;
uniform bakedVertexAnimationTextureSizeInverted: vec2<f32>;
uniform bakedVertexAnimationSettings: vec4<f32>;
var bakedVertexAnimationTexture : texture_2d<f32>;
#ifdef INSTANCES
attribute bakedVertexAnimationSettingsInstanced : vec4<f32>;
#endif
fn readMatrixFromRawSamplerVAT(smp : texture_2d<f32>,index : f32,frame : f32)->mat4x4<f32>
{
let offset=i32(index)*4;
let frameUV=i32(frame);
let m0=textureLoad(smp,vec2<i32>(offset+0,frameUV),0);
let m1=textureLoad(smp,vec2<i32>(offset+1,frameUV),0);
let m2=textureLoad(smp,vec2<i32>(offset+2,frameUV),0);
let m3=textureLoad(smp,vec2<i32>(offset+3,frameUV),0);
return mat4x4<f32>(m0,m1,m2,m3);
}
#endif
`;Y.IncludesShadersStoreWGSL[yv]=Av;const Rv="bakedVertexAnimation",Iv=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
let VATStartFrame: f32=bakedVertexAnimationSettingsInstanced.x;
let VATEndFrame: f32=bakedVertexAnimationSettingsInstanced.y;
let VATOffsetFrame: f32=bakedVertexAnimationSettingsInstanced.z;
let VATSpeed: f32=bakedVertexAnimationSettingsInstanced.w;
#else
let VATStartFrame: f32=uniforms.bakedVertexAnimationSettings.x;
let VATEndFrame: f32=uniforms.bakedVertexAnimationSettings.y;
let VATOffsetFrame: f32=uniforms.bakedVertexAnimationSettings.z;
let VATSpeed: f32=uniforms.bakedVertexAnimationSettings.w;
#endif
let totalFrames: f32=VATEndFrame-VATStartFrame+1.0;
let time: f32=uniforms.bakedVertexAnimationTime*VATSpeed/totalFrames;
let frameCorrection: f32=select(1.0,0.0,time<1.0);
let numOfFrames: f32=totalFrames-frameCorrection;
var VATFrameNum: f32=fract(time)*numOfFrames;
VATFrameNum=(VATFrameNum+VATOffsetFrame) % numOfFrames;
VATFrameNum=floor(VATFrameNum);
VATFrameNum=VATFrameNum+VATStartFrame+frameCorrection;
var VATInfluence : mat4x4<f32>;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence=VATInfluence+readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;Y.IncludesShadersStoreWGSL[Rv]=Iv;const Pv="clipPlaneFragment",Mv=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;Y.IncludesShadersStoreWGSL[Pv]=Mv;const Dv="clipPlaneFragmentDeclaration",Ov=`#ifdef CLIPPLANE
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
varying fClipDistance6: f32;
#endif
`;Y.IncludesShadersStoreWGSL[Dv]=Ov;const wv="clipPlaneVertex",Nv=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,uniforms.vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,uniforms.vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,uniforms.vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,uniforms.vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,uniforms.vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,uniforms.vClipPlane6);
#endif
`;Y.IncludesShadersStoreWGSL[wv]=Nv;const Fv="clipPlaneVertexDeclaration",Lv=`#ifdef CLIPPLANE
uniform vClipPlane: vec4<f32>;
varying fClipDistance: f32;
#endif
#ifdef CLIPPLANE2
uniform vClipPlane2: vec4<f32>;
varying fClipDistance2: f32;
#endif
#ifdef CLIPPLANE3
uniform vClipPlane3: vec4<f32>;
varying fClipDistance3: f32;
#endif
#ifdef CLIPPLANE4
uniform vClipPlane4: vec4<f32>;
varying fClipDistance4: f32;
#endif
#ifdef CLIPPLANE5
uniform vClipPlane5: vec4<f32>;
varying fClipDistance5: f32;
#endif
#ifdef CLIPPLANE6
uniform vClipPlane6: vec4<f32>;
varying fClipDistance6: f32;
#endif
`;Y.IncludesShadersStoreWGSL[Fv]=Lv;const Bv="instancesDeclaration",Uv=`#ifdef INSTANCES
attribute world0 : vec4<f32>;
attribute world1 : vec4<f32>;
attribute world2 : vec4<f32>;
attribute world3 : vec4<f32>;
#ifdef INSTANCESCOLOR
attribute instanceColor : vec4<f32>;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute previousWorld0 : vec4<f32>;
attribute previousWorld1 : vec4<f32>;
attribute previousWorld2 : vec4<f32>;
attribute previousWorld3 : vec4<f32>;
#ifdef THIN_INSTANCES
uniform previousWorld : mat4x4<f32>;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform world : mat4x4<f32>;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform previousWorld : mat4x4<f32>;
#endif
#endif
`;Y.IncludesShadersStoreWGSL[Bv]=Uv;const Vv="instancesVertex",kv=`#ifdef INSTANCES
var finalWorld=mat4x4<f32>(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
var finalPreviousWorld=mat4x4<f32>(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
#if !defined(WORLD_UBO)
finalWorld=uniforms.world*finalWorld;
#else
finalWorld=mesh.world*finalWorld;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
var finalWorld=uniforms.world;
#else
var finalWorld=mesh.world;
#endif
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
var finalPreviousWorld=previousWorld;
#endif
#endif
`;Y.IncludesShadersStoreWGSL[Vv]=kv;const Gv="meshUboDeclaration",zv=`struct Mesh {
world : mat4x4<f32>,
visibility : f32,
};
var<uniform> mesh : Mesh;
#define WORLD_UBO
`;Y.IncludesShadersStoreWGSL[Gv]=zv;const Wv="morphTargetsVertex",Hv=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=f32(gl_VertexID)*uniforms.morphTargetTextureInfo.x;
positionUpdated=positionUpdated+(readVector3FromRawSampler({X},vertexID)-position)*uniforms.morphTargetInfluences[{X}];
vertexID=vertexID+1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated=normalUpdated+(readVector3FromRawSampler({X},vertexID) -normal)*uniforms.morphTargetInfluences[{X}];
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(readVector3FromRawSampler({X},vertexID).xy-uv)*uniforms.morphTargetInfluences[{X}];
vertexID=vertexID+1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz=tangentUpdated.xyz+(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*uniforms.morphTargetInfluences[{X}];
#endif
#else
positionUpdated=positionUpdated+(position{X}-position)*uniforms.morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz=tangentUpdated.xyz+(tangent{X}-tangent.xyz)*uniforms.morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated=uvUpdated+(uv_{X}-uv)*uniforms.morphTargetInfluences[{X}];
#endif
#endif
#endif
`;Y.IncludesShadersStoreWGSL[Wv]=Hv;const Xv="morphTargetsVertexDeclaration",Yv=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute position{X} : vec3<f32>;
#ifdef MORPHTARGETS_NORMAL
attribute normal{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_TANGENT
attribute tangent{X} : vec3<f32>;
#endif
#ifdef MORPHTARGETS_UV
attribute uv_{X} : vec2<f32>;
#endif
#endif
#endif
`;Y.IncludesShadersStoreWGSL[Xv]=Yv;const Kv="morphTargetsVertexGlobal",$v=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
var vertexID : f32;
#endif
#endif
`;Y.IncludesShadersStoreWGSL[Kv]=$v;const jv="morphTargetsVertexGlobalDeclaration",qv=`#ifdef MORPHTARGETS
uniform morphTargetInfluences : array<f32,NUM_MORPH_INFLUENCERS>;
#ifdef MORPHTARGETS_TEXTURE 
uniform morphTargetTextureIndices : array<f32,NUM_MORPH_INFLUENCERS>;
uniform morphTargetTextureInfo : vec3<f32>;
var morphTargets : texture_2d_array<f32>;
var morphTargetsSampler : sampler;
fn readVector3FromRawSampler(targetIndex : i32,vertexIndex : f32)->vec3<f32>
{ 
let y=floor(vertexIndex/uniforms.morphTargetTextureInfo.y);
let x=vertexIndex-y*uniforms.morphTargetTextureInfo.y;
let textureUV=vec2<f32>((x+0.5)/uniforms.morphTargetTextureInfo.y,(y+0.5)/uniforms.morphTargetTextureInfo.z);
return textureSampleLevel(morphTargets,morphTargetsSampler,textureUV,i32(uniforms.morphTargetTextureIndices[targetIndex]),0.0).xyz;
}
#endif
#endif
`;Y.IncludesShadersStoreWGSL[jv]=qv;const Qv="sceneUboDeclaration",Zv=`struct Scene {
viewProjection : mat4x4<f32>,
#ifdef MULTIVIEW
viewProjectionR : mat4x4<f32>,
#endif 
view : mat4x4<f32>,
projection : mat4x4<f32>,
vEyePosition : vec4<f32>,
};
var<uniform> scene : Scene;
`;Y.IncludesShadersStoreWGSL[Qv]=Zv;const tf="gl_VertexID",sf="gl_InstanceID",rf="gl_Position",nf="gl_FragCoord",af="gl_FrontFacing",_h="gl_FragDepth",of="gl_FragColor",Jv="uniforms",ex="internals",tx={texture_1d:Mt.E1d,texture_2d:Mt.E2d,texture_2d_array:Mt.E2dArray,texture_3d:Mt.E3d,texture_cube:Mt.Cube,texture_cube_array:Mt.CubeArray,texture_multisampled_2d:Mt.E2d,texture_depth_2d:Mt.E2d,texture_depth_2d_array:Mt.E2dArray,texture_depth_cube:Mt.Cube,texture_depth_cube_array:Mt.CubeArray,texture_depth_multisampled_2d:Mt.E2d,texture_storage_1d:Mt.E1d,texture_storage_2d:Mt.E2d,texture_storage_2d_array:Mt.E2dArray,texture_storage_3d:Mt.E3d,texture_external:null};class ix extends Vt{constructor(){super(...arguments),this.shaderLanguage=Xt.WGSL,this.uniformRegexp=/uniform\s+(\w+)\s*:\s*(.+)\s*;/,this.textureRegexp=/var\s+(\w+)\s*:\s*((array<\s*)?(texture_\w+)\s*(<\s*(.+)\s*>)?\s*(,\s*\w+\s*>\s*)?);/,this.noPrecision=!0}_getArraySize(e,t,i){let s=0;const r=t.lastIndexOf(">");if(t.indexOf("array")>=0&&r>0){let n=r;for(;n>0&&t.charAt(n)!==" "&&t.charAt(n)!==",";)n--;const o=t.substring(n+1,r);for(s=+o,isNaN(s)&&(s=+i[o.trim()]);n>0&&(t.charAt(n)===" "||t.charAt(n)===",");)n--;t=t.substring(t.indexOf("<")+1,n+1)}return[e,t,s]}initializeShaders(e){this._webgpuProcessingContext=e,this._attributesWGSL=[],this._attributesDeclWGSL=[],this._attributeNamesWGSL=[],this._varyingsWGSL=[],this._varyingsDeclWGSL=[],this._varyingNamesWGSL=[],this._stridedUniformArrays=[]}preProcessShaderCode(e){return`struct ${Vt.InternalsUBOName} {
yFactor_: f32,
textureOutputHeight_: f32,
};
var<uniform> ${ex} : ${Vt.InternalsUBOName};
`+qu(e)}varyingProcessor(e,t,i){const r=/\s*varying\s+(?:(?:highp)?|(?:lowp)?)\s*(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(r!==null){const n=r[2],o=r[1];let l;t?(l=this._webgpuProcessingContext.availableVaryings[o],l===void 0&&B.Warn(`Invalid fragment shader: The varying named "${o}" is not declared in the vertex shader! This declaration will be ignored.`)):(l=this._webgpuProcessingContext.getVaryingNextLocation(n,this._getArraySize(o,n,i)[2]),this._webgpuProcessingContext.availableVaryings[o]=l,this._varyingsWGSL.push(`@location(${l}) ${o} : ${n},`),this._varyingsDeclWGSL.push(`var<private> ${o} : ${n};`),this._varyingNamesWGSL.push(o)),e=""}return e}attributeProcessor(e,t){const s=/\s*attribute\s+(\S+)\s*:\s*(.+)\s*;/gm.exec(e);if(s!==null){const r=s[2],n=s[1],o=this._webgpuProcessingContext.getAttributeNextLocation(r,this._getArraySize(n,r,t)[2]);this._webgpuProcessingContext.availableAttributes[n]=o,this._webgpuProcessingContext.orderedAttributes[o]=n,this._attributesWGSL.push(`@location(${o}) ${n} : ${r},`),this._attributesDeclWGSL.push(`var<private> ${n} : ${r};`),this._attributeNamesWGSL.push(n),e=""}return e}uniformProcessor(e,t,i){const s=this.uniformRegexp.exec(e);if(s!==null){const r=s[2],n=s[1];this._addUniformToLeftOverUBO(n,r,i),e=""}return e}textureProcessor(e,t,i){const s=this.textureRegexp.exec(e);if(s!==null){const r=s[1],n=s[2],o=!!s[3],l=s[4],h=l.indexOf("storage")>0,c=s[6],u=h?c.substring(0,c.indexOf(",")).trim():null;let d=o?this._getArraySize(r,n,i)[2]:0,f=this._webgpuProcessingContext.availableTextures[r];if(f)d=f.textures.length;else{f={isTextureArray:d>0,isStorageTexture:h,textures:[],sampleType:Gs.Float},d=d||1;for(let v=0;v<d;++v)f.textures.push(this._webgpuProcessingContext.getNextFreeUBOBinding())}this._webgpuProcessingContext.availableTextures[r]=f;const p=l.indexOf("depth")>0,_=tx[l],m=p?Gs.Depth:c==="u32"?Gs.Uint:c==="i32"?Gs.Sint:Gs.Float;if(f.sampleType=m,_===void 0)throw`Can't get the texture dimension corresponding to the texture function "${l}"!`;for(let v=0;v<d;++v){const{groupIndex:x,bindingIndex:b}=f.textures[v];v===0&&(e=`@group(${x}) @binding(${b}) ${e}`),this._addTextureBindingDescription(r,f,v,_,u,!t)}}return e}postProcessor(e){return e}finalizeShaders(e,t){const i=t.indexOf("gl_FragCoord")>=0?`
            if (internals.yFactor_ == 1.) {
                gl_FragCoord.y = internals.textureOutputHeight_ - gl_FragCoord.y;
            }
        `:"";e=this._processSamplers(e,!0),t=this._processSamplers(t,!1),e=this._processCustomBuffers(e,!0),t=this._processCustomBuffers(t,!1);const s=this._buildLeftOverUBO();e=s+e,t=s+t,e=e.replace(/#define /g,"//#define "),e=this._processStridedUniformArrays(e);const r=this._varyingsDeclWGSL.join(`
`)+`
`,n=`var<private> ${tf} : u32;
var<private> ${sf} : u32;
var<private> ${rf} : vec4<f32>;
`,o=this._attributesDeclWGSL.join(`
`)+`
`;let l=`struct VertexInputs {
  @builtin(vertex_index) vertexIndex : u32,
  @builtin(instance_index) instanceIndex : u32,
`;this._attributesWGSL.length>0&&(l+=this._attributesWGSL.join(`
`)),l+=`
};
`;let h=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
`;this._varyingsWGSL.length>0&&(h+=this._varyingsWGSL.join(`
`)),h+=`
};
`,e=n+l+o+h+r+e;let c=`  var output : FragmentInputs;
  ${tf} = input.vertexIndex;
  ${sf} = input.instanceIndex;
`;for(let b=0;b<this._attributeNamesWGSL.length;++b){const S=this._attributeNamesWGSL[b];c+=`  ${S} = input.${S};
`}let u=`  output.position = ${rf};
  output.position.y = output.position.y * internals.yFactor_;
`;for(let b=0;b<this._varyingNamesWGSL.length;++b){const S=this._varyingNamesWGSL[b];u+=`  output.${S} = ${S};
`}u+="  return output;",e=this._injectStartingAndEndingCode(e,"fn main",c,u),t=t.replace(/#define /g,"//#define "),t=this._processStridedUniformArrays(t),t=t.replace(/dpdy/g,"(-internals.yFactor_)*dpdy");const d=`var<private> ${nf} : vec4<f32>;
var<private> ${af} : bool;
var<private> ${of} : vec4<f32>;
var<private> ${_h} : f32;
`;let f=`struct FragmentInputs {
  @builtin(position) position : vec4<f32>,
  @builtin(front_facing) frontFacing : bool,
`;this._varyingsWGSL.length>0&&(f+=this._varyingsWGSL.join(`
`)),f+=`
};
`;let p=`struct FragmentOutputs {
  @location(0) color : vec4<f32>,
`,_=!1,m=0;for(;!_&&(m=t.indexOf(_h,m),!(m<0));){const b=m;for(_=!0;m>1&&t.charAt(m)!==`
`;){if(t.charAt(m)==="/"&&t.charAt(m-1)==="/"){_=!1;break}m--}m=b+_h.length}_&&(p+=`  @builtin(frag_depth) fragDepth: f32,
`),p+=`};
`,t=d+f+r+p+t;let v=`  var output : FragmentOutputs;
  ${nf} = input.position;
  ${af} = input.frontFacing;
`+i;for(let b=0;b<this._varyingNamesWGSL.length;++b){const S=this._varyingNamesWGSL[b];v+=`  ${S} = input.${S};
`}let x=`  output.color = ${of};
`;return _&&(x+=`  output.fragDepth = ${_h};
`),x+="  return output;",t=this._injectStartingAndEndingCode(t,"fn main",v,x),this._collectBindingNames(),this._preCreateBindGroupEntries(),{vertexCode:e,fragmentCode:t}}_generateLeftOverUBOCode(e,t){let i="",s=`struct ${e} {
`;for(const r of this._webgpuProcessingContext.leftOverUniforms){const n=r.type.replace(/^(.*?)(<.*>)?$/,"$1"),o=Vt.UniformSizes[n];if(r.length>0)if(o<=2){const l=`${e}_${this._stridedUniformArrays.length}_strided_arr`;i+=`struct ${l} {
                        @size(16)
                        el: ${n},
                    }`,this._stridedUniformArrays.push(r.name),s+=` @align(16) ${r.name} : array<${l}, ${r.length}>,
`}else s+=` ${r.name} : array<${r.type}, ${r.length}>,
`;else s+=`  ${r.name} : ${r.type},
`}return s+=`};
`,s=`${i}
${s}`,s+=`@group(${t.binding.groupIndex}) @binding(${t.binding.bindingIndex}) var<uniform> ${Jv} : ${e};
`,s}_processSamplers(e,t){const i=/var\s+(\w+Sampler)\s*:\s*(sampler|sampler_comparison)\s*;/gm;for(;;){const s=i.exec(e);if(s===null)break;const r=s[1],n=s[2],o=r.indexOf(Vt.AutoSamplerSuffix)===r.length-Vt.AutoSamplerSuffix.length?r.substring(0,r.indexOf(Vt.AutoSamplerSuffix)):null,l=n==="sampler_comparison"?jn.Comparison:jn.Filtering;if(o){const f=this._webgpuProcessingContext.availableTextures[o];f&&(f.autoBindSampler=!0)}let h=this._webgpuProcessingContext.availableSamplers[r];h||(h={binding:this._webgpuProcessingContext.getNextFreeUBOBinding(),type:l},this._webgpuProcessingContext.availableSamplers[r]=h),this._addSamplerBindingDescription(r,h,t);const c=e.substring(0,s.index),u=`@group(${h.binding.groupIndex}) @binding(${h.binding.bindingIndex}) `,d=e.substring(s.index);e=c+u+d,i.lastIndex+=u.length}return e}_processCustomBuffers(e,t){const i=/var<\s*(uniform|storage)\s*(,\s*(read|read_write)\s*)?>\s+(\S+)\s*:\s*(\S+)\s*;/gm;for(;;){const s=i.exec(e);if(s===null)break;const r=s[1],n=s[3];let o=s[4];const l=s[5];let h=this._webgpuProcessingContext.availableBuffers[o];if(!h){const _=r==="uniform"?qs.KnownUBOs[l]:null;let m;_?(o=l,m=_.binding,m.groupIndex===-1&&(m=this._webgpuProcessingContext.getNextFreeUBOBinding())):m=this._webgpuProcessingContext.getNextFreeUBOBinding(),h={binding:m},this._webgpuProcessingContext.availableBuffers[o]=h}this._addBufferBindingDescription(o,this._webgpuProcessingContext.availableBuffers[o],n==="read_write"?Wn.Storage:r==="storage"?Wn.ReadOnlyStorage:Wn.Uniform,t);const c=h.binding.groupIndex,u=h.binding.bindingIndex,d=e.substring(0,s.index),f=`@group(${c}) @binding(${u}) `,p=e.substring(s.index);e=d+f+p,i.lastIndex+=f.length}return e}_processStridedUniformArrays(e){for(const t of this._stridedUniformArrays)e=e.replace(new RegExp(`${t}\\s*\\[(.*)\\]`,"g"),`${t}[$1].el`);return e}}class Rh{constructor(e=null){this.format=w.RGBA8Unorm,this.textureUsages=0,this.textureAdditionalUsages=0,this._webgpuTexture=e,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}get underlyingResource(){return this._webgpuTexture}get msaaTexture(){return this._webgpuMSAATexture}set msaaTexture(e){this._webgpuMSAATexture=e}set(e){this._webgpuTexture=e}setUsage(e,t,i,s,r){t=e===We.RenderTarget?!1:t,this.createView({format:this.format,dimension:i?Mt.Cube:Mt.E2d,mipLevelCount:t?oe.ILog2(Math.max(s,r))+1:1,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:i?6:1,aspect:_n.All})}createView(e,t=!1){if(this.view=this._webgpuTexture.createView(e),t&&e){const i=e.mipLevelCount;e.mipLevelCount=1,this.viewForWriting=this._webgpuTexture.createView(e),e.mipLevelCount=i}}reset(){this._webgpuTexture=null,this._webgpuMSAATexture=null,this.view=null,this.viewForWriting=null}release(){var e,t,i;(e=this._webgpuTexture)===null||e===void 0||e.destroy(),(t=this._webgpuMSAATexture)===null||t===void 0||t.destroy(),(i=this._copyInvertYTempTexture)===null||i===void 0||i.destroy(),this.reset()}}const sx=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(location = 0) out vec2 vTex;

    void main() {
        vTex = tex[gl_VertexIndex];
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,rx=`
    layout(set = 0, binding = 0) uniform sampler imgSampler;
    layout(set = 0, binding = 1) uniform texture2D img;

    layout(location = 0) in vec2 vTex;
    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = texture(sampler2D(img, imgSampler), vTex);
    }
    `,u_=`
    #extension GL_EXT_samplerless_texture_functions : enable

    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));
    const vec2 tex[4] = vec2[4](vec2(0.0f, 0.0f), vec2(1.0f, 0.0f), vec2(0.0f, 1.0f), vec2(1.0f, 1.0f));

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) out flat ivec2 vTextureSize;
    #endif

    void main() {
        #ifdef INVERTY
            vTextureSize = textureSize(img, 0);
        #endif
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,nx=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, vTextureSize.y - gl_FragCoord.y), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,ax=u_,ox=`
    #extension GL_EXT_samplerless_texture_functions : enable

    layout(set = 0, binding = 0) uniform texture2D img;
    layout(set = 0, binding = 1) uniform Params {
        float ofstX;
        float ofstY;
        float width;
        float height;
    };

    #ifdef INVERTY
        layout(location = 0) in flat ivec2 vTextureSize;
    #endif
    layout(location = 0) out vec4 outColor;

    void main() {
        if (gl_FragCoord.x < ofstX || gl_FragCoord.x >= ofstX + width) {
            discard;
        }
        if (gl_FragCoord.y < ofstY || gl_FragCoord.y >= ofstY + height) {
            discard;
        }
    #ifdef INVERTY
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.x, ofstY + height - (gl_FragCoord.y - ofstY)), 0);
    #else
        vec4 color = texelFetch(img, ivec2(gl_FragCoord.xy), 0);
    #endif
    #ifdef PREMULTIPLYALPHA
        color.rgb *= color.a;
    #endif
        outColor = color;
    }
    `,lx=`
    const vec2 pos[4] = vec2[4](vec2(-1.0f, 1.0f), vec2(1.0f, 1.0f), vec2(-1.0f, -1.0f), vec2(1.0f, -1.0f));

    void main() {
        gl_Position = vec4(pos[gl_VertexIndex], 0.0, 1.0);
    }
    `,hx=`
    layout(set = 0, binding = 0) uniform Uniforms {
        uniform vec4 color;
    };

    layout(location = 0) out vec4 outColor;

    void main() {
        outColor = color;
    }
    `;var cr;(function(a){a[a.MipMap=0]="MipMap",a[a.InvertYPremultiplyAlpha=1]="InvertYPremultiplyAlpha",a[a.Clear=2]="Clear",a[a.InvertYPremultiplyAlphaWithOfst=3]="InvertYPremultiplyAlphaWithOfst"})(cr||(cr={}));const lf=[{vertex:sx,fragment:rx},{vertex:u_,fragment:nx},{vertex:lx,fragment:hx},{vertex:ax,fragment:ox}],ll={"":0,r8unorm:1,r8uint:2,r8sint:3,r16uint:4,r16sint:5,r16float:6,rg8unorm:7,rg8uint:8,rg8sint:9,r32uint:10,r32sint:11,r32float:12,rg16uint:13,rg16sint:14,rg16float:15,rgba8unorm:16,"rgba8unorm-srgb":17,rgba8uint:18,rgba8sint:19,bgra8unorm:20,"bgra8unorm-srgb":21,rgb10a2unorm:22,rg32uint:23,rg32sint:24,rg32float:25,rgba16uint:26,rgba16sint:27,rgba16float:28,rgba32uint:29,rgba32sint:30,rgba32float:31,stencil8:32,depth16unorm:33,depth24plus:34,"depth24plus-stencil8":35,depth32float:36,"depth24unorm-stencil8":37,"depth32float-stencil8":38};class Lt{constructor(e,t,i,s){this._pipelines={},this._compiledShaders=[],this._deferredReleaseTextures=[],this._device=e,this._glslang=t,this._tintWASM=i,this._bufferManager=s,this._mipmapSampler=e.createSampler({minFilter:st.Linear}),this._ubCopyWithOfst=this._bufferManager.createBuffer(4*4,Dt.Uniform|Dt.CopyDst).underlyingResource,this._getPipeline(w.RGBA8Unorm)}static ComputeNumMipmapLevels(e,t){return oe.ILog2(Math.max(e,t))+1}_getPipeline(e,t=cr.MipMap,i){const s=t===cr.MipMap?1:t===cr.InvertYPremultiplyAlpha?((i.invertY?1:0)<<1)+((i.premultiplyAlpha?1:0)<<2):t===cr.Clear?8:t===cr.InvertYPremultiplyAlphaWithOfst?((i.invertY?1:0)<<4)+((i.premultiplyAlpha?1:0)<<5):0;this._pipelines[e]||(this._pipelines[e]=[]);let r=this._pipelines[e][s];if(!r){let n=`#version 450\r
`;(t===cr.InvertYPremultiplyAlpha||t===cr.InvertYPremultiplyAlphaWithOfst)&&(i.invertY&&(n+=`#define INVERTY\r
`),i.premultiplyAlpha&&(n+=`#define PREMULTIPLYALPHA\r
`));let o=this._compiledShaders[s];if(!o){let h=this._glslang.compileGLSL(n+lf[t].vertex,"vertex"),c=this._glslang.compileGLSL(n+lf[t].fragment,"fragment");this._tintWASM&&(h=this._tintWASM.convertSpirV2WGSL(h),c=this._tintWASM.convertSpirV2WGSL(c));const u=this._device.createShaderModule({code:h}),d=this._device.createShaderModule({code:c});o=this._compiledShaders[s]=[u,d]}const l=this._device.createRenderPipeline({layout:Vh.Auto,vertex:{module:o[0],entryPoint:"main"},fragment:{module:o[1],entryPoint:"main",targets:[{format:e}]},primitive:{topology:Ys.TriangleStrip,stripIndexFormat:Fa.Uint16}});r=this._pipelines[e][s]=[l,l.getBindGroupLayout(0)]}return r}static _GetTextureTypeFromFormat(e){switch(e){case w.R8Unorm:case w.R8Snorm:case w.R8Uint:case w.R8Sint:case w.RG8Unorm:case w.RG8Snorm:case w.RG8Uint:case w.RG8Sint:case w.RGBA8Unorm:case w.RGBA8UnormSRGB:case w.RGBA8Snorm:case w.RGBA8Uint:case w.RGBA8Sint:case w.BGRA8Unorm:case w.BGRA8UnormSRGB:case w.RGB10A2Unorm:case w.RGB9E5UFloat:case w.RG11B10UFloat:case w.Depth24UnormStencil8:case w.Depth32FloatStencil8:case w.BC7RGBAUnorm:case w.BC7RGBAUnormSRGB:case w.BC6HRGBUFloat:case w.BC6HRGBFloat:case w.BC5RGUnorm:case w.BC5RGSnorm:case w.BC3RGBAUnorm:case w.BC3RGBAUnormSRGB:case w.BC2RGBAUnorm:case w.BC2RGBAUnormSRGB:case w.BC4RUnorm:case w.BC4RSnorm:case w.BC1RGBAUnorm:case w.BC1RGBAUnormSRGB:case w.ETC2RGB8Unorm:case w.ETC2RGB8UnormSRGB:case w.ETC2RGB8A1Unorm:case w.ETC2RGB8A1UnormSRGB:case w.ETC2RGBA8Unorm:case w.ETC2RGBA8UnormSRGB:case w.EACR11Unorm:case w.EACR11Snorm:case w.EACRG11Unorm:case w.EACRG11Snorm:case w.ASTC4x4Unorm:case w.ASTC4x4UnormSRGB:case w.ASTC5x4Unorm:case w.ASTC5x4UnormSRGB:case w.ASTC5x5Unorm:case w.ASTC5x5UnormSRGB:case w.ASTC6x5Unorm:case w.ASTC6x5UnormSRGB:case w.ASTC6x6Unorm:case w.ASTC6x6UnormSRGB:case w.ASTC8x5Unorm:case w.ASTC8x5UnormSRGB:case w.ASTC8x6Unorm:case w.ASTC8x6UnormSRGB:case w.ASTC8x8Unorm:case w.ASTC8x8UnormSRGB:case w.ASTC10x5Unorm:case w.ASTC10x5UnormSRGB:case w.ASTC10x6Unorm:case w.ASTC10x6UnormSRGB:case w.ASTC10x8Unorm:case w.ASTC10x8UnormSRGB:case w.ASTC10x10Unorm:case w.ASTC10x10UnormSRGB:case w.ASTC12x10Unorm:case w.ASTC12x10UnormSRGB:case w.ASTC12x12Unorm:case w.ASTC12x12UnormSRGB:return 0;case w.R16Uint:case w.R16Sint:case w.RG16Uint:case w.RG16Sint:case w.RGBA16Uint:case w.RGBA16Sint:case w.Depth16Unorm:return 5;case w.R16Float:case w.RG16Float:case w.RGBA16Float:return 2;case w.R32Uint:case w.R32Sint:case w.RG32Uint:case w.RG32Sint:case w.RGBA32Uint:case w.RGBA32Sint:return 7;case w.R32Float:case w.RG32Float:case w.RGBA32Float:case w.Depth32Float:return 1;case w.Stencil8:throw"No fixed size for Stencil8 format!";case w.Depth24Plus:throw"No fixed size for Depth24Plus format!";case w.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!"}return 0}static _GetBlockInformationFromFormat(e){switch(e){case w.R8Unorm:case w.R8Snorm:case w.R8Uint:case w.R8Sint:return{width:1,height:1,length:1};case w.R16Uint:case w.R16Sint:case w.R16Float:case w.RG8Unorm:case w.RG8Snorm:case w.RG8Uint:case w.RG8Sint:return{width:1,height:1,length:2};case w.R32Uint:case w.R32Sint:case w.R32Float:case w.RG16Uint:case w.RG16Sint:case w.RG16Float:case w.RGBA8Unorm:case w.RGBA8UnormSRGB:case w.RGBA8Snorm:case w.RGBA8Uint:case w.RGBA8Sint:case w.BGRA8Unorm:case w.BGRA8UnormSRGB:case w.RGB9E5UFloat:case w.RGB10A2Unorm:case w.RG11B10UFloat:return{width:1,height:1,length:4};case w.RG32Uint:case w.RG32Sint:case w.RG32Float:case w.RGBA16Uint:case w.RGBA16Sint:case w.RGBA16Float:return{width:1,height:1,length:8};case w.RGBA32Uint:case w.RGBA32Sint:case w.RGBA32Float:return{width:1,height:1,length:16};case w.Stencil8:throw"No fixed size for Stencil8 format!";case w.Depth16Unorm:return{width:1,height:1,length:2};case w.Depth24Plus:throw"No fixed size for Depth24Plus format!";case w.Depth24PlusStencil8:throw"No fixed size for Depth24PlusStencil8 format!";case w.Depth32Float:return{width:1,height:1,length:4};case w.Depth24UnormStencil8:return{width:1,height:1,length:4};case w.Depth32FloatStencil8:return{width:1,height:1,length:5};case w.BC7RGBAUnorm:case w.BC7RGBAUnormSRGB:case w.BC6HRGBUFloat:case w.BC6HRGBFloat:case w.BC5RGUnorm:case w.BC5RGSnorm:case w.BC3RGBAUnorm:case w.BC3RGBAUnormSRGB:case w.BC2RGBAUnorm:case w.BC2RGBAUnormSRGB:return{width:4,height:4,length:16};case w.BC4RUnorm:case w.BC4RSnorm:case w.BC1RGBAUnorm:case w.BC1RGBAUnormSRGB:return{width:4,height:4,length:8};case w.ETC2RGB8Unorm:case w.ETC2RGB8UnormSRGB:case w.ETC2RGB8A1Unorm:case w.ETC2RGB8A1UnormSRGB:case w.EACR11Unorm:case w.EACR11Snorm:return{width:4,height:4,length:8};case w.ETC2RGBA8Unorm:case w.ETC2RGBA8UnormSRGB:case w.EACRG11Unorm:case w.EACRG11Snorm:return{width:4,height:4,length:16};case w.ASTC4x4Unorm:case w.ASTC4x4UnormSRGB:return{width:4,height:4,length:16};case w.ASTC5x4Unorm:case w.ASTC5x4UnormSRGB:return{width:5,height:4,length:16};case w.ASTC5x5Unorm:case w.ASTC5x5UnormSRGB:return{width:5,height:5,length:16};case w.ASTC6x5Unorm:case w.ASTC6x5UnormSRGB:return{width:6,height:5,length:16};case w.ASTC6x6Unorm:case w.ASTC6x6UnormSRGB:return{width:6,height:6,length:16};case w.ASTC8x5Unorm:case w.ASTC8x5UnormSRGB:return{width:8,height:5,length:16};case w.ASTC8x6Unorm:case w.ASTC8x6UnormSRGB:return{width:8,height:6,length:16};case w.ASTC8x8Unorm:case w.ASTC8x8UnormSRGB:return{width:8,height:8,length:16};case w.ASTC10x5Unorm:case w.ASTC10x5UnormSRGB:return{width:10,height:5,length:16};case w.ASTC10x6Unorm:case w.ASTC10x6UnormSRGB:return{width:10,height:6,length:16};case w.ASTC10x8Unorm:case w.ASTC10x8UnormSRGB:return{width:10,height:8,length:16};case w.ASTC10x10Unorm:case w.ASTC10x10UnormSRGB:return{width:10,height:10,length:16};case w.ASTC12x10Unorm:case w.ASTC12x10UnormSRGB:return{width:12,height:10,length:16};case w.ASTC12x12Unorm:case w.ASTC12x12UnormSRGB:return{width:12,height:12,length:16}}return{width:1,height:1,length:4}}static _IsHardwareTexture(e){return!!e.release}static _IsInternalTexture(e){return!!e.dispose}static IsImageBitmap(e){return e.close!==void 0}static IsImageBitmapArray(e){return Array.isArray(e)&&e[0].close!==void 0}setCommandEncoder(e){this._commandEncoderForCreation=e}static IsCompressedFormat(e){switch(e){case w.BC7RGBAUnormSRGB:case w.BC7RGBAUnorm:case w.BC6HRGBFloat:case w.BC6HRGBUFloat:case w.BC5RGSnorm:case w.BC5RGUnorm:case w.BC4RSnorm:case w.BC4RUnorm:case w.BC3RGBAUnormSRGB:case w.BC3RGBAUnorm:case w.BC2RGBAUnormSRGB:case w.BC2RGBAUnorm:case w.BC1RGBAUnormSRGB:case w.BC1RGBAUnorm:case w.ETC2RGB8Unorm:case w.ETC2RGB8UnormSRGB:case w.ETC2RGB8A1Unorm:case w.ETC2RGB8A1UnormSRGB:case w.ETC2RGBA8Unorm:case w.ETC2RGBA8UnormSRGB:case w.EACR11Unorm:case w.EACR11Snorm:case w.EACRG11Unorm:case w.EACRG11Snorm:case w.ASTC4x4Unorm:case w.ASTC4x4UnormSRGB:case w.ASTC5x4Unorm:case w.ASTC5x4UnormSRGB:case w.ASTC5x5Unorm:case w.ASTC5x5UnormSRGB:case w.ASTC6x5Unorm:case w.ASTC6x5UnormSRGB:case w.ASTC6x6Unorm:case w.ASTC6x6UnormSRGB:case w.ASTC8x5Unorm:case w.ASTC8x5UnormSRGB:case w.ASTC8x6Unorm:case w.ASTC8x6UnormSRGB:case w.ASTC8x8Unorm:case w.ASTC8x8UnormSRGB:case w.ASTC10x5Unorm:case w.ASTC10x5UnormSRGB:case w.ASTC10x6Unorm:case w.ASTC10x6UnormSRGB:case w.ASTC10x8Unorm:case w.ASTC10x8UnormSRGB:case w.ASTC10x10Unorm:case w.ASTC10x10UnormSRGB:case w.ASTC12x10Unorm:case w.ASTC12x10UnormSRGB:case w.ASTC12x12Unorm:case w.ASTC12x12UnormSRGB:return!0}return!1}static GetWebGPUTextureFormat(e,t,i=!1){switch(t){case 15:return w.Depth16Unorm;case 16:return w.Depth24Plus;case 13:return w.Depth24PlusStencil8;case 14:return w.Depth32Float;case 17:return w.Depth24UnormStencil8;case 18:return w.Depth32FloatStencil8;case 36492:return i?w.BC7RGBAUnormSRGB:w.BC7RGBAUnorm;case 36495:return w.BC6HRGBUFloat;case 36494:return w.BC6HRGBFloat;case 33779:return i?w.BC3RGBAUnormSRGB:w.BC3RGBAUnorm;case 33778:return i?w.BC2RGBAUnormSRGB:w.BC2RGBAUnorm;case 33777:case 33776:return i?w.BC1RGBAUnormSRGB:w.BC1RGBAUnorm;case 37808:return i?w.ASTC4x4UnormSRGB:w.ASTC4x4Unorm;case 36196:case 37492:return i?w.ETC2RGB8UnormSRGB:w.ETC2RGB8Unorm;case 37496:return i?w.ETC2RGBA8UnormSRGB:w.ETC2RGBA8Unorm}switch(e){case 3:switch(t){case 6:return w.R8Snorm;case 7:return w.RG8Snorm;case 4:throw"RGB format not supported in WebGPU";case 8:return w.R8Sint;case 9:return w.RG8Sint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return w.RGBA8Sint;default:return w.RGBA8Snorm}case 0:switch(t){case 6:return w.R8Unorm;case 7:return w.RG8Unorm;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return i?w.RGBA8UnormSRGB:w.RGBA8Unorm;case 12:return i?w.BGRA8UnormSRGB:w.BGRA8Unorm;case 8:return w.R8Uint;case 9:return w.RG8Uint;case 10:throw"RGB_INTEGER format not supported in WebGPU";case 11:return w.RGBA8Uint;case 0:throw"TEXTUREFORMAT_ALPHA format not supported in WebGPU";case 1:throw"TEXTUREFORMAT_LUMINANCE format not supported in WebGPU";case 2:throw"TEXTUREFORMAT_LUMINANCE_ALPHA format not supported in WebGPU";default:return w.RGBA8Unorm}case 4:switch(t){case 8:return w.R16Sint;case 9:return w.RG16Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return w.RGBA16Sint;default:return w.RGBA16Sint}case 5:switch(t){case 8:return w.R16Uint;case 9:return w.RG16Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return w.RGBA16Uint;default:return w.RGBA16Uint}case 6:switch(t){case 8:return w.R32Sint;case 9:return w.RG32Sint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return w.RGBA32Sint;default:return w.RGBA32Sint}case 7:switch(t){case 8:return w.R32Uint;case 9:return w.RG32Uint;case 10:throw"TEXTUREFORMAT_RGB_INTEGER format not supported in WebGPU";case 11:return w.RGBA32Uint;default:return w.RGBA32Uint}case 1:switch(t){case 6:return w.R32Float;case 7:return w.RG32Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return w.RGBA32Float;default:return w.RGBA32Float}case 2:switch(t){case 6:return w.R16Float;case 7:return w.RG16Float;case 4:throw"TEXTUREFORMAT_RGB format not supported in WebGPU";case 5:return w.RGBA16Float;default:return w.RGBA16Float}case 10:throw"TEXTURETYPE_UNSIGNED_SHORT_5_6_5 format not supported in WebGPU";case 13:throw"TEXTURETYPE_UNSIGNED_INT_10F_11F_11F_REV format not supported in WebGPU";case 14:throw"TEXTURETYPE_UNSIGNED_INT_5_9_9_9_REV format not supported in WebGPU";case 8:throw"TEXTURETYPE_UNSIGNED_SHORT_4_4_4_4 format not supported in WebGPU";case 9:throw"TEXTURETYPE_UNSIGNED_SHORT_5_5_5_1 format not supported in WebGPU";case 11:switch(t){case 5:return w.RGB10A2Unorm;case 11:throw"TEXTUREFORMAT_RGBA_INTEGER format not supported in WebGPU when type is TEXTURETYPE_UNSIGNED_INT_2_10_10_10_REV";default:return w.RGB10A2Unorm}}return i?w.RGBA8UnormSRGB:w.RGBA8Unorm}static GetNumChannelsFromWebGPUTextureFormat(e){switch(e){case w.R8Unorm:case w.R8Snorm:case w.R8Uint:case w.R8Sint:case w.BC4RUnorm:case w.BC4RSnorm:case w.R16Uint:case w.R16Sint:case w.Depth16Unorm:case w.R16Float:case w.R32Uint:case w.R32Sint:case w.R32Float:case w.Depth32Float:case w.Stencil8:case w.Depth24Plus:case w.EACR11Unorm:case w.EACR11Snorm:return 1;case w.RG8Unorm:case w.RG8Snorm:case w.RG8Uint:case w.RG8Sint:case w.Depth24UnormStencil8:case w.Depth32FloatStencil8:case w.BC5RGUnorm:case w.BC5RGSnorm:case w.RG16Uint:case w.RG16Sint:case w.RG16Float:case w.RG32Uint:case w.RG32Sint:case w.RG32Float:case w.Depth24PlusStencil8:case w.EACRG11Unorm:case w.EACRG11Snorm:return 2;case w.RGB9E5UFloat:case w.RG11B10UFloat:case w.BC6HRGBUFloat:case w.BC6HRGBFloat:case w.ETC2RGB8Unorm:case w.ETC2RGB8UnormSRGB:return 3;case w.RGBA8Unorm:case w.RGBA8UnormSRGB:case w.RGBA8Snorm:case w.RGBA8Uint:case w.RGBA8Sint:case w.BGRA8Unorm:case w.BGRA8UnormSRGB:case w.RGB10A2Unorm:case w.BC7RGBAUnorm:case w.BC7RGBAUnormSRGB:case w.BC3RGBAUnorm:case w.BC3RGBAUnormSRGB:case w.BC2RGBAUnorm:case w.BC2RGBAUnormSRGB:case w.BC1RGBAUnorm:case w.BC1RGBAUnormSRGB:case w.RGBA16Uint:case w.RGBA16Sint:case w.RGBA16Float:case w.RGBA32Uint:case w.RGBA32Sint:case w.RGBA32Float:case w.ETC2RGB8A1Unorm:case w.ETC2RGB8A1UnormSRGB:case w.ETC2RGBA8Unorm:case w.ETC2RGBA8UnormSRGB:case w.ASTC4x4Unorm:case w.ASTC4x4UnormSRGB:case w.ASTC5x4Unorm:case w.ASTC5x4UnormSRGB:case w.ASTC5x5Unorm:case w.ASTC5x5UnormSRGB:case w.ASTC6x5Unorm:case w.ASTC6x5UnormSRGB:case w.ASTC6x6Unorm:case w.ASTC6x6UnormSRGB:case w.ASTC8x5Unorm:case w.ASTC8x5UnormSRGB:case w.ASTC8x6Unorm:case w.ASTC8x6UnormSRGB:case w.ASTC8x8Unorm:case w.ASTC8x8UnormSRGB:case w.ASTC10x5Unorm:case w.ASTC10x5UnormSRGB:case w.ASTC10x6Unorm:case w.ASTC10x6UnormSRGB:case w.ASTC10x8Unorm:case w.ASTC10x8UnormSRGB:case w.ASTC10x10Unorm:case w.ASTC10x10UnormSRGB:case w.ASTC12x10Unorm:case w.ASTC12x10UnormSRGB:case w.ASTC12x12Unorm:case w.ASTC12x12UnormSRGB:return 4}throw`Unknown format ${e}!`}static HasStencilAspect(e){switch(e){case w.Stencil8:case w.Depth24UnormStencil8:case w.Depth32FloatStencil8:case w.Depth24PlusStencil8:return!0}return!1}static HasDepthAndStencilAspects(e){switch(e){case w.Depth24UnormStencil8:case w.Depth32FloatStencil8:case w.Depth24PlusStencil8:return!0}return!1}invertYPreMultiplyAlpha(e,t,i,s,r=!1,n=!1,o=0,l=0,h=1,c=0,u=0,d=0,f=0,p,_){var m,v,x,b,S,C;const E=d!==0,A=p===void 0,[M,D]=this._getPipeline(s,E?cr.InvertYPremultiplyAlphaWithOfst:cr.InvertYPremultiplyAlpha,{invertY:r,premultiplyAlpha:n});o=Math.max(o,0),A&&(p=this._device.createCommandEncoder({})),(v=(m=p).pushDebugGroup)===null||v===void 0||v.call(m,`internal process texture - invertY=${r} premultiplyAlpha=${n}`);let P;if(Lt._IsHardwareTexture(e)?(P=e.underlyingResource,r&&!n&&h===1&&o===0||(e=void 0)):(P=e,e=void 0),!P)return;E&&this._bufferManager.setRawData(this._ubCopyWithOfst,0,new Float32Array([c,u,d,f]),0,4*4);const O=e,N=(x=O==null?void 0:O._copyInvertYTempTexture)!==null&&x!==void 0?x:this.createTexture({width:t,height:i,layers:1},!1,!1,!1,!1,!1,s,1,p,Ft.CopySrc|Ft.RenderAttachment|Ft.TextureBinding),$=(b=O==null?void 0:O._copyInvertYRenderPassDescr)!==null&&b!==void 0?b:{colorAttachments:[{view:N.createView({format:s,dimension:Mt.E2d,baseMipLevel:0,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:0}),loadOp:Ci.Load,storeOp:dr.Store}]},W=p.beginRenderPass($);let K=E?O==null?void 0:O._copyInvertYBindGroupWithOfst:O==null?void 0:O._copyInvertYBindGroup;if(!K){const te={layout:D,entries:[{binding:0,resource:P.createView({format:s,dimension:Mt.E2d,baseMipLevel:l,mipLevelCount:1,arrayLayerCount:h,baseArrayLayer:o})}]};E&&te.entries.push({binding:1,resource:{buffer:this._ubCopyWithOfst}}),K=this._device.createBindGroup(te)}W.setPipeline(M),W.setBindGroup(0,K),W.draw(4,1,0,0),W.end(),p.copyTextureToTexture({texture:N},{texture:P,mipLevel:l,origin:{x:0,y:0,z:o}},{width:t,height:i,depthOrArrayLayers:1}),O?(O._copyInvertYTempTexture=N,O._copyInvertYRenderPassDescr=$,E?O._copyInvertYBindGroupWithOfst=K:O._copyInvertYBindGroup=K):this._deferredReleaseTextures.push([N,null]),(C=(S=p).popDebugGroup)===null||C===void 0||C.call(S),A&&(this._device.queue.submit([p.finish()]),p=null)}copyWithInvertY(e,t,i,s){var r,n,o,l;const h=s===void 0,[c,u]=this._getPipeline(t,cr.InvertYPremultiplyAlpha,{invertY:!0,premultiplyAlpha:!1});h&&(s=this._device.createCommandEncoder({})),(n=(r=s).pushDebugGroup)===null||n===void 0||n.call(r,"internal copy texture with invertY");const d=s.beginRenderPass(i),f=this._device.createBindGroup({layout:u,entries:[{binding:0,resource:e}]});d.setPipeline(c),d.setBindGroup(0,f),d.draw(4,1,0,0),d.end(),(l=(o=s).popDebugGroup)===null||l===void 0||l.call(o),h&&(this._device.queue.submit([s.finish()]),s=null)}createTexture(e,t=!1,i=!1,s=!1,r=!1,n=!1,o=w.RGBA8Unorm,l=1,h,c=-1,u=0){l>1&&(l=4);const d=e.layers||1,f={width:e.width,height:e.height,depthOrArrayLayers:d},p=Lt.IsCompressedFormat(o),_=t?Lt.ComputeNumMipmapLevels(e.width,e.height):1,m=c>=0?c:Ft.CopySrc|Ft.CopyDst|Ft.TextureBinding;u|=t&&!p?Ft.CopySrc|Ft.RenderAttachment:0,!p&&!n&&(u|=Ft.RenderAttachment|Ft.CopyDst);const v=this._device.createTexture({size:f,dimension:n?Vn.E3d:Vn.E2d,format:o,usage:m|u,sampleCount:l,mipLevelCount:_});return Lt.IsImageBitmap(e)&&(this.updateTexture(e,v,e.width,e.height,d,o,0,0,s,r,0,0),t&&i&&this.generateMipmaps(v,o,_,0,h)),v}createCubeTexture(e,t=!1,i=!1,s=!1,r=!1,n=w.RGBA8Unorm,o=1,l,h=-1,c=0){o>1&&(o=4);const u=Lt.IsImageBitmapArray(e)?e[0].width:e.width,d=Lt.IsImageBitmapArray(e)?e[0].height:e.height,f=Lt.IsCompressedFormat(n),p=t?Lt.ComputeNumMipmapLevels(u,d):1,_=h>=0?h:Ft.CopySrc|Ft.CopyDst|Ft.TextureBinding;c|=t&&!f?Ft.CopySrc|Ft.RenderAttachment:0,f||(c|=Ft.RenderAttachment|Ft.CopyDst);const m=this._device.createTexture({size:{width:u,height:d,depthOrArrayLayers:6},dimension:Vn.E2d,format:n,usage:_|c,sampleCount:o,mipLevelCount:p});return Lt.IsImageBitmapArray(e)&&(this.updateCubeTextures(e,m,u,d,n,s,r,0,0),t&&i&&this.generateCubeMipmaps(m,n,p,l)),m}generateCubeMipmaps(e,t,i,s){var r,n,o,l;const h=s===void 0;h&&(s=this._device.createCommandEncoder({})),(n=(r=s).pushDebugGroup)===null||n===void 0||n.call(r,`create cube mipmaps - ${i} levels`);for(let c=0;c<6;++c)this.generateMipmaps(e,t,i,c,s);(l=(o=s).popDebugGroup)===null||l===void 0||l.call(o),h&&(this._device.queue.submit([s.finish()]),s=null)}generateMipmaps(e,t,i,s=0,r){var n,o,l,h,c,u,d,f;const p=r===void 0,[_,m]=this._getPipeline(t);s=Math.max(s,0),p&&(r=this._device.createCommandEncoder({})),(o=(n=r).pushDebugGroup)===null||o===void 0||o.call(n,`create mipmaps for face #${s} - ${i} levels`);let v;if(Lt._IsHardwareTexture(e)?(v=e.underlyingResource,e._mipmapGenRenderPassDescr=e._mipmapGenRenderPassDescr||[],e._mipmapGenBindGroup=e._mipmapGenBindGroup||[]):(v=e,e=void 0),!v)return;const x=e;for(let b=1;b<i;++b){const S=(h=(l=x==null?void 0:x._mipmapGenRenderPassDescr[s])===null||l===void 0?void 0:l[b-1])!==null&&h!==void 0?h:{colorAttachments:[{view:v.createView({format:t,dimension:Mt.E2d,baseMipLevel:b,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s}),loadOp:Ci.Load,storeOp:dr.Store}]};x&&(x._mipmapGenRenderPassDescr[s]=x._mipmapGenRenderPassDescr[s]||[],x._mipmapGenRenderPassDescr[s][b-1]=S);const C=r.beginRenderPass(S),E=(u=(c=x==null?void 0:x._mipmapGenBindGroup[s])===null||c===void 0?void 0:c[b-1])!==null&&u!==void 0?u:this._device.createBindGroup({layout:m,entries:[{binding:0,resource:this._mipmapSampler},{binding:1,resource:v.createView({format:t,dimension:Mt.E2d,baseMipLevel:b-1,mipLevelCount:1,arrayLayerCount:1,baseArrayLayer:s})}]});x&&(x._mipmapGenBindGroup[s]=x._mipmapGenBindGroup[s]||[],x._mipmapGenBindGroup[s][b-1]=E),C.setPipeline(_),C.setBindGroup(0,E),C.draw(4,1,0,0),C.end()}(f=(d=r).popDebugGroup)===null||f===void 0||f.call(d),p&&(this._device.queue.submit([r.finish()]),r=null)}createGPUTextureForInternalTexture(e,t,i,s,r){e._hardwareTexture||(e._hardwareTexture=new Rh),t===void 0&&(t=e.width),i===void 0&&(i=e.height),s===void 0&&(s=e.depth);const n=e._hardwareTexture,o=((r!=null?r:0)&1)!==0;n.format=Lt.GetWebGPUTextureFormat(e.type,e.format,e._useSRGBBuffer),n.textureUsages=e._source===We.RenderTarget||e.source===We.MultiRenderTarget?Ft.TextureBinding|Ft.CopySrc|Ft.RenderAttachment:e._source===We.DepthStencil?Ft.TextureBinding|Ft.RenderAttachment:-1,n.textureAdditionalUsages=o?Ft.StorageBinding:0;const l=e.generateMipMaps,h=s||1;let c;if(e._maxLodLevel!==null?c=e._maxLodLevel:c=l?Lt.ComputeNumMipmapLevels(t,i):1,e.isCube){const u=this.createCubeTexture({width:t,height:i},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,n.format,1,this._commandEncoderForCreation,n.textureUsages,n.textureAdditionalUsages);n.set(u),n.createView({format:n.format,dimension:Mt.Cube,mipLevelCount:c,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:6,aspect:Lt.HasDepthAndStencilAspects(n.format)?_n.DepthOnly:_n.All},o)}else{const u=this.createTexture({width:t,height:i,layers:h},e.generateMipMaps,e.generateMipMaps,e.invertY,!1,e.is3D,n.format,1,this._commandEncoderForCreation,n.textureUsages,n.textureAdditionalUsages);n.set(u),n.createView({format:n.format,dimension:e.is2DArray?Mt.E2dArray:e.is3D?Vn.E3d:Mt.E2d,mipLevelCount:c,baseArrayLayer:0,baseMipLevel:0,arrayLayerCount:e.is3D?1:h,aspect:Lt.HasDepthAndStencilAspects(n.format)?_n.DepthOnly:_n.All},o)}return e.width=e.baseWidth=t,e.height=e.baseHeight=i,e.depth=e.baseDepth=s,this.createMSAATexture(e,e.samples),n}createMSAATexture(e,t){const i=e._hardwareTexture;if(i!=null&&i.msaaTexture&&(this.releaseTexture(i.msaaTexture),i.msaaTexture=null),!i||(t!=null?t:1)<=1)return;const s=e.width,r=e.height,n=e.depth||1;if(e.isCube){const o=this.createCubeTexture({width:s,height:r},!1,!1,e.invertY,!1,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=o}else{const o=this.createTexture({width:s,height:r,layers:n},!1,!1,e.invertY,!1,e.is3D,i.format,t,this._commandEncoderForCreation,i.textureUsages,i.textureAdditionalUsages);i.msaaTexture=o}}updateCubeTextures(e,t,i,s,r,n=!1,o=!1,l=0,h=0){const c=[0,3,1,4,2,5];for(let u=0;u<c.length;++u){const d=e[c[u]];this.updateTexture(d,t,i,s,1,r,u,0,n,o,l,h)}}updateTexture(e,t,i,s,r,n,o=0,l=0,h=!1,c=!1,u=0,d=0,f){const p=Lt._IsInternalTexture(t)?t._hardwareTexture.underlyingResource:t,_=Lt._GetBlockInformationFromFormat(n),m=Lt._IsInternalTexture(t)?t._hardwareTexture:t,v={texture:p,origin:{x:u,y:d,z:Math.max(o,0)},mipLevel:l,premultipliedAlpha:c},x={width:Math.ceil(i/_.width)*_.width,height:Math.ceil(s/_.height)*_.height,depthOrArrayLayers:r||1};if(e.byteLength!==void 0){e=e;const b=Math.ceil(i/_.width)*_.length;if(Math.ceil(b/256)*256===b){const C=this._device.createCommandEncoder({}),E=this._bufferManager.createRawBuffer(e.byteLength,Dt.MapWrite|Dt.CopySrc,!0),A=E.getMappedRange();new Uint8Array(A).set(e),E.unmap(),C.copyBufferToTexture({buffer:E,offset:0,bytesPerRow:b,rowsPerImage:s},v,x),this._device.queue.submit([C.finish()]),this._bufferManager.releaseBuffer(E)}else this._device.queue.writeTexture(v,e,{offset:0,bytesPerRow:b,rowsPerImage:s},x);if(h||c)if(Lt._IsInternalTexture(t)){const C=u===0&&d===0&&i===t.width&&s===t.height;this.invertYPreMultiplyAlpha(m,t.width,t.height,n,h,c,o,l,r||1,u,d,C?0:i,C?0:s,void 0,f)}else throw"updateTexture: Can't process the texture data because a GPUTexture was provided instead of an InternalTexture!"}else if(e=e,h)if(v.premultipliedAlpha=!1,Lt._IsInternalTexture(t)&&u===0&&d===0&&i===t.width&&s===t.height)this._device.queue.copyExternalImageToTexture({source:e},v,x),this.invertYPreMultiplyAlpha(m,i,s,n,h,c,o,l,r||1,0,0,0,0,void 0,f);else{const b=this._device.createCommandEncoder({}),S=this.createTexture({width:i,height:s,layers:1},!1,!1,!1,!1,!1,n,1,b,Ft.CopySrc|Ft.TextureBinding);this._deferredReleaseTextures.push([S,null]),x.depthOrArrayLayers=1,this._device.queue.copyExternalImageToTexture({source:e},{texture:S},x),x.depthOrArrayLayers=r||1,this.invertYPreMultiplyAlpha(S,i,s,n,h,c,o,l,r||1,0,0,0,0,b,f),b.copyTextureToTexture({texture:S},v,x),this._device.queue.submit([b.finish()])}else this._device.queue.copyExternalImageToTexture({source:e},v,x)}readPixels(e,t,i,s,r,n,o=0,l=0,h=null,c=!1){const u=Lt._GetBlockInformationFromFormat(n),d=Math.ceil(s/u.width)*u.length,f=Math.ceil(d/256)*256,p=f*r,_=this._bufferManager.createRawBuffer(p,Dt.MapRead|Dt.CopyDst),m=this._device.createCommandEncoder({});return m.copyTextureToBuffer({texture:e,mipLevel:l,origin:{x:t,y:i,z:Math.max(o,0)}},{buffer:_,offset:0,bytesPerRow:f},{width:s,height:r,depthOrArrayLayers:1}),this._device.queue.submit([m.finish()]),this._bufferManager.readDataFromBuffer(_,p,s,r,d,f,Lt._GetTextureTypeFromFormat(n),0,h,!0,c)}releaseTexture(e){if(Lt._IsInternalTexture(e)){const t=e._hardwareTexture,i=e._irradianceTexture;this._deferredReleaseTextures.push([t,i])}else this._deferredReleaseTextures.push([e,null])}destroyDeferredTextures(){for(let e=0;e<this._deferredReleaseTextures.length;++e){const[t,i]=this._deferredReleaseTextures[e];t&&(Lt._IsHardwareTexture(t)?t.release():t.destroy()),i==null||i.dispose()}this._deferredReleaseTextures.length=0}}class cx extends Ga{constructor(e){super(),this._buffer=e}get underlyingResource(){return this._buffer}}function T(a,e,t,i){var s=arguments.length,r=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,n;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")r=Reflect.decorate(a,e,t,i);else for(var o=a.length-1;o>=0;o--)(n=a[o])&&(r=(s<3?n(r):s>3?n(e,t,r):n(e,t))||r);return s>3&&r&&Object.defineProperty(e,t,r),r}class Ta{static Eval(e,t){return e.match(/\([^()]*\)/g)?e=e.replace(/\([^()]*\)/g,i=>(i=i.slice(1,i.length-1),Ta._HandleParenthesisContent(i,t))):e=Ta._HandleParenthesisContent(e,t),e==="true"?!0:e==="false"?!1:Ta.Eval(e,t)}static _HandleParenthesisContent(e,t){t=t||(r=>r==="true");let i;const s=e.split("||");for(const r in s)if(Object.prototype.hasOwnProperty.call(s,r)){let n=Ta._SimplifyNegation(s[r].trim());const o=n.split("&&");if(o.length>1)for(let l=0;l<o.length;++l){const h=Ta._SimplifyNegation(o[l].trim());if(h!=="true"&&h!=="false"?h[0]==="!"?i=!t(h.substring(1)):i=t(h):i=h==="true",!i){n="false";break}}if(i||n==="true"){i=!0;break}n!=="true"&&n!=="false"?n[0]==="!"?i=!t(n.substring(1)):i=t(n):i=n==="true"}return i?"true":"false"}static _SimplifyNegation(e){return e=e.replace(/^[\s!]+/,t=>(t=t.replace(/[\s]/g,()=>""),t.length%2?"!":"")),e=e.trim(),e==="!true"?e="false":e==="!false"&&(e="true"),e}}class ot{static EnableFor(e){e._tags=e._tags||{},e.hasTags=()=>ot.HasTags(e),e.addTags=t=>ot.AddTagsTo(e,t),e.removeTags=t=>ot.RemoveTagsFrom(e,t),e.matchesTagsQuery=t=>ot.MatchesQuery(e,t)}static DisableFor(e){delete e._tags,delete e.hasTags,delete e.addTags,delete e.removeTags,delete e.matchesTagsQuery}static HasTags(e){if(!e._tags)return!1;const t=e._tags;for(const i in t)if(Object.prototype.hasOwnProperty.call(t,i))return!0;return!1}static GetTags(e,t=!0){if(!e._tags)return null;if(t){const i=[];for(const s in e._tags)Object.prototype.hasOwnProperty.call(e._tags,s)&&e._tags[s]===!0&&i.push(s);return i.join(" ")}else return e._tags}static AddTagsTo(e,t){if(!t||typeof t!="string")return;t.split(" ").forEach(function(s){ot._AddTagTo(e,s)})}static _AddTagTo(e,t){t=t.trim(),!(t===""||t==="true"||t==="false")&&(t.match(/[\s]/)||t.match(/^([!]|([|]|[&]){2})/)||(ot.EnableFor(e),e._tags[t]=!0))}static RemoveTagsFrom(e,t){if(!ot.HasTags(e))return;const i=t.split(" ");for(const s in i)ot._RemoveTagFrom(e,i[s])}static _RemoveTagFrom(e,t){delete e._tags[t]}static MatchesQuery(e,t){return t===void 0?!0:t===""?ot.HasTags(e):Ta.Eval(t,i=>ot.HasTags(e)&&e._tags[i])}}const Ih={},mh={},hf=function(a,e,t){const i=a();ot&&ot.AddTagsTo(i,e.tags);const s=Qu(i);for(const r in s){const n=s[r],o=e[r],l=n.type;if(o!=null&&(r!=="uniqueId"||xe.AllowLoadingUniqueId))switch(l){case 0:case 6:case 11:i[r]=o;break;case 1:i[r]=t||o.isRenderTarget?o:o.clone();break;case 2:case 3:case 4:case 5:case 7:case 10:case 12:i[r]=t?o:o.clone();break}}return i};function ux(a){const e=a.getClassName();return Ih[e]||(Ih[e]={}),Ih[e]}function Qu(a){const e=a.getClassName();if(mh[e])return mh[e];mh[e]={};const t=mh[e];let i=a,s=e;for(;s;){const r=Ih[s];for(const l in r)t[l]=r[l];let n,o=!1;do{if(n=Object.getPrototypeOf(i),!n.getClassName){o=!0;break}if(n.getClassName()!==s)break;i=n}while(n);if(o)break;s=n.getClassName(),i=n}return t}function sr(a,e){return(t,i)=>{const s=ux(t);s[i]||(s[i]={type:a,sourceName:e})}}function dx(a,e=null){return(t,i)=>{const s=e||"_"+i;Object.defineProperty(t,i,{get:function(){return this[s]},set:function(r){typeof this.equals=="function"&&this.equals(r)||this[s]!==r&&(this[s]=r,t[a].apply(this))},enumerable:!0,configurable:!0})}}function ie(a,e=null){return dx(a,e)}function R(a){return sr(0,a)}function Qe(a){return sr(1,a)}function pi(a){return sr(2,a)}function Hl(a){return sr(3,a)}function Dd(a){return sr(4,a)}function Zi(a){return sr(5,a)}function Xl(a){return sr(6,a)}function fx(a){return sr(7,a)}function Od(a){return sr(8,a)}function d_(a){return sr(9,a)}function px(a){return sr(10,a)}function f_(a){return sr(12,a)}function _x(a){return sr(11,a)}class xe{static AppendSerializedAnimations(e,t){if(e.animations){t.animations=[];for(let i=0;i<e.animations.length;i++){const s=e.animations[i];t.animations.push(s.serialize())}}}static Serialize(e,t){t||(t={}),ot&&(t.tags=ot.GetTags(e));const i=Qu(e);for(const s in i){const r=i[s],n=r.sourceName||s,o=r.type,l=e[s];if(l!=null&&(s!=="uniqueId"||xe.AllowLoadingUniqueId))switch(o){case 0:t[n]=l;break;case 1:t[n]=l.serialize();break;case 2:t[n]=l.asArray();break;case 3:t[n]=l.serialize();break;case 4:t[n]=l.asArray();break;case 5:t[n]=l.asArray();break;case 6:t[n]=l.id;break;case 7:t[n]=l.serialize();break;case 8:t[n]=l.asArray();break;case 9:t[n]=l.serialize();break;case 10:t[n]=l.asArray();break;case 11:t[n]=l.id;break;case 12:t[n]=l.asArray();break}}return t}static Parse(e,t,i,s=null){const r=e();s||(s=""),ot&&ot.AddTagsTo(r,t.tags);const n=Qu(r);for(const o in n){const l=n[o],h=t[l.sourceName||o],c=l.type;if(h!=null&&(o!=="uniqueId"||xe.AllowLoadingUniqueId)){const u=r;switch(c){case 0:u[o]=h;break;case 1:i&&(u[o]=xe._TextureParser(h,i,s));break;case 2:u[o]=re.FromArray(h);break;case 3:u[o]=xe._FresnelParametersParser(h);break;case 4:u[o]=le.FromArray(h);break;case 5:u[o]=g.FromArray(h);break;case 6:i&&(u[o]=i.getLastMeshById(h));break;case 7:u[o]=xe._ColorCurvesParser(h);break;case 8:u[o]=J.FromArray(h);break;case 9:u[o]=xe._ImageProcessingConfigurationParser(h);break;case 10:u[o]=Q.FromArray(h);break;case 11:i&&(u[o]=i.getCameraById(h));break;case 12:u[o]=L.FromArray(h);break}}}return r}static Clone(e,t){return hf(e,t,!1)}static Instanciate(e,t){return hf(e,t,!0)}}xe.AllowLoadingUniqueId=!1;xe._ImageProcessingConfigurationParser=a=>{throw Ve("ImageProcessingConfiguration")};xe._FresnelParametersParser=a=>{throw Ve("FresnelParameters")};xe._ColorCurvesParser=a=>{throw Ve("ColorCurves")};xe._TextureParser=(a,e,t)=>{throw Ve("Texture")};function Qn(a,e,t,i){const s=t.value;t.value=(...r)=>{let n=s;if(typeof _native<"u"&&_native[e]){const o=_native[e];i?n=(...l)=>i(...l)?o(...l):s(...l):n=o}return a[e]=n,n(...r)}}Qn.filter=function(a){return(e,t,i)=>Qn(e,t,i,a)};class tl{constructor(e){this._wrapU=1,this._wrapV=1,this.wrapR=1,this.anisotropicFilteringLevel=4,this.delayLoadState=0,this._texture=null,this._engine=null,this._cachedSize=js.Zero(),this._cachedBaseSize=js.Zero(),this._initialSamplingMode=2,this._texture=e,this._texture&&(this._engine=this._texture.getEngine())}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get coordinatesMode(){return 0}get isCube(){return this._texture?this._texture.isCube:!1}set isCube(e){!this._texture||(this._texture.isCube=e)}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}getClassName(){return"ThinTexture"}isReady(){return this.delayLoadState===4?(this.delayLoad(),!1):this._texture?this._texture.isReady:!1}delayLoad(){}getInternalTexture(){return this._texture}getSize(){if(this._texture){if(this._texture.width)return this._cachedSize.width=this._texture.width,this._cachedSize.height=this._texture.height,this._cachedSize;if(this._texture._size)return this._cachedSize.width=this._texture._size,this._cachedSize.height=this._texture._size,this._cachedSize}return this._cachedSize}getBaseSize(){return!this.isReady()||!this._texture?(this._cachedBaseSize.width=0,this._cachedBaseSize.height=0,this._cachedBaseSize):this._texture._size?(this._cachedBaseSize.width=this._texture._size,this._cachedBaseSize.height=this._texture._size,this._cachedBaseSize):(this._cachedBaseSize.width=this._texture.baseWidth,this._cachedBaseSize.height=this._texture.baseHeight,this._cachedBaseSize)}get samplingMode(){return this._texture?this._texture.samplingMode:this._initialSamplingMode}updateSamplingMode(e){this._texture&&this._engine&&this._engine.updateTextureSamplingMode(e,this._texture)}releaseInternalTexture(){this._texture&&(this._texture.dispose(),this._texture=null)}dispose(){this._texture&&(this.releaseInternalTexture(),this._engine=null)}}class dt extends tl{constructor(e,t=null){super(null),this.metadata=null,this.reservedDataStore=null,this._hasAlpha=!1,this._getAlphaFromRGB=!1,this.level=1,this._coordinatesIndex=0,this.optimizeUVAllocation=!0,this._coordinatesMode=0,this.wrapR=1,this.anisotropicFilteringLevel=dt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL,this._isCube=!1,this._gammaSpace=!0,this.invertZ=!1,this.lodLevelInAlpha=!1,this.isRenderTarget=!1,this._prefiltered=!1,this._forceSerialize=!1,this.animations=new Array,this.onDisposeObservable=new X,this._onDisposeObserver=null,this._scene=null,this._uid=null,this._parentContainer=null,this._loadingError=!1,e?dt._IsScene(e)?this._scene=e:this._engine=e:this._scene=ye.LastCreatedScene,this._scene&&(this.uniqueId=this._scene.getUniqueId(),this._scene.addTexture(this),this._engine=this._scene.getEngine()),this._texture=t,this._uid=null}set hasAlpha(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get hasAlpha(){return this._hasAlpha}set getAlphaFromRGB(e){this._getAlphaFromRGB!==e&&(this._getAlphaFromRGB=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get getAlphaFromRGB(){return this._getAlphaFromRGB}set coordinatesIndex(e){this._coordinatesIndex!==e&&(this._coordinatesIndex=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesIndex(){return this._coordinatesIndex}set coordinatesMode(e){this._coordinatesMode!==e&&(this._coordinatesMode=e,this._scene&&this._scene.markAllMaterialsAsDirty(1,t=>t.hasTexture(this)))}get coordinatesMode(){return this._coordinatesMode}get wrapU(){return this._wrapU}set wrapU(e){this._wrapU=e}get wrapV(){return this._wrapV}set wrapV(e){this._wrapV=e}get isCube(){return this._texture?this._texture.isCube:this._isCube}set isCube(e){this._texture?this._texture.isCube=e:this._isCube=e}get is3D(){return this._texture?this._texture.is3D:!1}set is3D(e){!this._texture||(this._texture.is3D=e)}get is2DArray(){return this._texture?this._texture.is2DArray:!1}set is2DArray(e){!this._texture||(this._texture.is2DArray=e)}get gammaSpace(){if(this._texture)this._texture._gammaSpace===null&&(this._texture._gammaSpace=this._gammaSpace);else return this._gammaSpace;return this._texture._gammaSpace&&!this._texture._useSRGBBuffer}set gammaSpace(e){if(this._texture){if(this._texture._gammaSpace===e)return;this._texture._gammaSpace=e}else{if(this._gammaSpace===e)return;this._gammaSpace=e}this._markAllSubMeshesAsTexturesDirty()}get isRGBD(){return this._texture!=null&&this._texture._isRGBD}set isRGBD(e){this._texture&&(this._texture._isRGBD=e)}get noMipmap(){return!1}get lodGenerationOffset(){return this._texture?this._texture._lodGenerationOffset:0}set lodGenerationOffset(e){this._texture&&(this._texture._lodGenerationOffset=e)}get lodGenerationScale(){return this._texture?this._texture._lodGenerationScale:0}set lodGenerationScale(e){this._texture&&(this._texture._lodGenerationScale=e)}get linearSpecularLOD(){return this._texture?this._texture._linearSpecularLOD:!1}set linearSpecularLOD(e){this._texture&&(this._texture._linearSpecularLOD=e)}get irradianceTexture(){return this._texture?this._texture._irradianceTexture:null}set irradianceTexture(e){this._texture&&(this._texture._irradianceTexture=e)}get uid(){return this._uid||(this._uid=Md()),this._uid}toString(){return this.name}getClassName(){return"BaseTexture"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get isBlocking(){return!0}get loadingError(){return this._loadingError}get errorObject(){return this._errorObject}getScene(){return this._scene}_getEngine(){return this._engine}checkTransformsAreIdentical(e){return e!==null}getTextureMatrix(){return L.IdentityReadOnly}getReflectionTextureMatrix(){return L.IdentityReadOnly}isReadyOrNotBlocking(){return!this.isBlocking||this.isReady()||this.loadingError}scale(e){}get canRescale(){return!1}_getFromCache(e,t,i,s,r,n){const o=this._getEngine();if(!o)return null;const l=o._getUseSRGBBuffer(!!r,t),h=o.getLoadedTexturesCache();for(let c=0;c<h.length;c++){const u=h[c];if((r===void 0||l===u._useSRGBBuffer)&&(s===void 0||s===u.invertY)&&u.url===e&&u.generateMipMaps===!t&&(!i||i===u.samplingMode)&&(n===void 0||n===u.isCube))return u.incrementReferences(),u}return null}_rebuild(){}clone(){return null}get textureType(){return this._texture&&this._texture.type!==void 0?this._texture.type:0}get textureFormat(){return this._texture&&this._texture.format!==void 0?this._texture.format:5}_markAllSubMeshesAsTexturesDirty(){const e=this.getScene();!e||e.markAllMaterialsAsDirty(1)}readPixels(e=0,t=0,i=null,s=!0,r=!1,n=0,o=0,l=Number.MAX_VALUE,h=Number.MAX_VALUE){if(!this._texture)return null;const c=this._getEngine();if(!c)return null;const u=this.getSize();let d=u.width,f=u.height;t!==0&&(d=d/Math.pow(2,t),f=f/Math.pow(2,t),d=Math.round(d),f=Math.round(f)),l=Math.min(d,l),h=Math.min(f,h);try{return this._texture.isCube?c._readTexturePixels(this._texture,l,h,e,t,i,s,r,n,o):c._readTexturePixels(this._texture,l,h,-1,t,i,s,r,n,o)}catch{return null}}_readPixelsSync(e=0,t=0,i=null,s=!0,r=!1){if(!this._texture)return null;const n=this.getSize();let o=n.width,l=n.height;const h=this._getEngine();if(!h)return null;t!=0&&(o=o/Math.pow(2,t),l=l/Math.pow(2,t),o=Math.round(o),l=Math.round(l));try{return this._texture.isCube?h._readTexturePixelsSync(this._texture,o,l,e,t,i,s,r):h._readTexturePixelsSync(this._texture,o,l,-1,t,i,s,r)}catch{return null}}get _lodTextureHigh(){return this._texture?this._texture._lodTextureHigh:null}get _lodTextureMid(){return this._texture?this._texture._lodTextureMid:null}get _lodTextureLow(){return this._texture?this._texture._lodTextureLow:null}dispose(){if(this._scene){this._scene.stopAnimation&&this._scene.stopAnimation(this),this._scene.removePendingData(this);const e=this._scene.textures.indexOf(this);if(e>=0&&this._scene.textures.splice(e,1),this._scene.onTextureRemovedObservable.notifyObservers(this),this._scene=null,this._parentContainer){const t=this._parentContainer.textures.indexOf(this);t>-1&&this._parentContainer.textures.splice(t,1),this._parentContainer=null}}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.metadata=null,super.dispose()}serialize(){if(!this.name)return null;const e=xe.Serialize(this);return xe.AppendSerializedAnimations(this,e),e}static WhenAllReady(e,t){let i=e.length;if(i===0){t();return}for(let s=0;s<e.length;s++){const r=e[s];if(r.isReady())--i===0&&t();else{const n=r.onLoadObservable;n?n.addOnce(()=>{--i===0&&t()}):--i===0&&t()}}}static _IsScene(e){return e.getClassName()==="Scene"}}dt.DEFAULT_ANISOTROPIC_FILTERING_LEVEL=4;T([R()],dt.prototype,"uniqueId",void 0);T([R()],dt.prototype,"name",void 0);T([R()],dt.prototype,"metadata",void 0);T([R("hasAlpha")],dt.prototype,"_hasAlpha",void 0);T([R("getAlphaFromRGB")],dt.prototype,"_getAlphaFromRGB",void 0);T([R()],dt.prototype,"level",void 0);T([R("coordinatesIndex")],dt.prototype,"_coordinatesIndex",void 0);T([R()],dt.prototype,"optimizeUVAllocation",void 0);T([R("coordinatesMode")],dt.prototype,"_coordinatesMode",void 0);T([R()],dt.prototype,"wrapU",null);T([R()],dt.prototype,"wrapV",null);T([R()],dt.prototype,"wrapR",void 0);T([R()],dt.prototype,"anisotropicFilteringLevel",void 0);T([R()],dt.prototype,"isCube",null);T([R()],dt.prototype,"is3D",null);T([R()],dt.prototype,"is2DArray",null);T([R()],dt.prototype,"gammaSpace",null);T([R()],dt.prototype,"invertZ",void 0);T([R()],dt.prototype,"lodLevelInAlpha",void 0);T([R()],dt.prototype,"lodGenerationOffset",null);T([R()],dt.prototype,"lodGenerationScale",null);T([R()],dt.prototype,"linearSpecularLOD",null);T([Qe()],dt.prototype,"irradianceTexture",null);T([R()],dt.prototype,"isRenderTarget",void 0);function p_(a,e,t=!1){const i=e.width,s=e.height;if(a instanceof Float32Array){let h=a.byteLength/a.BYTES_PER_ELEMENT;const c=new Uint8Array(h);for(;--h>=0;){let u=a[h];u<0?u=0:u>1&&(u=1),c[h]=u*255}a=c}const r=document.createElement("canvas");r.width=i,r.height=s;const n=r.getContext("2d");if(!n)return null;const o=n.createImageData(i,s);if(o.data.set(a),n.putImageData(o,0,0),t){const h=document.createElement("canvas");h.width=i,h.height=s;const c=h.getContext("2d");return c?(c.translate(0,s),c.scale(1,-1),c.drawImage(r,0,0),h.toDataURL("image/png")):null}return r.toDataURL("image/png")}function mx(a,e=0,t=0){const i=a.getInternalTexture();if(!i)return null;const s=a._readPixelsSync(e,t);return s?p_(s,a.getSize(),i.invertY):null}async function gx(a,e=0,t=0){const i=a.getInternalTexture();if(!i)return null;const s=await a.readPixels(e,t);return s?p_(s,a.getSize(),i.invertY):null}class nt{}nt.UseOpenGLOrientationForUV=!1;class H extends dt{constructor(e,t,i,s,r=H.TRILINEAR_SAMPLINGMODE,n=null,o=null,l=null,h=!1,c,u,d,f,p){var _,m,v,x,b,S,C,E,A;super(t),this.url=null,this.uOffset=0,this.vOffset=0,this.uScale=1,this.vScale=1,this.uAng=0,this.vAng=0,this.wAng=0,this.uRotationCenter=.5,this.vRotationCenter=.5,this.wRotationCenter=.5,this.homogeneousRotationInUVTransform=!1,this.inspectableCustomProperties=null,this._noMipmap=!1,this._invertY=!1,this._rowGenerationMatrix=null,this._cachedTextureMatrix=null,this._projectionModeMatrix=null,this._t0=null,this._t1=null,this._t2=null,this._cachedUOffset=-1,this._cachedVOffset=-1,this._cachedUScale=0,this._cachedVScale=0,this._cachedUAng=-1,this._cachedVAng=-1,this._cachedWAng=-1,this._cachedReflectionProjectionMatrixId=-1,this._cachedURotationCenter=-1,this._cachedVRotationCenter=-1,this._cachedWRotationCenter=-1,this._cachedHomogeneousRotationInUVTransform=!1,this._cachedReflectionTextureMatrix=null,this._cachedReflectionUOffset=-1,this._cachedReflectionVOffset=-1,this._cachedReflectionUScale=0,this._cachedReflectionVScale=0,this._cachedReflectionCoordinatesMode=-1,this._buffer=null,this._deleteBuffer=!1,this._format=null,this._delayedOnLoad=null,this._delayedOnError=null,this.onLoadObservable=new X,this._isBlocking=!0,this.name=e||"",this.url=e;let M,D=!1,P=null;typeof i=="object"&&i!==null?(M=(_=i.noMipmap)!==null&&_!==void 0?_:!1,s=(m=i.invertY)!==null&&m!==void 0?m:!nt.UseOpenGLOrientationForUV,r=(v=i.samplingMode)!==null&&v!==void 0?v:H.TRILINEAR_SAMPLINGMODE,n=(x=i.onLoad)!==null&&x!==void 0?x:null,o=(b=i.onError)!==null&&b!==void 0?b:null,l=(S=i.buffer)!==null&&S!==void 0?S:null,h=(C=i.deleteBuffer)!==null&&C!==void 0?C:!1,c=i.format,u=i.mimeType,d=i.loaderOptions,f=i.creationFlags,D=(E=i.useSRGBBuffer)!==null&&E!==void 0?E:!1,P=(A=i.internalTexture)!==null&&A!==void 0?A:null):M=!!i,this._noMipmap=M,this._invertY=s===void 0?!nt.UseOpenGLOrientationForUV:s,this._initialSamplingMode=r,this._buffer=l,this._deleteBuffer=h,this._mimeType=u,this._loaderOptions=d,this._creationFlags=f,this._useSRGBBuffer=D,this._forcedExtension=p,c&&(this._format=c);const O=this.getScene(),N=this._getEngine();if(!N)return;N.onBeforeTextureInitObservable.notifyObservers(this);const $=()=>{this._texture&&(this._texture._invertVScale&&(this.vScale*=-1,this.vOffset+=1),this._texture._cachedWrapU!==null&&(this.wrapU=this._texture._cachedWrapU,this._texture._cachedWrapU=null),this._texture._cachedWrapV!==null&&(this.wrapV=this._texture._cachedWrapV,this._texture._cachedWrapV=null),this._texture._cachedWrapR!==null&&(this.wrapR=this._texture._cachedWrapR,this._texture._cachedWrapR=null)),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this),n&&n(),!this.isBlocking&&O&&O.resetCachedMaterial()},W=(K,te)=>{this._loadingError=!0,this._errorObject={message:K,exception:te},o&&o(K,te),H.OnTextureLoadErrorObservable.notifyObservers(this)};if(!this.url){this._delayedOnLoad=$,this._delayedOnError=W;return}if(this._texture=P!=null?P:this._getFromCache(this.url,M,r,this._invertY,D),this._texture)if(this._texture.isReady)yo.SetImmediate(()=>$());else{const K=this._texture.onLoadedObservable.add($);this._texture.onErrorObservable.add(te=>{var ve;W(te.message,te.exception),(ve=this._texture)===null||ve===void 0||ve.onLoadedObservable.remove(K)})}else if(!O||!O.useDelayedTextureLoading){try{this._texture=N.createTexture(this.url,M,this._invertY,O,r,$,W,this._buffer,void 0,this._format,this._forcedExtension,u,d,f,D)}catch(K){throw W("error loading",K),K}h&&(this._buffer=null)}else this.delayLoadState=4,this._delayedOnLoad=$,this._delayedOnError=W}get noMipmap(){return this._noMipmap}get mimeType(){return this._mimeType}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}get invertY(){return this._invertY}updateURL(e,t=null,i,s){this.url&&(this.releaseInternalTexture(),this.getScene().markAllMaterialsAsDirty(1)),(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,this._buffer=t,this._forcedExtension=s,this.delayLoadState=4,i&&(this._delayedOnLoad=i),this.delayLoad()}delayLoad(){if(this.delayLoadState!==4)return;const e=this.getScene();!e||(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap,this.samplingMode,this._invertY,this._useSRGBBuffer),this._texture?this._delayedOnLoad&&(this._texture.isReady?yo.SetImmediate(this._delayedOnLoad):this._texture.onLoadedObservable.add(this._delayedOnLoad)):(this._texture=e.getEngine().createTexture(this.url,this._noMipmap,this._invertY,e,this.samplingMode,this._delayedOnLoad,this._delayedOnError,this._buffer,null,this._format,this._forcedExtension,this._mimeType,this._loaderOptions,this._creationFlags,this._useSRGBBuffer),this._deleteBuffer&&(this._buffer=null)),this._delayedOnLoad=null,this._delayedOnError=null)}_prepareRowForTextureGeneration(e,t,i,s){e*=this._cachedUScale,t*=this._cachedVScale,e-=this.uRotationCenter*this._cachedUScale,t-=this.vRotationCenter*this._cachedVScale,i-=this.wRotationCenter,g.TransformCoordinatesFromFloatsToRef(e,t,i,this._rowGenerationMatrix,s),s.x+=this.uRotationCenter*this._cachedUScale+this._cachedUOffset,s.y+=this.vRotationCenter*this._cachedVScale+this._cachedVOffset,s.z+=this.wRotationCenter}checkTransformsAreIdentical(e){return e!==null&&this.uOffset===e.uOffset&&this.vOffset===e.vOffset&&this.uScale===e.uScale&&this.vScale===e.vScale&&this.uAng===e.uAng&&this.vAng===e.vAng&&this.wAng===e.wAng}getTextureMatrix(e=1){if(this.uOffset===this._cachedUOffset&&this.vOffset===this._cachedVOffset&&this.uScale*e===this._cachedUScale&&this.vScale===this._cachedVScale&&this.uAng===this._cachedUAng&&this.vAng===this._cachedVAng&&this.wAng===this._cachedWAng&&this.uRotationCenter===this._cachedURotationCenter&&this.vRotationCenter===this._cachedVRotationCenter&&this.wRotationCenter===this._cachedWRotationCenter&&this.homogeneousRotationInUVTransform===this._cachedHomogeneousRotationInUVTransform)return this._cachedTextureMatrix;this._cachedUOffset=this.uOffset,this._cachedVOffset=this.vOffset,this._cachedUScale=this.uScale*e,this._cachedVScale=this.vScale,this._cachedUAng=this.uAng,this._cachedVAng=this.vAng,this._cachedWAng=this.wAng,this._cachedURotationCenter=this.uRotationCenter,this._cachedVRotationCenter=this.vRotationCenter,this._cachedWRotationCenter=this.wRotationCenter,this._cachedHomogeneousRotationInUVTransform=this.homogeneousRotationInUVTransform,(!this._cachedTextureMatrix||!this._rowGenerationMatrix)&&(this._cachedTextureMatrix=L.Zero(),this._rowGenerationMatrix=new L,this._t0=g.Zero(),this._t1=g.Zero(),this._t2=g.Zero()),L.RotationYawPitchRollToRef(this.vAng,this.uAng,this.wAng,this._rowGenerationMatrix),this.homogeneousRotationInUVTransform?(L.TranslationToRef(-this._cachedURotationCenter,-this._cachedVRotationCenter,-this._cachedWRotationCenter,G.Matrix[0]),L.TranslationToRef(this._cachedURotationCenter,this._cachedVRotationCenter,this._cachedWRotationCenter,G.Matrix[1]),L.ScalingToRef(this._cachedUScale,this._cachedVScale,0,G.Matrix[2]),L.TranslationToRef(this._cachedUOffset,this._cachedVOffset,0,G.Matrix[3]),G.Matrix[0].multiplyToRef(this._rowGenerationMatrix,this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(G.Matrix[1],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(G.Matrix[2],this._cachedTextureMatrix),this._cachedTextureMatrix.multiplyToRef(G.Matrix[3],this._cachedTextureMatrix),this._cachedTextureMatrix.setRowFromFloats(2,this._cachedTextureMatrix.m[12],this._cachedTextureMatrix.m[13],this._cachedTextureMatrix.m[14],1)):(this._prepareRowForTextureGeneration(0,0,0,this._t0),this._prepareRowForTextureGeneration(1,0,0,this._t1),this._prepareRowForTextureGeneration(0,1,0,this._t2),this._t1.subtractInPlace(this._t0),this._t2.subtractInPlace(this._t0),L.FromValuesToRef(this._t1.x,this._t1.y,this._t1.z,0,this._t2.x,this._t2.y,this._t2.z,0,this._t0.x,this._t0.y,this._t0.z,0,0,0,0,1,this._cachedTextureMatrix));const t=this.getScene();return t?(this.optimizeUVAllocation&&t.markAllMaterialsAsDirty(1,i=>i.hasTexture(this)),this._cachedTextureMatrix):this._cachedTextureMatrix}getReflectionTextureMatrix(){const e=this.getScene();if(!e)return this._cachedReflectionTextureMatrix;if(this.uOffset===this._cachedReflectionUOffset&&this.vOffset===this._cachedReflectionVOffset&&this.uScale===this._cachedReflectionUScale&&this.vScale===this._cachedReflectionVScale&&this.coordinatesMode===this._cachedReflectionCoordinatesMode)if(this.coordinatesMode===H.PROJECTION_MODE){if(this._cachedReflectionProjectionMatrixId===e.getProjectionMatrix().updateFlag)return this._cachedReflectionTextureMatrix}else return this._cachedReflectionTextureMatrix;this._cachedReflectionTextureMatrix||(this._cachedReflectionTextureMatrix=L.Zero()),this._projectionModeMatrix||(this._projectionModeMatrix=L.Zero());const t=this._cachedReflectionCoordinatesMode!==this.coordinatesMode;switch(this._cachedReflectionUOffset=this.uOffset,this._cachedReflectionVOffset=this.vOffset,this._cachedReflectionUScale=this.uScale,this._cachedReflectionVScale=this.vScale,this._cachedReflectionCoordinatesMode=this.coordinatesMode,this.coordinatesMode){case H.PLANAR_MODE:{L.IdentityToRef(this._cachedReflectionTextureMatrix),this._cachedReflectionTextureMatrix[0]=this.uScale,this._cachedReflectionTextureMatrix[5]=this.vScale,this._cachedReflectionTextureMatrix[12]=this.uOffset,this._cachedReflectionTextureMatrix[13]=this.vOffset;break}case H.PROJECTION_MODE:{L.FromValuesToRef(.5,0,0,0,0,-.5,0,0,0,0,0,0,.5,.5,1,1,this._projectionModeMatrix);const i=e.getProjectionMatrix();this._cachedReflectionProjectionMatrixId=i.updateFlag,i.multiplyToRef(this._projectionModeMatrix,this._cachedReflectionTextureMatrix);break}default:L.IdentityToRef(this._cachedReflectionTextureMatrix);break}return t&&e.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1),this._cachedReflectionTextureMatrix}clone(){const e={noMipmap:this._noMipmap,invertY:this._invertY,samplingMode:this.samplingMode,onLoad:void 0,onError:void 0,buffer:this._texture?this._texture._buffer:void 0,deleteBuffer:this._deleteBuffer,format:this.textureFormat,mimeType:this.mimeType,loaderOptions:this._loaderOptions,creationFlags:this._creationFlags,useSRGBBuffer:this._useSRGBBuffer};return xe.Clone(()=>new H(this._texture?this._texture.url:null,this.getScene(),e),this)}serialize(){const e=this.name;H.SerializeBuffers||this.name.startsWith("data:")&&(this.name=""),this.name.startsWith("data:")&&this.url===this.name&&(this.url="");const t=super.serialize();return t?((H.SerializeBuffers||H.ForceSerializeBuffers)&&(typeof this._buffer=="string"&&this._buffer.substr(0,5)==="data:"?(t.base64String=this._buffer,t.name=t.name.replace("data:","")):this.url&&this.url.startsWith("data:")&&this._buffer instanceof Uint8Array?t.base64String="data:image/png;base64,"+n_(this._buffer):(H.ForceSerializeBuffers||this.url&&this.url.startsWith("blob:")||this._forceSerialize)&&(t.base64String=!this._engine||this._engine._features.supportSyncTextureRead?mx(this):gx(this))),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t._creationFlags=this._creationFlags,t._useSRGBBuffer=this._useSRGBBuffer,this.name=e,t):null}getClassName(){return"Texture"}dispose(){super.dispose(),this.onLoadObservable.clear(),this._delayedOnLoad=null,this._delayedOnError=null}static Parse(e,t,i){if(e.customType){const o=ol.Instantiate(e.customType).Parse(e,t,i);return e.samplingMode&&o.updateSamplingMode&&o._samplingMode&&o._samplingMode!==e.samplingMode&&o.updateSamplingMode(e.samplingMode),o}if(e.isCube&&!e.isRenderTarget)return H._CubeTextureParser(e,t,i);if(!e.name&&!e.isRenderTarget)return null;const s=n=>{if(n&&n._texture&&(n._texture._cachedWrapU=null,n._texture._cachedWrapV=null,n._texture._cachedWrapR=null),e.samplingMode){const o=e.samplingMode;n&&n.samplingMode!==o&&n.updateSamplingMode(o)}if(n&&e.animations)for(let o=0;o<e.animations.length;o++){const l=e.animations[o],h=Si("BABYLON.Animation");h&&n.animations.push(h.Parse(l))}};return xe.Parse(()=>{var n,o,l;let h=!0;if(e.noMipmap&&(h=!1),e.mirrorPlane){const c=H._CreateMirror(e.name,e.renderTargetSize,t,h);return c._waitingRenderList=e.renderList,c.mirrorPlane=Hi.FromArray(e.mirrorPlane),s(c),c}else if(e.isRenderTarget){let c=null;if(e.isCube){if(t.reflectionProbes)for(let u=0;u<t.reflectionProbes.length;u++){const d=t.reflectionProbes[u];if(d.name===e.name)return d.cubeTexture}}else c=H._CreateRenderTargetTexture(e.name,e.renderTargetSize,t,h,(n=e._creationFlags)!==null&&n!==void 0?n:0),c._waitingRenderList=e.renderList;return s(c),c}else{let c;if(e.base64String)c=H.CreateFromBase64String(e.base64String,e.base64String,t,!h,e.invertY,e.samplingMode,()=>{s(c)},(o=e._creationFlags)!==null&&o!==void 0?o:0,(l=e._useSRGBBuffer)!==null&&l!==void 0?l:!1),c.name=e.name;else{let u;e.name&&e.name.indexOf("://")>0?u=e.name:u=i+e.name,e.url&&(e.url.startsWith("data:")||H.UseSerializedUrlIfAny)&&(u=e.url),c=new H(u,t,!h,e.invertY,e.samplingMode,()=>{s(c)})}return c}},e,t)}static CreateFromBase64String(e,t,i,s,r,n=H.TRILINEAR_SAMPLINGMODE,o=null,l=null,h=5,c){return new H("data:"+t,i,s,r,n,o,l,e,!1,h,void 0,void 0,c)}static LoadFromDataString(e,t,i,s=!1,r,n=!0,o=H.TRILINEAR_SAMPLINGMODE,l=null,h=null,c=5,u){return e.substr(0,5)!=="data:"&&(e="data:"+e),new H(e,i,r,n,o,l,h,t,s,c,void 0,void 0,u)}}H.SerializeBuffers=!0;H.ForceSerializeBuffers=!1;H.OnTextureLoadErrorObservable=new X;H._CubeTextureParser=(a,e,t)=>{throw Ve("CubeTexture")};H._CreateMirror=(a,e,t,i)=>{throw Ve("MirrorTexture")};H._CreateRenderTargetTexture=(a,e,t,i,s)=>{throw Ve("RenderTargetTexture")};H.NEAREST_SAMPLINGMODE=1;H.NEAREST_NEAREST_MIPLINEAR=8;H.BILINEAR_SAMPLINGMODE=2;H.LINEAR_LINEAR_MIPNEAREST=11;H.TRILINEAR_SAMPLINGMODE=3;H.LINEAR_LINEAR_MIPLINEAR=3;H.NEAREST_NEAREST_MIPNEAREST=4;H.NEAREST_LINEAR_MIPNEAREST=5;H.NEAREST_LINEAR_MIPLINEAR=6;H.NEAREST_LINEAR=7;H.NEAREST_NEAREST=1;H.LINEAR_NEAREST_MIPNEAREST=9;H.LINEAR_NEAREST_MIPLINEAR=10;H.LINEAR_LINEAR=2;H.LINEAR_NEAREST=12;H.EXPLICIT_MODE=0;H.SPHERICAL_MODE=1;H.PLANAR_MODE=2;H.CUBIC_MODE=3;H.PROJECTION_MODE=4;H.SKYBOX_MODE=5;H.INVCUBIC_MODE=6;H.EQUIRECTANGULAR_MODE=7;H.FIXED_EQUIRECTANGULAR_MODE=8;H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE=9;H.CLAMP_ADDRESSMODE=0;H.WRAP_ADDRESSMODE=1;H.MIRROR_ADDRESSMODE=2;H.UseSerializedUrlIfAny=!1;T([R()],H.prototype,"url",void 0);T([R()],H.prototype,"uOffset",void 0);T([R()],H.prototype,"vOffset",void 0);T([R()],H.prototype,"uScale",void 0);T([R()],H.prototype,"vScale",void 0);T([R()],H.prototype,"uAng",void 0);T([R()],H.prototype,"vAng",void 0);T([R()],H.prototype,"wAng",void 0);T([R()],H.prototype,"uRotationCenter",void 0);T([R()],H.prototype,"vRotationCenter",void 0);T([R()],H.prototype,"wRotationCenter",void 0);T([R()],H.prototype,"homogeneousRotationInUVTransform",void 0);T([R()],H.prototype,"isBlocking",null);he("BABYLON.Texture",H);xe._TextureParser=H.Parse;class Yh{constructor(e){this._vertexBuffers={},this._scene=e}_prepareBuffers(){if(this._vertexBuffers[y.PositionKind])return;const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1),this._vertexBuffers[y.PositionKind]=new y(this._scene.getEngine(),e,y.PositionKind,!1,!1,2),this._buildIndexBuffer()}_buildIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}_rebuild(){const e=this._vertexBuffers[y.PositionKind];!e||(e._rebuild(),this._buildIndexBuffer())}_prepareFrame(e=null,t=null){const i=this._scene.activeCamera;return!i||(t=t||i._postProcesses.filter(s=>s!=null),!t||t.length===0||!this._scene.postProcessesEnabled)?!1:(t[0].activate(i,e,t!=null),!0)}directRender(e,t=null,i=!1,s=0,r=0,n=!1){var o;const l=this._scene.getEngine();for(let h=0;h<e.length;h++){h<e.length-1?e[h+1].activate(this._scene.activeCamera,t==null?void 0:t.texture):(t?l.bindFramebuffer(t,s,void 0,void 0,i,r):n||l.restoreDefaultFramebuffer(),(o=l._debugInsertMarker)===null||o===void 0||o.call(l,`post process ${e[h].name} output`));const c=e[h],u=c.apply();u&&(c.onBeforeRenderObservable.notifyObservers(u),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,u),l.drawElementsType(0,0,6),c.onAfterRenderObservable.notifyObservers(u))}l.setDepthBuffer(!0),l.setDepthWrite(!0)}_finalizeFrame(e,t,i,s,r=!1){var n;const o=this._scene.activeCamera;if(!o||(s=s||o._postProcesses.filter(h=>h!=null),s.length===0||!this._scene.postProcessesEnabled))return;const l=this._scene.getEngine();for(let h=0,c=s.length;h<c;h++){const u=s[h];if(h<c-1?u._outputTexture=s[h+1].activate(o,t==null?void 0:t.texture):(t?(l.bindFramebuffer(t,i,void 0,void 0,r),u._outputTexture=t):(l.restoreDefaultFramebuffer(),u._outputTexture=null),(n=l._debugInsertMarker)===null||n===void 0||n.call(l,`post process ${s[h].name} output`)),e)break;const d=u.apply();d&&(u.onBeforeRenderObservable.notifyObservers(d),this._prepareBuffers(),l.bindBuffers(this._vertexBuffers,this._indexBuffer,d),l.drawElementsType(0,0,6),u.onAfterRenderObservable.notifyObservers(d))}l.setDepthBuffer(!0),l.setDepthWrite(!0),l.setAlphaMode(0)}dispose(){const e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null)}}class mi{constructor(e){this.length=0,this.data=new Array(e),this._id=mi._GlobalId++}push(e){this.data[this.length++]=e,this.length>this.data.length&&(this.data.length*=2)}forEach(e){for(let t=0;t<this.length;t++)e(this.data[t])}sort(e){this.data.sort(e)}reset(){this.length=0}dispose(){this.reset(),this.data&&(this.data.length=0)}concat(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++)this.data[this.length++]=(e.data||e)[t]}}indexOf(e){const t=this.data.indexOf(e);return t>=this.length?-1:t}contains(e){return this.indexOf(e)!==-1}}mi._GlobalId=0;class wn extends mi{constructor(){super(...arguments),this._duplicateId=0}push(e){super.push(e),e.__smartArrayFlags||(e.__smartArrayFlags={}),e.__smartArrayFlags[this._id]=this._duplicateId}pushNoDuplicate(e){return e.__smartArrayFlags&&e.__smartArrayFlags[this._id]===this._duplicateId?!1:(this.push(e),!0)}reset(){super.reset(),this._duplicateId++}concatWithNoDuplicate(e){if(e.length!==0){this.length+e.length>this.data.length&&(this.data.length=(this.length+e.length)*2);for(let t=0;t<e.length;t++){const i=(e.data||e)[t];this.pushNoDuplicate(i)}}}}class Ar{constructor(e,t,i=null,s=null,r=null){this.index=e,this._opaqueSubMeshes=new mi(256),this._transparentSubMeshes=new mi(256),this._alphaTestSubMeshes=new mi(256),this._depthOnlySubMeshes=new mi(256),this._particleSystems=new mi(256),this._spriteManagers=new mi(256),this._empty=!0,this._edgesRenderers=new wn(16),this._scene=t,this.opaqueSortCompareFn=i,this.alphaTestSortCompareFn=s,this.transparentSortCompareFn=r}set opaqueSortCompareFn(e){e?this._opaqueSortCompareFn=e:this._opaqueSortCompareFn=Ar.PainterSortCompare,this._renderOpaque=this._renderOpaqueSorted}set alphaTestSortCompareFn(e){e?this._alphaTestSortCompareFn=e:this._alphaTestSortCompareFn=Ar.PainterSortCompare,this._renderAlphaTest=this._renderAlphaTestSorted}set transparentSortCompareFn(e){e?this._transparentSortCompareFn=e:this._transparentSortCompareFn=Ar.defaultTransparentSortCompare,this._renderTransparent=this._renderTransparentSorted}render(e,t,i,s){if(e){e(this._opaqueSubMeshes,this._alphaTestSubMeshes,this._transparentSubMeshes,this._depthOnlySubMeshes);return}const r=this._scene.getEngine();this._depthOnlySubMeshes.length!==0&&(r.setColorWrite(!1),this._renderAlphaTest(this._depthOnlySubMeshes),r.setColorWrite(!0)),this._opaqueSubMeshes.length!==0&&this._renderOpaque(this._opaqueSubMeshes),this._alphaTestSubMeshes.length!==0&&this._renderAlphaTest(this._alphaTestSubMeshes);const n=r.getStencilBuffer();if(r.setStencilBuffer(!1),t&&this._renderSprites(),i&&this._renderParticles(s),this.onBeforeTransparentRendering&&this.onBeforeTransparentRendering(),this._transparentSubMeshes.length!==0||this._scene.useOrderIndependentTransparency){if(r.setStencilBuffer(n),this._scene.useOrderIndependentTransparency){const o=this._scene.depthPeelingRenderer.render(this._transparentSubMeshes);o.length&&this._renderTransparent(o)}else this._renderTransparent(this._transparentSubMeshes);r.setAlphaMode(0)}if(r.setStencilBuffer(!1),this._edgesRenderers.length){for(let o=0;o<this._edgesRenderers.length;o++)this._edgesRenderers.data[o].render();r.setAlphaMode(0)}r.setStencilBuffer(n)}_renderOpaqueSorted(e){return Ar._RenderSorted(e,this._opaqueSortCompareFn,this._scene.activeCamera,!1)}_renderAlphaTestSorted(e){return Ar._RenderSorted(e,this._alphaTestSortCompareFn,this._scene.activeCamera,!1)}_renderTransparentSorted(e){return Ar._RenderSorted(e,this._transparentSortCompareFn,this._scene.activeCamera,!0)}static _RenderSorted(e,t,i,s){let r=0,n;const o=i?i.globalPosition:Ar._ZeroVector;if(s)for(;r<e.length;r++)n=e.data[r],n._alphaIndex=n.getMesh().alphaIndex,n._distanceToCamera=g.Distance(n.getBoundingInfo().boundingSphere.centerWorld,o);const l=e.length===e.data.length?e.data:e.data.slice(0,e.length);t&&l.sort(t);const h=l[0].getMesh().getScene();for(r=0;r<l.length;r++)if(n=l[r],!(h._activeMeshesFrozenButKeepClipping&&!n.isInFrustum(h._frustumPlanes))){if(s){const c=n.getMaterial();if(c&&c.needDepthPrePass){const u=c.getScene().getEngine();u.setColorWrite(!1),u.setAlphaMode(0),n.render(!1),u.setColorWrite(!0)}}n.render(s)}}static defaultTransparentSortCompare(e,t){return e._alphaIndex>t._alphaIndex?1:e._alphaIndex<t._alphaIndex?-1:Ar.backToFrontSortCompare(e,t)}static backToFrontSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?1:e._distanceToCamera>t._distanceToCamera?-1:0}static frontToBackSortCompare(e,t){return e._distanceToCamera<t._distanceToCamera?-1:e._distanceToCamera>t._distanceToCamera?1:0}static PainterSortCompare(e,t){const i=e.getMesh(),s=t.getMesh();return i.material&&s.material?i.material.uniqueId-s.material.uniqueId:i.uniqueId-s.uniqueId}prepare(){this._opaqueSubMeshes.reset(),this._transparentSubMeshes.reset(),this._alphaTestSubMeshes.reset(),this._depthOnlySubMeshes.reset(),this._particleSystems.reset(),this._spriteManagers.reset(),this._edgesRenderers.reset(),this._empty=!0}dispose(){this._opaqueSubMeshes.dispose(),this._transparentSubMeshes.dispose(),this._alphaTestSubMeshes.dispose(),this._depthOnlySubMeshes.dispose(),this._particleSystems.dispose(),this._spriteManagers.dispose(),this._edgesRenderers.dispose()}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),i===void 0&&(i=e.getMaterial()),i!=null&&(i.needAlphaBlendingForMesh(t)?this._transparentSubMeshes.push(e):i.needAlphaTesting()?(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._alphaTestSubMeshes.push(e)):(i.needDepthPrePass&&this._depthOnlySubMeshes.push(e),this._opaqueSubMeshes.push(e)),t._renderingGroup=this,t._edgesRenderer&&t._edgesRenderer.isEnabled&&this._edgesRenderers.pushNoDuplicate(t._edgesRenderer),this._empty=!1)}dispatchSprites(e){this._spriteManagers.push(e),this._empty=!1}dispatchParticles(e){this._particleSystems.push(e),this._empty=!1}_renderParticles(e){if(this._particleSystems.length===0)return;const t=this._scene.activeCamera;this._scene.onBeforeParticlesRenderingObservable.notifyObservers(this._scene);for(let i=0;i<this._particleSystems.length;i++){const s=this._particleSystems.data[i];if((t&&t.layerMask&s.layerMask)===0)continue;const r=s.emitter;(!r.position||!e||e.indexOf(r)!==-1)&&this._scene._activeParticles.addCount(s.render(),!1)}this._scene.onAfterParticlesRenderingObservable.notifyObservers(this._scene)}_renderSprites(){if(!this._scene.spritesEnabled||this._spriteManagers.length===0)return;const e=this._scene.activeCamera;this._scene.onBeforeSpritesRenderingObservable.notifyObservers(this._scene);for(let t=0;t<this._spriteManagers.length;t++){const i=this._spriteManagers.data[t];(e&&e.layerMask&i.layerMask)!==0&&i.render()}this._scene.onAfterSpritesRenderingObservable.notifyObservers(this._scene)}}Ar._ZeroVector=g.Zero();class vx{}class ns{constructor(e){this._useSceneAutoClearSetup=!1,this._renderingGroups=new Array,this._autoClearDepthStencil={},this._customOpaqueSortCompareFn={},this._customAlphaTestSortCompareFn={},this._customTransparentSortCompareFn={},this._renderingGroupInfo=new vx,this._maintainStateBetweenFrames=!1,this._scene=e;for(let t=ns.MIN_RENDERINGGROUPS;t<ns.MAX_RENDERINGGROUPS;t++)this._autoClearDepthStencil[t]={autoClear:!0,depth:!0,stencil:!0}}get maintainStateBetweenFrames(){return this._maintainStateBetweenFrames}set maintainStateBetweenFrames(e){if(e!==this._maintainStateBetweenFrames&&(this._maintainStateBetweenFrames=e,!this._maintainStateBetweenFrames)){for(const t of this._scene.meshes)if(t.subMeshes)for(const i of t.subMeshes)i._wasDispatched=!1;for(const t of this._scene.spriteManagers)t._wasDispatched=!1;for(const t of this._scene.particleSystems)t._wasDispatched=!1}}getRenderingGroup(e){const t=e||0;return this._prepareRenderingGroup(t),this._renderingGroups[t]}_clearDepthStencilBuffer(e=!0,t=!0){this._depthStencilBufferAlreadyCleaned||(this._scene.getEngine().clear(null,!1,e,t),this._depthStencilBufferAlreadyCleaned=!0)}render(e,t,i,s){const r=this._renderingGroupInfo;if(r.scene=this._scene,r.camera=this._scene.activeCamera,this._scene.spriteManagers&&s)for(let n=0;n<this._scene.spriteManagers.length;n++){const o=this._scene.spriteManagers[n];this.dispatchSprites(o)}for(let n=ns.MIN_RENDERINGGROUPS;n<ns.MAX_RENDERINGGROUPS;n++){this._depthStencilBufferAlreadyCleaned=n===ns.MIN_RENDERINGGROUPS;const o=this._renderingGroups[n];if(!o||o._empty)continue;const l=Math.pow(2,n);if(r.renderingGroupId=n,this._scene.onBeforeRenderingGroupObservable.notifyObservers(r,l),ns.AUTOCLEAR){const h=this._useSceneAutoClearSetup?this._scene.getAutoClearDepthStencilSetup(n):this._autoClearDepthStencil[n];h&&h.autoClear&&this._clearDepthStencilBuffer(h.depth,h.stencil)}for(const h of this._scene._beforeRenderingGroupDrawStage)h.action(n);o.render(e,s,i,t);for(const h of this._scene._afterRenderingGroupDrawStage)h.action(n);this._scene.onAfterRenderingGroupObservable.notifyObservers(r,l)}}reset(){if(!this.maintainStateBetweenFrames)for(let e=ns.MIN_RENDERINGGROUPS;e<ns.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.prepare()}}dispose(){this.freeRenderingGroups(),this._renderingGroups.length=0,this._renderingGroupInfo=null}freeRenderingGroups(){for(let e=ns.MIN_RENDERINGGROUPS;e<ns.MAX_RENDERINGGROUPS;e++){const t=this._renderingGroups[e];t&&t.dispose()}}_prepareRenderingGroup(e){this._renderingGroups[e]===void 0&&(this._renderingGroups[e]=new Ar(e,this._scene,this._customOpaqueSortCompareFn[e],this._customAlphaTestSortCompareFn[e],this._customTransparentSortCompareFn[e]))}dispatchSprites(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchSprites(e))}dispatchParticles(e){this.maintainStateBetweenFrames&&e._wasDispatched||(e._wasDispatched=!0,this.getRenderingGroup(e.renderingGroupId).dispatchParticles(e))}dispatch(e,t,i){t===void 0&&(t=e.getMesh()),!(this.maintainStateBetweenFrames&&e._wasDispatched)&&(e._wasDispatched=!0,this.getRenderingGroup(t.renderingGroupId).dispatch(e,t,i))}setRenderingOrder(e,t=null,i=null,s=null){if(this._customOpaqueSortCompareFn[e]=t,this._customAlphaTestSortCompareFn[e]=i,this._customTransparentSortCompareFn[e]=s,this._renderingGroups[e]){const r=this._renderingGroups[e];r.opaqueSortCompareFn=this._customOpaqueSortCompareFn[e],r.alphaTestSortCompareFn=this._customAlphaTestSortCompareFn[e],r.transparentSortCompareFn=this._customTransparentSortCompareFn[e]}}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._autoClearDepthStencil[e]={autoClear:t,depth:i,stencil:s}}getAutoClearDepthStencilSetup(e){return this._autoClearDepthStencil[e]}}ns.MAX_RENDERINGGROUPS=4;ns.MIN_RENDERINGGROUPS=0;ns.AUTOCLEAR=!0;class wd{constructor(e,t,i,s){this._textures=null,this._samples=1,this._attachments=null,this._generateStencilBuffer=!1,this._generateDepthBuffer=!1,this._depthStencilTextureWithStencil=!1,this._isMulti=e,this._isCube=t,this._size=i,this._engine=s,this._depthStencilTexture=null}get depthStencilTexture(){return this._depthStencilTexture}get depthStencilTextureWithStencil(){return this._depthStencilTextureWithStencil}get isCube(){return this._isCube}get isMulti(){return this._isMulti}get is2DArray(){return this.layers>0}get size(){return this.width}get width(){return this._size.width||this._size}get height(){return this._size.height||this._size}get layers(){return this._size.layers||0}get texture(){var e,t;return(t=(e=this._textures)===null||e===void 0?void 0:e[0])!==null&&t!==void 0?t:null}get textures(){return this._textures}get samples(){return this._samples}setSamples(e,t=!0,i=!1){if(this.samples===e&&!i)return e;const s=this._isMulti?this._engine.updateMultipleRenderTargetTextureSampleCount(this,e,t):this._engine.updateRenderTargetTextureSampleCount(this,e);return this._samples=e,s}setTextures(e){Array.isArray(e)?this._textures=e:e?this._textures=[e]:this._textures=null}setTexture(e,t=0,i=!0){this._textures||(this._textures=[]),this._textures[t]&&i&&this._textures[t].dispose(),this._textures[t]=e}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14){var n;return(n=this._depthStencilTexture)===null||n===void 0||n.dispose(),this._depthStencilTextureWithStencil=i,this._depthStencilTexture=this._engine.createDepthStencilTexture(this._size,{bilinearFiltering:t,comparisonFunction:e,generateStencil:i,isCube:this._isCube,samples:s,depthTextureFormat:r},this),this._depthStencilTexture}_shareDepth(e){this._depthStencilTexture&&(e._depthStencilTexture&&e._depthStencilTexture.dispose(),e._depthStencilTexture=this._depthStencilTexture,this._depthStencilTexture.incrementReferences())}_swapAndDie(e){this.texture&&this.texture._swapAndDie(e),this._textures=null,this.dispose(!0)}_cloneRenderTargetWrapper(){var e,t,i,s,r,n;let o=null;if(this._isMulti){const l=this.textures;if(l&&l.length>0){let h=!1,c=l.length;const u=l[l.length-1]._source;(u===We.Depth||u===We.DepthStencil)&&(h=!0,c--);const d=[],f=[];for(let m=0;m<c;++m){const v=l[m];d.push(v.samplingMode),f.push(v.type)}const p={samplingModes:d,generateMipMaps:l[0].generateMipMaps,generateDepthBuffer:this._generateDepthBuffer,generateStencilBuffer:this._generateStencilBuffer,generateDepthTexture:h,types:f,textureCount:c},_={width:this.width,height:this.height};o=this._engine.createMultipleRenderTarget(_,p)}}else{const l={};if(l.generateDepthBuffer=this._generateDepthBuffer,l.generateMipMaps=(t=(e=this.texture)===null||e===void 0?void 0:e.generateMipMaps)!==null&&t!==void 0?t:!1,l.generateStencilBuffer=this._generateStencilBuffer,l.samplingMode=(i=this.texture)===null||i===void 0?void 0:i.samplingMode,l.type=(s=this.texture)===null||s===void 0?void 0:s.type,l.format=(r=this.texture)===null||r===void 0?void 0:r.format,this.isCube)o=this._engine.createRenderTargetCubeTexture(this.width,l);else{const h={width:this.width,height:this.height,layers:this.is2DArray?(n=this.texture)===null||n===void 0?void 0:n.depth:void 0};o=this._engine.createRenderTargetTexture(h,l)}o.texture.isReady=!0}return o}_swapRenderTargetWrapper(e){if(this._textures&&e._textures)for(let t=0;t<this._textures.length;++t)this._textures[t]._swapAndDie(e._textures[t],!1),e._textures[t].isReady=!0;this._depthStencilTexture&&e._depthStencilTexture&&(this._depthStencilTexture._swapAndDie(e._depthStencilTexture),e._depthStencilTexture.isReady=!0),this._textures=null,this._depthStencilTexture=null}_rebuild(){const e=this._cloneRenderTargetWrapper();if(!!e){if(this._depthStencilTexture){const t=this._depthStencilTexture.samplingMode,i=t===2||t===3||t===11;e.createDepthStencilTexture(this._depthStencilTexture._comparisonFunction,i,this._depthStencilTextureWithStencil,this._depthStencilTexture.samples)}this.samples>1&&e.setSamples(this.samples),e._swapRenderTargetWrapper(this),e.dispose()}}releaseTextures(){var e,t;if(this._textures)for(let i=0;(t=i<((e=this._textures)===null||e===void 0?void 0:e.length))!==null&&t!==void 0&&t;++i)this._textures[i].dispose();this._textures=null}dispose(e=!1){var t;e||((t=this._depthStencilTexture)===null||t===void 0||t.dispose(),this._depthStencilTexture=null,this.releaseTextures()),this._engine._releaseRenderTargetWrapper(this)}}class xx extends wd{constructor(e,t,i,s,r){super(e,t,i,s),this._framebuffer=null,this._depthStencilBuffer=null,this._MSAAFramebuffer=null,this._colorTextureArray=null,this._depthStencilTextureArray=null,this._context=r}_cloneRenderTargetWrapper(){let e=null;return this._colorTextureArray&&this._depthStencilTextureArray?(e=this._engine.createMultiviewRenderTargetTexture(this.width,this.height),e.texture.isReady=!0):e=super._cloneRenderTargetWrapper(),e}_swapRenderTargetWrapper(e){super._swapRenderTargetWrapper(e),e._framebuffer=this._framebuffer,e._depthStencilBuffer=this._depthStencilBuffer,e._MSAAFramebuffer=this._MSAAFramebuffer,e._colorTextureArray=this._colorTextureArray,e._depthStencilTextureArray=this._depthStencilTextureArray,this._framebuffer=this._depthStencilBuffer=this._MSAAFramebuffer=this._colorTextureArray=this._depthStencilTextureArray=null}_shareDepth(e){super._shareDepth(e);const t=this._context,i=this._depthStencilBuffer,s=e._MSAAFramebuffer||e._framebuffer;e._depthStencilBuffer&&t.deleteRenderbuffer(e._depthStencilBuffer),e._depthStencilBuffer=this._depthStencilBuffer,this._engine._bindUnboundFramebuffer(s),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,i),this._engine._bindUnboundFramebuffer(null)}_bindTextureRenderTarget(e,t=0,i=-1,s=0){if(!e._hardwareTexture)return;const r=this._context,n=this._framebuffer,o=this._engine._currentFramebuffer;this._engine._bindUnboundFramebuffer(n);const l=r[this._engine.webGLVersion>1?"COLOR_ATTACHMENT"+t:"COLOR_ATTACHMENT"+t+"_WEBGL"],h=i!==-1?r.TEXTURE_CUBE_MAP_POSITIVE_X+i:r.TEXTURE_2D;r.framebufferTexture2D(r.FRAMEBUFFER,l,h,e._hardwareTexture.underlyingResource,s),this._engine._bindUnboundFramebuffer(o)}setTexture(e,t=0,i=!0){super.setTexture(e,t,i),this._bindTextureRenderTarget(e,t)}dispose(e=!1){const t=this._context;e||(this._colorTextureArray&&(this._context.deleteTexture(this._colorTextureArray),this._colorTextureArray=null),this._depthStencilTextureArray&&(this._context.deleteTexture(this._depthStencilTextureArray),this._depthStencilTextureArray=null)),this._framebuffer&&(t.deleteFramebuffer(this._framebuffer),this._framebuffer=null),this._depthStencilBuffer&&(t.deleteRenderbuffer(this._depthStencilBuffer),this._depthStencilBuffer=null),this._MSAAFramebuffer&&(t.deleteFramebuffer(this._MSAAFramebuffer),this._MSAAFramebuffer=null),super.dispose(e)}}Te.prototype._createHardwareRenderTargetWrapper=function(a,e,t){const i=new xx(a,e,t,this,this._gl);return this._renderTargetWrapperCache.push(i),i};Te.prototype.createRenderTargetTexture=function(a,e){const t=this._createHardwareRenderTargetWrapper(!1,!1,a),i={};e!==void 0&&typeof e=="object"?(i.generateDepthBuffer=!!e.generateDepthBuffer,i.generateStencilBuffer=!!e.generateStencilBuffer,i.noColorTarget=!!e.noColorTarget):(i.generateDepthBuffer=!0,i.generateStencilBuffer=!1,i.noColorTarget=!1);const s=i.noColorTarget?null:this._createInternalTexture(a,e,!0,We.RenderTarget),r=a.width||a,n=a.height||a,o=this._currentFramebuffer,l=this._gl,h=l.createFramebuffer();return this._bindUnboundFramebuffer(h),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(!!i.generateStencilBuffer,i.generateDepthBuffer,r,n),s&&!s.is2DArray&&l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,s._hardwareTexture.underlyingResource,0),this._bindUnboundFramebuffer(o),t._framebuffer=h,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=!!i.generateStencilBuffer,t.setTextures(s),t};Te.prototype.createDepthStencilTexture=function(a,e,t){if(e.isCube){const i=a.width||a;return this._createDepthStencilCubeTexture(i,e,t)}else return this._createDepthStencilTexture(a,e,t)};Te.prototype._createDepthStencilTexture=function(a,e,t){const i=this._gl,s=a.layers||0,r=s!==0?i.TEXTURE_2D_ARRAY:i.TEXTURE_2D,n=new gt(this,We.DepthStencil);if(!this._caps.depthTextureExtension)return B.Error("Depth texture is not supported by your browser or hardware."),n;const o={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e};if(this._bindTextureDirectly(r,n,!0),this._setupDepthStencilTexture(n,a,o.generateStencil,o.comparisonFunction===0?!1:o.bilinearFiltering,o.comparisonFunction),o.depthTextureFormat!==void 0){if(o.depthTextureFormat!==15&&o.depthTextureFormat!==16&&o.depthTextureFormat!==17&&o.depthTextureFormat!==13&&o.depthTextureFormat!==14&&o.depthTextureFormat!==18)return B.Error("Depth texture format is not supported."),n;n.format=o.depthTextureFormat}else n.format=o.generateStencil?13:16;const l=n.format===17||n.format===13||n.format===18;t._depthStencilTexture=n,t._depthStencilTextureWithStencil=l;let h=i.UNSIGNED_INT;n.format===15?h=i.UNSIGNED_SHORT:n.format===17||n.format===13?h=i.UNSIGNED_INT_24_8:n.format===14?h=i.FLOAT:n.format===18&&(h=i.FLOAT_32_UNSIGNED_INT_24_8_REV);const c=l?i.DEPTH_STENCIL:i.DEPTH_COMPONENT;let u=c;this.webGLVersion>1&&(n.format===15?u=i.DEPTH_COMPONENT16:n.format===16?u=i.DEPTH_COMPONENT24:n.format===17||n.format===13?u=i.DEPTH24_STENCIL8:n.format===14?u=i.DEPTH_COMPONENT32F:n.format===18&&(u=i.DEPTH32F_STENCIL8)),n.is2DArray?i.texImage3D(r,0,u,n.width,n.height,s,0,c,h,null):i.texImage2D(r,0,u,n.width,n.height,0,c,h,null),this._bindTextureDirectly(r,null),this._internalTexturesCache.push(n);const d=t;if(d._depthStencilBuffer){const f=this._currentFramebuffer;this._bindUnboundFramebuffer(d._framebuffer),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_STENCIL_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,null),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,null),this._bindUnboundFramebuffer(f),i.deleteRenderbuffer(d._depthStencilBuffer),d._depthStencilBuffer=null}return n};Te.prototype.updateRenderTargetTextureSampleCount=function(a,e){if(this.webGLVersion<2||!a||!a.texture)return 1;if(a.samples===e)return e;const t=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples),a._depthStencilBuffer&&(t.deleteRenderbuffer(a._depthStencilBuffer),a._depthStencilBuffer=null),a._MSAAFramebuffer&&(t.deleteFramebuffer(a._MSAAFramebuffer),a._MSAAFramebuffer=null);const i=a.texture._hardwareTexture;if(i._MSAARenderBuffer&&(t.deleteRenderbuffer(i._MSAARenderBuffer),i._MSAARenderBuffer=null),e>1&&t.renderbufferStorageMultisample){const s=t.createFramebuffer();if(!s)throw new Error("Unable to create multi sampled framebuffer");a._MSAAFramebuffer=s,this._bindUnboundFramebuffer(a._MSAAFramebuffer);const r=this._createRenderBuffer(a.texture.width,a.texture.height,e,-1,this._getRGBAMultiSampleBufferFormat(a.texture.type),t.COLOR_ATTACHMENT0,!1);if(!r)throw new Error("Unable to create multi sampled framebuffer");i._MSAARenderBuffer=r}else this._bindUnboundFramebuffer(a._framebuffer);return a.texture.samples=e,a._depthStencilBuffer=this._setupFramebufferDepthAttachments(a._generateStencilBuffer,a._generateDepthBuffer,a.texture.width,a.texture.height,e),this._bindUnboundFramebuffer(null),e};Te.prototype.createRenderTargetCubeTexture=function(a,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,a),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,(i.type===1&&!this._caps.textureFloatLinearFiltering||i.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(i.samplingMode=1);const s=this._gl,r=new gt(this,We.RenderTarget);this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,r,!0);const n=this._getSamplingParameters(i.samplingMode,i.generateMipMaps);i.type===1&&!this._caps.textureFloat&&(i.type=0,B.Warn("Float textures are not supported. Cube render target forced to TEXTURETYPE_UNESIGNED_BYTE type")),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,n.mag),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,n.min),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE);for(let l=0;l<6;l++)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+l,0,this._getRGBABufferInternalSizedFormat(i.type,i.format),a,a,0,this._getInternalFormat(i.format),this._getWebGLTextureType(i.type),null);const o=s.createFramebuffer();return this._bindUnboundFramebuffer(o),t._depthStencilBuffer=this._setupFramebufferDepthAttachments(i.generateStencilBuffer,i.generateDepthBuffer,a,a),i.generateMipMaps&&s.generateMipmap(s.TEXTURE_CUBE_MAP),this._bindTextureDirectly(s.TEXTURE_CUBE_MAP,null),this._bindUnboundFramebuffer(null),t._framebuffer=o,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer,r.width=a,r.height=a,r.isReady=!0,r.isCube=!0,r.samples=1,r.generateMipMaps=i.generateMipMaps,r.samplingMode=i.samplingMode,r.type=i.type,r.format=i.format,this._internalTexturesCache.push(r),t.setTextures(r),t};class si extends H{constructor(e,t,i,s,r=!0,n=0,o=!1,l=H.TRILINEAR_SAMPLINGMODE,h=!0,c=!1,u=!1,d=5,f=!1,p,_,m=!1,v=!1){var x;if(super(null,i,!s,void 0,l,void 0,void 0,void 0,void 0,d),this._unObserveRenderList=null,this._renderListHasChanged=(S,C)=>{var E;const A=this._renderList?this._renderList.length:0;(C===0&&A>0||A===0)&&((E=this.getScene())===null||E===void 0||E.meshes.forEach(M=>{M._markSubMeshesAsLightDirty()}))},this.renderParticles=!0,this.renderSprites=!1,this.ignoreCameraViewport=!1,this.onBeforeBindObservable=new X,this.onAfterUnbindObservable=new X,this.onBeforeRenderObservable=new X,this.onAfterRenderObservable=new X,this.onClearObservable=new X,this.onResizeObservable=new X,this._cleared=!1,this.skipInitialClear=!1,this._currentRefreshId=-1,this._refreshRate=1,this._samples=1,this._canRescale=!0,this._renderTarget=null,this.boundingBoxPosition=g.Zero(),i=this.getScene(),!i)return;const b=this.getScene().getEngine();this._coordinatesMode=H.PROJECTION_MODE,this.renderList=new Array,this.name=e,this.isRenderTarget=!0,this._initialSizeParameter=t,this._renderPassIds=[],this._isCubeData=o,this._processSizeParameter(t),this.renderPassId=this._renderPassIds[0],this._resizeObserver=b.onResizeObservable.add(()=>{}),this._generateMipMaps=!!s,this._doNotChangeAspectRatio=r,this._renderingManager=new ns(i),this._renderingManager._useSceneAutoClearSetup=!0,!u&&(this._renderTargetOptions={generateMipMaps:s,type:n,format:(x=this._format)!==null&&x!==void 0?x:void 0,samplingMode:this.samplingMode,generateDepthBuffer:h,generateStencilBuffer:c,samples:p,creationFlags:_,noColorTarget:m,useSRGBBuffer:v},this.samplingMode===H.NEAREST_SAMPLINGMODE&&(this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE),f||(o?(this._renderTarget=i.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions),this.coordinatesMode=H.INVCUBIC_MODE,this._textureMatrix=L.Identity()):this._renderTarget=i.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,p!==void 0&&(this.samples=p)))}get renderList(){return this._renderList}set renderList(e){this._unObserveRenderList&&(this._unObserveRenderList(),this._unObserveRenderList=null),e&&(this._unObserveRenderList=s_(e,this._renderListHasChanged)),this._renderList=e}get postProcesses(){return this._postProcesses}get _prePassEnabled(){return!!this._prePassRenderTarget&&this._prePassRenderTarget.enabled}set onAfterUnbind(e){this._onAfterUnbindObserver&&this.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=this.onAfterUnbindObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}set onClear(e){this._onClearObserver&&this.onClearObservable.remove(this._onClearObserver),this._onClearObserver=this.onClearObservable.add(e)}get renderPassIds(){return this._renderPassIds}get currentRefreshId(){return this._currentRefreshId}setMaterialForRendering(e,t){let i;Array.isArray(e)?i=e:i=[e];for(let s=0;s<i.length;++s)for(let r=0;r<this._renderPassIds.length;++r)i[s].setMaterialForRenderPass(this._renderPassIds[r],t!==void 0?Array.isArray(t)?t[r]:t:void 0)}get renderTargetOptions(){return this._renderTargetOptions}get renderTarget(){return this._renderTarget}_onRatioRescale(){this._sizeRatio&&this.resize(this._initialSizeParameter)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}get depthStencilTexture(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e._depthStencilTexture)!==null&&t!==void 0?t:null}createDepthStencilTexture(e=0,t=!0,i=!1,s=1,r=14){var n;(n=this._renderTarget)===null||n===void 0||n.createDepthStencilTexture(e,t,i,s,r)}_releaseRenderPassId(){if(this._scene){const e=this._scene.getEngine();for(let t=0;t<this._renderPassIds.length;++t)e.releaseRenderPassId(this._renderPassIds[t])}this._renderPassIds=[]}_createRenderPassId(){this._releaseRenderPassId();const e=this._scene.getEngine(),t=this._isCubeData?6:this.getRenderLayers()||1;for(let i=0;i<t;++i)this._renderPassIds[i]=e.createRenderPassId(`RenderTargetTexture - ${this.name}#${i}`)}_processSizeParameter(e){if(e.ratio){this._sizeRatio=e.ratio;const t=this._getEngine();this._size={width:this._bestReflectionRenderTargetDimension(t.getRenderWidth(),this._sizeRatio),height:this._bestReflectionRenderTargetDimension(t.getRenderHeight(),this._sizeRatio)}}else this._size=e;this._createRenderPassId()}get samples(){var e,t;return(t=(e=this._renderTarget)===null||e===void 0?void 0:e.samples)!==null&&t!==void 0?t:this._samples}set samples(e){this._renderTarget&&(this._samples=this._renderTarget.setSamples(e))}resetRefreshCounter(){this._currentRefreshId=-1}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}addPostProcess(e){if(!this._postProcessManager){const t=this.getScene();if(!t)return;this._postProcessManager=new Yh(t),this._postProcesses=new Array}this._postProcesses.push(e),this._postProcesses[0].autoClear=!1}clearPostProcesses(e=!1){if(!!this._postProcesses){if(e)for(const t of this._postProcesses)t.dispose();this._postProcesses=[]}}removePostProcess(e){if(!this._postProcesses)return;const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses.splice(t,1),this._postProcesses.length>0&&(this._postProcesses[0].autoClear=!1))}_shouldRender(){return this._currentRefreshId===-1?(this._currentRefreshId=1,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this.getRenderWidth()}getRenderWidth(){return this._size.width?this._size.width:this._size}getRenderHeight(){return this._size.width?this._size.height:this._size}getRenderLayers(){const e=this._size.layers;return e||0}disableRescaling(){this._canRescale=!1}get canRescale(){return this._canRescale}scale(e){const t=Math.max(1,this.getRenderSize()*e);this.resize(t)}getReflectionTextureMatrix(){return this.isCube?this._textureMatrix:super.getReflectionTextureMatrix()}resize(e){var t;const i=this.isCube;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null;const s=this.getScene();!s||(this._processSizeParameter(e),i?this._renderTarget=s.getEngine().createRenderTargetCubeTexture(this.getRenderSize(),this._renderTargetOptions):this._renderTarget=s.getEngine().createRenderTargetTexture(this._size,this._renderTargetOptions),this._texture=this._renderTarget.texture,this._renderTargetOptions.samples!==void 0&&(this.samples=this._renderTargetOptions.samples),this.onResizeObservable.hasObservers()&&this.onResizeObservable.notifyObservers(this))}render(e=!1,t=!1){this._render(e,t)}isReadyForRendering(){return this._render(!1,!1,!0)}_render(e=!1,t=!1,i=!1){var s;const r=this.getScene();if(!r)return i;const n=r.getEngine();if(this.useCameraPostProcesses!==void 0&&(e=this.useCameraPostProcesses),this._waitingRenderList){this.renderList=[];for(let u=0;u<this._waitingRenderList.length;u++){const d=this._waitingRenderList[u],f=r.getMeshById(d);f&&this.renderList.push(f)}this._waitingRenderList=void 0}if(this.renderListPredicate){this.renderList?this.renderList.length=0:this.renderList=[];const u=this.getScene();if(!u)return i;const d=u.meshes;for(let f=0;f<d.length;f++){const p=d[f];this.renderListPredicate(p)&&this.renderList.push(p)}}const o=n.currentRenderPassId;this.onBeforeBindObservable.notifyObservers(this);const l=(s=this.activeCamera)!==null&&s!==void 0?s:r.activeCamera,h=r.activeCamera;l&&(l!==r.activeCamera&&(r.setTransformMatrix(l.getViewMatrix(),l.getProjectionMatrix(!0)),r.activeCamera=l),n.setViewport(l.viewport,this.getRenderWidth(),this.getRenderHeight())),this._defaultRenderListPrepared=!1;let c=i;if(i){r.getViewMatrix()||r.updateTransformMatrix();const u=this.is2DArray?this.getRenderLayers():this.isCube?6:1;for(let d=0;d<u&&c;d++){let f=null;const p=this.renderList?this.renderList:r.getActiveMeshes().data,_=this.renderList?this.renderList.length:r.getActiveMeshes().length;n.currentRenderPassId=this._renderPassIds[d],this.onBeforeRenderObservable.notifyObservers(d),this.getCustomRenderList&&(f=this.getCustomRenderList(d,p,_)),f||(f=p),this._doNotChangeAspectRatio||r.updateTransformMatrix(!0);for(let m=0;m<f.length&&c;++m){const v=f[m];if(!(!v.isEnabled()||v.isBlocked||!v.isVisible||!v.subMeshes)){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(v,this.refreshRate)){c=!1;break}}else if(!v.isReady(!0)){c=!1;break}}}this.onAfterRenderObservable.notifyObservers(d)}}else if(this.is2DArray)for(let u=0;u<this.getRenderLayers();u++)this._renderToTarget(0,e,t,u,l),r.incrementRenderId(),r.resetCachedMaterial();else if(this.isCube)for(let u=0;u<6;u++)this._renderToTarget(u,e,t,void 0,l),r.incrementRenderId(),r.resetCachedMaterial();else this._renderToTarget(0,e,t,void 0,l);return this.onAfterUnbindObservable.notifyObservers(this),n.currentRenderPassId=o,h&&(r.activeCamera=h,(r.getEngine().scenes.length>1||this.activeCamera&&this.activeCamera!==r.activeCamera)&&r.setTransformMatrix(r.activeCamera.getViewMatrix(),r.activeCamera.getProjectionMatrix(!0)),n.setViewport(r.activeCamera.viewport)),r.resetCachedMaterial(),c}_bestReflectionRenderTargetDimension(e,t){const s=e*t,r=k.NearestPOT(s+128*128/(128+s));return Math.min(k.FloorPOT(e),r)}_prepareRenderingManager(e,t,i,s){const r=this.getScene();if(!r)return;this._renderingManager.reset();const n=r.getRenderId();for(let o=0;o<t;o++){const l=e[o];if(l&&!l.isBlocked){if(this.customIsReadyFunction){if(!this.customIsReadyFunction(l,this.refreshRate)){this.resetRefreshCounter();continue}}else if(!l.isReady(this.refreshRate===0)){this.resetRefreshCounter();continue}if(!l._internalAbstractMeshDataInfo._currentLODIsUpToDate&&r.activeCamera&&(l._internalAbstractMeshDataInfo._currentLOD=r.customLODSelector?r.customLODSelector(l,this.activeCamera||r.activeCamera):l.getLOD(this.activeCamera||r.activeCamera),l._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0),!l._internalAbstractMeshDataInfo._currentLOD)continue;let h=l._internalAbstractMeshDataInfo._currentLOD;h._preActivateForIntermediateRendering(n);let c;if(s&&i?c=(l.layerMask&i.layerMask)===0:c=!1,l.isEnabled()&&l.isVisible&&l.subMeshes&&!c&&(h!==l&&h._activate(n,!0),l._activate(n,!0)&&l.subMeshes.length)){l.isAnInstance?l._internalAbstractMeshDataInfo._actAsRegularMesh&&(h=l):h._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!1,h._internalAbstractMeshDataInfo._isActiveIntermediate=!0;for(let u=0;u<h.subMeshes.length;u++){const d=h.subMeshes[u];this._renderingManager.dispatch(d,h)}}}}for(let o=0;o<r.particleSystems.length;o++){const l=r.particleSystems[o],h=l.emitter;!l.isStarted()||!h||!h.position||!h.isEnabled()||e.indexOf(h)>=0&&this._renderingManager.dispatchParticles(l)}}_bindFrameBuffer(e=0,t=0){const i=this.getScene();if(!i)return;const s=i.getEngine();this._renderTarget&&s.bindFramebuffer(this._renderTarget,this.isCube?e:void 0,void 0,void 0,this.ignoreCameraViewport,0,t)}_unbindFrameBuffer(e,t){!this._renderTarget||e.unBindFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}_prepareFrame(e,t,i,s){this._postProcessManager?this._prePassEnabled||this._postProcessManager._prepareFrame(this._texture,this._postProcesses):(!s||!e.postProcessManager._prepareFrame(this._texture))&&this._bindFrameBuffer(t,i)}_renderToTarget(e,t,i,s=0,r=null){var n,o,l,h,c,u;const d=this.getScene();if(!d)return;const f=d.getEngine();if((n=f._debugPushGroup)===null||n===void 0||n.call(f,`render to face #${e} layer #${s}`,1),this._prepareFrame(d,e,s,t),this.is2DArray?(f.currentRenderPassId=this._renderPassIds[s],this.onBeforeRenderObservable.notifyObservers(s)):(f.currentRenderPassId=this._renderPassIds[e],this.onBeforeRenderObservable.notifyObservers(e)),f.snapshotRendering&&f.snapshotRenderingMode===1)this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0);else{let _=null;const m=this.renderList?this.renderList:d.getActiveMeshes().data,v=this.renderList?this.renderList.length:d.getActiveMeshes().length;this.getCustomRenderList&&(_=this.getCustomRenderList(this.is2DArray?s:e,m,v)),_?this._prepareRenderingManager(_,_.length,r,!1):(this._defaultRenderListPrepared||(this._prepareRenderingManager(m,v,r,!this.renderList),this._defaultRenderListPrepared=!0),_=m);for(const b of d._beforeRenderTargetClearStage)b.action(this,e,s);this.onClearObservable.hasObservers()?this.onClearObservable.notifyObservers(f):this.skipInitialClear||f.clear(this.clearColor||d.clearColor,!0,!0,!0),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0);for(const b of d._beforeRenderTargetDrawStage)b.action(this,e,s);this._renderingManager.render(this.customRenderFunction,_,this.renderParticles,this.renderSprites);for(const b of d._afterRenderTargetDrawStage)b.action(this,e,s);const x=(l=(o=this._texture)===null||o===void 0?void 0:o.generateMipMaps)!==null&&l!==void 0?l:!1;this._texture&&(this._texture.generateMipMaps=!1),this._postProcessManager?this._postProcessManager._finalizeFrame(!1,(h=this._renderTarget)!==null&&h!==void 0?h:void 0,e,this._postProcesses,this.ignoreCameraViewport):t&&d.postProcessManager._finalizeFrame(!1,(c=this._renderTarget)!==null&&c!==void 0?c:void 0,e);for(const b of d._afterRenderTargetPostProcessStage)b.action(this,e,s);this._texture&&(this._texture.generateMipMaps=x),this._doNotChangeAspectRatio||d.updateTransformMatrix(!0),i&&q.DumpFramebuffer(this.getRenderWidth(),this.getRenderHeight(),f)}this._unbindFrameBuffer(f,e),this._texture&&this.isCube&&e===5&&f.generateMipMapsForCubemap(this._texture),(u=f._debugPopGroup)===null||u===void 0||u.call(f,1)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t){this._renderingManager.setRenderingAutoClearDepthStencil(e,t),this._renderingManager._useSceneAutoClearSetup=!1}clone(){const e=this.getSize(),t=new si(this.name,e,this.getScene(),this._renderTargetOptions.generateMipMaps,this._doNotChangeAspectRatio,this._renderTargetOptions.type,this.isCube,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer,this._renderTargetOptions.generateStencilBuffer,void 0,this._renderTargetOptions.format,void 0,this._renderTargetOptions.samples);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,this.renderList&&(t.renderList=this.renderList.slice(0)),t}serialize(){if(!this.name)return null;const e=super.serialize();if(e.renderTargetSize=this.getRenderSize(),e.renderList=[],this.renderList)for(let t=0;t<this.renderList.length;t++)e.renderList.push(this.renderList[t].id);return e}disposeFramebufferObjects(){var e;(e=this._renderTarget)===null||e===void 0||e.dispose(!0)}releaseInternalTexture(){var e;(e=this._renderTarget)===null||e===void 0||e.releaseTextures(),this._texture=null}dispose(){var e;this.onResizeObservable.clear(),this.onClearObservable.clear(),this.onAfterRenderObservable.clear(),this.onAfterUnbindObservable.clear(),this.onBeforeBindObservable.clear(),this.onBeforeRenderObservable.clear(),this._postProcessManager&&(this._postProcessManager.dispose(),this._postProcessManager=null),this._prePassRenderTarget&&this._prePassRenderTarget.dispose(),this._releaseRenderPassId(),this.clearPostProcesses(!0),this._resizeObserver&&(this.getScene().getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.renderList=null;const t=this.getScene();if(!t)return;let i=t.customRenderTargets.indexOf(this);i>=0&&t.customRenderTargets.splice(i,1);for(const s of t.cameras)i=s.customRenderTargets.indexOf(this),i>=0&&s.customRenderTargets.splice(i,1);(e=this._renderTarget)===null||e===void 0||e.dispose(),this._renderTarget=null,this._texture=null,super.dispose()}_rebuild(){this.refreshRate===si.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=si.REFRESHRATE_RENDER_ONCE),this._postProcessManager&&this._postProcessManager._rebuild()}freeRenderingGroups(){this._renderingManager&&this._renderingManager.freeRenderingGroups()}getViewCount(){return 1}}si.REFRESHRATE_RENDER_ONCE=0;si.REFRESHRATE_RENDER_ONEVERYFRAME=1;si.REFRESHRATE_RENDER_ONEVERYTWOFRAMES=2;H._CreateRenderTargetTexture=(a,e,t,i,s)=>new si(a,e,t,i);const Tx="postprocessVertexShader",bx=`attribute vec2 position;
uniform vec2 scale;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd)*scale;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[Tx]=bx;class Fe{constructor(e,t,i,s,r,n,o=1,l,h,c=null,u=0,d="postprocess",f,p=!1,_=5){this._parentContainer=null,this.width=-1,this.height=-1,this.nodeMaterialSource=null,this._outputTexture=null,this.autoClear=!0,this.alphaMode=0,this.animations=new Array,this.enablePixelPerfectMode=!1,this.forceFullscreenViewport=!0,this.scaleMode=1,this.alwaysForcePOT=!1,this._samples=1,this.adaptScaleToCurrentViewport=!1,this._reusable=!1,this._renderId=0,this.externalTextureSamplerBinding=!1,this._textures=new mi(2),this._textureCache=[],this._currentRenderTextureInd=0,this._scaleRatio=new le(1,1),this._texelSize=le.Zero(),this.onActivateObservable=new X,this.onSizeChangedObservable=new X,this.onApplyObservable=new X,this.onBeforeRenderObservable=new X,this.onAfterRenderObservable=new X,this.name=e,n!=null?(this._camera=n,this._scene=n.getScene(),n.attachPostProcess(this),this._engine=this._scene.getEngine(),this._scene.postProcesses.push(this),this.uniqueId=this._scene.getUniqueId()):l&&(this._engine=l,this._engine.postProcesses.push(this)),this._options=r,this.renderTargetSamplingMode=o||1,this._reusable=h||!1,this._textureType=u,this._textureFormat=_,this._samplers=s||[],this._samplers.push("textureSampler"),this._fragmentUrl=t,this._vertexUrl=d,this._parameters=i||[],this._parameters.push("scale"),this._indexParameters=f,this._drawWrapper=new Vi(this._engine),p||this.updateEffect(c)}get samples(){return this._samples}set samples(e){this._samples=Math.min(e,this._engine.getCaps().maxMSAASamples),this._textures.forEach(t=>{t.samples!==this._samples&&this._engine.updateRenderTargetTextureSampleCount(t,this._samples)})}getEffectName(){return this._fragmentUrl}set onActivate(e){this._onActivateObserver&&this.onActivateObservable.remove(this._onActivateObserver),e&&(this._onActivateObserver=this.onActivateObservable.add(e))}set onSizeChanged(e){this._onSizeChangedObserver&&this.onSizeChangedObservable.remove(this._onSizeChangedObserver),this._onSizeChangedObserver=this.onSizeChangedObservable.add(e)}set onApply(e){this._onApplyObserver&&this.onApplyObservable.remove(this._onApplyObserver),this._onApplyObserver=this.onApplyObservable.add(e)}set onBeforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e)}set onAfterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),this._onAfterRenderObserver=this.onAfterRenderObservable.add(e)}get inputTexture(){return this._textures.data[this._currentRenderTextureInd]}set inputTexture(e){this._forcedOutputTexture=e}restoreDefaultInputTexture(){this._forcedOutputTexture&&(this._forcedOutputTexture=null,this.markTextureDirty())}getCamera(){return this._camera}get texelSize(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.texelSize:(this._forcedOutputTexture&&this._texelSize.copyFromFloats(1/this._forcedOutputTexture.width,1/this._forcedOutputTexture.height),this._texelSize)}getClassName(){return"PostProcess"}getEngine(){return this._engine}getEffect(){return this._drawWrapper.effect}shareOutputWith(e){return this._disposeTextures(),this._shareOutputWithPostProcess=e,this}useOwnOutput(){this._textures.length==0&&(this._textures=new mi(2)),this._shareOutputWithPostProcess=null}updateEffect(e=null,t=null,i=null,s,r,n,o,l){this._postProcessDefines=e,this._drawWrapper.effect=this._engine.createEffect({vertex:o!=null?o:this._vertexUrl,fragment:l!=null?l:this._fragmentUrl},["position"],t||this._parameters,i||this._samplers,e!==null?e:"",void 0,r,n,s||this._indexParameters)}isReusable(){return this._reusable}markTextureDirty(){this.width=-1}_createRenderTargetTexture(e,t,i=0){for(let r=0;r<this._textureCache.length;r++)if(this._textureCache[r].texture.width===e.width&&this._textureCache[r].texture.height===e.height&&this._textureCache[r].postProcessChannel===i&&this._textureCache[r].texture._generateDepthBuffer===t.generateDepthBuffer)return this._textureCache[r].texture;const s=this._engine.createRenderTargetTexture(e,t);return this._textureCache.push({texture:s,postProcessChannel:i,lastUsedRenderId:-1}),s}_flushTextureCache(){const e=this._renderId;for(let t=this._textureCache.length-1;t>=0;t--)if(e-this._textureCache[t].lastUsedRenderId>100){let i=!1;for(let s=0;s<this._textures.length;s++)if(this._textures.data[s]===this._textureCache[t].texture){i=!0;break}i||(this._textureCache[t].texture.dispose(),this._textureCache.splice(t,1))}}_resize(e,t,i,s,r){this._textures.length>0&&this._textures.reset(),this.width=e,this.height=t;let n=null;for(let h=0;h<i._postProcesses.length;h++)if(i._postProcesses[h]!==null){n=i._postProcesses[h];break}const o={width:this.width,height:this.height},l={generateMipMaps:s,generateDepthBuffer:r||n===this,generateStencilBuffer:(r||n===this)&&this._engine.isStencilEnable,samplingMode:this.renderTargetSamplingMode,type:this._textureType,format:this._textureFormat};this._textures.push(this._createRenderTargetTexture(o,l,0)),this._reusable&&this._textures.push(this._createRenderTargetTexture(o,l,1)),this._texelSize.copyFromFloats(1/this.width,1/this.height),this.onSizeChangedObservable.notifyObservers(this)}activate(e,t=null,i){var s,r;e=e||this._camera;const n=e.getScene(),o=n.getEngine(),l=o.getCaps().maxTextureSize;let h=(t?t.width:this._engine.getRenderWidth(!0))*this._options|0;const c=(t?t.height:this._engine.getRenderHeight(!0))*this._options|0,u=e.parent;u&&(u.leftCamera==e||u.rightCamera==e)&&(h/=2);let d=this._options.width||h,f=this._options.height||c;const p=this.renderTargetSamplingMode!==7&&this.renderTargetSamplingMode!==1&&this.renderTargetSamplingMode!==2;if(!this._shareOutputWithPostProcess&&!this._forcedOutputTexture){if(this.adaptScaleToCurrentViewport){const m=o.currentViewport;m&&(d*=m.width,f*=m.height)}(p||this.alwaysForcePOT)&&(this._options.width||(d=o.needPOTTextures?k.GetExponentOfTwo(d,l,this.scaleMode):d),this._options.height||(f=o.needPOTTextures?k.GetExponentOfTwo(f,l,this.scaleMode):f)),(this.width!==d||this.height!==f)&&this._resize(d,f,e,p,i),this._textures.forEach(m=>{m.samples!==this.samples&&this._engine.updateRenderTargetTextureSampleCount(m,this.samples)}),this._flushTextureCache(),this._renderId++}let _;if(this._shareOutputWithPostProcess)_=this._shareOutputWithPostProcess.inputTexture;else if(this._forcedOutputTexture)_=this._forcedOutputTexture,this.width=this._forcedOutputTexture.width,this.height=this._forcedOutputTexture.height;else{_=this.inputTexture;let m;for(let v=0;v<this._textureCache.length;v++)if(this._textureCache[v].texture===_){m=this._textureCache[v];break}m&&(m.lastUsedRenderId=this._renderId)}return this.enablePixelPerfectMode?(this._scaleRatio.copyFromFloats(h/d,c/f),this._engine.bindFramebuffer(_,0,h,c,this.forceFullscreenViewport)):(this._scaleRatio.copyFromFloats(1,1),this._engine.bindFramebuffer(_,0,void 0,void 0,this.forceFullscreenViewport)),(r=(s=this._engine)._debugInsertMarker)===null||r===void 0||r.call(s,`post process ${this.name} input`),this.onActivateObservable.notifyObservers(e),this.autoClear&&this.alphaMode===0&&this._engine.clear(this.clearColor?this.clearColor:n.clearColor,n._allowPostProcessClearColor,!0,!0),this._reusable&&(this._currentRenderTextureInd=(this._currentRenderTextureInd+1)%2),_}get isSupported(){return this._drawWrapper.effect.isSupported}get aspectRatio(){return this._shareOutputWithPostProcess?this._shareOutputWithPostProcess.aspectRatio:this._forcedOutputTexture?this._forcedOutputTexture.width/this._forcedOutputTexture.height:this.width/this.height}isReady(){var e,t;return(t=(e=this._drawWrapper.effect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}apply(){var e;if(!(!((e=this._drawWrapper.effect)===null||e===void 0)&&e.isReady()))return null;this._engine.enableEffect(this._drawWrapper),this._engine.setState(!1),this._engine.setDepthBuffer(!1),this._engine.setDepthWrite(!1),this._engine.setAlphaMode(this.alphaMode),this.alphaConstants&&this.getEngine().setAlphaConstants(this.alphaConstants.r,this.alphaConstants.g,this.alphaConstants.b,this.alphaConstants.a);let t;return this._shareOutputWithPostProcess?t=this._shareOutputWithPostProcess.inputTexture:this._forcedOutputTexture?t=this._forcedOutputTexture:t=this.inputTexture,this.externalTextureSamplerBinding||this._drawWrapper.effect._bindTexture("textureSampler",t==null?void 0:t.texture),this._drawWrapper.effect.setVector2("scale",this._scaleRatio),this.onApplyObservable.notifyObservers(this._drawWrapper.effect),this._drawWrapper.effect}_disposeTextures(){if(this._shareOutputWithPostProcess||this._forcedOutputTexture){this._disposeTextureCache();return}this._disposeTextureCache(),this._textures.dispose()}_disposeTextureCache(){for(let e=this._textureCache.length-1;e>=0;e--)this._textureCache[e].texture.dispose();this._textureCache.length=0}setPrePassRenderer(e){return this._prePassEffectConfiguration?(this._prePassEffectConfiguration=e.addEffectConfiguration(this._prePassEffectConfiguration),this._prePassEffectConfiguration.enabled=!0,!0):!1}dispose(e){e=e||this._camera,this._disposeTextures();let t;if(this._scene&&(t=this._scene.postProcesses.indexOf(this),t!==-1&&this._scene.postProcesses.splice(t,1)),this._parentContainer){const i=this._parentContainer.postProcesses.indexOf(this);i>-1&&this._parentContainer.postProcesses.splice(i,1),this._parentContainer=null}if(t=this._engine.postProcesses.indexOf(this),t!==-1&&this._engine.postProcesses.splice(t,1),!!e){if(e.detachPostProcess(this),t=e._postProcesses.indexOf(this),t===0&&e._postProcesses.length>0){const i=this._camera._getFirstPostProcess();i&&i.markTextureDirty()}this.onActivateObservable.clear(),this.onAfterRenderObservable.clear(),this.onApplyObservable.clear(),this.onBeforeRenderObservable.clear(),this.onSizeChangedObservable.clear()}}serialize(){const e=xe.Serialize(this),t=this.getCamera()||this._scene&&this._scene.activeCamera;return e.customType="BABYLON."+this.getClassName(),e.cameraId=t?t.id:null,e.reusable=this._reusable,e.textureType=this._textureType,e.fragmentUrl=this._fragmentUrl,e.parameters=this._parameters,e.samplers=this._samplers,e.options=this._options,e.defines=this._postProcessDefines,e.textureFormat=this._textureFormat,e.vertexUrl=this._vertexUrl,e.indexParameters=this._indexParameters,e}clone(){const e=this.serialize();e._engine=this._engine,e.cameraId=null;const t=Fe.Parse(e,this._scene,"");return t?(t.onActivateObservable=this.onActivateObservable.clone(),t.onSizeChangedObservable=this.onSizeChangedObservable.clone(),t.onApplyObservable=this.onApplyObservable.clone(),t.onBeforeRenderObservable=this.onBeforeRenderObservable.clone(),t.onAfterRenderObservable=this.onAfterRenderObservable.clone(),t._prePassEffectConfiguration=this._prePassEffectConfiguration,t):null}static Parse(e,t,i){const s=Si(e.customType);if(!s||!s._Parse)return null;const r=t?t.getCameraById(e.cameraId):null;return s._Parse(e,r,t,i)}static _Parse(e,t,i,s){return xe.Parse(()=>new Fe(e.name,e.fragmentUrl,e.parameters,e.samplers,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable,e.defines,e.textureType,e.vertexUrl,e.indexParameters,!1,e.textureFormat),e,i,s)}}T([R()],Fe.prototype,"uniqueId",void 0);T([R()],Fe.prototype,"name",void 0);T([R()],Fe.prototype,"width",void 0);T([R()],Fe.prototype,"height",void 0);T([R()],Fe.prototype,"renderTargetSamplingMode",void 0);T([Od()],Fe.prototype,"clearColor",void 0);T([R()],Fe.prototype,"autoClear",void 0);T([R()],Fe.prototype,"alphaMode",void 0);T([R()],Fe.prototype,"alphaConstants",void 0);T([R()],Fe.prototype,"enablePixelPerfectMode",void 0);T([R()],Fe.prototype,"forceFullscreenViewport",void 0);T([R()],Fe.prototype,"scaleMode",void 0);T([R()],Fe.prototype,"alwaysForcePOT",void 0);T([R("samples")],Fe.prototype,"_samples",void 0);T([R()],Fe.prototype,"adaptScaleToCurrentViewport",void 0);he("BABYLON.PostProcess",Fe);const Sx="passPixelShader",Ex=`varying vec2 vUV;
uniform sampler2D textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
}`;Y.ShadersStore[Sx]=Ex;const Cx="passCubePixelShader",yx=`varying vec2 vUV;
uniform samplerCube textureSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec2 uv=vUV*2.0-1.0;
#ifdef POSITIVEX
gl_FragColor=textureCube(textureSampler,vec3(1.001,uv.y,uv.x));
#endif
#ifdef NEGATIVEX
gl_FragColor=textureCube(textureSampler,vec3(-1.001,uv.y,uv.x));
#endif
#ifdef POSITIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,1.001,uv.x));
#endif
#ifdef NEGATIVEY
gl_FragColor=textureCube(textureSampler,vec3(uv.y,-1.001,uv.x));
#endif
#ifdef POSITIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,1.001));
#endif
#ifdef NEGATIVEZ
gl_FragColor=textureCube(textureSampler,vec3(uv,-1.001));
#endif
}`;Y.ShadersStore[Cx]=yx;class Sn extends Fe{getClassName(){return"PassPostProcess"}constructor(e,t,i=null,s,r,n,o=0,l=!1){super(e,"pass",null,null,t,i,s,r,n,void 0,o,void 0,null,l)}static _Parse(e,t,i,s){return xe.Parse(()=>new Sn(e.name,e.options,t,e.renderTargetSamplingMode,e._engine,e.reusable),e,i,s)}}he("BABYLON.PassPostProcess",Sn);k._RescalePostProcessFactory=a=>new Sn("rescale",1,null,2,a,!1,0);function Ax(a,e,t,i,s,r){const n=e.getEngine();return e.isReady=!1,s=s!=null?s:e.samplingMode,i=i!=null?i:e.type,r=r!=null?r:e.format,i===-1&&(i=0),new Promise(o=>{const l=new Fe("postprocess",a,null,null,1,null,s,n,!1,void 0,i,void 0,null,!1,r);l.externalTextureSamplerBinding=!0;const h=n.createRenderTargetTexture({width:e.width,height:e.height},{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:s,type:i,format:r});l.getEffect().executeWhenCompiled(()=>{l.onApply=c=>{c._bindTexture("textureSampler",e),c.setFloat2("scale",1,1)},t.postProcessManager.directRender([l],h,!0),n.restoreDefaultFramebuffer(),n._releaseTexture(e),l&&l.dispose(),h._swapAndDie(e),e.type=i,e.format=5,e.isReady=!0,o(e)})})}let gh,cf;function cn(a){gh||(gh=new Float32Array(1),cf=new Int32Array(gh.buffer)),gh[0]=a;const e=cf[0];let t=e>>16&32768,i=e>>12&2047;const s=e>>23&255;return s<103?t:s>142?(t|=31744,t|=(s==255?0:1)&&e&8388607,t):s<113?(i|=2048,t|=(i>>114-s)+(i>>113-s&1),t):(t|=s-112<<10|i>>1,t+=i&1,t)}function ln(a){const e=(a&32768)>>15,t=(a&31744)>>10,i=a&1023;return t===0?(e?-1:1)*Math.pow(2,-14)*(i/Math.pow(2,10)):t==31?i?NaN:(e?-1:1)*(1/0):(e?-1:1)*Math.pow(2,t-15)*(1+i/Math.pow(2,10))}class Nd{constructor(e){this._deferredReleaseBuffers=[],this._device=e}static _IsGPUBuffer(e){return e.underlyingResource===void 0}createRawBuffer(e,t,i=!1){const s=e.byteLength!==void 0?e.byteLength+3&-4:e+3&-4,r={mappedAtCreation:i,size:s,usage:t};return this._device.createBuffer(r)}createBuffer(e,t){const i=e.byteLength!==void 0,s=this.createRawBuffer(e,t),r=new cx(s);return r.references=1,r.capacity=i?e.byteLength:e,i&&this.setSubData(r,0,e),r}setRawData(e,t,i,s,r){this._device.queue.writeBuffer(e,t,i.buffer,s,r)}setSubData(e,t,i,s=0,r=0){const n=e.underlyingResource;r=r||i.byteLength,r=Math.min(r,e.capacity-t);let o=i.byteOffset+s,l=o+r;const h=r+3&-4;if(h!==r){const d=new Uint8Array(i.buffer.slice(o,l));i=new Uint8Array(h),i.set(d),s=0,o=0,l=h,r=h}const c=1024*1024*15;let u=0;for(;l-(o+u)>c;)this._device.queue.writeBuffer(n,t+u,i.buffer,o+u,c),u+=c;this._device.queue.writeBuffer(n,t+u,i.buffer,o+u,r-u)}_getHalfFloatAsFloatRGBAArrayBuffer(e,t,i){i||(i=new Float32Array(e));const s=new Uint16Array(t);for(;e--;)i[e]=ln(s[e]);return i}readDataFromBuffer(e,t,i,s,r,n,o=0,l=0,h=null,c=!0,u=!1){const d=o===1?2:o===2?1:0;return new Promise((f,p)=>{e.mapAsync(Aa.Read,l,t).then(()=>{const _=e.getMappedRange(l,t);let m=h;if(u)m===null?m=$u(o,t,!0,_):m=$u(o,m.buffer,void 0,_);else if(m===null)switch(d){case 0:m=new Uint8Array(t),m.set(new Uint8Array(_));break;case 1:m=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_);break;case 2:m=new Float32Array(t/4),m.set(new Float32Array(_));break}else switch(d){case 0:m=new Uint8Array(m.buffer),m.set(new Uint8Array(_));break;case 1:m=this._getHalfFloatAsFloatRGBAArrayBuffer(t/2,_,h);break;case 2:m=new Float32Array(m.buffer),m.set(new Float32Array(_));break}if(r!==n){d===1&&!u&&(r*=2,n*=2);const v=new Uint8Array(m.buffer);let x=r,b=0;for(let S=1;S<s;++S){b=S*n;for(let C=0;C<r;++C)v[x++]=v[b++]}d!==0&&!u?m=new Float32Array(v.buffer,0,x/4):m=new Uint8Array(v.buffer,0,x)}e.unmap(),c&&this.releaseBuffer(e),f(m)},_=>p(_))})}releaseBuffer(e){return Nd._IsGPUBuffer(e)?(this._deferredReleaseBuffers.push(e),!0):(e.references--,e.references===0?(this._deferredReleaseBuffers.push(e.underlyingResource),!0):!1)}destroyDeferredBuffers(){for(let e=0;e<this._deferredReleaseBuffers.length;++e)this._deferredReleaseBuffers[e].destroy();this._deferredReleaseBuffers.length=0}}class uf{constructor(){this.colorAttachmentGPUTextures=[],this.reset()}reset(e=!1){this.renderPass=null,e&&(this.renderPassDescriptor=null,this.colorAttachmentViewDescriptor=null,this.depthAttachmentViewDescriptor=null,this.colorAttachmentGPUTextures=[],this.depthTextureFormat=void 0)}}const Rx=[0|0<<1|0<<2,0|0<<1|0<<2,1|1<<1|0<<2,1|1<<1|1<<2,0|0<<1|0<<2,0|1<<1|0<<2,0|1<<1|1<<2,0|1<<1|0<<2,0|0<<1|1<<2,1|0<<1|0<<2,1|0<<1|1<<2,1|1<<1|0<<2,1|0<<1|0<<2],Ix=[0<<3|0<<4|0<<5|0<<6,0<<3|0<<4|0<<5|1<<6,0<<3|0<<4|1<<5|0<<6,0<<3|0<<4|1<<5|1<<6,0<<3|1<<4|0<<5|0<<6,0<<3|1<<4|0<<5|1<<6,0<<3|1<<4|1<<5|0<<6,0<<3|1<<4|1<<5|1<<6,1<<3|0<<4|0<<5|0<<6],Px=[0<<7,1<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7,0<<7,0<<7,0<<7,0<<7,1<<7];class Ea{constructor(e){this._samplers={},this._device=e,this.disabled=!1}static GetSamplerHashCode(e){var t,i,s;const r=e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1;return Rx[e.samplingMode]+Ix[(e._comparisonFunction||514)-512+1]+Px[e.samplingMode]+(((t=e._cachedWrapU)!==null&&t!==void 0?t:1)<<8)+(((i=e._cachedWrapV)!==null&&i!==void 0?i:1)<<10)+(((s=e._cachedWrapR)!==null&&s!==void 0?s:1)<<12)+((e.useMipMaps?1:0)<<14)+(r<<15)}static _GetSamplerFilterDescriptor(e,t){let i,s,r,n,o;const l=e.useMipMaps;switch(e.samplingMode){case 11:i=st.Linear,s=st.Linear,r=st.Nearest,l||(n=o=0);break;case 3:case 3:i=st.Linear,s=st.Linear,l?r=st.Linear:(r=st.Nearest,n=o=0);break;case 8:i=st.Nearest,s=st.Nearest,l?r=st.Linear:(r=st.Nearest,n=o=0);break;case 4:i=st.Nearest,s=st.Nearest,r=st.Nearest,l||(n=o=0);break;case 5:i=st.Nearest,s=st.Linear,r=st.Nearest,l||(n=o=0);break;case 6:i=st.Nearest,s=st.Linear,l?r=st.Linear:(r=st.Nearest,n=o=0);break;case 7:i=st.Nearest,s=st.Linear,r=st.Nearest,n=o=0;break;case 1:case 1:i=st.Nearest,s=st.Nearest,r=st.Nearest,n=o=0;break;case 9:i=st.Linear,s=st.Nearest,r=st.Nearest,l||(n=o=0);break;case 10:i=st.Linear,s=st.Nearest,l?r=st.Linear:(r=st.Nearest,n=o=0);break;case 2:case 2:i=st.Linear,s=st.Linear,r=st.Nearest,n=o=0;break;case 12:i=st.Linear,s=st.Nearest,r=st.Nearest,n=o=0;break;default:i=st.Nearest,s=st.Nearest,r=st.Nearest,n=o=0;break}return t>1&&(n!==0||o!==0)?{magFilter:st.Linear,minFilter:st.Linear,mipmapFilter:st.Linear,anisotropyEnabled:!0}:{magFilter:i,minFilter:s,mipmapFilter:r,lodMinClamp:n,lodMaxClamp:o}}static _GetWrappingMode(e){switch(e){case 1:return lo.Repeat;case 0:return lo.ClampToEdge;case 2:return lo.MirrorRepeat}return lo.Repeat}static _GetSamplerWrappingDescriptor(e){return{addressModeU:this._GetWrappingMode(e._cachedWrapU),addressModeV:this._GetWrappingMode(e._cachedWrapV),addressModeW:this._GetWrappingMode(e._cachedWrapR)}}static _GetSamplerDescriptor(e){const t=e.useMipMaps&&e._cachedAnisotropicFilteringLevel&&e._cachedAnisotropicFilteringLevel>1?4:1,i=this._GetSamplerFilterDescriptor(e,t);return{...i,...this._GetSamplerWrappingDescriptor(e),compare:e._comparisonFunction?Ea.GetCompareFunction(e._comparisonFunction):void 0,maxAnisotropy:i.anisotropyEnabled?t:1}}static GetCompareFunction(e){switch(e){case 519:return Li.Always;case 514:return Li.Equal;case 516:return Li.Greater;case 518:return Li.GreaterEqual;case 513:return Li.Less;case 515:return Li.LessEqual;case 512:return Li.Never;case 517:return Li.NotEqual;default:return Li.Less}}getSampler(e,t=!1,i=0){if(this.disabled)return this._device.createSampler(Ea._GetSamplerDescriptor(e));t?i=0:i===0&&(i=Ea.GetSamplerHashCode(e));let s=t?void 0:this._samplers[i];return s||(s=this._device.createSampler(Ea._GetSamplerDescriptor(e)),t||(this._samplers[i]=s)),s}}var ri;(function(a){a[a.StencilReadMask=0]="StencilReadMask",a[a.StencilWriteMask=1]="StencilWriteMask",a[a.DepthBias=2]="DepthBias",a[a.DepthBiasSlopeScale=3]="DepthBiasSlopeScale",a[a.DepthStencilState=4]="DepthStencilState",a[a.MRTAttachments1=5]="MRTAttachments1",a[a.MRTAttachments2=6]="MRTAttachments2",a[a.RasterizationState=7]="RasterizationState",a[a.ColorStates=8]="ColorStates",a[a.ShaderStage=9]="ShaderStage",a[a.TextureStage=10]="TextureStage",a[a.VertexState=11]="VertexState",a[a.NumStates=12]="NumStates"})(ri||(ri={}));const vh={0:1,1:2,768:3,769:4,770:5,771:6,772:7,773:8,774:9,775:10,776:11,32769:12,32770:13,32771:12,32772:13},eo={0:0,7680:1,7681:2,7682:3,7683:4,5386:5,34055:6,34056:7};class Wt{constructor(e,t,i){this.mrtTextureCount=0,this._device=e,this._useTextureStage=i,this._states=new Array(30),this._statesLength=0,this._stateDirtyLowestIndex=0,this._emptyVertexBuffer=t,this._mrtFormats=[],this._parameter={token:void 0,pipeline:null},this.disabled=!1,this.vertexBuffers=[],this._kMaxVertexBufferStride=e.limits.maxVertexBufferArrayStride||2048,this.reset()}reset(){this._isDirty=!0,this.vertexBuffers.length=0,this.setAlphaToCoverage(!1),this.resetDepthCullingState(),this.setClampDepth(!1),this.setDepthBias(0),this._webgpuColorFormat=[w.BGRA8Unorm],this.setColorFormat(w.BGRA8Unorm),this.setMRT([]),this.setAlphaBlendEnabled(!1),this.setAlphaBlendFactors([null,null,null,null],[null,null]),this.setWriteMask(15),this.setDepthStencilFormat(w.Depth24PlusStencil8),this.setStencilEnabled(!1),this.resetStencilState(),this.setBuffers(null,null,null),this._setTextureState(0)}get colorFormats(){return this._mrtAttachments1>0?this._mrtFormats:this._webgpuColorFormat}getRenderPipeline(e,t,i,s=0){if(i>1&&(i=4),this.disabled){const n=Wt._GetTopology(e);return this._setVertexState(t),this._parameter.pipeline=this._createRenderPipeline(t,n,i),Wt.NumCacheMiss++,Wt._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}if(this._setShaderStage(t.uniqueId),this._setRasterizationState(e,i),this._setColorStates(),this._setDepthStencilState(),this._setVertexState(t),this._setTextureState(s),this.lastStateDirtyLowestIndex=this._stateDirtyLowestIndex,!this._isDirty&&this._parameter.pipeline)return this._stateDirtyLowestIndex=this._statesLength,Wt.NumCacheHitWithoutHash++,this._parameter.pipeline;if(this._getRenderPipeline(this._parameter),this._isDirty=!1,this._stateDirtyLowestIndex=this._statesLength,this._parameter.pipeline)return Wt.NumCacheHitWithHash++,this._parameter.pipeline;const r=Wt._GetTopology(e);return this._parameter.pipeline=this._createRenderPipeline(t,r,i),this._setRenderPipeline(this._parameter),Wt.NumCacheMiss++,Wt._NumPipelineCreationCurrentFrame++,this._parameter.pipeline}endFrame(){Wt.NumPipelineCreationLastFrame=Wt._NumPipelineCreationCurrentFrame,Wt._NumPipelineCreationCurrentFrame=0}setAlphaToCoverage(e){this._alphaToCoverageEnabled=e}setFrontFace(e){this._frontFace=e}setCullEnabled(e){this._cullEnabled=e}setCullFace(e){this._cullFace=e}setClampDepth(e){this._clampDepth=e}resetDepthCullingState(){this.setDepthCullingState(!1,2,1,0,0,!0,!0,519)}setDepthCullingState(e,t,i,s,r,n,o,l){this._depthWriteEnabled=o,this._depthTestEnabled=n,this._depthCompare=(l!=null?l:519)-512,this._cullFace=i,this._cullEnabled=e,this._frontFace=t,this.setDepthBiasSlopeScale(s),this.setDepthBias(r)}setDepthBias(e){this._depthBias!==e&&(this._depthBias=e,this._states[ri.DepthBias]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.DepthBias))}setDepthBiasSlopeScale(e){this._depthBiasSlopeScale!==e&&(this._depthBiasSlopeScale=e,this._states[ri.DepthBiasSlopeScale]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.DepthBiasSlopeScale))}setColorFormat(e){this._webgpuColorFormat[0]=e,this._colorFormat=ll[e!=null?e:""]}setMRTAttachments(e){this.mrtAttachments=e;let t=0;for(let i=0;i<e.length;++i)e[i]!==0&&(t+=1<<i);this._mrtEnabledMask!==t&&(this._mrtEnabledMask=t,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.MRTAttachments1))}setMRT(e,t){var i,s;if(t=t!=null?t:e.length,t>10)throw"Can't handle more than 10 attachments for a MRT in cache render pipeline!";this.mrtTextureArray=e,this.mrtTextureCount=t,this._mrtEnabledMask=65535;const r=[0,0];let n=0,o=0,l=0;for(let h=0;h<t;++h){const c=e[h],u=c==null?void 0:c._hardwareTexture;this._mrtFormats[l]=(i=u==null?void 0:u.format)!==null&&i!==void 0?i:this._webgpuColorFormat[0],r[n]+=ll[(s=this._mrtFormats[l])!==null&&s!==void 0?s:""]<<o,o+=6,l++,o>=32&&(o=0,n++)}this._mrtFormats.length=l,(this._mrtAttachments1!==r[0]||this._mrtAttachments2!==r[1])&&(this._mrtAttachments1=r[0],this._mrtAttachments2=r[1],this._states[ri.MRTAttachments1]=r[0],this._states[ri.MRTAttachments2]=r[1],this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.MRTAttachments1))}setAlphaBlendEnabled(e){this._alphaBlendEnabled=e}setAlphaBlendFactors(e,t){this._alphaBlendFuncParams=e,this._alphaBlendEqParams=t}setWriteMask(e){this._writeMask=e}setDepthStencilFormat(e){this._webgpuDepthStencilFormat=e,this._depthStencilFormat=e===void 0?0:ll[e]}setDepthTestEnabled(e){this._depthTestEnabled=e}setDepthWriteEnabled(e){this._depthWriteEnabled=e}setDepthCompare(e){this._depthCompare=(e!=null?e:519)-512}setStencilEnabled(e){this._stencilEnabled=e}setStencilCompare(e){this._stencilFrontCompare=(e!=null?e:519)-512}setStencilDepthFailOp(e){this._stencilFrontDepthFailOp=e===null?1:eo[e]}setStencilPassOp(e){this._stencilFrontPassOp=e===null?2:eo[e]}setStencilFailOp(e){this._stencilFrontFailOp=e===null?1:eo[e]}setStencilReadMask(e){this._stencilReadMask!==e&&(this._stencilReadMask=e,this._states[ri.StencilReadMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.StencilReadMask))}setStencilWriteMask(e){this._stencilWriteMask!==e&&(this._stencilWriteMask=e,this._states[ri.StencilWriteMask]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.StencilWriteMask))}resetStencilState(){this.setStencilState(!1,519,7680,7681,7680,255,255)}setStencilState(e,t,i,s,r,n,o){this._stencilEnabled=e,this._stencilFrontCompare=(t!=null?t:519)-512,this._stencilFrontDepthFailOp=i===null?1:eo[i],this._stencilFrontPassOp=s===null?2:eo[s],this._stencilFrontFailOp=r===null?1:eo[r],this.setStencilReadMask(n),this.setStencilWriteMask(o)}setBuffers(e,t,i){this._vertexBuffers=e,this._overrideVertexBuffers=i,this._indexBuffer=t}static _GetTopology(e){switch(e){case 0:return Ys.TriangleList;case 2:return Ys.PointList;case 1:return Ys.LineList;case 3:return Ys.PointList;case 4:return Ys.LineList;case 5:throw"LineLoop is an unsupported fillmode in WebGPU";case 6:return Ys.LineStrip;case 7:return Ys.TriangleStrip;case 8:throw"TriangleFan is an unsupported fillmode in WebGPU";default:return Ys.TriangleList}}static _GetAphaBlendOperation(e){switch(e){case 32774:return On.Add;case 32778:return On.Subtract;case 32779:return On.ReverseSubtract;case 32775:return On.Min;case 32776:return On.Max;default:return On.Add}}static _GetAphaBlendFactor(e){switch(e){case 0:return rs.Zero;case 1:return rs.One;case 768:return rs.Src;case 769:return rs.OneMinusSrc;case 770:return rs.SrcAlpha;case 771:return rs.OneMinusSrcAlpha;case 772:return rs.DstAlpha;case 773:return rs.OneMinusDstAlpha;case 774:return rs.Dst;case 775:return rs.OneMinusDst;case 776:return rs.SrcAlphaSaturated;case 32769:return rs.Constant;case 32770:return rs.OneMinusConstant;case 32771:return rs.Constant;case 32772:return rs.OneMinusConstant;default:return rs.One}}static _GetCompareFunction(e){switch(e){case 0:return Li.Never;case 1:return Li.Less;case 2:return Li.Equal;case 3:return Li.LessEqual;case 4:return Li.Greater;case 5:return Li.NotEqual;case 6:return Li.GreaterEqual;case 7:return Li.Always}return Li.Never}static _GetStencilOpFunction(e){switch(e){case 0:return Er.Zero;case 1:return Er.Keep;case 2:return Er.Replace;case 3:return Er.IncrementClamp;case 4:return Er.DecrementClamp;case 5:return Er.Invert;case 6:return Er.IncrementWrap;case 7:return Er.DecrementWrap}return Er.Keep}static _GetVertexInputDescriptorFormat(e){const t=e.type,i=e.normalized,s=e.getSize();switch(t){case y.BYTE:switch(s){case 1:case 2:return i?zt.Snorm8x2:zt.Sint8x2;case 3:case 4:return i?zt.Snorm8x4:zt.Sint8x4}break;case y.UNSIGNED_BYTE:switch(s){case 1:case 2:return i?zt.Unorm8x2:zt.Uint8x2;case 3:case 4:return i?zt.Unorm8x4:zt.Uint8x4}break;case y.SHORT:switch(s){case 1:case 2:return i?zt.Snorm16x2:zt.Sint16x2;case 3:case 4:return i?zt.Snorm16x4:zt.Sint16x4}break;case y.UNSIGNED_SHORT:switch(s){case 1:case 2:return i?zt.Unorm16x2:zt.Uint16x2;case 3:case 4:return i?zt.Unorm16x4:zt.Uint16x4}break;case y.INT:switch(s){case 1:return zt.Sint32;case 2:return zt.Sint32x2;case 3:return zt.Sint32x3;case 4:return zt.Sint32x4}break;case y.UNSIGNED_INT:switch(s){case 1:return zt.Uint32;case 2:return zt.Uint32x2;case 3:return zt.Uint32x3;case 4:return zt.Uint32x4}break;case y.FLOAT:switch(s){case 1:return zt.Float32;case 2:return zt.Float32x2;case 3:return zt.Float32x3;case 4:return zt.Float32x4}break}throw new Error(`Invalid Format '${e.getKind()}' - type=${t}, normalized=${i}, size=${s}`)}_getAphaBlendState(){return this._alphaBlendEnabled?{srcFactor:Wt._GetAphaBlendFactor(this._alphaBlendFuncParams[2]),dstFactor:Wt._GetAphaBlendFactor(this._alphaBlendFuncParams[3]),operation:Wt._GetAphaBlendOperation(this._alphaBlendEqParams[1])}:null}_getColorBlendState(){return this._alphaBlendEnabled?{srcFactor:Wt._GetAphaBlendFactor(this._alphaBlendFuncParams[0]),dstFactor:Wt._GetAphaBlendFactor(this._alphaBlendFuncParams[1]),operation:Wt._GetAphaBlendOperation(this._alphaBlendEqParams[0])}:null}_setShaderStage(e){this._shaderId!==e&&(this._shaderId=e,this._states[ri.ShaderStage]=e,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.ShaderStage))}_setRasterizationState(e,t){const i=this._frontFace,s=this._cullEnabled?this._cullFace:0,r=this._clampDepth?1:0,n=this._alphaToCoverageEnabled?1:0,o=i-1+(s<<1)+(r<<3)+(n<<4)+(e<<5)+(t<<8);this._rasterizationState!==o&&(this._rasterizationState=o,this._states[ri.RasterizationState]=this._rasterizationState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.RasterizationState))}_setColorStates(){let e=((this._writeMask?1:0)<<22)+(this._colorFormat<<23)+((this._depthWriteEnabled?1:0)<<29);this._alphaBlendEnabled&&(e+=((this._alphaBlendFuncParams[0]===null?2:vh[this._alphaBlendFuncParams[0]])<<0)+((this._alphaBlendFuncParams[1]===null?2:vh[this._alphaBlendFuncParams[1]])<<4)+((this._alphaBlendFuncParams[2]===null?2:vh[this._alphaBlendFuncParams[2]])<<8)+((this._alphaBlendFuncParams[3]===null?2:vh[this._alphaBlendFuncParams[3]])<<12)+((this._alphaBlendEqParams[0]===null?1:this._alphaBlendEqParams[0]-32773)<<16)+((this._alphaBlendEqParams[1]===null?1:this._alphaBlendEqParams[1]-32773)<<19)),e!==this._colorStates&&(this._colorStates=e,this._states[ri.ColorStates]=this._colorStates,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.ColorStates))}_setDepthStencilState(){const e=this._stencilEnabled?this._stencilFrontCompare+(this._stencilFrontDepthFailOp<<3)+(this._stencilFrontPassOp<<6)+(this._stencilFrontFailOp<<9):591,t=this._depthStencilFormat+((this._depthTestEnabled?this._depthCompare:7)<<6)+(e<<10);this._depthStencilState!==t&&(this._depthStencilState=t,this._states[ri.DepthStencilState]=this._depthStencilState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.DepthStencilState))}_setVertexState(e){var t,i;const s=this._statesLength;let r=ri.VertexState;const n=e._pipelineContext,o=n.shaderProcessingContext.attributeNamesFromEffect,l=n.shaderProcessingContext.attributeLocationsFromEffect;let h,c=0;for(let u=0;u<o.length;u++){const d=l[u];let f=(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[o[u]])!==null&&t!==void 0?t:this._vertexBuffers[o[u]];f||(f=this._emptyVertexBuffer);const p=(i=f.getBuffer())===null||i===void 0?void 0:i.underlyingResource;if(f._validOffsetRange===void 0){const m=f.byteOffset,v=f.getSize(!0),x=f.byteStride;f._validOffsetRange=m<=this._kMaxVertexBufferStride-v&&(x===0||m+v<=x)}h&&h===p&&f._validOffsetRange||(this.vertexBuffers[c++]=f,h=f._validOffsetRange?p:null);const _=f.hashCode+(d<<7);this._isDirty=this._isDirty||this._states[r]!==_,this._states[r++]=_}this.vertexBuffers.length=c,this._statesLength=r,this._isDirty=this._isDirty||r!==s,this._isDirty&&(this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.VertexState))}_setTextureState(e){this._textureState!==e&&(this._textureState=e,this._states[ri.TextureStage]=this._textureState,this._isDirty=!0,this._stateDirtyLowestIndex=Math.min(this._stateDirtyLowestIndex,ri.TextureStage))}_createPipelineLayout(e){if(this._useTextureStage)return this._createPipelineLayoutWithTextureStage(e);const t=[],i=e.shaderProcessingContext.bindGroupLayoutEntries;for(let s=0;s<i.length;s++){const r=i[s];t[s]=this._device.createBindGroupLayout({entries:r})}return e.bindGroupLayouts=t,this._device.createPipelineLayout({bindGroupLayouts:t})}_createPipelineLayoutWithTextureStage(e){var t;const i=e.shaderProcessingContext,s=i.bindGroupLayoutEntries;let r=1;for(let o=0;o<s.length;o++){const l=s[o];for(let h=0;h<l.length;h++){const c=s[o][h];if(c.texture){const u=i.bindGroupLayoutEntryInfo[o][c.binding].name,d=i.availableTextures[u],f=d.autoBindSampler?i.availableSamplers[u+Vt.AutoSamplerSuffix]:null;let p=d.sampleType,_=(t=f==null?void 0:f.type)!==null&&t!==void 0?t:jn.Filtering;if(this._textureState&r&&p!==Gs.Depth&&(d.autoBindSampler&&(_=jn.NonFiltering),p=Gs.UnfilterableFloat),c.texture.sampleType=p,f){const m=i.bindGroupLayoutEntryInfo[f.binding.groupIndex][f.binding.bindingIndex].index;s[f.binding.groupIndex][m].sampler.type=_}r=r<<1}}}const n=[];for(let o=0;o<s.length;++o)n[o]=this._device.createBindGroupLayout({entries:s[o]});return e.bindGroupLayouts=n,this._device.createPipelineLayout({bindGroupLayouts:n})}_getVertexInputDescriptor(e){var t,i;const s=[],r=e._pipelineContext,n=r.shaderProcessingContext.attributeNamesFromEffect,o=r.shaderProcessingContext.attributeLocationsFromEffect;let l,h;for(let c=0;c<n.length;c++){const u=o[c];let d=(t=this._overrideVertexBuffers&&this._overrideVertexBuffers[n[c]])!==null&&t!==void 0?t:this._vertexBuffers[n[c]];d||(d=this._emptyVertexBuffer);let f=(i=d.getBuffer())===null||i===void 0?void 0:i.underlyingResource,p=d.byteOffset;const _=!d._validOffsetRange;if(!(l&&h&&l===f)||_){const m={arrayStride:d.byteStride,stepMode:d.getIsInstanced()?Gh.Instance:Gh.Vertex,attributes:[]};s.push(m),h=m.attributes,_&&(p=0,f=null)}h.push({shaderLocation:u,offset:p,format:Wt._GetVertexInputDescriptorFormat(d)}),l=f}return s}_createRenderPipeline(e,t,i){const s=e._pipelineContext,r=this._getVertexInputDescriptor(e),n=this._createPipelineLayout(s),o=[],l=this._getAphaBlendState(),h=this._getColorBlendState();if(this._mrtAttachments1>0)for(let f=0;f<this._mrtFormats.length;++f){const p=this._mrtFormats[f];if(p){const _={format:p,writeMask:(this._mrtEnabledMask&1<<f)!==0?this._writeMask:0};l&&h&&(_.blend={alpha:l,color:h}),o.push(_)}else o.push(null)}else if(this._webgpuColorFormat[0]){const f={format:this._webgpuColorFormat[0],writeMask:this._writeMask};l&&h&&(f.blend={alpha:l,color:h}),o.push(f)}else o.push(null);const c={compare:Wt._GetCompareFunction(this._stencilEnabled?this._stencilFrontCompare:7),depthFailOp:Wt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontDepthFailOp:1),failOp:Wt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontFailOp:1),passOp:Wt._GetStencilOpFunction(this._stencilEnabled?this._stencilFrontPassOp:1)};let u;(t===Ys.LineStrip||t===Ys.TriangleStrip)&&(u=!this._indexBuffer||this._indexBuffer.is32Bits?Fa.Uint32:Fa.Uint16);const d=this._webgpuDepthStencilFormat?Lt.HasStencilAspect(this._webgpuDepthStencilFormat):!1;return this._device.createRenderPipeline({layout:n,vertex:{module:s.stages.vertexStage.module,entryPoint:s.stages.vertexStage.entryPoint,buffers:r},primitive:{topology:t,stripIndexFormat:u,frontFace:this._frontFace===1?kh.CCW:kh.CW,cullMode:this._cullEnabled?this._cullFace===2?nl.Front:nl.Back:nl.None},fragment:s.stages.fragmentStage?{module:s.stages.fragmentStage.module,entryPoint:s.stages.fragmentStage.entryPoint,targets:o}:void 0,multisample:{count:i},depthStencil:this._webgpuDepthStencilFormat===void 0?void 0:{depthWriteEnabled:this._depthWriteEnabled,depthCompare:this._depthTestEnabled?Wt._GetCompareFunction(this._depthCompare):Li.Always,format:this._webgpuDepthStencilFormat,stencilFront:this._stencilEnabled&&d?c:void 0,stencilBack:this._stencilEnabled&&d?c:void 0,stencilReadMask:this._stencilEnabled&&d?this._stencilReadMask:void 0,stencilWriteMask:this._stencilEnabled&&d?this._stencilWriteMask:void 0,depthBias:this._depthBias,depthBiasClamp:this._depthBiasClamp,depthBiasSlopeScale:this._depthBiasSlopeScale}})}}Wt.NumCacheHitWithoutHash=0;Wt.NumCacheHitWithHash=0;Wt.NumCacheMiss=0;Wt.NumPipelineCreationLastFrame=0;Wt._NumPipelineCreationCurrentFrame=0;class __{constructor(){this.values={}}count(){let e=0,t=this.pipeline?1:0;for(const i in this.values){const s=this.values[i],[r,n]=s.count();e+=r,t+=n,e++}return[e,t]}}class dn extends Wt{constructor(e,t,i){super(e,t,i),this._nodeStack=[],this._nodeStack[0]=dn._Cache}static GetNodeCounts(){const e=dn._Cache.count();return{nodeCount:e[0],pipelineCount:e[1]}}static _GetPipelines(e,t,i,s){if(e.pipeline){const r=i.slice();r.length=s,t.push(r)}for(const r in e.values){const n=e.values[r];i[s]=parseInt(r),dn._GetPipelines(n,t,i,s+1)}}static GetPipelines(){const e=[];return dn._GetPipelines(dn._Cache,e,[],0),e}_getRenderPipeline(e){let t=this._nodeStack[this._stateDirtyLowestIndex];for(let i=this._stateDirtyLowestIndex;i<this._statesLength;++i){let s=t.values[this._states[i]];s||(s=new __,t.values[this._states[i]]=s),t=s,this._nodeStack[i+1]=t}e.token=t,e.pipeline=t.pipeline}_setRenderPipeline(e){e.token.pipeline=e.pipeline}}dn._Cache=new __;class Mx extends i_{constructor(e){super(!1),this._cache=e,this.reset()}get func(){return this._func}set func(e){this._func!==e&&(this._func=e,this._cache.setStencilCompare(e))}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask!==e&&(this._funcMask=e,this._cache.setStencilReadMask(e))}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail!==e&&(this._opStencilFail=e,this._cache.setStencilFailOp(e))}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail!==e&&(this._opDepthFail=e,this._cache.setStencilDepthFailOp(e))}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass!==e&&(this._opStencilDepthPass=e,this._cache.setStencilPassOp(e))}get mask(){return this._mask}set mask(e){this._mask!==e&&(this._mask=e,this._cache.setStencilWriteMask(e))}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this._cache.setStencilEnabled(e))}reset(){super.reset(),this._cache.resetStencilState()}apply(){var e;const t=(e=this.stencilMaterial)===null||e===void 0?void 0:e.enabled;this.enabled=t?this.stencilMaterial.enabled:this.stencilGlobal.enabled,this.enabled&&(this.func=t?this.stencilMaterial.func:this.stencilGlobal.func,this.funcRef=t?this.stencilMaterial.funcRef:this.stencilGlobal.funcRef,this.funcMask=t?this.stencilMaterial.funcMask:this.stencilGlobal.funcMask,this.opStencilFail=t?this.stencilMaterial.opStencilFail:this.stencilGlobal.opStencilFail,this.opDepthFail=t?this.stencilMaterial.opDepthFail:this.stencilGlobal.opDepthFail,this.opStencilDepthPass=t?this.stencilMaterial.opStencilDepthPass:this.stencilGlobal.opStencilDepthPass,this.mask=t?this.stencilMaterial.mask:this.stencilGlobal.mask)}}class Dx extends e_{constructor(e){super(!1),this._cache=e,this.reset()}get zOffset(){return this._zOffset}set zOffset(e){this._zOffset!==e&&(this._zOffset=e,this._isZOffsetDirty=!0,this._cache.setDepthBiasSlopeScale(e))}get zOffsetUnits(){return this._zOffsetUnits}set zOffsetUnits(e){this._zOffsetUnits!==e&&(this._zOffsetUnits=e,this._isZOffsetDirty=!0,this._cache.setDepthBias(e))}get cullFace(){return this._cullFace}set cullFace(e){this._cullFace!==e&&(this._cullFace=e,this._isCullFaceDirty=!0,this._cache.setCullFace(e!=null?e:1))}get cull(){return this._cull}set cull(e){this._cull!==e&&(this._cull=e,this._isCullDirty=!0,this._cache.setCullEnabled(!!e))}get depthFunc(){return this._depthFunc}set depthFunc(e){this._depthFunc!==e&&(this._depthFunc=e,this._isDepthFuncDirty=!0,this._cache.setDepthCompare(e))}get depthMask(){return this._depthMask}set depthMask(e){this._depthMask!==e&&(this._depthMask=e,this._isDepthMaskDirty=!0,this._cache.setDepthWriteEnabled(e))}get depthTest(){return this._depthTest}set depthTest(e){this._depthTest!==e&&(this._depthTest=e,this._isDepthTestDirty=!0,this._cache.setDepthTestEnabled(e))}get frontFace(){return this._frontFace}set frontFace(e){this._frontFace!==e&&(this._frontFace=e,this._isFrontFaceDirty=!0,this._cache.setFrontFace(e!=null?e:2))}reset(){super.reset(),this._cache.resetDepthCullingState()}apply(){}}class m_{constructor(e){this.useMipMaps=!1,this.type=16,this._video=e,this.uniqueId=gt._Counter++}static IsExternalTexture(e){return e.underlyingResource!==void 0}getClassName(){return"ExternalTexture"}get underlyingResource(){return this._video}isReady(){return this._video.readyState>=this._video.HAVE_CURRENT_DATA}dispose(){}}class mc{constructor(){this.uniqueId=mc._Counter++,this.updateId=0,this.reset()}get forceBindGroupCreation(){return this._numExternalTextures>0}get hasFloatTextures(){return this._numFloatTextures>0}reset(){this.samplers={},this.textures={},this.isDirty=!0,this._numFloatTextures=0,this._numExternalTextures=0}setSampler(e,t){let i=this.samplers[e],s=-1;i?s=i.hashCode:this.samplers[e]=i={sampler:t,hashCode:0},i.sampler=t,i.hashCode=t?Ea.GetSamplerHashCode(t):0;const r=s!==i.hashCode;r&&this.updateId++,this.isDirty||(this.isDirty=r)}setTexture(e,t){var i,s,r;let n=this.textures[e],o=-1;n?o=(s=(i=n.texture)===null||i===void 0?void 0:i.uniqueId)!==null&&s!==void 0?s:-1:this.textures[e]=n={texture:t,isFloatTexture:!1,isExternalTexture:!1},n.isExternalTexture&&this._numExternalTextures--,n.isFloatTexture&&this._numFloatTextures--,t?(n.isFloatTexture=t.type===1,n.isExternalTexture=m_.IsExternalTexture(t),n.isFloatTexture&&this._numFloatTextures++,n.isExternalTexture&&this._numExternalTextures++):(n.isFloatTexture=!1,n.isExternalTexture=!1),n.texture=t;const l=o!==((r=t==null?void 0:t.uniqueId)!==null&&r!==void 0?r:-1);l&&this.updateId++,this.isDirty||(this.isDirty=l)}}mc._Counter=0;class gc{constructor(e){this._bufferManager=e,this.uniqueId=gc._Counter++,this._useInstancing=!1,this._currentInstanceCount=0,this.reset()}isDirty(e){return this._isDirty||this._materialContextUpdateId!==e}resetIsDirty(e){this._isDirty=!1,this._materialContextUpdateId=e}get useInstancing(){return this._useInstancing}set useInstancing(e){this._useInstancing!==e&&(e?(this.indirectDrawBuffer=this._bufferManager.createRawBuffer(40,Dt.CopyDst|Dt.Indirect),this._indirectDrawData=new Uint32Array(5),this._indirectDrawData[3]=0,this._indirectDrawData[4]=0):(this.indirectDrawBuffer&&this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this._useInstancing=e,this._currentInstanceCount=-1)}reset(){this.buffers={},this._isDirty=!0,this._materialContextUpdateId=0,this.fastBundle=void 0,this.bindGroups=void 0}setBuffer(e,t){var i;this._isDirty||(this._isDirty=(t==null?void 0:t.uniqueId)!==((i=this.buffers[e])===null||i===void 0?void 0:i.uniqueId)),this.buffers[e]=t}setIndirectData(e,t,i){t===this._currentInstanceCount||!this.indirectDrawBuffer||!this._indirectDrawData||(this._currentInstanceCount=t,this._indirectDrawData[0]=e,this._indirectDrawData[1]=t,this._indirectDrawData[2]=i,this._bufferManager.setRawData(this.indirectDrawBuffer,0,this._indirectDrawData,0,20))}dispose(){this.indirectDrawBuffer&&(this._bufferManager.releaseBuffer(this.indirectDrawBuffer),this.indirectDrawBuffer=void 0,this._indirectDrawData=void 0),this.fastBundle=void 0,this.bindGroups=void 0,this.buffers=void 0}}gc._Counter=0;class Ph{constructor(){this.values={}}}class qt{constructor(e,t,i){this.disabled=!1,this._device=e,this._cacheSampler=t,this._engine=i}static get Statistics(){return{totalCreated:qt.NumBindGroupsCreatedTotal,lastFrameCreated:qt.NumBindGroupsCreatedLastFrame,lookupLastFrame:qt.NumBindGroupsLookupLastFrame,noLookupLastFrame:qt.NumBindGroupsNoLookupLastFrame}}endFrame(){qt.NumBindGroupsCreatedLastFrame=qt._NumBindGroupsCreatedCurrentFrame,qt.NumBindGroupsLookupLastFrame=qt._NumBindGroupsLookupCurrentFrame,qt.NumBindGroupsNoLookupLastFrame=qt._NumBindGroupsNoLookupCurrentFrame,qt._NumBindGroupsCreatedCurrentFrame=0,qt._NumBindGroupsLookupCurrentFrame=0,qt._NumBindGroupsNoLookupCurrentFrame=0}getBindGroups(e,t,i){var s,r,n,o,l,h,c,u,d,f;let p,_=qt._Cache;const m=this.disabled||i.forceBindGroupCreation;if(!m){if(!t.isDirty(i.updateId)&&!i.isDirty)return qt._NumBindGroupsNoLookupCurrentFrame++,t.bindGroups;for(const x of e.shaderProcessingContext.bufferNames){const b=(r=(s=t.buffers[x])===null||s===void 0?void 0:s.uniqueId)!==null&&r!==void 0?r:0;let S=_.values[b];S||(S=new Ph,_.values[b]=S),_=S}for(const x of e.shaderProcessingContext.samplerNames){const b=(o=(n=i.samplers[x])===null||n===void 0?void 0:n.hashCode)!==null&&o!==void 0?o:0;let S=_.values[b];S||(S=new Ph,_.values[b]=S),_=S}for(const x of e.shaderProcessingContext.textureNames){const b=(c=(h=(l=i.textures[x])===null||l===void 0?void 0:l.texture)===null||h===void 0?void 0:h.uniqueId)!==null&&c!==void 0?c:0;let S=_.values[b];S||(S=new Ph,_.values[b]=S),_=S}p=_.bindGroups}if(t.resetIsDirty(i.updateId),i.isDirty=!1,p)return t.bindGroups=p,qt._NumBindGroupsLookupCurrentFrame++,p;p=[],t.bindGroups=p,m||(_.bindGroups=p),qt.NumBindGroupsCreatedTotal++,qt._NumBindGroupsCreatedCurrentFrame++;const v=e.bindGroupLayouts;for(let x=0;x<e.shaderProcessingContext.bindGroupLayoutEntries.length;x++){const b=e.shaderProcessingContext.bindGroupLayoutEntries[x],S=e.shaderProcessingContext.bindGroupEntries[x];for(let E=0;E<b.length;E++){const A=e.shaderProcessingContext.bindGroupLayoutEntries[x][E],M=e.shaderProcessingContext.bindGroupLayoutEntryInfo[x][A.binding],D=(u=M.nameInArrayOfTexture)!==null&&u!==void 0?u:M.name;if(A.sampler){const P=i.samplers[D];if(P){const O=P.sampler;if(!O){this._engine.dbgSanityChecks&&B.Error(`Trying to bind a null sampler! entry=${JSON.stringify(A)}, name=${D}, bindingInfo=${JSON.stringify(P,(N,$)=>N==="texture"?"<no dump>":$)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}S[E].resource=this._cacheSampler.getSampler(O,!1,P.hashCode)}else B.Error(`Sampler "${D}" could not be bound. entry=${JSON.stringify(A)}, materialContext=${JSON.stringify(i,(O,N)=>O==="texture"||O==="sampler"?"<no dump>":N)}`,50)}else if(A.texture||A.storageTexture){const P=i.textures[D];if(P){if(this._engine.dbgSanityChecks&&P.texture===null){B.Error(`Trying to bind a null texture! entry=${JSON.stringify(A)}, bindingInfo=${JSON.stringify(P,(N,$)=>N==="texture"?"<no dump>":$)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const O=P.texture._hardwareTexture;if(this._engine.dbgSanityChecks&&(!O||A.texture&&!O.view||A.storageTexture&&!O.viewForWriting)){B.Error(`Trying to bind a null gpu texture or view! entry=${JSON.stringify(A)}, name=${D}, bindingInfo=${JSON.stringify(P,(N,$)=>N==="texture"?"<no dump>":$)}, isReady=${(d=P.texture)===null||d===void 0?void 0:d.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}S[E].resource=A.storageTexture?O.viewForWriting:O.view}else B.Error(`Texture "${D}" could not be bound. entry=${JSON.stringify(A)}, materialContext=${JSON.stringify(i,(O,N)=>O==="texture"||O==="sampler"?"<no dump>":N)}`,50)}else if(A.externalTexture){const P=i.textures[D];if(P){if(this._engine.dbgSanityChecks&&P.texture===null){B.Error(`Trying to bind a null external texture! entry=${JSON.stringify(A)}, name=${D}, bindingInfo=${JSON.stringify(P,(N,$)=>N==="texture"?"<no dump>":$)}, materialContext.uniqueId=${i.uniqueId}`,50);continue}const O=P.texture.underlyingResource;if(this._engine.dbgSanityChecks&&!O){B.Error(`Trying to bind a null gpu external texture! entry=${JSON.stringify(A)}, name=${D}, bindingInfo=${JSON.stringify(P,(N,$)=>N==="texture"?"<no dump>":$)}, isReady=${(f=P.texture)===null||f===void 0?void 0:f.isReady}, materialContext.uniqueId=${i.uniqueId}`,50);continue}S[E].resource=this._device.importExternalTexture({source:O})}else B.Error(`Texture "${D}" could not be bound. entry=${JSON.stringify(A)}, materialContext=${JSON.stringify(i,(O,N)=>O==="texture"||O==="sampler"?"<no dump>":N)}`,50)}else if(A.buffer){const P=t.buffers[D];if(P){const O=P.underlyingResource;S[E].resource.buffer=O,S[E].resource.size=P.capacity}else B.Error(`Can't find buffer "${D}". entry=${JSON.stringify(A)}, buffers=${JSON.stringify(t.buffers)}, drawContext.uniqueId=${t.uniqueId}`,50)}}const C=v[x];p[x]=this._device.createBindGroup({layout:C,entries:S})}return p}}qt.NumBindGroupsCreatedTotal=0;qt.NumBindGroupsCreatedLastFrame=0;qt.NumBindGroupsLookupLastFrame=0;qt.NumBindGroupsNoLookupLastFrame=0;qt._Cache=new Ph;qt._NumBindGroupsCreatedCurrentFrame=0;qt._NumBindGroupsLookupCurrentFrame=0;qt._NumBindGroupsNoLookupCurrentFrame=0;const Ox="clearQuadVertexShader",wx=`uniform float depthValue;
const vec2 pos[4]={
vec2(-1.0,1.0),
vec2(1.0,1.0),
vec2(-1.0,-1.0),
vec2(1.0,-1.0)
};
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
gl_Position=vec4(pos[gl_VertexID],depthValue,1.0);
#define CUSTOM_VERTEX_MAIN_END
}
`;Y.ShadersStore[Ox]=wx;const Nx="clearQuadPixelShader",Fx=`uniform vec4 color;
void main() {
gl_FragColor=color;
}
`;Y.ShadersStore[Nx]=Fx;class Lx{constructor(e,t,i){this._bindGroups={},this._bundleCache={},this._keyTemp=[],this._device=e,this._engine=t,this._cacheRenderPipeline=new dn(this._device,i,!t._caps.textureFloatLinearFiltering),this._cacheRenderPipeline.setDepthTestEnabled(!1),this._cacheRenderPipeline.setStencilReadMask(255),this._effect=t.createEffect("clearQuad",[],["color","depthValue"])}setDepthStencilFormat(e){this._depthTextureFormat=e,this._cacheRenderPipeline.setDepthStencilFormat(e)}setColorFormat(e){this._cacheRenderPipeline.setColorFormat(e)}setMRTAttachments(e,t,i){this._cacheRenderPipeline.setMRT(t,i),this._cacheRenderPipeline.setMRTAttachments(e)}clear(e,t,i,s,r=1){var n,o;let l,h=null,c;const u=!!this._engine._currentRenderTarget;if(e)l=e;else{let x=0;this._keyTemp.length=0;for(let S=0;S<this._cacheRenderPipeline.colorFormats.length;++S)this._keyTemp[x++]=ll[(n=this._cacheRenderPipeline.colorFormats[S])!==null&&n!==void 0?n:""];const b=ll[(o=this._depthTextureFormat)!==null&&o!==void 0?o:0];if(this._keyTemp[x]=(t?t.r+t.g*256+t.b*256*256+t.a*256*256*256:0)+(i?2**32:0)+(s?2**33:0)+(this._engine.useReverseDepthBuffer?2**34:0)+(u?2**35:0)+(r>1?2**36:0)+b*2**37,c=this._keyTemp.join("_"),h=this._bundleCache[c],h)return h;l=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:r})}this._cacheRenderPipeline.setDepthWriteEnabled(!!i),this._cacheRenderPipeline.setStencilEnabled(!!s&&!!this._depthTextureFormat&&Lt.HasStencilAspect(this._depthTextureFormat)),this._cacheRenderPipeline.setStencilWriteMask(s?255:0),this._cacheRenderPipeline.setStencilCompare(s?519:512),this._cacheRenderPipeline.setStencilPassOp(s?7681:7680),this._cacheRenderPipeline.setWriteMask(t?15:0);const d=this._cacheRenderPipeline.getRenderPipeline(7,this._effect,r),f=this._effect._pipelineContext;t&&this._effect.setDirectColor4("color",t),this._effect.setFloat("depthValue",this._engine.useReverseDepthBuffer?this._engine._clearReverseDepthValue:this._engine._clearDepthValue),f.uniformBuffer.update();const p=u?this._engine._ubInvertY:this._engine._ubDontInvertY,_=f.uniformBuffer.getBuffer(),m=_.uniqueId+"-"+p.uniqueId;let v=this._bindGroups[m];if(!v){const x=f.bindGroupLayouts;v=this._bindGroups[m]=[],v.push(this._device.createBindGroup({layout:x[0],entries:[]})),qs._SimplifiedKnownBindings||v.push(this._device.createBindGroup({layout:x[1],entries:[]})),v.push(this._device.createBindGroup({layout:x[qs._SimplifiedKnownBindings?1:2],entries:[{binding:0,resource:{buffer:p.underlyingResource,size:p.capacity}},{binding:1,resource:{buffer:_.underlyingResource,size:_.capacity}}]}))}l.setPipeline(d);for(let x=0;x<v.length;++x)l.setBindGroup(x,v[x]);return l.draw(4,1,0,0),e||(h=l.finish(),this._bundleCache[c]=h),h}}class Fd{constructor(e,t,i,s){this.x=Math.floor(e),this.y=Math.floor(t),this.w=Math.floor(i),this.h=Math.floor(s)}run(e){e.setViewport(this.x,this.y,this.w,this.h,0,1)}clone(){return new Fd(this.x,this.y,this.w,this.h)}}class hl{constructor(e,t,i,s){this.x=e,this.y=t,this.w=i,this.h=s}run(e){e.setScissorRect(this.x,this.y,this.w,this.h)}clone(){return new hl(this.x,this.y,this.w,this.h)}}class cl{constructor(e){this.ref=e}run(e){e.setStencilReference(this.ref)}clone(){return new cl(this.ref)}}class Ld{constructor(e){this.color=e}run(e){e.setBlendConstant(this.color)}clone(){return new Ld(this.color)}}class Bd{constructor(e){this.query=e}run(e){e.beginOcclusionQuery(this.query)}clone(){return new Bd(this.query)}}class Ud{constructor(){}run(e){e.endOcclusionQuery()}clone(){return new Ud}}class Vd{constructor(){this.bundles=[]}run(e){e.executeBundles(this.bundles)}clone(){const e=new Vd;return e.bundles=this.bundles,e}}class Kh{constructor(e){this.numDrawCalls=0,this._device=e,this._list=new Array(10),this._listLength=0}addBundle(e){if(!this._currentItemIsBundle){const t=new Vd;this._list[this._listLength++]=t,this._currentBundleList=t.bundles,this._currentItemIsBundle=!0}e&&this._currentBundleList.push(e)}_finishBundle(){this._currentItemIsBundle&&this._bundleEncoder&&(this._currentBundleList.push(this._bundleEncoder.finish()),this._bundleEncoder=void 0,this._currentItemIsBundle=!1)}addItem(e){this._finishBundle(),this._list[this._listLength++]=e,this._currentItemIsBundle=!1}getBundleEncoder(e,t,i){return this._currentItemIsBundle||(this.addBundle(),this._bundleEncoder=this._device.createRenderBundleEncoder({colorFormats:e,depthStencilFormat:t,sampleCount:i})),this._bundleEncoder}close(){this._finishBundle()}run(e){this.close();for(let t=0;t<this._listLength;++t)this._list[t].run(e)}reset(){this._listLength=0,this._currentItemIsBundle=!1,this.numDrawCalls=0}clone(){this.close();const e=new Kh(this._device);e._list=new Array(this._listLength),e._listLength=this._listLength,e.numDrawCalls=this.numDrawCalls;for(let t=0;t<this._listLength;++t)e._list[t]=this._list[t].clone();return e}}class g_{constructor(e,t,i,s,r=!0){this._dstBuffers=[],this._device=i,this._bufferManager=s,this._count=e,this._canUseMultipleBuffers=r,this._querySet=i.createQuerySet({type:t,count:e}),this._queryBuffer=s.createRawBuffer(8*e,Dt.QueryResolve|Dt.CopySrc),r||this._dstBuffers.push(this._bufferManager.createRawBuffer(8*this._count,Dt.MapRead|Dt.CopyDst))}get querySet(){return this._querySet}_getBuffer(e,t){if(!this._canUseMultipleBuffers&&this._dstBuffers.length===0)return null;const i=this._device.createCommandEncoder();let s;return this._dstBuffers.length===0?s=this._bufferManager.createRawBuffer(8*this._count,Dt.MapRead|Dt.CopyDst):(s=this._dstBuffers[this._dstBuffers.length-1],this._dstBuffers.length--),i.resolveQuerySet(this._querySet,e,t,this._queryBuffer,0),i.copyBufferToBuffer(this._queryBuffer,0,s,0,8*t),this._device.queue.submit([i.finish()]),s}async readValues(e=0,t=1){const i=this._getBuffer(e,t);if(i===null)return null;await i.mapAsync(Aa.Read);const s=new BigUint64Array(i.getMappedRange()).slice();return i.unmap(),this._dstBuffers[this._dstBuffers.length]=i,s}async readValue(e=0){const t=this._getBuffer(e,1);if(t===null)return null;await t.mapAsync(Aa.Read);const i=new BigUint64Array(t.getMappedRange()),s=Number(i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,s}async readTwoValuesAndSubtract(e=0){const t=this._getBuffer(e,2);if(t===null)return null;await t.mapAsync(Aa.Read);const i=new BigUint64Array(t.getMappedRange()),s=Number(i[1]-i[0]);return t.unmap(),this._dstBuffers[this._dstBuffers.length]=t,s}dispose(){this._querySet.destroy(),this._bufferManager.releaseBuffer(this._queryBuffer);for(let e=0;e<this._dstBuffers.length;++e)this._bufferManager.releaseBuffer(this._dstBuffers[e])}}class Bx{constructor(e,t){this._enabled=!1,this._gpuFrameTimeCounter=new _r,this._measureDurationState=0,this._device=e,this._bufferManager=t}get gpuFrameTimeCounter(){return this._gpuFrameTimeCounter}get enable(){return this._enabled}set enable(e){this._enabled!==e&&(this._enabled=e,this._measureDurationState=0,e?this._measureDuration=new Ux(this._device,this._bufferManager):this._measureDuration.dispose())}startFrame(e){this._enabled&&this._measureDurationState===0&&(this._measureDuration.start(e),this._measureDurationState=1)}endFrame(e){this._measureDurationState===1&&(this._measureDurationState=2,this._measureDuration.stop(e).then(t=>{t!==null&&t>=0&&(this._gpuFrameTimeCounter.fetchNewFrame(),this._gpuFrameTimeCounter.addCount(t,!0)),this._measureDurationState=0}))}}class Ux{constructor(e,t){this._querySet=new g_(2,zh.Timestamp,e,t)}start(e){e.writeTimestamp(this._querySet.querySet,0)}async stop(e){return e.writeTimestamp(this._querySet.querySet,1),this._querySet.readTwoValuesAndSubtract(0)}dispose(){this._querySet.dispose()}}class Vx{constructor(e,t,i,s=50,r=100){this._availableIndices=[],this._engine=e,this._device=t,this._bufferManager=i,this._frameLastBuffer=-1,this._currentTotalIndices=0,this._countIncrement=r,this._allocateNewIndices(s)}get querySet(){return this._querySet.querySet}get hasQueries(){return this._currentTotalIndices!==this._availableIndices.length}get canBeginQuery(){switch(this._engine._getCurrentRenderPassIndex()){case 0:return this._engine._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet!==void 0;case 1:return this._engine._rttRenderPassWrapper.renderPassDescriptor.occlusionQuerySet!==void 0}return!1}createQuery(){this._availableIndices.length===0&&this._allocateNewIndices();const e=this._availableIndices[this._availableIndices.length-1];return this._availableIndices.length--,e}deleteQuery(e){this._availableIndices[this._availableIndices.length-1]=e}isQueryResultAvailable(e){return this._retrieveQueryBuffer(),!!this._lastBuffer&&e<this._lastBuffer.length}getQueryResult(e){var t,i;return Number((i=(t=this._lastBuffer)===null||t===void 0?void 0:t[e])!==null&&i!==void 0?i:-1)}_retrieveQueryBuffer(){this._lastBuffer&&this._frameLastBuffer===this._engine.frameId||this._frameLastBuffer!==this._engine.frameId&&(this._frameLastBuffer=this._engine.frameId,this._querySet.readValues(0,this._currentTotalIndices).then(e=>{this._lastBuffer=e}))}_allocateNewIndices(e){e=e!=null?e:this._countIncrement,this._delayQuerySetDispose();for(let t=0;t<e;++t)this._availableIndices.push(this._currentTotalIndices+t);this._currentTotalIndices+=e,this._querySet=new g_(this._currentTotalIndices,zh.Occlusion,this._device,this._bufferManager,!1)}_delayQuerySetDispose(){const e=this._querySet;e&&setTimeout(()=>e.dispose,1e3)}dispose(){var e;(e=this._querySet)===null||e===void 0||e.dispose(),this._availableIndices.length=0}}class Ra{constructor(e,t=20){this.debug=!1,this._sourceCode=e,this._numMaxIterations=t,this._functionDescr=[],this.inlineToken="#define inline"}get code(){return this._sourceCode}processCode(){this.debug&&console.log(`Start inlining process (code size=${this._sourceCode.length})...`),this._collectFunctions(),this._processInlining(this._numMaxIterations),this.debug&&console.log("End of inlining process.")}_collectFunctions(){let e=0;for(;e<this._sourceCode.length;){const t=this._sourceCode.indexOf(this.inlineToken,e);if(t<0)break;const i=this._sourceCode.indexOf("(",t+this.inlineToken.length);if(i<0){this.debug&&console.warn(`Could not find the opening parenthesis after the token. startIndex=${e}`),e=t+this.inlineToken.length;continue}const s=Ra._RegexpFindFunctionNameAndType.exec(this._sourceCode.substring(t+this.inlineToken.length,i));if(!s){this.debug&&console.warn(`Could not extract the name/type of the function from: ${this._sourceCode.substring(t+this.inlineToken.length,i)}`),e=t+this.inlineToken.length;continue}const[r,n]=[s[3],s[4]],o=ph("(",")",this._sourceCode,i);if(o<0){this.debug&&console.warn(`Could not extract the parameters the function '${n}' (type=${r}). funcParamsStartIndex=${i}`),e=t+this.inlineToken.length;continue}const l=this._sourceCode.substring(i+1,o),h=ef(this._sourceCode,o+1);if(h===this._sourceCode.length){this.debug&&console.warn(`Could not extract the body of the function '${n}' (type=${r}). funcParamsEndIndex=${o}`),e=t+this.inlineToken.length;continue}const c=ph("{","}",this._sourceCode,h);if(c<0){this.debug&&console.warn(`Could not extract the body of the function '${n}' (type=${r}). funcBodyStartIndex=${h}`),e=t+this.inlineToken.length;continue}const u=this._sourceCode.substring(h,c+1),d=qu(l).split(","),f=[];for(let m=0;m<d.length;++m){const v=d[m].trim(),x=v.lastIndexOf(" ");x>=0&&f.push(v.substring(x+1))}r!=="void"&&f.push("return"),this._functionDescr.push({name:n,type:r,parameters:f,body:u,callIndex:0}),e=c+1;const p=t>0?this._sourceCode.substring(0,t):"",_=c+1<this._sourceCode.length-1?this._sourceCode.substring(c+1):"";this._sourceCode=p+_,e-=c+1-t}this.debug&&console.log(`Collect functions: ${this._functionDescr.length} functions found. functionDescr=`,this._functionDescr)}_processInlining(e=20){for(;e-->=0&&this._replaceFunctionCallsByCode(););return this.debug&&console.log(`numMaxIterations is ${e} after inlining process`),e>=0}_replaceFunctionCallsByCode(){let e=!1;for(const t of this._functionDescr){const{name:i,type:s,parameters:r,body:n}=t;let o=0;for(;o<this._sourceCode.length;){const l=this._sourceCode.indexOf(i,o);if(l<0)break;if(l===0||Eu(this._sourceCode.charAt(l-1))){o=l+i.length;continue}const h=ef(this._sourceCode,l+i.length);if(h===this._sourceCode.length||this._sourceCode.charAt(h)!=="("){o=l+i.length;continue}const c=ph("(",")",this._sourceCode,h);if(c<0){this.debug&&console.warn(`Could not extract the parameters of the function call. Function '${i}' (type=${s}). callParamsStartIndex=${h}`),o=l+i.length;continue}const u=this._sourceCode.substring(h+1,c),f=(b=>{const S=[];let C=0,E=0;for(;C<b.length;){if(b.charAt(C)==="("){const A=ph("(",")",b,C);if(A<0)return null;C=A}else b.charAt(C)===","&&(S.push(b.substring(E,C)),E=C+1);C++}return E<C&&S.push(b.substring(E,C)),S})(qu(u));if(f===null){this.debug&&console.warn(`Invalid function call: can't extract the parameters of the function call. Function '${i}' (type=${s}). callParamsStartIndex=${h}, callParams=`+u),o=l+i.length;continue}const p=[];for(let b=0;b<f.length;++b){const S=f[b].trim();p.push(S)}const _=s!=="void"?i+"_"+t.callIndex++:null;if(_&&p.push(_+" ="),p.length!==r.length){this.debug&&console.warn(`Invalid function call: not the same number of parameters for the call than the number expected by the function. Function '${i}' (type=${s}). function parameters=${r}, call parameters=${p}`),o=l+i.length;continue}o=c+1;const m=this._replaceNames(n,r,p);let v=l>0?this._sourceCode.substring(0,l):"";const x=c+1<this._sourceCode.length-1?this._sourceCode.substring(c+1):"";if(_){const b=xv(this._sourceCode,l-1,`
`);v=this._sourceCode.substring(0,b+1);const S=this._sourceCode.substring(b+1,l);this._sourceCode=v+s+" "+_+`;
`+m+`
`+S+_+x,this.debug&&console.log(`Replace function call by code. Function '${i}' (type=${s}). injectDeclarationIndex=${b}, call parameters=${p}`)}else this._sourceCode=v+m+x,o+=m.length-(c+1-l),this.debug&&console.log(`Replace function call by code. Function '${i}' (type=${s}). functionCallIndex=${l}, call parameters=${p}`);e=!0}}return e}_replaceNames(e,t,i){for(let s=0;s<t.length;++s){const r=new RegExp(Tv(t[s]),"g"),n=t[s].length,o=i[s];e=e.replace(r,(l,...h)=>{const c=h[0];return Eu(e.charAt(c-1))||Eu(e.charAt(c+n))?t[s]:o})}return e}}Ra._RegexpFindFunctionNameAndType=/((\s+?)(\w+)\s+(\w+)\s*?)$/;class vc{constructor(){this._twgsl=null}async initTwgsl(e){return e=e||{},e={...vc._TWgslDefaultOptions,...e},e.twgsl?(this._twgsl=e.twgsl,Promise.resolve()):(e.jsPath&&e.wasmPath&&(Ht()?await q.LoadScriptAsync(e.jsPath):importScripts(e.jsPath)),self.twgsl?(this._twgsl=await self.twgsl(e.wasmPath),Promise.resolve()):Promise.reject("twgsl is not available."))}convertSpirV2WGSL(e){return this._twgsl.convertSpirV2WGSL(e)}}vc._TWgslDefaultOptions={jsPath:"https://preview.babylonjs.com/twgsl/twgsl.js",wasmPath:"https://preview.babylonjs.com/twgsl/twgsl.wasm"};class kx{constructor(e,t,i,s){this._record=!1,this._play=!1,this._mainPassBundleList=[],this._enabled=!1,this._engine=e,this._mode=t,this._bundleList=i,this._bundleListRenderTarget=s}get enabled(){return this._enabled}get play(){return this._play}get record(){return this._record}set enabled(e){this._mainPassBundleList.length=0,this._record=this._enabled=e,this._play=!1,e&&(this._modeSaved=this._mode,this._mode=0)}get mode(){return this._mode}set mode(e){this._record?this._modeSaved=e:this._mode=e}endMainRenderPass(){this._record&&this._mainPassBundleList.push(this._bundleList.clone())}endRenderTargetPass(e,t){var i,s,r,n;if(this._play)(s=(i=t._bundleLists)===null||i===void 0?void 0:i[t._currentLayer])===null||s===void 0||s.run(e),this._mode===1&&this._engine._reportDrawCall((n=(r=t._bundleLists)===null||r===void 0?void 0:r[t._currentLayer])===null||n===void 0?void 0:n.numDrawCalls);else if(this._record)t._bundleLists||(t._bundleLists=[]),t._bundleLists[t._currentLayer]=this._bundleListRenderTarget.clone(),t._bundleLists[t._currentLayer].run(e),this._bundleListRenderTarget.reset();else return!1;return!0}endFrame(e){if(this._record&&(this._mainPassBundleList.push(this._bundleList.clone()),this._record=!1,this._play=!0,this._mode=this._modeSaved),e!==null&&this._play)for(let t=0;t<this._mainPassBundleList.length;++t)this._mainPassBundleList[t].run(e),this._mode===1&&this._engine._reportDrawCall(this._mainPassBundleList[t].numDrawCalls)}reset(){this.enabled=!1,this.enabled=!0}}class Le extends k{constructor(e,t={}){var i,s,r,n;if(super(null),this._uploadEncoderDescriptor={label:"upload"},this._renderEncoderDescriptor={label:"render"},this._renderTargetEncoderDescriptor={label:"renderTarget"},this._clearDepthValue=1,this._clearReverseDepthValue=0,this._clearStencilValue=0,this._defaultSampleCount=4,this._glslang=null,this._tintWASM=null,this._compiledComputeEffects={},this._counters={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.countersLastFrame={numEnableEffects:0,numEnableDrawWrapper:0,numBundleCreationNonCompatMode:0,numBundleReuseNonCompatMode:0},this.numMaxUncapturedErrors=20,this._commandBuffers=[null,null,null],this._currentRenderPass=null,this._mainRenderPassWrapper=new uf,this._rttRenderPassWrapper=new uf,this._pendingDebugCommands=[],this._onAfterUnbindFrameBufferObservable=new X,this._currentOverrideVertexBuffers=null,this._currentIndexBuffer=null,this._colorWriteLocal=!0,this._forceEnableEffect=!1,this.dbgShowShaderCode=!1,this.dbgSanityChecks=!0,this.dbgVerboseLogsForFirstFrames=!1,this.dbgVerboseLogsNumFrames=10,this.dbgLogIfNotDrawWrapper=!0,this.dbgShowEmptyEnableEffectCalls=!0,this._viewportsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorsCurrent=[{x:0,y:0,w:0,h:0},{x:0,y:0,w:0,h:0}],this._scissorCached={x:0,y:0,z:0,w:0},this._stencilRefsCurrent=[-1,-1],this._blendColorsCurrent=[[null,null,null,null],[null,null,null,null]],this._name="WebGPU",this.isNDCHalfZRange=!0,this.hasOriginBottomLeft=!1,t.deviceDescriptor=t.deviceDescriptor||{},t.antialiasing=t.antialiasing===void 0?!0:t.antialiasing,t.stencil=(i=t.stencil)!==null&&i!==void 0?i:!0,t.enableGPUDebugMarkers=(s=t.enableGPUDebugMarkers)!==null&&s!==void 0?s:!1,Pi.SetMatrixPrecision(!!t.useHighPrecisionMatrix),B.Log(`Babylon.js v${k.Version} - ${this.description} engine`),!navigator.gpu){B.Error("WebGPU is not supported by your browser.");return}t.swapChainFormat=t.swapChainFormat||navigator.gpu.getPreferredCanvasFormat(),this._isWebGPU=!0,this._shaderPlatformName="WEBGPU",t.deterministicLockstep===void 0&&(t.deterministicLockstep=!1),t.lockstepMaxSteps===void 0&&(t.lockstepMaxSteps=4),t.audioEngine===void 0&&(t.audioEngine=!0),this._deterministicLockstep=t.deterministicLockstep,this._lockstepMaxSteps=t.lockstepMaxSteps,this._timeStep=t.timeStep||1/60,this._doNotHandleContextLost=!!t.doNotHandleContextLost,this._canvas=e,this._options=t,this.premultipliedAlpha=(r=t.premultipliedAlpha)!==null&&r!==void 0?r:!0;const o=Ht()&&window.devicePixelRatio||1,l=t.limitDeviceRatio||o,h=(n=t.adaptToDeviceRatio)!==null&&n!==void 0?n:!1;this._hardwareScalingLevel=h?1/Math.min(l,o):1,this._mainPassSampleCount=t.antialiasing?this._defaultSampleCount:1,this._isStencilEnable=t.stencil,this._sharedInit(e,!!t.doNotHandleTouchAction,t.audioEngine),this._shaderProcessor=new vv,this._shaderProcessorWGSL=new ix}get snapshotRenderingMode(){return this._snapshotRendering.mode}set snapshotRenderingMode(e){this._snapshotRendering.mode=e}snapshotRenderingReset(){this._snapshotRendering.reset()}get snapshotRendering(){return this._snapshotRendering.enabled}set snapshotRendering(e){this._snapshotRendering.enabled=e}get disableCacheSamplers(){return this._cacheSampler?this._cacheSampler.disabled:!1}set disableCacheSamplers(e){this._cacheSampler&&(this._cacheSampler.disabled=e)}get disableCacheRenderPipelines(){return this._cacheRenderPipeline?this._cacheRenderPipeline.disabled:!1}set disableCacheRenderPipelines(e){this._cacheRenderPipeline&&(this._cacheRenderPipeline.disabled=e)}get disableCacheBindGroups(){return this._cacheBindGroups?this._cacheBindGroups.disabled:!1}set disableCacheBindGroups(e){this._cacheBindGroups&&(this._cacheBindGroups.disabled=e)}static get IsSupportedAsync(){return navigator.gpu?navigator.gpu.requestAdapter().then(e=>!!e,()=>!1).catch(()=>!1):Promise.resolve(!1)}static get IsSupported(){return B.Warn("You must call IsSupportedAsync for WebGPU!"),!1}get supportsUniformBuffers(){return!0}get supportedExtensions(){return this._adapterSupportedExtensions}get enabledExtensions(){return this._deviceEnabledExtensions}get description(){return this.name+this.version}get version(){return 1}getInfo(){return{vendor:"unknown vendor",renderer:"unknown renderer",version:"unknown version"}}get compatibilityMode(){return this._compatibilityMode}set compatibilityMode(e){this._compatibilityMode=e}get currentSampleCount(){return this._currentRenderTarget?this._currentRenderTarget.samples:this._mainPassSampleCount}static CreateAsync(e,t={}){const i=new Le(e,t);return new Promise(s=>{i.initAsync(t.glslangOptions,t.twgslOptions).then(()=>s(i))})}initAsync(e,t){var i;return this._initGlslang(e!=null?e:(i=this._options)===null||i===void 0?void 0:i.glslangOptions).then(s=>{var r;return this._glslang=s,this._tintWASM=Le.UseTWGSL?new vc:null,this._tintWASM?this._tintWASM.initTwgsl(t!=null?t:(r=this._options)===null||r===void 0?void 0:r.twgslOptions).then(()=>navigator.gpu.requestAdapter(this._options),n=>{throw B.Error("Can not initialize twgsl!"),B.Error(n),Error("WebGPU initializations stopped.")}):navigator.gpu.requestAdapter(this._options)},s=>{throw B.Error("Can not initialize glslang!"),B.Error(s),Error("WebGPU initializations stopped.")}).then(s=>{var r;if(s){this._adapter=s,this._adapterSupportedExtensions=[],(r=this._adapter.features)===null||r===void 0||r.forEach(o=>this._adapterSupportedExtensions.push(o));const n=this._options.deviceDescriptor;if(n!=null&&n.requiredFeatures){const o=n.requiredFeatures,l=[];for(const h of o)this._adapterSupportedExtensions.indexOf(h)!==-1&&l.push(h);n.requiredFeatures=l}return this._adapter.requestDevice(this._options.deviceDescriptor)}else throw"Could not retrieve a WebGPU adapter (adapter is null)."}).then(s=>{var r,n;this._device=s,this._deviceEnabledExtensions=[],(r=this._device.features)===null||r===void 0||r.forEach(l=>this._deviceEnabledExtensions.push(l));let o=-1;this._device.addEventListener("uncapturederror",l=>{++o<this.numMaxUncapturedErrors?B.Warn(`WebGPU uncaptured error (${o+1}): ${l.error} - ${l.error.message}`):o++===this.numMaxUncapturedErrors&&B.Warn(`WebGPU uncaptured error: too many warnings (${this.numMaxUncapturedErrors}), no more warnings will be reported to the console for this engine.`)}),this._doNotHandleContextLost||(n=this._device.lost)===null||n===void 0||n.then(l=>{this._contextWasLost=!0,B.Warn("WebGPU context lost. "+l),this.onContextLostObservable.notifyObservers(this),this._restoreEngineAfterContextLost(this.initAsync.bind(this))})},s=>{B.Error("Could not retrieve a WebGPU device."),B.Error(s)}).then(()=>{this._bufferManager=new Nd(this._device),this._textureHelper=new Lt(this._device,this._glslang,this._tintWASM,this._bufferManager),this._cacheSampler=new Ea(this._device),this._cacheBindGroups=new qt(this._device,this._cacheSampler,this),this._timestampQuery=new Bx(this._device,this._bufferManager),this._occlusionQuery=this._device.createQuerySet?new Vx(this,this._device,this._bufferManager):void 0,this._bundleList=new Kh(this._device),this._bundleListRenderTarget=new Kh(this._device),this._snapshotRendering=new kx(this,this._snapshotRenderingMode,this._bundleList,this._bundleListRenderTarget),this._ubInvertY=this._bufferManager.createBuffer(new Float32Array([-1,0]),Dt.Uniform|Dt.CopyDst),this._ubDontInvertY=this._bufferManager.createBuffer(new Float32Array([1,0]),Dt.Uniform|Dt.CopyDst),this.dbgVerboseLogsForFirstFrames&&this._count===void 0&&(this._count=0,console.log("%c frame #"+this._count+" - begin","background: #ffff00")),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._emptyVertexBuffer=new y(this,[0],"",!1,!1,1,!1,0,1),this._initializeLimits(),this._cacheRenderPipeline=new dn(this._device,this._emptyVertexBuffer,!this._caps.textureFloatLinearFiltering),this._depthCullingState=new Dx(this._cacheRenderPipeline),this._stencilStateComposer=new Mx(this._cacheRenderPipeline),this._stencilStateComposer.stencilGlobal=this._stencilState,this._depthCullingState.depthTest=!0,this._depthCullingState.depthFunc=515,this._depthCullingState.depthMask=!0,this._textureHelper.setCommandEncoder(this._uploadEncoder),this._clearQuad=new Lx(this._device,this,this._emptyVertexBuffer),this._defaultDrawContext=this.createDrawContext(),this._currentDrawContext=this._defaultDrawContext,this._defaultMaterialContext=this.createMaterialContext(),this._currentMaterialContext=this._defaultMaterialContext,this._initializeContextAndSwapChain(),this._initializeMainAttachments(),this.resize()}).catch(s=>{B.Error("Can not create WebGPU Device and/or context."),B.Error(s),console.trace&&console.trace()})}_initGlslang(e){return e=e||{},e={...Le._GLSLslangDefaultOptions,...e},e.glslang?Promise.resolve(e.glslang):self.glslang?self.glslang(e.wasmPath):e.jsPath&&e.wasmPath?Ht()?q.LoadScriptAsync(e.jsPath).then(()=>self.glslang(e.wasmPath)):(importScripts(e.jsPath),self.glslang(e.wasmPath)):Promise.reject("gslang is not available.")}_initializeLimits(){this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:8192,maxCubemapTextureSize:2048,maxRenderTextureSize:8192,maxVertexAttribs:16,maxVaryingVectors:15,maxFragmentUniformVectors:1024,maxVertexUniformVectors:1024,standardDerivatives:!0,astc:this._deviceEnabledExtensions.indexOf(xa.TextureCompressionASTC)>=0?!0:void 0,s3tc:this._deviceEnabledExtensions.indexOf(xa.TextureCompressionBC)>=0?!0:void 0,pvrtc:null,etc1:null,etc2:this._deviceEnabledExtensions.indexOf(xa.TextureCompressionETC2)>=0?!0:void 0,bptc:this._deviceEnabledExtensions.indexOf(xa.TextureCompressionBC)>=0?!0:void 0,maxAnisotropy:4,uintIndices:!0,fragmentDepthSupported:!0,highPrecisionShaderSupported:!0,colorBufferFloat:!0,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!0,textureHalfFloat:!0,textureHalfFloatLinearFiltering:!0,textureHalfFloatRender:!0,textureLOD:!0,drawBuffersExtension:!0,depthTextureExtension:!0,vertexArrayObject:!1,instancedArrays:!0,timerQuery:typeof BigUint64Array<"u"&&this.enabledExtensions.indexOf(xa.TimestampQuery)!==-1?!0:void 0,supportOcclusionQuery:typeof BigUint64Array<"u",canUseTimestampForTimerQuery:!0,multiview:!1,oculusMultiview:!1,parallelShaderCompile:void 0,blendMinMax:!0,maxMSAASamples:4,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!0,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!0,texture2DArrayMaxLayerCount:2048},this._caps.parallelShaderCompile=null,this._features={forceBitmapOverHTMLImageElement:!0,supportRenderAndCopyToLodForFloatTextures:!0,supportDepthStencilTexture:!0,supportShadowSamplers:!0,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!0,trackUbosInFrame:!0,checkUbosContentBeforeUpload:!0,supportCSM:!0,basisNeedsPOT:!1,support3DTextures:!0,needTypeSuffixInShaderConstants:!0,supportMSAA:!0,supportSSAO2:!0,supportExtendedTextureFormats:!0,supportSwitchCaseInShader:!0,supportSyncTextureRead:!1,needsInvertingBitmap:!1,useUBOBindingCache:!1,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!0,supportRenderPasses:!0,supportSpriteInstancing:!0,_collectUbosUpdatedInFrame:!1}}_initializeContextAndSwapChain(){this._context=this._canvas.getContext("webgpu"),this._configureContext(),this._colorFormat=this._options.swapChainFormat,this._mainRenderPassWrapper.colorAttachmentGPUTextures=[new Rh],this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].format=this._colorFormat}_initializeMainAttachments(){var e;if(!this._bufferManager)return;this._mainTextureExtends={width:this.getRenderWidth(),height:this.getRenderHeight(),depthOrArrayLayers:1};const t=new Float32Array([this.getRenderHeight()]);this._bufferManager.setSubData(this._ubInvertY,4,t),this._bufferManager.setSubData(this._ubDontInvertY,4,t);let i;if(this._options.antialiasing){const n={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Vn.E2d,format:this._options.swapChainFormat,usage:Ft.RenderAttachment};(e=this._mainTexture)===null||e===void 0||e.destroy(),this._mainTexture=this._device.createTexture(n),i=[{view:this._mainTexture.createView(),clearValue:new J(0,0,0,1),loadOp:Ci.Clear,storeOp:dr.Store}]}else i=[{view:void 0,clearValue:new J(0,0,0,1),loadOp:Ci.Clear,storeOp:dr.Store}];this._mainRenderPassWrapper.depthTextureFormat=this.isStencilEnable?w.Depth24PlusStencil8:w.Depth32Float,this._setDepthTextureFormat(this._mainRenderPassWrapper);const s={size:this._mainTextureExtends,mipLevelCount:1,sampleCount:this._mainPassSampleCount,dimension:Vn.E2d,format:this._mainRenderPassWrapper.depthTextureFormat,usage:Ft.RenderAttachment};this._depthTexture&&this._depthTexture.destroy(),this._depthTexture=this._device.createTexture(s);const r={view:this._depthTexture.createView(),depthClearValue:this._clearDepthValue,depthLoadOp:Ci.Clear,depthStoreOp:dr.Store,stencilClearValue:this._clearStencilValue,stencilLoadOp:this.isStencilEnable?Ci.Clear:void 0,stencilStoreOp:this.isStencilEnable?dr.Store:void 0};this._mainRenderPassWrapper.renderPassDescriptor={colorAttachments:i,depthStencilAttachment:r},this._mainRenderPassWrapper.renderPass!==null&&this._endMainRenderPass()}_configureContext(){this._context.configure({device:this._device,format:this._options.swapChainFormat,usage:Ft.RenderAttachment|Ft.CopySrc,alphaMode:this.premultipliedAlpha?Wh.Premultiplied:Wh.Opaque})}setSize(e,t,i=!1){return super.setSize(e,t,i)?(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - setSize called -",e,t)),this._initializeMainAttachments(),this.snapshotRendering&&this.snapshotRenderingReset(),!0):!1}_getShaderProcessor(e){return e===Xt.WGSL?this._shaderProcessorWGSL:this._shaderProcessor}_getShaderProcessingContext(e){return new qs(e)}applyStates(){this._stencilStateComposer.apply(),this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend)}wipeCaches(e){this.preventCacheWipeBetweenFrames&&!e||(this._forceEnableEffect=!0,this._currentIndexBuffer=null,this._currentOverrideVertexBuffers=null,this._cacheRenderPipeline.setBuffers(null,null,null),e&&(this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._depthCullingState.depthFunc=515,this._alphaState.reset(),this._alphaMode=1,this._alphaEquation=0,this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters),this._cacheRenderPipeline.setAlphaBlendEnabled(!1),this.setColorWrite(!0)),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}setColorWrite(e){this._colorWriteLocal=e,this._cacheRenderPipeline.setWriteMask(e?15:0)}getColorWrite(){return this._colorWriteLocal}_resetCurrentViewport(e){this._viewportsCurrent[e].x=0,this._viewportsCurrent[e].y=0,this._viewportsCurrent[e].w=0,this._viewportsCurrent[e].h=0,e===1&&(this._viewportCached.x=0,this._viewportCached.y=0,this._viewportCached.z=0,this._viewportCached.w=0)}_mustUpdateViewport(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._viewportCached.x,s=this._viewportCached.y,r=this._viewportCached.z,n=this._viewportCached.w,o=this._viewportsCurrent[t].x!==i||this._viewportsCurrent[t].y!==s||this._viewportsCurrent[t].w!==r||this._viewportsCurrent[t].h!==n;return o&&(this._viewportsCurrent[t].x=this._viewportCached.x,this._viewportsCurrent[t].y=this._viewportCached.y,this._viewportsCurrent[t].w=this._viewportCached.z,this._viewportsCurrent[t].h=this._viewportCached.w),o}_applyViewport(e){let t=Math.floor(this._viewportCached.y);const i=Math.floor(this._viewportCached.w);this._currentRenderTarget||(t=this.getRenderHeight()-t-i),e.setViewport(Math.floor(this._viewportCached.x),t,Math.floor(this._viewportCached.z),i,0,1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - viewport applied - (",this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass)))}_viewport(e,t,i,s){this._viewportCached.x=e,this._viewportCached.y=t,this._viewportCached.z=i,this._viewportCached.w=s}_resetCurrentScissor(e){this._scissorsCurrent[e].x=0,this._scissorsCurrent[e].y=0,this._scissorsCurrent[e].w=0,this._scissorsCurrent[e].h=0}_mustUpdateScissor(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._scissorCached.x,s=this._scissorCached.y,r=this._scissorCached.z,n=this._scissorCached.w,o=this._scissorsCurrent[t].x!==i||this._scissorsCurrent[t].y!==s||this._scissorsCurrent[t].w!==r||this._scissorsCurrent[t].h!==n;return o&&(this._scissorsCurrent[t].x=this._scissorCached.x,this._scissorsCurrent[t].y=this._scissorCached.y,this._scissorsCurrent[t].w=this._scissorCached.z,this._scissorsCurrent[t].h=this._scissorCached.w),o}_applyScissor(e){e.setScissorRect(this._scissorCached.x,this._currentRenderTarget?this._scissorCached.y:this.getRenderHeight()-this._scissorCached.w-this._scissorCached.y,this._scissorCached.z,this._scissorCached.w),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - scissor applied - (",this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w,") current pass is main pass="+(e===this._mainRenderPassWrapper.renderPass)))}_scissorIsActive(){return this._scissorCached.x!==0||this._scissorCached.y!==0||this._scissorCached.z!==0||this._scissorCached.w!==0}enableScissor(e,t,i,s){this._scissorCached.x=e,this._scissorCached.y=t,this._scissorCached.z=i,this._scissorCached.w=s}disableScissor(){this._scissorCached.x=0,this._scissorCached.y=0,this._scissorCached.z=0,this._scissorCached.w=0,this._resetCurrentScissor(0),this._resetCurrentScissor(1)}_resetCurrentStencilRef(e){this._stencilRefsCurrent[e]=-1}_mustUpdateStencilRef(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._stencilStateComposer.funcRef!==this._stencilRefsCurrent[t];return i&&(this._stencilRefsCurrent[t]=this._stencilStateComposer.funcRef),i}_applyStencilRef(e){var t;e.setStencilReference((t=this._stencilStateComposer.funcRef)!==null&&t!==void 0?t:0)}_resetCurrentColorBlend(e){this._blendColorsCurrent[e][0]=this._blendColorsCurrent[e][1]=this._blendColorsCurrent[e][2]=this._blendColorsCurrent[e][3]=null}_mustUpdateBlendColor(e){const t=e===this._mainRenderPassWrapper.renderPass?0:1,i=this._alphaState._blendConstants,s=i[0]!==this._blendColorsCurrent[t][0]||i[1]!==this._blendColorsCurrent[t][1]||i[2]!==this._blendColorsCurrent[t][2]||i[3]!==this._blendColorsCurrent[t][3];return s&&(this._blendColorsCurrent[t][0]=i[0],this._blendColorsCurrent[t][1]=i[1],this._blendColorsCurrent[t][2]=i[2],this._blendColorsCurrent[t][3]=i[3]),s}_applyBlendColor(e){e.setBlendConstant(this._alphaState._blendConstants)}clear(e,t,i,s=!1){e&&e.a===void 0&&(e.a=1);const r=this._scissorIsActive();this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - clear called - backBuffer=",t," depth=",i," stencil=",s," scissor is active=",r)),this._currentRenderTarget?r?(this._rttRenderPassWrapper.renderPass||this._startRenderTargetRenderPass(this._currentRenderTarget,!1,t?e:null,i,s),this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleListRenderTarget.addItem(new hl(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(t?e:null,i,s)):(this._currentRenderPass&&this._endRenderTargetRenderPass(),this._startRenderTargetRenderPass(this._currentRenderTarget,!0,t?e:null,i,s)):((!this._mainRenderPassWrapper.renderPass||!r)&&this._startMainRenderPass(!r,t?e:null,i,s),r&&(this.compatibilityMode?this._applyScissor(this._currentRenderPass):this._bundleList.addItem(new hl(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),this._clearFullQuad(t?e:null,i,s)))}_clearFullQuad(e,t,i){var s,r,n;const o=this.compatibilityMode?this._getCurrentRenderPass():null,h=this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget;this._clearQuad.setColorFormat(this._colorFormat),this._clearQuad.setDepthStencilFormat(this._depthTextureFormat),this._clearQuad.setMRTAttachments((s=this._cacheRenderPipeline.mrtAttachments)!==null&&s!==void 0?s:[],(r=this._cacheRenderPipeline.mrtTextureArray)!==null&&r!==void 0?r:[],this._cacheRenderPipeline.mrtTextureCount),this.compatibilityMode?o.setStencilReference(this._clearStencilValue):h.addItem(new cl(this._clearStencilValue));const c=this._clearQuad.clear(o,e,t,i,this.currentSampleCount);this.compatibilityMode?this._applyStencilRef(o):(h.addBundle(c),h.addItem(new cl((n=this._stencilStateComposer.funcRef)!==null&&n!==void 0?n:0)),this._reportDrawCall())}createVertexBuffer(e){let t;return e instanceof Array?t=new Float32Array(e):e instanceof ArrayBuffer?t=new Uint8Array(e):t=e,this._bufferManager.createBuffer(t,Dt.Vertex|Dt.CopyDst)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e)}createIndexBuffer(e){let t=!0,i;e instanceof Uint32Array||e instanceof Int32Array?i=e:e instanceof Uint16Array?(i=e,t=!1):e.length>65535?i=new Uint32Array(e):(i=new Uint16Array(e),t=!1);const s=this._bufferManager.createBuffer(i,Dt.Index|Dt.CopyDst);return s.is32Bits=t,s}_createBuffer(e,t){let i;e instanceof Array?i=new Float32Array(e):e instanceof ArrayBuffer?i=new Uint8Array(e):i=e;let s=0;return t&1&&(s|=Dt.CopySrc),t&2&&(s|=Dt.CopyDst),t&4&&(s|=Dt.Uniform),t&8&&(s|=Dt.Vertex),t&16&&(s|=Dt.Index),t&32&&(s|=Dt.Storage),this._bufferManager.createBuffer(i,s)}bindBuffersDirectly(){throw"Not implemented on WebGPU"}updateAndBindInstancesBuffer(){throw"Not implemented on WebGPU"}bindBuffers(e,t,i,s){this._currentIndexBuffer=t,this._currentOverrideVertexBuffers=s!=null?s:null,this._cacheRenderPipeline.setBuffers(e,t,this._currentOverrideVertexBuffers)}_releaseBuffer(e){return this._bufferManager.releaseBuffer(e)}createEffect(e,t,i,s,r,n,o,l,h,c=Xt.GLSL){var u;const d=e.vertexElement||e.vertex||e.vertexToken||e.vertexSource||e,f=e.fragmentElement||e.fragment||e.fragmentToken||e.fragmentSource||e,p=this._getGlobalDefines();let _=(u=r!=null?r:t.defines)!==null&&u!==void 0?u:"";p&&(_+=`
`+p);const m=d+"+"+f+"@"+_;if(this._compiledEffects[m]){const x=this._compiledEffects[m];return o&&x.isReady()&&o(x),x}const v=new Rt(e,t,i,s,this,r,n,o,l,h,m,c);return this._compiledEffects[m]=v,v}_compileRawShaderToSpirV(e,t){return this._glslang.compileGLSL(e,t)}_compileShaderToSpirV(e,t,i,s){return this._compileRawShaderToSpirV(s+(i?i+`
`:"")+e,t)}_getWGSLShader(e,t,i){return i?i="//"+i.split(`
`).join(`
//`)+`
`:i="",i+e}_createPipelineStageDescriptor(e,t,i){return this._tintWASM&&i===Xt.GLSL&&(e=this._tintWASM.convertSpirV2WGSL(e),t=this._tintWASM.convertSpirV2WGSL(t)),{vertexStage:{module:this._device.createShaderModule({code:e}),entryPoint:"main"},fragmentStage:{module:this._device.createShaderModule({code:t}),entryPoint:"main"}}}_compileRawPipelineStageDescriptor(e,t,i){const s=i===Xt.GLSL?this._compileRawShaderToSpirV(e,"vertex"):e,r=i===Xt.GLSL?this._compileRawShaderToSpirV(t,"fragment"):t;return this._createPipelineStageDescriptor(s,r,i)}_compilePipelineStageDescriptor(e,t,i,s){this.onBeforeShaderCompilationObservable.notifyObservers(this);const r=`#version 450
`,n=s===Xt.GLSL?this._compileShaderToSpirV(e,"vertex",i,r):this._getWGSLShader(e,"vertex",i),o=s===Xt.GLSL?this._compileShaderToSpirV(t,"fragment",i,r):this._getWGSLShader(t,"fragment",i),l=this._createPipelineStageDescriptor(n,o,s);return this.onAfterShaderCompilationObservable.notifyObservers(this),l}createRawShaderProgram(){throw"Not available on WebGPU"}createShaderProgram(){throw"Not available on WebGPU"}inlineShaderCode(e){const t=new Ra(e);return t.debug=!1,t.processCode(),t.code}createPipelineContext(e){return new _v(e,this)}createMaterialContext(){return new mc}createDrawContext(){return new gc(this._bufferManager)}_preparePipelineContext(e,t,i,s,r,n,o,l){const h=e,c=h.shaderProcessingContext.shaderLanguage;this.dbgShowShaderCode&&(console.log(l),console.log(t),console.log(i)),h.sources={fragment:i,vertex:t,rawVertex:r,rawFragment:n},s?h.stages=this._compileRawPipelineStageDescriptor(t,i,c):h.stages=this._compilePipelineStageDescriptor(t,i,l,c)}getAttributes(e,t){const i=new Array(t.length),s=e;for(let r=0;r<t.length;r++){const n=t[r],o=s.shaderProcessingContext.availableAttributes[n];o!==void 0&&(i[r]=o)}return i}enableEffect(e){if(!e)return;let t=!0;if(!Vi.IsWrapper(e))t=e!==this._currentEffect,this._currentEffect=e,this._currentMaterialContext=this._defaultMaterialContext,this._currentDrawContext=this._defaultDrawContext,this._counters.numEnableEffects++,this.dbgLogIfNotDrawWrapper&&B.Warn(`enableEffect has been called with an Effect and not a Wrapper! effect.uniqueId=${e.uniqueId}, effect.name=${e.name}, effect.name.vertex=${e.name.vertex}, effect.name.fragment=${e.name.fragment}`,10);else if(!e.effect||e.effect===this._currentEffect&&e.materialContext===this._currentMaterialContext&&e.drawContext===this._currentDrawContext&&!this._forceEnableEffect){if(!e.effect&&this.dbgShowEmptyEnableEffectCalls)throw console.error("drawWrapper=",e),"Invalid call to enableEffect: the effect property is empty!";return}else if(t=e.effect!==this._currentEffect,this._currentEffect=e.effect,this._currentMaterialContext=e.materialContext,this._currentDrawContext=e.drawContext,this._counters.numEnableDrawWrapper++,!this._currentMaterialContext)throw console.error("drawWrapper=",e),"Invalid call to enableEffect: the materialContext property is empty!";this._stencilStateComposer.stencilMaterial=void 0,this._forceEnableEffect=t||this._forceEnableEffect?!1:this._forceEnableEffect,t&&(this._currentEffect.onBind&&this._currentEffect.onBind(this._currentEffect),this._currentEffect._onBindObservable&&this._currentEffect._onBindObservable.notifyObservers(this._currentEffect))}_releaseEffect(e){this._compiledEffects[e._key]&&(delete this._compiledEffects[e._key],this._deletePipelineContext(e.getPipelineContext()))}releaseEffects(){for(const e in this._compiledEffects){const t=this._compiledEffects[e].getPipelineContext();this._deletePipelineContext(t)}this._compiledEffects={}}_deletePipelineContext(e){e&&e.dispose()}get needPOTTextures(){return!1}_createHardwareTexture(){return new Rh}_releaseTexture(e){const t=this._internalTexturesCache.indexOf(e);t!==-1&&this._internalTexturesCache.splice(t,1),this._textureHelper.releaseTexture(e)}_getRGBABufferInternalSizedFormat(){return 5}updateTextureComparisonFunction(e,t){e._comparisonFunction=t}_createInternalTexture(e,t,i=!0,s=We.Unknown){var r,n,o;const l={};t!==void 0&&typeof t=="object"?(l.generateMipMaps=t.generateMipMaps,l.type=t.type===void 0?0:t.type,l.samplingMode=t.samplingMode===void 0?3:t.samplingMode,l.format=t.format===void 0?5:t.format,l.samples=(r=t.samples)!==null&&r!==void 0?r:1,l.creationFlags=(n=t.creationFlags)!==null&&n!==void 0?n:0,l.useSRGBBuffer=(o=t.useSRGBBuffer)!==null&&o!==void 0?o:!1):(l.generateMipMaps=t,l.type=0,l.samplingMode=3,l.format=5,l.samples=1,l.creationFlags=0,l.useSRGBBuffer=!1),(l.type===1&&!this._caps.textureFloatLinearFiltering||l.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(l.samplingMode=1),l.type===1&&!this._caps.textureFloat&&(l.type=0,B.Warn("Float textures are not supported. Type forced to TEXTURETYPE_UNSIGNED_BYTE"));const h=new gt(this,s),c=e.width||e,u=e.height||e,d=e.layers||0;return h.baseWidth=c,h.baseHeight=u,h.width=c,h.height=u,h.depth=d,h.isReady=!0,h.samples=l.samples,h.generateMipMaps=!!l.generateMipMaps,h.samplingMode=l.samplingMode,h.type=l.type,h.format=l.format,h.is2DArray=d>0,h._cachedWrapU=0,h._cachedWrapV=0,h._useSRGBBuffer=l.useSRGBBuffer,this._internalTexturesCache.push(h),i||this._textureHelper.createGPUTextureForInternalTexture(h,c,u,d||1,l.creationFlags),h}createTexture(e,t,i,s,r=3,n=null,o=null,l=null,h=null,c=null,u=null,d,f,p,_){return this._createTextureBase(e,t,i,s,r,n,o,(m,v,x,b,S,C,E,A)=>{var M;const D=b;if(m.baseWidth=D.width,m.baseHeight=D.height,m.width=D.width,m.height=D.height,m.format=c!=null?c:-1,A(m.width,m.height,D,v,m,()=>{}),!((M=m._hardwareTexture)===null||M===void 0)&&M.underlyingResource)!C&&!E&&this._generateMipmaps(m,this._uploadEncoder);else{const P=this._textureHelper.createGPUTextureForInternalTexture(m,D.width,D.height,void 0,p);Lt.IsImageBitmap(D)&&(this._textureHelper.updateTexture(D,m,D.width,D.height,m.depth,P.format,0,0,S,!1,0,0),!C&&!E&&this._generateMipmaps(m,this._uploadEncoder))}x&&x.removePendingData(m),m.isReady=!0,m.onLoadedObservable.notifyObservers(m),m.onLoadedObservable.clear()},()=>!1,l,h,c,u,d,f,_)}wrapWebGPUTexture(e){const t=new Rh(e),i=new gt(this,We.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapWebGPUTexture instead.")}generateMipMapsForCubemap(e){var t;e.generateMipMaps&&(!((t=e._hardwareTexture)===null||t===void 0)&&t.underlyingResource||this._textureHelper.createGPUTextureForInternalTexture(e),this._generateMipmaps(e,e.source===We.RenderTarget||e.source===We.MultiRenderTarget?this._renderTargetEncoder:void 0))}updateTextureSamplingMode(e,t,i=!1){i&&(t.generateMipMaps=!0,this._generateMipmaps(t)),t.samplingMode=e}updateTextureWrappingMode(e,t,i=null,s=null){t!==null&&(e._cachedWrapU=t),i!==null&&(e._cachedWrapV=i),(e.is2DArray||e.is3D)&&s!==null&&(e._cachedWrapR=s)}updateTextureDimensions(e,t,i,s=1){if(!e._hardwareTexture||e.width===t&&e.height===i&&e.depth===s)return;const r=e._hardwareTexture.textureAdditionalUsages;e._hardwareTexture.release(),this._textureHelper.createGPUTextureForInternalTexture(e,t,i,s,r)}_setInternalTexture(e,t,i){if(i=i!=null?i:e,this._currentEffect){const r=this._currentEffect._pipelineContext.shaderProcessingContext.availableTextures[i];if(this._currentMaterialContext.setTexture(e,t),r&&r.autoBindSampler){const n=i+Vt.AutoSamplerSuffix;this._currentMaterialContext.setSampler(n,t)}}}setTexture(e,t,i,s){this._setTexture(e,i,!1,!1,s,s)}setTextureArray(e,t,i,s){for(let r=0;r<i.length;r++)this._setTexture(-1,i[r],!0,!1,s+r.toString(),s)}_setTexture(e,t,i=!1,s=!1,r="",n){if(n=n!=null?n:r,this._currentEffect){if(!t)return this._currentMaterialContext.setTexture(r,null),!1;if(t.video)t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let o=null;if(s?o=t.depthStencilTexture:t.isReady()?o=t.getInternalTexture():t.isCube?o=this.emptyCubeTexture:t.is3D?o=this.emptyTexture3D:t.is2DArray?o=this.emptyTexture2DArray:o=this.emptyTexture,o&&!o.isMultiview){if(o.isCube&&o._cachedCoordinatesMode!==t.coordinatesMode){o._cachedCoordinatesMode=t.coordinatesMode;const l=t.coordinatesMode!==3&&t.coordinatesMode!==5?1:0;t.wrapU=l,t.wrapV=l}o._cachedWrapU=t.wrapU,o._cachedWrapV=t.wrapV,o.is3D&&(o._cachedWrapR=t.wrapR),this._setAnisotropicLevel(0,o,t.anisotropicFilteringLevel)}this._setInternalTexture(r,o,n)}else this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - _setTexture called with a null _currentEffect! texture=",t));return!0}_setAnisotropicLevel(e,t,i){t._cachedAnisotropicFilteringLevel!==i&&(t._cachedAnisotropicFilteringLevel=Math.min(i,this._caps.maxAnisotropy))}_bindTexture(e,t,i){e!==void 0&&this._setInternalTexture(i,t)}generateMipmaps(e){this._generateMipmaps(e,this._renderTargetEncoder)}_generateMipmaps(e,t){const i=e._hardwareTexture;if(!i)return;t=t!=null?t:this._currentRenderTarget&&!this._currentRenderPass?this._renderTargetEncoder:this._currentRenderPass?this._uploadEncoder:this._renderEncoder;const s=e._hardwareTexture.format,r=Lt.ComputeNumMipmapLevels(e.width,e.height);this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - generate mipmaps called - width=",e.width,"height=",e.height,"isCube=",e.isCube)),e.isCube?this._textureHelper.generateCubeMipmaps(i,s,r,t):this._textureHelper.generateMipmaps(i,s,r,0,t)}updateTextureData(e,t,i,s,r,n,o=0,l=0,h=!1){var c;let u=e._hardwareTexture;!((c=e._hardwareTexture)===null||c===void 0)&&c.underlyingResource||(u=this._textureHelper.createGPUTextureForInternalTexture(e));const d=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(d,e,r,n,e.depth,u.format,o,l,e.invertY,!1,i,s),h&&this._generateMipmaps(e,this._renderTargetEncoder)}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){var l;let h=e._hardwareTexture;!((l=e._hardwareTexture)===null||l===void 0)&&l.underlyingResource||(e.format=t,h=this._textureHelper.createGPUTextureForInternalTexture(e,i,s));const c=new Uint8Array(r.buffer,r.byteOffset,r.byteLength);this._textureHelper.updateTexture(c,e,i,s,e.depth,h.format,n,o,!1,!1,0,0)}_uploadDataToTextureDirectly(e,t,i=0,s=0,r,n=!1){var o;const l=Math.round(Math.log(e.width)*Math.LOG2E),h=Math.round(Math.log(e.height)*Math.LOG2E),c=n?e.width:Math.pow(2,Math.max(l-s,0)),u=n?e.height:Math.pow(2,Math.max(h-s,0));let d=e._hardwareTexture;!((o=e._hardwareTexture)===null||o===void 0)&&o.underlyingResource||(d=this._textureHelper.createGPUTextureForInternalTexture(e,c,u));const f=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);this._textureHelper.updateTexture(f,e,c,u,e.depth,d.format,i,s,e.invertY,!1,0,0)}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){this._uploadDataToTextureDirectly(e,t,i,s)}_uploadImageToTexture(e,t,i=0,s=0){var r;let n=e._hardwareTexture;!((r=e._hardwareTexture)===null||r===void 0)&&r.underlyingResource||(n=this._textureHelper.createGPUTextureForInternalTexture(e));const o=t,l=Math.ceil(e.width/(1<<s)),h=Math.ceil(e.height/(1<<s));this._textureHelper.updateTexture(o,e,l,h,e.depth,n.format,i,s,e.invertY,!1,0,0)}readPixels(e,t,i,s,r=!0,n=!0){const l=(this._rttRenderPassWrapper.renderPass?this._rttRenderPassWrapper:this._mainRenderPassWrapper).colorAttachmentGPUTextures[0];if(!l)return Promise.resolve(new Uint8Array(0));const h=l.underlyingResource,c=l.format;return h?(n&&this.flushFramebuffer(),this._textureHelper.readPixels(h,e,t,i,s,c)):Promise.resolve(new Uint8Array(0))}beginFrame(){super.beginFrame()}endFrame(){if(this._snapshotRendering.endFrame(this._mainRenderPassWrapper.renderPass),this._endMainRenderPass(),this._timestampQuery.endFrame(this._renderEncoder),this.flushFramebuffer(!1),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - counters")),this._textureHelper.destroyDeferredTextures(),this._bufferManager.destroyDeferredBuffers(),this._features._collectUbosUpdatedInFrame){if(this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const e=[];for(const t in Pe._UpdatedUbosInFrame)e.push(t+":"+Pe._UpdatedUbosInFrame[t]);console.log("frame #"+this._count+" - updated ubos -",e.join(", "))}Pe._UpdatedUbosInFrame={}}this.countersLastFrame.numEnableEffects=this._counters.numEnableEffects,this.countersLastFrame.numEnableDrawWrapper=this._counters.numEnableDrawWrapper,this.countersLastFrame.numBundleCreationNonCompatMode=this._counters.numBundleCreationNonCompatMode,this.countersLastFrame.numBundleReuseNonCompatMode=this._counters.numBundleReuseNonCompatMode,this._counters.numEnableEffects=0,this._counters.numEnableDrawWrapper=0,this._counters.numBundleCreationNonCompatMode=0,this._counters.numBundleReuseNonCompatMode=0,this._cacheRenderPipeline.endFrame(),this._cacheBindGroups.endFrame(),this._pendingDebugCommands.length=0,super.endFrame(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),this._count<this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - end","background: #ffff00"),this._count<this.dbgVerboseLogsNumFrames&&(this._count++,this._count!==this.dbgVerboseLogsNumFrames&&console.log("%c frame #"+this._count+" - begin","background: #ffff00")))}flushFramebuffer(e=!0){const t=!this._currentRenderPass;let i=0;this._currentRenderPass&&this._currentRenderTarget&&(i|=1,this._endRenderTargetRenderPass()),this._mainRenderPassWrapper.renderPass&&(i|=2,this._endMainRenderPass()),this._commandBuffers[0]=this._uploadEncoder.finish(),this._commandBuffers[1]=this._renderTargetEncoder.finish(),this._commandBuffers[2]=this._renderEncoder.finish(),this._device.queue.submit(this._commandBuffers),this._uploadEncoder=this._device.createCommandEncoder(this._uploadEncoderDescriptor),this._renderEncoder=this._device.createCommandEncoder(this._renderEncoderDescriptor),this._renderTargetEncoder=this._device.createCommandEncoder(this._renderTargetEncoderDescriptor),this._timestampQuery.startFrame(this._uploadEncoder),this._textureHelper.setCommandEncoder(this._uploadEncoder),this._bundleList.reset(),this._bundleListRenderTarget.reset(),e&&(i&2&&this._startMainRenderPass(!1),i&1&&this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1),t&&this._currentRenderTarget&&(this._currentRenderPass=null))}_currentFrameBufferIsDefaultFrameBuffer(){return this._currentRenderTarget===null}_startRenderTargetRenderPass(e,t,i,s,r){var n,o,l;const h=e,c=h._depthStencilTexture,u=c==null?void 0:c._hardwareTexture,d=u==null?void 0:u.underlyingResource,f=u==null?void 0:u.msaaTexture,p=d==null?void 0:d.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),_=f==null?void 0:f.createView(this._rttRenderPassWrapper.depthAttachmentViewDescriptor),m=u?Lt.HasStencilAspect(u.format):!1,v=[];this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const x=t&&i,b=t&&s,S=t&&r;if(h._attachments&&h.isMulti){(!this._mrtAttachments||this._mrtAttachments.length===0)&&(this._mrtAttachments=h._defaultAttachments);for(let C=0;C<this._mrtAttachments.length;++C){const E=this._mrtAttachments[C],A=h.textures[C],M=A==null?void 0:A._hardwareTexture,D=M==null?void 0:M.underlyingResource;if(M&&D){const P={...this._rttRenderPassWrapper.colorAttachmentViewDescriptor,format:M.format},O=M.msaaTexture,N=D.createView(P),$=O==null?void 0:O.createView(P);v.push({view:$||N,resolveTarget:O?N:void 0,clearValue:E!==0&&x?i:void 0,loadOp:E!==0&&x?Ci.Clear:Ci.Load,storeOp:dr.Store})}}this._cacheRenderPipeline.setMRT(h.textures,this._mrtAttachments.length),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments)}else{const C=h.texture;if(C){const E=C._hardwareTexture,A=E.underlyingResource,M=E.msaaTexture,D=A.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor),P=M==null?void 0:M.createView(this._rttRenderPassWrapper.colorAttachmentViewDescriptor);v.push({view:P||D,resolveTarget:M?D:void 0,clearValue:x?i:void 0,loadOp:x?Ci.Clear:Ci.Load,storeOp:dr.Store})}else v.push(null)}if((n=this._debugPushGroup)===null||n===void 0||n.call(this,"render target pass",1),this._rttRenderPassWrapper.renderPassDescriptor={colorAttachments:v,depthStencilAttachment:c&&d?{view:_||p,depthClearValue:b?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,depthLoadOp:b?Ci.Clear:Ci.Load,depthStoreOp:dr.Store,stencilClearValue:h._depthStencilTextureWithStencil&&S?this._clearStencilValue:void 0,stencilLoadOp:m?h._depthStencilTextureWithStencil&&S?Ci.Clear:Ci.Load:void 0,stencilStoreOp:m?dr.Store:void 0}:void 0,occlusionQuerySet:!((o=this._occlusionQuery)===null||o===void 0)&&o.hasQueries?this._occlusionQuery.querySet:void 0},this._rttRenderPassWrapper.renderPass=this._renderTargetEncoder.beginRenderPass(this._rttRenderPassWrapper.renderPassDescriptor),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),!this._count||this._count<this.dbgVerboseLogsNumFrames)){const C=h.texture;console.log("frame #"+this._count+" - render target begin pass - internalTexture.uniqueId=",C.uniqueId,"width=",C.width,"height=",C.height,this._rttRenderPassWrapper.renderPassDescriptor)}this._currentRenderPass=this._rttRenderPassWrapper.renderPass,(l=this._debugFlushPendingCommands)===null||l===void 0||l.call(this),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),(!u||!Lt.HasStencilAspect(u.format))&&(this._stencilStateComposer.enabled=!1)}_endRenderTargetRenderPass(){var e,t,i,s;if(this._currentRenderPass){const r=(e=this._currentRenderTarget.texture)===null||e===void 0?void 0:e._hardwareTexture;r&&!this._snapshotRendering.endRenderTargetPass(this._currentRenderPass,r)&&!this.compatibilityMode&&(this._bundleListRenderTarget.run(this._currentRenderPass),this._bundleListRenderTarget.reset()),this._currentRenderPass.end(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - render target end pass - internalTexture.uniqueId=",(i=(t=this._currentRenderTarget)===null||t===void 0?void 0:t.texture)===null||i===void 0?void 0:i.uniqueId)),(s=this._debugPopGroup)===null||s===void 0||s.call(this,1),this._resetCurrentViewport(1),this._resetCurrentScissor(1),this._resetCurrentStencilRef(1),this._resetCurrentColorBlend(1),this._currentRenderPass=null,this._rttRenderPassWrapper.reset()}}_getCurrentRenderPass(){return this._currentRenderTarget&&!this._currentRenderPass?this._startRenderTargetRenderPass(this._currentRenderTarget,!1,null,!1,!1):this._currentRenderPass||this._startMainRenderPass(!1),this._currentRenderPass}_getCurrentRenderPassIndex(){return this._currentRenderPass===null?-1:this._currentRenderPass===this._mainRenderPassWrapper.renderPass?0:1}_startMainRenderPass(e,t,i,s){var r,n,o;this._mainRenderPassWrapper.renderPass&&this._endMainRenderPass(),this.useReverseDepthBuffer&&this.setDepthFunctionToGreaterOrEqual();const l=e&&t,h=e&&i,c=e&&s;this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].clearValue=l?t:void 0,this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].loadOp=l?Ci.Clear:Ci.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthClearValue=h?this.useReverseDepthBuffer?this._clearReverseDepthValue:this._clearDepthValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.depthLoadOp=h?Ci.Clear:Ci.Load,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilClearValue=c?this._clearStencilValue:void 0,this._mainRenderPassWrapper.renderPassDescriptor.depthStencilAttachment.stencilLoadOp=this.isStencilEnable?c?Ci.Clear:Ci.Load:void 0,this._mainRenderPassWrapper.renderPassDescriptor.occlusionQuerySet=!((r=this._occlusionQuery)===null||r===void 0)&&r.hasQueries?this._occlusionQuery.querySet:void 0,this._swapChainTexture=this._context.getCurrentTexture(),this._mainRenderPassWrapper.colorAttachmentGPUTextures[0].set(this._swapChainTexture),this._options.antialiasing?this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].resolveTarget=this._swapChainTexture.createView():this._mainRenderPassWrapper.renderPassDescriptor.colorAttachments[0].view=this._swapChainTexture.createView(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main begin pass - texture width="+this._mainTextureExtends.width," height="+this._mainTextureExtends.height,this._mainRenderPassWrapper.renderPassDescriptor)),(n=this._debugPushGroup)===null||n===void 0||n.call(this,"main pass",0),this._currentRenderPass=this._renderEncoder.beginRenderPass(this._mainRenderPassWrapper.renderPassDescriptor),this._mainRenderPassWrapper.renderPass=this._currentRenderPass,(o=this._debugFlushPendingCommands)===null||o===void 0||o.call(this),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._isStencilEnable||(this._stencilStateComposer.enabled=!1)}_endMainRenderPass(){var e;this._mainRenderPassWrapper.renderPass!==null&&(this._snapshotRendering.endMainRenderPass(),!this.compatibilityMode&&!this._snapshotRendering.play&&(this._bundleList.run(this._mainRenderPassWrapper.renderPass),this._bundleList.reset()),this._mainRenderPassWrapper.renderPass.end(),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - main end pass")),(e=this._debugPopGroup)===null||e===void 0||e.call(this,0),this._resetCurrentViewport(0),this._resetCurrentScissor(0),this._resetCurrentStencilRef(0),this._resetCurrentColorBlend(0),this._mainRenderPassWrapper.renderPass===this._currentRenderPass&&(this._currentRenderPass=null),this._mainRenderPassWrapper.reset(!1))}bindFramebuffer(e,t=0,i,s,r,n=0,o=0){var l,h;const c=(l=e.texture)===null||l===void 0?void 0:l._hardwareTexture;this._currentRenderTarget&&this.unBindFramebuffer(this._currentRenderTarget),this._currentRenderTarget=e,c&&(c._currentLayer=e.isCube?o*6+t:o),this._rttRenderPassWrapper.colorAttachmentGPUTextures[0]=c,this._rttRenderPassWrapper.depthTextureFormat=this._currentRenderTarget._depthStencilTexture?Lt.GetWebGPUTextureFormat(-1,this._currentRenderTarget._depthStencilTexture.format):void 0,this._setDepthTextureFormat(this._rttRenderPassWrapper),this._setColorFormat(this._rttRenderPassWrapper),this._rttRenderPassWrapper.colorAttachmentViewDescriptor={format:this._colorFormat,dimension:Mt.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?o*6+t:o,baseMipLevel:n,arrayLayerCount:1,aspect:_n.All},this._rttRenderPassWrapper.depthAttachmentViewDescriptor={format:this._depthTextureFormat,dimension:Mt.E2d,mipLevelCount:1,baseArrayLayer:e.isCube?o*6+t:o,baseMipLevel:0,arrayLayerCount:1,aspect:_n.All},this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - bindFramebuffer called - internalTexture.uniqueId=",(h=e.texture)===null||h===void 0?void 0:h.uniqueId,"face=",t,"lodLevel=",n,"layer=",o,this._rttRenderPassWrapper.colorAttachmentViewDescriptor,this._rttRenderPassWrapper.depthAttachmentViewDescriptor)),this._currentRenderPass=null,this.snapshotRendering&&this.snapshotRenderingMode===1&&this._getCurrentRenderPass(),this._cachedViewport&&!r?this.setViewport(this._cachedViewport,i,s):(i||(i=e.width,n&&(i=i/Math.pow(2,n))),s||(s=e.height,n&&(s=s/Math.pow(2,n))),this._viewport(0,0,i,s)),this.wipeCaches()}unBindFramebuffer(e,t=!1,i){var s,r;const n=this._currentRenderTarget;this._currentRenderTarget=null,i&&i(),this._currentRenderTarget=n,this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass(),((s=e.texture)===null||s===void 0?void 0:s.generateMipMaps)&&!t&&!e.isCube&&this._generateMipmaps(e.texture),this._currentRenderTarget=null,this._onAfterUnbindFrameBufferObservable.notifyObservers(this),this.dbgVerboseLogsForFirstFrames&&(this._count===void 0&&(this._count=0),(!this._count||this._count<this.dbgVerboseLogsNumFrames)&&console.log("frame #"+this._count+" - unBindFramebuffer called - internalTexture.uniqueId=",(r=e.texture)===null||r===void 0?void 0:r.uniqueId)),this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)}restoreDefaultFramebuffer(){this._currentRenderTarget?this.unBindFramebuffer(this._currentRenderTarget):(this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)),this._currentRenderPass&&this._cachedViewport&&this.setViewport(this._cachedViewport),this.wipeCaches()}_setColorFormat(e){var t,i;const s=(i=(t=e.colorAttachmentGPUTextures[0])===null||t===void 0?void 0:t.format)!==null&&i!==void 0?i:null;this._cacheRenderPipeline.setColorFormat(s),this._colorFormat!==s&&(this._colorFormat=s)}_setDepthTextureFormat(e){this._cacheRenderPipeline.setDepthStencilFormat(e.depthTextureFormat),this._depthTextureFormat!==e.depthTextureFormat&&(this._depthTextureFormat=e.depthTextureFormat)}setDitheringState(){}setRasterizerState(){}setState(e,t=0,i,s=!1,r,n,o=0){var l,h;(this._depthCullingState.cull!==e||i)&&(this._depthCullingState.cull=e);const c=!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:r)!==null&&h!==void 0)||h?1:2;(this._depthCullingState.cullFace!==c||i)&&(this._depthCullingState.cullFace=c),this.setZOffset(t),this.setZOffsetUnits(o);const u=s?this._currentRenderTarget?1:2:this._currentRenderTarget?2:1;(this._depthCullingState.frontFace!==u||i)&&(this._depthCullingState.frontFace=u),this._stencilStateComposer.stencilMaterial=n}_applyRenderPassChanges(e,t){var i;const s=this._mustUpdateViewport(e),r=this._mustUpdateScissor(e),n=this._stencilStateComposer.enabled?this._mustUpdateStencilRef(e):!1,o=this._alphaState.alphaBlend?this._mustUpdateBlendColor(e):!1;t?(s&&t.addItem(new Fd(this._viewportCached.x,this._viewportCached.y,this._viewportCached.z,this._viewportCached.w)),r&&t.addItem(new hl(this._scissorCached.x,this._scissorCached.y,this._scissorCached.z,this._scissorCached.w)),n&&t.addItem(new cl((i=this._stencilStateComposer.funcRef)!==null&&i!==void 0?i:0)),o&&t.addItem(new Ld(this._alphaState._blendConstants.slice()))):(s&&this._applyViewport(e),r&&this._applyScissor(e),n&&this._applyStencilRef(e),o&&this._applyBlendColor(e))}_draw(e,t,i,s,r){var n;const o=this._getCurrentRenderPass(),h=this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget;this.applyStates();const c=this._currentEffect._pipelineContext;if(this.bindUniformBufferBase(this._currentRenderTarget?this._ubInvertY:this._ubDontInvertY,0,Vt.InternalsUBOName),c.uniformBuffer&&(c.uniformBuffer.update(),this.bindUniformBufferBase(c.uniformBuffer.getBuffer(),0,Vt.LeftOvertUBOName)),this._snapshotRendering.play){this._reportDrawCall();return}!this.compatibilityMode&&(this._currentDrawContext.isDirty(this._currentMaterialContext.updateId)||this._currentMaterialContext.isDirty||this._currentMaterialContext.forceBindGroupCreation)&&(this._currentDrawContext.fastBundle=void 0);const u=!this.compatibilityMode&&this._currentDrawContext.fastBundle;let d=o;if(u||this._snapshotRendering.record){if(this._applyRenderPassChanges(o,h),!this._snapshotRendering.record){this._counters.numBundleReuseNonCompatMode++,this._currentDrawContext.indirectDrawBuffer&&this._currentDrawContext.setIndirectData(s,r||1,i),h.addBundle(this._currentDrawContext.fastBundle),this._reportDrawCall();return}d=h.getBundleEncoder(this._cacheRenderPipeline.colorFormats,this._depthTextureFormat,this.currentSampleCount),h.numDrawCalls++}let f=0;if(!this._caps.textureFloatLinearFiltering&&this._currentMaterialContext.hasFloatTextures){let x=1;for(let b=0;b<c.shaderProcessingContext.textureNames.length;++b){const S=c.shaderProcessingContext.textureNames[b],C=(n=this._currentMaterialContext.textures[S])===null||n===void 0?void 0:n.texture;(C==null?void 0:C.type)===1&&(f|=x),x=x<<1}}const p=this._cacheRenderPipeline.getRenderPipeline(t,this._currentEffect,this.currentSampleCount,f),_=this._cacheBindGroups.getBindGroups(c,this._currentDrawContext,this._currentMaterialContext);this._snapshotRendering.record||(this._applyRenderPassChanges(o,this.compatibilityMode?null:h),this.compatibilityMode||(this._counters.numBundleCreationNonCompatMode++,d=this._device.createRenderBundleEncoder({colorFormats:this._cacheRenderPipeline.colorFormats,depthStencilFormat:this._depthTextureFormat,sampleCount:this.currentSampleCount}))),d.setPipeline(p),this._currentIndexBuffer&&d.setIndexBuffer(this._currentIndexBuffer.underlyingResource,this._currentIndexBuffer.is32Bits?Fa.Uint32:Fa.Uint16,0);const m=this._cacheRenderPipeline.vertexBuffers;for(let x=0;x<m.length;x++){const b=m[x],S=b.getBuffer();S&&d.setVertexBuffer(x,S.underlyingResource,b._validOffsetRange?0:b.byteOffset)}for(let x=0;x<_.length;x++)d.setBindGroup(x,_[x]);const v=!this.compatibilityMode&&!this._snapshotRendering.record;v&&this._currentDrawContext.indirectDrawBuffer?(this._currentDrawContext.setIndirectData(s,r||1,i),e===0?d.drawIndexedIndirect(this._currentDrawContext.indirectDrawBuffer,0):d.drawIndirect(this._currentDrawContext.indirectDrawBuffer,0)):e===0?d.drawIndexed(s,r||1,i,0,0):d.draw(s,r||1,i,0),v&&(this._currentDrawContext.fastBundle=d.finish(),h.addBundle(this._currentDrawContext.fastBundle)),this._reportDrawCall()}drawElementsType(e,t,i,s=1){this._draw(0,e,t,i,s)}drawArraysType(e,t,i,s=1){this._currentIndexBuffer=null,this._draw(1,e,t,i,s)}dispose(){var e,t,i;(e=this._mainTexture)===null||e===void 0||e.destroy(),(t=this._mainTextureLastCopy)===null||t===void 0||t.destroy(),(i=this._depthTexture)===null||i===void 0||i.destroy(),super.dispose()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._canvas.width}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._canvas.height}getRenderingCanvas(){return this._canvas}getError(){return 0}bindSamplers(){}_bindTextureDirectly(){return!1}areAllEffectsReady(){return!0}_executeWhenRenderingStateIsCompiled(e,t){t()}_isRenderingStateCompiled(){return!0}_getUnpackAlignement(){return 1}_unpackFlipY(){}_bindUnboundFramebuffer(){throw"_bindUnboundFramebuffer is not implementedin WebGPU! You probably want to use restoreDefaultFramebuffer or unBindFramebuffer instead"}_getSamplingParameters(){throw"_getSamplingParameters is not available in WebGPU"}getUniforms(){return[]}setIntArray(){return!1}setIntArray2(){return!1}setIntArray3(){return!1}setIntArray4(){return!1}setArray(){return!1}setArray2(){return!1}setArray3(){return!1}setArray4(){return!1}setMatrices(){return!1}setMatrix3x3(){return!1}setMatrix2x2(){return!1}setFloat(){return!1}setFloat2(){return!1}setFloat3(){return!1}setFloat4(){return!1}}Le._GLSLslangDefaultOptions={jsPath:"https://preview.babylonjs.com/glslang/glslang.js",wasmPath:"https://preview.babylonjs.com/glslang/glslang.wasm"};Le.UseTWGSL=!0;class Zu{constructor(){this._count=0,this._data={}}copyFrom(e){this.clear(),e.forEach((t,i)=>this.add(t,i))}get(e){const t=this._data[e];if(t!==void 0)return t}getOrAddWithFactory(e,t){let i=this.get(e);return i!==void 0||(i=t(e),i&&this.add(e,i)),i}getOrAdd(e,t){const i=this.get(e);return i!==void 0?i:(this.add(e,t),t)}contains(e){return this._data[e]!==void 0}add(e,t){return this._data[e]!==void 0?!1:(this._data[e]=t,++this._count,!0)}set(e,t){return this._data[e]===void 0?!1:(this._data[e]=t,!0)}getAndRemove(e){const t=this.get(e);return t!==void 0?(delete this._data[e],--this._count,t):null}remove(e){return this.contains(e)?(delete this._data[e],--this._count,!0):!1}clear(){this._data={},this._count=0}get count(){return this._count}forEach(e){for(const t in this._data){const i=this._data[t];e(t,i)}}first(e){for(const t in this._data){const i=this._data[t],s=e(t,i);if(s)return s}return null}}class li{constructor(){this.rootNodes=new Array,this.cameras=new Array,this.lights=new Array,this.meshes=new Array,this.skeletons=new Array,this.particleSystems=new Array,this.animations=[],this.animationGroups=new Array,this.multiMaterials=new Array,this.materials=new Array,this.morphTargetManagers=new Array,this.geometries=new Array,this.transformNodes=new Array,this.actionManagers=new Array,this.textures=new Array,this._environmentTexture=null,this.postProcesses=new Array}static AddParser(e,t){this._BabylonFileParsers[e]=t}static GetParser(e){return this._BabylonFileParsers[e]?this._BabylonFileParsers[e]:null}static AddIndividualParser(e,t){this._IndividualBabylonFileParsers[e]=t}static GetIndividualParser(e){return this._IndividualBabylonFileParsers[e]?this._IndividualBabylonFileParsers[e]:null}static Parse(e,t,i,s){for(const r in this._BabylonFileParsers)Object.prototype.hasOwnProperty.call(this._BabylonFileParsers,r)&&this._BabylonFileParsers[r](e,t,i,s)}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture=e}getNodes(){let e=new Array;return e=e.concat(this.meshes),e=e.concat(this.lights),e=e.concat(this.cameras),e=e.concat(this.transformNodes),this.skeletons.forEach(t=>e=e.concat(t.bones)),e}}li._BabylonFileParsers={};li._IndividualBabylonFileParsers={};class rr{constructor(e){if(this._keys=[],this._isDirty=!0,this._areLightsDirty=!0,this._areLightsDisposed=!1,this._areAttributesDirty=!0,this._areTexturesDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._arePrePassDirty=!0,this._areImageProcessingDirty=!0,this._normals=!1,this._uvs=!1,this._needNormals=!1,this._needUVs=!1,this._externalProperties=e,e)for(const t in e)Object.prototype.hasOwnProperty.call(e,t)&&this._setDefaultValue(t)}get isDirty(){return this._isDirty}markAsProcessed(){this._isDirty=!1,this._areAttributesDirty=!1,this._areTexturesDirty=!1,this._areFresnelDirty=!1,this._areLightsDirty=!1,this._areLightsDisposed=!1,this._areMiscDirty=!1,this._arePrePassDirty=!1,this._areImageProcessingDirty=!1}markAsUnprocessed(){this._isDirty=!0}markAllAsDirty(){this._areTexturesDirty=!0,this._areAttributesDirty=!0,this._areLightsDirty=!0,this._areFresnelDirty=!0,this._areMiscDirty=!0,this._areImageProcessingDirty=!0,this._isDirty=!0}markAsImageProcessingDirty(){this._areImageProcessingDirty=!0,this._isDirty=!0}markAsLightDirty(e=!1){this._areLightsDirty=!0,this._areLightsDisposed=this._areLightsDisposed||e,this._isDirty=!0}markAsAttributesDirty(){this._areAttributesDirty=!0,this._isDirty=!0}markAsTexturesDirty(){this._areTexturesDirty=!0,this._isDirty=!0}markAsFresnelDirty(){this._areFresnelDirty=!0,this._isDirty=!0}markAsMiscDirty(){this._areMiscDirty=!0,this._isDirty=!0}markAsPrePassDirty(){this._arePrePassDirty=!0,this._isDirty=!0}rebuild(){this._keys.length=0;for(const e of Object.keys(this))e[0]!=="_"&&this._keys.push(e);if(this._externalProperties)for(const e in this._externalProperties)this._keys.indexOf(e)===-1&&this._keys.push(e)}isEqual(e){if(this._keys.length!==e._keys.length)return!1;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];if(this[i]!==e[i])return!1}return!0}cloneTo(e){this._keys.length!==e._keys.length&&(e._keys=this._keys.slice(0));for(let t=0;t<this._keys.length;t++){const i=this._keys[t];e[i]=this[i]}}reset(){this._keys.forEach(e=>this._setDefaultValue(e))}_setDefaultValue(e){var t,i,s,r,n;const o=(s=(i=(t=this._externalProperties)===null||t===void 0?void 0:t[e])===null||i===void 0?void 0:i.type)!==null&&s!==void 0?s:typeof this[e],l=(n=(r=this._externalProperties)===null||r===void 0?void 0:r[e])===null||n===void 0?void 0:n.default;switch(o){case"number":this[e]=l!=null?l:0;break;case"string":this[e]=l!=null?l:"";break;default:this[e]=l!=null?l:!1;break}}toString(){let e="";for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=this[i];switch(typeof s){case"number":case"string":e+="#define "+i+" "+s+`
`;break;default:s&&(e+="#define "+i+`
`);break}}return e}}class Kt{constructor(){this._dirty=!0,this._tempColor=new J(0,0,0,0),this._globalCurve=new J(0,0,0,0),this._highlightsCurve=new J(0,0,0,0),this._midtonesCurve=new J(0,0,0,0),this._shadowsCurve=new J(0,0,0,0),this._positiveCurve=new J(0,0,0,0),this._negativeCurve=new J(0,0,0,0),this._globalHue=30,this._globalDensity=0,this._globalSaturation=0,this._globalExposure=0,this._highlightsHue=30,this._highlightsDensity=0,this._highlightsSaturation=0,this._highlightsExposure=0,this._midtonesHue=30,this._midtonesDensity=0,this._midtonesSaturation=0,this._midtonesExposure=0,this._shadowsHue=30,this._shadowsDensity=0,this._shadowsSaturation=0,this._shadowsExposure=0}get globalHue(){return this._globalHue}set globalHue(e){this._globalHue=e,this._dirty=!0}get globalDensity(){return this._globalDensity}set globalDensity(e){this._globalDensity=e,this._dirty=!0}get globalSaturation(){return this._globalSaturation}set globalSaturation(e){this._globalSaturation=e,this._dirty=!0}get globalExposure(){return this._globalExposure}set globalExposure(e){this._globalExposure=e,this._dirty=!0}get highlightsHue(){return this._highlightsHue}set highlightsHue(e){this._highlightsHue=e,this._dirty=!0}get highlightsDensity(){return this._highlightsDensity}set highlightsDensity(e){this._highlightsDensity=e,this._dirty=!0}get highlightsSaturation(){return this._highlightsSaturation}set highlightsSaturation(e){this._highlightsSaturation=e,this._dirty=!0}get highlightsExposure(){return this._highlightsExposure}set highlightsExposure(e){this._highlightsExposure=e,this._dirty=!0}get midtonesHue(){return this._midtonesHue}set midtonesHue(e){this._midtonesHue=e,this._dirty=!0}get midtonesDensity(){return this._midtonesDensity}set midtonesDensity(e){this._midtonesDensity=e,this._dirty=!0}get midtonesSaturation(){return this._midtonesSaturation}set midtonesSaturation(e){this._midtonesSaturation=e,this._dirty=!0}get midtonesExposure(){return this._midtonesExposure}set midtonesExposure(e){this._midtonesExposure=e,this._dirty=!0}get shadowsHue(){return this._shadowsHue}set shadowsHue(e){this._shadowsHue=e,this._dirty=!0}get shadowsDensity(){return this._shadowsDensity}set shadowsDensity(e){this._shadowsDensity=e,this._dirty=!0}get shadowsSaturation(){return this._shadowsSaturation}set shadowsSaturation(e){this._shadowsSaturation=e,this._dirty=!0}get shadowsExposure(){return this._shadowsExposure}set shadowsExposure(e){this._shadowsExposure=e,this._dirty=!0}getClassName(){return"ColorCurves"}static Bind(e,t,i="vCameraColorCurvePositive",s="vCameraColorCurveNeutral",r="vCameraColorCurveNegative"){e._dirty&&(e._dirty=!1,e._getColorGradingDataToRef(e._globalHue,e._globalDensity,e._globalSaturation,e._globalExposure,e._globalCurve),e._getColorGradingDataToRef(e._highlightsHue,e._highlightsDensity,e._highlightsSaturation,e._highlightsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._highlightsCurve),e._getColorGradingDataToRef(e._midtonesHue,e._midtonesDensity,e._midtonesSaturation,e._midtonesExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._midtonesCurve),e._getColorGradingDataToRef(e._shadowsHue,e._shadowsDensity,e._shadowsSaturation,e._shadowsExposure,e._tempColor),e._tempColor.multiplyToRef(e._globalCurve,e._shadowsCurve),e._highlightsCurve.subtractToRef(e._midtonesCurve,e._positiveCurve),e._midtonesCurve.subtractToRef(e._shadowsCurve,e._negativeCurve)),t&&(t.setFloat4(i,e._positiveCurve.r,e._positiveCurve.g,e._positiveCurve.b,e._positiveCurve.a),t.setFloat4(s,e._midtonesCurve.r,e._midtonesCurve.g,e._midtonesCurve.b,e._midtonesCurve.a),t.setFloat4(r,e._negativeCurve.r,e._negativeCurve.g,e._negativeCurve.b,e._negativeCurve.a))}static PrepareUniforms(e){e.push("vCameraColorCurveNeutral","vCameraColorCurvePositive","vCameraColorCurveNegative")}_getColorGradingDataToRef(e,t,i,s,r){e!=null&&(e=Kt._Clamp(e,0,360),t=Kt._Clamp(t,-100,100),i=Kt._Clamp(i,-100,100),s=Kt._Clamp(s,-100,100),t=Kt._ApplyColorGradingSliderNonlinear(t),t*=.5,s=Kt._ApplyColorGradingSliderNonlinear(s),t<0&&(t*=-1,e=(e+180)%360),Kt._FromHSBToRef(e,t,50+.25*s,r),r.scaleToRef(2,r),r.a=1+.01*i)}static _ApplyColorGradingSliderNonlinear(e){e/=100;let t=Math.abs(e);return t=Math.pow(t,2),e<0&&(t*=-1),t*=100,t}static _FromHSBToRef(e,t,i,s){let r=Kt._Clamp(e,0,360);const n=Kt._Clamp(t/100,0,1),o=Kt._Clamp(i/100,0,1);if(n===0)s.r=o,s.g=o,s.b=o;else{r/=60;const l=Math.floor(r),h=r-l,c=o*(1-n),u=o*(1-n*h),d=o*(1-n*(1-h));switch(l){case 0:s.r=o,s.g=d,s.b=c;break;case 1:s.r=u,s.g=o,s.b=c;break;case 2:s.r=c,s.g=o,s.b=d;break;case 3:s.r=c,s.g=u,s.b=o;break;case 4:s.r=d,s.g=c,s.b=o;break;default:s.r=o,s.g=c,s.b=u;break}}s.a=1}static _Clamp(e,t,i){return Math.min(Math.max(e,t),i)}clone(){return xe.Clone(()=>new Kt,this)}serialize(){return xe.Serialize(this)}static Parse(e){return xe.Parse(()=>new Kt,e,null,null)}}T([R()],Kt.prototype,"_globalHue",void 0);T([R()],Kt.prototype,"_globalDensity",void 0);T([R()],Kt.prototype,"_globalSaturation",void 0);T([R()],Kt.prototype,"_globalExposure",void 0);T([R()],Kt.prototype,"_highlightsHue",void 0);T([R()],Kt.prototype,"_highlightsDensity",void 0);T([R()],Kt.prototype,"_highlightsSaturation",void 0);T([R()],Kt.prototype,"_highlightsExposure",void 0);T([R()],Kt.prototype,"_midtonesHue",void 0);T([R()],Kt.prototype,"_midtonesDensity",void 0);T([R()],Kt.prototype,"_midtonesSaturation",void 0);T([R()],Kt.prototype,"_midtonesExposure",void 0);xe._ColorCurvesParser=Kt.Parse;class Gx extends rr{constructor(){super(),this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.EXPOSURE=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class qe{constructor(){this.colorCurves=new Kt,this._colorCurvesEnabled=!1,this._colorGradingEnabled=!1,this._colorGradingWithGreenDepth=!0,this._colorGradingBGR=!0,this._exposure=1,this._toneMappingEnabled=!1,this._toneMappingType=qe.TONEMAPPING_STANDARD,this._contrast=1,this.vignetteStretch=0,this.vignetteCentreX=0,this.vignetteCentreY=0,this.vignetteWeight=1.5,this.vignetteColor=new J(0,0,0,0),this.vignetteCameraFov=.5,this._vignetteBlendMode=qe.VIGNETTEMODE_MULTIPLY,this._vignetteEnabled=!1,this._ditheringEnabled=!1,this._ditheringIntensity=1/255,this._skipFinalColorClamp=!1,this._applyByPostProcess=!1,this._isEnabled=!0,this.onUpdateParameters=new X}get colorCurvesEnabled(){return this._colorCurvesEnabled}set colorCurvesEnabled(e){this._colorCurvesEnabled!==e&&(this._colorCurvesEnabled=e,this._updateParameters())}get colorGradingTexture(){return this._colorGradingTexture}set colorGradingTexture(e){this._colorGradingTexture!==e&&(this._colorGradingTexture=e,this._updateParameters())}get colorGradingEnabled(){return this._colorGradingEnabled}set colorGradingEnabled(e){this._colorGradingEnabled!==e&&(this._colorGradingEnabled=e,this._updateParameters())}get colorGradingWithGreenDepth(){return this._colorGradingWithGreenDepth}set colorGradingWithGreenDepth(e){this._colorGradingWithGreenDepth!==e&&(this._colorGradingWithGreenDepth=e,this._updateParameters())}get colorGradingBGR(){return this._colorGradingBGR}set colorGradingBGR(e){this._colorGradingBGR!==e&&(this._colorGradingBGR=e,this._updateParameters())}get exposure(){return this._exposure}set exposure(e){this._exposure!==e&&(this._exposure=e,this._updateParameters())}get toneMappingEnabled(){return this._toneMappingEnabled}set toneMappingEnabled(e){this._toneMappingEnabled!==e&&(this._toneMappingEnabled=e,this._updateParameters())}get toneMappingType(){return this._toneMappingType}set toneMappingType(e){this._toneMappingType!==e&&(this._toneMappingType=e,this._updateParameters())}get contrast(){return this._contrast}set contrast(e){this._contrast!==e&&(this._contrast=e,this._updateParameters())}get vignetteBlendMode(){return this._vignetteBlendMode}set vignetteBlendMode(e){this._vignetteBlendMode!==e&&(this._vignetteBlendMode=e,this._updateParameters())}get vignetteEnabled(){return this._vignetteEnabled}set vignetteEnabled(e){this._vignetteEnabled!==e&&(this._vignetteEnabled=e,this._updateParameters())}get ditheringEnabled(){return this._ditheringEnabled}set ditheringEnabled(e){this._ditheringEnabled!==e&&(this._ditheringEnabled=e,this._updateParameters())}get ditheringIntensity(){return this._ditheringIntensity}set ditheringIntensity(e){this._ditheringIntensity!==e&&(this._ditheringIntensity=e,this._updateParameters())}get skipFinalColorClamp(){return this._skipFinalColorClamp}set skipFinalColorClamp(e){this._skipFinalColorClamp!==e&&(this._skipFinalColorClamp=e,this._updateParameters())}get applyByPostProcess(){return this._applyByPostProcess}set applyByPostProcess(e){this._applyByPostProcess!==e&&(this._applyByPostProcess=e,this._updateParameters())}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,this._updateParameters())}_updateParameters(){this.onUpdateParameters.notifyObservers(this)}getClassName(){return"ImageProcessingConfiguration"}static PrepareUniforms(e,t){t.EXPOSURE&&e.push("exposureLinear"),t.CONTRAST&&e.push("contrast"),t.COLORGRADING&&e.push("colorTransformSettings"),(t.VIGNETTE||t.DITHER)&&e.push("vInverseScreenSize"),t.VIGNETTE&&(e.push("vignetteSettings1"),e.push("vignetteSettings2")),t.COLORCURVES&&Kt.PrepareUniforms(e),t.DITHER&&e.push("ditherIntensity")}static PrepareSamplers(e,t){t.COLORGRADING&&e.push("txColorTransform")}prepareDefines(e,t=!1){if(t!==this.applyByPostProcess||!this._isEnabled){e.VIGNETTE=!1,e.TONEMAPPING=!1,e.TONEMAPPING_ACES=!1,e.CONTRAST=!1,e.EXPOSURE=!1,e.COLORCURVES=!1,e.COLORGRADING=!1,e.COLORGRADING3D=!1,e.DITHER=!1,e.IMAGEPROCESSING=!1,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess&&this._isEnabled;return}switch(e.VIGNETTE=this.vignetteEnabled,e.VIGNETTEBLENDMODEMULTIPLY=this.vignetteBlendMode===qe._VIGNETTEMODE_MULTIPLY,e.VIGNETTEBLENDMODEOPAQUE=!e.VIGNETTEBLENDMODEMULTIPLY,e.TONEMAPPING=this.toneMappingEnabled,this._toneMappingType){case qe.TONEMAPPING_ACES:e.TONEMAPPING_ACES=!0;break;default:e.TONEMAPPING_ACES=!1;break}e.CONTRAST=this.contrast!==1,e.EXPOSURE=this.exposure!==1,e.COLORCURVES=this.colorCurvesEnabled&&!!this.colorCurves,e.COLORGRADING=this.colorGradingEnabled&&!!this.colorGradingTexture,e.COLORGRADING?e.COLORGRADING3D=this.colorGradingTexture.is3D:e.COLORGRADING3D=!1,e.SAMPLER3DGREENDEPTH=this.colorGradingWithGreenDepth,e.SAMPLER3DBGRMAP=this.colorGradingBGR,e.DITHER=this._ditheringEnabled,e.IMAGEPROCESSINGPOSTPROCESS=this.applyByPostProcess,e.SKIPFINALCOLORCLAMP=this.skipFinalColorClamp,e.IMAGEPROCESSING=e.VIGNETTE||e.TONEMAPPING||e.CONTRAST||e.EXPOSURE||e.COLORCURVES||e.COLORGRADING||e.DITHER}isReady(){return!this.colorGradingEnabled||!this.colorGradingTexture||this.colorGradingTexture.isReady()}bind(e,t){if(this._colorCurvesEnabled&&this.colorCurves&&Kt.Bind(this.colorCurves,e),this._vignetteEnabled||this._ditheringEnabled){const i=1/e.getEngine().getRenderWidth(),s=1/e.getEngine().getRenderHeight();if(e.setFloat2("vInverseScreenSize",i,s),this._ditheringEnabled&&e.setFloat("ditherIntensity",.5*this._ditheringIntensity),this._vignetteEnabled){const r=t!=null?t:s/i;let n=Math.tan(this.vignetteCameraFov*.5),o=n*r;const l=Math.sqrt(o*n);o=q.Mix(o,l,this.vignetteStretch),n=q.Mix(n,l,this.vignetteStretch),e.setFloat4("vignetteSettings1",o,n,-o*this.vignetteCentreX,-n*this.vignetteCentreY);const h=-2*this.vignetteWeight;e.setFloat4("vignetteSettings2",this.vignetteColor.r,this.vignetteColor.g,this.vignetteColor.b,h)}}if(e.setFloat("exposureLinear",this.exposure),e.setFloat("contrast",this.contrast),this.colorGradingTexture){e.setTexture("txColorTransform",this.colorGradingTexture);const i=this.colorGradingTexture.getSize().height;e.setFloat4("colorTransformSettings",(i-1)/i,.5/i,i,this.colorGradingTexture.level)}}clone(){return xe.Clone(()=>new qe,this)}serialize(){return xe.Serialize(this)}static Parse(e){return xe.Parse(()=>new qe,e,null,null)}static get VIGNETTEMODE_MULTIPLY(){return this._VIGNETTEMODE_MULTIPLY}static get VIGNETTEMODE_OPAQUE(){return this._VIGNETTEMODE_OPAQUE}}qe.TONEMAPPING_STANDARD=0;qe.TONEMAPPING_ACES=1;qe._VIGNETTEMODE_MULTIPLY=0;qe._VIGNETTEMODE_OPAQUE=1;T([fx()],qe.prototype,"colorCurves",void 0);T([R()],qe.prototype,"_colorCurvesEnabled",void 0);T([Qe("colorGradingTexture")],qe.prototype,"_colorGradingTexture",void 0);T([R()],qe.prototype,"_colorGradingEnabled",void 0);T([R()],qe.prototype,"_colorGradingWithGreenDepth",void 0);T([R()],qe.prototype,"_colorGradingBGR",void 0);T([R()],qe.prototype,"_exposure",void 0);T([R()],qe.prototype,"_toneMappingEnabled",void 0);T([R()],qe.prototype,"_toneMappingType",void 0);T([R()],qe.prototype,"_contrast",void 0);T([R()],qe.prototype,"vignetteStretch",void 0);T([R()],qe.prototype,"vignetteCentreX",void 0);T([R()],qe.prototype,"vignetteCentreY",void 0);T([R()],qe.prototype,"vignetteWeight",void 0);T([Od()],qe.prototype,"vignetteColor",void 0);T([R()],qe.prototype,"vignetteCameraFov",void 0);T([R()],qe.prototype,"_vignetteBlendMode",void 0);T([R()],qe.prototype,"_vignetteEnabled",void 0);T([R()],qe.prototype,"_ditheringEnabled",void 0);T([R()],qe.prototype,"_ditheringIntensity",void 0);T([R()],qe.prototype,"_skipFinalColorClamp",void 0);T([R()],qe.prototype,"_applyByPostProcess",void 0);T([R()],qe.prototype,"_isEnabled",void 0);xe._ImageProcessingConfigurationParser=qe.Parse;class ki{constructor(){this._pickingUnavailable=!1,this.hit=!1,this.distance=0,this.pickedPoint=null,this.pickedMesh=null,this.bu=0,this.bv=0,this.faceId=-1,this.subMeshFaceId=-1,this.subMeshId=0,this.pickedSprite=null,this.thinInstanceIndex=-1,this.ray=null,this.originMesh=null,this.aimTransform=null,this.gripTransform=null}getNormal(e=!1,t=!0){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(y.NormalKind))return null;const i=this.pickedMesh.getIndices();if(!i)return null;let s;if(t){const r=this.pickedMesh.getVerticesData(y.NormalKind);let n=g.FromArray(r,i[this.faceId*3]*3),o=g.FromArray(r,i[this.faceId*3+1]*3),l=g.FromArray(r,i[this.faceId*3+2]*3);n=n.scale(this.bu),o=o.scale(this.bv),l=l.scale(1-this.bu-this.bv),s=new g(n.x+o.x+l.x,n.y+o.y+l.y,n.z+o.z+l.z)}else{const r=this.pickedMesh.getVerticesData(y.PositionKind),n=g.FromArray(r,i[this.faceId*3]*3),o=g.FromArray(r,i[this.faceId*3+1]*3),l=g.FromArray(r,i[this.faceId*3+2]*3),h=n.subtract(o),c=l.subtract(o);s=g.Cross(h,c)}if(e){let r=this.pickedMesh.getWorldMatrix();this.pickedMesh.nonUniformScaling&&(G.Matrix[0].copyFrom(r),r=G.Matrix[0],r.setTranslationFromFloats(0,0,0),r.invert(),r.transposeToRef(G.Matrix[1]),r=G.Matrix[1]),s=g.TransformNormal(s,r)}return s.normalize(),s}getTextureCoordinates(){if(!this.pickedMesh||!this.pickedMesh.isVerticesDataPresent(y.UVKind))return null;const e=this.pickedMesh.getIndices();if(!e)return null;const t=this.pickedMesh.getVerticesData(y.UVKind);if(!t)return null;let i=le.FromArray(t,e[this.faceId*3]*2),s=le.FromArray(t,e[this.faceId*3+1]*2),r=le.FromArray(t,e[this.faceId*3+2]*2);return i=i.scale(this.bu),s=s.scale(this.bv),r=r.scale(1-this.bu-this.bv),new le(i.x+s.x+r.x,i.y+s.y+r.y)}}class Ri{constructor(e,t,i,s,r,n){this.source=e,this.pointerX=t,this.pointerY=i,this.meshUnderPointer=s,this.sourceEvent=r,this.additionalData=n}static CreateNew(e,t,i){const s=e.getScene();return new Ri(e,s.pointerX,s.pointerY,s.meshUnderPointer||e,t,i)}static CreateNewFromSprite(e,t,i,s){return new Ri(e,t.pointerX,t.pointerY,t.meshUnderPointer,i,s)}static CreateNewFromScene(e,t){return new Ri(null,e.pointerX,e.pointerY,e.meshUnderPointer,t)}static CreateNewFromPrimitive(e,t,i,s){return new Ri(e,t.x,t.y,null,i,s)}}class ue{}ue.NAME_EFFECTLAYER="EffectLayer";ue.NAME_LAYER="Layer";ue.NAME_LENSFLARESYSTEM="LensFlareSystem";ue.NAME_BOUNDINGBOXRENDERER="BoundingBoxRenderer";ue.NAME_PARTICLESYSTEM="ParticleSystem";ue.NAME_GAMEPAD="Gamepad";ue.NAME_SIMPLIFICATIONQUEUE="SimplificationQueue";ue.NAME_GEOMETRYBUFFERRENDERER="GeometryBufferRenderer";ue.NAME_PREPASSRENDERER="PrePassRenderer";ue.NAME_DEPTHRENDERER="DepthRenderer";ue.NAME_DEPTHPEELINGRENDERER="DepthPeelingRenderer";ue.NAME_POSTPROCESSRENDERPIPELINEMANAGER="PostProcessRenderPipelineManager";ue.NAME_SPRITE="Sprite";ue.NAME_SUBSURFACE="SubSurface";ue.NAME_OUTLINERENDERER="Outline";ue.NAME_PROCEDURALTEXTURE="ProceduralTexture";ue.NAME_SHADOWGENERATOR="ShadowGenerator";ue.NAME_OCTREE="Octree";ue.NAME_PHYSICSENGINE="PhysicsEngine";ue.NAME_AUDIO="Audio";ue.STEP_ISREADYFORMESH_EFFECTLAYER=0;ue.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER=0;ue.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER=0;ue.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER=0;ue.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER=1;ue.STEP_BEFORECAMERADRAW_PREPASS=0;ue.STEP_BEFORECAMERADRAW_EFFECTLAYER=1;ue.STEP_BEFORECAMERADRAW_LAYER=2;ue.STEP_BEFORERENDERTARGETDRAW_PREPASS=0;ue.STEP_BEFORERENDERTARGETDRAW_LAYER=1;ue.STEP_BEFORERENDERINGMESH_PREPASS=0;ue.STEP_BEFORERENDERINGMESH_OUTLINE=1;ue.STEP_AFTERRENDERINGMESH_PREPASS=0;ue.STEP_AFTERRENDERINGMESH_OUTLINE=1;ue.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW=0;ue.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER=1;ue.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE=0;ue.STEP_BEFORECAMERAUPDATE_GAMEPAD=1;ue.STEP_BEFORECLEAR_PROCEDURALTEXTURE=0;ue.STEP_BEFORECLEAR_PREPASS=1;ue.STEP_BEFORERENDERTARGETCLEAR_PREPASS=0;ue.STEP_AFTERRENDERTARGETDRAW_PREPASS=0;ue.STEP_AFTERRENDERTARGETDRAW_LAYER=1;ue.STEP_AFTERCAMERADRAW_PREPASS=0;ue.STEP_AFTERCAMERADRAW_EFFECTLAYER=1;ue.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM=2;ue.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW=3;ue.STEP_AFTERCAMERADRAW_LAYER=4;ue.STEP_AFTERCAMERAPOSTPROCESS_LAYER=0;ue.STEP_AFTERRENDERTARGETPOSTPROCESS_LAYER=0;ue.STEP_AFTERRENDER_AUDIO=0;ue.STEP_GATHERRENDERTARGETS_DEPTHRENDERER=0;ue.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER=1;ue.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR=2;ue.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER=3;ue.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER=0;ue.STEP_POINTERMOVE_SPRITE=0;ue.STEP_POINTERDOWN_SPRITE=0;ue.STEP_POINTERUP_SPRITE=0;class ni extends Array{constructor(e){super(...e)}static Create(){return Object.create(ni.prototype)}registerStep(e,t,i){let s=0,r=Number.MAX_VALUE;for(;s<this.length&&(r=this[s].index,!(e<r));s++);this.splice(s,0,{index:e,component:t,action:i.bind(t)})}clear(){this.length=0}}class Ce{}Ce.POINTERDOWN=1;Ce.POINTERUP=2;Ce.POINTERMOVE=4;Ce.POINTERWHEEL=8;Ce.POINTERPICK=16;Ce.POINTERTAP=32;Ce.POINTERDOUBLETAP=64;class v_{constructor(e,t){this.type=e,this.event=t}}class zx extends v_{constructor(e,t,i,s){super(e,t),this.ray=null,this.originalPickingInfo=null,this.skipOnPointerObservable=!1,this.localPosition=new le(i,s)}}class Bn extends v_{constructor(e,t,i){super(e,t),this.pickInfo=i}}class ks{constructor(){this.hoverCursor="",this.actions=new Array,this.isRecursive=!1}static get HasTriggers(){for(const e in ks.Triggers)if(Object.prototype.hasOwnProperty.call(ks.Triggers,e))return!0;return!1}static get HasPickTriggers(){for(const e in ks.Triggers)if(Object.prototype.hasOwnProperty.call(ks.Triggers,e)){const t=parseInt(e);if(t>=1&&t<=7)return!0}return!1}static HasSpecificTrigger(e){for(const t in ks.Triggers)if(Object.prototype.hasOwnProperty.call(ks.Triggers,t)&&parseInt(t)===e)return!0;return!1}}ks.Triggers={};class Zn{}Zn.KEYDOWN=1;Zn.KEYUP=2;class Ju{constructor(e,t){this.type=e,this.event=t}}class df extends Ju{constructor(e,t){super(e,t),this.type=e,this.event=t,this.skipOnKeyboardObservable=!1}get skipOnPointerObservable(){return this.skipOnKeyboardObservable}set skipOnPointerObservable(e){this.skipOnKeyboardObservable=e}}var Me;(function(a){a[a.Generic=0]="Generic",a[a.Keyboard=1]="Keyboard",a[a.Mouse=2]="Mouse",a[a.Touch=3]="Touch",a[a.DualShock=4]="DualShock",a[a.Xbox=5]="Xbox",a[a.Switch=6]="Switch",a[a.DualSense=7]="DualSense"})(Me||(Me={}));var ze;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.LeftClick=2]="LeftClick",a[a.MiddleClick=3]="MiddleClick",a[a.RightClick=4]="RightClick",a[a.BrowserBack=5]="BrowserBack",a[a.BrowserForward=6]="BrowserForward",a[a.MouseWheelX=7]="MouseWheelX",a[a.MouseWheelY=8]="MouseWheelY",a[a.MouseWheelZ=9]="MouseWheelZ",a[a.Move=12]="Move"})(ze||(ze={}));var $h;(function(a){a[a.Horizontal=0]="Horizontal",a[a.Vertical=1]="Vertical",a[a.LeftClick=2]="LeftClick",a[a.MiddleClick=3]="MiddleClick",a[a.RightClick=4]="RightClick",a[a.BrowserBack=5]="BrowserBack",a[a.BrowserForward=6]="BrowserForward",a[a.MouseWheelX=7]="MouseWheelX",a[a.MouseWheelY=8]="MouseWheelY",a[a.MouseWheelZ=9]="MouseWheelZ",a[a.DeltaHorizontal=10]="DeltaHorizontal",a[a.DeltaVertical=11]="DeltaVertical"})($h||($h={}));var ff;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.L2=6]="L2",a[a.R2=7]="R2",a[a.Share=8]="Share",a[a.Options=9]="Options",a[a.L3=10]="L3",a[a.R3=11]="R3",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.TouchPad=17]="TouchPad",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(ff||(ff={}));var pf;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.L2=6]="L2",a[a.R2=7]="R2",a[a.Create=8]="Create",a[a.Options=9]="Options",a[a.L3=10]="L3",a[a.R3=11]="R3",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.TouchPad=17]="TouchPad",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(pf||(pf={}));var _f;(function(a){a[a.A=0]="A",a[a.B=1]="B",a[a.X=2]="X",a[a.Y=3]="Y",a[a.LB=4]="LB",a[a.RB=5]="RB",a[a.LT=6]="LT",a[a.RT=7]="RT",a[a.Back=8]="Back",a[a.Start=9]="Start",a[a.LS=10]="LS",a[a.RS=11]="RS",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.LStickXAxis=17]="LStickXAxis",a[a.LStickYAxis=18]="LStickYAxis",a[a.RStickXAxis=19]="RStickXAxis",a[a.RStickYAxis=20]="RStickYAxis"})(_f||(_f={}));var mf;(function(a){a[a.B=0]="B",a[a.A=1]="A",a[a.Y=2]="Y",a[a.X=3]="X",a[a.L=4]="L",a[a.R=5]="R",a[a.ZL=6]="ZL",a[a.ZR=7]="ZR",a[a.Minus=8]="Minus",a[a.Plus=9]="Plus",a[a.LS=10]="LS",a[a.RS=11]="RS",a[a.DPadUp=12]="DPadUp",a[a.DPadDown=13]="DPadDown",a[a.DPadLeft=14]="DPadLeft",a[a.DPadRight=15]="DPadRight",a[a.Home=16]="Home",a[a.Capture=17]="Capture",a[a.LStickXAxis=18]="LStickXAxis",a[a.LStickYAxis=19]="LStickYAxis",a[a.RStickXAxis=20]="RStickXAxis",a[a.RStickYAxis=21]="RStickYAxis"})(mf||(mf={}));var gf;(function(a){a[a.PointerMove=0]="PointerMove",a[a.PointerDown=1]="PointerDown",a[a.PointerUp=2]="PointerUp"})(gf||(gf={}));class ko{}ko.DOM_DELTA_PIXEL=0;ko.DOM_DELTA_LINE=1;ko.DOM_DELTA_PAGE=2;class ga{static CreateDeviceEvent(e,t,i,s,r,n){switch(e){case Me.Keyboard:return this._CreateKeyboardEvent(i,s,r,n);case Me.Mouse:if(i===ze.MouseWheelX||i===ze.MouseWheelY||i===ze.MouseWheelZ)return this._CreateWheelEvent(e,t,i,s,r,n);case Me.Touch:return this._CreatePointerEvent(e,t,i,s,r,n);default:throw`Unable to generate event for device ${Me[e]}`}}static _CreatePointerEvent(e,t,i,s,r,n){const o=this._CreateMouseEvent(e,t,i,s,r,n);return e===Me.Mouse?(o.deviceType=Me.Mouse,o.pointerId=1,o.pointerType="mouse"):(o.deviceType=Me.Touch,o.pointerId=t,o.pointerType="touch"),i===ze.Move?o.type="pointermove":i>=ze.LeftClick&&i<=ze.RightClick&&(o.type=s===1?"pointerdown":"pointerup",o.button=i-2),o}static _CreateWheelEvent(e,t,i,s,r,n){const o=this._CreateMouseEvent(e,t,i,s,r,n);switch(o.type="wheel",o.deltaMode=ko.DOM_DELTA_PIXEL,o.deltaX=0,o.deltaY=0,o.deltaZ=0,i){case ze.MouseWheelX:o.deltaX=s;break;case ze.MouseWheelY:o.deltaY=s;break;case ze.MouseWheelZ:o.deltaZ=s;break}return o}static _CreateMouseEvent(e,t,i,s,r,n){const o=this._CreateEvent(n),l=r.pollInput(e,t,ze.Horizontal),h=r.pollInput(e,t,ze.Vertical);return n?(o.movementX=0,o.movementY=0,o.offsetX=o.movementX-n.getBoundingClientRect().x,o.offsetY=o.movementY-n.getBoundingClientRect().y):(o.movementX=r.pollInput(e,t,$h.DeltaHorizontal),o.movementY=r.pollInput(e,t,$h.DeltaVertical),o.offsetX=0,o.offsetY=0),this._CheckNonCharacterKeys(o,r),o.clientX=l,o.clientY=h,o.x=l,o.y=h,o.deviceType=e,o.deviceSlot=t,o.inputIndex=i,o}static _CreateKeyboardEvent(e,t,i,s){const r=this._CreateEvent(s);return this._CheckNonCharacterKeys(r,i),r.deviceType=Me.Keyboard,r.deviceSlot=0,r.inputIndex=e,r.type=t===1?"keydown":"keyup",r.key=String.fromCharCode(e),r.keyCode=e,r}static _CheckNonCharacterKeys(e,t){const i=t.isDeviceAvailable(Me.Keyboard),s=i&&t.pollInput(Me.Keyboard,0,18)===1,r=i&&t.pollInput(Me.Keyboard,0,17)===1,n=i&&(t.pollInput(Me.Keyboard,0,91)===1||t.pollInput(Me.Keyboard,0,92)===1||t.pollInput(Me.Keyboard,0,93)===1),o=i&&t.pollInput(Me.Keyboard,0,16)===1;e.altKey=s,e.ctrlKey=r,e.metaKey=n,e.shiftKey=o}static _CreateEvent(e){const t={};return t.preventDefault=()=>{},t.target=e,t}}class Wx{constructor(e,t,i){this._nativeInput=_native.DeviceInputSystem?new _native.DeviceInputSystem(e,t,(s,r,n,o)=>{const l=ga.CreateDeviceEvent(s,r,n,o,this);i(s,r,l)}):this._createDummyNativeInput()}pollInput(e,t,i){return this._nativeInput.pollInput(e,t,i)}isDeviceAvailable(e){return e===Me.Mouse||e===Me.Touch}dispose(){this._nativeInput.dispose()}_createDummyNativeInput(){return{pollInput:()=>0,isDeviceAvailable:()=>!1,dispose:()=>{}}}}const vf=255,xf=Object.keys(ze).length/2;class Hx{constructor(e,t,i,s){this._inputs=[],this._keyboardActive=!1,this._pointerActive=!1,this._usingSafari=q.IsSafari(),this._usingMacOS=/(Mac|iPhone|iPod|iPad)/i.test(navigator.platform),this._keyboardDownEvent=r=>{},this._keyboardUpEvent=r=>{},this._keyboardBlurEvent=r=>{},this._pointerMoveEvent=r=>{},this._pointerDownEvent=r=>{},this._pointerUpEvent=r=>{},this._pointerCancelEvent=r=>{},this._pointerWheelEvent=r=>{},this._pointerBlurEvent=r=>{},this._eventsAttached=!1,this._mouseId=-1,this._isUsingFirefox=Ku.IsNavigatorAvailable()&&navigator.userAgent&&navigator.userAgent.indexOf("Firefox")!==-1,this._maxTouchPoints=0,this._pointerInputClearObserver=null,this._gamepadConnectedEvent=r=>{},this._gamepadDisconnectedEvent=r=>{},this._eventPrefix=q.GetPointerPrefix(e),this._engine=e,this._onDeviceConnected=t,this._onDeviceDisconnected=i,this._onInputChanged=s,this._enableEvents(),this._usingMacOS&&(this._metaKeys=[]),this._engine._onEngineViewChanged||(this._engine._onEngineViewChanged=()=>{this._enableEvents()})}pollInput(e,t,i){const s=this._inputs[e][t];if(!s)throw`Unable to find device ${Me[e]}`;e>=Me.DualShock&&e<=Me.DualSense&&this._updateDevice(e,t,i);const r=s[i];if(r===void 0)throw`Unable to find input ${i} for device ${Me[e]} in slot ${t}`;return i===ze.Move&&q.Warn("Unable to provide information for PointerInput.Move.  Try using PointerInput.Horizontal or PointerInput.Vertical for move data."),r}isDeviceAvailable(e){return this._inputs[e]!==void 0}dispose(){this._onDeviceConnected=()=>{},this._onDeviceDisconnected=()=>{},this._onInputChanged=()=>{},delete this._engine._onEngineViewChanged,this._elementToAttachTo&&this._disableEvents()}_enableEvents(){const e=this===null||this===void 0?void 0:this._engine.getInputElement();if(e&&(!this._eventsAttached||this._elementToAttachTo!==e)){if(this._disableEvents(),this._inputs){for(const t of this._inputs)if(t)for(const i in t){const s=+i,r=t[s];if(r)for(let n=0;n<r.length;n++)r[n]=0}}this._elementToAttachTo=e,this._elementToAttachTo.tabIndex=this._elementToAttachTo.tabIndex!==-1?this._elementToAttachTo.tabIndex:this._engine.canvasTabIndex,this._handleKeyActions(),this._handlePointerActions(),this._handleGamepadActions(),this._eventsAttached=!0,this._checkForConnectedDevices()}}_disableEvents(){this._elementToAttachTo&&(this._elementToAttachTo.removeEventListener("blur",this._keyboardBlurEvent),this._elementToAttachTo.removeEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.removeEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.removeEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.removeEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.removeEventListener(this._wheelEventName,this._pointerWheelEvent),window.removeEventListener("gamepadconnected",this._gamepadConnectedEvent),window.removeEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)),this._pointerInputClearObserver&&this._engine.onEndFrameObservable.remove(this._pointerInputClearObserver),this._eventsAttached=!1}_checkForConnectedDevices(){if(navigator.getGamepads){const e=navigator.getGamepads();for(const t of e)t&&this._addGamePad(t)}typeof matchMedia=="function"&&matchMedia("(pointer:fine)").matches&&this._addPointerDevice(Me.Mouse,0,0,0)}_addGamePad(e){const t=this._getGamepadDeviceType(e.id),i=e.index;this._gamepads=this._gamepads||new Array(e.index+1),this._registerDevice(t,i,e.buttons.length+e.axes.length),this._gamepads[i]=t}_addPointerDevice(e,t,i,s){this._pointerActive||(this._pointerActive=!0),this._registerDevice(e,t,xf);const r=this._inputs[e][t];r[0]=i,r[1]=s}_registerDevice(e,t,i){if(t===void 0)throw`Unable to register device ${Me[e]} to undefined slot.`;if(this._inputs[e]||(this._inputs[e]={}),!this._inputs[e][t]){const s=new Array(i);s.fill(0),this._inputs[e][t]=s,this._onDeviceConnected(e,t)}}_unregisterDevice(e,t){this._inputs[e][t]&&(delete this._inputs[e][t],this._onDeviceDisconnected(e,t))}_handleKeyActions(){this._keyboardDownEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Me.Keyboard,0,vf));const t=this._inputs[Me.Keyboard][0];if(t){t[e.keyCode]=1;const i=e;i.inputIndex=e.keyCode,this._usingMacOS&&e.metaKey&&e.key!=="Meta"&&(this._metaKeys.includes(e.keyCode)||this._metaKeys.push(e.keyCode)),this._onInputChanged(Me.Keyboard,0,i)}},this._keyboardUpEvent=e=>{this._keyboardActive||(this._keyboardActive=!0,this._registerDevice(Me.Keyboard,0,vf));const t=this._inputs[Me.Keyboard][0];if(t){t[e.keyCode]=0;const i=e;if(i.inputIndex=e.keyCode,this._usingMacOS&&e.key==="Meta"&&this._metaKeys.length>0){for(const s of this._metaKeys){const r=ga.CreateDeviceEvent(Me.Keyboard,0,s,0,this,this._elementToAttachTo);t[s]=0,this._onInputChanged(Me.Keyboard,0,r)}this._metaKeys.splice(0,this._metaKeys.length)}this._onInputChanged(Me.Keyboard,0,i)}},this._keyboardBlurEvent=()=>{if(this._keyboardActive){const e=this._inputs[Me.Keyboard][0];for(let t=0;t<e.length;t++)if(e[t]!==0){e[t]=0;const i=ga.CreateDeviceEvent(Me.Keyboard,0,t,0,this,this._elementToAttachTo);this._onInputChanged(Me.Keyboard,0,i)}this._usingMacOS&&this._metaKeys.splice(0,this._metaKeys.length)}},this._elementToAttachTo.addEventListener("keydown",this._keyboardDownEvent),this._elementToAttachTo.addEventListener("keyup",this._keyboardUpEvent),this._elementToAttachTo.addEventListener("blur",this._keyboardBlurEvent)}_handlePointerActions(){this._maxTouchPoints=Ku.IsNavigatorAvailable()&&navigator.maxTouchPoints||2,this._activeTouchIds||(this._activeTouchIds=new Array(this._maxTouchPoints));for(let i=0;i<this._maxTouchPoints;i++)this._activeTouchIds[i]=-1;this._pointerMoveEvent=i=>{const s=this._getPointerType(i),r=s===Me.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);this._inputs[s]||(this._inputs[s]={}),this._inputs[s][r]||this._addPointerDevice(s,r,i.clientX,i.clientY);const n=this._inputs[s][r];if(n){const o=i;o.inputIndex=ze.Move,n[ze.Horizontal]=i.clientX,n[ze.Vertical]=i.clientY,this._onInputChanged(s,r,o),!this._usingSafari&&i.button!==-1&&(o.inputIndex=i.button+2,n[i.button+2]=n[i.button+2]?0:1,this._onInputChanged(s,r,o))}},this._pointerDownEvent=i=>{const s=this._getPointerType(i);let r=s===Me.Mouse?0:i.pointerId;if(s===Me.Touch){const o=this._activeTouchIds.indexOf(-1);if(o>=0)r=o,this._activeTouchIds[o]=i.pointerId;else{q.Warn(`Max number of touches exceeded.  Ignoring touches in excess of ${this._maxTouchPoints}`);return}}this._inputs[s]||(this._inputs[s]={}),this._inputs[s][r]?s===Me.Touch&&this._onDeviceConnected(s,r):this._addPointerDevice(s,r,i.clientX,i.clientY);const n=this._inputs[s][r];if(n){const o=n[ze.Horizontal],l=n[ze.Vertical];if(s===Me.Mouse){if(this._mouseId===-1&&(i.pointerId===void 0?this._mouseId=this._isUsingFirefox?0:1:this._mouseId=i.pointerId),!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(this._mouseId)}catch{}}else if(i.pointerId&&!document.pointerLockElement)try{this._elementToAttachTo.setPointerCapture(i.pointerId)}catch{}n[ze.Horizontal]=i.clientX,n[ze.Vertical]=i.clientY,n[i.button+2]=1;const h=i;h.inputIndex=i.button+2,this._onInputChanged(s,r,h),(o!==i.clientX||l!==i.clientY)&&(h.inputIndex=ze.Move,this._onInputChanged(s,r,h))}},this._pointerUpEvent=i=>{var s,r,n,o,l;const h=this._getPointerType(i),c=h===Me.Mouse?0:this._activeTouchIds.indexOf(i.pointerId);if(h===Me.Touch){if(c===-1)return;this._activeTouchIds[c]=-1}const u=(s=this._inputs[h])===null||s===void 0?void 0:s[c];if(u&&u[i.button+2]!==0){const d=u[ze.Horizontal],f=u[ze.Vertical];u[ze.Horizontal]=i.clientX,u[ze.Vertical]=i.clientY,u[i.button+2]=0;const p=i;(d!==i.clientX||f!==i.clientY)&&(p.inputIndex=ze.Move,this._onInputChanged(h,c,p)),p.inputIndex=i.button+2,h===Me.Mouse&&this._mouseId>=0&&((n=(r=this._elementToAttachTo).hasPointerCapture)===null||n===void 0?void 0:n.call(r,this._mouseId))?this._elementToAttachTo.releasePointerCapture(this._mouseId):i.pointerId&&((l=(o=this._elementToAttachTo).hasPointerCapture)===null||l===void 0?void 0:l.call(o,i.pointerId))&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._onInputChanged(h,c,p),h===Me.Touch&&this._onDeviceDisconnected(h,c)}},this._pointerCancelEvent=i=>{var s,r,n,o;if(i.pointerType==="mouse"){const l=this._inputs[Me.Mouse][0];this._mouseId>=0&&((r=(s=this._elementToAttachTo).hasPointerCapture)===null||r===void 0?void 0:r.call(s,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let h=ze.LeftClick;h<=ze.BrowserForward;h++)if(l[h]===1){l[h]=0;const c=ga.CreateDeviceEvent(Me.Mouse,0,h,0,this,this._elementToAttachTo);this._onInputChanged(Me.Mouse,0,c)}}else{const l=this._activeTouchIds.indexOf(i.pointerId);!((o=(n=this._elementToAttachTo).hasPointerCapture)===null||o===void 0)&&o.call(n,i.pointerId)&&this._elementToAttachTo.releasePointerCapture(i.pointerId),this._inputs[Me.Touch][l][ze.LeftClick]=0;const h=ga.CreateDeviceEvent(Me.Touch,l,ze.LeftClick,0,this,this._elementToAttachTo);this._onInputChanged(Me.Touch,l,h),this._activeTouchIds[l]=-1,this._onDeviceDisconnected(Me.Touch,l)}},this._wheelEventName="onwheel"in document.createElement("div")?"wheel":document.onmousewheel!==void 0?"mousewheel":"DOMMouseScroll";let e=!1;const t=function(){};try{const i=Object.defineProperty({},"passive",{get:function(){e=!0}});this._elementToAttachTo.addEventListener("test",t,i),this._elementToAttachTo.removeEventListener("test",t,i)}catch{}this._pointerBlurEvent=()=>{var i,s,r,n,o;if(this.isDeviceAvailable(Me.Mouse)){const l=this._inputs[Me.Mouse][0];this._mouseId>=0&&((s=(i=this._elementToAttachTo).hasPointerCapture)===null||s===void 0?void 0:s.call(i,this._mouseId))&&this._elementToAttachTo.releasePointerCapture(this._mouseId);for(let h=ze.LeftClick;h<=ze.BrowserForward;h++)if(l[h]===1){l[h]=0;const c=ga.CreateDeviceEvent(Me.Mouse,0,h,0,this,this._elementToAttachTo);this._onInputChanged(Me.Mouse,0,c)}}if(this.isDeviceAvailable(Me.Touch)){const l=this._inputs[Me.Touch];for(let h=0;h<this._activeTouchIds.length;h++){const c=this._activeTouchIds[h];if(!((n=(r=this._elementToAttachTo).hasPointerCapture)===null||n===void 0)&&n.call(r,c)&&this._elementToAttachTo.releasePointerCapture(c),c!==-1&&((o=l[h])===null||o===void 0?void 0:o[ze.LeftClick])===1){l[h][ze.LeftClick]=0;const u=ga.CreateDeviceEvent(Me.Touch,h,ze.LeftClick,0,this,this._elementToAttachTo);this._onInputChanged(Me.Touch,h,u),this._activeTouchIds[h]=-1,this._onDeviceDisconnected(Me.Touch,h)}}}},this._pointerWheelEvent=i=>{const s=Me.Mouse,r=0;this._inputs[s]||(this._inputs[s]=[]),this._inputs[s][r]||(this._pointerActive=!0,this._registerDevice(s,r,xf));const n=this._inputs[s][r];if(n){n[ze.MouseWheelX]=i.deltaX||0,n[ze.MouseWheelY]=i.deltaY||i.wheelDelta||0,n[ze.MouseWheelZ]=i.deltaZ||0;const o=i;n[ze.MouseWheelX]!==0&&(o.inputIndex=ze.MouseWheelX,this._onInputChanged(s,r,o)),n[ze.MouseWheelY]!==0&&(o.inputIndex=ze.MouseWheelY,this._onInputChanged(s,r,o)),n[ze.MouseWheelZ]!==0&&(o.inputIndex=ze.MouseWheelZ,this._onInputChanged(s,r,o))}},this._elementToAttachTo.addEventListener(this._eventPrefix+"move",this._pointerMoveEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"down",this._pointerDownEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"up",this._pointerUpEvent),this._elementToAttachTo.addEventListener(this._eventPrefix+"cancel",this._pointerCancelEvent),this._elementToAttachTo.addEventListener("blur",this._pointerBlurEvent),this._elementToAttachTo.addEventListener(this._wheelEventName,this._pointerWheelEvent,e?{passive:!1}:!1),this._pointerInputClearObserver=this._engine.onEndFrameObservable.add(()=>{if(this.isDeviceAvailable(Me.Mouse)){const i=this._inputs[Me.Mouse][0];i[ze.MouseWheelX]=0,i[ze.MouseWheelY]=0,i[ze.MouseWheelZ]=0}})}_handleGamepadActions(){this._gamepadConnectedEvent=e=>{this._addGamePad(e.gamepad)},this._gamepadDisconnectedEvent=e=>{if(this._gamepads){const t=this._getGamepadDeviceType(e.gamepad.id),i=e.gamepad.index;this._unregisterDevice(t,i),delete this._gamepads[i]}},window.addEventListener("gamepadconnected",this._gamepadConnectedEvent),window.addEventListener("gamepaddisconnected",this._gamepadDisconnectedEvent)}_updateDevice(e,t,i){const s=navigator.getGamepads()[t];if(s&&e===this._gamepads[t]){const r=this._inputs[e][t];i>=s.buttons.length?r[i]=s.axes[i-s.buttons.length].valueOf():r[i]=s.buttons[i].value}}_getGamepadDeviceType(e){return e.indexOf("054c")!==-1?e.indexOf("0ce6")!==-1?Me.DualSense:Me.DualShock:e.indexOf("Xbox One")!==-1||e.search("Xbox 360")!==-1||e.search("xinput")!==-1?Me.Xbox:e.indexOf("057e")!==-1?Me.Switch:Me.Generic}_getPointerType(e){let t=Me.Mouse;return(e.pointerType==="touch"||e.pointerType==="pen"||e.touches)&&(t=Me.Touch),t}}class Tf{constructor(e,t,i=0){this.deviceType=t,this.deviceSlot=i,this.onInputChangedObservable=new X,this._deviceInputSystem=e}getInput(e){return this._deviceInputSystem.pollInput(this.deviceType,this.deviceSlot,e)}}class Xx{constructor(e){this._registeredManagers=new Array,this._refCount=0,this.registerManager=n=>{for(let o=0;o<this._devices.length;o++){const l=this._devices[o];for(const h in l){const c=+h;n._addDevice(new Tf(this._deviceInputSystem,o,c))}}this._registeredManagers.push(n)},this.unregisterManager=n=>{const o=this._registeredManagers.indexOf(n);o>-1&&this._registeredManagers.splice(o,1)};const t=Object.keys(Me).length/2;this._devices=new Array(t);const i=(n,o)=>{this._devices[n]||(this._devices[n]=new Array),this._devices[n][o]||(this._devices[n][o]=o);for(const l of this._registeredManagers){const h=new Tf(this._deviceInputSystem,n,o);l._addDevice(h)}},s=(n,o)=>{var l;!((l=this._devices[n])===null||l===void 0)&&l[o]&&delete this._devices[n][o];for(const h of this._registeredManagers)h._removeDevice(n,o)},r=(n,o,l)=>{if(l)for(const h of this._registeredManagers)h._onInputChanged(n,o,l)};typeof _native<"u"?this._deviceInputSystem=new Wx(i,s,r):this._deviceInputSystem=new Hx(e,i,s,r)}dispose(){this._deviceInputSystem.dispose()}}class Yx{constructor(e){const t=Object.keys(Me).length/2;this._devices=new Array(t),this._firstDevice=new Array(t),this._engine=e,this._engine._deviceSourceManager||(this._engine._deviceSourceManager=new Xx(e)),this._engine._deviceSourceManager._refCount++,this.onDeviceConnectedObservable=new X(i=>{for(const s of this._devices)if(s)for(const r of s)r&&this.onDeviceConnectedObservable.notifyObserver(i,r)}),this.onDeviceDisconnectedObservable=new X,this._engine._deviceSourceManager.registerManager(this),this._onDisposeObserver=e.onDisposeObservable.add(()=>{this.dispose()})}getDeviceSource(e,t){if(t===void 0){if(this._firstDevice[e]===void 0)return null;t=this._firstDevice[e]}return!this._devices[e]||this._devices[e][t]===void 0?null:this._devices[e][t]}getDeviceSources(e){return this._devices[e]?this._devices[e].filter(t=>!!t):[]}dispose(){this.onDeviceConnectedObservable.clear(),this.onDeviceDisconnectedObservable.clear(),this._engine._deviceSourceManager&&(this._engine._deviceSourceManager.unregisterManager(this),--this._engine._deviceSourceManager._refCount<1&&(this._engine._deviceSourceManager.dispose(),delete this._engine._deviceSourceManager)),this._engine.onDisposeObservable.remove(this._onDisposeObserver)}_addDevice(e){this._devices[e.deviceType]||(this._devices[e.deviceType]=new Array),this._devices[e.deviceType][e.deviceSlot]||(this._devices[e.deviceType][e.deviceSlot]=e,this._updateFirstDevices(e.deviceType)),this.onDeviceConnectedObservable.notifyObservers(e)}_removeDevice(e,t){var i,s;const r=(i=this._devices[e])===null||i===void 0?void 0:i[t];this.onDeviceDisconnectedObservable.notifyObservers(r),!((s=this._devices[e])===null||s===void 0)&&s[t]&&delete this._devices[e][t],this._updateFirstDevices(e)}_onInputChanged(e,t,i){var s,r;(r=(s=this._devices[e])===null||s===void 0?void 0:s[t])===null||r===void 0||r.onInputChangedObservable.notifyObservers(i)}_updateFirstDevices(e){switch(e){case Me.Keyboard:case Me.Mouse:this._firstDevice[e]=0;break;case Me.Touch:case Me.DualSense:case Me.DualShock:case Me.Xbox:case Me.Switch:case Me.Generic:{delete this._firstDevice[e];const t=this._devices[e];if(t){for(let i=0;i<t.length;i++)if(t[i]){this._firstDevice[e]=i;break}}break}}}}class bf{constructor(){this._singleClick=!1,this._doubleClick=!1,this._hasSwiped=!1,this._ignore=!1}get singleClick(){return this._singleClick}get doubleClick(){return this._doubleClick}get hasSwiped(){return this._hasSwiped}get ignore(){return this._ignore}set singleClick(e){this._singleClick=e}set doubleClick(e){this._doubleClick=e}set hasSwiped(e){this._hasSwiped=e}set ignore(e){this._ignore=e}}class ui{constructor(e){this._alreadyAttached=!1,this._meshPickProceed=!1,this._currentPickResult=null,this._previousPickResult=null,this._totalPointersPressed=0,this._doubleClickOccured=!1,this._pointerX=0,this._pointerY=0,this._startingPointerPosition=new le(0,0),this._previousStartingPointerPosition=new le(0,0),this._startingPointerTime=0,this._previousStartingPointerTime=0,this._pointerCaptures={},this._meshUnderPointerId={},this._deviceSourceManager=null,this._scene=e||ye.LastCreatedScene,this._scene}get meshUnderPointer(){return this._pointerOverMesh}getMeshUnderPointerByPointerId(e){return this._meshUnderPointerId[e]||null}get unTranslatedPointer(){return new le(this._unTranslatedPointerX,this._unTranslatedPointerY)}get pointerX(){return this._pointerX}set pointerX(e){this._pointerX=e}get pointerY(){return this._pointerY}set pointerY(e){this._pointerY=e}_updatePointerPosition(e){const t=this._scene.getEngine().getInputElementClientRect();!t||(this._pointerX=e.clientX-t.left,this._pointerY=e.clientY-t.top,this._unTranslatedPointerX=this._pointerX,this._unTranslatedPointerY=this._pointerY)}_processPointerMove(e,t){const i=this._scene,s=i.getEngine(),r=s.getInputElement();r&&(r.tabIndex=s.canvasTabIndex,i.doNotHandleCursors||(r.style.cursor=i.defaultCursor));const n=!!(e&&e.hit&&e.pickedMesh);if(n){if(i.setPointerOverMesh(e.pickedMesh,t.pointerId,e),!i.doNotHandleCursors&&r&&this._pointerOverMesh){const o=this._pointerOverMesh._getActionManagerForTrigger();o&&o.hasPointerTriggers&&(r.style.cursor=o.hoverCursor||i.hoverCursor)}}else i.setPointerOverMesh(null,t.pointerId,e);for(const o of i._pointerMoveStage)e=o.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,n,r);if(e){const o=t.inputIndex>=ze.MouseWheelX&&t.inputIndex<=ze.MouseWheelZ?Ce.POINTERWHEEL:Ce.POINTERMOVE;if(i.onPointerMove&&i.onPointerMove(t,e,o),i.onPointerObservable.hasObservers()){const l=new Bn(o,t,e);this._setRayOnPointerInfo(l),i.onPointerObservable.notifyObservers(l,o)}}}_setRayOnPointerInfo(e){const t=this._scene;e.pickInfo&&!e.pickInfo._pickingUnavailable&&(e.pickInfo.ray||(e.pickInfo.ray=t.createPickingRay(e.event.offsetX,e.event.offsetY,L.Identity(),t.activeCamera)))}_checkPrePointerObservable(e,t,i){const s=this._scene,r=new zx(i,t,this._unTranslatedPointerX,this._unTranslatedPointerY);return e&&(r.originalPickingInfo=e,r.ray=e.ray,e.originMesh&&(r.nearInteractionPickingInfo=e)),s.onPrePointerObservable.notifyObservers(r,i),!!r.skipOnPointerObservable}simulatePointerMove(e,t){const i=new PointerEvent("pointermove",t);i.inputIndex=ze.Move,!this._checkPrePointerObservable(e,i,Ce.POINTERMOVE)&&this._processPointerMove(e,i)}simulatePointerDown(e,t){const i=new PointerEvent("pointerdown",t);i.inputIndex=i.button+2,!this._checkPrePointerObservable(e,i,Ce.POINTERDOWN)&&this._processPointerDown(e,i)}_processPointerDown(e,t){const i=this._scene;if(e&&e.hit&&e.pickedMesh){this._pickedDownMesh=e.pickedMesh;const s=e.pickedMesh._getActionManagerForTrigger();if(s){if(s.hasPickTriggers)switch(s.processTrigger(5,Ri.CreateNew(e.pickedMesh,t)),t.button){case 0:s.processTrigger(2,Ri.CreateNew(e.pickedMesh,t));break;case 1:s.processTrigger(4,Ri.CreateNew(e.pickedMesh,t));break;case 2:s.processTrigger(3,Ri.CreateNew(e.pickedMesh,t));break}s.hasSpecificTrigger(8)&&window.setTimeout(()=>{const r=i.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,n=>n.isPickable&&n.isVisible&&n.isReady()&&n.actionManager&&n.actionManager.hasSpecificTrigger(8)&&n===this._pickedDownMesh,!1,i.cameraToUseForPointers);r&&r.hit&&r.pickedMesh&&s&&this._totalPointersPressed!==0&&Date.now()-this._startingPointerTime>ui.LongPressDelay&&!this._isPointerSwiping()&&(this._startingPointerTime=0,s.processTrigger(8,Ri.CreateNew(r.pickedMesh,t)))},ui.LongPressDelay)}}else for(const s of i._pointerDownStage)e=s.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,!1);if(e){const s=Ce.POINTERDOWN;if(i.onPointerDown&&i.onPointerDown(t,e,s),i.onPointerObservable.hasObservers()){const r=new Bn(s,t,e);this._setRayOnPointerInfo(r),i.onPointerObservable.notifyObservers(r,s)}}}_isPointerSwiping(){return Math.abs(this._startingPointerPosition.x-this._pointerX)>ui.DragMovementThreshold||Math.abs(this._startingPointerPosition.y-this._pointerY)>ui.DragMovementThreshold}simulatePointerUp(e,t,i){const s=new PointerEvent("pointerup",t);s.inputIndex=ze.Move;const r=new bf;i?r.doubleClick=!0:r.singleClick=!0,!this._checkPrePointerObservable(e,s,Ce.POINTERUP)&&this._processPointerUp(e,s,r)}_processPointerUp(e,t,i){const s=this._scene;if(e&&e.hit&&e.pickedMesh){if(this._pickedUpMesh=e.pickedMesh,this._pickedDownMesh===this._pickedUpMesh&&(s.onPointerPick&&s.onPointerPick(t,e),i.singleClick&&!i.ignore&&s.onPointerObservable.hasObservers())){const o=Ce.POINTERPICK,l=new Bn(o,t,e);this._setRayOnPointerInfo(l),s.onPointerObservable.notifyObservers(l,o)}const n=e.pickedMesh._getActionManagerForTrigger();if(n&&!i.ignore){n.processTrigger(7,Ri.CreateNew(e.pickedMesh,t,e)),!i.hasSwiped&&i.singleClick&&n.processTrigger(1,Ri.CreateNew(e.pickedMesh,t,e));const o=e.pickedMesh._getActionManagerForTrigger(6);i.doubleClick&&o&&o.processTrigger(6,Ri.CreateNew(e.pickedMesh,t,e))}}else if(!i.ignore)for(const n of s._pointerUpStage)e=n.action(this._unTranslatedPointerX,this._unTranslatedPointerY,e,t,i.doubleClick);if(this._pickedDownMesh&&this._pickedDownMesh!==this._pickedUpMesh){const n=this._pickedDownMesh._getActionManagerForTrigger(16);n&&n.processTrigger(16,Ri.CreateNew(this._pickedDownMesh,t))}let r=0;if(s.onPointerObservable.hasObservers()){if(!i.ignore&&!i.hasSwiped&&(i.singleClick&&s.onPointerObservable.hasSpecificMask(Ce.POINTERTAP)?r=Ce.POINTERTAP:i.doubleClick&&s.onPointerObservable.hasSpecificMask(Ce.POINTERDOUBLETAP)&&(r=Ce.POINTERDOUBLETAP),r)){const n=new Bn(r,t,e);this._setRayOnPointerInfo(n),s.onPointerObservable.notifyObservers(n,r)}if(!i.ignore){r=Ce.POINTERUP;const n=new Bn(r,t,e);this._setRayOnPointerInfo(n),s.onPointerObservable.notifyObservers(n,r)}}s.onPointerUp&&!i.ignore&&s.onPointerUp(t,e,r)}isPointerCaptured(e=0){return this._pointerCaptures[e]}attachControl(e=!0,t=!0,i=!0,s=null){const r=this._scene,n=r.getEngine();s||(s=n.getInputElement()),this._alreadyAttached&&this.detachControl(),s&&(this._alreadyAttachedTo=s),this._deviceSourceManager=new Yx(n),this._initActionManager=o=>{if(!this._meshPickProceed){const l=r.skipPointerUpPicking?null:r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerUpPredicate,!1,r.cameraToUseForPointers);this._currentPickResult=l,l&&(o=l.hit&&l.pickedMesh?l.pickedMesh._getActionManagerForTrigger():null),this._meshPickProceed=!0}return o},this._delayedSimpleClick=(o,l,h)=>{(Date.now()-this._previousStartingPointerTime>ui.DoubleClickDelay&&!this._doubleClickOccured||o!==this._previousButtonPressed)&&(this._doubleClickOccured=!1,l.singleClick=!0,l.ignore=!1,h(l,this._currentPickResult))},this._initClickEvent=(o,l,h,c)=>{const u=new bf;this._currentPickResult=null;let d=null,f=o.hasSpecificMask(Ce.POINTERPICK)||l.hasSpecificMask(Ce.POINTERPICK)||o.hasSpecificMask(Ce.POINTERTAP)||l.hasSpecificMask(Ce.POINTERTAP)||o.hasSpecificMask(Ce.POINTERDOUBLETAP)||l.hasSpecificMask(Ce.POINTERDOUBLETAP);!f&&ks&&(d=this._initActionManager(d,u),d&&(f=d.hasPickTriggers));let p=!1;if(f){const _=h.button;if(u.hasSwiped=this._isPointerSwiping(),!u.hasSwiped){let m=!ui.ExclusiveDoubleClickMode;m||(m=!o.hasSpecificMask(Ce.POINTERDOUBLETAP)&&!l.hasSpecificMask(Ce.POINTERDOUBLETAP),m&&!ks.HasSpecificTrigger(6)&&(d=this._initActionManager(d,u),d&&(m=!d.hasSpecificTrigger(6)))),m?(Date.now()-this._previousStartingPointerTime>ui.DoubleClickDelay||_!==this._previousButtonPressed)&&(u.singleClick=!0,c(u,this._currentPickResult),p=!0):(this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,this._delayedSimpleClickTimeout=window.setTimeout(this._delayedSimpleClick.bind(this,_,u,c),ui.DoubleClickDelay));let v=o.hasSpecificMask(Ce.POINTERDOUBLETAP)||l.hasSpecificMask(Ce.POINTERDOUBLETAP);!v&&ks.HasSpecificTrigger(6)&&(d=this._initActionManager(d,u),d&&(v=d.hasSpecificTrigger(6))),v&&(_===this._previousButtonPressed&&Date.now()-this._previousStartingPointerTime<ui.DoubleClickDelay&&!this._doubleClickOccured?(!u.hasSwiped&&!this._isPointerSwiping()?(this._previousStartingPointerTime=0,this._doubleClickOccured=!0,u.doubleClick=!0,u.ignore=!1,ui.ExclusiveDoubleClickMode&&this._previousDelayedSimpleClickTimeout&&clearTimeout(this._previousDelayedSimpleClickTimeout),this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,c(u,this._currentPickResult)):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=_,ui.ExclusiveDoubleClickMode?(this._previousDelayedSimpleClickTimeout&&clearTimeout(this._previousDelayedSimpleClickTimeout),this._previousDelayedSimpleClickTimeout=this._delayedSimpleClickTimeout,c(u,this._previousPickResult)):c(u,this._currentPickResult)),p=!0):(this._doubleClickOccured=!1,this._previousStartingPointerTime=this._startingPointerTime,this._previousStartingPointerPosition.x=this._startingPointerPosition.x,this._previousStartingPointerPosition.y=this._startingPointerPosition.y,this._previousButtonPressed=_))}}p||c(u,this._currentPickResult)},this._onPointerMove=o=>{if(o.pointerId===void 0&&(o.pointerId=0),this._updatePointerPosition(o),this._checkPrePointerObservable(null,o,o.inputIndex>=ze.MouseWheelX&&o.inputIndex<=ze.MouseWheelZ?Ce.POINTERWHEEL:Ce.POINTERMOVE)||!r.cameraToUseForPointers&&!r.activeCamera)return;if(r.skipPointerMovePicking){this._processPointerMove(new ki,o);return}r.pointerMovePredicate||(r.pointerMovePredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(h.enablePointerMoveEvents||r.constantlyUpdateMeshUnderPointer||h._getActionManagerForTrigger()!==null)&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&h.layerMask)!==0));const l=r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerMovePredicate,!1,r.cameraToUseForPointers,r.pointerMoveTrianglePredicate);this._processPointerMove(l,o)},this._onPointerDown=o=>{if(this._totalPointersPressed++,this._pickedDownMesh=null,this._meshPickProceed=!1,o.pointerId===void 0&&(o.pointerId=0),this._updatePointerPosition(o),r.preventDefaultOnPointerDown&&s&&(o.preventDefault(),s.focus()),this._startingPointerPosition.x=this._pointerX,this._startingPointerPosition.y=this._pointerY,this._startingPointerTime=Date.now(),this._checkPrePointerObservable(null,o,Ce.POINTERDOWN)||!r.cameraToUseForPointers&&!r.activeCamera)return;this._pointerCaptures[o.pointerId]=!0,r.pointerDownPredicate||(r.pointerDownPredicate=h=>h.isPickable&&h.isVisible&&h.isReady()&&h.isEnabled()&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&h.layerMask)!==0)),this._pickedDownMesh=null;let l;r.skipPointerDownPicking?l=new ki:l=r.pick(this._unTranslatedPointerX,this._unTranslatedPointerY,r.pointerDownPredicate,!1,r.cameraToUseForPointers),this._processPointerDown(l,o)},this._onPointerUp=o=>{this._totalPointersPressed!==0&&(this._totalPointersPressed--,this._pickedUpMesh=null,this._meshPickProceed=!1,o.pointerId===void 0&&(o.pointerId=0),this._updatePointerPosition(o),r.preventDefaultOnPointerUp&&s&&(o.preventDefault(),s.focus()),this._initClickEvent(r.onPrePointerObservable,r.onPointerObservable,o,(l,h)=>{r.onPrePointerObservable.hasObservers()&&!l.ignore&&(!l.hasSwiped&&(l.singleClick&&r.onPrePointerObservable.hasSpecificMask(Ce.POINTERTAP)&&this._checkPrePointerObservable(null,o,Ce.POINTERTAP)||l.doubleClick&&r.onPrePointerObservable.hasSpecificMask(Ce.POINTERDOUBLETAP)&&this._checkPrePointerObservable(null,o,Ce.POINTERDOUBLETAP))||this._checkPrePointerObservable(null,o,Ce.POINTERUP))||(this._pointerCaptures[o.pointerId]=!1,!(!r.cameraToUseForPointers&&!r.activeCamera)&&(r.pointerUpPredicate||(r.pointerUpPredicate=c=>c.isPickable&&c.isVisible&&c.isReady()&&c.isEnabled()&&(!r.cameraToUseForPointers||(r.cameraToUseForPointers.layerMask&c.layerMask)!==0)),!this._meshPickProceed&&(ks&&ks.HasTriggers||r.onPointerObservable.hasObservers())&&this._initActionManager(null,l),h||(h=this._currentPickResult),this._processPointerUp(h,o,l),this._previousPickResult=this._currentPickResult))}))},this._onKeyDown=o=>{const l=Zn.KEYDOWN;if(r.onPreKeyboardObservable.hasObservers()){const h=new df(l,o);if(r.onPreKeyboardObservable.notifyObservers(h,l),h.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const h=new Ju(l,o);r.onKeyboardObservable.notifyObservers(h,l)}r.actionManager&&r.actionManager.processTrigger(14,Ri.CreateNewFromScene(r,o))},this._onKeyUp=o=>{const l=Zn.KEYUP;if(r.onPreKeyboardObservable.hasObservers()){const h=new df(l,o);if(r.onPreKeyboardObservable.notifyObservers(h,l),h.skipOnKeyboardObservable)return}if(r.onKeyboardObservable.hasObservers()){const h=new Ju(l,o);r.onKeyboardObservable.notifyObservers(h,l)}r.actionManager&&r.actionManager.processTrigger(15,Ri.CreateNewFromScene(r,o))},this._deviceSourceManager.onDeviceConnectedObservable.add(o=>{o.deviceType===Me.Mouse?o.onInputChangedObservable.add(l=>{l.inputIndex===ze.LeftClick||l.inputIndex===ze.MiddleClick||l.inputIndex===ze.RightClick||l.inputIndex===ze.BrowserBack||l.inputIndex===ze.BrowserForward?t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l):i&&(l.inputIndex===ze.Move?this._onPointerMove(l):(l.inputIndex===ze.MouseWheelX||l.inputIndex===ze.MouseWheelY||l.inputIndex===ze.MouseWheelZ)&&this._onPointerMove(l))}):o.deviceType===Me.Touch?o.onInputChangedObservable.add(l=>{l.inputIndex===ze.LeftClick&&(t&&o.getInput(l.inputIndex)===1?this._onPointerDown(l):e&&o.getInput(l.inputIndex)===0&&this._onPointerUp(l)),i&&l.inputIndex===ze.Move&&this._onPointerMove(l)}):o.deviceType===Me.Keyboard&&o.onInputChangedObservable.add(l=>{l.type==="keydown"?this._onKeyDown(l):l.type==="keyup"&&this._onKeyUp(l)})}),this._alreadyAttached=!0}detachControl(){this._alreadyAttached&&(this._deviceSourceManager.dispose(),this._deviceSourceManager=null,this._alreadyAttachedTo&&!this._scene.doNotHandleCursors&&(this._alreadyAttachedTo.style.cursor=this._scene.defaultCursor),this._alreadyAttached=!1,this._alreadyAttachedTo=null)}setPointerOverMesh(e,t=0,i){if(this._meshUnderPointerId[t]===e&&(!e||!e._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting))return;const s=this._meshUnderPointerId[t];let r;s&&(r=s._getActionManagerForTrigger(10),r&&r.processTrigger(10,Ri.CreateNew(s,void 0,{pointerId:t}))),e?(this._meshUnderPointerId[t]=e,this._pointerOverMesh=e,r=e._getActionManagerForTrigger(9),r&&r.processTrigger(9,Ri.CreateNew(e,void 0,{pointerId:t,pickResult:i}))):(delete this._meshUnderPointerId[t],this._pointerOverMesh=null)}getPointerOverMesh(){return this._pointerOverMesh}_invalidateMesh(e){this._pointerOverMesh===e&&(this._pointerOverMesh=null),this._pickedDownMesh===e&&(this._pickedDownMesh=null),this._pickedUpMesh===e&&(this._pickedUpMesh=null);for(const t in this._meshUnderPointerId)this._meshUnderPointerId[t]===e&&delete this._meshUnderPointerId[t]}}ui.DragMovementThreshold=10;ui.LongPressDelay=500;ui.DoubleClickDelay=300;ui.ExclusiveDoubleClickMode=!1;class xc{static get UniqueId(){const e=this._UniqueIdCounter;return this._UniqueIdCounter++,e}}xc._UniqueIdCounter=1;class Tt{static CompareLightsPriority(e,t){return e.shadowEnabled!==t.shadowEnabled?(t.shadowEnabled?1:0)-(e.shadowEnabled?1:0):t.renderPriority-e.renderPriority}}Tt.FALLOFF_DEFAULT=0;Tt.FALLOFF_PHYSICAL=1;Tt.FALLOFF_GLTF=2;Tt.FALLOFF_STANDARD=3;Tt.LIGHTMAP_DEFAULT=0;Tt.LIGHTMAP_SPECULAR=1;Tt.LIGHTMAP_SHADOWSONLY=2;Tt.INTENSITYMODE_AUTOMATIC=0;Tt.INTENSITYMODE_LUMINOUSPOWER=1;Tt.INTENSITYMODE_LUMINOUSINTENSITY=2;Tt.INTENSITYMODE_ILLUMINANCE=3;Tt.INTENSITYMODE_LUMINANCE=4;Tt.LIGHTTYPEID_POINTLIGHT=0;Tt.LIGHTTYPEID_DIRECTIONALLIGHT=1;Tt.LIGHTTYPEID_SPOTLIGHT=2;Tt.LIGHTTYPEID_HEMISPHERICLIGHT=3;class jh{constructor(e,t){jh.IsAvailable&&(this._observer=new window.ComputePressureObserver(e,t))}static get IsAvailable(){var e,t;return Ht()&&"ComputePressureObserver"in window&&((t=(e=window.ComputePressureObserver)===null||e===void 0?void 0:e.supportedSources)===null||t===void 0?void 0:t.includes("cpu"))}observe(e){var t,i;!((t=this._observer)===null||t===void 0)&&t.observe&&((i=this._observer)===null||i===void 0||i.observe(e).catch(()=>{}))}unobserve(e){var t,i;try{!((t=this._observer)===null||t===void 0)&&t.unobserve&&((i=this._observer)===null||i===void 0||i.unobserve(e))}catch{}}}var Qs;(function(a){a[a.BackwardCompatible=0]="BackwardCompatible",a[a.Intermediate=1]="Intermediate",a[a.Aggressive=2]="Aggressive"})(Qs||(Qs={}));class ge extends li{constructor(e,t){super(),this._inputManager=new ui(this),this.cameraToUseForPointers=null,this._isScene=!0,this._blockEntityCollection=!1,this.autoClear=!0,this.autoClearDepthAndStencil=!0,this.clearColor=new J(.2,.2,.3,1),this.ambientColor=new re(0,0,0),this.environmentIntensity=1,this._performancePriority=Qs.BackwardCompatible,this._forceWireframe=!1,this._skipFrustumClipping=!1,this._forcePointsCloud=!1,this.animationsEnabled=!0,this._animationPropertiesOverride=null,this.useConstantAnimationDeltaTime=!1,this.constantlyUpdateMeshUnderPointer=!1,this.hoverCursor="pointer",this.defaultCursor="",this.doNotHandleCursors=!1,this.preventDefaultOnPointerDown=!0,this.preventDefaultOnPointerUp=!0,this.metadata=null,this.reservedDataStore=null,this.disableOfflineSupportExceptionRules=new Array,this.onDisposeObservable=new X,this._onDisposeObserver=null,this.onBeforeRenderObservable=new X,this._onBeforeRenderObserver=null,this.onAfterRenderObservable=new X,this.onAfterRenderCameraObservable=new X,this._onAfterRenderObserver=null,this.onBeforeAnimationsObservable=new X,this.onAfterAnimationsObservable=new X,this.onBeforeDrawPhaseObservable=new X,this.onAfterDrawPhaseObservable=new X,this.onReadyObservable=new X,this.onBeforeCameraRenderObservable=new X,this._onBeforeCameraRenderObserver=null,this.onAfterCameraRenderObservable=new X,this._onAfterCameraRenderObserver=null,this.onBeforeActiveMeshesEvaluationObservable=new X,this.onAfterActiveMeshesEvaluationObservable=new X,this.onBeforeParticlesRenderingObservable=new X,this.onAfterParticlesRenderingObservable=new X,this.onDataLoadedObservable=new X,this.onNewCameraAddedObservable=new X,this.onCameraRemovedObservable=new X,this.onNewLightAddedObservable=new X,this.onLightRemovedObservable=new X,this.onNewGeometryAddedObservable=new X,this.onGeometryRemovedObservable=new X,this.onNewTransformNodeAddedObservable=new X,this.onTransformNodeRemovedObservable=new X,this.onNewMeshAddedObservable=new X,this.onMeshRemovedObservable=new X,this.onNewSkeletonAddedObservable=new X,this.onSkeletonRemovedObservable=new X,this.onNewMaterialAddedObservable=new X,this.onNewMultiMaterialAddedObservable=new X,this.onMaterialRemovedObservable=new X,this.onMultiMaterialRemovedObservable=new X,this.onNewTextureAddedObservable=new X,this.onTextureRemovedObservable=new X,this.onBeforeRenderTargetsRenderObservable=new X,this.onAfterRenderTargetsRenderObservable=new X,this.onBeforeStepObservable=new X,this.onAfterStepObservable=new X,this.onActiveCameraChanged=new X,this.onActiveCamerasChanged=new X,this.onBeforeRenderingGroupObservable=new X,this.onAfterRenderingGroupObservable=new X,this.onMeshImportedObservable=new X,this.onAnimationFileImportedObservable=new X,this._registeredForLateAnimationBindings=new wn(256),this.skipPointerMovePicking=!1,this.skipPointerDownPicking=!1,this.skipPointerUpPicking=!1,this.onPrePointerObservable=new X,this.onPointerObservable=new X,this.onPreKeyboardObservable=new X,this.onKeyboardObservable=new X,this._useRightHandedSystem=!1,this._timeAccumulator=0,this._currentStepId=0,this._currentInternalStep=0,this._fogEnabled=!0,this._fogMode=ge.FOGMODE_NONE,this.fogColor=new re(.2,.2,.3),this.fogDensity=.1,this.fogStart=0,this.fogEnd=1e3,this.needsPreviousWorldMatrices=!1,this._shadowsEnabled=!0,this._lightsEnabled=!0,this._unObserveActiveCameras=null,this._texturesEnabled=!0,this.physicsEnabled=!0,this.particlesEnabled=!0,this.spritesEnabled=!0,this._skeletonsEnabled=!0,this.lensFlaresEnabled=!0,this.collisionsEnabled=!0,this.gravity=new g(0,-9.807,0),this.postProcessesEnabled=!0,this.renderTargetsEnabled=!0,this.dumpNextRenderTargets=!1,this.customRenderTargets=new Array,this.importedMeshesFiles=new Array,this.probesEnabled=!0,this._meshesForIntersections=new wn(256),this.proceduralTexturesEnabled=!0,this._totalVertices=new _r,this._activeIndices=new _r,this._activeParticles=new _r,this._activeBones=new _r,this._animationTime=0,this.animationTimeScale=1,this._renderId=0,this._frameId=0,this._executeWhenReadyTimeoutId=null,this._intermediateRendering=!1,this._defaultFrameBufferCleared=!1,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1,this._toBeDisposed=new Array(256),this._activeRequests=new Array,this._pendingData=new Array,this._isDisposed=!1,this.dispatchAllSubMeshesOfActiveMeshes=!1,this._activeMeshes=new mi(256),this._processedMaterials=new mi(256),this._renderTargets=new wn(256),this._materialsRenderTargets=new wn(256),this._activeParticleSystems=new mi(256),this._activeSkeletons=new wn(32),this._softwareSkinnedMeshes=new wn(32),this._activeAnimatables=new Array,this._transformMatrix=L.Zero(),this.requireLightSorting=!1,this._components=[],this._serializableComponents=[],this._transientComponents=[],this._beforeCameraUpdateStage=ni.Create(),this._beforeClearStage=ni.Create(),this._beforeRenderTargetClearStage=ni.Create(),this._gatherRenderTargetsStage=ni.Create(),this._gatherActiveCameraRenderTargetsStage=ni.Create(),this._isReadyForMeshStage=ni.Create(),this._beforeEvaluateActiveMeshStage=ni.Create(),this._evaluateSubMeshStage=ni.Create(),this._preActiveMeshStage=ni.Create(),this._cameraDrawRenderTargetStage=ni.Create(),this._beforeCameraDrawStage=ni.Create(),this._beforeRenderTargetDrawStage=ni.Create(),this._beforeRenderingGroupDrawStage=ni.Create(),this._beforeRenderingMeshStage=ni.Create(),this._afterRenderingMeshStage=ni.Create(),this._afterRenderingGroupDrawStage=ni.Create(),this._afterCameraDrawStage=ni.Create(),this._afterCameraPostProcessStage=ni.Create(),this._afterRenderTargetDrawStage=ni.Create(),this._afterRenderTargetPostProcessStage=ni.Create(),this._afterRenderStage=ni.Create(),this._pointerMoveStage=ni.Create(),this._pointerDownStage=ni.Create(),this._pointerUpStage=ni.Create(),this._geometriesByUniqueId=null,this._defaultMeshCandidates={data:[],length:0},this._defaultSubMeshCandidates={data:[],length:0},this._preventFreeActiveMeshesAndRenderingGroups=!1,this._activeMeshesFrozen=!1,this._activeMeshesFrozenButKeepClipping=!1,this._skipEvaluateActiveMeshesCompletely=!1,this._allowPostProcessClearColor=!0,this.getDeterministicFrameTime=()=>this._engine.getTimeStep(),this._blockMaterialDirtyMechanism=!1,this._perfCollector=null,this.onComputePressureChanged=new X,this.activeCameras=new Array;const i={useGeometryUniqueIdsMap:!0,useMaterialMeshMap:!0,useClonedMeshMap:!0,virtual:!1,...t};this._engine=e||ye.LastCreatedEngine,i.virtual?this._engine._virtualScenes.push(this):(ye._LastCreatedScene=this,this._engine.scenes.push(this)),this._uid=null,this._renderingManager=new ns(this),Yh&&(this.postProcessManager=new Yh(this)),Ht()&&this.attachControl(),this._createUbo(),qe&&(this._imageProcessingConfiguration=new qe),this.setDefaultCandidateProviders(),i.useGeometryUniqueIdsMap&&(this._geometriesByUniqueId={}),this.useMaterialMeshMap=i.useMaterialMeshMap,this.useClonedMeshMap=i.useClonedMeshMap,(!t||!t.virtual)&&this._engine.onNewSceneAddedObservable.notifyObservers(this),jh.IsAvailable&&(this._computePressureObserver=new jh(s=>{this.onComputePressureChanged.notifyObservers(s)},{cpuUtilizationThresholds:[.25,.5,.75,.9],cpuSpeedThresholds:[.5]}),this._computePressureObserver.observe("cpu"))}static DefaultMaterialFactory(e){throw Ve("StandardMaterial")}static CollisionCoordinatorFactory(){throw Ve("DefaultCollisionCoordinator")}get environmentTexture(){return this._environmentTexture}set environmentTexture(e){this._environmentTexture!==e&&(this._environmentTexture=e,this.markAllMaterialsAsDirty(1))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}get performancePriority(){return this._performancePriority}set performancePriority(e){if(e!==this._performancePriority)switch(this._performancePriority=e,e){case Qs.BackwardCompatible:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!1,this.autoClear=!0;break;case Qs.Intermediate:this.skipFrustumClipping=!1,this._renderingManager.maintainStateBetweenFrames=!1,this.skipPointerMovePicking=!0,this.autoClear=!1;break;case Qs.Aggressive:this.skipFrustumClipping=!0,this._renderingManager.maintainStateBetweenFrames=!0,this.skipPointerMovePicking=!0,this.autoClear=!1;break}}set forceWireframe(e){this._forceWireframe!==e&&(this._forceWireframe=e,this.markAllMaterialsAsDirty(16))}get forceWireframe(){return this._forceWireframe}set skipFrustumClipping(e){this._skipFrustumClipping!==e&&(this._skipFrustumClipping=e)}get skipFrustumClipping(){return this._skipFrustumClipping}set forcePointsCloud(e){this._forcePointsCloud!==e&&(this._forcePointsCloud=e,this.markAllMaterialsAsDirty(16))}get forcePointsCloud(){return this._forcePointsCloud}get animationPropertiesOverride(){return this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set beforeRender(e){this._onBeforeRenderObserver&&this.onBeforeRenderObservable.remove(this._onBeforeRenderObserver),e&&(this._onBeforeRenderObserver=this.onBeforeRenderObservable.add(e))}set afterRender(e){this._onAfterRenderObserver&&this.onAfterRenderObservable.remove(this._onAfterRenderObserver),e&&(this._onAfterRenderObserver=this.onAfterRenderObservable.add(e))}set beforeCameraRender(e){this._onBeforeCameraRenderObserver&&this.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._onBeforeCameraRenderObserver=this.onBeforeCameraRenderObservable.add(e)}set afterCameraRender(e){this._onAfterCameraRenderObserver&&this.onAfterCameraRenderObservable.remove(this._onAfterCameraRenderObserver),this._onAfterCameraRenderObserver=this.onAfterCameraRenderObservable.add(e)}get unTranslatedPointer(){return this._inputManager.unTranslatedPointer}static get DragMovementThreshold(){return ui.DragMovementThreshold}static set DragMovementThreshold(e){ui.DragMovementThreshold=e}static get LongPressDelay(){return ui.LongPressDelay}static set LongPressDelay(e){ui.LongPressDelay=e}static get DoubleClickDelay(){return ui.DoubleClickDelay}static set DoubleClickDelay(e){ui.DoubleClickDelay=e}static get ExclusiveDoubleClickMode(){return ui.ExclusiveDoubleClickMode}static set ExclusiveDoubleClickMode(e){ui.ExclusiveDoubleClickMode=e}bindEyePosition(e,t="vEyePosition",i=!1){var s;const r=this._forcedViewPosition?this._forcedViewPosition:this._mirroredCameraPosition?this._mirroredCameraPosition:(s=this.activeCamera.globalPosition)!==null&&s!==void 0?s:this.activeCamera.devicePosition,n=this.useRightHandedSystem===(this._mirroredCameraPosition!=null);return G.Vector4[0].set(r.x,r.y,r.z,n?-1:1),e&&(i?e.setFloat3(t,G.Vector4[0].x,G.Vector4[0].y,G.Vector4[0].z):e.setVector4(t,G.Vector4[0])),G.Vector4[0]}finalizeSceneUbo(){const e=this.getSceneUniformBuffer(),t=this.bindEyePosition(null);return e.updateFloat4("vEyePosition",t.x,t.y,t.z,t.w),e.update(),e}set useRightHandedSystem(e){this._useRightHandedSystem!==e&&(this._useRightHandedSystem=e,this.markAllMaterialsAsDirty(16))}get useRightHandedSystem(){return this._useRightHandedSystem}setStepId(e){this._currentStepId=e}getStepId(){return this._currentStepId}getInternalStep(){return this._currentInternalStep}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAllMaterialsAsDirty(16))}get fogEnabled(){return this._fogEnabled}set fogMode(e){this._fogMode!==e&&(this._fogMode=e,this.markAllMaterialsAsDirty(16))}get fogMode(){return this._fogMode}get prePass(){return!!this.prePassRenderer&&this.prePassRenderer.defaultRT.enabled}set shadowsEnabled(e){this._shadowsEnabled!==e&&(this._shadowsEnabled=e,this.markAllMaterialsAsDirty(2))}get shadowsEnabled(){return this._shadowsEnabled}set lightsEnabled(e){this._lightsEnabled!==e&&(this._lightsEnabled=e,this.markAllMaterialsAsDirty(2))}get lightsEnabled(){return this._lightsEnabled}get activeCameras(){return this._activeCameras}set activeCameras(e){this._unObserveActiveCameras&&(this._unObserveActiveCameras(),this._unObserveActiveCameras=null),e&&(this._unObserveActiveCameras=s_(e,()=>{this.onActiveCamerasChanged.notifyObservers(this)})),this._activeCameras=e}get activeCamera(){return this._activeCamera}set activeCamera(e){e!==this._activeCamera&&(this._activeCamera=e,this.onActiveCameraChanged.notifyObservers(this))}get defaultMaterial(){return this._defaultMaterial||(this._defaultMaterial=ge.DefaultMaterialFactory(this)),this._defaultMaterial}set defaultMaterial(e){this._defaultMaterial=e}set texturesEnabled(e){this._texturesEnabled!==e&&(this._texturesEnabled=e,this.markAllMaterialsAsDirty(1))}get texturesEnabled(){return this._texturesEnabled}set skeletonsEnabled(e){this._skeletonsEnabled!==e&&(this._skeletonsEnabled=e,this.markAllMaterialsAsDirty(8))}get skeletonsEnabled(){return this._skeletonsEnabled}get collisionCoordinator(){return this._collisionCoordinator||(this._collisionCoordinator=ge.CollisionCoordinatorFactory(),this._collisionCoordinator.init(this)),this._collisionCoordinator}get renderingManager(){return this._renderingManager}get frustumPlanes(){return this._frustumPlanes}_registerTransientComponents(){if(this._transientComponents.length>0){for(const e of this._transientComponents)e.register();this._transientComponents.length=0}}_addComponent(e){this._components.push(e),this._transientComponents.push(e);const t=e;t.addFromContainer&&t.serialize&&this._serializableComponents.push(t)}_getComponent(e){for(const t of this._components)if(t.name===e)return t;return null}getClassName(){return"Scene"}_getDefaultMeshCandidates(){return this._defaultMeshCandidates.data=this.meshes,this._defaultMeshCandidates.length=this.meshes.length,this._defaultMeshCandidates}_getDefaultSubMeshCandidates(e){return this._defaultSubMeshCandidates.data=e.subMeshes,this._defaultSubMeshCandidates.length=e.subMeshes.length,this._defaultSubMeshCandidates}setDefaultCandidateProviders(){this.getActiveMeshCandidates=this._getDefaultMeshCandidates.bind(this),this.getActiveSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getIntersectingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this),this.getCollidingSubMeshCandidates=this._getDefaultSubMeshCandidates.bind(this)}get meshUnderPointer(){return this._inputManager.meshUnderPointer}get pointerX(){return this._inputManager.pointerX}set pointerX(e){this._inputManager.pointerX=e}get pointerY(){return this._inputManager.pointerY}set pointerY(e){this._inputManager.pointerY=e}getCachedMaterial(){return this._cachedMaterial}getCachedEffect(){return this._cachedEffect}getCachedVisibility(){return this._cachedVisibility}isCachedMaterialInvalid(e,t,i=1){return this._cachedEffect!==t||this._cachedMaterial!==e||this._cachedVisibility!==i}getEngine(){return this._engine}getTotalVertices(){return this._totalVertices.current}get totalVerticesPerfCounter(){return this._totalVertices}getActiveIndices(){return this._activeIndices.current}get totalActiveIndicesPerfCounter(){return this._activeIndices}getActiveParticles(){return this._activeParticles.current}get activeParticlesPerfCounter(){return this._activeParticles}getActiveBones(){return this._activeBones.current}get activeBonesPerfCounter(){return this._activeBones}getActiveMeshes(){return this._activeMeshes}getAnimationRatio(){return this._animationRatio!==void 0?this._animationRatio:1}getRenderId(){return this._renderId}getFrameId(){return this._frameId}incrementRenderId(){this._renderId++}_createUbo(){this.setSceneUniformBuffer(this.createSceneUniformBuffer())}simulatePointerMove(e,t){return this._inputManager.simulatePointerMove(e,t),this}simulatePointerDown(e,t){return this._inputManager.simulatePointerDown(e,t),this}simulatePointerUp(e,t,i){return this._inputManager.simulatePointerUp(e,t,i),this}isPointerCaptured(e=0){return this._inputManager.isPointerCaptured(e)}attachControl(e=!0,t=!0,i=!0){this._inputManager.attachControl(e,t,i)}detachControl(){this._inputManager.detachControl()}isReady(e=!0){if(this._isDisposed)return!1;let t;const i=this.getEngine();let s=!0;for(this._pendingData.length>0&&(s=!1),e&&(this._processedMaterials.reset(),this._materialsRenderTargets.reset()),t=0;t<this.meshes.length;t++){const r=this.meshes[t];if(!r.subMeshes||r.subMeshes.length===0)continue;if(!r.isReady(!0)){s=!1;continue}const n=r.hasThinInstances||r.getClassName()==="InstancedMesh"||r.getClassName()==="InstancedLinesMesh"||i.getCaps().instancedArrays&&r.instances.length>0;for(const l of this._isReadyForMeshStage)l.action(r,n)||(s=!1);if(!e)continue;const o=r.material||this.defaultMaterial;if(o)if(o._storeEffectOnSubMeshes)for(const l of r.subMeshes){const h=l.getMaterial();h&&h.hasRenderTargetTextures&&h.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(h)===-1&&(this._processedMaterials.push(h),this._materialsRenderTargets.concatWithNoDuplicate(h.getRenderTargetTextures()))}else o.hasRenderTargetTextures&&o.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(o)===-1&&(this._processedMaterials.push(o),this._materialsRenderTargets.concatWithNoDuplicate(o.getRenderTargetTextures()))}if(!s||!i.areAllEffectsReady())return!1;if(e){for(t=0;t<this._materialsRenderTargets.length;++t)if(!this._materialsRenderTargets.data[t].isReadyForRendering())return!1}for(t=0;t<this.geometries.length;t++)if(this.geometries[t].delayLoadState===2)return!1;if(this.activeCameras&&this.activeCameras.length>0){for(const r of this.activeCameras)if(!r.isReady(!0))return!1}else if(this.activeCamera&&!this.activeCamera.isReady(!0))return!1;for(const r of this.particleSystems)if(!r.isReady())return!1;return!0}resetCachedMaterial(){this._cachedMaterial=null,this._cachedEffect=null,this._cachedVisibility=null}registerBeforeRender(e){this.onBeforeRenderObservable.add(e)}unregisterBeforeRender(e){this.onBeforeRenderObservable.removeCallback(e)}registerAfterRender(e){this.onAfterRenderObservable.add(e)}unregisterAfterRender(e){this.onAfterRenderObservable.removeCallback(e)}_executeOnceBeforeRender(e){const t=()=>{e(),setTimeout(()=>{this.unregisterBeforeRender(t)})};this.registerBeforeRender(t)}executeOnceBeforeRender(e,t){t!==void 0?setTimeout(()=>{this._executeOnceBeforeRender(e)},t):this._executeOnceBeforeRender(e)}addPendingData(e){this._pendingData.push(e)}removePendingData(e){const t=this.isLoading,i=this._pendingData.indexOf(e);i!==-1&&this._pendingData.splice(i,1),t&&!this.isLoading&&this.onDataLoadedObservable.notifyObservers(this)}getWaitingItemsCount(){return this._pendingData.length}get isLoading(){return this._pendingData.length>0}executeWhenReady(e,t=!1){this.onReadyObservable.add(e),this._executeWhenReadyTimeoutId===null&&this._checkIsReady(t)}whenReadyAsync(e=!1){return new Promise(t=>{this.executeWhenReady(()=>{t()},e)})}_checkIsReady(e=!1){if(this._registerTransientComponents(),this.isReady(e)){this.onReadyObservable.notifyObservers(this),this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}if(this._isDisposed){this.onReadyObservable.clear(),this._executeWhenReadyTimeoutId=null;return}this._executeWhenReadyTimeoutId=setTimeout(()=>{this.incrementRenderId(),this._checkIsReady(e)},100)}get animatables(){return this._activeAnimatables}resetLastAnimationTimeFrame(){this._animationTimeLast=ps.Now}getViewMatrix(){return this._viewMatrix}getProjectionMatrix(){return this._projectionMatrix}getTransformMatrix(){return this._transformMatrix}setTransformMatrix(e,t,i,s){!i&&!s&&this._multiviewSceneUbo&&(this._multiviewSceneUbo.dispose(),this._multiviewSceneUbo=null),!(this._viewUpdateFlag===e.updateFlag&&this._projectionUpdateFlag===t.updateFlag)&&(this._viewUpdateFlag=e.updateFlag,this._projectionUpdateFlag=t.updateFlag,this._viewMatrix=e,this._projectionMatrix=t,this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._frustumPlanes?$s.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=$s.GetPlanes(this._transformMatrix),this._multiviewSceneUbo&&this._multiviewSceneUbo.useUbo?this._updateMultiviewUbo(i,s):this._sceneUbo.useUbo&&(this._sceneUbo.updateMatrix("viewProjection",this._transformMatrix),this._sceneUbo.updateMatrix("view",this._viewMatrix),this._sceneUbo.updateMatrix("projection",this._projectionMatrix)))}getSceneUniformBuffer(){return this._multiviewSceneUbo?this._multiviewSceneUbo:this._sceneUbo}createSceneUniformBuffer(e){const t=new Pe(this._engine,void 0,!1,e!=null?e:"scene");return t.addUniform("viewProjection",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}setSceneUniformBuffer(e){this._sceneUbo=e,this._viewUpdateFlag=-1,this._projectionUpdateFlag=-1}getUniqueId(){return xc.UniqueId}addMesh(e,t=!1){this._blockEntityCollection||(this.meshes.push(e),e._resyncLightSources(),e.parent||e._addToSceneRootNodes(),this.onNewMeshAddedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(i=>{this.addMesh(i)}))}removeMesh(e,t=!1){const i=this.meshes.indexOf(e);return i!==-1&&(this.meshes[i]=this.meshes[this.meshes.length-1],this.meshes.pop(),e.parent||e._removeFromSceneRootNodes()),this._inputManager._invalidateMesh(e),this.onMeshRemovedObservable.notifyObservers(e),t&&e.getChildMeshes().forEach(s=>{this.removeMesh(s)}),i}addTransformNode(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneTransformNodesArray!==-1||(e._indexInSceneTransformNodesArray=this.transformNodes.length,this.transformNodes.push(e),e.parent||e._addToSceneRootNodes(),this.onNewTransformNodeAddedObservable.notifyObservers(e))}removeTransformNode(e){const t=e._indexInSceneTransformNodesArray;if(t!==-1){if(t!==this.transformNodes.length-1){const i=this.transformNodes[this.transformNodes.length-1];this.transformNodes[t]=i,i._indexInSceneTransformNodesArray=t}e._indexInSceneTransformNodesArray=-1,this.transformNodes.pop(),e.parent||e._removeFromSceneRootNodes()}return this.onTransformNodeRemovedObservable.notifyObservers(e),t}removeSkeleton(e){const t=this.skeletons.indexOf(e);return t!==-1&&(this.skeletons.splice(t,1),this.onSkeletonRemovedObservable.notifyObservers(e),this._executeActiveContainerCleanup(this._activeSkeletons)),t}removeMorphTargetManager(e){const t=this.morphTargetManagers.indexOf(e);return t!==-1&&this.morphTargetManagers.splice(t,1),t}removeLight(e){const t=this.lights.indexOf(e);if(t!==-1){for(const i of this.meshes)i._removeLightSource(e,!1);this.lights.splice(t,1),this.sortLightsByPriority(),e.parent||e._removeFromSceneRootNodes()}return this.onLightRemovedObservable.notifyObservers(e),t}removeCamera(e){const t=this.cameras.indexOf(e);if(t!==-1&&(this.cameras.splice(t,1),e.parent||e._removeFromSceneRootNodes()),this.activeCameras){const i=this.activeCameras.indexOf(e);i!==-1&&this.activeCameras.splice(i,1)}return this.activeCamera===e&&(this.cameras.length>0?this.activeCamera=this.cameras[0]:this.activeCamera=null),this.onCameraRemovedObservable.notifyObservers(e),t}removeParticleSystem(e){const t=this.particleSystems.indexOf(e);return t!==-1&&(this.particleSystems.splice(t,1),this._executeActiveContainerCleanup(this._activeParticleSystems)),t}removeAnimation(e){const t=this.animations.indexOf(e);return t!==-1&&this.animations.splice(t,1),t}stopAnimation(e,t,i){}removeAnimationGroup(e){const t=this.animationGroups.indexOf(e);return t!==-1&&this.animationGroups.splice(t,1),t}removeMultiMaterial(e){const t=this.multiMaterials.indexOf(e);return t!==-1&&this.multiMaterials.splice(t,1),this.onMultiMaterialRemovedObservable.notifyObservers(e),t}removeMaterial(e){const t=e._indexInSceneMaterialArray;if(t!==-1&&t<this.materials.length){if(t!==this.materials.length-1){const i=this.materials[this.materials.length-1];this.materials[t]=i,i._indexInSceneMaterialArray=t}e._indexInSceneMaterialArray=-1,this.materials.pop()}return this.onMaterialRemovedObservable.notifyObservers(e),t}removeActionManager(e){const t=this.actionManagers.indexOf(e);return t!==-1&&this.actionManagers.splice(t,1),t}removeTexture(e){const t=this.textures.indexOf(e);return t!==-1&&this.textures.splice(t,1),this.onTextureRemovedObservable.notifyObservers(e),t}addLight(e){if(!this._blockEntityCollection){this.lights.push(e),this.sortLightsByPriority(),e.parent||e._addToSceneRootNodes();for(const t of this.meshes)t.lightSources.indexOf(e)===-1&&(t.lightSources.push(e),t._resyncLightSources());this.onNewLightAddedObservable.notifyObservers(e)}}sortLightsByPriority(){this.requireLightSorting&&this.lights.sort(Tt.CompareLightsPriority)}addCamera(e){this._blockEntityCollection||(this.cameras.push(e),this.onNewCameraAddedObservable.notifyObservers(e),e.parent||e._addToSceneRootNodes())}addSkeleton(e){this._blockEntityCollection||(this.skeletons.push(e),this.onNewSkeletonAddedObservable.notifyObservers(e))}addParticleSystem(e){this._blockEntityCollection||this.particleSystems.push(e)}addAnimation(e){this._blockEntityCollection||this.animations.push(e)}addAnimationGroup(e){this._blockEntityCollection||this.animationGroups.push(e)}addMultiMaterial(e){this._blockEntityCollection||(this.multiMaterials.push(e),this.onNewMultiMaterialAddedObservable.notifyObservers(e))}addMaterial(e){this._blockEntityCollection||e.getScene()===this&&e._indexInSceneMaterialArray!==-1||(e._indexInSceneMaterialArray=this.materials.length,this.materials.push(e),this.onNewMaterialAddedObservable.notifyObservers(e))}addMorphTargetManager(e){this._blockEntityCollection||this.morphTargetManagers.push(e)}addGeometry(e){this._blockEntityCollection||(this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=this.geometries.length),this.geometries.push(e))}addActionManager(e){this.actionManagers.push(e)}addTexture(e){this._blockEntityCollection||(this.textures.push(e),this.onNewTextureAddedObservable.notifyObservers(e))}switchActiveCamera(e,t=!0){!this._engine.getInputElement()||(this.activeCamera&&this.activeCamera.detachControl(),this.activeCamera=e,t&&e.attachControl())}setActiveCameraById(e){const t=this.getCameraById(e);return t?(this.activeCamera=t,t):null}setActiveCameraByName(e){const t=this.getCameraByName(e);return t?(this.activeCamera=t,t):null}getAnimationGroupByName(e){for(let t=0;t<this.animationGroups.length;t++)if(this.animationGroups[t].name===e)return this.animationGroups[t];return null}getMaterialByUniqueID(e){for(let t=0;t<this.materials.length;t++)if(this.materials[t].uniqueId===e)return this.materials[t];return null}getMaterialById(e){for(let t=0;t<this.materials.length;t++)if(this.materials[t].id===e)return this.materials[t];return null}getLastMaterialById(e,t=!1){for(let i=this.materials.length-1;i>=0;i--)if(this.materials[i].id===e)return this.materials[i];if(t){for(let i=this.multiMaterials.length-1;i>=0;i--)if(this.multiMaterials[i].id===e)return this.multiMaterials[i]}return null}getMaterialByName(e){for(let t=0;t<this.materials.length;t++)if(this.materials[t].name===e)return this.materials[t];return null}getTextureByUniqueId(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].uniqueId===e)return this.textures[t];return null}getTextureByName(e){for(let t=0;t<this.textures.length;t++)if(this.textures[t].name===e)return this.textures[t];return null}getCameraById(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].id===e)return this.cameras[t];return null}getCameraByUniqueId(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].uniqueId===e)return this.cameras[t];return null}getCameraByName(e){for(let t=0;t<this.cameras.length;t++)if(this.cameras[t].name===e)return this.cameras[t];return null}getBoneById(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let s=0;s<i.bones.length;s++)if(i.bones[s].id===e)return i.bones[s]}return null}getBoneByName(e){for(let t=0;t<this.skeletons.length;t++){const i=this.skeletons[t];for(let s=0;s<i.bones.length;s++)if(i.bones[s].name===e)return i.bones[s]}return null}getLightByName(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].name===e)return this.lights[t];return null}getLightById(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].id===e)return this.lights[t];return null}getLightByUniqueId(e){for(let t=0;t<this.lights.length;t++)if(this.lights[t].uniqueId===e)return this.lights[t];return null}getParticleSystemById(e){for(let t=0;t<this.particleSystems.length;t++)if(this.particleSystems[t].id===e)return this.particleSystems[t];return null}getGeometryById(e){for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].id===e)return this.geometries[t];return null}_getGeometryByUniqueId(e){if(this._geometriesByUniqueId){const t=this._geometriesByUniqueId[e];if(t!==void 0)return this.geometries[t]}else for(let t=0;t<this.geometries.length;t++)if(this.geometries[t].uniqueId===e)return this.geometries[t];return null}pushGeometry(e,t){return!t&&this._getGeometryByUniqueId(e.uniqueId)?!1:(this.addGeometry(e),this.onNewGeometryAddedObservable.notifyObservers(e),!0)}removeGeometry(e){let t;if(this._geometriesByUniqueId){if(t=this._geometriesByUniqueId[e.uniqueId],t===void 0)return!1}else if(t=this.geometries.indexOf(e),t<0)return!1;if(t!==this.geometries.length-1){const i=this.geometries[this.geometries.length-1];i&&(this.geometries[t]=i,this._geometriesByUniqueId&&(this._geometriesByUniqueId[i.uniqueId]=t))}return this._geometriesByUniqueId&&(this._geometriesByUniqueId[e.uniqueId]=void 0),this.geometries.pop(),this.onGeometryRemovedObservable.notifyObservers(e),!0}getGeometries(){return this.geometries}getMeshById(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].id===e)return this.meshes[t];return null}getMeshesById(e){return this.meshes.filter(function(t){return t.id===e})}getTransformNodeById(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].id===e)return this.transformNodes[t];return null}getTransformNodeByUniqueId(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].uniqueId===e)return this.transformNodes[t];return null}getTransformNodesById(e){return this.transformNodes.filter(function(t){return t.id===e})}getMeshByUniqueId(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].uniqueId===e)return this.meshes[t];return null}getLastMeshById(e){for(let t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];return null}getLastEntryById(e){let t;for(t=this.meshes.length-1;t>=0;t--)if(this.meshes[t].id===e)return this.meshes[t];for(t=this.transformNodes.length-1;t>=0;t--)if(this.transformNodes[t].id===e)return this.transformNodes[t];for(t=this.cameras.length-1;t>=0;t--)if(this.cameras[t].id===e)return this.cameras[t];for(t=this.lights.length-1;t>=0;t--)if(this.lights[t].id===e)return this.lights[t];return null}getNodeById(e){const t=this.getMeshById(e);if(t)return t;const i=this.getTransformNodeById(e);if(i)return i;const s=this.getLightById(e);if(s)return s;const r=this.getCameraById(e);if(r)return r;const n=this.getBoneById(e);return n||null}getNodeByName(e){const t=this.getMeshByName(e);if(t)return t;const i=this.getTransformNodeByName(e);if(i)return i;const s=this.getLightByName(e);if(s)return s;const r=this.getCameraByName(e);if(r)return r;const n=this.getBoneByName(e);return n||null}getMeshByName(e){for(let t=0;t<this.meshes.length;t++)if(this.meshes[t].name===e)return this.meshes[t];return null}getTransformNodeByName(e){for(let t=0;t<this.transformNodes.length;t++)if(this.transformNodes[t].name===e)return this.transformNodes[t];return null}getLastSkeletonById(e){for(let t=this.skeletons.length-1;t>=0;t--)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByUniqueId(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].uniqueId===e)return this.skeletons[t];return null}getSkeletonById(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].id===e)return this.skeletons[t];return null}getSkeletonByName(e){for(let t=0;t<this.skeletons.length;t++)if(this.skeletons[t].name===e)return this.skeletons[t];return null}getMorphTargetManagerById(e){for(let t=0;t<this.morphTargetManagers.length;t++)if(this.morphTargetManagers[t].uniqueId===e)return this.morphTargetManagers[t];return null}getMorphTargetById(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let s=0;s<i.numTargets;++s){const r=i.getTarget(s);if(r.id===e)return r}}return null}getMorphTargetByName(e){for(let t=0;t<this.morphTargetManagers.length;++t){const i=this.morphTargetManagers[t];for(let s=0;s<i.numTargets;++s){const r=i.getTarget(s);if(r.name===e)return r}}return null}getPostProcessByName(e){for(let t=0;t<this.postProcesses.length;++t){const i=this.postProcesses[t];if(i.name===e)return i}return null}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}get uid(){return this._uid||(this._uid=q.RandomId()),this._uid}addExternalData(e,t){return this._externalData||(this._externalData=new Zu),this._externalData.add(e,t)}getExternalData(e){return this._externalData?this._externalData.get(e):null}getOrAddExternalDataWithFactory(e,t){return this._externalData||(this._externalData=new Zu),this._externalData.getOrAddWithFactory(e,t)}removeExternalData(e){return this._externalData.remove(e)}_evaluateSubMesh(e,t,i,s){if(s||e.isInFrustum(this._frustumPlanes)){for(const n of this._evaluateSubMeshStage)n.action(t,e);const r=e.getMaterial();r!=null&&(r.hasRenderTargetTextures&&r.getRenderTargetTextures!=null&&this._processedMaterials.indexOf(r)===-1&&(this._processedMaterials.push(r),this._materialsRenderTargets.concatWithNoDuplicate(r.getRenderTargetTextures())),this._renderingManager.dispatch(e,t,r))}}freeProcessedMaterials(){this._processedMaterials.dispose()}get blockfreeActiveMeshesAndRenderingGroups(){return this._preventFreeActiveMeshesAndRenderingGroups}set blockfreeActiveMeshesAndRenderingGroups(e){this._preventFreeActiveMeshesAndRenderingGroups!==e&&(e&&(this.freeActiveMeshes(),this.freeRenderingGroups()),this._preventFreeActiveMeshesAndRenderingGroups=e)}freeActiveMeshes(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._activeMeshes.dispose(),this.activeCamera&&this.activeCamera._activeMeshes&&this.activeCamera._activeMeshes.dispose(),this.activeCameras))for(let e=0;e<this.activeCameras.length;e++){const t=this.activeCameras[e];t&&t._activeMeshes&&t._activeMeshes.dispose()}}freeRenderingGroups(){if(!this.blockfreeActiveMeshesAndRenderingGroups&&(this._renderingManager&&this._renderingManager.freeRenderingGroups(),this.textures))for(let e=0;e<this.textures.length;e++){const t=this.textures[e];t&&t.renderList&&t.freeRenderingGroups()}}_isInIntermediateRendering(){return this._intermediateRendering}freezeActiveMeshes(e=!1,t,i,s=!0,r=!1){return this.executeWhenReady(()=>{if(!this.activeCamera){i&&i("No active camera found");return}if(this._frustumPlanes||this.updateTransformMatrix(),this._evaluateActiveMeshes(),this._activeMeshesFrozen=!0,this._activeMeshesFrozenButKeepClipping=r,this._skipEvaluateActiveMeshesCompletely=e,s)for(let n=0;n<this._activeMeshes.length;n++)this._activeMeshes.data[n]._freeze();t&&t()}),this}unfreezeActiveMeshes(){for(let e=0;e<this.meshes.length;e++){const t=this.meshes[e];t._internalAbstractMeshDataInfo&&(t._internalAbstractMeshDataInfo._isActive=!1)}for(let e=0;e<this._activeMeshes.length;e++)this._activeMeshes.data[e]._unFreeze();return this._activeMeshesFrozen=!1,this}_executeActiveContainerCleanup(e){!(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1)&&this._activeMeshesFrozen&&this._activeMeshes.length||this.onBeforeRenderObservable.addOnce(()=>e.dispose())}_evaluateActiveMeshes(){var e;if(this._engine.snapshotRendering&&this._engine.snapshotRenderingMode===1){this._activeMeshes.length>0&&((e=this.activeCamera)===null||e===void 0||e._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset());return}if(this._activeMeshesFrozen&&this._activeMeshes.length){if(!this._skipEvaluateActiveMeshesCompletely){const s=this._activeMeshes.length;for(let r=0;r<s;r++)this._activeMeshes.data[r].computeWorldMatrix()}if(this._activeParticleSystems){const s=this._activeParticleSystems.length;for(let r=0;r<s;r++)this._activeParticleSystems.data[r].animate()}return}if(!this.activeCamera)return;this.onBeforeActiveMeshesEvaluationObservable.notifyObservers(this),this.activeCamera._activeMeshes.reset(),this._activeMeshes.reset(),this._renderingManager.reset(),this._processedMaterials.reset(),this._activeParticleSystems.reset(),this._activeSkeletons.reset(),this._softwareSkinnedMeshes.reset(),this._materialsRenderTargets.reset();for(const s of this._beforeEvaluateActiveMeshStage)s.action();const t=this.getActiveMeshCandidates(),i=t.length;for(let s=0;s<i;s++){const r=t.data[s];if(r._internalAbstractMeshDataInfo._currentLODIsUpToDate=!1,r.isBlocked||(this._totalVertices.addCount(r.getTotalVertices(),!1),!r.isReady()||!r.isEnabled()||r.scaling.hasAZeroComponent))continue;r.computeWorldMatrix(),r.actionManager&&r.actionManager.hasSpecificTriggers2(12,13)&&this._meshesForIntersections.pushNoDuplicate(r);let n=this.customLODSelector?this.customLODSelector(r,this.activeCamera):r.getLOD(this.activeCamera);if(r._internalAbstractMeshDataInfo._currentLOD=n,r._internalAbstractMeshDataInfo._currentLODIsUpToDate=!0,n!=null&&(n!==r&&n.billboardMode!==0&&n.computeWorldMatrix(),r._preActivate(),r.isVisible&&r.visibility>0&&(r.layerMask&this.activeCamera.layerMask)!==0&&(this._skipFrustumClipping||r.alwaysSelectAsActiveMesh||r.isInFrustum(this._frustumPlanes)))){this._activeMeshes.push(r),this.activeCamera._activeMeshes.push(r),n!==r&&n._activate(this._renderId,!1);for(const o of this._preActiveMeshStage)o.action(r);r._activate(this._renderId,!1)&&(r.isAnInstance?r._internalAbstractMeshDataInfo._actAsRegularMesh&&(n=r):n._internalAbstractMeshDataInfo._onlyForInstances=!1,n._internalAbstractMeshDataInfo._isActive=!0,this._activeMesh(r,n)),r._postActivate()}}if(this.particlesEnabled){this.onBeforeParticlesRenderingObservable.notifyObservers(this);for(let s=0;s<this.particleSystems.length;s++){const r=this.particleSystems[s];if(!r.isStarted()||!r.emitter)continue;const n=r.emitter;(!n.position||n.isEnabled())&&(this._activeParticleSystems.push(r),r.animate(),this._renderingManager.dispatchParticles(r))}this.onAfterParticlesRenderingObservable.notifyObservers(this)}}_activeMesh(e,t){this._skeletonsEnabled&&t.skeleton!==null&&t.skeleton!==void 0&&(this._activeSkeletons.pushNoDuplicate(t.skeleton)&&(t.skeleton.prepare(),this._activeBones.addCount(t.skeleton.bones.length,!1)),t.computeBonesUsingShaders||this._softwareSkinnedMeshes.pushNoDuplicate(t));let i=e.hasInstances||e.isAnInstance||this.dispatchAllSubMeshesOfActiveMeshes||this._skipFrustumClipping||t.alwaysSelectAsActiveMesh;if(t&&t.subMeshes&&t.subMeshes.length>0){const s=this.getActiveSubMeshCandidates(t),r=s.length;i=i||r===1;for(let n=0;n<r;n++){const o=s.data[n];this._evaluateSubMesh(o,t,e,i)}}}updateTransformMatrix(e){if(!!this.activeCamera)if(this.activeCamera._renderingMultiview){const t=this.activeCamera._rigCameras[0],i=this.activeCamera._rigCameras[1];this.setTransformMatrix(t.getViewMatrix(),t.getProjectionMatrix(e),i.getViewMatrix(),i.getProjectionMatrix(e))}else this.setTransformMatrix(this.activeCamera.getViewMatrix(),this.activeCamera.getProjectionMatrix(e))}_bindFrameBuffer(e,t=!0){e&&e._multiviewTexture?e._multiviewTexture._bindFrameBuffer():e&&e.outputRenderTarget?e.outputRenderTarget._bindFrameBuffer():this._engine._currentFrameBufferIsDefaultFrameBuffer()||this._engine.restoreDefaultFramebuffer(),t&&this._clearFrameBuffer(e)}_clearFrameBuffer(e){if(!(e&&e._multiviewTexture))if(e&&e.outputRenderTarget){const t=e.outputRenderTarget;t.onClearObservable.hasObservers()?t.onClearObservable.notifyObservers(this._engine):t.skipInitialClear||(this.autoClear&&this._engine.clear(t.clearColor||this.clearColor,!t._cleared,!0,!0),t._cleared=!0)}else this._defaultFrameBufferCleared?this._engine.clear(null,!1,!0,!0):(this._defaultFrameBufferCleared=!0,this._clear())}_renderForCamera(e,t,i=!0){var s,r,n;if(e&&e._skipRendering)return;const o=this._engine;if(this._activeCamera=e,!this.activeCamera)throw new Error("Active camera not set");if(o.setViewport(this.activeCamera.viewport),this.resetCachedMaterial(),this._renderId++,!this.prePass&&i){let h=!0;e._renderingMultiview&&e.outputRenderTarget&&(h=e.outputRenderTarget.skipInitialClear,this.autoClear&&(e.outputRenderTarget.skipInitialClear=!1)),this._bindFrameBuffer(this._activeCamera),e._renderingMultiview&&e.outputRenderTarget&&(e.outputRenderTarget.skipInitialClear=h)}this.updateTransformMatrix(),this.onBeforeCameraRenderObservable.notifyObservers(this.activeCamera),this._evaluateActiveMeshes();for(let h=0;h<this._softwareSkinnedMeshes.length;h++){const c=this._softwareSkinnedMeshes.data[h];c.applySkeleton(c.skeleton)}this.onBeforeRenderTargetsRenderObservable.notifyObservers(this),this._renderTargets.concatWithNoDuplicate(this._materialsRenderTargets),e.customRenderTargets&&e.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(e.customRenderTargets),t&&t.customRenderTargets&&t.customRenderTargets.length>0&&this._renderTargets.concatWithNoDuplicate(t.customRenderTargets),this.environmentTexture&&this.environmentTexture.isRenderTarget&&this._renderTargets.pushNoDuplicate(this.environmentTexture);for(const h of this._gatherActiveCameraRenderTargetsStage)h.action(this._renderTargets);let l=!1;if(this.renderTargetsEnabled){if(this._intermediateRendering=!0,this._renderTargets.length>0){q.StartPerformanceCounter("Render targets",this._renderTargets.length>0);for(let h=0;h<this._renderTargets.length;h++){const c=this._renderTargets.data[h];if(c._shouldRender()){this._renderId++;const u=c.activeCamera&&c.activeCamera!==this.activeCamera;c.render(u,this.dumpNextRenderTargets),l=!0}}q.EndPerformanceCounter("Render targets",this._renderTargets.length>0),this._renderId++}for(const h of this._cameraDrawRenderTargetStage)l=h.action(this.activeCamera)||l;this._intermediateRendering=!1}this._engine.currentRenderPassId=(n=(r=(s=e.outputRenderTarget)===null||s===void 0?void 0:s.renderPassId)!==null&&r!==void 0?r:e.renderPassId)!==null&&n!==void 0?n:0,l&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this),this.postProcessManager&&!e._multiviewTexture&&!this.prePass&&this.postProcessManager._prepareFrame();for(const h of this._beforeCameraDrawStage)h.action(this.activeCamera);this.onBeforeDrawPhaseObservable.notifyObservers(this),o.snapshotRendering&&o.snapshotRenderingMode===1&&this.finalizeSceneUbo(),this._renderingManager.render(null,null,!0,!0),this.onAfterDrawPhaseObservable.notifyObservers(this);for(const h of this._afterCameraDrawStage)h.action(this.activeCamera);if(this.postProcessManager&&!e._multiviewTexture){const h=e.outputRenderTarget?e.outputRenderTarget.renderTarget:void 0;this.postProcessManager._finalizeFrame(e.isIntermediate,h)}for(const h of this._afterCameraPostProcessStage)h.action(this.activeCamera);this._renderTargets.reset(),this.onAfterCameraRenderObservable.notifyObservers(this.activeCamera)}_processSubCameras(e,t=!0){if(e.cameraRigMode===0||e._renderingMultiview){e._renderingMultiview&&!this._multiviewSceneUbo&&this._createMultiviewUbo(),this._renderForCamera(e,void 0,t),this.onAfterRenderCameraObservable.notifyObservers(e);return}if(e._useMultiviewToSingleView)this._renderMultiviewToSingleView(e);else{this.onBeforeCameraRenderObservable.notifyObservers(e);for(let i=0;i<e._rigCameras.length;i++)this._renderForCamera(e._rigCameras[i],e)}this._activeCamera=e,this.updateTransformMatrix(),this.onAfterRenderCameraObservable.notifyObservers(e)}_checkIntersections(){for(let e=0;e<this._meshesForIntersections.length;e++){const t=this._meshesForIntersections.data[e];if(!!t.actionManager)for(let i=0;t.actionManager&&i<t.actionManager.actions.length;i++){const s=t.actionManager.actions[i];if(s.trigger===12||s.trigger===13){const r=s.getTriggerParameter(),n=r.mesh?r.mesh:r,o=n.intersectsMesh(t,r.usePreciseIntersection),l=t._intersectionsInProgress.indexOf(n);o&&l===-1?s.trigger===12?(s._executeCurrent(Ri.CreateNew(t,void 0,n)),t._intersectionsInProgress.push(n)):s.trigger===13&&t._intersectionsInProgress.push(n):!o&&l>-1&&(s.trigger===13&&s._executeCurrent(Ri.CreateNew(t,void 0,n)),(!t.actionManager.hasSpecificTrigger(13,h=>{const c=h.mesh?h.mesh:h;return n===c})||s.trigger===13)&&t._intersectionsInProgress.splice(l,1))}}}}_advancePhysicsEngineStep(e){}_animate(){}animate(){if(this._engine.isDeterministicLockStep()){let e=Math.max(ge.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ge.MaxDeltaTime))+this._timeAccumulator;const t=this._engine.getTimeStep(),i=1e3/t/1e3;let s=0;const r=this._engine.getLockstepMaxSteps();let n=Math.floor(e/t);for(n=Math.min(n,r);e>0&&s<n;)this.onBeforeStepObservable.notifyObservers(this),this._animationRatio=t*i,this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(t),this.onAfterStepObservable.notifyObservers(this),this._currentStepId++,s++,e-=t;this._timeAccumulator=e<0?0:e}else{const e=this.useConstantAnimationDeltaTime?16:Math.max(ge.MinDeltaTime,Math.min(this._engine.getDeltaTime(),ge.MaxDeltaTime));this._animationRatio=e*(60/1e3),this._animate(),this.onAfterAnimationsObservable.notifyObservers(this),this.physicsEnabled&&this._advancePhysicsEngineStep(e)}}_clear(){(this.autoClearDepthAndStencil||this.autoClear)&&this._engine.clear(this.clearColor,this.autoClear||this.forceWireframe||this.forcePointsCloud,this.autoClearDepthAndStencil,this.autoClearDepthAndStencil)}_checkCameraRenderTarget(e){var t;if((e==null?void 0:e.outputRenderTarget)&&!(e!=null&&e.isRigCamera)&&(e.outputRenderTarget._cleared=!1),!((t=e==null?void 0:e.rigCameras)===null||t===void 0)&&t.length)for(let i=0;i<e.rigCameras.length;++i){const s=e.rigCameras[i].outputRenderTarget;s&&(s._cleared=!1)}}resetDrawCache(e){if(!!this.meshes)for(const t of this.meshes)t.resetDrawCache(e)}render(e=!0,t=!1){var i,s,r;if(this.isDisposed)return;this.onReadyObservable.hasObservers()&&this._executeWhenReadyTimeoutId===null&&this._checkIsReady(),this._frameId++,this._defaultFrameBufferCleared=!1,this._checkCameraRenderTarget(this.activeCamera),!((i=this.activeCameras)===null||i===void 0)&&i.length&&this.activeCameras.forEach(this._checkCameraRenderTarget),this._registerTransientComponents(),this._activeParticles.fetchNewFrame(),this._totalVertices.fetchNewFrame(),this._activeIndices.fetchNewFrame(),this._activeBones.fetchNewFrame(),this._meshesForIntersections.reset(),this.resetCachedMaterial(),this.onBeforeAnimationsObservable.notifyObservers(this),this.actionManager&&this.actionManager.processTrigger(11),t||this.animate();for(const h of this._beforeCameraUpdateStage)h.action();if(e){if(this.activeCameras&&this.activeCameras.length>0)for(let h=0;h<this.activeCameras.length;h++){const c=this.activeCameras[h];if(c.update(),c.cameraRigMode!==0)for(let u=0;u<c._rigCameras.length;u++)c._rigCameras[u].update()}else if(this.activeCamera&&(this.activeCamera.update(),this.activeCamera.cameraRigMode!==0))for(let h=0;h<this.activeCamera._rigCameras.length;h++)this.activeCamera._rigCameras[h].update()}this.onBeforeRenderObservable.notifyObservers(this);const n=this.getEngine();this.onBeforeRenderTargetsRenderObservable.notifyObservers(this);const o=!((s=this.activeCameras)===null||s===void 0)&&s.length?this.activeCameras[0]:this.activeCamera;if(this.renderTargetsEnabled){q.StartPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!0;for(let h=0;h<this.customRenderTargets.length;h++){const c=this.customRenderTargets[h];if(c._shouldRender()){if(this._renderId++,this.activeCamera=c.activeCamera||this.activeCamera,!this.activeCamera)throw new Error("Active camera not set");n.setViewport(this.activeCamera.viewport),this.updateTransformMatrix(),c.render(o!==this.activeCamera,this.dumpNextRenderTargets)}}q.EndPerformanceCounter("Custom render targets",this.customRenderTargets.length>0),this._intermediateRendering=!1,this._renderId++}this._engine.currentRenderPassId=(r=o==null?void 0:o.renderPassId)!==null&&r!==void 0?r:0,this.activeCamera=o,this._activeCamera&&this._activeCamera.cameraRigMode!==22&&!this.prePass&&this._bindFrameBuffer(this._activeCamera,!1),this.onAfterRenderTargetsRenderObservable.notifyObservers(this);for(const h of this._beforeClearStage)h.action();this._clearFrameBuffer(this.activeCamera);for(const h of this._gatherRenderTargetsStage)h.action(this._renderTargets);const l=this._activeCamera;if(this.activeCameras&&this.activeCameras.length>0)for(let h=0;h<this.activeCameras.length;h++)this._processSubCameras(this.activeCameras[h],h>0);else{if(!this.activeCamera)throw new Error("No camera defined");this._processSubCameras(this.activeCamera,!!this.activeCamera.outputRenderTarget)}this._activeCamera=l,this._checkIntersections();for(const h of this._afterRenderStage)h.action();if(this.afterRender&&this.afterRender(),this.onAfterRenderObservable.notifyObservers(this),this._toBeDisposed.length){for(let h=0;h<this._toBeDisposed.length;h++){const c=this._toBeDisposed[h];c&&c.dispose()}this._toBeDisposed.length=0}this.dumpNextRenderTargets&&(this.dumpNextRenderTargets=!1),this._activeBones.addCount(0,!0),this._activeIndices.addCount(0,!0),this._activeParticles.addCount(0,!0),this._engine.restoreDefaultFramebuffer()}freezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].freeze()}unfreezeMaterials(){for(let e=0;e<this.materials.length;e++)this.materials[e].unfreeze()}dispose(){var e;if(this.isDisposed)return;this.beforeRender=null,this.afterRender=null,this.metadata=null,this.skeletons.length=0,this.morphTargetManagers.length=0,this._transientComponents.length=0,this._isReadyForMeshStage.clear(),this._beforeEvaluateActiveMeshStage.clear(),this._evaluateSubMeshStage.clear(),this._preActiveMeshStage.clear(),this._cameraDrawRenderTargetStage.clear(),this._beforeCameraDrawStage.clear(),this._beforeRenderTargetDrawStage.clear(),this._beforeRenderingGroupDrawStage.clear(),this._beforeRenderingMeshStage.clear(),this._afterRenderingMeshStage.clear(),this._afterRenderingGroupDrawStage.clear(),this._afterCameraDrawStage.clear(),this._afterRenderTargetDrawStage.clear(),this._afterRenderStage.clear(),this._beforeCameraUpdateStage.clear(),this._beforeClearStage.clear(),this._gatherRenderTargetsStage.clear(),this._gatherActiveCameraRenderTargetsStage.clear(),this._pointerMoveStage.clear(),this._pointerDownStage.clear(),this._pointerUpStage.clear(),this.importedMeshesFiles=new Array,this.stopAllAnimations&&this.stopAllAnimations(),this.resetCachedMaterial(),this.activeCamera&&(this.activeCamera._activeMeshes.dispose(),this.activeCamera=null),this.activeCameras=null,this._activeMeshes.dispose(),this._renderingManager.dispose(),this._processedMaterials.dispose(),this._activeParticleSystems.dispose(),this._activeSkeletons.dispose(),this._softwareSkinnedMeshes.dispose(),this._renderTargets.dispose(),this._materialsRenderTargets.dispose(),this._registeredForLateAnimationBindings.dispose(),this._meshesForIntersections.dispose(),this._toBeDisposed.length=0;const t=this._activeRequests.slice();for(const n of t)n.abort();if(this._activeRequests.length=0,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderObservable.clear(),this.onAfterRenderObservable.clear(),this.onBeforeRenderTargetsRenderObservable.clear(),this.onAfterRenderTargetsRenderObservable.clear(),this.onAfterStepObservable.clear(),this.onBeforeStepObservable.clear(),this.onBeforeActiveMeshesEvaluationObservable.clear(),this.onAfterActiveMeshesEvaluationObservable.clear(),this.onBeforeParticlesRenderingObservable.clear(),this.onAfterParticlesRenderingObservable.clear(),this.onBeforeDrawPhaseObservable.clear(),this.onAfterDrawPhaseObservable.clear(),this.onBeforeAnimationsObservable.clear(),this.onAfterAnimationsObservable.clear(),this.onDataLoadedObservable.clear(),this.onBeforeRenderingGroupObservable.clear(),this.onAfterRenderingGroupObservable.clear(),this.onMeshImportedObservable.clear(),this.onBeforeCameraRenderObservable.clear(),this.onAfterCameraRenderObservable.clear(),this.onReadyObservable.clear(),this.onNewCameraAddedObservable.clear(),this.onCameraRemovedObservable.clear(),this.onNewLightAddedObservable.clear(),this.onLightRemovedObservable.clear(),this.onNewGeometryAddedObservable.clear(),this.onGeometryRemovedObservable.clear(),this.onNewTransformNodeAddedObservable.clear(),this.onTransformNodeRemovedObservable.clear(),this.onNewMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onNewSkeletonAddedObservable.clear(),this.onSkeletonRemovedObservable.clear(),this.onNewMaterialAddedObservable.clear(),this.onNewMultiMaterialAddedObservable.clear(),this.onMaterialRemovedObservable.clear(),this.onMultiMaterialRemovedObservable.clear(),this.onNewTextureAddedObservable.clear(),this.onTextureRemovedObservable.clear(),this.onPrePointerObservable.clear(),this.onPointerObservable.clear(),this.onPreKeyboardObservable.clear(),this.onKeyboardObservable.clear(),this.onActiveCameraChanged.clear(),this.onComputePressureChanged.clear(),(e=this._computePressureObserver)===null||e===void 0||e.unobserve("cpu"),this._computePressureObserver=void 0,this.detachControl(),this._engine.getInputElement())for(let n=0;n<this.cameras.length;n++)this.cameras[n].detachControl();this._disposeList(this.animationGroups),this._disposeList(this.lights),this._disposeList(this.meshes,n=>n.dispose(!0)),this._disposeList(this.transformNodes,n=>n.dispose(!0));const s=this.cameras;this._disposeList(s),this._defaultMaterial&&this._defaultMaterial.dispose(),this._disposeList(this.multiMaterials),this._disposeList(this.materials),this._disposeList(this.particleSystems),this._disposeList(this.postProcesses),this._disposeList(this.textures),this._disposeList(this.morphTargetManagers),this._sceneUbo.dispose(),this._multiviewSceneUbo&&this._multiviewSceneUbo.dispose(),this.postProcessManager.dispose(),this._disposeList(this._components);let r=this._engine.scenes.indexOf(this);r>-1&&this._engine.scenes.splice(r,1),ye._LastCreatedScene===this&&(this._engine.scenes.length>0?ye._LastCreatedScene=this._engine.scenes[this._engine.scenes.length-1]:ye._LastCreatedScene=null),r=this._engine._virtualScenes.indexOf(this),r>-1&&this._engine._virtualScenes.splice(r,1),this._engine.wipeCaches(!0),this._isDisposed=!0}_disposeList(e,t){const i=e.slice(0);t=t!=null?t:s=>s.dispose();for(const s of i)t(s);e.length=0}get isDisposed(){return this._isDisposed}clearCachedVertexData(){for(let e=0;e<this.meshes.length;e++){const i=this.meshes[e].geometry;i&&i.clearCachedData()}}cleanCachedTextureBuffer(){for(const e of this.textures)e._buffer&&(e._buffer=null)}getWorldExtends(e){const t=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),i=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return e=e||(()=>!0),this.meshes.filter(e).forEach(s=>{if(s.computeWorldMatrix(!0),!s.subMeshes||s.subMeshes.length===0||s.infiniteDistance)return;const r=s.getBoundingInfo(),n=r.boundingBox.minimumWorld,o=r.boundingBox.maximumWorld;g.CheckExtends(n,t,i),g.CheckExtends(o,t,i)}),{min:t,max:i}}createPickingRay(e,t,i,s,r=!1){throw Ve("Ray")}createPickingRayToRef(e,t,i,s,r,n=!1,o=!1){throw Ve("Ray")}createPickingRayInCameraSpace(e,t,i){throw Ve("Ray")}createPickingRayInCameraSpaceToRef(e,t,i,s){throw Ve("Ray")}pick(e,t,i,s,r,n){const o=new ki;return o._pickingUnavailable=!0,o}pickWithBoundingInfo(e,t,i,s,r){const n=new ki;return n._pickingUnavailable=!0,n}pickWithRay(e,t,i,s){throw Ve("Ray")}multiPick(e,t,i,s,r){throw Ve("Ray")}multiPickWithRay(e,t,i){throw Ve("Ray")}setPointerOverMesh(e,t,i){this._inputManager.setPointerOverMesh(e,t,i)}getPointerOverMesh(){return this._inputManager.getPointerOverMesh()}_rebuildGeometries(){for(const e of this.geometries)e._rebuild();for(const e of this.meshes)e._rebuild();this.postProcessManager&&this.postProcessManager._rebuild();for(const e of this._components)e.rebuild();for(const e of this.particleSystems)e.rebuild();if(this.spriteManagers)for(const e of this.spriteManagers)e.rebuild()}_rebuildTextures(){for(const e of this.textures)e._rebuild();this.markAllMaterialsAsDirty(1)}_getByTags(e,t,i){if(t===void 0)return e;const s=[];i=i||(r=>{});for(const r in e){const n=e[r];ot&&ot.MatchesQuery(n,t)&&(s.push(n),i(n))}return s}getMeshesByTags(e,t){return this._getByTags(this.meshes,e,t)}getCamerasByTags(e,t){return this._getByTags(this.cameras,e,t)}getLightsByTags(e,t){return this._getByTags(this.lights,e,t)}getMaterialByTags(e,t){return this._getByTags(this.materials,e,t).concat(this._getByTags(this.multiMaterials,e,t))}getTransformNodesByTags(e,t){return this._getByTags(this.transformNodes,e,t)}setRenderingOrder(e,t=null,i=null,s=null){this._renderingManager.setRenderingOrder(e,t,i,s)}setRenderingAutoClearDepthStencil(e,t,i=!0,s=!0){this._renderingManager.setRenderingAutoClearDepthStencil(e,t,i,s)}getAutoClearDepthStencilSetup(e){return this._renderingManager.getAutoClearDepthStencilSetup(e)}get blockMaterialDirtyMechanism(){return this._blockMaterialDirtyMechanism}set blockMaterialDirtyMechanism(e){this._blockMaterialDirtyMechanism!==e&&(this._blockMaterialDirtyMechanism=e,e||this.markAllMaterialsAsDirty(63))}markAllMaterialsAsDirty(e,t){if(!this._blockMaterialDirtyMechanism)for(const i of this.materials)t&&!t(i)||i.markAsDirty(e)}_loadFile(e,t,i,s,r,n,o){const l=qn(e,t,i,s?this.offlineProvider:void 0,r,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),l}_loadFileAsync(e,t,i,s,r){return new Promise((n,o)=>{this._loadFile(e,l=>{n(l)},t,i,s,(l,h)=>{o(h)},r)})}_requestFile(e,t,i,s,r,n,o){const l=Rd(e,t,i,s?this.offlineProvider:void 0,r,n,o);return this._activeRequests.push(l),l.onCompleteObservable.add(h=>{this._activeRequests.splice(this._activeRequests.indexOf(h),1)}),l}_requestFileAsync(e,t,i,s,r){return new Promise((n,o)=>{this._requestFile(e,l=>{n(l)},t,i,s,l=>{o(l)},r)})}_readFile(e,t,i,s,r){const n=Rl(e,t,i,s,r);return this._activeRequests.push(n),n.onCompleteObservable.add(o=>{this._activeRequests.splice(this._activeRequests.indexOf(o),1)}),n}_readFileAsync(e,t,i){return new Promise((s,r)=>{this._readFile(e,n=>{s(n)},t,i,n=>{r(n)})})}getPerfCollector(){throw Ve("performanceViewerSceneExtension")}}ge.FOGMODE_NONE=0;ge.FOGMODE_EXP=1;ge.FOGMODE_EXP2=2;ge.FOGMODE_LINEAR=3;ge.MinDeltaTime=1;ge.MaxDeltaTime=1e3;ge.prototype.setActiveCameraByID=function(a){return this.setActiveCameraById(a)};ge.prototype.getLastMaterialByID=function(a){return this.getLastMaterialById(a)};ge.prototype.getMaterialByID=function(a){return this.getMaterialById(a)};ge.prototype.getTextureByUniqueID=function(a){return this.getTextureByUniqueId(a)};ge.prototype.getCameraByID=function(a){return this.getCameraById(a)};ge.prototype.getCameraByUniqueID=function(a){return this.getCameraByUniqueId(a)};ge.prototype.getBoneByID=function(a){return this.getBoneById(a)};ge.prototype.getLightByID=function(a){return this.getLightById(a)};ge.prototype.getLightByUniqueID=function(a){return this.getLightByUniqueId(a)};ge.prototype.getParticleSystemByID=function(a){return this.getParticleSystemById(a)};ge.prototype.getGeometryByID=function(a){return this.getGeometryById(a)};ge.prototype.getMeshByID=function(a){return this.getMeshById(a)};ge.prototype.getMeshesByID=function(a){return this.getMeshesById(a)};ge.prototype.getTransformNodeByID=function(a){return this.getTransformNodeById(a)};ge.prototype.getTransformNodeByUniqueID=function(a){return this.getTransformNodeByUniqueId(a)};ge.prototype.getTransformNodesByID=function(a){return this.getTransformNodesById(a)};ge.prototype.getMeshByUniqueID=function(a){return this.getMeshByUniqueId(a)};ge.prototype.getLastMeshByID=function(a){return this.getLastMeshById(a)};ge.prototype.getLastEntryByID=function(a){return this.getLastEntryById(a)};ge.prototype.getNodeByID=function(a){return this.getNodeById(a)};ge.prototype.getLastSkeletonByID=function(a){return this.getLastSkeletonById(a)};class Kx{constructor(){this._doNotSerialize=!1,this._isDisposed=!1,this._sceneRootNodesIndex=-1,this._isEnabled=!0,this._isParentEnabled=!0,this._isReady=!0,this._onEnabledStateChangedObservable=new X,this._onClonedObservable=new X}}class lt{constructor(e,t=null){this._isDirty=!1,this._nodeDataStorage=new Kx,this.state="",this.metadata=null,this.reservedDataStore=null,this._parentContainer=null,this.animations=new Array,this._ranges={},this.onReady=null,this._currentRenderId=-1,this._parentUpdateId=-1,this._childUpdateId=-1,this._waitingParentId=null,this._waitingParentInstanceIndex=null,this._waitingParsedUniqueId=null,this._cache={},this._parentNode=null,this._children=null,this._worldMatrix=L.Identity(),this._worldMatrixDeterminant=0,this._worldMatrixDeterminantIsDirty=!0,this._animationPropertiesOverride=null,this._isNode=!0,this.onDisposeObservable=new X,this._onDisposeObserver=null,this._behaviors=new Array,this.name=e,this.id=e,this._scene=t||ye.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._initCache()}static AddNodeConstructor(e,t){this._NodeConstructors[e]=t}static Construct(e,t,i,s){const r=this._NodeConstructors[e];return r?r(t,i,s):null}get doNotSerialize(){return this._nodeDataStorage._doNotSerialize?!0:this._parentNode?this._parentNode.doNotSerialize:!1}set doNotSerialize(e){this._nodeDataStorage._doNotSerialize=e}isDisposed(){return this._nodeDataStorage._isDisposed}set parent(e){if(this._parentNode===e)return;const t=this._parentNode;if(this._parentNode&&this._parentNode._children!==void 0&&this._parentNode._children!==null){const i=this._parentNode._children.indexOf(this);i!==-1&&this._parentNode._children.splice(i,1),!e&&!this._nodeDataStorage._isDisposed&&this._addToSceneRootNodes()}this._parentNode=e,this._parentNode&&((this._parentNode._children===void 0||this._parentNode._children===null)&&(this._parentNode._children=new Array),this._parentNode._children.push(this),t||this._removeFromSceneRootNodes()),this._syncParentEnabledState()}get parent(){return this._parentNode}_serializeAsParent(e){e.parentId=this.uniqueId}_addToSceneRootNodes(){this._nodeDataStorage._sceneRootNodesIndex===-1&&(this._nodeDataStorage._sceneRootNodesIndex=this._scene.rootNodes.length,this._scene.rootNodes.push(this))}_removeFromSceneRootNodes(){if(this._nodeDataStorage._sceneRootNodesIndex!==-1){const e=this._scene.rootNodes,t=e.length-1;e[this._nodeDataStorage._sceneRootNodesIndex]=e[t],e[this._nodeDataStorage._sceneRootNodesIndex]._nodeDataStorage._sceneRootNodesIndex=this._nodeDataStorage._sceneRootNodesIndex,this._scene.rootNodes.pop(),this._nodeDataStorage._sceneRootNodesIndex=-1}}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}getClassName(){return"Node"}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onEnabledStateChangedObservable(){return this._nodeDataStorage._onEnabledStateChangedObservable}get onClonedObservable(){return this._nodeDataStorage._onClonedObservable}getScene(){return this._scene}getEngine(){return this._scene.getEngine()}addBehavior(e,t=!1){return this._behaviors.indexOf(e)!==-1?this:(e.init(),this._scene.isLoading&&!t?this._scene.onDataLoadedObservable.addOnce(()=>{e.attach(this)}):e.attach(this),this._behaviors.push(e),this)}removeBehavior(e){const t=this._behaviors.indexOf(e);return t===-1?this:(this._behaviors[t].detach(),this._behaviors.splice(t,1),this)}get behaviors(){return this._behaviors}getBehaviorByName(e){for(const t of this._behaviors)if(t.name===e)return t;return null}getWorldMatrix(){return this._currentRenderId!==this._scene.getRenderId()&&this.computeWorldMatrix(),this._worldMatrix}_getWorldMatrixDeterminant(){return this._worldMatrixDeterminantIsDirty&&(this._worldMatrixDeterminantIsDirty=!1,this._worldMatrixDeterminant=this._worldMatrix.determinant()),this._worldMatrixDeterminant}get worldMatrixFromCache(){return this._worldMatrix}_initCache(){this._cache={},this._cache.parent=void 0}updateCache(e){!e&&this.isSynchronized()||(this._cache.parent=this.parent,this._updateCache())}_getActionManagerForTrigger(e,t=!0){return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_updateCache(e){}_isSynchronized(){return!0}_markSyncedWithParent(){this._parentNode&&(this._parentUpdateId=this._parentNode._childUpdateId)}isSynchronizedWithParent(){return this._parentNode?this._parentNode._isDirty||this._parentUpdateId!==this._parentNode._childUpdateId?!1:this._parentNode.isSynchronized():!0}isSynchronized(){return this._cache.parent!==this._parentNode?(this._cache.parent=this._parentNode,!1):this._parentNode&&!this.isSynchronizedWithParent()?!1:this._isSynchronized()}isReady(e=!1){return this._nodeDataStorage._isReady}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}isEnabled(e=!0){return e===!1?this._nodeDataStorage._isEnabled:this._nodeDataStorage._isEnabled?this._nodeDataStorage._isParentEnabled:!1}_syncParentEnabledState(){this._nodeDataStorage._isParentEnabled=this._parentNode?this._parentNode.isEnabled():!0,this._children&&this._children.forEach(e=>{e._syncParentEnabledState()})}setEnabled(e){this._nodeDataStorage._isEnabled!==e&&(this._nodeDataStorage._isEnabled=e,this._nodeDataStorage._onEnabledStateChangedObservable.notifyObservers(e),this._syncParentEnabledState())}isDescendantOf(e){return this.parent?this.parent===e?!0:this.parent.isDescendantOf(e):!1}_getDescendants(e,t=!1,i){if(!!this._children)for(let s=0;s<this._children.length;s++){const r=this._children[s];(!i||i(r))&&e.push(r),t||r._getDescendants(e,!1,i)}}getDescendants(e,t){const i=new Array;return this._getDescendants(i,e,t),i}getChildMeshes(e,t){const i=[];return this._getDescendants(i,e,s=>(!t||t(s))&&s.cullingStrategy!==void 0),i}getChildren(e,t=!0){return this.getDescendants(t,e)}_setReady(e){if(e!==this._nodeDataStorage._isReady){if(!e){this._nodeDataStorage._isReady=!1;return}this.onReady&&this.onReady(this),this._nodeDataStorage._isReady=!0}}getAnimationByName(e){for(let t=0;t<this.animations.length;t++){const i=this.animations[t];if(i.name===e)return i}return null}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=lt._AnimationRangeFactory(e,t,i);for(let s=0,r=this.animations.length;s<r;s++)this.animations[s]&&this.animations[s].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.animations.length;i<s;i++)this.animations[i]&&this.animations[i].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}serializeAnimationRanges(){const e=[];for(const t in this._ranges){const i=this._ranges[t];if(!i)continue;const s={};s.name=t,s.from=i.from,s.to=i.to,e.push(s)}return e}computeWorldMatrix(e){return this._worldMatrix||(this._worldMatrix=L.Identity()),this._worldMatrix}dispose(e,t=!1){if(this._nodeDataStorage._isDisposed=!0,!e){const i=this.getDescendants(!0);for(const s of i)s.dispose(e,t)}this.parent?this.parent=null:this._removeFromSceneRootNodes(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onEnabledStateChangedObservable.clear(),this.onClonedObservable.clear();for(const i of this._behaviors)i.detach();this._behaviors.length=0,this.metadata=null}static ParseAnimationRanges(e,t,i){if(t.ranges)for(let s=0;s<t.ranges.length;s++){const r=t.ranges[s];e.createAnimationRange(r.name,r.from,r.to)}}getHierarchyBoundingVectors(e=!0,t=null){this.getScene().incrementRenderId(),this.computeWorldMatrix(!0);let i,s;const r=this;if(r.getBoundingInfo&&r.subMeshes){const n=r.getBoundingInfo();i=n.boundingBox.minimumWorld.clone(),s=n.boundingBox.maximumWorld.clone()}else i=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),s=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);if(e){const n=this.getDescendants(!1);for(const o of n){const l=o;if(l.computeWorldMatrix(!0),t&&!t(l)||!l.getBoundingInfo||l.getTotalVertices()===0)continue;const c=l.getBoundingInfo().boundingBox,u=c.minimumWorld,d=c.maximumWorld;g.CheckExtends(u,i,s),g.CheckExtends(d,i,s)}}return{min:i,max:s}}}lt._AnimationRangeFactory=(a,e,t)=>{throw Ve("AnimationRange")};lt._NodeConstructors={};T([R()],lt.prototype,"name",void 0);T([R()],lt.prototype,"id",void 0);T([R()],lt.prototype,"uniqueId",void 0);T([R()],lt.prototype,"state",void 0);T([R()],lt.prototype,"metadata",void 0);class ke extends lt{constructor(e,t=null,i=!0){super(e,t),this._forward=new g(0,0,1),this._up=new g(0,1,0),this._right=new g(1,0,0),this._position=g.Zero(),this._rotation=g.Zero(),this._rotationQuaternion=null,this._scaling=g.One(),this._transformToBoneReferal=null,this._isAbsoluteSynced=!1,this._billboardMode=ke.BILLBOARDMODE_NONE,this._preserveParentRotationForBillboard=!1,this.scalingDeterminant=1,this._infiniteDistance=!1,this.ignoreNonUniformScaling=!1,this.reIntegrateRotationIntoRotationQuaternion=!1,this._poseMatrix=null,this._localMatrix=L.Zero(),this._usePivotMatrix=!1,this._absolutePosition=g.Zero(),this._absoluteScaling=g.Zero(),this._absoluteRotationQuaternion=Q.Identity(),this._pivotMatrix=L.Identity(),this._postMultiplyPivotMatrix=!1,this._isWorldMatrixFrozen=!1,this._indexInSceneTransformNodesArray=-1,this.onAfterWorldMatrixUpdateObservable=new X,this._nonUniformScaling=!1,i&&this.getScene().addTransformNode(this)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e)}get preserveParentRotationForBillboard(){return this._preserveParentRotationForBillboard}set preserveParentRotationForBillboard(e){e!==this._preserveParentRotationForBillboard&&(this._preserveParentRotationForBillboard=e)}get infiniteDistance(){return this._infiniteDistance}set infiniteDistance(e){this._infiniteDistance!==e&&(this._infiniteDistance=e)}getClassName(){return"TransformNode"}get position(){return this._position}set position(e){this._position=e,this._isDirty=!0}isUsingPivotMatrix(){return this._usePivotMatrix}get rotation(){return this._rotation}set rotation(e){this._rotation=e,this._rotationQuaternion=null,this._isDirty=!0}get scaling(){return this._scaling}set scaling(e){this._scaling=e,this._isDirty=!0}get rotationQuaternion(){return this._rotationQuaternion}set rotationQuaternion(e){this._rotationQuaternion=e,e&&this._rotation.setAll(0),this._isDirty=!0}get forward(){return g.TransformNormalFromFloatsToRef(0,0,this.getScene().useRightHandedSystem?-1:1,this.getWorldMatrix(),this._forward),this._forward.normalize()}get up(){return g.TransformNormalFromFloatsToRef(0,1,0,this.getWorldMatrix(),this._up),this._up.normalize()}get right(){return g.TransformNormalFromFloatsToRef(this.getScene().useRightHandedSystem?-1:1,0,0,this.getWorldMatrix(),this._right),this._right.normalize()}updatePoseMatrix(e){return this._poseMatrix?(this._poseMatrix.copyFrom(e),this):(this._poseMatrix=e.clone(),this)}getPoseMatrix(){return this._poseMatrix||(this._poseMatrix=L.Identity()),this._poseMatrix}_isSynchronized(){const e=this._cache;return!(this._billboardMode!==e.billboardMode||this._billboardMode!==ke.BILLBOARDMODE_NONE||e.pivotMatrixUpdated||this._infiniteDistance||this._position._isDirty||this._scaling._isDirty||this._rotationQuaternion&&this._rotationQuaternion._isDirty||this._rotation._isDirty)}_initCache(){super._initCache();const e=this._cache;e.localMatrixUpdated=!1,e.billboardMode=-1,e.infiniteDistance=!1}get absolutePosition(){return this.getAbsolutePosition()}get absoluteScaling(){return this._syncAbsoluteScalingAndRotation(),this._absoluteScaling}get absoluteRotationQuaternion(){return this._syncAbsoluteScalingAndRotation(),this._absoluteRotationQuaternion}setPreTransformMatrix(e){return this.setPivotMatrix(e,!1)}setPivotMatrix(e,t=!0){return this._pivotMatrix.copyFrom(e),this._usePivotMatrix=!this._pivotMatrix.isIdentity(),this._cache.pivotMatrixUpdated=!0,this._postMultiplyPivotMatrix=t,this._postMultiplyPivotMatrix&&(this._pivotMatrixInverse?this._pivotMatrix.invertToRef(this._pivotMatrixInverse):this._pivotMatrixInverse=L.Invert(this._pivotMatrix)),this}getPivotMatrix(){return this._pivotMatrix}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0);s&&i&&i(this,s);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,t,i);return s}freezeWorldMatrix(e=null,t=!1){return e?t?(this._rotation.setAll(0),this._rotationQuaternion=this._rotationQuaternion||Q.Identity(),e.decompose(this._scaling,this._rotationQuaternion,this._position),this.computeWorldMatrix(!0)):(this._worldMatrix=e,this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._afterComputeWorldMatrix()):(this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0)),this._isDirty=!1,this._isWorldMatrixFrozen=!0,this}unfreezeWorldMatrix(){return this._isWorldMatrixFrozen=!1,this.computeWorldMatrix(!0),this}get isWorldMatrixFrozen(){return this._isWorldMatrixFrozen}getAbsolutePosition(){return this.computeWorldMatrix(),this._absolutePosition}setAbsolutePosition(e){if(!e)return this;let t,i,s;if(e.x===void 0){if(arguments.length<3)return this;t=arguments[0],i=arguments[1],s=arguments[2]}else t=e.x,i=e.y,s=e.z;if(this.parent){const r=G.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),g.TransformCoordinatesFromFloatsToRef(t,i,s,r,this.position)}else this.position.x=t,this.position.y=i,this.position.z=s;return this._absolutePosition.copyFrom(e),this}setPositionWithLocalVector(e){return this.computeWorldMatrix(),this.position=g.TransformNormal(e,this._localMatrix),this}getPositionExpressedInLocalSpace(){this.computeWorldMatrix();const e=G.Matrix[0];return this._localMatrix.invertToRef(e),g.TransformNormal(this.position,e)}locallyTranslate(e){return this.computeWorldMatrix(!0),this.position=g.TransformCoordinates(e,this._localMatrix),this}lookAt(e,t=0,i=0,s=0,r=Ze.LOCAL){const n=ke._LookAtVectorCache,o=r===Ze.LOCAL?this.position:this.getAbsolutePosition();if(e.subtractToRef(o,n),this.setDirection(n,t,i,s),r===Ze.WORLD&&this.parent)if(this.rotationQuaternion){const l=G.Matrix[0];this.rotationQuaternion.toRotationMatrix(l);const h=G.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(h),h.invert(),l.multiplyToRef(h,l),this.rotationQuaternion.fromRotationMatrix(l)}else{const l=G.Quaternion[0];Q.FromEulerVectorToRef(this.rotation,l);const h=G.Matrix[0];l.toRotationMatrix(h);const c=G.Matrix[1];this.parent.getWorldMatrix().getRotationMatrixToRef(c),c.invert(),h.multiplyToRef(c,h),l.fromRotationMatrix(h),l.toEulerAnglesToRef(this.rotation)}return this}getDirection(e){const t=g.Zero();return this.getDirectionToRef(e,t),t}getDirectionToRef(e,t){return g.TransformNormalToRef(e,this.getWorldMatrix(),t),this}setDirection(e,t=0,i=0,s=0){const r=-Math.atan2(e.z,e.x)+Math.PI/2,n=Math.sqrt(e.x*e.x+e.z*e.z),o=-Math.atan2(e.y,n);return this.rotationQuaternion?Q.RotationYawPitchRollToRef(r+t,o+i,s,this.rotationQuaternion):(this.rotation.x=o+i,this.rotation.y=r+t,this.rotation.z=s),this}setPivotPoint(e,t=Ze.LOCAL){this.getScene().getRenderId()==0&&this.computeWorldMatrix(!0);const i=this.getWorldMatrix();if(t==Ze.WORLD){const s=G.Matrix[0];i.invertToRef(s),e=g.TransformCoordinates(e,s)}return this.setPivotMatrix(L.Translation(-e.x,-e.y,-e.z),!0)}getPivotPoint(){const e=g.Zero();return this.getPivotPointToRef(e),e}getPivotPointToRef(e){return e.x=-this._pivotMatrix.m[12],e.y=-this._pivotMatrix.m[13],e.z=-this._pivotMatrix.m[14],this}getAbsolutePivotPoint(){const e=g.Zero();return this.getAbsolutePivotPointToRef(e),e}getAbsolutePivotPointToRef(e){return this.getPivotPointToRef(e),g.TransformCoordinatesToRef(e,this.getWorldMatrix(),e),this}markAsDirty(e){if(this._isDirty)return this;if(this._children)for(const t of this._children)t.markAsDirty(e);return super.markAsDirty(e)}setParent(e,t=!1,i=!1){if(!e&&!this.parent)return this;const s=G.Quaternion[0],r=G.Vector3[0],n=G.Vector3[1],o=G.Matrix[1];L.IdentityToRef(o);const l=G.Matrix[0];this.computeWorldMatrix(!0);let h=this.rotationQuaternion;return h||(h=ke._TmpRotation,Q.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,h)),L.ComposeToRef(this.scaling,h,this.position,l),this.parent&&l.multiplyToRef(this.parent.computeWorldMatrix(!0),l),e&&(e.computeWorldMatrix(!0).invertToRef(o),l.multiplyToRef(o,l)),l.decompose(n,s,r,t?this:void 0),this.rotationQuaternion?this.rotationQuaternion.copyFrom(s):s.toEulerAnglesToRef(this.rotation),this.scaling.copyFrom(n),this.position.copyFrom(r),this.parent=e,i&&this.setPivotMatrix(L.Identity()),this}get nonUniformScaling(){return this._nonUniformScaling}_updateNonUniformScalingState(e){return this._nonUniformScaling===e?!1:(this._nonUniformScaling=e,!0)}attachToBone(e,t){return this._currentParentWhenAttachingToBone=this.parent,this._transformToBoneReferal=t,this.parent=e,e.getSkeleton().prepare(),e.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this}detachFromBone(e=!1){return this.parent?(this.parent.getWorldMatrix().determinant()<0&&(this.scalingDeterminant*=-1),this._transformToBoneReferal=null,e?this.parent=this._currentParentWhenAttachingToBone:this.parent=null,this):(e&&(this.parent=this._currentParentWhenAttachingToBone),this)}rotate(e,t,i){e.normalize(),this.rotationQuaternion||(this.rotationQuaternion=this.rotation.toQuaternion(),this.rotation.setAll(0));let s;if(!i||i===Ze.LOCAL)s=Q.RotationAxisToRef(e,t,ke._RotationAxisCache),this.rotationQuaternion.multiplyToRef(s,this.rotationQuaternion);else{if(this.parent){const r=G.Matrix[0];this.parent.getWorldMatrix().invertToRef(r),e=g.TransformNormal(e,r)}s=Q.RotationAxisToRef(e,t,ke._RotationAxisCache),s.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}return this}rotateAround(e,t,i){t.normalize(),this.rotationQuaternion||(this.rotationQuaternion=Q.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z),this.rotation.setAll(0));const s=G.Vector3[0],r=G.Vector3[1],n=G.Vector3[2],o=G.Quaternion[0],l=G.Matrix[0],h=G.Matrix[1],c=G.Matrix[2],u=G.Matrix[3];return e.subtractToRef(this.position,s),L.TranslationToRef(s.x,s.y,s.z,l),L.TranslationToRef(-s.x,-s.y,-s.z,h),L.RotationAxisToRef(t,i,c),h.multiplyToRef(c,u),u.multiplyToRef(l,u),u.decompose(r,o,n),this.position.addInPlace(n),o.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion),this}translate(e,t,i){const s=e.scale(t);if(!i||i===Ze.LOCAL){const r=this.getPositionExpressedInLocalSpace().add(s);this.setPositionWithLocalVector(r)}else this.setAbsolutePosition(this.getAbsolutePosition().add(s));return this}addRotation(e,t,i){let s;this.rotationQuaternion?s=this.rotationQuaternion:(s=G.Quaternion[1],Q.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,s));const r=G.Quaternion[0];return Q.RotationYawPitchRollToRef(t,e,i,r),s.multiplyInPlace(r),this.rotationQuaternion||s.toEulerAnglesToRef(this.rotation),this}_getEffectiveParent(){return this.parent}computeWorldMatrix(e){if(this._isWorldMatrixFrozen&&!this._isDirty)return this._worldMatrix;const t=this.getScene().getRenderId();if(!this._isDirty&&!e&&(this._currentRenderId===t||this.isSynchronized()))return this._currentRenderId=t,this._worldMatrix;const i=this.getScene().activeCamera,s=(this._billboardMode&ke.BILLBOARDMODE_USE_POSITION)!==0,r=this._billboardMode!==ke.BILLBOARDMODE_NONE&&!this.preserveParentRotationForBillboard;this._updateCache();const n=this._cache;n.pivotMatrixUpdated=!1,n.billboardMode=this.billboardMode,n.infiniteDistance=this.infiniteDistance,n.parent=this._parentNode,this._currentRenderId=t,this._childUpdateId+=1,this._isDirty=!1,this._position._isDirty=!1,this._rotation._isDirty=!1,this._scaling._isDirty=!1;const o=this._getEffectiveParent(),l=ke._TmpScaling;let h=this._position;if(this._infiniteDistance&&!this.parent&&i){const u=i.getWorldMatrix(),d=new g(u.m[12],u.m[13],u.m[14]);h=ke._TmpTranslation,h.copyFromFloats(this._position.x+d.x,this._position.y+d.y,this._position.z+d.z)}l.copyFromFloats(this._scaling.x*this.scalingDeterminant,this._scaling.y*this.scalingDeterminant,this._scaling.z*this.scalingDeterminant);let c;if(this._rotationQuaternion?(this._rotationQuaternion._isDirty=!1,c=this._rotationQuaternion,this.reIntegrateRotationIntoRotationQuaternion&&this.rotation.lengthSquared()&&(this._rotationQuaternion.multiplyInPlace(Q.RotationYawPitchRoll(this._rotation.y,this._rotation.x,this._rotation.z)),this._rotation.copyFromFloats(0,0,0))):(c=ke._TmpRotation,Q.RotationYawPitchRollToRef(this._rotation.y,this._rotation.x,this._rotation.z,c)),this._usePivotMatrix){const u=G.Matrix[1];L.ScalingToRef(l.x,l.y,l.z,u);const d=G.Matrix[0];c.toRotationMatrix(d),this._pivotMatrix.multiplyToRef(u,G.Matrix[4]),G.Matrix[4].multiplyToRef(d,this._localMatrix),this._postMultiplyPivotMatrix&&this._localMatrix.multiplyToRef(this._pivotMatrixInverse,this._localMatrix),this._localMatrix.addTranslationFromFloats(h.x,h.y,h.z)}else L.ComposeToRef(l,c,h,this._localMatrix);if(o&&o.getWorldMatrix){if(e&&o.computeWorldMatrix(e),r){this._transformToBoneReferal?o.getWorldMatrix().multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),G.Matrix[7]):G.Matrix[7].copyFrom(o.getWorldMatrix());const u=G.Vector3[5],d=G.Vector3[6],f=G.Quaternion[0];G.Matrix[7].decompose(d,f,u),L.ScalingToRef(d.x,d.y,d.z,G.Matrix[7]),G.Matrix[7].setTranslation(u),ke.BillboardUseParentOrientation&&(this._position.applyRotationQuaternionToRef(f,u),this._localMatrix.setTranslation(u)),this._localMatrix.multiplyToRef(G.Matrix[7],this._worldMatrix)}else this._transformToBoneReferal?(this._localMatrix.multiplyToRef(o.getWorldMatrix(),G.Matrix[6]),G.Matrix[6].multiplyToRef(this._transformToBoneReferal.getWorldMatrix(),this._worldMatrix)):this._localMatrix.multiplyToRef(o.getWorldMatrix(),this._worldMatrix);this._markSyncedWithParent()}else this._worldMatrix.copyFrom(this._localMatrix);if(r&&i&&this.billboardMode&&!s){const u=G.Vector3[0];if(this._worldMatrix.getTranslationToRef(u),G.Matrix[1].copyFrom(i.getViewMatrix()),G.Matrix[1].setTranslationFromFloats(0,0,0),G.Matrix[1].invertToRef(G.Matrix[0]),(this.billboardMode&ke.BILLBOARDMODE_ALL)!==ke.BILLBOARDMODE_ALL){G.Matrix[0].decompose(void 0,G.Quaternion[0],void 0);const d=G.Vector3[1];G.Quaternion[0].toEulerAnglesToRef(d),(this.billboardMode&ke.BILLBOARDMODE_X)!==ke.BILLBOARDMODE_X&&(d.x=0),(this.billboardMode&ke.BILLBOARDMODE_Y)!==ke.BILLBOARDMODE_Y&&(d.y=0),(this.billboardMode&ke.BILLBOARDMODE_Z)!==ke.BILLBOARDMODE_Z&&(d.z=0),L.RotationYawPitchRollToRef(d.y,d.x,d.z,G.Matrix[0])}this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(G.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(G.Vector3[0])}else if(r&&i&&this.billboardMode&&s){const u=G.Vector3[0];this._worldMatrix.getTranslationToRef(u);const d=i.globalPosition;this._worldMatrix.invertToRef(G.Matrix[1]);const f=G.Vector3[1];g.TransformCoordinatesToRef(d,G.Matrix[1],f),f.normalize();const p=-Math.atan2(f.z,f.x)+Math.PI/2,_=Math.sqrt(f.x*f.x+f.z*f.z),m=-Math.atan2(f.y,_);if(Q.RotationYawPitchRollToRef(p,m,0,G.Quaternion[0]),(this.billboardMode&ke.BILLBOARDMODE_ALL)!==ke.BILLBOARDMODE_ALL){const v=G.Vector3[1];G.Quaternion[0].toEulerAnglesToRef(v),(this.billboardMode&ke.BILLBOARDMODE_X)!==ke.BILLBOARDMODE_X&&(v.x=0),(this.billboardMode&ke.BILLBOARDMODE_Y)!==ke.BILLBOARDMODE_Y&&(v.y=0),(this.billboardMode&ke.BILLBOARDMODE_Z)!==ke.BILLBOARDMODE_Z&&(v.z=0),L.RotationYawPitchRollToRef(v.y,v.x,v.z,G.Matrix[0])}else L.FromQuaternionToRef(G.Quaternion[0],G.Matrix[0]);this._worldMatrix.setTranslationFromFloats(0,0,0),this._worldMatrix.multiplyToRef(G.Matrix[0],this._worldMatrix),this._worldMatrix.setTranslation(G.Vector3[0])}return this.ignoreNonUniformScaling?this._updateNonUniformScalingState(!1):this._scaling.isNonUniformWithinEpsilon(1e-6)?this._updateNonUniformScalingState(!0):o&&o._nonUniformScaling?this._updateNonUniformScalingState(o._nonUniformScaling):this._updateNonUniformScalingState(!1),this._afterComputeWorldMatrix(),this._absolutePosition.copyFromFloats(this._worldMatrix.m[12],this._worldMatrix.m[13],this._worldMatrix.m[14]),this._isAbsoluteSynced=!1,this.onAfterWorldMatrixUpdateObservable.notifyObservers(this),this._poseMatrix||(this._poseMatrix=L.Invert(this._worldMatrix)),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix}resetLocalMatrix(e=!0){if(this.computeWorldMatrix(),e){const t=this.getChildren();for(let i=0;i<t.length;++i){const s=t[i];if(s){s.computeWorldMatrix();const r=G.Matrix[0];s._localMatrix.multiplyToRef(this._localMatrix,r);const n=G.Quaternion[0];r.decompose(s.scaling,n,s.position),s.rotationQuaternion?s.rotationQuaternion.copyFrom(n):n.toEulerAnglesToRef(s.rotation)}}}this.scaling.copyFromFloats(1,1,1),this.position.copyFromFloats(0,0,0),this.rotation.copyFromFloats(0,0,0),this.rotationQuaternion&&(this.rotationQuaternion=Q.Identity()),this._worldMatrix=L.Identity()}_afterComputeWorldMatrix(){}registerAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.add(e),this}unregisterAfterWorldMatrixUpdate(e){return this.onAfterWorldMatrixUpdateObservable.removeCallback(e),this}getPositionInCameraSpace(e=null){return e||(e=this.getScene().activeCamera),g.TransformCoordinates(this.getAbsolutePosition(),e.getViewMatrix())}getDistanceToCamera(e=null){return e||(e=this.getScene().activeCamera),this.getAbsolutePosition().subtract(e.globalPosition).length()}clone(e,t,i){const s=xe.Clone(()=>new ke(e,this.getScene()),this);if(s.name=e,s.id=e,t&&(s.parent=t),!i){const r=this.getDescendants(!0);for(let n=0;n<r.length;n++){const o=r[n];o.clone&&o.clone(e+"."+o.name,s)}}return s}serialize(e){const t=xe.Serialize(this,e);return t.type=this.getClassName(),t.uniqueId=this.uniqueId,this.parent&&this.parent._serializeAsParent(t),t.localMatrix=this.getPivotMatrix().asArray(),t.isEnabled=this.isEnabled(),t}static Parse(e,t,i){const s=xe.Parse(()=>new ke(e.name,t),e,t,i);return e.localMatrix?s.setPreTransformMatrix(L.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(L.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s._waitingParsedUniqueId=e.uniqueId,e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),s}getChildTransformNodes(e,t){const i=[];return this._getDescendants(i,e,s=>(!t||t(s))&&s instanceof ke),i}dispose(e,t=!1){if(this.getScene().stopAnimation(this),this.getScene().removeTransformNode(this),this._parentContainer){const i=this._parentContainer.transformNodes.indexOf(this);i>-1&&this._parentContainer.transformNodes.splice(i,1),this._parentContainer=null}if(this.onAfterWorldMatrixUpdateObservable.clear(),e){const i=this.getChildTransformNodes(!0);for(const s of i)s.parent=null,s.computeWorldMatrix(!0)}super.dispose(e,t)}normalizeToUnitCube(e=!0,t=!1,i){let s=null,r=null;t&&(this.rotationQuaternion?(r=this.rotationQuaternion.clone(),this.rotationQuaternion.copyFromFloats(0,0,0,1)):this.rotation&&(s=this.rotation.clone(),this.rotation.copyFromFloats(0,0,0)));const n=this.getHierarchyBoundingVectors(e,i),o=n.max.subtract(n.min),l=Math.max(o.x,o.y,o.z);if(l===0)return this;const h=1/l;return this.scaling.scaleInPlace(h),t&&(this.rotationQuaternion&&r?this.rotationQuaternion.copyFrom(r):this.rotation&&s&&this.rotation.copyFrom(s)),this}_syncAbsoluteScalingAndRotation(){this._isAbsoluteSynced||(this._worldMatrix.decompose(this._absoluteScaling,this._absoluteRotationQuaternion),this._isAbsoluteSynced=!0)}}ke.BILLBOARDMODE_NONE=0;ke.BILLBOARDMODE_X=1;ke.BILLBOARDMODE_Y=2;ke.BILLBOARDMODE_Z=4;ke.BILLBOARDMODE_ALL=7;ke.BILLBOARDMODE_USE_POSITION=128;ke.BillboardUseParentOrientation=!1;ke._TmpRotation=Q.Zero();ke._TmpScaling=g.Zero();ke._TmpTranslation=g.Zero();ke._LookAtVectorCache=new g(0,0,0);ke._RotationAxisCache=new Q;T([Zi("position")],ke.prototype,"_position",void 0);T([Zi("rotation")],ke.prototype,"_rotation",void 0);T([px("rotationQuaternion")],ke.prototype,"_rotationQuaternion",void 0);T([Zi("scaling")],ke.prototype,"_scaling",void 0);T([R("billboardMode")],ke.prototype,"_billboardMode",void 0);T([R()],ke.prototype,"scalingDeterminant",void 0);T([R("infiniteDistance")],ke.prototype,"_infiniteDistance",void 0);T([R()],ke.prototype,"ignoreNonUniformScaling",void 0);T([R()],ke.prototype,"reIntegrateRotationIntoRotationQuaternion",void 0);function qh(a,e,t){try{const i=a.next();i.done?e(i):i.value?i.value.then(()=>{i.value=void 0,e(i)},t):e(i)}catch(i){t(i)}}function $x(a=25){let e;return(t,i,s)=>{const r=performance.now();e===void 0||r-e>a?(e=r,setTimeout(()=>{qh(t,i,s)},0)):qh(t,i,s)}}function x_(a,e,t,i,s){const r=()=>{let n;const o=l=>{l.done?t(l.value):n===void 0?n=!0:r()};do n=void 0,!s||!s.aborted?e(a,o,i):i(new Error("Aborted")),n===void 0&&(n=!1);while(n)};r()}function kd(a,e){let t;return x_(a,qh,i=>t=i,i=>{throw i},e),t}function T_(a,e,t){return new Promise((i,s)=>{x_(a,e,i,s,t)})}function jx(a,e){return(...t)=>kd(a(...t),e)}class de{constructor(){this._applyTo=jx(this._applyToCoroutine.bind(this))}set(e,t){switch(e.length||B.Warn(`Setting vertex data kind '${t}' with an empty array`),t){case y.PositionKind:this.positions=e;break;case y.NormalKind:this.normals=e;break;case y.TangentKind:this.tangents=e;break;case y.UVKind:this.uvs=e;break;case y.UV2Kind:this.uvs2=e;break;case y.UV3Kind:this.uvs3=e;break;case y.UV4Kind:this.uvs4=e;break;case y.UV5Kind:this.uvs5=e;break;case y.UV6Kind:this.uvs6=e;break;case y.ColorKind:this.colors=e;break;case y.MatricesIndicesKind:this.matricesIndices=e;break;case y.MatricesWeightsKind:this.matricesWeights=e;break;case y.MatricesIndicesExtraKind:this.matricesIndicesExtra=e;break;case y.MatricesWeightsExtraKind:this.matricesWeightsExtra=e;break}}applyToMesh(e,t){return this._applyTo(e,t,!1),this}applyToGeometry(e,t){return this._applyTo(e,t,!1),this}updateMesh(e){return this._update(e),this}updateGeometry(e){return this._update(e),this}*_applyToCoroutine(e,t=!1,i){return this.positions&&(e.setVerticesData(y.PositionKind,this.positions,t),i&&(yield)),this.normals&&(e.setVerticesData(y.NormalKind,this.normals,t),i&&(yield)),this.tangents&&(e.setVerticesData(y.TangentKind,this.tangents,t),i&&(yield)),this.uvs&&(e.setVerticesData(y.UVKind,this.uvs,t),i&&(yield)),this.uvs2&&(e.setVerticesData(y.UV2Kind,this.uvs2,t),i&&(yield)),this.uvs3&&(e.setVerticesData(y.UV3Kind,this.uvs3,t),i&&(yield)),this.uvs4&&(e.setVerticesData(y.UV4Kind,this.uvs4,t),i&&(yield)),this.uvs5&&(e.setVerticesData(y.UV5Kind,this.uvs5,t),i&&(yield)),this.uvs6&&(e.setVerticesData(y.UV6Kind,this.uvs6,t),i&&(yield)),this.colors&&(e.setVerticesData(y.ColorKind,this.colors,t),i&&(yield)),this.matricesIndices&&(e.setVerticesData(y.MatricesIndicesKind,this.matricesIndices,t),i&&(yield)),this.matricesWeights&&(e.setVerticesData(y.MatricesWeightsKind,this.matricesWeights,t),i&&(yield)),this.matricesIndicesExtra&&(e.setVerticesData(y.MatricesIndicesExtraKind,this.matricesIndicesExtra,t),i&&(yield)),this.matricesWeightsExtra&&(e.setVerticesData(y.MatricesWeightsExtraKind,this.matricesWeightsExtra,t),i&&(yield)),this.indices?(e.setIndices(this.indices,null,t),i&&(yield)):e.setIndices([],null),this}_update(e,t,i){return this.positions&&e.updateVerticesData(y.PositionKind,this.positions,t,i),this.normals&&e.updateVerticesData(y.NormalKind,this.normals,t,i),this.tangents&&e.updateVerticesData(y.TangentKind,this.tangents,t,i),this.uvs&&e.updateVerticesData(y.UVKind,this.uvs,t,i),this.uvs2&&e.updateVerticesData(y.UV2Kind,this.uvs2,t,i),this.uvs3&&e.updateVerticesData(y.UV3Kind,this.uvs3,t,i),this.uvs4&&e.updateVerticesData(y.UV4Kind,this.uvs4,t,i),this.uvs5&&e.updateVerticesData(y.UV5Kind,this.uvs5,t,i),this.uvs6&&e.updateVerticesData(y.UV6Kind,this.uvs6,t,i),this.colors&&e.updateVerticesData(y.ColorKind,this.colors,t,i),this.matricesIndices&&e.updateVerticesData(y.MatricesIndicesKind,this.matricesIndices,t,i),this.matricesWeights&&e.updateVerticesData(y.MatricesWeightsKind,this.matricesWeights,t,i),this.matricesIndicesExtra&&e.updateVerticesData(y.MatricesIndicesExtraKind,this.matricesIndicesExtra,t,i),this.matricesWeightsExtra&&e.updateVerticesData(y.MatricesWeightsExtraKind,this.matricesWeightsExtra,t,i),this.indices&&e.setIndices(this.indices,null),this}static _TransformVector3Coordinates(e,t,i=0,s=e.length){const r=G.Vector3[0],n=G.Vector3[1];for(let o=i;o<i+s;o+=3)g.FromArrayToRef(e,o,r),g.TransformCoordinatesToRef(r,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector3Normals(e,t,i=0,s=e.length){const r=G.Vector3[0],n=G.Vector3[1];for(let o=i;o<i+s;o+=3)g.FromArrayToRef(e,o,r),g.TransformNormalToRef(r,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z}static _TransformVector4Normals(e,t,i=0,s=e.length){const r=G.Vector4[0],n=G.Vector4[1];for(let o=i;o<i+s;o+=4)Ge.FromArrayToRef(e,o,r),Ge.TransformNormalToRef(r,t,n),e[o]=n.x,e[o+1]=n.y,e[o+2]=n.z,e[o+3]=n.w}static _FlipFaces(e,t=0,i=e.length){for(let s=t;s<t+i;s+=3){const r=e[s+1];e[s+1]=e[s+2],e[s+2]=r}}transform(e){const t=e.determinant()<0;return this.positions&&de._TransformVector3Coordinates(this.positions,e),this.normals&&de._TransformVector3Normals(this.normals,e),this.tangents&&de._TransformVector4Normals(this.tangents,e),t&&this.indices&&de._FlipFaces(this.indices),this}merge(e,t=!1,i=!1){const s=Array.isArray(e)?e.map(r=>[r,void 0]):[[e,void 0]];return kd(this._mergeCoroutine(void 0,s,t,!1,i))}*_mergeCoroutine(e,t,i=!1,s,r){var n,o,l,h;this._validate();const c=t.map(p=>p[0]);for(const p of c)if(p._validate(),!this.normals!=!p.normals||!this.tangents!=!p.tangents||!this.uvs!=!p.uvs||!this.uvs2!=!p.uvs2||!this.uvs3!=!p.uvs3||!this.uvs4!=!p.uvs4||!this.uvs5!=!p.uvs5||!this.uvs6!=!p.uvs6||!this.colors!=!p.colors||!this.matricesIndices!=!p.matricesIndices||!this.matricesWeights!=!p.matricesWeights||!this.matricesIndicesExtra!=!p.matricesIndicesExtra||!this.matricesWeightsExtra!=!p.matricesWeightsExtra)throw new Error("Cannot merge vertex data that do not have the same set of attributes");const u=c.reduce((p,_)=>{var m,v;return p+((v=(m=_.indices)===null||m===void 0?void 0:m.length)!==null&&v!==void 0?v:0)},(o=(n=this.indices)===null||n===void 0?void 0:n.length)!==null&&o!==void 0?o:0);let f=r||c.some(p=>p.indices===this.indices)?(l=this.indices)===null||l===void 0?void 0:l.slice():this.indices;if(u>0){let p=(h=f==null?void 0:f.length)!==null&&h!==void 0?h:0;if(f||(f=new Array(u)),f.length!==u){if(Array.isArray(f))f.length=u;else{const m=i||f instanceof Uint32Array?new Uint32Array(u):new Uint16Array(u);m.set(f),f=m}e&&e.determinant()<0&&de._FlipFaces(f,0,p)}let _=this.positions?this.positions.length/3:0;for(const[m,v]of t)if(m.indices){for(let x=0;x<m.indices.length;x++)f[p+x]=m.indices[x]+_;v&&v.determinant()<0&&de._FlipFaces(f,p,m.indices.length),_+=m.positions.length/3,p+=m.indices.length,s&&(yield)}}return this.indices=f,this.positions=de._MergeElement(y.PositionKind,this.positions,e,t.map(p=>[p[0].positions,p[1]])),s&&(yield),this.normals=de._MergeElement(y.NormalKind,this.normals,e,t.map(p=>[p[0].normals,p[1]])),s&&(yield),this.tangents=de._MergeElement(y.TangentKind,this.tangents,e,t.map(p=>[p[0].tangents,p[1]])),s&&(yield),this.uvs=de._MergeElement(y.UVKind,this.uvs,e,t.map(p=>[p[0].uvs,p[1]])),s&&(yield),this.uvs2=de._MergeElement(y.UV2Kind,this.uvs2,e,t.map(p=>[p[0].uvs2,p[1]])),s&&(yield),this.uvs3=de._MergeElement(y.UV3Kind,this.uvs3,e,t.map(p=>[p[0].uvs3,p[1]])),s&&(yield),this.uvs4=de._MergeElement(y.UV4Kind,this.uvs4,e,t.map(p=>[p[0].uvs4,p[1]])),s&&(yield),this.uvs5=de._MergeElement(y.UV5Kind,this.uvs5,e,t.map(p=>[p[0].uvs5,p[1]])),s&&(yield),this.uvs6=de._MergeElement(y.UV6Kind,this.uvs6,e,t.map(p=>[p[0].uvs6,p[1]])),s&&(yield),this.colors=de._MergeElement(y.ColorKind,this.colors,e,t.map(p=>[p[0].colors,p[1]])),s&&(yield),this.matricesIndices=de._MergeElement(y.MatricesIndicesKind,this.matricesIndices,e,t.map(p=>[p[0].matricesIndices,p[1]])),s&&(yield),this.matricesWeights=de._MergeElement(y.MatricesWeightsKind,this.matricesWeights,e,t.map(p=>[p[0].matricesWeights,p[1]])),s&&(yield),this.matricesIndicesExtra=de._MergeElement(y.MatricesIndicesExtraKind,this.matricesIndicesExtra,e,t.map(p=>[p[0].matricesIndicesExtra,p[1]])),s&&(yield),this.matricesWeightsExtra=de._MergeElement(y.MatricesWeightsExtraKind,this.matricesWeightsExtra,e,t.map(p=>[p[0].matricesWeightsExtra,p[1]])),this}static _MergeElement(e,t,i,s){const r=s.filter(l=>l[0]!==null&&l[0]!==void 0);if(!t&&r.length==0)return t;if(!t)return this._MergeElement(e,r[0][0],r[0][1],r.slice(1));const n=r.reduce((l,h)=>l+h[0].length,t.length),o=e===y.PositionKind?de._TransformVector3Coordinates:e===y.NormalKind?de._TransformVector3Normals:e===y.TangentKind?de._TransformVector4Normals:()=>{};if(t instanceof Float32Array){const l=new Float32Array(n);l.set(t),i&&o(l,i,0,t.length);let h=t.length;for(const[c,u]of r)l.set(c,h),u&&o(l,u,h,c.length),h+=c.length;return l}else{const l=new Array(n);for(let c=0;c<t.length;c++)l[c]=t[c];i&&o(l,i,0,t.length);let h=t.length;for(const[c,u]of r){for(let d=0;d<c.length;d++)l[h+d]=c[d];u&&o(l,u,h,c.length),h+=c.length}return l}}_validate(){if(!this.positions)throw new Xr("Positions are required",Hn.MeshInvalidPositionsError);const e=(s,r)=>{const n=y.DeduceStride(s);if(r.length%n!==0)throw new Error("The "+s+"s array count must be a multiple of "+n);return r.length/n},t=e(y.PositionKind,this.positions),i=(s,r)=>{const n=e(s,r);if(n!==t)throw new Error("The "+s+"s element count ("+n+") does not match the positions count ("+t+")")};this.normals&&i(y.NormalKind,this.normals),this.tangents&&i(y.TangentKind,this.tangents),this.uvs&&i(y.UVKind,this.uvs),this.uvs2&&i(y.UV2Kind,this.uvs2),this.uvs3&&i(y.UV3Kind,this.uvs3),this.uvs4&&i(y.UV4Kind,this.uvs4),this.uvs5&&i(y.UV5Kind,this.uvs5),this.uvs6&&i(y.UV6Kind,this.uvs6),this.colors&&i(y.ColorKind,this.colors),this.matricesIndices&&i(y.MatricesIndicesKind,this.matricesIndices),this.matricesWeights&&i(y.MatricesWeightsKind,this.matricesWeights),this.matricesIndicesExtra&&i(y.MatricesIndicesExtraKind,this.matricesIndicesExtra),this.matricesWeightsExtra&&i(y.MatricesWeightsExtraKind,this.matricesWeightsExtra)}serialize(){const e={};return this.positions&&(e.positions=this.positions),this.normals&&(e.normals=this.normals),this.tangents&&(e.tangents=this.tangents),this.uvs&&(e.uvs=this.uvs),this.uvs2&&(e.uvs2=this.uvs2),this.uvs3&&(e.uvs3=this.uvs3),this.uvs4&&(e.uvs4=this.uvs4),this.uvs5&&(e.uvs5=this.uvs5),this.uvs6&&(e.uvs6=this.uvs6),this.colors&&(e.colors=this.colors),this.matricesIndices&&(e.matricesIndices=this.matricesIndices,e.matricesIndices._isExpanded=!0),this.matricesWeights&&(e.matricesWeights=this.matricesWeights),this.matricesIndicesExtra&&(e.matricesIndicesExtra=this.matricesIndicesExtra,e.matricesIndicesExtra._isExpanded=!0),this.matricesWeightsExtra&&(e.matricesWeightsExtra=this.matricesWeightsExtra),e.indices=this.indices,e}static ExtractFromMesh(e,t,i){return de._ExtractFrom(e,t,i)}static ExtractFromGeometry(e,t,i){return de._ExtractFrom(e,t,i)}static _ExtractFrom(e,t,i){const s=new de;return e.isVerticesDataPresent(y.PositionKind)&&(s.positions=e.getVerticesData(y.PositionKind,t,i)),e.isVerticesDataPresent(y.NormalKind)&&(s.normals=e.getVerticesData(y.NormalKind,t,i)),e.isVerticesDataPresent(y.TangentKind)&&(s.tangents=e.getVerticesData(y.TangentKind,t,i)),e.isVerticesDataPresent(y.UVKind)&&(s.uvs=e.getVerticesData(y.UVKind,t,i)),e.isVerticesDataPresent(y.UV2Kind)&&(s.uvs2=e.getVerticesData(y.UV2Kind,t,i)),e.isVerticesDataPresent(y.UV3Kind)&&(s.uvs3=e.getVerticesData(y.UV3Kind,t,i)),e.isVerticesDataPresent(y.UV4Kind)&&(s.uvs4=e.getVerticesData(y.UV4Kind,t,i)),e.isVerticesDataPresent(y.UV5Kind)&&(s.uvs5=e.getVerticesData(y.UV5Kind,t,i)),e.isVerticesDataPresent(y.UV6Kind)&&(s.uvs6=e.getVerticesData(y.UV6Kind,t,i)),e.isVerticesDataPresent(y.ColorKind)&&(s.colors=e.getVerticesData(y.ColorKind,t,i)),e.isVerticesDataPresent(y.MatricesIndicesKind)&&(s.matricesIndices=e.getVerticesData(y.MatricesIndicesKind,t,i)),e.isVerticesDataPresent(y.MatricesWeightsKind)&&(s.matricesWeights=e.getVerticesData(y.MatricesWeightsKind,t,i)),e.isVerticesDataPresent(y.MatricesIndicesExtraKind)&&(s.matricesIndicesExtra=e.getVerticesData(y.MatricesIndicesExtraKind,t,i)),e.isVerticesDataPresent(y.MatricesWeightsExtraKind)&&(s.matricesWeightsExtra=e.getVerticesData(y.MatricesWeightsExtraKind,t,i)),s.indices=e.getIndices(t,i),s}static CreateRibbon(e){throw Ve("ribbonBuilder")}static CreateBox(e){throw Ve("boxBuilder")}static CreateTiledBox(e){throw Ve("tiledBoxBuilder")}static CreateTiledPlane(e){throw Ve("tiledPlaneBuilder")}static CreateSphere(e){throw Ve("sphereBuilder")}static CreateCylinder(e){throw Ve("cylinderBuilder")}static CreateTorus(e){throw Ve("torusBuilder")}static CreateLineSystem(e){throw Ve("linesBuilder")}static CreateDashedLines(e){throw Ve("linesBuilder")}static CreateGround(e){throw Ve("groundBuilder")}static CreateTiledGround(e){throw Ve("groundBuilder")}static CreateGroundFromHeightMap(e){throw Ve("groundBuilder")}static CreatePlane(e){throw Ve("planeBuilder")}static CreateDisc(e){throw Ve("discBuilder")}static CreatePolygon(e,t,i,s,r,n,o){throw Ve("polygonBuilder")}static CreateIcoSphere(e){throw Ve("icoSphereBuilder")}static CreatePolyhedron(e){throw Ve("polyhedronBuilder")}static CreateCapsule(e={orientation:g.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){throw Ve("capsuleBuilder")}static CreateTorusKnot(e){throw Ve("torusKnotBuilder")}static ComputeNormals(e,t,i,s){let r=0,n=0,o=0,l=0,h=0,c=0,u=0,d=0,f=0,p=0,_=0,m=0,v=0,x=0,b=0,S=0,C=0,E=0,A=0,M=0,D=!1,P=!1,O=!1,N=!1,$=1,W=0,K=null;s&&(D=!!s.facetNormals,P=!!s.facetPositions,O=!!s.facetPartitioning,$=s.useRightHandedSystem===!0?-1:1,W=s.ratio||0,N=!!s.depthSort,K=s.distanceTo,N&&K===void 0&&(K=g.Zero()));let te=0,ve=0,_e=0,j=0;for(O&&s&&s.bbSize&&(te=s.subDiv.X*W/s.bbSize.x,ve=s.subDiv.Y*W/s.bbSize.y,_e=s.subDiv.Z*W/s.bbSize.z,j=s.subDiv.max*s.subDiv.max,s.facetPartitioning.length=0),r=0;r<e.length;r++)i[r]=0;const ee=t.length/3|0;for(r=0;r<ee;r++){if(m=t[r*3]*3,v=m+1,x=m+2,b=t[r*3+1]*3,S=b+1,C=b+2,E=t[r*3+2]*3,A=E+1,M=E+2,n=e[m]-e[b],o=e[v]-e[S],l=e[x]-e[C],h=e[E]-e[b],c=e[A]-e[S],u=e[M]-e[C],d=$*(o*u-l*c),f=$*(l*h-n*u),p=$*(n*c-o*h),_=Math.sqrt(d*d+f*f+p*p),_=_===0?1:_,d/=_,f/=_,p/=_,D&&s&&(s.facetNormals[r].x=d,s.facetNormals[r].y=f,s.facetNormals[r].z=p),P&&s&&(s.facetPositions[r].x=(e[m]+e[b]+e[E])/3,s.facetPositions[r].y=(e[v]+e[S]+e[A])/3,s.facetPositions[r].z=(e[x]+e[C]+e[M])/3),O&&s){const F=Math.floor((s.facetPositions[r].x-s.bInfo.minimum.x*W)*te),z=Math.floor((s.facetPositions[r].y-s.bInfo.minimum.y*W)*ve),Z=Math.floor((s.facetPositions[r].z-s.bInfo.minimum.z*W)*_e),Ee=Math.floor((e[m]-s.bInfo.minimum.x*W)*te),He=Math.floor((e[v]-s.bInfo.minimum.y*W)*ve),ut=Math.floor((e[x]-s.bInfo.minimum.z*W)*_e),me=Math.floor((e[b]-s.bInfo.minimum.x*W)*te),Se=Math.floor((e[S]-s.bInfo.minimum.y*W)*ve),it=Math.floor((e[C]-s.bInfo.minimum.z*W)*_e),Zt=Math.floor((e[E]-s.bInfo.minimum.x*W)*te),Xe=Math.floor((e[A]-s.bInfo.minimum.y*W)*ve),Re=Math.floor((e[M]-s.bInfo.minimum.z*W)*_e),rt=Ee+s.subDiv.max*He+j*ut,xt=me+s.subDiv.max*Se+j*it,At=Zt+s.subDiv.max*Xe+j*Re,Ut=F+s.subDiv.max*z+j*Z;s.facetPartitioning[Ut]=s.facetPartitioning[Ut]?s.facetPartitioning[Ut]:new Array,s.facetPartitioning[rt]=s.facetPartitioning[rt]?s.facetPartitioning[rt]:new Array,s.facetPartitioning[xt]=s.facetPartitioning[xt]?s.facetPartitioning[xt]:new Array,s.facetPartitioning[At]=s.facetPartitioning[At]?s.facetPartitioning[At]:new Array,s.facetPartitioning[rt].push(r),xt!=rt&&s.facetPartitioning[xt].push(r),At==xt||At==rt||s.facetPartitioning[At].push(r),Ut==rt||Ut==xt||Ut==At||s.facetPartitioning[Ut].push(r)}if(N&&s&&s.facetPositions){const F=s.depthSortedFacets[r];F.ind=r*3,F.sqDistance=g.DistanceSquared(s.facetPositions[r],K)}i[m]+=d,i[v]+=f,i[x]+=p,i[b]+=d,i[S]+=f,i[C]+=p,i[E]+=d,i[A]+=f,i[M]+=p}for(r=0;r<i.length/3;r++)d=i[r*3],f=i[r*3+1],p=i[r*3+2],_=Math.sqrt(d*d+f*f+p*p),_=_===0?1:_,d/=_,f/=_,p/=_,i[r*3]=d,i[r*3+1]=f,i[r*3+2]=p}static _ComputeSides(e,t,i,s,r,n,o){const l=i.length,h=s.length;let c,u;switch(e=e||de.DEFAULTSIDE,e){case de.FRONTSIDE:break;case de.BACKSIDE:for(c=0;c<l;c+=3){const d=i[c];i[c]=i[c+2],i[c+2]=d}for(u=0;u<h;u++)s[u]=-s[u];break;case de.DOUBLESIDE:{const d=t.length,f=d/3;for(let m=0;m<d;m++)t[d+m]=t[m];for(c=0;c<l;c+=3)i[c+l]=i[c+2]+f,i[c+1+l]=i[c+1]+f,i[c+2+l]=i[c]+f;for(u=0;u<h;u++)s[h+u]=-s[u];const p=r.length;let _=0;for(_=0;_<p;_++)r[_+p]=r[_];for(n=n||new Ge(0,0,1,1),o=o||new Ge(0,0,1,1),_=0,c=0;c<p/2;c++)r[_]=n.x+(n.z-n.x)*r[_],r[_+1]=n.y+(n.w-n.y)*r[_+1],r[_+p]=o.x+(o.z-o.x)*r[_+p],r[_+p+1]=o.y+(o.w-o.y)*r[_+p+1],_+=2;break}}}static ImportVertexData(e,t){const i=new de,s=e.positions;s&&i.set(s,y.PositionKind);const r=e.normals;r&&i.set(r,y.NormalKind);const n=e.tangents;n&&i.set(n,y.TangentKind);const o=e.uvs;o&&i.set(o,y.UVKind);const l=e.uv2s;l&&i.set(l,y.UV2Kind);const h=e.uv3s;h&&i.set(h,y.UV3Kind);const c=e.uv4s;c&&i.set(c,y.UV4Kind);const u=e.uv5s;u&&i.set(u,y.UV5Kind);const d=e.uv6s;d&&i.set(d,y.UV6Kind);const f=e.colors;f&&i.set(J.CheckColors4(f,s.length/3),y.ColorKind);const p=e.matricesIndices;p&&i.set(p,y.MatricesIndicesKind);const _=e.matricesWeights;_&&i.set(_,y.MatricesWeightsKind);const m=e.indices;m&&(i.indices=m),t.setAllVerticesData(i,e.updatable)}}de.FRONTSIDE=0;de.BACKSIDE=1;de.DOUBLESIDE=2;de.DEFAULTSIDE=0;T([Qn.filter((...[a])=>!Array.isArray(a))],de,"_TransformVector3Coordinates",null);T([Qn.filter((...[a])=>!Array.isArray(a))],de,"_TransformVector3Normals",null);T([Qn.filter((...[a])=>!Array.isArray(a))],de,"_TransformVector4Normals",null);T([Qn.filter((...[a])=>!Array.isArray(a))],de,"_FlipFaces",null);class ed{constructor(e,t,i){this.bu=e,this.bv=t,this.distance=i,this.faceId=0,this.subMeshId=0}}class Ir{constructor(e,t,i){this.vectors=gi.BuildArray(8,g.Zero),this.center=g.Zero(),this.centerWorld=g.Zero(),this.extendSize=g.Zero(),this.extendSizeWorld=g.Zero(),this.directions=gi.BuildArray(3,g.Zero),this.vectorsWorld=gi.BuildArray(8,g.Zero),this.minimumWorld=g.Zero(),this.maximumWorld=g.Zero(),this.minimum=g.Zero(),this.maximum=g.Zero(),this._drawWrapperFront=null,this._drawWrapperBack=null,this.reConstruct(e,t,i)}reConstruct(e,t,i){const s=e.x,r=e.y,n=e.z,o=t.x,l=t.y,h=t.z,c=this.vectors;this.minimum.copyFromFloats(s,r,n),this.maximum.copyFromFloats(o,l,h),c[0].copyFromFloats(s,r,n),c[1].copyFromFloats(o,l,h),c[2].copyFromFloats(o,r,n),c[3].copyFromFloats(s,l,n),c[4].copyFromFloats(s,r,h),c[5].copyFromFloats(o,l,n),c[6].copyFromFloats(s,l,h),c[7].copyFromFloats(o,r,h),t.addToRef(e,this.center).scaleInPlace(.5),t.subtractToRef(e,this.extendSize).scaleInPlace(.5),this._worldMatrix=i||L.IdentityReadOnly,this._update(this._worldMatrix)}scale(e){const t=Ir._TmpVector3,i=this.maximum.subtractToRef(this.minimum,t[0]),s=i.length();i.normalizeFromLength(s);const r=s*e,n=i.scaleInPlace(r*.5),o=this.center.subtractToRef(n,t[1]),l=this.center.addToRef(n,t[2]);return this.reConstruct(o,l,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){const t=this.minimumWorld,i=this.maximumWorld,s=this.directions,r=this.vectorsWorld,n=this.vectors;if(e.isIdentity()){t.copyFrom(this.minimum),i.copyFrom(this.maximum);for(let o=0;o<8;++o)r[o].copyFrom(n[o]);this.extendSizeWorld.copyFrom(this.extendSize),this.centerWorld.copyFrom(this.center)}else{t.setAll(Number.MAX_VALUE),i.setAll(-Number.MAX_VALUE);for(let o=0;o<8;++o){const l=r[o];g.TransformCoordinatesToRef(n[o],e,l),t.minimizeInPlace(l),i.maximizeInPlace(l)}i.subtractToRef(t,this.extendSizeWorld).scaleInPlace(.5),i.addToRef(t,this.centerWorld).scaleInPlace(.5)}g.FromArrayToRef(e.m,0,s[0]),g.FromArrayToRef(e.m,4,s[1]),g.FromArrayToRef(e.m,8,s[2]),this._worldMatrix=e}isInFrustum(e){return Ir.IsInFrustum(this.vectorsWorld,e)}isCompletelyInFrustum(e){return Ir.IsCompletelyInFrustum(this.vectorsWorld,e)}intersectsPoint(e){const t=this.minimumWorld,i=this.maximumWorld,s=t.x,r=t.y,n=t.z,o=i.x,l=i.y,h=i.z,c=e.x,u=e.y,d=e.z,f=-tt;return!(o-c<f||f>c-s||l-u<f||f>u-r||h-d<f||f>d-n)}intersectsSphere(e){return Ir.IntersectsSphere(this.minimumWorld,this.maximumWorld,e.centerWorld,e.radiusWorld)}intersectsMinMax(e,t){const i=this.minimumWorld,s=this.maximumWorld,r=i.x,n=i.y,o=i.z,l=s.x,h=s.y,c=s.z,u=e.x,d=e.y,f=e.z,p=t.x,_=t.y,m=t.z;return!(l<u||r>p||h<d||n>_||c<f||o>m)}dispose(){var e,t;(e=this._drawWrapperFront)===null||e===void 0||e.dispose(),(t=this._drawWrapperBack)===null||t===void 0||t.dispose()}static Intersects(e,t){return e.intersectsMinMax(t.minimumWorld,t.maximumWorld)}static IntersectsSphere(e,t,i,s){const r=Ir._TmpVector3[0];return g.ClampToRef(i,e,t,r),g.DistanceSquared(i,r)<=s*s}static IsCompletelyInFrustum(e,t){for(let i=0;i<6;++i){const s=t[i];for(let r=0;r<8;++r)if(s.dotCoordinate(e[r])<0)return!1}return!0}static IsInFrustum(e,t){for(let i=0;i<6;++i){let s=!0;const r=t[i];for(let n=0;n<8;++n)if(r.dotCoordinate(e[n])>=0){s=!1;break}if(s)return!1}return!0}}Ir._TmpVector3=gi.BuildArray(3,g.Zero);class vn{constructor(e,t,i){this.center=g.Zero(),this.centerWorld=g.Zero(),this.minimum=g.Zero(),this.maximum=g.Zero(),this.reConstruct(e,t,i)}reConstruct(e,t,i){this.minimum.copyFrom(e),this.maximum.copyFrom(t);const s=g.Distance(e,t);t.addToRef(e,this.center).scaleInPlace(.5),this.radius=s*.5,this._update(i||L.IdentityReadOnly)}scale(e){const t=this.radius*e,i=vn._TmpVector3,s=i[0].setAll(t),r=this.center.subtractToRef(s,i[1]),n=this.center.addToRef(s,i[2]);return this.reConstruct(r,n,this._worldMatrix),this}getWorldMatrix(){return this._worldMatrix}_update(e){if(e.isIdentity())this.centerWorld.copyFrom(this.center),this.radiusWorld=this.radius;else{g.TransformCoordinatesToRef(this.center,e,this.centerWorld);const t=vn._TmpVector3[0];g.TransformNormalFromFloatsToRef(1,1,1,e,t),this.radiusWorld=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z))*this.radius}}isInFrustum(e){const t=this.centerWorld,i=this.radiusWorld;for(let s=0;s<6;s++)if(e[s].dotCoordinate(t)<=-i)return!1;return!0}isCenterInFrustum(e){const t=this.centerWorld;for(let i=0;i<6;i++)if(e[i].dotCoordinate(t)<0)return!1;return!0}intersectsPoint(e){const t=g.DistanceSquared(this.centerWorld,e);return!(this.radiusWorld*this.radiusWorld<t)}static Intersects(e,t){const i=g.DistanceSquared(e.centerWorld,t.centerWorld),s=e.radiusWorld+t.radiusWorld;return!(s*s<i)}static CreateFromCenterAndRadius(e,t,i){this._TmpVector3[0].copyFrom(e),this._TmpVector3[1].copyFromFloats(0,0,t),this._TmpVector3[2].copyFrom(e),this._TmpVector3[0].addInPlace(this._TmpVector3[1]),this._TmpVector3[2].subtractInPlace(this._TmpVector3[1]);const s=new vn(this._TmpVector3[0],this._TmpVector3[2]);return i?s._worldMatrix=i:s._worldMatrix=L.Identity(),s}}vn._TmpVector3=gi.BuildArray(3,g.Zero);const Cu={min:0,max:0},yu={min:0,max:0},Sf=(a,e,t)=>{const i=g.Dot(e.centerWorld,a),s=Math.abs(g.Dot(e.directions[0],a))*e.extendSize.x,r=Math.abs(g.Dot(e.directions[1],a))*e.extendSize.y,n=Math.abs(g.Dot(e.directions[2],a))*e.extendSize.z,o=s+r+n;t.min=i-o,t.max=i+o},Is=(a,e,t)=>(Sf(a,e,Cu),Sf(a,t,yu),!(Cu.min>yu.max||yu.min>Cu.max));class Js{constructor(e,t,i){this._isLocked=!1,this.boundingBox=new Ir(e,t,i),this.boundingSphere=new vn(e,t,i)}reConstruct(e,t,i){this.boundingBox.reConstruct(e,t,i),this.boundingSphere.reConstruct(e,t,i)}get minimum(){return this.boundingBox.minimum}get maximum(){return this.boundingBox.maximum}get isLocked(){return this._isLocked}set isLocked(e){this._isLocked=e}update(e){this._isLocked||(this.boundingBox._update(e),this.boundingSphere._update(e))}centerOn(e,t){const i=Js._TmpVector3[0].copyFrom(e).subtractInPlace(t),s=Js._TmpVector3[1].copyFrom(e).addInPlace(t);return this.boundingBox.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this.boundingSphere.reConstruct(i,s,this.boundingBox.getWorldMatrix()),this}encapsulate(e){const t=g.Minimize(this.minimum,e),i=g.Maximize(this.maximum,e);return this.reConstruct(t,i,this.boundingBox.getWorldMatrix()),this}encapsulateBoundingInfo(e){return this.encapsulate(e.boundingBox.centerWorld.subtract(e.boundingBox.extendSizeWorld)),this.encapsulate(e.boundingBox.centerWorld.add(e.boundingBox.extendSizeWorld)),this}scale(e){return this.boundingBox.scale(e),this.boundingSphere.scale(e),this}isInFrustum(e,t=0){return(t===2||t===3)&&this.boundingSphere.isCenterInFrustum(e)?!0:this.boundingSphere.isInFrustum(e)?t===1||t===3?!0:this.boundingBox.isInFrustum(e):!1}get diagonalLength(){const e=this.boundingBox;return e.maximumWorld.subtractToRef(e.minimumWorld,Js._TmpVector3[0]).length()}isCompletelyInFrustum(e){return this.boundingBox.isCompletelyInFrustum(e)}_checkCollision(e){return e._canDoCollision(this.boundingSphere.centerWorld,this.boundingSphere.radiusWorld,this.boundingBox.minimumWorld,this.boundingBox.maximumWorld)}intersectsPoint(e){return!(!this.boundingSphere.centerWorld||!this.boundingSphere.intersectsPoint(e)||!this.boundingBox.intersectsPoint(e))}intersects(e,t){if(!vn.Intersects(this.boundingSphere,e.boundingSphere)||!Ir.Intersects(this.boundingBox,e.boundingBox))return!1;if(!t)return!0;const i=this.boundingBox,s=e.boundingBox;return!(!Is(i.directions[0],i,s)||!Is(i.directions[1],i,s)||!Is(i.directions[2],i,s)||!Is(s.directions[0],i,s)||!Is(s.directions[1],i,s)||!Is(s.directions[2],i,s)||!Is(g.Cross(i.directions[0],s.directions[0]),i,s)||!Is(g.Cross(i.directions[0],s.directions[1]),i,s)||!Is(g.Cross(i.directions[0],s.directions[2]),i,s)||!Is(g.Cross(i.directions[1],s.directions[0]),i,s)||!Is(g.Cross(i.directions[1],s.directions[1]),i,s)||!Is(g.Cross(i.directions[1],s.directions[2]),i,s)||!Is(g.Cross(i.directions[2],s.directions[0]),i,s)||!Is(g.Cross(i.directions[2],s.directions[1]),i,s)||!Is(g.Cross(i.directions[2],s.directions[2]),i,s))}}Js._TmpVector3=gi.BuildArray(2,g.Zero);class Tc{static extractMinAndMaxIndexed(e,t,i,s,r,n){for(let o=i;o<i+s;o++){const l=t[o]*3,h=e[l],c=e[l+1],u=e[l+2];r.minimizeInPlaceFromFloats(h,c,u),n.maximizeInPlaceFromFloats(h,c,u)}}static extractMinAndMax(e,t,i,s,r,n){for(let o=t,l=t*s;o<t+i;o++,l+=s){const h=e[l],c=e[l+1],u=e[l+2];r.minimizeInPlaceFromFloats(h,c,u),n.maximizeInPlaceFromFloats(h,c,u)}}}T([Qn.filter((...[a,e])=>!Array.isArray(a)&&!Array.isArray(e))],Tc,"extractMinAndMaxIndexed",null);T([Qn.filter((...[a])=>!Array.isArray(a))],Tc,"extractMinAndMax",null);function qx(a,e,t,i,s=null){const r=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return Tc.extractMinAndMaxIndexed(a,e,t,i,r,n),s&&(r.x-=r.x*s.x+s.y,r.y-=r.y*s.x+s.y,r.z-=r.z*s.x+s.y,n.x+=n.x*s.x+s.y,n.y+=n.y*s.x+s.y,n.z+=n.z*s.x+s.y),{minimum:r,maximum:n}}function b_(a,e,t,i=null,s){const r=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),n=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);return s||(s=3),Tc.extractMinAndMax(a,e,t,s,r,n),i&&(r.x-=r.x*i.x+i.y,r.y-=r.y*i.x+i.y,r.z-=r.z*i.x+i.y,n.x+=n.x*i.x+i.y,n.y+=n.y*i.x+i.y,n.z+=n.z*i.x+i.y),{minimum:r,maximum:n}}class fs{constructor(e,t,i,s,r,n,o,l=!0,h=!0){this.materialIndex=e,this.verticesStart=t,this.verticesCount=i,this.indexStart=s,this.indexCount=r,this._mainDrawWrapperOverride=null,this._linesIndexCount=0,this._linesIndexBuffer=null,this._lastColliderWorldVertices=null,this._lastColliderTransformMatrix=null,this._wasDispatched=!1,this._renderId=0,this._alphaIndex=0,this._distanceToCamera=0,this._currentMaterial=null,this._mesh=n,this._renderingMesh=o||n,h&&n.subMeshes.push(this),this._engine=this._mesh.getScene().getEngine(),this.resetDrawCache(),this._trianglePlanes=[],this._id=n.subMeshes.length-1,l&&(this.refreshBoundingInfo(),n.computeWorldMatrix(!0))}get materialDefines(){var e;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.defines:(e=this._getDrawWrapper())===null||e===void 0?void 0:e.defines}set materialDefines(e){var t;const i=(t=this._mainDrawWrapperOverride)!==null&&t!==void 0?t:this._getDrawWrapper(void 0,!0);i.defines=e}_getDrawWrapper(e,t=!1){e=e!=null?e:this._engine.currentRenderPassId;let i=this._drawWrappers[e];return!i&&t&&(this._drawWrappers[e]=i=new Vi(this._mesh.getScene().getEngine())),i}_removeDrawWrapper(e,t=!0){var i;t&&((i=this._drawWrappers[e])===null||i===void 0||i.dispose()),this._drawWrappers[e]=void 0}get effect(){var e,t;return this._mainDrawWrapperOverride?this._mainDrawWrapperOverride.effect:(t=(e=this._getDrawWrapper())===null||e===void 0?void 0:e.effect)!==null&&t!==void 0?t:null}get _drawWrapper(){var e;return(e=this._mainDrawWrapperOverride)!==null&&e!==void 0?e:this._getDrawWrapper(void 0,!0)}get _drawWrapperOverride(){return this._mainDrawWrapperOverride}_setMainDrawWrapperOverride(e){this._mainDrawWrapperOverride=e}setEffect(e,t=null,i,s=!0){const r=this._drawWrapper;r.setEffect(e,t,s),i!==void 0&&(r.materialContext=i),e||(r.defines=null,r.materialContext=void 0)}resetDrawCache(e){if(this._drawWrappers)if(e!==void 0){this._removeDrawWrapper(e);return}else for(const t of this._drawWrappers)t==null||t.dispose();this._drawWrappers=[]}static AddToMesh(e,t,i,s,r,n,o,l=!0){return new fs(e,t,i,s,r,n,o,l)}get IsGlobal(){return this.verticesStart===0&&this.verticesCount===this._mesh.getTotalVertices()&&this.indexStart===0&&this.indexCount===this._mesh.getTotalIndices()}getBoundingInfo(){return this.IsGlobal?this._mesh.getBoundingInfo():this._boundingInfo}setBoundingInfo(e){return this._boundingInfo=e,this}getMesh(){return this._mesh}getRenderingMesh(){return this._renderingMesh}getReplacementMesh(){return this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null}getEffectiveMesh(){const e=this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:null;return e||this._renderingMesh}getMaterial(e=!0){var t;const i=(t=this._renderingMesh.getMaterialForRenderPass(this._engine.currentRenderPassId))!==null&&t!==void 0?t:this._renderingMesh.material;if(i){if(this._isMultiMaterial(i)){const s=i.getSubMaterial(this.materialIndex);return this._currentMaterial!==s&&(this._currentMaterial=s,this.resetDrawCache()),s}}else return e?this._mesh.getScene().defaultMaterial:null;return i}_isMultiMaterial(e){return e.getSubMaterial!==void 0}refreshBoundingInfo(e=null){if(this._lastColliderWorldVertices=null,this.IsGlobal||!this._renderingMesh||!this._renderingMesh.geometry)return this;if(e||(e=this._renderingMesh.getVerticesData(y.PositionKind)),!e)return this._boundingInfo=this._mesh.getBoundingInfo(),this;const t=this._renderingMesh.getIndices();let i;if(this.indexStart===0&&this.indexCount===t.length){const s=this._renderingMesh.getBoundingInfo();i={minimum:s.minimum.clone(),maximum:s.maximum.clone()}}else i=qx(e,t,this.indexStart,this.indexCount,this._renderingMesh.geometry.boundingBias);return this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Js(i.minimum,i.maximum),this}_checkCollision(e){return this.getBoundingInfo()._checkCollision(e)}updateBoundingInfo(e){let t=this.getBoundingInfo();return t||(this.refreshBoundingInfo(),t=this.getBoundingInfo()),t&&t.update(e),this}isInFrustum(e){const t=this.getBoundingInfo();return t?t.isInFrustum(e,this._mesh.cullingStrategy):!1}isCompletelyInFrustum(e){const t=this.getBoundingInfo();return t?t.isCompletelyInFrustum(e):!1}render(e){return this._renderingMesh.render(this,e,this._mesh._internalAbstractMeshDataInfo._actAsRegularMesh?this._mesh:void 0),this}_getLinesIndexBuffer(e,t){if(!this._linesIndexBuffer){const i=[];for(let s=this.indexStart;s<this.indexStart+this.indexCount;s+=3)i.push(e[s],e[s+1],e[s+1],e[s+2],e[s+2],e[s]);this._linesIndexBuffer=t.createIndexBuffer(i),this._linesIndexCount=i.length}return this._linesIndexBuffer}canIntersects(e){const t=this.getBoundingInfo();return t?e.intersectsBox(t.boundingBox):!1}intersects(e,t,i,s,r){const n=this.getMaterial();if(!n)return null;let o=3,l=!1;switch(n.fillMode){case 3:case 5:case 6:case 8:return null;case 7:o=1,l=!0;break}return n.fillMode===4?i.length?this._intersectLines(e,t,i,this._mesh.intersectionThreshold,s):this._intersectUnIndexedLines(e,t,i,this._mesh.intersectionThreshold,s):!i.length&&this._mesh._unIndexed?this._intersectUnIndexedTriangles(e,t,i,s,r):this._intersectTriangles(e,t,i,o,l,s,r)}_intersectLines(e,t,i,s,r){let n=null;for(let o=this.indexStart;o<this.indexStart+this.indexCount;o+=2){const l=t[i[o]],h=t[i[o+1]],c=e.intersectionSegment(l,h,s);if(!(c<0)&&(r||!n||c<n.distance)&&(n=new ed(null,null,c),n.faceId=o/2,r))break}return n}_intersectUnIndexedLines(e,t,i,s,r){let n=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=2){const l=t[o],h=t[o+1],c=e.intersectionSegment(l,h,s);if(!(c<0)&&(r||!n||c<n.distance)&&(n=new ed(null,null,c),n.faceId=o/2,r))break}return n}_intersectTriangles(e,t,i,s,r,n,o){let l=null,h=-1;for(let c=this.indexStart;c<this.indexStart+this.indexCount-(3-s);c+=s){h++;const u=i[c],d=i[c+1],f=i[c+2];if(r&&f===4294967295){c+=2;continue}const p=t[u],_=t[d],m=t[f];if(!p||!_||!m||o&&!o(p,_,m,e))continue;const v=e.intersectsTriangle(p,_,m);if(v){if(v.distance<0)continue;if((n||!l||v.distance<l.distance)&&(l=v,l.faceId=h,n))break}}return l}_intersectUnIndexedTriangles(e,t,i,s,r){let n=null;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=t[o],h=t[o+1],c=t[o+2];if(r&&!r(l,h,c,e))continue;const u=e.intersectsTriangle(l,h,c);if(u){if(u.distance<0)continue;if((s||!n||u.distance<n.distance)&&(n=u,n.faceId=o/3,s))break}}return n}_rebuild(){this._linesIndexBuffer&&(this._linesIndexBuffer=null)}clone(e,t){const i=new fs(this.materialIndex,this.verticesStart,this.verticesCount,this.indexStart,this.indexCount,e,t,!1);if(!this.IsGlobal){const s=this.getBoundingInfo();if(!s)return i;i._boundingInfo=new Js(s.minimum,s.maximum)}return i}dispose(){this._linesIndexBuffer&&(this._mesh.getScene().getEngine()._releaseBuffer(this._linesIndexBuffer),this._linesIndexBuffer=null);const e=this._mesh.subMeshes.indexOf(this);this._mesh.subMeshes.splice(e,1),this.resetDrawCache()}getClassName(){return"SubMesh"}static CreateFromIndices(e,t,i,s,r,n=!0){let o=Number.MAX_VALUE,l=-Number.MAX_VALUE;const c=(r||s).getIndices();for(let u=t;u<t+i;u++){const d=c[u];d<o&&(o=d),d>l&&(l=d)}return new fs(e,o,l-o+1,t,i,s,r,n)}}class bi{static get ForceFullSceneLoadingForIncremental(){return bi._ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){bi._ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return bi._ShowLoadingScreen}static set ShowLoadingScreen(e){bi._ShowLoadingScreen=e}static get loggingLevel(){return bi._LoggingLevel}static set loggingLevel(e){bi._LoggingLevel=e}static get CleanBoneMatrixWeights(){return bi._CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){bi._CleanBoneMatrixWeights=e}}bi._ForceFullSceneLoadingForIncremental=!1;bi._ShowLoadingScreen=!0;bi._CleanBoneMatrixWeights=!1;bi._LoggingLevel=0;class os{constructor(e,t,i,s=!1,r=null){this.delayLoadState=0,this._totalVertices=0,this._isDisposed=!1,this._indexBufferIsUpdatable=!1,this._positionsCache=[],this._parentContainer=null,this.useBoundingInfoFromGeometry=!1,this._scene=t||ye.LastCreatedScene,this._scene&&(this.id=e,this.uniqueId=this._scene.getUniqueId(),this._engine=this._scene.getEngine(),this._meshes=[],this._vertexBuffers={},this._indices=[],this._updatable=s,i?this.setAllVerticesData(i,s):this._totalVertices=0,this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObjects={}),r&&(this.applyToMesh(r),r.computeWorldMatrix(!0)))}get boundingBias(){return this._boundingBias}set boundingBias(e){this._boundingBias?this._boundingBias.copyFrom(e):this._boundingBias=e.clone(),this._updateBoundingInfo(!0,null)}static CreateGeometryForMesh(e){const t=new os(os.RandomId(),e.getScene());return t.applyToMesh(e),t}get meshes(){return this._meshes}get extend(){return this._extend}getScene(){return this._scene}getEngine(){return this._engine}isReady(){return this.delayLoadState===1||this.delayLoadState===0}get doNotSerialize(){for(let e=0;e<this._meshes.length;e++)if(!this._meshes[e].doNotSerialize)return!1;return!0}_rebuild(){this._vertexArrayObjects&&(this._vertexArrayObjects={}),this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable));for(const e in this._vertexBuffers)this._vertexBuffers[e]._rebuild()}setAllVerticesData(e,t){e.applyToGeometry(this,t),this._notifyUpdate()}setVerticesData(e,t,i=!1,s){i&&Array.isArray(t)&&(t=new Float32Array(t));const r=new y(this._engine,t,e,i,this._meshes.length===0,s);this.setVerticesBuffer(r)}removeVerticesData(e){this._vertexBuffers[e]&&(this._vertexBuffers[e].dispose(),delete this._vertexBuffers[e]),this._vertexArrayObjects&&this._disposeVertexArrayObjects()}setVerticesBuffer(e,t=null,i=!0){const s=e.getKind();this._vertexBuffers[s]&&i&&this._vertexBuffers[s].dispose(),e._buffer&&e._buffer._increaseReferences(),this._vertexBuffers[s]=e;const r=this._meshes,n=r.length;if(s===y.PositionKind){const o=e.getData();t!=null?this._totalVertices=t:o!=null&&(this._totalVertices=o.length/(e.type===y.BYTE?e.byteStride:e.byteStride/4)),this._updateExtend(o),this._resetPointsArrayCache();for(let l=0;l<n;l++){const h=r[l];h.buildBoundingInfo(this._extend.minimum,this._extend.maximum),h._createGlobalSubMesh(h.isUnIndexed),h.computeWorldMatrix(!0),h.synchronizeInstances()}}this._notifyUpdate(s)}updateVerticesDataDirectly(e,t,i,s=!1){const r=this.getVertexBuffer(e);!r||(r.updateDirectly(t,i,s),this._notifyUpdate(e))}updateVerticesData(e,t,i=!1){const s=this.getVertexBuffer(e);!s||(s.update(t),e===y.PositionKind&&this._updateBoundingInfo(i,t),this._notifyUpdate(e))}_updateBoundingInfo(e,t){if(e&&this._updateExtend(t),this._resetPointsArrayCache(),e){const i=this._meshes;for(const s of i){s.hasBoundingInfo?s.getBoundingInfo().reConstruct(this._extend.minimum,this._extend.maximum):s.buildBoundingInfo(this._extend.minimum,this._extend.maximum);const r=s.subMeshes;for(const n of r)n.refreshBoundingInfo()}}}_bind(e,t,i,s){if(!e)return;t===void 0&&(t=this._indexBuffer);const r=this.getVertexBuffers();if(!r)return;if(t!=this._indexBuffer||!this._vertexArrayObjects&&!s){this._engine.bindBuffers(r,t,e,i);return}const n=s||this._vertexArrayObjects;n[e.key]||(n[e.key]=this._engine.recordVertexArrayObject(r,t,e,i)),this._engine.bindVertexArrayObject(n[e.key],t)}getTotalVertices(){return this.isReady()?this._totalVertices:0}getVerticesData(e,t,i){const s=this.getVertexBuffer(e);return s?s.getFloatData(this._totalVertices,i||t&&this._meshes.length!==1):null}isVertexBufferUpdatable(e){const t=this._vertexBuffers[e];return t?t.isUpdatable():!1}getVertexBuffer(e){return this.isReady()?this._vertexBuffers[e]:null}getVertexBuffers(){return this.isReady()?this._vertexBuffers:null}isVerticesDataPresent(e){return this._vertexBuffers?this._vertexBuffers[e]!==void 0:this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){const e=[];let t;if(!this._vertexBuffers&&this._delayInfo)for(t in this._delayInfo)e.push(t);else for(t in this._vertexBuffers)e.push(t);return e}updateIndices(e,t,i=!1){if(!!this._indexBuffer)if(!this._indexBufferIsUpdatable)this.setIndices(e,null,!0);else{const s=e.length!==this._indices.length;if(i||(this._indices=e.slice()),this._engine.updateDynamicIndexBuffer(this._indexBuffer,e,t),s)for(const r of this._meshes)r._createGlobalSubMesh(!0)}}setIndices(e,t=null,i=!1){this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indices=e,this._indexBufferIsUpdatable=i,this._meshes.length!==0&&this._indices&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,i)),t!=null&&(this._totalVertices=t);for(const s of this._meshes)s._createGlobalSubMesh(!0),s.synchronizeInstances();this._notifyUpdate()}getTotalIndices(){return this.isReady()?this._indices.length:0}getIndices(e,t){if(!this.isReady())return null;const i=this._indices;return!t&&(!e||this._meshes.length===1)?i:i.slice()}getIndexBuffer(){return this.isReady()?this._indexBuffer:null}_releaseVertexArrayObject(e=null){!e||!this._vertexArrayObjects||this._vertexArrayObjects[e.key]&&(this._engine.releaseVertexArrayObject(this._vertexArrayObjects[e.key]),delete this._vertexArrayObjects[e.key])}releaseForMesh(e,t){const i=this._meshes,s=i.indexOf(e);s!==-1&&(i.splice(s,1),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject(),e._geometry=null,i.length===0&&t&&this.dispose())}applyToMesh(e){if(e._geometry===this)return;const t=e._geometry;t&&t.releaseForMesh(e),this._vertexArrayObjects&&e._invalidateInstanceVertexArrayObject();const i=this._meshes;e._geometry=this,e._internalAbstractMeshDataInfo._positions=null,this._scene.pushGeometry(this),i.push(e),this.isReady()?this._applyToMesh(e):this._boundingInfo&&e.setBoundingInfo(this._boundingInfo)}_updateExtend(e=null){if(this.useBoundingInfoFromGeometry&&this._boundingInfo)this._extend={minimum:this._boundingInfo.minimum.clone(),maximum:this._boundingInfo.maximum.clone()};else{if(!e&&(e=this.getVerticesData(y.PositionKind),!e))return;this._extend=b_(e,0,this._totalVertices,this.boundingBias,3)}}_applyToMesh(e){const t=this._meshes.length;for(const i in this._vertexBuffers)t===1&&this._vertexBuffers[i].create(),i===y.PositionKind&&(this._extend||this._updateExtend(),e.buildBoundingInfo(this._extend.minimum,this._extend.maximum),e._createGlobalSubMesh(e.isUnIndexed),e._updateBoundingInfo());t===1&&this._indices&&this._indices.length>0&&(this._indexBuffer=this._engine.createIndexBuffer(this._indices,this._updatable)),e._syncGeometryWithMorphTargetManager(),e.synchronizeInstances()}_notifyUpdate(e){this.onGeometryUpdated&&this.onGeometryUpdated(this,e),this._vertexArrayObjects&&this._disposeVertexArrayObjects();for(const t of this._meshes)t._markSubMeshesAsAttributesDirty()}load(e,t){if(this.delayLoadState!==2){if(this.isReady()){t&&t();return}this.delayLoadState=2,this._queueLoad(e,t)}}_queueLoad(e,t){!this.delayLoadingFile||(e.addPendingData(this),e._loadFile(this.delayLoadingFile,i=>{if(!this._delayLoadingFunction)return;this._delayLoadingFunction(JSON.parse(i),this),this.delayLoadState=1,this._delayInfo=[],e.removePendingData(this);const s=this._meshes,r=s.length;for(let n=0;n<r;n++)this._applyToMesh(s[n]);t&&t()},void 0,!0))}toLeftHanded(){const e=this.getIndices(!1);if(e!=null&&e.length>0){for(let s=0;s<e.length;s+=3){const r=e[s+0];e[s+0]=e[s+2],e[s+2]=r}this.setIndices(e)}const t=this.getVerticesData(y.PositionKind,!1);if(t!=null&&t.length>0){for(let s=0;s<t.length;s+=3)t[s+2]=-t[s+2];this.setVerticesData(y.PositionKind,t,!1)}const i=this.getVerticesData(y.NormalKind,!1);if(i!=null&&i.length>0){for(let s=0;s<i.length;s+=3)i[s+2]=-i[s+2];this.setVerticesData(y.NormalKind,i,!1)}}_resetPointsArrayCache(){this._positions=null}_generatePointsArray(){if(this._positions)return!0;const e=this.getVerticesData(y.PositionKind);if(!e||e.length===0)return!1;for(let t=this._positionsCache.length*3,i=this._positionsCache.length;t<e.length;t+=3,++i)this._positionsCache[i]=g.FromArray(e,t);for(let t=0,i=0;t<e.length;t+=3,++i)this._positionsCache[i].set(e[0+t],e[1+t],e[2+t]);return this._positionsCache.length=e.length/3,this._positions=this._positionsCache,!0}isDisposed(){return this._isDisposed}_disposeVertexArrayObjects(){if(this._vertexArrayObjects){for(const i in this._vertexArrayObjects)this._engine.releaseVertexArrayObject(this._vertexArrayObjects[i]);this._vertexArrayObjects={};const e=this._meshes,t=e.length;for(let i=0;i<t;i++)e[i]._invalidateInstanceVertexArrayObject()}}dispose(){const e=this._meshes,t=e.length;let i;for(i=0;i<t;i++)this.releaseForMesh(e[i]);this._meshes.length=0,this._disposeVertexArrayObjects();for(const s in this._vertexBuffers)this._vertexBuffers[s].dispose();if(this._vertexBuffers={},this._totalVertices=0,this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null,this._indices=[],this.delayLoadState=0,this.delayLoadingFile=null,this._delayLoadingFunction=null,this._delayInfo=[],this._boundingInfo=null,this._scene.removeGeometry(this),this._parentContainer){const s=this._parentContainer.geometries.indexOf(this);s>-1&&this._parentContainer.geometries.splice(s,1),this._parentContainer=null}this._isDisposed=!0}copy(e){const t=new de;t.indices=[];const i=this.getIndices();if(i)for(let l=0;l<i.length;l++)t.indices.push(i[l]);let s=!1,r=!1,n;for(n in this._vertexBuffers){const l=this.getVerticesData(n);if(l&&(l instanceof Float32Array?t.set(new Float32Array(l),n):t.set(l.slice(0),n),!r)){const h=this.getVertexBuffer(n);h&&(s=h.isUpdatable(),r=!s)}}const o=new os(e,this._scene,t,s);o.delayLoadState=this.delayLoadState,o.delayLoadingFile=this.delayLoadingFile,o._delayLoadingFunction=this._delayLoadingFunction;for(n in this._delayInfo)o._delayInfo=o._delayInfo||[],o._delayInfo.push(n);return o._boundingInfo=new Js(this._extend.minimum,this._extend.maximum),o}serialize(){const e={};return e.id=this.id,e.uniqueId=this.uniqueId,e.updatable=this._updatable,ot&&ot.HasTags(this)&&(e.tags=ot.GetTags(this)),e}_toNumberArray(e){return Array.isArray(e)?e:Array.prototype.slice.call(e)}clearCachedData(){this._indices=[],this._resetPointsArrayCache();for(const e in this._vertexBuffers)!Object.prototype.hasOwnProperty.call(this._vertexBuffers,e)||(this._vertexBuffers[e]._buffer._data=null)}serializeVerticeData(){const e=this.serialize();return this.isVerticesDataPresent(y.PositionKind)&&(e.positions=this._toNumberArray(this.getVerticesData(y.PositionKind)),this.isVertexBufferUpdatable(y.PositionKind)&&(e.positions._updatable=!0)),this.isVerticesDataPresent(y.NormalKind)&&(e.normals=this._toNumberArray(this.getVerticesData(y.NormalKind)),this.isVertexBufferUpdatable(y.NormalKind)&&(e.normals._updatable=!0)),this.isVerticesDataPresent(y.TangentKind)&&(e.tangents=this._toNumberArray(this.getVerticesData(y.TangentKind)),this.isVertexBufferUpdatable(y.TangentKind)&&(e.tangents._updatable=!0)),this.isVerticesDataPresent(y.UVKind)&&(e.uvs=this._toNumberArray(this.getVerticesData(y.UVKind)),this.isVertexBufferUpdatable(y.UVKind)&&(e.uvs._updatable=!0)),this.isVerticesDataPresent(y.UV2Kind)&&(e.uv2s=this._toNumberArray(this.getVerticesData(y.UV2Kind)),this.isVertexBufferUpdatable(y.UV2Kind)&&(e.uv2s._updatable=!0)),this.isVerticesDataPresent(y.UV3Kind)&&(e.uv3s=this._toNumberArray(this.getVerticesData(y.UV3Kind)),this.isVertexBufferUpdatable(y.UV3Kind)&&(e.uv3s._updatable=!0)),this.isVerticesDataPresent(y.UV4Kind)&&(e.uv4s=this._toNumberArray(this.getVerticesData(y.UV4Kind)),this.isVertexBufferUpdatable(y.UV4Kind)&&(e.uv4s._updatable=!0)),this.isVerticesDataPresent(y.UV5Kind)&&(e.uv5s=this._toNumberArray(this.getVerticesData(y.UV5Kind)),this.isVertexBufferUpdatable(y.UV5Kind)&&(e.uv5s._updatable=!0)),this.isVerticesDataPresent(y.UV6Kind)&&(e.uv6s=this._toNumberArray(this.getVerticesData(y.UV6Kind)),this.isVertexBufferUpdatable(y.UV6Kind)&&(e.uv6s._updatable=!0)),this.isVerticesDataPresent(y.ColorKind)&&(e.colors=this._toNumberArray(this.getVerticesData(y.ColorKind)),this.isVertexBufferUpdatable(y.ColorKind)&&(e.colors._updatable=!0)),this.isVerticesDataPresent(y.MatricesIndicesKind)&&(e.matricesIndices=this._toNumberArray(this.getVerticesData(y.MatricesIndicesKind)),e.matricesIndices._isExpanded=!0,this.isVertexBufferUpdatable(y.MatricesIndicesKind)&&(e.matricesIndices._updatable=!0)),this.isVerticesDataPresent(y.MatricesWeightsKind)&&(e.matricesWeights=this._toNumberArray(this.getVerticesData(y.MatricesWeightsKind)),this.isVertexBufferUpdatable(y.MatricesWeightsKind)&&(e.matricesWeights._updatable=!0)),e.indices=this._toNumberArray(this.getIndices()),e}static ExtractFromMesh(e,t){const i=e._geometry;return i?i.copy(t):null}static RandomId(){return q.RandomId()}static _GetGeometryByLoadedUniqueId(e,t){for(let i=0;i<t.geometries.length;i++)if(t.geometries[i]._loadedUniqueId===e)return t.geometries[i];return null}static _ImportGeometry(e,t){const i=t.getScene(),s=e.geometryUniqueId,r=e.geometryId;if(s||r){const n=s?this._GetGeometryByLoadedUniqueId(s,i):i.getGeometryById(r);n&&n.applyToMesh(t)}else if(e instanceof ArrayBuffer){const n=t._binaryInfo;if(n.positionsAttrDesc&&n.positionsAttrDesc.count>0){const o=new Float32Array(e,n.positionsAttrDesc.offset,n.positionsAttrDesc.count);t.setVerticesData(y.PositionKind,o,!1)}if(n.normalsAttrDesc&&n.normalsAttrDesc.count>0){const o=new Float32Array(e,n.normalsAttrDesc.offset,n.normalsAttrDesc.count);t.setVerticesData(y.NormalKind,o,!1)}if(n.tangetsAttrDesc&&n.tangetsAttrDesc.count>0){const o=new Float32Array(e,n.tangetsAttrDesc.offset,n.tangetsAttrDesc.count);t.setVerticesData(y.TangentKind,o,!1)}if(n.uvsAttrDesc&&n.uvsAttrDesc.count>0){const o=new Float32Array(e,n.uvsAttrDesc.offset,n.uvsAttrDesc.count);if(nt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(y.UVKind,o,!1)}if(n.uvs2AttrDesc&&n.uvs2AttrDesc.count>0){const o=new Float32Array(e,n.uvs2AttrDesc.offset,n.uvs2AttrDesc.count);if(nt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(y.UV2Kind,o,!1)}if(n.uvs3AttrDesc&&n.uvs3AttrDesc.count>0){const o=new Float32Array(e,n.uvs3AttrDesc.offset,n.uvs3AttrDesc.count);if(nt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(y.UV3Kind,o,!1)}if(n.uvs4AttrDesc&&n.uvs4AttrDesc.count>0){const o=new Float32Array(e,n.uvs4AttrDesc.offset,n.uvs4AttrDesc.count);if(nt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(y.UV4Kind,o,!1)}if(n.uvs5AttrDesc&&n.uvs5AttrDesc.count>0){const o=new Float32Array(e,n.uvs5AttrDesc.offset,n.uvs5AttrDesc.count);if(nt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(y.UV5Kind,o,!1)}if(n.uvs6AttrDesc&&n.uvs6AttrDesc.count>0){const o=new Float32Array(e,n.uvs6AttrDesc.offset,n.uvs6AttrDesc.count);if(nt.UseOpenGLOrientationForUV)for(let l=1;l<o.length;l+=2)o[l]=1-o[l];t.setVerticesData(y.UV6Kind,o,!1)}if(n.colorsAttrDesc&&n.colorsAttrDesc.count>0){const o=new Float32Array(e,n.colorsAttrDesc.offset,n.colorsAttrDesc.count);t.setVerticesData(y.ColorKind,o,!1,n.colorsAttrDesc.stride)}if(n.matricesIndicesAttrDesc&&n.matricesIndicesAttrDesc.count>0){const o=new Int32Array(e,n.matricesIndicesAttrDesc.offset,n.matricesIndicesAttrDesc.count),l=[];for(let h=0;h<o.length;h++){const c=o[h];l.push(c&255),l.push((c&65280)>>8),l.push((c&16711680)>>16),l.push(c>>24&255)}t.setVerticesData(y.MatricesIndicesKind,l,!1)}if(n.matricesIndicesExtraAttrDesc&&n.matricesIndicesExtraAttrDesc.count>0){const o=new Int32Array(e,n.matricesIndicesExtraAttrDesc.offset,n.matricesIndicesExtraAttrDesc.count),l=[];for(let h=0;h<o.length;h++){const c=o[h];l.push(c&255),l.push((c&65280)>>8),l.push((c&16711680)>>16),l.push(c>>24&255)}t.setVerticesData(y.MatricesIndicesExtraKind,l,!1)}if(n.matricesWeightsAttrDesc&&n.matricesWeightsAttrDesc.count>0){const o=new Float32Array(e,n.matricesWeightsAttrDesc.offset,n.matricesWeightsAttrDesc.count);t.setVerticesData(y.MatricesWeightsKind,o,!1)}if(n.indicesAttrDesc&&n.indicesAttrDesc.count>0){const o=new Int32Array(e,n.indicesAttrDesc.offset,n.indicesAttrDesc.count);t.setIndices(o,null)}if(n.subMeshesAttrDesc&&n.subMeshesAttrDesc.count>0){const o=new Int32Array(e,n.subMeshesAttrDesc.offset,n.subMeshesAttrDesc.count*5);t.subMeshes=[];for(let l=0;l<n.subMeshesAttrDesc.count;l++){const h=o[l*5+0],c=o[l*5+1],u=o[l*5+2],d=o[l*5+3],f=o[l*5+4];fs.AddToMesh(h,c,u,d,f,t)}}}else if(e.positions&&e.normals&&e.indices){if(t.setVerticesData(y.PositionKind,e.positions,e.positions._updatable),t.setVerticesData(y.NormalKind,e.normals,e.normals._updatable),e.tangents&&t.setVerticesData(y.TangentKind,e.tangents,e.tangents._updatable),e.uvs&&t.setVerticesData(y.UVKind,e.uvs,e.uvs._updatable),e.uvs2&&t.setVerticesData(y.UV2Kind,e.uvs2,e.uvs2._updatable),e.uvs3&&t.setVerticesData(y.UV3Kind,e.uvs3,e.uvs3._updatable),e.uvs4&&t.setVerticesData(y.UV4Kind,e.uvs4,e.uvs4._updatable),e.uvs5&&t.setVerticesData(y.UV5Kind,e.uvs5,e.uvs5._updatable),e.uvs6&&t.setVerticesData(y.UV6Kind,e.uvs6,e.uvs6._updatable),e.colors&&t.setVerticesData(y.ColorKind,J.CheckColors4(e.colors,e.positions.length/3),e.colors._updatable),e.matricesIndices)if(e.matricesIndices._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(y.MatricesIndicesKind,e.matricesIndices,e.matricesIndices._updatable);else{const n=[];for(let o=0;o<e.matricesIndices.length;o++){const l=e.matricesIndices[o];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(y.MatricesIndicesKind,n,e.matricesIndices._updatable)}if(e.matricesIndicesExtra)if(e.matricesIndicesExtra._isExpanded)delete e.matricesIndices._isExpanded,t.setVerticesData(y.MatricesIndicesExtraKind,e.matricesIndicesExtra,e.matricesIndicesExtra._updatable);else{const n=[];for(let o=0;o<e.matricesIndicesExtra.length;o++){const l=e.matricesIndicesExtra[o];n.push(l&255),n.push((l&65280)>>8),n.push((l&16711680)>>16),n.push(l>>24&255)}t.setVerticesData(y.MatricesIndicesExtraKind,n,e.matricesIndicesExtra._updatable)}e.matricesWeights&&(os._CleanMatricesWeights(e,t),t.setVerticesData(y.MatricesWeightsKind,e.matricesWeights,e.matricesWeights._updatable)),e.matricesWeightsExtra&&t.setVerticesData(y.MatricesWeightsExtraKind,e.matricesWeightsExtra,e.matricesWeights._updatable),t.setIndices(e.indices,null)}if(e.subMeshes){t.subMeshes=[];for(let n=0;n<e.subMeshes.length;n++){const o=e.subMeshes[n];fs.AddToMesh(o.materialIndex,o.verticesStart,o.verticesCount,o.indexStart,o.indexCount,t)}}t._shouldGenerateFlatShading&&(t.convertToFlatShadedMesh(),t._shouldGenerateFlatShading=!1),t.computeWorldMatrix(!0),i.onMeshImportedObservable.notifyObservers(t)}static _CleanMatricesWeights(e,t){if(!bi.CleanBoneMatrixWeights)return;let s=0;if(e.skeletonId>-1){const u=t.getScene().getLastSkeletonById(e.skeletonId);if(!u)return;s=u.bones.length}else return;const r=t.getVerticesData(y.MatricesIndicesKind),n=t.getVerticesData(y.MatricesIndicesExtraKind),o=e.matricesWeights,l=e.matricesWeightsExtra,h=e.numBoneInfluencer,c=o.length;for(let u=0;u<c;u+=4){let d=0,f=-1;for(let p=0;p<4;p++){const _=o[u+p];d+=_,_<.001&&f<0&&(f=p)}if(l)for(let p=0;p<4;p++){const _=l[u+p];d+=_,_<.001&&f<0&&(f=p+4)}if((f<0||f>h-1)&&(f=h-1),d>.001){const p=1/d;for(let _=0;_<4;_++)o[u+_]*=p;if(l)for(let _=0;_<4;_++)l[u+_]*=p}else f>=4?(l[u+f-4]=1-d,n[u+f-4]=s):(o[u+f]=1-d,r[u+f]=s)}t.setVerticesData(y.MatricesIndicesKind,r),e.matricesWeightsExtra&&t.setVerticesData(y.MatricesIndicesExtraKind,n)}static Parse(e,t,i){const s=new os(e.id,t,void 0,e.updatable);return s._loadedUniqueId=e.uniqueId,ot&&ot.AddTagsTo(s,e.tags),e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s._boundingInfo=new Js(g.FromArray(e.boundingBoxMinimum),g.FromArray(e.boundingBoxMaximum)),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(y.UVKind),e.hasUVs2&&s._delayInfo.push(y.UV2Kind),e.hasUVs3&&s._delayInfo.push(y.UV3Kind),e.hasUVs4&&s._delayInfo.push(y.UV4Kind),e.hasUVs5&&s._delayInfo.push(y.UV5Kind),e.hasUVs6&&s._delayInfo.push(y.UV6Kind),e.hasColors&&s._delayInfo.push(y.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(y.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(y.MatricesWeightsKind),s._delayLoadingFunction=de.ImportVertexData):de.ImportVertexData(e,s),t.pushGeometry(s,!0),s}}class Qx{constructor(){this._checkCollisions=!1,this._collisionMask=-1,this._collisionGroup=-1,this._surroundingMeshes=null,this._collider=null,this._oldPositionForCollisions=new g(0,0,0),this._diffPositionForCollisions=new g(0,0,0),this._collisionResponse=!0}}class Zx{constructor(){this.facetNb=0,this.partitioningSubdivisions=10,this.partitioningBBoxRatio=1.01,this.facetDataEnabled=!1,this.facetParameters={},this.bbSize=g.Zero(),this.subDiv={max:1,X:1,Y:1,Z:1},this.facetDepthSort=!1,this.facetDepthSortEnabled=!1}}class Jx{constructor(){this._hasVertexAlpha=!1,this._useVertexColors=!0,this._numBoneInfluencers=4,this._applyFog=!0,this._receiveShadows=!1,this._facetData=new Zx,this._visibility=1,this._skeleton=null,this._layerMask=268435455,this._computeBonesUsingShaders=!0,this._isActive=!1,this._onlyForInstances=!1,this._isActiveIntermediate=!1,this._onlyForInstancesIntermediate=!1,this._actAsRegularMesh=!1,this._currentLOD=null,this._currentLODIsUpToDate=!1,this._collisionRetryCount=3,this._morphTargetManager=null,this._renderingGroupId=0,this._bakedVertexAnimationManager=null,this._material=null,this._positions=null,this._pointerOverDisableMeshTesting=!1,this._meshCollisionData=new Qx,this._enableDistantPicking=!1}}class ct extends ke{constructor(e,t=null){switch(super(e,t,!1),this._internalAbstractMeshDataInfo=new Jx,this._waitingMaterialId=null,this.cullingStrategy=ct.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,this.onCollideObservable=new X,this.onCollisionPositionChangeObservable=new X,this.onMaterialChangedObservable=new X,this.definedFacingForward=!0,this._occlusionQuery=null,this._renderingGroup=null,this.alphaIndex=Number.MAX_VALUE,this.isVisible=!0,this.isPickable=!0,this.isNearPickable=!1,this.isNearGrabbable=!1,this.showSubMeshesBoundingBox=!1,this.isBlocker=!1,this.enablePointerMoveEvents=!1,this.outlineColor=re.Red(),this.outlineWidth=.02,this.overlayColor=re.Red(),this.overlayAlpha=.5,this.useOctreeForRenderingSelection=!0,this.useOctreeForPicking=!0,this.useOctreeForCollisions=!0,this.alwaysSelectAsActiveMesh=!1,this.doNotSyncBoundingInfo=!1,this.actionManager=null,this.ellipsoid=new g(.5,1,.5),this.ellipsoidOffset=new g(0,0,0),this.edgesWidth=1,this.edgesColor=new J(1,0,0,1),this._edgesRenderer=null,this._masterMesh=null,this._boundingInfo=null,this._boundingInfoIsDirty=!0,this._renderId=0,this._intersectionsInProgress=new Array,this._unIndexed=!1,this._lightSources=new Array,this._waitingData={lods:null,actions:null,freezeWorldMatrix:null},this._bonesTransformMatrices=null,this._transformMatrixTexture=null,this.onRebuildObservable=new X,this._onCollisionPositionChange=(i,s,r=null)=>{s.subtractToRef(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions.length()>k.CollisionsEpsilon&&this.position.addInPlace(this._internalAbstractMeshDataInfo._meshCollisionData._diffPositionForCollisions),r&&this.onCollideObservable.notifyObservers(r),this.onCollisionPositionChangeObservable.notifyObservers(this.position)},t=this.getScene(),t.addMesh(this),this._resyncLightSources(),this._uniformBuffer=new Pe(this.getScene().getEngine(),void 0,void 0,e,!this.getScene().getEngine().isWebGPU),this._buildUniformLayout(),t.performancePriority){case Qs.Aggressive:this.doNotSyncBoundingInfo=!0;case Qs.Intermediate:this.alwaysSelectAsActiveMesh=!0,this.isPickable=!1;break}}static get BILLBOARDMODE_NONE(){return ke.BILLBOARDMODE_NONE}static get BILLBOARDMODE_X(){return ke.BILLBOARDMODE_X}static get BILLBOARDMODE_Y(){return ke.BILLBOARDMODE_Y}static get BILLBOARDMODE_Z(){return ke.BILLBOARDMODE_Z}static get BILLBOARDMODE_ALL(){return ke.BILLBOARDMODE_ALL}static get BILLBOARDMODE_USE_POSITION(){return ke.BILLBOARDMODE_USE_POSITION}get facetNb(){return this._internalAbstractMeshDataInfo._facetData.facetNb}get partitioningSubdivisions(){return this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions}set partitioningSubdivisions(e){this._internalAbstractMeshDataInfo._facetData.partitioningSubdivisions=e}get partitioningBBoxRatio(){return this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio}set partitioningBBoxRatio(e){this._internalAbstractMeshDataInfo._facetData.partitioningBBoxRatio=e}get mustDepthSortFacets(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSort}set mustDepthSortFacets(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSort=e}get facetDepthSortFrom(){return this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom}set facetDepthSortFrom(e){this._internalAbstractMeshDataInfo._facetData.facetDepthSortFrom=e}get collisionRetryCount(){return this._internalAbstractMeshDataInfo._collisionRetryCount}set collisionRetryCount(e){this._internalAbstractMeshDataInfo._collisionRetryCount=e}get isFacetDataEnabled(){return this._internalAbstractMeshDataInfo._facetData.facetDataEnabled}get morphTargetManager(){return this._internalAbstractMeshDataInfo._morphTargetManager}set morphTargetManager(e){this._internalAbstractMeshDataInfo._morphTargetManager!==e&&(this._internalAbstractMeshDataInfo._morphTargetManager=e,this._syncGeometryWithMorphTargetManager())}get bakedVertexAnimationManager(){return this._internalAbstractMeshDataInfo._bakedVertexAnimationManager}set bakedVertexAnimationManager(e){this._internalAbstractMeshDataInfo._bakedVertexAnimationManager!==e&&(this._internalAbstractMeshDataInfo._bakedVertexAnimationManager=e,this._markSubMeshesAsAttributesDirty())}_syncGeometryWithMorphTargetManager(){}_updateNonUniformScalingState(e){return super._updateNonUniformScalingState(e)?(this._markSubMeshesAsMiscDirty(),!0):!1}set onCollide(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver&&this.onCollideObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollideObserver=this.onCollideObservable.add(e)}set onCollisionPositionChange(e){this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver&&this.onCollisionPositionChangeObservable.remove(this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver),this._internalAbstractMeshDataInfo._meshCollisionData._onCollisionPositionChangeObserver=this.onCollisionPositionChangeObservable.add(e)}get visibility(){return this._internalAbstractMeshDataInfo._visibility}set visibility(e){if(this._internalAbstractMeshDataInfo._visibility===e)return;const t=this._internalAbstractMeshDataInfo._visibility;this._internalAbstractMeshDataInfo._visibility=e,(t===1&&e!==1||t!==1&&e===1)&&this._markSubMeshesAsMiscDirty()}get pointerOverDisableMeshTesting(){return this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting}set pointerOverDisableMeshTesting(e){this._internalAbstractMeshDataInfo._pointerOverDisableMeshTesting=e}get renderingGroupId(){return this._internalAbstractMeshDataInfo._renderingGroupId}set renderingGroupId(e){this._internalAbstractMeshDataInfo._renderingGroupId=e}get material(){return this._internalAbstractMeshDataInfo._material}set material(e){this._internalAbstractMeshDataInfo._material!==e&&(this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this._internalAbstractMeshDataInfo._material=e,e&&e.meshMap&&(e.meshMap[this.uniqueId]=this),this.onMaterialChangedObservable.hasObservers()&&this.onMaterialChangedObservable.notifyObservers(this),this.subMeshes&&(this.resetDrawCache(),this._unBindEffect()))}getMaterialForRenderPass(e){var t;return(t=this._internalAbstractMeshDataInfo._materialForRenderPass)===null||t===void 0?void 0:t[e]}setMaterialForRenderPass(e,t){this.resetDrawCache(e),this._internalAbstractMeshDataInfo._materialForRenderPass||(this._internalAbstractMeshDataInfo._materialForRenderPass=[]),this._internalAbstractMeshDataInfo._materialForRenderPass[e]=t}get receiveShadows(){return this._internalAbstractMeshDataInfo._receiveShadows}set receiveShadows(e){this._internalAbstractMeshDataInfo._receiveShadows!==e&&(this._internalAbstractMeshDataInfo._receiveShadows=e,this._markSubMeshesAsLightDirty())}get hasVertexAlpha(){return this._internalAbstractMeshDataInfo._hasVertexAlpha}set hasVertexAlpha(e){this._internalAbstractMeshDataInfo._hasVertexAlpha!==e&&(this._internalAbstractMeshDataInfo._hasVertexAlpha=e,this._markSubMeshesAsAttributesDirty(),this._markSubMeshesAsMiscDirty())}get useVertexColors(){return this._internalAbstractMeshDataInfo._useVertexColors}set useVertexColors(e){this._internalAbstractMeshDataInfo._useVertexColors!==e&&(this._internalAbstractMeshDataInfo._useVertexColors=e,this._markSubMeshesAsAttributesDirty())}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get numBoneInfluencers(){return this._internalAbstractMeshDataInfo._numBoneInfluencers}set numBoneInfluencers(e){this._internalAbstractMeshDataInfo._numBoneInfluencers!==e&&(this._internalAbstractMeshDataInfo._numBoneInfluencers=e,this._markSubMeshesAsAttributesDirty())}get applyFog(){return this._internalAbstractMeshDataInfo._applyFog}set applyFog(e){this._internalAbstractMeshDataInfo._applyFog!==e&&(this._internalAbstractMeshDataInfo._applyFog=e,this._markSubMeshesAsMiscDirty())}get enableDistantPicking(){return this._internalAbstractMeshDataInfo._enableDistantPicking}set enableDistantPicking(e){this._internalAbstractMeshDataInfo._enableDistantPicking=e}get layerMask(){return this._internalAbstractMeshDataInfo._layerMask}set layerMask(e){e!==this._internalAbstractMeshDataInfo._layerMask&&(this._internalAbstractMeshDataInfo._layerMask=e,this._resyncLightSources())}get collisionMask(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask}set collisionMask(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionMask=isNaN(e)?-1:e}get collisionResponse(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse}set collisionResponse(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionResponse=e}get collisionGroup(){return this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup}set collisionGroup(e){this._internalAbstractMeshDataInfo._meshCollisionData._collisionGroup=isNaN(e)?-1:e}get surroundingMeshes(){return this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes}set surroundingMeshes(e){this._internalAbstractMeshDataInfo._meshCollisionData._surroundingMeshes=e}get lightSources(){return this._lightSources}get _positions(){return null}set skeleton(e){const t=this._internalAbstractMeshDataInfo._skeleton;t&&t.needInitialSkinMatrix&&t._unregisterMeshWithPoseMatrix(this),e&&e.needInitialSkinMatrix&&e._registerMeshWithPoseMatrix(this),this._internalAbstractMeshDataInfo._skeleton=e,this._internalAbstractMeshDataInfo._skeleton||(this._bonesTransformMatrices=null),this._markSubMeshesAsAttributesDirty()}get skeleton(){return this._internalAbstractMeshDataInfo._skeleton}_buildUniformLayout(){this._uniformBuffer.addUniform("world",16),this._uniformBuffer.addUniform("visibility",1),this._uniformBuffer.create()}transferToEffect(e){const t=this._uniformBuffer;t.updateMatrix("world",e),t.updateFloat("visibility",this._internalAbstractMeshDataInfo._visibility),t.update()}getMeshUniformBuffer(){return this._uniformBuffer}getClassName(){return"AbstractMesh"}toString(e){let t="Name: "+this.name+", isInstance: "+(this.getClassName()!=="InstancedMesh"?"YES":"NO");t+=", # of submeshes: "+(this.subMeshes?this.subMeshes.length:0);const i=this._internalAbstractMeshDataInfo._skeleton;return i&&(t+=", skeleton: "+i.name),e&&(t+=", billboard mode: "+["NONE","X","Y",null,"Z",null,null,"ALL"][this.billboardMode],t+=", freeze wrld mat: "+(this._isWorldMatrixFrozen||this._waitingData.freezeWorldMatrix?"YES":"NO")),t}_getEffectiveParent(){return this._masterMesh&&this.billboardMode!==ke.BILLBOARDMODE_NONE?this._masterMesh:super._getEffectiveParent()}_getActionManagerForTrigger(e,t=!0){if(this.actionManager&&(t||this.actionManager.isRecursive))if(e){if(this.actionManager.hasSpecificTrigger(e))return this.actionManager}else return this.actionManager;return this.parent?this.parent._getActionManagerForTrigger(e,!1):null}_rebuild(e=!1){if(this.onRebuildObservable.notifyObservers(this),this._occlusionQuery!==null&&(this._occlusionQuery=null),!!this.subMeshes)for(const t of this.subMeshes)t._rebuild()}_resyncLightSources(){this._lightSources.length=0;for(const e of this.getScene().lights)!e.isEnabled()||e.canAffectMesh(this)&&this._lightSources.push(e);this._markSubMeshesAsLightDirty()}_resyncLightSource(e){const t=e.isEnabled()&&e.canAffectMesh(this),i=this._lightSources.indexOf(e);let s=!1;if(i===-1){if(!t)return;this._lightSources.push(e)}else{if(t)return;s=!0,this._lightSources.splice(i,1)}this._markSubMeshesAsLightDirty(s)}_unBindEffect(){for(const e of this.subMeshes)e.setEffect(null)}_removeLightSource(e,t){const i=this._lightSources.indexOf(e);i!==-1&&(this._lightSources.splice(i,1),this._markSubMeshesAsLightDirty(t))}_markSubMeshesAsDirty(e){if(!!this.subMeshes)for(const t of this.subMeshes)for(let i=0;i<t._drawWrappers.length;++i){const s=t._drawWrappers[i];!s||!s.defines||!s.defines.markAllAsDirty||e(s.defines)}}_markSubMeshesAsLightDirty(e=!1){this._markSubMeshesAsDirty(t=>t.markAsLightDirty(e))}_markSubMeshesAsAttributesDirty(){this._markSubMeshesAsDirty(e=>e.markAsAttributesDirty())}_markSubMeshesAsMiscDirty(){this._markSubMeshesAsDirty(e=>e.markAsMiscDirty())}markAsDirty(e){return this._currentRenderId=Number.MAX_VALUE,this._isDirty=!0,this}resetDrawCache(e){if(!!this.subMeshes)for(const t of this.subMeshes)t.resetDrawCache(e)}get isBlocked(){return!1}getLOD(e){return this}getTotalVertices(){return 0}getTotalIndices(){return 0}getIndices(){return null}getVerticesData(e){return null}setVerticesData(e,t,i,s){return this}updateVerticesData(e,t,i,s){return this}setIndices(e,t){return this}isVerticesDataPresent(e){return!1}getBoundingInfo(){return this._masterMesh?this._masterMesh.getBoundingInfo():(this._boundingInfoIsDirty&&(this._boundingInfoIsDirty=!1,this._updateBoundingInfo()),this._boundingInfo)}setBoundingInfo(e){return this._boundingInfo=e,this}get hasBoundingInfo(){return this._boundingInfo!==null}buildBoundingInfo(e,t,i){return this._boundingInfo=new Js(e,t,i),this._boundingInfo}normalizeToUnitCube(e=!0,t=!1,i){return super.normalizeToUnitCube(e,t,i)}get useBones(){return this.skeleton&&this.getScene().skeletonsEnabled&&this.isVerticesDataPresent(y.MatricesIndicesKind)&&this.isVerticesDataPresent(y.MatricesWeightsKind)}_preActivate(){}_preActivateForIntermediateRendering(e){}_activate(e,t){return this._renderId=e,!0}_postActivate(){}_freeze(){}_unFreeze(){}getWorldMatrix(){return this._masterMesh&&this.billboardMode===ke.BILLBOARDMODE_NONE?this._masterMesh.getWorldMatrix():super.getWorldMatrix()}_getWorldMatrixDeterminant(){return this._masterMesh?this._masterMesh._getWorldMatrixDeterminant():super._getWorldMatrixDeterminant()}get isAnInstance(){return!1}get hasInstances(){return!1}get hasThinInstances(){return!1}movePOV(e,t,i){return this.position.addInPlace(this.calcMovePOV(e,t,i)),this}calcMovePOV(e,t,i){const s=new L;(this.rotationQuaternion?this.rotationQuaternion:Q.RotationYawPitchRoll(this.rotation.y,this.rotation.x,this.rotation.z)).toRotationMatrix(s);const n=g.Zero(),o=this.definedFacingForward?-1:1;return g.TransformCoordinatesFromFloatsToRef(e*o,t,i*o,s,n),n}rotatePOV(e,t,i){return this.rotation.addInPlace(this.calcRotatePOV(e,t,i)),this}calcRotatePOV(e,t,i){const s=this.definedFacingForward?1:-1;return new g(e*s,t,i*s)}refreshBoundingInfo(e=!1,t=!1){return this._boundingInfo&&this._boundingInfo.isLocked?this:(this._refreshBoundingInfo(this._getPositionData(e,t),null),this)}_refreshBoundingInfo(e,t){if(e){const i=b_(e,0,this.getTotalVertices(),t);this._boundingInfo?this._boundingInfo.reConstruct(i.minimum,i.maximum):this._boundingInfo=new Js(i.minimum,i.maximum)}if(this.subMeshes)for(let i=0;i<this.subMeshes.length;i++)this.subMeshes[i].refreshBoundingInfo(e);this._updateBoundingInfo()}_getData(e=!1,t=!1,i,s=y.PositionKind){if(i=i!=null?i:this.getVerticesData(s).slice(),i&&t&&this.morphTargetManager){let r=0,n=0;for(let o=0;o<i.length;o++){for(let l=0;l<this.morphTargetManager.numTargets;l++){const h=this.morphTargetManager.getTarget(l),c=h.influence;if(c>0){const u=h.getPositions();u&&(i[o]+=(u[o]-i[o])*c)}}if(r++,s===y.PositionKind&&this._positions&&r===3){r=0;const l=n*3;this._positions[n++].copyFromFloats(i[l],i[l+1],i[l+2])}}}if(i&&e&&this.skeleton){const r=this.getVerticesData(y.MatricesIndicesKind),n=this.getVerticesData(y.MatricesWeightsKind);if(n&&r){const o=this.numBoneInfluencers>4,l=o?this.getVerticesData(y.MatricesIndicesExtraKind):null,h=o?this.getVerticesData(y.MatricesWeightsExtraKind):null,c=this.skeleton.getTransformMatrices(this),u=G.Vector3[0],d=G.Matrix[0],f=G.Matrix[1];let p=0;for(let _=0;_<i.length;_+=3,p+=4){d.reset();let m,v;for(m=0;m<4;m++)v=n[p+m],v>0&&(L.FromFloat32ArrayToRefScaled(c,Math.floor(r[p+m]*16),v,f),d.addToSelf(f));if(o)for(m=0;m<4;m++)v=h[p+m],v>0&&(L.FromFloat32ArrayToRefScaled(c,Math.floor(l[p+m]*16),v,f),d.addToSelf(f));s===y.NormalKind?g.TransformNormalFromFloatsToRef(i[_],i[_+1],i[_+2],d,u):g.TransformCoordinatesFromFloatsToRef(i[_],i[_+1],i[_+2],d,u),u.toArray(i,_),s===y.PositionKind&&this._positions&&this._positions[_/3].copyFrom(u)}}}return i}getNormalsData(e=!1,t=!1){return this._getData(e,t,null,y.NormalKind)}getPositionData(e=!1,t=!1,i){return this._getData(e,t,i,y.PositionKind)}_getPositionData(e,t){var i;let s=this.getVerticesData(y.PositionKind);if(this._internalAbstractMeshDataInfo._positions&&(this._internalAbstractMeshDataInfo._positions=null),s&&(e&&this.skeleton||t&&this.morphTargetManager)){if(s=s.slice(),this._generatePointsArray(),this._positions){const r=this._positions;this._internalAbstractMeshDataInfo._positions=new Array(r.length);for(let n=0;n<r.length;n++)this._internalAbstractMeshDataInfo._positions[n]=((i=r[n])===null||i===void 0?void 0:i.clone())||new g}return this.getPositionData(e,t,s)}return s}_updateBoundingInfo(){return this._boundingInfo?this._boundingInfo.update(this.worldMatrixFromCache):this._boundingInfo=new Js(g.Zero(),g.Zero(),this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}_updateSubMeshesBoundingInfo(e){if(!this.subMeshes)return this;const t=this.subMeshes.length;for(let i=0;i<t;i++){const s=this.subMeshes[i];(t>1||!s.IsGlobal)&&s.updateBoundingInfo(e)}return this}_afterComputeWorldMatrix(){this.doNotSyncBoundingInfo||(this._boundingInfoIsDirty=!0)}isInFrustum(e){return this.getBoundingInfo().isInFrustum(e,this.cullingStrategy)}isCompletelyInFrustum(e){return this.getBoundingInfo().isCompletelyInFrustum(e)}intersectsMesh(e,t=!1,i){const s=this.getBoundingInfo(),r=e.getBoundingInfo();if(s.intersects(r,t))return!0;if(i){for(const n of this.getChildMeshes())if(n.intersectsMesh(e,t,!0))return!0}return!1}intersectsPoint(e){return this.getBoundingInfo().intersectsPoint(e)}get checkCollisions(){return this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions}set checkCollisions(e){this._internalAbstractMeshDataInfo._meshCollisionData._checkCollisions=e}get collider(){return this._internalAbstractMeshDataInfo._meshCollisionData._collider}moveWithCollisions(e){this.getAbsolutePosition().addToRef(this.ellipsoidOffset,this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions);const i=this.getScene().collisionCoordinator;return this._internalAbstractMeshDataInfo._meshCollisionData._collider||(this._internalAbstractMeshDataInfo._meshCollisionData._collider=i.createCollider()),this._internalAbstractMeshDataInfo._meshCollisionData._collider._radius=this.ellipsoid,i.getNewPosition(this._internalAbstractMeshDataInfo._meshCollisionData._oldPositionForCollisions,e,this._internalAbstractMeshDataInfo._meshCollisionData._collider,this.collisionRetryCount,this,this._onCollisionPositionChange,this.uniqueId),this}_collideForSubMesh(e,t,i){var s;if(this._generatePointsArray(),!this._positions)return this;if(!e._lastColliderWorldVertices||!e._lastColliderTransformMatrix.equals(t)){e._lastColliderTransformMatrix=t.clone(),e._lastColliderWorldVertices=[],e._trianglePlanes=[];const r=e.verticesStart,n=e.verticesStart+e.verticesCount;for(let o=r;o<n;o++)e._lastColliderWorldVertices.push(g.TransformCoordinates(this._positions[o],t))}return i._collide(e._trianglePlanes,e._lastColliderWorldVertices,this.getIndices(),e.indexStart,e.indexStart+e.indexCount,e.verticesStart,!!e.getMaterial(),this,this._shouldConvertRHS(),((s=e.getMaterial())===null||s===void 0?void 0:s.fillMode)===7),this}_processCollisionsForSubMeshes(e,t){const i=this._scene.getCollidingSubMeshCandidates(this,e),s=i.length;for(let r=0;r<s;r++){const n=i.data[r];s>1&&!n._checkCollision(e)||this._collideForSubMesh(n,t,e)}return this}_shouldConvertRHS(){return!1}_checkCollision(e){if(!this.getBoundingInfo()._checkCollision(e))return this;const t=G.Matrix[0],i=G.Matrix[1];return L.ScalingToRef(1/e._radius.x,1/e._radius.y,1/e._radius.z,t),this.worldMatrixFromCache.multiplyToRef(t,i),this._processCollisionsForSubMeshes(e,i),this}_generatePointsArray(){return!1}intersects(e,t,i,s=!1,r,n=!1){const o=new ki,l=this.getClassName()==="InstancedLinesMesh"||this.getClassName()==="LinesMesh"?this.intersectionThreshold:0,h=this.getBoundingInfo();if(!this.subMeshes||!n&&(!e.intersectsSphere(h.boundingSphere,l)||!e.intersectsBox(h.boundingBox,l)))return o;if(s)return o.hit=!n,o.pickedMesh=n?null:this,o.distance=n?0:g.Distance(e.origin,h.boundingSphere.center),o.subMeshId=0,o;if(!this._generatePointsArray())return o;let c=null;const u=this._scene.getIntersectingSubMeshCandidates(this,e),d=u.length;let f=!1;for(let p=0;p<d;p++){const m=u.data[p].getMaterial();if(!!m&&(m.fillMode==7||m.fillMode==0||m.fillMode==1||m.fillMode==2||m.fillMode==4)){f=!0;break}}if(!f)return o.hit=!0,o.pickedMesh=this,o.distance=g.Distance(e.origin,h.boundingSphere.center),o.subMeshId=-1,o;for(let p=0;p<d;p++){const _=u.data[p];if(d>1&&!_.canIntersects(e))continue;const m=_.intersects(e,this._positions,this.getIndices(),t,i);if(m&&(t||!c||m.distance<c.distance)&&(c=m,c.subMeshId=p,t))break}if(c){const p=r!=null?r:this.getWorldMatrix(),_=G.Vector3[0],m=G.Vector3[1];g.TransformCoordinatesToRef(e.origin,p,_),e.direction.scaleToRef(c.distance,m);const x=g.TransformNormal(m,p).addInPlace(_);return o.hit=!0,o.distance=g.Distance(_,x),o.pickedPoint=x,o.pickedMesh=this,o.bu=c.bu||0,o.bv=c.bv||0,o.subMeshFaceId=c.faceId,o.faceId=c.faceId+u.data[c.subMeshId].indexStart/(this.getClassName().indexOf("LinesMesh")!==-1?2:3),o.subMeshId=c.subMeshId,o}return o}clone(e,t,i){return null}releaseSubMeshes(){if(this.subMeshes)for(;this.subMeshes.length;)this.subMeshes[0].dispose();else this.subMeshes=new Array;return this}dispose(e,t=!1){let i;for(this._scene.useMaterialMeshMap&&this._internalAbstractMeshDataInfo._material&&this._internalAbstractMeshDataInfo._material.meshMap&&(this._internalAbstractMeshDataInfo._material.meshMap[this.uniqueId]=void 0),this.getScene().freeActiveMeshes(),this.getScene().freeRenderingGroups(),this.actionManager!==void 0&&this.actionManager!==null&&(this.actionManager.dispose(),this.actionManager=null),this._internalAbstractMeshDataInfo._skeleton=null,this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null),i=0;i<this._intersectionsInProgress.length;i++){const n=this._intersectionsInProgress[i],o=n._intersectionsInProgress.indexOf(this);n._intersectionsInProgress.splice(o,1)}this._intersectionsInProgress.length=0,this.getScene().lights.forEach(n=>{let o=n.includedOnlyMeshes.indexOf(this);o!==-1&&n.includedOnlyMeshes.splice(o,1),o=n.excludedMeshes.indexOf(this),o!==-1&&n.excludedMeshes.splice(o,1);const l=n.getShadowGenerator();if(l){const h=l.getShadowMap();h&&h.renderList&&(o=h.renderList.indexOf(this),o!==-1&&h.renderList.splice(o,1))}}),(this.getClassName()!=="InstancedMesh"||this.getClassName()!=="InstancedLinesMesh")&&this.releaseSubMeshes();const r=this.getScene().getEngine();if(this._occlusionQuery!==null&&(this.isOcclusionQueryInProgress=!1,r.deleteQuery(this._occlusionQuery),this._occlusionQuery=null),r.wipeCaches(),this.getScene().removeMesh(this),this._parentContainer){const n=this._parentContainer.meshes.indexOf(this);n>-1&&this._parentContainer.meshes.splice(n,1),this._parentContainer=null}if(t&&this.material&&(this.material.getClassName()==="MultiMaterial"?this.material.dispose(!1,!0,!0):this.material.dispose(!1,!0)),!e)for(i=0;i<this.getScene().particleSystems.length;i++)this.getScene().particleSystems[i].emitter===this&&(this.getScene().particleSystems[i].dispose(),i--);this._internalAbstractMeshDataInfo._facetData.facetDataEnabled&&this.disableFacetData(),this._uniformBuffer.dispose(),this.onAfterWorldMatrixUpdateObservable.clear(),this.onCollideObservable.clear(),this.onCollisionPositionChangeObservable.clear(),this.onRebuildObservable.clear(),super.dispose(e,t)}addChild(e,t=!1){return e.setParent(this,t),this}removeChild(e,t=!1){return e.setParent(null,t),this}_initFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetNormals||(e.facetNormals=new Array),e.facetPositions||(e.facetPositions=new Array),e.facetPartitioning||(e.facetPartitioning=new Array),e.facetNb=this.getIndices().length/3|0,e.partitioningSubdivisions=e.partitioningSubdivisions?e.partitioningSubdivisions:10,e.partitioningBBoxRatio=e.partitioningBBoxRatio?e.partitioningBBoxRatio:1.01;for(let t=0;t<e.facetNb;t++)e.facetNormals[t]=g.Zero(),e.facetPositions[t]=g.Zero();return e.facetDataEnabled=!0,this}updateFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;e.facetDataEnabled||this._initFacetData();const t=this.getVerticesData(y.PositionKind),i=this.getIndices(),s=this.getVerticesData(y.NormalKind),r=this.getBoundingInfo();if(e.facetDepthSort&&!e.facetDepthSortEnabled){if(e.facetDepthSortEnabled=!0,i instanceof Uint16Array)e.depthSortedIndices=new Uint16Array(i);else if(i instanceof Uint32Array)e.depthSortedIndices=new Uint32Array(i);else{let o=!1;for(let l=0;l<i.length;l++)if(i[l]>65535){o=!0;break}o?e.depthSortedIndices=new Uint32Array(i):e.depthSortedIndices=new Uint16Array(i)}if(e.facetDepthSortFunction=function(o,l){return l.sqDistance-o.sqDistance},!e.facetDepthSortFrom){const o=this.getScene().activeCamera;e.facetDepthSortFrom=o?o.position:g.Zero()}e.depthSortedFacets=[];for(let o=0;o<e.facetNb;o++){const l={ind:o*3,sqDistance:0};e.depthSortedFacets.push(l)}e.invertedMatrix=L.Identity(),e.facetDepthSortOrigin=g.Zero()}e.bbSize.x=r.maximum.x-r.minimum.x>tt?r.maximum.x-r.minimum.x:tt,e.bbSize.y=r.maximum.y-r.minimum.y>tt?r.maximum.y-r.minimum.y:tt,e.bbSize.z=r.maximum.z-r.minimum.z>tt?r.maximum.z-r.minimum.z:tt;let n=e.bbSize.x>e.bbSize.y?e.bbSize.x:e.bbSize.y;if(n=n>e.bbSize.z?n:e.bbSize.z,e.subDiv.max=e.partitioningSubdivisions,e.subDiv.X=Math.floor(e.subDiv.max*e.bbSize.x/n),e.subDiv.Y=Math.floor(e.subDiv.max*e.bbSize.y/n),e.subDiv.Z=Math.floor(e.subDiv.max*e.bbSize.z/n),e.subDiv.X=e.subDiv.X<1?1:e.subDiv.X,e.subDiv.Y=e.subDiv.Y<1?1:e.subDiv.Y,e.subDiv.Z=e.subDiv.Z<1?1:e.subDiv.Z,e.facetParameters.facetNormals=this.getFacetLocalNormals(),e.facetParameters.facetPositions=this.getFacetLocalPositions(),e.facetParameters.facetPartitioning=this.getFacetLocalPartitioning(),e.facetParameters.bInfo=r,e.facetParameters.bbSize=e.bbSize,e.facetParameters.subDiv=e.subDiv,e.facetParameters.ratio=this.partitioningBBoxRatio,e.facetParameters.depthSort=e.facetDepthSort,e.facetDepthSort&&e.facetDepthSortEnabled&&(this.computeWorldMatrix(!0),this._worldMatrix.invertToRef(e.invertedMatrix),g.TransformCoordinatesToRef(e.facetDepthSortFrom,e.invertedMatrix,e.facetDepthSortOrigin),e.facetParameters.distanceTo=e.facetDepthSortOrigin),e.facetParameters.depthSortedFacets=e.depthSortedFacets,s&&de.ComputeNormals(t,i,s,e.facetParameters),e.facetDepthSort&&e.facetDepthSortEnabled){e.depthSortedFacets.sort(e.facetDepthSortFunction);const o=e.depthSortedIndices.length/3|0;for(let l=0;l<o;l++){const h=e.depthSortedFacets[l].ind;e.depthSortedIndices[l*3]=i[h],e.depthSortedIndices[l*3+1]=i[h+1],e.depthSortedIndices[l*3+2]=i[h+2]}this.updateIndices(e.depthSortedIndices,void 0,!0)}return this}getFacetLocalNormals(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetNormals||this.updateFacetData(),e.facetNormals}getFacetLocalPositions(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPositions||this.updateFacetData(),e.facetPositions}getFacetLocalPartitioning(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetPartitioning||this.updateFacetData(),e.facetPartitioning}getFacetPosition(e){const t=g.Zero();return this.getFacetPositionToRef(e,t),t}getFacetPositionToRef(e,t){const i=this.getFacetLocalPositions()[e],s=this.getWorldMatrix();return g.TransformCoordinatesToRef(i,s,t),this}getFacetNormal(e){const t=g.Zero();return this.getFacetNormalToRef(e,t),t}getFacetNormalToRef(e,t){const i=this.getFacetLocalNormals()[e];return g.TransformNormalToRef(i,this.getWorldMatrix(),t),this}getFacetsAtLocalCoordinates(e,t,i){const s=this.getBoundingInfo(),r=this._internalAbstractMeshDataInfo._facetData,n=Math.floor((e-s.minimum.x*r.partitioningBBoxRatio)*r.subDiv.X*r.partitioningBBoxRatio/r.bbSize.x),o=Math.floor((t-s.minimum.y*r.partitioningBBoxRatio)*r.subDiv.Y*r.partitioningBBoxRatio/r.bbSize.y),l=Math.floor((i-s.minimum.z*r.partitioningBBoxRatio)*r.subDiv.Z*r.partitioningBBoxRatio/r.bbSize.z);return n<0||n>r.subDiv.max||o<0||o>r.subDiv.max||l<0||l>r.subDiv.max?null:r.facetPartitioning[n+r.subDiv.max*o+r.subDiv.max*r.subDiv.max*l]}getClosestFacetAtCoordinates(e,t,i,s,r=!1,n=!0){const o=this.getWorldMatrix(),l=G.Matrix[5];o.invertToRef(l);const h=G.Vector3[8];g.TransformCoordinatesFromFloatsToRef(e,t,i,l,h);const c=this.getClosestFacetAtLocalCoordinates(h.x,h.y,h.z,s,r,n);return s&&g.TransformCoordinatesFromFloatsToRef(s.x,s.y,s.z,o,s),c}getClosestFacetAtLocalCoordinates(e,t,i,s,r=!1,n=!0){let o=null,l=0,h=0,c=0,u=0,d=0,f=0,p=0,_=0;const m=this.getFacetLocalPositions(),v=this.getFacetLocalNormals(),x=this.getFacetsAtLocalCoordinates(e,t,i);if(!x)return null;let b=Number.MAX_VALUE,S=b,C,E,A;for(let M=0;M<x.length;M++)C=x[M],E=v[C],A=m[C],u=(e-A.x)*E.x+(t-A.y)*E.y+(i-A.z)*E.z,(!r||r&&n&&u>=0||r&&!n&&u<=0)&&(u=E.x*A.x+E.y*A.y+E.z*A.z,d=-(E.x*e+E.y*t+E.z*i-u)/(E.x*E.x+E.y*E.y+E.z*E.z),f=e+E.x*d,p=t+E.y*d,_=i+E.z*d,l=f-e,h=p-t,c=_-i,S=l*l+h*h+c*c,S<b&&(b=S,o=C,s&&(s.x=f,s.y=p,s.z=_)));return o}getFacetDataParameters(){return this._internalAbstractMeshDataInfo._facetData.facetParameters}disableFacetData(){const e=this._internalAbstractMeshDataInfo._facetData;return e.facetDataEnabled&&(e.facetDataEnabled=!1,e.facetPositions=new Array,e.facetNormals=new Array,e.facetPartitioning=new Array,e.facetParameters=null,e.depthSortedIndices=new Uint32Array(0)),this}updateIndices(e,t,i=!1){return this}createNormals(e){const t=this.getVerticesData(y.PositionKind),i=this.getIndices();let s;return this.isVerticesDataPresent(y.NormalKind)?s=this.getVerticesData(y.NormalKind):s=[],de.ComputeNormals(t,i,s,{useRightHandedSystem:this.getScene().useRightHandedSystem}),this.setVerticesData(y.NormalKind,s,e),this}alignWithNormal(e,t){t||(t=ti.Y);const i=G.Vector3[0],s=G.Vector3[1];return g.CrossToRef(t,e,s),g.CrossToRef(e,s,i),this.rotationQuaternion?Q.RotationQuaternionFromAxisToRef(i,e,s,this.rotationQuaternion):g.RotationFromAxisToRef(i,e,s,this.rotation),this}_checkOcclusionQuery(){return!1}disableEdgesRendering(){throw Ve("EdgesRenderer")}enableEdgesRendering(e,t,i){throw Ve("EdgesRenderer")}getConnectedParticleSystems(){return this._scene.particleSystems.filter(e=>e.emitter===this)}}ct.OCCLUSION_TYPE_NONE=0;ct.OCCLUSION_TYPE_OPTIMISTIC=1;ct.OCCLUSION_TYPE_STRICT=2;ct.OCCLUSION_ALGORITHM_TYPE_ACCURATE=0;ct.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE=1;ct.CULLINGSTRATEGY_STANDARD=0;ct.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY=1;ct.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION=2;ct.CULLINGSTRATEGY_OPTIMISTIC_INCLUSION_THEN_BSPHERE_ONLY=3;he("BABYLON.AbstractMesh",ct);class be extends lt{constructor(e,t,i,s=!0){super(e,i),this._position=g.Zero(),this._upVector=g.Up(),this._orthoLeft=null,this._orthoRight=null,this._orthoBottom=null,this._orthoTop=null,this.fov=.8,this.projectionPlaneTilt=0,this.minZ=1,this.maxZ=1e4,this.inertia=.9,this._mode=be.PERSPECTIVE_CAMERA,this.isIntermediate=!1,this.viewport=new Es(0,0,1,1),this.layerMask=268435455,this.fovMode=be.FOVMODE_VERTICAL_FIXED,this.cameraRigMode=be.RIG_MODE_NONE,this.customRenderTargets=new Array,this.outputRenderTarget=null,this.onViewMatrixChangedObservable=new X,this.onProjectionMatrixChangedObservable=new X,this.onAfterCheckInputsObservable=new X,this.onRestoreStateObservable=new X,this.isRigCamera=!1,this._rigCameras=new Array,this._webvrViewMatrix=L.Identity(),this._skipRendering=!1,this._projectionMatrix=new L,this._postProcesses=new Array,this._activeMeshes=new mi(256),this._globalPosition=g.Zero(),this._computedViewMatrix=L.Identity(),this._doNotComputeProjectionMatrix=!1,this._transformMatrix=L.Zero(),this._refreshFrustumPlanes=!0,this._absoluteRotation=Q.Identity(),this._isCamera=!0,this._isLeftCamera=!1,this._isRightCamera=!1,this.getScene().addCamera(this),s&&!this.getScene().activeCamera&&(this.getScene().activeCamera=this),this.position=t,this.renderPassId=this.getScene().getEngine().createRenderPassId(`Camera ${e}`)}get position(){return this._position}set position(e){this._position=e}set upVector(e){this._upVector=e}get upVector(){return this._upVector}get screenArea(){var e,t,i,s;let r=0,n=0;if(this.mode===be.PERSPECTIVE_CAMERA)this.fovMode===be.FOVMODE_VERTICAL_FIXED?(n=this.minZ*2*Math.tan(this.fov/2),r=this.getEngine().getAspectRatio(this)*n):(r=this.minZ*2*Math.tan(this.fov/2),n=r/this.getEngine().getAspectRatio(this));else{const o=this.getEngine().getRenderWidth()/2,l=this.getEngine().getRenderHeight()/2;r=((e=this.orthoRight)!==null&&e!==void 0?e:o)-((t=this.orthoLeft)!==null&&t!==void 0?t:-o),n=((i=this.orthoTop)!==null&&i!==void 0?i:l)-((s=this.orthoBottom)!==null&&s!==void 0?s:-l)}return r*n}set orthoLeft(e){this._orthoLeft=e;for(const t of this._rigCameras)t.orthoLeft=e}get orthoLeft(){return this._orthoLeft}set orthoRight(e){this._orthoRight=e;for(const t of this._rigCameras)t.orthoRight=e}get orthoRight(){return this._orthoRight}set orthoBottom(e){this._orthoBottom=e;for(const t of this._rigCameras)t.orthoBottom=e}get orthoBottom(){return this._orthoBottom}set orthoTop(e){this._orthoTop=e;for(const t of this._rigCameras)t.orthoTop=e}get orthoTop(){return this._orthoTop}set mode(e){this._mode=e;for(const t of this._rigCameras)t.mode=e}get mode(){return this._mode}storeState(){return this._stateStored=!0,this._storedFov=this.fov,this}_restoreStateValues(){return this._stateStored?(this.fov=this._storedFov,!0):!1}restoreState(){return this._restoreStateValues()?(this.onRestoreStateObservable.notifyObservers(this),!0):!1}getClassName(){return"Camera"}toString(e){let t="Name: "+this.name;if(t+=", type: "+this.getClassName(),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}applyVerticalCorrection(){const e=this.absoluteRotation.toEulerAngles();this.projectionPlaneTilt=this._scene.useRightHandedSystem?-e.x:e.x}get globalPosition(){return this._globalPosition}getActiveMeshes(){return this._activeMeshes}isActiveMesh(e){return this._activeMeshes.indexOf(e)!==-1}isReady(e=!1){if(e){for(const t of this._postProcesses)if(t&&!t.isReady())return!1}return super.isReady(e)}_initCache(){super._initCache(),this._cache.position=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.upVector=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.mode=void 0,this._cache.minZ=void 0,this._cache.maxZ=void 0,this._cache.fov=void 0,this._cache.fovMode=void 0,this._cache.aspectRatio=void 0,this._cache.orthoLeft=void 0,this._cache.orthoRight=void 0,this._cache.orthoBottom=void 0,this._cache.orthoTop=void 0,this._cache.renderWidth=void 0,this._cache.renderHeight=void 0}_updateCache(e){e||super._updateCache(),this._cache.position.copyFrom(this.position),this._cache.upVector.copyFrom(this.upVector)}_isSynchronized(){return this._isSynchronizedViewMatrix()&&this._isSynchronizedProjectionMatrix()}_isSynchronizedViewMatrix(){return super._isSynchronized()?this._cache.position.equals(this.position)&&this._cache.upVector.equals(this.upVector)&&this.isSynchronizedWithParent():!1}_isSynchronizedProjectionMatrix(){let e=this._cache.mode===this.mode&&this._cache.minZ===this.minZ&&this._cache.maxZ===this.maxZ;if(!e)return!1;const t=this.getEngine();return this.mode===be.PERSPECTIVE_CAMERA?e=this._cache.fov===this.fov&&this._cache.fovMode===this.fovMode&&this._cache.aspectRatio===t.getAspectRatio(this)&&this._cache.projectionPlaneTilt===this.projectionPlaneTilt:e=this._cache.orthoLeft===this.orthoLeft&&this._cache.orthoRight===this.orthoRight&&this._cache.orthoBottom===this.orthoBottom&&this._cache.orthoTop===this.orthoTop&&this._cache.renderWidth===t.getRenderWidth()&&this._cache.renderHeight===t.getRenderHeight(),e}attachControl(e,t){}detachControl(e){}update(){this._checkInputs(),this.cameraRigMode!==be.RIG_MODE_NONE&&this._updateRigCameras()}_checkInputs(){this.onAfterCheckInputsObservable.notifyObservers(this)}get rigCameras(){return this._rigCameras}get rigPostProcess(){return this._rigPostProcess}_getFirstPostProcess(){for(let e=0;e<this._postProcesses.length;e++)if(this._postProcesses[e]!==null)return this._postProcesses[e];return null}_cascadePostProcessesToRigCams(){const e=this._getFirstPostProcess();e&&e.markTextureDirty();for(let t=0,i=this._rigCameras.length;t<i;t++){const s=this._rigCameras[t],r=s._rigPostProcess;r?(r.getEffectName()==="pass"&&(s.isIntermediate=this._postProcesses.length===0),s._postProcesses=this._postProcesses.slice(0).concat(r),r.markTextureDirty()):s._postProcesses=this._postProcesses.slice(0)}}attachPostProcess(e,t=null){return!e.isReusable()&&this._postProcesses.indexOf(e)>-1?(B.Error("You're trying to reuse a post process not defined as reusable."),0):(t==null||t<0?this._postProcesses.push(e):this._postProcesses[t]===null?this._postProcesses[t]=e:this._postProcesses.splice(t,0,e),this._cascadePostProcessesToRigCams(),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._postProcesses.indexOf(e))}detachPostProcess(e){const t=this._postProcesses.indexOf(e);t!==-1&&(this._postProcesses[t]=null),this._scene.prePassRenderer&&this._scene.prePassRenderer.markAsDirty(),this._cascadePostProcessesToRigCams()}getWorldMatrix(){return this._isSynchronizedViewMatrix()?this._worldMatrix:(this.getViewMatrix(),this._worldMatrix)}_getViewMatrix(){return L.Identity()}getViewMatrix(e){return!e&&this._isSynchronizedViewMatrix()?this._computedViewMatrix:(this.updateCache(),this._computedViewMatrix=this._getViewMatrix(),this._currentRenderId=this.getScene().getRenderId(),this._childUpdateId++,this._refreshFrustumPlanes=!0,this._cameraRigParams&&this._cameraRigParams.vrPreViewMatrix&&this._computedViewMatrix.multiplyToRef(this._cameraRigParams.vrPreViewMatrix,this._computedViewMatrix),this.parent&&this.parent.onViewMatrixChangedObservable&&this.parent.onViewMatrixChangedObservable.notifyObservers(this.parent),this.onViewMatrixChangedObservable.notifyObservers(this),this._computedViewMatrix.invertToRef(this._worldMatrix),this._computedViewMatrix)}freezeProjectionMatrix(e){this._doNotComputeProjectionMatrix=!0,e!==void 0&&(this._projectionMatrix=e)}unfreezeProjectionMatrix(){this._doNotComputeProjectionMatrix=!1}getProjectionMatrix(e){var t,i,s,r,n,o,l,h;if(this._doNotComputeProjectionMatrix||!e&&this._isSynchronizedProjectionMatrix())return this._projectionMatrix;this._cache.mode=this.mode,this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ,this._refreshFrustumPlanes=!0;const c=this.getEngine(),u=this.getScene();if(this.mode===be.PERSPECTIVE_CAMERA){this._cache.fov=this.fov,this._cache.fovMode=this.fovMode,this._cache.aspectRatio=c.getAspectRatio(this),this._cache.projectionPlaneTilt=this.projectionPlaneTilt,this.minZ<=0&&(this.minZ=.1);const d=c.useReverseDepthBuffer;let f;u.useRightHandedSystem?f=L.PerspectiveFovRHToRef:f=L.PerspectiveFovLHToRef,f(this.fov,c.getAspectRatio(this),d?this.maxZ:this.minZ,d?this.minZ:this.maxZ,this._projectionMatrix,this.fovMode===be.FOVMODE_VERTICAL_FIXED,c.isNDCHalfZRange,this.projectionPlaneTilt,c.useReverseDepthBuffer)}else{const d=c.getRenderWidth()/2,f=c.getRenderHeight()/2;u.useRightHandedSystem?L.OrthoOffCenterRHToRef((t=this.orthoLeft)!==null&&t!==void 0?t:-d,(i=this.orthoRight)!==null&&i!==void 0?i:d,(s=this.orthoBottom)!==null&&s!==void 0?s:-f,(r=this.orthoTop)!==null&&r!==void 0?r:f,this.minZ,this.maxZ,this._projectionMatrix,c.isNDCHalfZRange):L.OrthoOffCenterLHToRef((n=this.orthoLeft)!==null&&n!==void 0?n:-d,(o=this.orthoRight)!==null&&o!==void 0?o:d,(l=this.orthoBottom)!==null&&l!==void 0?l:-f,(h=this.orthoTop)!==null&&h!==void 0?h:f,this.minZ,this.maxZ,this._projectionMatrix,c.isNDCHalfZRange),this._cache.orthoLeft=this.orthoLeft,this._cache.orthoRight=this.orthoRight,this._cache.orthoBottom=this.orthoBottom,this._cache.orthoTop=this.orthoTop,this._cache.renderWidth=c.getRenderWidth(),this._cache.renderHeight=c.getRenderHeight()}return this.onProjectionMatrixChangedObservable.notifyObservers(this),this._projectionMatrix}getTransformationMatrix(){return this._computedViewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix),this._transformMatrix}_updateFrustumPlanes(){!this._refreshFrustumPlanes||(this.getTransformationMatrix(),this._frustumPlanes?$s.GetPlanesToRef(this._transformMatrix,this._frustumPlanes):this._frustumPlanes=$s.GetPlanes(this._transformMatrix),this._refreshFrustumPlanes=!1)}isInFrustum(e,t=!1){if(this._updateFrustumPlanes(),t&&this.rigCameras.length>0){let i=!1;return this.rigCameras.forEach(s=>{s._updateFrustumPlanes(),i=i||e.isInFrustum(s._frustumPlanes)}),i}else return e.isInFrustum(this._frustumPlanes)}isCompletelyInFrustum(e){return this._updateFrustumPlanes(),e.isCompletelyInFrustum(this._frustumPlanes)}getForwardRay(e=100,t,i){throw Ve("Ray")}getForwardRayToRef(e,t=100,i,s){throw Ve("Ray")}dispose(e,t=!1){for(this.onViewMatrixChangedObservable.clear(),this.onProjectionMatrixChangedObservable.clear(),this.onAfterCheckInputsObservable.clear(),this.onRestoreStateObservable.clear(),this.inputs&&this.inputs.clear(),this.getScene().stopAnimation(this),this.getScene().removeCamera(this);this._rigCameras.length>0;){const s=this._rigCameras.pop();s&&s.dispose()}if(this._parentContainer){const s=this._parentContainer.cameras.indexOf(this);s>-1&&this._parentContainer.cameras.splice(s,1),this._parentContainer=null}if(this._rigPostProcess)this._rigPostProcess.dispose(this),this._rigPostProcess=null,this._postProcesses.length=0;else if(this.cameraRigMode!==be.RIG_MODE_NONE)this._rigPostProcess=null,this._postProcesses.length=0;else{let s=this._postProcesses.length;for(;--s>=0;){const r=this._postProcesses[s];r&&r.dispose(this)}}let i=this.customRenderTargets.length;for(;--i>=0;)this.customRenderTargets[i].dispose();this.customRenderTargets.length=0,this._activeMeshes.dispose(),this.getScene().getEngine().releaseRenderPassId(this.renderPassId),super.dispose(e,t)}get isLeftCamera(){return this._isLeftCamera}get isRightCamera(){return this._isRightCamera}get leftCamera(){return this._rigCameras.length<1?null:this._rigCameras[0]}get rightCamera(){return this._rigCameras.length<2?null:this._rigCameras[1]}getLeftTarget(){return this._rigCameras.length<1?null:this._rigCameras[0].getTarget()}getRightTarget(){return this._rigCameras.length<2?null:this._rigCameras[1].getTarget()}setCameraRigMode(e,t){if(this.cameraRigMode!==e){for(;this._rigCameras.length>0;){const i=this._rigCameras.pop();i&&i.dispose()}if(this.cameraRigMode=e,this._cameraRigParams={},this._cameraRigParams.interaxialDistance=t.interaxialDistance||.0637,this._cameraRigParams.stereoHalfAngle=q.ToRadians(this._cameraRigParams.interaxialDistance/.0637),this.cameraRigMode!==be.RIG_MODE_NONE){const i=this.createRigCamera(this.name+"_L",0);i&&(i._isLeftCamera=!0);const s=this.createRigCamera(this.name+"_R",1);s&&(s._isRightCamera=!0),i&&s&&(this._rigCameras.push(i),this._rigCameras.push(s))}this._setRigMode(t),this._cascadePostProcessesToRigCams(),this.update()}}_setRigMode(e){}_getVRProjectionMatrix(){return L.PerspectiveFovLHToRef(this._cameraRigParams.vrMetrics.aspectRatioFov,this._cameraRigParams.vrMetrics.aspectRatio,this.minZ,this.maxZ,this._cameraRigParams.vrWorkMatrix,!0,this.getEngine().isNDCHalfZRange),this._cameraRigParams.vrWorkMatrix.multiplyToRef(this._cameraRigParams.vrHMatrix,this._projectionMatrix),this._projectionMatrix}_updateCameraRotationMatrix(){}_updateWebVRCameraRotationMatrix(){}_getWebVRProjectionMatrix(){return L.Identity()}_getWebVRViewMatrix(){return L.Identity()}setCameraRigParameter(e,t){this._cameraRigParams||(this._cameraRigParams={}),this._cameraRigParams[e]=t,e==="interaxialDistance"&&(this._cameraRigParams.stereoHalfAngle=q.ToRadians(t/.0637))}createRigCamera(e,t){return null}_updateRigCameras(){for(let e=0;e<this._rigCameras.length;e++)this._rigCameras[e].minZ=this.minZ,this._rigCameras[e].maxZ=this.maxZ,this._rigCameras[e].fov=this.fov,this._rigCameras[e].upVector.copyFrom(this.upVector);this.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_ANAGLYPH&&(this._rigCameras[0].viewport=this._rigCameras[1].viewport=this.viewport)}_setupInputs(){}serialize(){const e=xe.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getClassName(),this.parent&&this.parent._serializeAsParent(e),this.inputs&&this.inputs.serialize(e),xe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}clone(e,t=null){const i=xe.Clone(be.GetConstructorFromName(this.getClassName(),e,this.getScene(),this.interaxialDistance,this.isStereoscopicSideBySide),this);return i.name=e,i.parent=t,this.onClonedObservable.notifyObservers(i),i}getDirection(e){const t=g.Zero();return this.getDirectionToRef(e,t),t}get absoluteRotation(){return this.getWorldMatrix().decompose(void 0,this._absoluteRotation),this._absoluteRotation}getDirectionToRef(e,t){g.TransformNormalToRef(e,this.getWorldMatrix(),t)}static GetConstructorFromName(e,t,i,s=0,r=!0){const n=lt.Construct(e,t,i,{interaxial_distance:s,isStereoscopicSideBySide:r});return n||(()=>be._CreateDefaultParsedCamera(t,i))}computeWorldMatrix(){return this.getWorldMatrix()}static Parse(e,t){const i=e.type,s=be.GetConstructorFromName(i,e.name,t,e.interaxial_distance,e.isStereoscopicSideBySide),r=xe.Parse(s,e,t);if(e.parentId!==void 0&&(r._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(r._waitingParentInstanceIndex=e.parentInstanceIndex),r.inputs&&(r.inputs.parse(e),r._setupInputs()),e.upVector&&(r.upVector=g.FromArray(e.upVector)),r.setPosition&&(r.position.copyFromFloats(0,0,0),r.setPosition(g.FromArray(e.position))),e.target&&r.setTarget&&r.setTarget(g.FromArray(e.target)),e.cameraRigMode){const n=e.interaxial_distance?{interaxialDistance:e.interaxial_distance}:{};r.setCameraRigMode(e.cameraRigMode,n)}if(e.animations){for(let n=0;n<e.animations.length;n++){const o=e.animations[n],l=Si("BABYLON.Animation");l&&r.animations.push(l.Parse(o))}lt.ParseAnimationRanges(r,e,t)}return e.autoAnimate&&t.beginAnimation(r,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&r.setEnabled(e.isEnabled),r}}be._CreateDefaultParsedCamera=(a,e)=>{throw Ve("UniversalCamera")};be.PERSPECTIVE_CAMERA=0;be.ORTHOGRAPHIC_CAMERA=1;be.FOVMODE_VERTICAL_FIXED=0;be.FOVMODE_HORIZONTAL_FIXED=1;be.RIG_MODE_NONE=0;be.RIG_MODE_STEREOSCOPIC_ANAGLYPH=10;be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL=11;be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED=12;be.RIG_MODE_STEREOSCOPIC_OVERUNDER=13;be.RIG_MODE_STEREOSCOPIC_INTERLACED=14;be.RIG_MODE_VR=20;be.RIG_MODE_WEBVR=21;be.RIG_MODE_CUSTOM=22;be.ForceAttachControlToAlwaysPreventDefault=!1;T([Zi("position")],be.prototype,"_position",void 0);T([Zi("upVector")],be.prototype,"_upVector",void 0);T([R()],be.prototype,"orthoLeft",null);T([R()],be.prototype,"orthoRight",null);T([R()],be.prototype,"orthoBottom",null);T([R()],be.prototype,"orthoTop",null);T([R()],be.prototype,"fov",void 0);T([R()],be.prototype,"projectionPlaneTilt",void 0);T([R()],be.prototype,"minZ",void 0);T([R()],be.prototype,"maxZ",void 0);T([R()],be.prototype,"inertia",void 0);T([R()],be.prototype,"mode",null);T([R()],be.prototype,"layerMask",void 0);T([R()],be.prototype,"fovMode",void 0);T([R()],be.prototype,"cameraRigMode",void 0);T([R()],be.prototype,"interaxialDistance",void 0);T([R()],be.prototype,"isStereoscopicSideBySide",void 0);class S_{static BindClipPlane(e,t){if(t.clipPlane){const i=t.clipPlane;e.setFloat4("vClipPlane",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane2){const i=t.clipPlane2;e.setFloat4("vClipPlane2",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane3){const i=t.clipPlane3;e.setFloat4("vClipPlane3",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane4){const i=t.clipPlane4;e.setFloat4("vClipPlane4",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane5){const i=t.clipPlane5;e.setFloat4("vClipPlane5",i.normal.x,i.normal.y,i.normal.z,i.d)}if(t.clipPlane6){const i=t.clipPlane6;e.setFloat4("vClipPlane6",i.normal.x,i.normal.y,i.normal.z,i.d)}}}class se{static BindSceneUniformBuffer(e,t){t.bindToEffect(e,"Scene")}static PrepareDefinesForMergedUV(e,t,i){t._needUVs=!0,t[i]=!0,e.optimizeUVAllocation&&e.getTextureMatrix().isIdentityAs3x2()?(t[i+"DIRECTUV"]=e.coordinatesIndex+1,t["MAINUV"+(e.coordinatesIndex+1)]=!0):t[i+"DIRECTUV"]=0}static BindTextureMatrix(e,t,i){const s=e.getTextureMatrix();t.updateMatrix(i+"Matrix",s)}static GetFogState(e,t){return t.fogEnabled&&e.applyFog&&t.fogMode!==ge.FOGMODE_NONE}static PrepareDefinesForMisc(e,t,i,s,r,n,o){o._areMiscDirty&&(o.LOGARITHMICDEPTH=i,o.POINTSIZE=s,o.FOG=r&&this.GetFogState(e,t),o.NONUNIFORMSCALING=e.nonUniformScaling,o.ALPHATEST=n)}static PrepareDefinesForFrameBoundValues(e,t,i,s,r=null,n=!1){let o=!1,l=!1,h=!1,c=!1,u=!1,d=!1,f=!1;l=r==null?e.clipPlane!==void 0&&e.clipPlane!==null:r,h=r==null?e.clipPlane2!==void 0&&e.clipPlane2!==null:r,c=r==null?e.clipPlane3!==void 0&&e.clipPlane3!==null:r,u=r==null?e.clipPlane4!==void 0&&e.clipPlane4!==null:r,d=r==null?e.clipPlane5!==void 0&&e.clipPlane5!==null:r,f=r==null?e.clipPlane6!==void 0&&e.clipPlane6!==null:r,i.CLIPPLANE!==l&&(i.CLIPPLANE=l,o=!0),i.CLIPPLANE2!==h&&(i.CLIPPLANE2=h,o=!0),i.CLIPPLANE3!==c&&(i.CLIPPLANE3=c,o=!0),i.CLIPPLANE4!==u&&(i.CLIPPLANE4=u,o=!0),i.CLIPPLANE5!==d&&(i.CLIPPLANE5=d,o=!0),i.CLIPPLANE6!==f&&(i.CLIPPLANE6=f,o=!0),i.DEPTHPREPASS!==!t.getColorWrite()&&(i.DEPTHPREPASS=!i.DEPTHPREPASS,o=!0),i.INSTANCES!==s&&(i.INSTANCES=s,o=!0),i.THIN_INSTANCES!==n&&(i.THIN_INSTANCES=n,o=!0),o&&i.markAsUnprocessed()}static PrepareDefinesForBones(e,t){if(e.useBones&&e.computeBonesUsingShaders&&e.skeleton){t.NUM_BONE_INFLUENCERS=e.numBoneInfluencers;const i=t.BONETEXTURE!==void 0;if(e.skeleton.isUsingTextureForMatrices&&i)t.BONETEXTURE=!0;else{t.BonesPerMesh=e.skeleton.bones.length+1,t.BONETEXTURE=i?!1:void 0;const s=e.getScene().prePassRenderer;if(s&&s.enabled){const r=s.excludedSkinnedMesh.indexOf(e)===-1;t.BONES_VELOCITY_ENABLED=r}}}else t.NUM_BONE_INFLUENCERS=0,t.BonesPerMesh=0}static PrepareDefinesForMorphTargets(e,t){const i=e.morphTargetManager;i?(t.MORPHTARGETS_UV=i.supportsUVs&&t.UV1,t.MORPHTARGETS_TANGENT=i.supportsTangents&&t.TANGENT,t.MORPHTARGETS_NORMAL=i.supportsNormals&&t.NORMAL,t.MORPHTARGETS=i.numInfluencers>0,t.NUM_MORPH_INFLUENCERS=i.numInfluencers,t.MORPHTARGETS_TEXTURE=i.isUsingTextureForTargets):(t.MORPHTARGETS_UV=!1,t.MORPHTARGETS_TANGENT=!1,t.MORPHTARGETS_NORMAL=!1,t.MORPHTARGETS=!1,t.NUM_MORPH_INFLUENCERS=0)}static PrepareDefinesForBakedVertexAnimation(e,t){const i=e.bakedVertexAnimationManager;t.BAKED_VERTEX_ANIMATION_TEXTURE=!!(i&&i.isEnabled)}static PrepareDefinesForAttributes(e,t,i,s,r=!1,n=!0,o=!0){if(!t._areAttributesDirty&&t._needNormals===t._normals&&t._needUVs===t._uvs)return!1;t._normals=t._needNormals,t._uvs=t._needUVs,t.NORMAL=t._needNormals&&e.isVerticesDataPresent(y.NormalKind),t._needNormals&&e.isVerticesDataPresent(y.TangentKind)&&(t.TANGENT=!0);for(let l=1;l<=6;++l)t["UV"+l]=t._needUVs?e.isVerticesDataPresent(`uv${l===1?"":l}`):!1;if(i){const l=e.useVertexColors&&e.isVerticesDataPresent(y.ColorKind);t.VERTEXCOLOR=l,t.VERTEXALPHA=e.hasVertexAlpha&&l&&n}return e.isVerticesDataPresent(y.ColorInstanceKind)&&(e.hasInstances||e.hasThinInstances)&&(t.INSTANCESCOLOR=!0),s&&this.PrepareDefinesForBones(e,t),r&&this.PrepareDefinesForMorphTargets(e,t),o&&this.PrepareDefinesForBakedVertexAnimation(e,t),!0}static PrepareDefinesForMultiview(e,t){if(e.activeCamera){const i=t.MULTIVIEW;t.MULTIVIEW=e.activeCamera.outputRenderTarget!==null&&e.activeCamera.outputRenderTarget.getViewCount()>1,t.MULTIVIEW!=i&&t.markAsUnprocessed()}}static PrepareDefinesForOIT(e,t,i){const s=t.ORDER_INDEPENDENT_TRANSPARENCY,r=t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS;t.ORDER_INDEPENDENT_TRANSPARENCY=e.useOrderIndependentTransparency&&i,t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!e.getEngine().getCaps().textureFloatLinearFiltering,(s!==t.ORDER_INDEPENDENT_TRANSPARENCY||r!==t.ORDER_INDEPENDENT_TRANSPARENCY_16BITS)&&t.markAsUnprocessed()}static PrepareDefinesForPrePass(e,t,i){const s=t.PREPASS;if(!t._arePrePassDirty)return;const r=[{type:1,define:"PREPASS_POSITION",index:"PREPASS_POSITION_INDEX"},{type:2,define:"PREPASS_VELOCITY",index:"PREPASS_VELOCITY_INDEX"},{type:3,define:"PREPASS_REFLECTIVITY",index:"PREPASS_REFLECTIVITY_INDEX"},{type:0,define:"PREPASS_IRRADIANCE",index:"PREPASS_IRRADIANCE_INDEX"},{type:7,define:"PREPASS_ALBEDO_SQRT",index:"PREPASS_ALBEDO_SQRT_INDEX"},{type:5,define:"PREPASS_DEPTH",index:"PREPASS_DEPTH_INDEX"},{type:6,define:"PREPASS_NORMAL",index:"PREPASS_NORMAL_INDEX"}];if(e.prePassRenderer&&e.prePassRenderer.enabled&&i){t.PREPASS=!0,t.SCENE_MRT_COUNT=e.prePassRenderer.mrtCount;for(let n=0;n<r.length;n++){const o=e.prePassRenderer.getIndex(r[n].type);o!==-1?(t[r[n].define]=!0,t[r[n].index]=o):t[r[n].define]=!1}}else{t.PREPASS=!1;for(let n=0;n<r.length;n++)t[r[n].define]=!1}t.PREPASS!=s&&(t.markAsUnprocessed(),t.markAsImageProcessingDirty())}static PrepareDefinesForLight(e,t,i,s,r,n,o){switch(o.needNormals=!0,r["LIGHT"+s]===void 0&&(o.needRebuild=!0),r["LIGHT"+s]=!0,r["SPOTLIGHT"+s]=!1,r["HEMILIGHT"+s]=!1,r["POINTLIGHT"+s]=!1,r["DIRLIGHT"+s]=!1,i.prepareLightSpecificDefines(r,s),r["LIGHT_FALLOFF_PHYSICAL"+s]=!1,r["LIGHT_FALLOFF_GLTF"+s]=!1,r["LIGHT_FALLOFF_STANDARD"+s]=!1,i.falloffType){case Tt.FALLOFF_GLTF:r["LIGHT_FALLOFF_GLTF"+s]=!0;break;case Tt.FALLOFF_PHYSICAL:r["LIGHT_FALLOFF_PHYSICAL"+s]=!0;break;case Tt.FALLOFF_STANDARD:r["LIGHT_FALLOFF_STANDARD"+s]=!0;break}if(n&&!i.specular.equalsFloats(0,0,0)&&(o.specularEnabled=!0),r["SHADOW"+s]=!1,r["SHADOWCSM"+s]=!1,r["SHADOWCSMDEBUG"+s]=!1,r["SHADOWCSMNUM_CASCADES"+s]=!1,r["SHADOWCSMUSESHADOWMAXZ"+s]=!1,r["SHADOWCSMNOBLEND"+s]=!1,r["SHADOWCSM_RIGHTHANDED"+s]=!1,r["SHADOWPCF"+s]=!1,r["SHADOWPCSS"+s]=!1,r["SHADOWPOISSON"+s]=!1,r["SHADOWESM"+s]=!1,r["SHADOWCLOSEESM"+s]=!1,r["SHADOWCUBE"+s]=!1,r["SHADOWLOWQUALITY"+s]=!1,r["SHADOWMEDIUMQUALITY"+s]=!1,t&&t.receiveShadows&&e.shadowsEnabled&&i.shadowEnabled){const l=i.getShadowGenerator();if(l){const h=l.getShadowMap();h&&h.renderList&&h.renderList.length>0&&(o.shadowEnabled=!0,l.prepareDefines(r,s))}}i.lightmapMode!=Tt.LIGHTMAP_DEFAULT?(o.lightmapMode=!0,r["LIGHTMAPEXCLUDED"+s]=!0,r["LIGHTMAPNOSPECULAR"+s]=i.lightmapMode==Tt.LIGHTMAP_SHADOWSONLY):(r["LIGHTMAPEXCLUDED"+s]=!1,r["LIGHTMAPNOSPECULAR"+s]=!1)}static PrepareDefinesForLights(e,t,i,s,r=4,n=!1){if(!i._areLightsDirty)return i._needNormals;let o=0;const l={needNormals:i._needNormals,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};if(e.lightsEnabled&&!n){for(const c of t.lightSources)if(this.PrepareDefinesForLight(e,t,c,o,i,s,l),o++,o===r)break}i.SPECULARTERM=l.specularEnabled,i.SHADOWS=l.shadowEnabled;for(let c=o;c<r;c++)i["LIGHT"+c]!==void 0&&(i["LIGHT"+c]=!1,i["HEMILIGHT"+c]=!1,i["POINTLIGHT"+c]=!1,i["DIRLIGHT"+c]=!1,i["SPOTLIGHT"+c]=!1,i["SHADOW"+c]=!1,i["SHADOWCSM"+c]=!1,i["SHADOWCSMDEBUG"+c]=!1,i["SHADOWCSMNUM_CASCADES"+c]=!1,i["SHADOWCSMUSESHADOWMAXZ"+c]=!1,i["SHADOWCSMNOBLEND"+c]=!1,i["SHADOWCSM_RIGHTHANDED"+c]=!1,i["SHADOWPCF"+c]=!1,i["SHADOWPCSS"+c]=!1,i["SHADOWPOISSON"+c]=!1,i["SHADOWESM"+c]=!1,i["SHADOWCLOSEESM"+c]=!1,i["SHADOWCUBE"+c]=!1,i["SHADOWLOWQUALITY"+c]=!1,i["SHADOWMEDIUMQUALITY"+c]=!1);const h=e.getEngine().getCaps();return i.SHADOWFLOAT===void 0&&(l.needRebuild=!0),i.SHADOWFLOAT=l.shadowEnabled&&(h.textureFloatRender&&h.textureFloatLinearFiltering||h.textureHalfFloatRender&&h.textureHalfFloatLinearFiltering),i.LIGHTMAPEXCLUDED=l.lightmapMode,l.needRebuild&&i.rebuild(),l.needNormals}static PrepareUniformsAndSamplersForLight(e,t,i,s,r=null,n=!1){r&&r.push("Light"+e),!n&&(t.push("vLightData"+e,"vLightDiffuse"+e,"vLightSpecular"+e,"vLightDirection"+e,"vLightFalloff"+e,"vLightGround"+e,"lightMatrix"+e,"shadowsInfo"+e,"depthValues"+e),i.push("shadowSampler"+e),i.push("depthSampler"+e),t.push("viewFrustumZ"+e,"cascadeBlendFactor"+e,"lightSizeUVCorrection"+e,"depthCorrection"+e,"penumbraDarkness"+e,"frustumLengths"+e),s&&(i.push("projectionLightSampler"+e),t.push("textureProjectionMatrix"+e)))}static PrepareUniformsAndSamplersList(e,t,i,s=4){let r,n=null;if(e.uniformsNames){const o=e;r=o.uniformsNames,n=o.uniformBuffersNames,t=o.samplers,i=o.defines,s=o.maxSimultaneousLights||0}else r=e,t||(t=[]);for(let o=0;o<s&&i["LIGHT"+o];o++)this.PrepareUniformsAndSamplersForLight(o,r,t,i["PROJECTEDLIGHTTEXTURE"+o],n);i.NUM_MORPH_INFLUENCERS&&r.push("morphTargetInfluences"),i.BAKED_VERTEX_ANIMATION_TEXTURE&&(r.push("bakedVertexAnimationSettings"),r.push("bakedVertexAnimationTextureSizeInverted"),r.push("bakedVertexAnimationTime"),t.push("bakedVertexAnimationTexture"))}static HandleFallbacksForShadows(e,t,i=4,s=0){let r=0;for(let n=0;n<i&&e["LIGHT"+n];n++)n>0&&(r=s+n,t.addFallback(r,"LIGHT"+n)),e.SHADOWS||(e["SHADOW"+n]&&t.addFallback(s,"SHADOW"+n),e["SHADOWPCF"+n]&&t.addFallback(s,"SHADOWPCF"+n),e["SHADOWPCSS"+n]&&t.addFallback(s,"SHADOWPCSS"+n),e["SHADOWPOISSON"+n]&&t.addFallback(s,"SHADOWPOISSON"+n),e["SHADOWESM"+n]&&t.addFallback(s,"SHADOWESM"+n),e["SHADOWCLOSEESM"+n]&&t.addFallback(s,"SHADOWCLOSEESM"+n));return r++}static PrepareAttributesForMorphTargetsInfluencers(e,t,i){this._TmpMorphInfluencers.NUM_MORPH_INFLUENCERS=i,this.PrepareAttributesForMorphTargets(e,t,this._TmpMorphInfluencers)}static PrepareAttributesForMorphTargets(e,t,i){const s=i.NUM_MORPH_INFLUENCERS;if(s>0&&ye.LastCreatedEngine){const r=ye.LastCreatedEngine.getCaps().maxVertexAttribs,n=t.morphTargetManager;if(n!=null&&n.isUsingTextureForTargets)return;const o=n&&n.supportsNormals&&i.NORMAL,l=n&&n.supportsTangents&&i.TANGENT,h=n&&n.supportsUVs&&i.UV1;for(let c=0;c<s;c++)e.push(y.PositionKind+c),o&&e.push(y.NormalKind+c),l&&e.push(y.TangentKind+c),h&&e.push(y.UVKind+"_"+c),e.length>r&&B.Error("Cannot add more vertex attributes for mesh "+t.name)}}static PrepareAttributesForBakedVertexAnimation(e,t,i){i.BAKED_VERTEX_ANIMATION_TEXTURE&&i.INSTANCES&&e.push("bakedVertexAnimationSettingsInstanced")}static PrepareAttributesForBones(e,t,i,s){i.NUM_BONE_INFLUENCERS>0&&(s.addCPUSkinningFallback(0,t),e.push(y.MatricesIndicesKind),e.push(y.MatricesWeightsKind),i.NUM_BONE_INFLUENCERS>4&&(e.push(y.MatricesIndicesExtraKind),e.push(y.MatricesWeightsExtraKind)))}static PrepareAttributesForInstances(e,t){(t.INSTANCES||t.THIN_INSTANCES)&&this.PushAttributesForInstances(e,!!t.PREPASS_VELOCITY),t.INSTANCESCOLOR&&e.push(y.ColorInstanceKind)}static PushAttributesForInstances(e,t=!1){e.push("world0"),e.push("world1"),e.push("world2"),e.push("world3"),t&&(e.push("previousWorld0"),e.push("previousWorld1"),e.push("previousWorld2"),e.push("previousWorld3"))}static BindLightProperties(e,t,i){e.transferToEffect(t,i+"")}static BindLight(e,t,i,s,r,n=!0){e._bindLight(t,i,s,r,n)}static BindLights(e,t,i,s,r=4){const n=Math.min(t.lightSources.length,r);for(let o=0;o<n;o++){const l=t.lightSources[o];this.BindLight(l,o,e,i,typeof s=="boolean"?s:s.SPECULARTERM,t.receiveShadows)}}static BindFogParameters(e,t,i,s=!1){e.fogEnabled&&t.applyFog&&e.fogMode!==ge.FOGMODE_NONE&&(i.setFloat4("vFogInfos",e.fogMode,e.fogStart,e.fogEnd,e.fogDensity),s?(e.fogColor.toLinearSpaceToRef(this._TempFogColor),i.setColor3("vFogColor",this._TempFogColor)):i.setColor3("vFogColor",e.fogColor))}static BindBonesParameters(e,t,i){if(!(!t||!e)&&(e.computeBonesUsingShaders&&t._bonesComputationForcedToCPU&&(e.computeBonesUsingShaders=!1),e.useBones&&e.computeBonesUsingShaders&&e.skeleton)){const s=e.skeleton;if(s.isUsingTextureForMatrices&&t.getUniformIndex("boneTextureWidth")>-1){const r=s.getTransformMatrixTexture(e);t.setTexture("boneSampler",r),t.setFloat("boneTextureWidth",4*(s.bones.length+1))}else{const r=s.getTransformMatrices(e);r&&(t.setMatrices("mBones",r),i&&e.getScene().prePassRenderer&&e.getScene().prePassRenderer.getIndex(2)&&(i.previousBones[e.uniqueId]||(i.previousBones[e.uniqueId]=r.slice()),t.setMatrices("mPreviousBones",i.previousBones[e.uniqueId]),se._CopyBonesTransformationMatrices(r,i.previousBones[e.uniqueId])))}}}static _CopyBonesTransformationMatrices(e,t){return t.set(e),t}static BindMorphTargetParameters(e,t){const i=e.morphTargetManager;!e||!i||t.setFloatArray("morphTargetInfluences",i.influences)}static BindLogDepth(e,t,i){if(!e||e.LOGARITHMICDEPTH||e.indexOf&&e.indexOf("LOGARITHMICDEPTH")>=0){const s=i.activeCamera;s.mode===be.ORTHOGRAPHIC_CAMERA&&B.Error("Logarithmic depth is not compatible with orthographic cameras!",20),t.setFloat("logarithmicDepthConstant",2/(Math.log(s.maxZ+1)/Math.LN2))}}static BindClipPlane(e,t){S_.BindClipPlane(e,t)}}se._TmpMorphInfluencers={NUM_MORPH_INFLUENCERS:0};se._TempFogColor=re.Black();class En{constructor(){this.reset()}reset(){this.enabled=!1,this.mask=255,this.func=519,this.funcRef=1,this.funcMask=255,this.opStencilFail=7680,this.opDepthFail=7680,this.opStencilDepthPass=7681}get func(){return this._func}set func(e){this._func=e}get funcRef(){return this._funcRef}set funcRef(e){this._funcRef=e}get funcMask(){return this._funcMask}set funcMask(e){this._funcMask=e}get opStencilFail(){return this._opStencilFail}set opStencilFail(e){this._opStencilFail=e}get opDepthFail(){return this._opDepthFail}set opDepthFail(e){this._opDepthFail=e}get opStencilDepthPass(){return this._opStencilDepthPass}set opStencilDepthPass(e){this._opStencilDepthPass=e}get mask(){return this._mask}set mask(e){this._mask=e}get enabled(){return this._enabled}set enabled(e){this._enabled=e}getClassName(){return"MaterialStencilState"}copyTo(e){xe.Clone(()=>e,this)}serialize(){return xe.Serialize(this)}parse(e,t,i){xe.Parse(()=>this,e,t,i)}}T([R()],En.prototype,"func",null);T([R()],En.prototype,"funcRef",null);T([R()],En.prototype,"funcMask",null);T([R()],En.prototype,"opStencilFail",null);T([R()],En.prototype,"opDepthFail",null);T([R()],En.prototype,"opStencilDepthPass",null);T([R()],En.prototype,"mask",null);T([R()],En.prototype,"enabled",null);var Wi;(function(a){a[a.Created=1]="Created",a[a.Disposed=2]="Disposed",a[a.GetDefineNames=4]="GetDefineNames",a[a.PrepareUniformBuffer=8]="PrepareUniformBuffer",a[a.IsReadyForSubMesh=16]="IsReadyForSubMesh",a[a.PrepareDefines=32]="PrepareDefines",a[a.BindForSubMesh=64]="BindForSubMesh",a[a.PrepareEffect=128]="PrepareEffect",a[a.GetAnimatables=256]="GetAnimatables",a[a.GetActiveTextures=512]="GetActiveTextures",a[a.HasTexture=1024]="HasTexture",a[a.FillRenderTargetTextures=2048]="FillRenderTargetTextures",a[a.HasRenderTargetTextures=4096]="HasRenderTargetTextures",a[a.HardBindForSubMesh=8192]="HardBindForSubMesh"})(Wi||(Wi={}));class ne{constructor(e,t,i){this.shadowDepthWrapper=null,this.allowShaderHotSwapping=!0,this.metadata=null,this.reservedDataStore=null,this.checkReadyOnEveryCall=!1,this.checkReadyOnlyOnce=!1,this.state="",this._alpha=1,this._backFaceCulling=!0,this._cullBackFaces=!0,this._blockDirtyMechanism=!1,this.onCompiled=null,this.onError=null,this.getRenderTargetTextures=null,this.doNotSerialize=!1,this._storeEffectOnSubMeshes=!1,this.animations=null,this.onDisposeObservable=new X,this._onDisposeObserver=null,this._onUnBindObservable=null,this._onBindObserver=null,this._alphaMode=2,this._needDepthPrePass=!1,this.disableDepthWrite=!1,this.disableColorWrite=!1,this.forceDepthWrite=!1,this.depthFunction=0,this.separateCullingPass=!1,this._fogEnabled=!0,this.pointSize=1,this.zOffset=0,this.zOffsetUnits=0,this.stencil=new En,this._useUBO=!1,this._fillMode=ne.TriangleFillMode,this._cachedDepthWriteState=!1,this._cachedColorWriteState=!1,this._cachedDepthFunctionState=0,this._indexInSceneMaterialArray=-1,this.meshMap=null,this._parentContainer=null,this._uniformBufferLayoutBuilt=!1,this._eventInfo={},this._callbackPluginEventGeneric=()=>{},this._callbackPluginEventIsReadyForSubMesh=()=>{},this._callbackPluginEventPrepareDefines=()=>{},this._callbackPluginEventPrepareDefinesBeforeAttributes=()=>{},this._callbackPluginEventHardBindForSubMesh=()=>{},this._callbackPluginEventBindForSubMesh=()=>{},this._callbackPluginEventHasRenderTargetTextures=()=>{},this._callbackPluginEventFillRenderTargetTextures=()=>{},this._forceAlphaTest=!1,this._transparencyMode=null,this.name=e;const s=t||ye.LastCreatedScene;!s||(this._scene=s,this._dirtyCallbacks={},this._dirtyCallbacks[1]=this._markAllSubMeshesAsTexturesDirty.bind(this),this._dirtyCallbacks[2]=this._markAllSubMeshesAsLightsDirty.bind(this),this._dirtyCallbacks[4]=this._markAllSubMeshesAsFresnelDirty.bind(this),this._dirtyCallbacks[8]=this._markAllSubMeshesAsAttributesDirty.bind(this),this._dirtyCallbacks[16]=this._markAllSubMeshesAsMiscDirty.bind(this),this._dirtyCallbacks[32]=this._markAllSubMeshesAsPrePassDirty.bind(this),this._dirtyCallbacks[63]=this._markAllSubMeshesAsAllDirty.bind(this),this.id=e||q.RandomId(),this.uniqueId=this._scene.getUniqueId(),this._materialContext=this._scene.getEngine().createMaterialContext(),this._drawWrapper=new Vi(this._scene.getEngine(),!1),this._drawWrapper.materialContext=this._materialContext,this._scene.useRightHandedSystem?this.sideOrientation=ne.ClockWiseSideOrientation:this.sideOrientation=ne.CounterClockWiseSideOrientation,this._uniformBuffer=new Pe(this._scene.getEngine(),void 0,void 0,e),this._useUBO=this.getScene().getEngine().supportsUniformBuffers,i||this._scene.addMaterial(this),this._scene.useMaterialMeshMap&&(this.meshMap={}),ne.OnEventObservable.notifyObservers(this,Wi.Created))}get canRenderToMRT(){return!1}set alpha(e){if(this._alpha===e)return;const t=this._alpha;this._alpha=e,(t===1||e===1)&&this.markAsDirty(ne.MiscDirtyFlag)}get alpha(){return this._alpha}set backFaceCulling(e){this._backFaceCulling!==e&&(this._backFaceCulling=e,this.markAsDirty(ne.TextureDirtyFlag))}get backFaceCulling(){return this._backFaceCulling}set cullBackFaces(e){this._cullBackFaces!==e&&(this._cullBackFaces=e,this.markAsDirty(ne.TextureDirtyFlag))}get cullBackFaces(){return this._cullBackFaces}get blockDirtyMechanism(){return this._blockDirtyMechanism}set blockDirtyMechanism(e){this._blockDirtyMechanism!==e&&(this._blockDirtyMechanism=e,e||this.markDirty())}atomicMaterialsUpdate(e){this.blockDirtyMechanism=!0;try{e(this)}finally{this.blockDirtyMechanism=!1}}get hasRenderTargetTextures(){return this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._eventInfo.hasRenderTargetTextures}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get onBindObservable(){return this._onBindObservable||(this._onBindObservable=new X),this._onBindObservable}set onBind(e){this._onBindObserver&&this.onBindObservable.remove(this._onBindObserver),this._onBindObserver=this.onBindObservable.add(e)}get onUnBindObservable(){return this._onUnBindObservable||(this._onUnBindObservable=new X),this._onUnBindObservable}get onEffectCreatedObservable(){return this._onEffectCreatedObservable||(this._onEffectCreatedObservable=new X),this._onEffectCreatedObservable}set alphaMode(e){this._alphaMode!==e&&(this._alphaMode=e,this.markAsDirty(ne.TextureDirtyFlag))}get alphaMode(){return this._alphaMode}set needDepthPrePass(e){this._needDepthPrePass!==e&&(this._needDepthPrePass=e,this._needDepthPrePass&&(this.checkReadyOnEveryCall=!0))}get needDepthPrePass(){return this._needDepthPrePass}get isPrePassCapable(){return!1}set fogEnabled(e){this._fogEnabled!==e&&(this._fogEnabled=e,this.markAsDirty(ne.MiscDirtyFlag))}get fogEnabled(){return this._fogEnabled}get wireframe(){switch(this._fillMode){case ne.WireFrameFillMode:case ne.LineListDrawMode:case ne.LineLoopDrawMode:case ne.LineStripDrawMode:return!0}return this._scene.forceWireframe}set wireframe(e){this.fillMode=e?ne.WireFrameFillMode:ne.TriangleFillMode}get pointsCloud(){switch(this._fillMode){case ne.PointFillMode:case ne.PointListDrawMode:return!0}return this._scene.forcePointsCloud}set pointsCloud(e){this.fillMode=e?ne.PointFillMode:ne.TriangleFillMode}get fillMode(){return this._fillMode}set fillMode(e){this._fillMode!==e&&(this._fillMode=e,this.markAsDirty(ne.MiscDirtyFlag))}_getDrawWrapper(){return this._drawWrapper}_setDrawWrapper(e){this._drawWrapper=e}toString(e){return"Name: "+this.name}getClassName(){return"Material"}get isFrozen(){return this.checkReadyOnlyOnce}freeze(){this.markDirty(),this.checkReadyOnlyOnce=!0}unfreeze(){this.markDirty(),this.checkReadyOnlyOnce=!1}isReady(e,t){return!0}isReadyForSubMesh(e,t,i){const s=t.materialDefines;return s?(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),this._eventInfo.isReadyForSubMesh):!1}getEffect(){return this._drawWrapper.effect}getScene(){return this._scene}get transparencyMode(){return this._transparencyMode}set transparencyMode(e){this._transparencyMode!==e&&(this._transparencyMode=e,this._forceAlphaTest=e===ne.MATERIAL_ALPHATESTANDBLEND,this._markAllSubMeshesAsTexturesAndMiscDirty())}get _disableAlphaBlending(){return this._transparencyMode===ne.MATERIAL_OPAQUE||this._transparencyMode===ne.MATERIAL_ALPHATEST}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1}needAlphaBlendingForMesh(e){return e.visibility<1?!0:this._disableAlphaBlending?!1:e.hasVertexAlpha||this.needAlphaBlending()}needAlphaTesting(){return!!this._forceAlphaTest}_shouldTurnAlphaTestOn(e){return!this.needAlphaBlendingForMesh(e)&&this.needAlphaTesting()}getAlphaTestTexture(){return null}markDirty(){const e=this.getScene().meshes;for(const t of e)if(!!t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&(!i.effect||(i.effect._wasPreviouslyReady=!1,i.effect._wasPreviouslyUsingInstances=null))}_preBind(e,t=null){const i=this._scene.getEngine(),r=(t==null?this.sideOrientation:t)===ne.ClockWiseSideOrientation;return i.enableEffect(e||this._getDrawWrapper()),i.setState(this.backFaceCulling,this.zOffset,!1,r,this.cullBackFaces,this.stencil,this.zOffsetUnits),r}bind(e,t){}buildUniformLayout(){const e=this._uniformBuffer;this._eventInfo.ubo=e,this._callbackPluginEventGeneric(Wi.PrepareUniformBuffer,this._eventInfo),e.create(),this._uniformBufferLayoutBuilt=!0}bindForSubMesh(e,t,i){!i.effect||(this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo))}bindOnlyWorldMatrix(e){}bindView(e){this._useUBO?this._needToBindSceneUbo=!0:e.setMatrix("view",this.getScene().getViewMatrix())}bindViewProjection(e){this._useUBO?this._needToBindSceneUbo=!0:(e.setMatrix("viewProjection",this.getScene().getTransformMatrix()),e.setMatrix("projection",this.getScene().getProjectionMatrix()))}bindEyePosition(e,t){this._useUBO?this._needToBindSceneUbo=!0:this._scene.bindEyePosition(e,t)}_afterBind(e,t=null){if(this._scene._cachedMaterial=this,this._needToBindSceneUbo&&t&&(this._needToBindSceneUbo=!1,se.BindSceneUniformBuffer(t,this.getScene().getSceneUniformBuffer()),this._scene.finalizeSceneUbo()),e?this._scene._cachedVisibility=e.visibility:this._scene._cachedVisibility=1,this._onBindObservable&&e&&this._onBindObservable.notifyObservers(e),this.disableDepthWrite){const i=this._scene.getEngine();this._cachedDepthWriteState=i.getDepthWrite(),i.setDepthWrite(!1)}if(this.disableColorWrite){const i=this._scene.getEngine();this._cachedColorWriteState=i.getColorWrite(),i.setColorWrite(!1)}if(this.depthFunction!==0){const i=this._scene.getEngine();this._cachedDepthFunctionState=i.getDepthFunction()||0,i.setDepthFunction(this.depthFunction)}}unbind(){this._onUnBindObservable&&this._onUnBindObservable.notifyObservers(this),this.depthFunction!==0&&this._scene.getEngine().setDepthFunction(this._cachedDepthFunctionState),this.disableDepthWrite&&this._scene.getEngine().setDepthWrite(this._cachedDepthWriteState),this.disableColorWrite&&this._scene.getEngine().setColorWrite(this._cachedColorWriteState)}getAnimatables(){return this._eventInfo.animatables=[],this._callbackPluginEventGeneric(Wi.GetAnimatables,this._eventInfo),this._eventInfo.animatables}getActiveTextures(){return this._eventInfo.activeTextures=[],this._callbackPluginEventGeneric(Wi.GetActiveTextures,this._eventInfo),this._eventInfo.activeTextures}hasTexture(e){return this._eventInfo.hasTexture=!1,this._eventInfo.texture=e,this._callbackPluginEventGeneric(Wi.HasTexture,this._eventInfo),this._eventInfo.hasTexture}clone(e){return null}getBindedMeshes(){if(this.meshMap){const e=new Array;for(const t in this.meshMap){const i=this.meshMap[t];i&&e.push(i)}return e}else return this._scene.meshes.filter(t=>t.material===this)}forceCompilation(e,t,i,s){const r={clipPlane:!1,useInstances:!1,...i},n=this.getScene(),o=this.allowShaderHotSwapping;this.allowShaderHotSwapping=!1;const l=()=>{if(!this._scene||!this._scene.getEngine())return;const h=n.clipPlane;if(r.clipPlane&&(n.clipPlane=new Hi(0,0,0,1)),this._storeEffectOnSubMeshes){let c=!0,u=null;if(e.subMeshes){const d=new fs(0,0,0,0,0,e,void 0,!1,!1);d.materialDefines&&(d.materialDefines._renderId=-1),this.isReadyForSubMesh(e,d,r.useInstances)||(d.effect&&d.effect.getCompilationError()&&d.effect.allFallbacksProcessed()?u=d.effect.getCompilationError():(c=!1,setTimeout(l,16)))}c&&(this.allowShaderHotSwapping=o,u&&s&&s(u),t&&t(this))}else this.isReady()?(this.allowShaderHotSwapping=o,t&&t(this)):setTimeout(l,16);r.clipPlane&&(n.clipPlane=h)};l()}forceCompilationAsync(e,t){return new Promise((i,s)=>{this.forceCompilation(e,()=>{i()},t,r=>{s(r)})})}markAsDirty(e){this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism||(ne._DirtyCallbackArray.length=0,e&ne.TextureDirtyFlag&&ne._DirtyCallbackArray.push(ne._TextureDirtyCallBack),e&ne.LightDirtyFlag&&ne._DirtyCallbackArray.push(ne._LightsDirtyCallBack),e&ne.FresnelDirtyFlag&&ne._DirtyCallbackArray.push(ne._FresnelDirtyCallBack),e&ne.AttributesDirtyFlag&&ne._DirtyCallbackArray.push(ne._AttributeDirtyCallBack),e&ne.MiscDirtyFlag&&ne._DirtyCallbackArray.push(ne._MiscDirtyCallBack),e&ne.PrePassDirtyFlag&&ne._DirtyCallbackArray.push(ne._PrePassDirtyCallBack),ne._DirtyCallbackArray.length&&this._markAllSubMeshesAsDirty(ne._RunDirtyCallBacks),this.getScene().resetCachedMaterial())}resetDrawCache(){const e=this.getScene().meshes;for(const t of e)if(!!t.subMeshes)for(const i of t.subMeshes)i.getMaterial()===this&&i.resetDrawCache()}_markAllSubMeshesAsDirty(e){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const t=this.getScene().meshes;for(const i of t)if(!!i.subMeshes){for(const s of i.subMeshes)if(s.getMaterial(!1)===this)for(const r of s._drawWrappers)!r||!r.defines||!r.defines.markAllAsDirty||this._materialContext===r.materialContext&&e(r.defines)}}_markScenePrePassDirty(){if(this.getScene().blockMaterialDirtyMechanism||this._blockDirtyMechanism)return;const e=this.getScene().enablePrePassRenderer();e&&e.markAsDirty()}_markAllSubMeshesAsAllDirty(){this._markAllSubMeshesAsDirty(ne._AllDirtyCallBack)}_markAllSubMeshesAsImageProcessingDirty(){this._markAllSubMeshesAsDirty(ne._ImageProcessingDirtyCallBack)}_markAllSubMeshesAsTexturesDirty(){this._markAllSubMeshesAsDirty(ne._TextureDirtyCallBack)}_markAllSubMeshesAsFresnelDirty(){this._markAllSubMeshesAsDirty(ne._FresnelDirtyCallBack)}_markAllSubMeshesAsFresnelAndMiscDirty(){this._markAllSubMeshesAsDirty(ne._FresnelAndMiscDirtyCallBack)}_markAllSubMeshesAsLightsDirty(){this._markAllSubMeshesAsDirty(ne._LightsDirtyCallBack)}_markAllSubMeshesAsAttributesDirty(){this._markAllSubMeshesAsDirty(ne._AttributeDirtyCallBack)}_markAllSubMeshesAsMiscDirty(){this._markAllSubMeshesAsDirty(ne._MiscDirtyCallBack)}_markAllSubMeshesAsPrePassDirty(){this._markAllSubMeshesAsDirty(ne._MiscDirtyCallBack)}_markAllSubMeshesAsTexturesAndMiscDirty(){this._markAllSubMeshesAsDirty(ne._TextureAndMiscDirtyCallBack)}setPrePassRenderer(e){return!1}dispose(e,t,i){const s=this.getScene();if(s.stopAnimation(this),s.freeProcessedMaterials(),s.removeMaterial(this),this._eventInfo.forceDisposeTextures=t,this._callbackPluginEventGeneric(Wi.Disposed,this._eventInfo),this._parentContainer){const r=this._parentContainer.materials.indexOf(this);r>-1&&this._parentContainer.materials.splice(r,1),this._parentContainer=null}if(i!==!0)if(this.meshMap)for(const r in this.meshMap){const n=this.meshMap[r];n&&(n.material=null,this.releaseVertexArrayObject(n,e))}else{const r=s.meshes;for(const n of r)n.material===this&&!n.sourceMesh&&(n.material=null,this.releaseVertexArrayObject(n,e))}this._uniformBuffer.dispose(),e&&this._drawWrapper.effect&&(this._storeEffectOnSubMeshes||this._drawWrapper.effect.dispose(),this._drawWrapper.effect=null),this.metadata=null,this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._onBindObservable&&this._onBindObservable.clear(),this._onUnBindObservable&&this._onUnBindObservable.clear(),this._onEffectCreatedObservable&&this._onEffectCreatedObservable.clear()}releaseVertexArrayObject(e,t){if(e.geometry){const i=e.geometry;if(this._storeEffectOnSubMeshes)for(const s of e.subMeshes)i._releaseVertexArrayObject(s.effect),t&&s.effect&&s.effect.dispose();else i._releaseVertexArrayObject(this._drawWrapper.effect)}}serialize(){const e=xe.Serialize(this);return e.stencil=this.stencil.serialize(),e.uniqueId=this.uniqueId,e}static Parse(e,t,i){if(!e.customType)e.customType="BABYLON.StandardMaterial";else if(e.customType==="BABYLON.PBRMaterial"&&e.overloadedAlbedo&&(e.customType="BABYLON.LegacyPBRMaterial",!BABYLON.LegacyPBRMaterial))return B.Error("Your scene is trying to load a legacy version of the PBRMaterial, please, include it from the materials library."),null;const r=q.Instantiate(e.customType).Parse(e,t,i);return r._loadedUniqueId=e.uniqueId,r}}ne.TriangleFillMode=0;ne.WireFrameFillMode=1;ne.PointFillMode=2;ne.PointListDrawMode=3;ne.LineListDrawMode=4;ne.LineLoopDrawMode=5;ne.LineStripDrawMode=6;ne.TriangleStripDrawMode=7;ne.TriangleFanDrawMode=8;ne.ClockWiseSideOrientation=0;ne.CounterClockWiseSideOrientation=1;ne.TextureDirtyFlag=1;ne.LightDirtyFlag=2;ne.FresnelDirtyFlag=4;ne.AttributesDirtyFlag=8;ne.MiscDirtyFlag=16;ne.PrePassDirtyFlag=32;ne.AllDirtyFlag=63;ne.MATERIAL_OPAQUE=0;ne.MATERIAL_ALPHATEST=1;ne.MATERIAL_ALPHABLEND=2;ne.MATERIAL_ALPHATESTANDBLEND=3;ne.MATERIAL_NORMALBLENDMETHOD_WHITEOUT=0;ne.MATERIAL_NORMALBLENDMETHOD_RNM=1;ne.OnEventObservable=new X;ne._AllDirtyCallBack=a=>a.markAllAsDirty();ne._ImageProcessingDirtyCallBack=a=>a.markAsImageProcessingDirty();ne._TextureDirtyCallBack=a=>a.markAsTexturesDirty();ne._FresnelDirtyCallBack=a=>a.markAsFresnelDirty();ne._MiscDirtyCallBack=a=>a.markAsMiscDirty();ne._PrePassDirtyCallBack=a=>a.markAsPrePassDirty();ne._LightsDirtyCallBack=a=>a.markAsLightDirty();ne._AttributeDirtyCallBack=a=>a.markAsAttributesDirty();ne._FresnelAndMiscDirtyCallBack=a=>{ne._FresnelDirtyCallBack(a),ne._MiscDirtyCallBack(a)};ne._TextureAndMiscDirtyCallBack=a=>{ne._TextureDirtyCallBack(a),ne._MiscDirtyCallBack(a)};ne._DirtyCallbackArray=[];ne._RunDirtyCallBacks=a=>{for(const e of ne._DirtyCallbackArray)e(a)};T([R()],ne.prototype,"id",void 0);T([R()],ne.prototype,"uniqueId",void 0);T([R()],ne.prototype,"name",void 0);T([R()],ne.prototype,"metadata",void 0);T([R()],ne.prototype,"checkReadyOnEveryCall",void 0);T([R()],ne.prototype,"checkReadyOnlyOnce",void 0);T([R()],ne.prototype,"state",void 0);T([R("alpha")],ne.prototype,"_alpha",void 0);T([R("backFaceCulling")],ne.prototype,"_backFaceCulling",void 0);T([R("cullBackFaces")],ne.prototype,"_cullBackFaces",void 0);T([R()],ne.prototype,"sideOrientation",void 0);T([R("alphaMode")],ne.prototype,"_alphaMode",void 0);T([R()],ne.prototype,"_needDepthPrePass",void 0);T([R()],ne.prototype,"disableDepthWrite",void 0);T([R()],ne.prototype,"disableColorWrite",void 0);T([R()],ne.prototype,"forceDepthWrite",void 0);T([R()],ne.prototype,"depthFunction",void 0);T([R()],ne.prototype,"separateCullingPass",void 0);T([R("fogEnabled")],ne.prototype,"_fogEnabled",void 0);T([R()],ne.prototype,"pointSize",void 0);T([R()],ne.prototype,"zOffset",void 0);T([R()],ne.prototype,"zOffsetUnits",void 0);T([R()],ne.prototype,"pointsCloud",null);T([R()],ne.prototype,"fillMode",null);T([R()],ne.prototype,"transparencyMode",null);class Jn extends ne{constructor(e,t){super(e,t,!0),this._waitingSubMaterialsUniqueIds=[],this.getScene().multiMaterials.push(this),this.subMaterials=new Array,this._storeEffectOnSubMeshes=!0}get subMaterials(){return this._subMaterials}set subMaterials(e){this._subMaterials=e,this._hookArray(e)}getChildren(){return this.subMaterials}_hookArray(e){const t=e.push;e.push=(...s)=>{const r=t.apply(e,s);return this._markAllSubMeshesAsTexturesDirty(),r};const i=e.splice;e.splice=(s,r)=>{const n=i.apply(e,[s,r]);return this._markAllSubMeshesAsTexturesDirty(),n}}getSubMaterial(e){return e<0||e>=this.subMaterials.length?this.getScene().defaultMaterial:this.subMaterials[e]}getActiveTextures(){return super.getActiveTextures().concat(...this.subMaterials.map(e=>e?e.getActiveTextures():[]))}hasTexture(e){var t;if(super.hasTexture(e))return!0;for(let i=0;i<this.subMaterials.length;i++)if(!((t=this.subMaterials[i])===null||t===void 0)&&t.hasTexture(e))return!0;return!1}getClassName(){return"MultiMaterial"}isReadyForSubMesh(e,t,i){for(let s=0;s<this.subMaterials.length;s++){const r=this.subMaterials[s];if(r){if(r._storeEffectOnSubMeshes){if(!r.isReadyForSubMesh(e,t,i))return!1;continue}if(!r.isReady(e))return!1}}return!0}clone(e,t){const i=new Jn(e,this.getScene());for(let s=0;s<this.subMaterials.length;s++){let r=null;const n=this.subMaterials[s];t&&n?r=n.clone(e+"-"+n.name):r=this.subMaterials[s],i.subMaterials.push(r)}return i}serialize(){const e={};e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,ot&&(e.tags=ot.GetTags(this)),e.materialsUniqueIds=[],e.materials=[];for(let t=0;t<this.subMaterials.length;t++){const i=this.subMaterials[t];i?(e.materialsUniqueIds.push(i.uniqueId),e.materials.push(i.id)):(e.materialsUniqueIds.push(null),e.materials.push(null))}return e}dispose(e,t,i){const s=this.getScene();if(!s)return;if(i)for(let n=0;n<this.subMaterials.length;n++){const o=this.subMaterials[n];o&&o.dispose(e,t)}const r=s.multiMaterials.indexOf(this);r>=0&&s.multiMaterials.splice(r,1),super.dispose(e,t)}static ParseMultiMaterial(e,t){const i=new Jn(e.name,t);return i.id=e.id,i._loadedUniqueId=e.uniqueId,ot&&ot.AddTagsTo(i,e.tags),e.materialsUniqueIds?i._waitingSubMaterialsUniqueIds=e.materialsUniqueIds:e.materials.forEach(s=>i.subMaterials.push(t.getLastMaterialById(s))),i}}he("BABYLON.MultiMaterial",Jn);class e1{constructor(e,t){this.distanceOrScreenCoverage=e,this.mesh=t}}class E_{}class t1{constructor(){this.visibleInstances={},this.batchCache=new Ef,this.batchCacheReplacementModeInFrozenMode=new Ef,this.instancesBufferSize=32*16*4}}class Ef{constructor(){this.mustReturn=!1,this.visibleInstances=new Array,this.renderSelf=new Array,this.hardwareInstancedRendering=new Array}}class i1{constructor(){this.instancesCount=0,this.matrixBuffer=null,this.previousMatrixBuffer=null,this.matrixBufferSize=32*16,this.matrixData=null,this.boundingVectors=[],this.worldMatrices=null}}class s1{constructor(){this._areNormalsFrozen=!1,this._source=null,this.meshMap=null,this._preActivateId=-1,this._LODLevels=new Array,this._useLODScreenCoverage=!1,this._effectiveMaterial=null,this._forcedInstanceCount=0}}class V extends ct{constructor(e,t=null,i=null,s=null,r,n=!0){if(super(e,t),this._internalMeshDataInfo=new s1,this.delayLoadState=0,this.instances=new Array,this._creationDataStorage=null,this._geometry=null,this._instanceDataStorage=new t1,this._thinInstanceDataStorage=new i1,this._shouldGenerateFlatShading=!1,this._originalBuilderSideOrientation=V.DEFAULTSIDE,this.overrideMaterialSideOrientation=null,this.ignoreCameraMaxZ=!1,t=this.getScene(),this._onBeforeDraw=(o,l,h)=>{o&&h&&(this._uniformBuffer?this.transferToEffect(l):h.bindOnlyWorldMatrix(l))},s){if(s._geometry&&s._geometry.applyToMesh(this),ys.DeepCopy(s,this,["name","material","skeleton","instances","parent","uniqueId","source","metadata","morphTargetManager","hasInstances","worldMatrixInstancedBuffer","previousWorldMatrixInstancedBuffer","hasLODLevels","geometry","isBlocked","areNormalsFrozen","facetNb","isFacetDataEnabled","lightSources","useBones","isAnInstance","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","cloneMeshMap","hasBoundingInfo"],["_poseMatrix"]),this._internalMeshDataInfo._source=s,t.useClonedMeshMap&&(s._internalMeshDataInfo.meshMap||(s._internalMeshDataInfo.meshMap={}),s._internalMeshDataInfo.meshMap[this.uniqueId]=this),this._originalBuilderSideOrientation=s._originalBuilderSideOrientation,this._creationDataStorage=s._creationDataStorage,s._ranges){const o=s._ranges;for(const l in o)!Object.prototype.hasOwnProperty.call(o,l)||!o[l]||this.createAnimationRange(l,o[l].from,o[l].to)}if(s.metadata&&s.metadata.clone?this.metadata=s.metadata.clone():this.metadata=s.metadata,ot&&ot.HasTags(s)&&ot.AddTagsTo(this,ot.GetTags(s,!0)),this.setEnabled(s.isEnabled(!1)),this.parent=s.parent,this.setPivotMatrix(s.getPivotMatrix()),this.id=e+"."+s.id,this.material=s.material,!r){const o=s.getDescendants(!0);for(let l=0;l<o.length;l++){const h=o[l];h.clone&&h.clone(e+"."+h.name,this)}}if(s.morphTargetManager&&(this.morphTargetManager=s.morphTargetManager),t.getPhysicsEngine){const o=t.getPhysicsEngine();if(n&&o){const l=o.getImpostorForPhysicsObject(s);l&&(this.physicsImpostor=l.clone(this))}}for(let o=0;o<t.particleSystems.length;o++){const l=t.particleSystems[o];l.emitter===s&&l.clone(l.name,this)}this.skeleton=s.skeleton,this.refreshBoundingInfo(!0,!0),this.computeWorldMatrix(!0)}i!==null&&(this.parent=i),this._instanceDataStorage.hardwareInstancedRendering=this.getEngine().getCaps().instancedArrays,this._internalMeshDataInfo._onMeshReadyObserverAdded=o=>{o.unregisterOnNextCall=!0,this.isReady(!0)?this.onMeshReadyObservable.notifyObservers(this):this._internalMeshDataInfo._checkReadinessObserver||(this._internalMeshDataInfo._checkReadinessObserver=this._scene.onBeforeRenderObservable.add(()=>{this.isReady(!0)&&(this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),this._internalMeshDataInfo._checkReadinessObserver=null,this.onMeshReadyObservable.notifyObservers(this))}))},this.onMeshReadyObservable=new X(this._internalMeshDataInfo._onMeshReadyObserverAdded),s&&s.onClonedObservable.notifyObservers(this)}static _GetDefaultSideOrientation(e){return e||V.FRONTSIDE}get useLODScreenCoverage(){return this._internalMeshDataInfo._useLODScreenCoverage}set useLODScreenCoverage(e){this._internalMeshDataInfo._useLODScreenCoverage=e}get computeBonesUsingShaders(){return this._internalAbstractMeshDataInfo._computeBonesUsingShaders}set computeBonesUsingShaders(e){this._internalAbstractMeshDataInfo._computeBonesUsingShaders!==e&&(e&&this._internalMeshDataInfo._sourcePositions&&(this.setVerticesData(y.PositionKind,this._internalMeshDataInfo._sourcePositions,!0),this._internalMeshDataInfo._sourceNormals&&this.setVerticesData(y.NormalKind,this._internalMeshDataInfo._sourceNormals,!0),this._internalMeshDataInfo._sourcePositions=null,this._internalMeshDataInfo._sourceNormals=null),this._internalAbstractMeshDataInfo._computeBonesUsingShaders=e,this._markSubMeshesAsAttributesDirty())}get onBeforeRenderObservable(){return this._internalMeshDataInfo._onBeforeRenderObservable||(this._internalMeshDataInfo._onBeforeRenderObservable=new X),this._internalMeshDataInfo._onBeforeRenderObservable}get onBeforeBindObservable(){return this._internalMeshDataInfo._onBeforeBindObservable||(this._internalMeshDataInfo._onBeforeBindObservable=new X),this._internalMeshDataInfo._onBeforeBindObservable}get onAfterRenderObservable(){return this._internalMeshDataInfo._onAfterRenderObservable||(this._internalMeshDataInfo._onAfterRenderObservable=new X),this._internalMeshDataInfo._onAfterRenderObservable}get onBetweenPassObservable(){return this._internalMeshDataInfo._onBetweenPassObservable||(this._internalMeshDataInfo._onBetweenPassObservable=new X),this._internalMeshDataInfo._onBetweenPassObservable}get onBeforeDrawObservable(){return this._internalMeshDataInfo._onBeforeDrawObservable||(this._internalMeshDataInfo._onBeforeDrawObservable=new X),this._internalMeshDataInfo._onBeforeDrawObservable}set onBeforeDraw(e){this._onBeforeDrawObserver&&this.onBeforeDrawObservable.remove(this._onBeforeDrawObserver),this._onBeforeDrawObserver=this.onBeforeDrawObservable.add(e)}get hasInstances(){return this.instances.length>0}get hasThinInstances(){var e;return((e=this._thinInstanceDataStorage.instancesCount)!==null&&e!==void 0?e:0)>0}get forcedInstanceCount(){return this._internalMeshDataInfo._forcedInstanceCount}set forcedInstanceCount(e){this._internalMeshDataInfo._forcedInstanceCount=e}get source(){return this._internalMeshDataInfo._source}get cloneMeshMap(){return this._internalMeshDataInfo.meshMap}get isUnIndexed(){return this._unIndexed}set isUnIndexed(e){this._unIndexed!==e&&(this._unIndexed=e,this._markSubMeshesAsAttributesDirty())}get worldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesData}get previousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.instancesPreviousData}get manualUpdateOfWorldMatrixInstancedBuffer(){return this._instanceDataStorage.manualUpdate}set manualUpdateOfWorldMatrixInstancedBuffer(e){this._instanceDataStorage.manualUpdate=e}get manualUpdateOfPreviousWorldMatrixInstancedBuffer(){return this._instanceDataStorage.previousManualUpdate}set manualUpdateOfPreviousWorldMatrixInstancedBuffer(e){this._instanceDataStorage.previousManualUpdate=e}instantiateHierarchy(e=null,t,i){const s=this.getTotalVertices()===0||t&&t.doNotInstantiate&&(t.doNotInstantiate===!0||t.doNotInstantiate(this))?this.clone("Clone of "+(this.name||this.id),e||this.parent,!0):this.createInstance("instance of "+(this.name||this.id));s.parent=e||this.parent,s.position=this.position.clone(),s.scaling=this.scaling.clone(),this.rotationQuaternion?s.rotationQuaternion=this.rotationQuaternion.clone():s.rotation=this.rotation.clone(),i&&i(this,s);for(const r of this.getChildTransformNodes(!0))r.getClassName()==="InstancedMesh"&&s.getClassName()==="Mesh"?r.instantiateHierarchy(s,{doNotInstantiate:t&&t.doNotInstantiate||!1,newSourcedMesh:s},i):r.instantiateHierarchy(s,t,i);return s}getClassName(){return"Mesh"}get _isMesh(){return!0}toString(e){let t=super.toString(e);if(t+=", n vertices: "+this.getTotalVertices(),t+=", parent: "+(this._waitingParentId?this._waitingParentId:this.parent?this.parent.name:"NONE"),this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);if(e)if(this._geometry){const i=this.getIndices(),s=this.getVerticesData(y.PositionKind);s&&i&&(t+=", flat shading: "+(s.length/3===i.length?"YES":"NO"))}else t+=", flat shading: UNKNOWN";return t}_unBindEffect(){super._unBindEffect();for(const e of this.instances)e._unBindEffect()}get hasLODLevels(){return this._internalMeshDataInfo._LODLevels.length>0}getLODLevels(){return this._internalMeshDataInfo._LODLevels}_sortLODLevels(){const e=this._internalMeshDataInfo._useLODScreenCoverage?-1:1;this._internalMeshDataInfo._LODLevels.sort((t,i)=>t.distanceOrScreenCoverage<i.distanceOrScreenCoverage?e:t.distanceOrScreenCoverage>i.distanceOrScreenCoverage?-e:0)}addLODLevel(e,t){if(t&&t._masterMesh)return B.Warn("You cannot use a mesh as LOD level twice"),this;const i=new e1(e,t);return this._internalMeshDataInfo._LODLevels.push(i),t&&(t._masterMesh=this),this._sortLODLevels(),this}getLODLevelAtDistance(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++){const s=t._LODLevels[i];if(s.distanceOrScreenCoverage===e)return s.mesh}return null}removeLODLevel(e){const t=this._internalMeshDataInfo;for(let i=0;i<t._LODLevels.length;i++)t._LODLevels[i].mesh===e&&(t._LODLevels.splice(i,1),e&&(e._masterMesh=null));return this._sortLODLevels(),this}getLOD(e,t){const i=this._internalMeshDataInfo;if(!i._LODLevels||i._LODLevels.length===0)return this;let s;t?s=t:s=this.getBoundingInfo().boundingSphere;const r=s.centerWorld.subtract(e.globalPosition).length(),n=i._useLODScreenCoverage;let o=r,l=1;if(n){const h=e.screenArea;let c=s.radiusWorld*e.minZ/r;c=c*c*Math.PI,o=c/h,l=-1}if(l*i._LODLevels[i._LODLevels.length-1].distanceOrScreenCoverage>l*o)return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this;for(let h=0;h<i._LODLevels.length;h++){const c=i._LODLevels[h];if(l*c.distanceOrScreenCoverage<l*o){if(c.mesh){if(c.mesh.delayLoadState===4)return c.mesh._checkDelayState(),this;if(c.mesh.delayLoadState===2)return this;c.mesh._preActivate(),c.mesh._updateSubMeshesBoundingInfo(this.worldMatrixFromCache)}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,c.mesh),c.mesh}}return this.onLODLevelSelection&&this.onLODLevelSelection(o,this,this),this}get geometry(){return this._geometry}getTotalVertices(){return this._geometry===null||this._geometry===void 0?0:this._geometry.getTotalVertices()}getVerticesData(e,t,i){var s,r;if(!this._geometry)return null;let n=(r=(s=this._userInstancedBuffersStorage)===null||s===void 0?void 0:s.vertexBuffers[e])===null||r===void 0?void 0:r.getFloatData(this._geometry.getTotalVertices(),i||t&&this._geometry.meshes.length!==1);return n||(n=this._geometry.getVerticesData(e,t,i)),n}getVertexBuffer(e){var t,i;return this._geometry?(i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[e])!==null&&i!==void 0?i:this._geometry.getVertexBuffer(e):null}isVerticesDataPresent(e){var t;return this._geometry?((t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[e])!==void 0||this._geometry.isVerticesDataPresent(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}isVertexBufferUpdatable(e){var t,i;return this._geometry?((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[e])===null||i===void 0?void 0:i.isUpdatable())||this._geometry.isVertexBufferUpdatable(e):this._delayInfo?this._delayInfo.indexOf(e)!==-1:!1}getVerticesDataKinds(){if(!this._geometry){const t=new Array;return this._delayInfo&&this._delayInfo.forEach(function(i){t.push(i)}),t}const e=this._geometry.getVerticesDataKinds();if(this._userInstancedBuffersStorage)for(const t in this._userInstancedBuffersStorage.vertexBuffers)e.push(t);return e}getTotalIndices(){return this._geometry?this._geometry.getTotalIndices():0}getIndices(e,t){return this._geometry?this._geometry.getIndices(e,t):[]}get isBlocked(){return this._masterMesh!==null&&this._masterMesh!==void 0}isReady(e=!1,t=!1){var i,s,r,n,o,l;if(this.delayLoadState===2||!super.isReady(e))return!1;if(!this.subMeshes||this.subMeshes.length===0||!e)return!0;const h=this.getEngine(),c=this.getScene(),u=t||h.getCaps().instancedArrays&&(this.instances.length>0||this.hasThinInstances);this.computeWorldMatrix();const d=this.material||c.defaultMaterial;if(d){if(d._storeEffectOnSubMeshes)for(const p of this.subMeshes){const _=p.getMaterial();if(_){if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,p,u))return!1}else if(!_.isReady(this,u))return!1}}else if(!d.isReady(this,u))return!1}const f=h.currentRenderPassId;for(const p of this.lightSources){const _=p.getShadowGenerator();if(_&&(!(!((i=_.getShadowMap())===null||i===void 0)&&i.renderList)||((s=_.getShadowMap())===null||s===void 0?void 0:s.renderList)&&((n=(r=_.getShadowMap())===null||r===void 0?void 0:r.renderList)===null||n===void 0?void 0:n.indexOf(this))!==-1)){_.getShadowMap()&&(h.currentRenderPassId=_.getShadowMap().renderPassId);for(const m of this.subMeshes)if(!_.isReady(m,u,(l=(o=m.getMaterial())===null||o===void 0?void 0:o.needAlphaBlendingForMesh(this))!==null&&l!==void 0?l:!1))return h.currentRenderPassId=f,!1;h.currentRenderPassId=f}}for(const p of this._internalMeshDataInfo._LODLevels)if(p.mesh&&!p.mesh.isReady(u))return!1;return!0}get areNormalsFrozen(){return this._internalMeshDataInfo._areNormalsFrozen}freezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!0,this}unfreezeNormals(){return this._internalMeshDataInfo._areNormalsFrozen=!1,this}set overridenInstanceCount(e){this._instanceDataStorage.overridenInstanceCount=e}_preActivate(){const e=this._internalMeshDataInfo,t=this.getScene().getRenderId();return e._preActivateId===t?this:(e._preActivateId=t,this._instanceDataStorage.visibleInstances=null,this)}_preActivateForIntermediateRendering(e){return this._instanceDataStorage.visibleInstances&&(this._instanceDataStorage.visibleInstances.intermediateDefaultRenderId=e),this}_registerInstanceForRenderId(e,t){return this._instanceDataStorage.visibleInstances||(this._instanceDataStorage.visibleInstances={defaultRenderId:t,selfDefaultRenderId:this._renderId}),this._instanceDataStorage.visibleInstances[t]||(this._instanceDataStorage.previousRenderId!==void 0&&this._instanceDataStorage.isFrozen&&(this._instanceDataStorage.visibleInstances[this._instanceDataStorage.previousRenderId]=null),this._instanceDataStorage.previousRenderId=t,this._instanceDataStorage.visibleInstances[t]=new Array),this._instanceDataStorage.visibleInstances[t].push(e),this}_afterComputeWorldMatrix(){super._afterComputeWorldMatrix(),this.hasThinInstances&&(this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1))}_postActivate(){this.edgesShareWithInstances&&this.edgesRenderer&&this.edgesRenderer.isEnabled&&this._renderingGroup&&(this._renderingGroup._edgesRenderers.pushNoDuplicate(this.edgesRenderer),this.edgesRenderer.customInstances.push(this.getWorldMatrix()))}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this.geometry?this.geometry.boundingBias:null;return this._refreshBoundingInfo(this._getPositionData(e,t),i),this}_createGlobalSubMesh(e){const t=this.getTotalVertices();if(!t||!this.getIndices())return null;if(this.subMeshes&&this.subMeshes.length>0){const i=this.getIndices();if(!i)return null;const s=i.length;let r=!1;if(e)r=!0;else for(const n of this.subMeshes){if(n.indexStart+n.indexCount>s){r=!0;break}if(n.verticesStart+n.verticesCount>t){r=!0;break}}if(!r)return this.subMeshes[0]}return this.releaseSubMeshes(),new fs(0,0,t,0,this.getTotalIndices(),this)}subdivide(e){if(e<1)return;const t=this.getTotalIndices();let i=t/e|0,s=0;for(;i%3!==0;)i++;this.releaseSubMeshes();for(let r=0;r<e&&!(s>=t);r++)fs.CreateFromIndices(0,s,r===e-1?t-s:i,this),s+=i;this.synchronizeInstances()}setVerticesData(e,t,i=!1,s){if(this._geometry)this._geometry.setVerticesData(e,t,i,s);else{const r=new de;r.set(t,e);const n=this.getScene();new os(os.RandomId(),n,r,i,this)}return this}removeVerticesData(e){!this._geometry||this._geometry.removeVerticesData(e)}markVerticesDataAsUpdatable(e,t=!0){const i=this.getVertexBuffer(e);!i||i.isUpdatable()===t||this.setVerticesData(e,this.getVerticesData(e),t)}setVerticesBuffer(e,t=!0){return this._geometry||(this._geometry=os.CreateGeometryForMesh(this)),this._geometry.setVerticesBuffer(e,null,t),this}updateVerticesData(e,t,i,s){return this._geometry?(s?(this.makeGeometryUnique(),this.updateVerticesData(e,t,i,!1)):this._geometry.updateVerticesData(e,t,i),this):this}updateMeshPositions(e,t=!0){const i=this.getVerticesData(y.PositionKind);if(!i)return this;if(e(i),this.updateVerticesData(y.PositionKind,i,!1,!1),t){const s=this.getIndices(),r=this.getVerticesData(y.NormalKind);if(!r)return this;de.ComputeNormals(i,s,r),this.updateVerticesData(y.NormalKind,r,!1,!1)}return this}makeGeometryUnique(){if(!this._geometry)return this;if(this._geometry.meshes.length===1)return this;const e=this._geometry,t=this._geometry.copy(os.RandomId());return e.releaseForMesh(this,!0),t.applyToMesh(this),this}setIndices(e,t=null,i=!1){if(this._geometry)this._geometry.setIndices(e,t,i);else{const s=new de;s.indices=e;const r=this.getScene();new os(os.RandomId(),r,s,i,this)}return this}updateIndices(e,t,i=!1){return this._geometry?(this._geometry.updateIndices(e,t,i),this):this}toLeftHanded(){return this._geometry?(this._geometry.toLeftHanded(),this):this}_bind(e,t,i){if(!this._geometry)return this;const s=this.getScene().getEngine();this.morphTargetManager&&this.morphTargetManager.isUsingTextureForTargets&&this.morphTargetManager._bind(t);let r;if(this._unIndexed)r=null;else switch(i){case ne.PointFillMode:r=null;break;case ne.WireFrameFillMode:r=e._getLinesIndexBuffer(this.getIndices(),s);break;default:case ne.TriangleFillMode:r=this._geometry.getIndexBuffer();break}return!this._userInstancedBuffersStorage||this.hasThinInstances?this._geometry._bind(t,r):this._geometry._bind(t,r,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects),this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;this._internalMeshDataInfo._onBeforeDrawObservable&&this._internalMeshDataInfo._onBeforeDrawObservable.notifyObservers(this);const r=this.getScene().getEngine();return this._unIndexed||t==ne.PointFillMode?r.drawArraysType(t,e.verticesStart,e.verticesCount,this.forcedInstanceCount||i):t==ne.WireFrameFillMode?r.drawElementsType(t,0,e._linesIndexCount,this.forcedInstanceCount||i):r.drawElementsType(t,e.indexStart,e.indexCount,this.forcedInstanceCount||i),this}registerBeforeRender(e){return this.onBeforeRenderObservable.add(e),this}unregisterBeforeRender(e){return this.onBeforeRenderObservable.removeCallback(e),this}registerAfterRender(e){return this.onAfterRenderObservable.add(e),this}unregisterAfterRender(e){return this.onAfterRenderObservable.removeCallback(e),this}_getInstancesRenderList(e,t=!1){if(this._instanceDataStorage.isFrozen){if(t)return this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.hardwareInstancedRendering[e]=!1,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode.renderSelf[e]=!0,this._instanceDataStorage.batchCacheReplacementModeInFrozenMode;if(this._instanceDataStorage.previousBatch)return this._instanceDataStorage.previousBatch}const i=this.getScene(),s=i._isInIntermediateRendering(),r=s?this._internalAbstractMeshDataInfo._onlyForInstancesIntermediate:this._internalAbstractMeshDataInfo._onlyForInstances,n=this._instanceDataStorage.batchCache;if(n.mustReturn=!1,n.renderSelf[e]=t||!r&&this.isEnabled()&&this.isVisible,n.visibleInstances[e]=null,this._instanceDataStorage.visibleInstances&&!t){const o=this._instanceDataStorage.visibleInstances,l=i.getRenderId(),h=s?o.intermediateDefaultRenderId:o.defaultRenderId;n.visibleInstances[e]=o[l],!n.visibleInstances[e]&&h&&(n.visibleInstances[e]=o[h])}return n.hardwareInstancedRendering[e]=!t&&this._instanceDataStorage.hardwareInstancedRendering&&n.visibleInstances[e]!==null&&n.visibleInstances[e]!==void 0,this._instanceDataStorage.previousBatch=n,n}_renderWithInstances(e,t,i,s,r){var n;const o=i.visibleInstances[e._id],l=o?o.length:0,h=this._instanceDataStorage,c=h.instancesBufferSize;let u=h.instancesBuffer,d=h.instancesPreviousBuffer;const p=(l+1)*16*4;for(;h.instancesBufferSize<p;)h.instancesBufferSize*=2;(!h.instancesData||c!=h.instancesBufferSize)&&(h.instancesData=new Float32Array(h.instancesBufferSize/4)),(this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousData||c!=h.instancesBufferSize)&&(h.instancesPreviousData=new Float32Array(h.instancesBufferSize/4));let _=0,m=0;const v=i.renderSelf[e._id],x=!u||c!==h.instancesBufferSize||this._scene.needsPreviousWorldMatrices&&!h.instancesPreviousBuffer;if(!this._instanceDataStorage.manualUpdate&&(!h.isFrozen||x)){const b=this.getWorldMatrix();if(v&&(this._scene.needsPreviousWorldMatrices&&(h.masterMeshPreviousWorldMatrix?(h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,_),h.masterMeshPreviousWorldMatrix.copyFrom(b)):(h.masterMeshPreviousWorldMatrix=b.clone(),h.masterMeshPreviousWorldMatrix.copyToArray(h.instancesPreviousData,_))),b.copyToArray(h.instancesData,_),_+=16,m++),o){if(V.INSTANCEDMESH_SORT_TRANSPARENT&&this._scene.activeCamera&&((n=e.getMaterial())===null||n===void 0?void 0:n.needAlphaBlendingForMesh(e.getRenderingMesh()))){const S=this._scene.activeCamera.globalPosition;for(let C=0;C<o.length;C++){const E=o[C];E._distanceToCamera=g.Distance(E.getBoundingInfo().boundingSphere.centerWorld,S)}o.sort((C,E)=>C._distanceToCamera>E._distanceToCamera?-1:C._distanceToCamera<E._distanceToCamera?1:0)}for(let S=0;S<o.length;S++){const C=o[S],E=C.getWorldMatrix();E.copyToArray(h.instancesData,_),this._scene.needsPreviousWorldMatrices&&(C._previousWorldMatrix?(C._previousWorldMatrix.copyToArray(h.instancesPreviousData,_),C._previousWorldMatrix.copyFrom(E)):(C._previousWorldMatrix=E.clone(),C._previousWorldMatrix.copyToArray(h.instancesPreviousData,_))),_+=16,m++}}}else m=(v?1:0)+l;return x?(u&&u.dispose(),d&&d.dispose(),u=new Hr(r,h.instancesData,!0,16,!1,!0),h.instancesBuffer=u,this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0}),this._userInstancedBuffersStorage.vertexBuffers.world0=u.createVertexBuffer("world0",0,4),this._userInstancedBuffersStorage.vertexBuffers.world1=u.createVertexBuffer("world1",4,4),this._userInstancedBuffersStorage.vertexBuffers.world2=u.createVertexBuffer("world2",8,4),this._userInstancedBuffersStorage.vertexBuffers.world3=u.createVertexBuffer("world3",12,4),this._scene.needsPreviousWorldMatrices&&(d=new Hr(r,h.instancesPreviousData,!0,16,!1,!0),h.instancesPreviousBuffer=d,this._userInstancedBuffersStorage.vertexBuffers.previousWorld0=d.createVertexBuffer("previousWorld0",0,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld1=d.createVertexBuffer("previousWorld1",4,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld2=d.createVertexBuffer("previousWorld2",8,4),this._userInstancedBuffersStorage.vertexBuffers.previousWorld3=d.createVertexBuffer("previousWorld3",12,4)),this._invalidateInstanceVertexArrayObject()):this._instanceDataStorage.isFrozen||(u.updateDirectly(h.instancesData,0,m),this._scene.needsPreviousWorldMatrices&&(!this._instanceDataStorage.manualUpdate||this._instanceDataStorage.previousManualUpdate)&&d.updateDirectly(h.instancesPreviousData,0,m)),this._processInstancedBuffers(o,v),this.getScene()._activeIndices.addCount(e.indexCount*m,!1),r._currentDrawContext&&(r._currentDrawContext.useInstancing=!0),this._bind(e,s,t),this._draw(e,t,m),this._scene.needsPreviousWorldMatrices&&!x&&this._instanceDataStorage.manualUpdate&&!this._instanceDataStorage.isFrozen&&!this._instanceDataStorage.previousManualUpdate&&d.updateDirectly(h.instancesData,0,m),r.unbindInstanceAttributes(),this}_renderWithThinInstances(e,t,i,s){var r,n;const o=(n=(r=this._thinInstanceDataStorage)===null||r===void 0?void 0:r.instancesCount)!==null&&n!==void 0?n:0;this.getScene()._activeIndices.addCount(e.indexCount*o,!1),s._currentDrawContext&&(s._currentDrawContext.useInstancing=!0),this._bind(e,i,t),this._draw(e,t,o),this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&this._thinInstanceDataStorage.matrixData&&(this._thinInstanceDataStorage.previousMatrixBuffer?this._thinInstanceDataStorage.previousMatrixBuffer.updateDirectly(this._thinInstanceDataStorage.matrixData,0,o):this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",this._thinInstanceDataStorage.matrixData,!1)),s.unbindInstanceAttributes()}_processInstancedBuffers(e,t){}_processRendering(e,t,i,s,r,n,o,l){const h=this.getScene(),c=h.getEngine();if(n&&t.getRenderingMesh().hasThinInstances)return this._renderWithThinInstances(t,s,i,c),this;if(n)this._renderWithInstances(t,s,r,i,c);else{c._currentDrawContext&&(c._currentDrawContext.useInstancing=!1);let u=0;r.renderSelf[t._id]&&(o&&o(!1,e.getWorldMatrix(),l),u++,this._draw(t,s,this._instanceDataStorage.overridenInstanceCount));const d=r.visibleInstances[t._id];if(d){const f=d.length;u+=f;for(let p=0;p<f;p++){const m=d[p].getWorldMatrix();o&&o(!0,m,l),this._draw(t,s)}}h._activeIndices.addCount(t.indexCount*u,!1)}return this}_rebuild(e=!1){if(this._instanceDataStorage.instancesBuffer&&(e&&this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null),this._userInstancedBuffersStorage){for(const t in this._userInstancedBuffersStorage.vertexBuffers){const i=this._userInstancedBuffersStorage.vertexBuffers[t];i&&(e&&i.dispose(),this._userInstancedBuffersStorage.vertexBuffers[t]=null)}this._userInstancedBuffersStorage.vertexArrayObjects&&(this._userInstancedBuffersStorage.vertexArrayObjects={})}this._internalMeshDataInfo._effectiveMaterial=null,super._rebuild(e)}_freeze(){if(!!this.subMeshes){for(let e=0;e<this.subMeshes.length;e++)this._getInstancesRenderList(e);this._internalMeshDataInfo._effectiveMaterial=null,this._instanceDataStorage.isFrozen=!0}}_unFreeze(){this._instanceDataStorage.isFrozen=!1,this._instanceDataStorage.previousBatch=null}render(e,t,i){var s,r,n;const o=this.getScene();if(this._internalAbstractMeshDataInfo._isActiveIntermediate?this._internalAbstractMeshDataInfo._isActiveIntermediate=!1:this._internalAbstractMeshDataInfo._isActive=!1,this._checkOcclusionQuery()&&!this._occlusionDataStorage.forceRenderingWhenOccluded)return this;const l=this._getInstancesRenderList(e._id,!!i);if(l.mustReturn)return this;if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const h=o.getEngine();let c=0,u=null;this.ignoreCameraMaxZ&&o.activeCamera&&!o._isInIntermediateRendering()&&(c=o.activeCamera.maxZ,u=o.activeCamera,o.activeCamera.maxZ=0,o.updateTransformMatrix(!0)),this._internalMeshDataInfo._onBeforeRenderObservable&&this._internalMeshDataInfo._onBeforeRenderObservable.notifyObservers(this);const d=e.getRenderingMesh(),f=l.hardwareInstancedRendering[e._id]||d.hasThinInstances||!!this._userInstancedBuffersStorage&&!e.getMesh()._internalAbstractMeshDataInfo._actAsRegularMesh,p=this._instanceDataStorage,_=e.getMaterial();if(!_)return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;if(!p.isFrozen||!this._internalMeshDataInfo._effectiveMaterial||this._internalMeshDataInfo._effectiveMaterial!==_){if(_._storeEffectOnSubMeshes){if(!_.isReadyForSubMesh(this,e,f))return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this}else if(!_.isReady(this,f))return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;this._internalMeshDataInfo._effectiveMaterial=_}else if(_._storeEffectOnSubMeshes&&!(!((s=e.effect)===null||s===void 0)&&s._wasPreviouslyReady)||!_._storeEffectOnSubMeshes&&!(!((r=_.getEffect())===null||r===void 0)&&r._wasPreviouslyReady))return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;t&&h.setAlphaMode(this._internalMeshDataInfo._effectiveMaterial.alphaMode);let m;this._internalMeshDataInfo._effectiveMaterial._storeEffectOnSubMeshes?m=e._drawWrapper:m=this._internalMeshDataInfo._effectiveMaterial._getDrawWrapper();const v=(n=m==null?void 0:m.effect)!==null&&n!==void 0?n:null;for(const M of o._beforeRenderingMeshStage)M.action(this,e,l,v);if(!m||!v)return u&&(u.maxZ=c,o.updateTransformMatrix(!0)),this;const x=i||this;let b;if(!p.isFrozen&&(this._internalMeshDataInfo._effectiveMaterial.backFaceCulling||this.overrideMaterialSideOrientation!==null)){const M=x._getWorldMatrixDeterminant();b=this.overrideMaterialSideOrientation,b==null&&(b=this._internalMeshDataInfo._effectiveMaterial.sideOrientation),M<0&&(b=b===ne.ClockWiseSideOrientation?ne.CounterClockWiseSideOrientation:ne.ClockWiseSideOrientation),p.sideOrientation=b}else b=p.sideOrientation;const S=this._internalMeshDataInfo._effectiveMaterial._preBind(m,b);this._internalMeshDataInfo._effectiveMaterial.forceDepthWrite&&h.setDepthWrite(!0);const C=o.forcePointsCloud?ne.PointFillMode:o.forceWireframe?ne.WireFrameFillMode:this._internalMeshDataInfo._effectiveMaterial.fillMode;this._internalMeshDataInfo._onBeforeBindObservable&&this._internalMeshDataInfo._onBeforeBindObservable.notifyObservers(this),f||this._bind(e,v,C);const E=this._internalMeshDataInfo._effectiveMaterial,A=x.getWorldMatrix();E._storeEffectOnSubMeshes?E.bindForSubMesh(A,this,e):E.bind(A,this),!E.backFaceCulling&&E.separateCullingPass&&(h.setState(!0,E.zOffset,!1,!S,E.cullBackFaces,E.stencil,E.zOffsetUnits),this._processRendering(this,e,v,C,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),h.setState(!0,E.zOffset,!1,S,E.cullBackFaces,E.stencil,E.zOffsetUnits),this._internalMeshDataInfo._onBetweenPassObservable&&this._internalMeshDataInfo._onBetweenPassObservable.notifyObservers(e)),this._processRendering(this,e,v,C,l,f,this._onBeforeDraw,this._internalMeshDataInfo._effectiveMaterial),this._internalMeshDataInfo._effectiveMaterial.unbind();for(const M of o._afterRenderingMeshStage)M.action(this,e,l,v);return this._internalMeshDataInfo._onAfterRenderObservable&&this._internalMeshDataInfo._onAfterRenderObservable.notifyObservers(this),u&&(u.maxZ=c,o.updateTransformMatrix(!0)),o.performancePriority===Qs.Aggressive&&!p.isFrozen&&this._freeze(),this}cleanMatrixWeights(){this.isVerticesDataPresent(y.MatricesWeightsKind)&&(this.isVerticesDataPresent(y.MatricesWeightsExtraKind)?this._normalizeSkinWeightsAndExtra():this._normalizeSkinFourWeights())}_normalizeSkinFourWeights(){const e=this.getVerticesData(y.MatricesWeightsKind),t=e.length;for(let i=0;i<t;i+=4){const s=e[i]+e[i+1]+e[i+2]+e[i+3];if(s===0)e[i]=1;else{const r=1/s;e[i]*=r,e[i+1]*=r,e[i+2]*=r,e[i+3]*=r}}this.setVerticesData(y.MatricesWeightsKind,e)}_normalizeSkinWeightsAndExtra(){const e=this.getVerticesData(y.MatricesWeightsExtraKind),t=this.getVerticesData(y.MatricesWeightsKind),i=t.length;for(let s=0;s<i;s+=4){let r=t[s]+t[s+1]+t[s+2]+t[s+3];if(r+=e[s]+e[s+1]+e[s+2]+e[s+3],r===0)t[s]=1;else{const n=1/r;t[s]*=n,t[s+1]*=n,t[s+2]*=n,t[s+3]*=n,e[s]*=n,e[s+1]*=n,e[s+2]*=n,e[s+3]*=n}}this.setVerticesData(y.MatricesWeightsKind,t),this.setVerticesData(y.MatricesWeightsKind,e)}validateSkinning(){const e=this.getVerticesData(y.MatricesWeightsExtraKind),t=this.getVerticesData(y.MatricesWeightsKind);if(t===null||this.skeleton==null)return{skinned:!1,valid:!0,report:"not skinned"};const i=t.length;let s=0,r=0,n=0,o=0;const l=e===null?4:8,h=new Array;for(let m=0;m<=l;m++)h[m]=0;const c=.001;for(let m=0;m<i;m+=4){let v=t[m],x=v,b=x===0?0:1;for(let S=1;S<l;S++){const C=S<4?t[m+S]:e[m+S-4];C>v&&s++,C!==0&&b++,x+=C,v=C}if(h[b]++,b>n&&(n=b),x===0)r++;else{const S=1/x;let C=0;for(let E=0;E<l;E++)E<4?C+=Math.abs(t[m+E]-t[m+E]*S):C+=Math.abs(e[m+E-4]-e[m+E-4]*S);C>c&&o++}}const u=this.skeleton.bones.length,d=this.getVerticesData(y.MatricesIndicesKind),f=this.getVerticesData(y.MatricesIndicesExtraKind);let p=0;for(let m=0;m<i;m+=4)for(let v=0;v<l;v++){const x=v<4?d[m+v]:f[m+v-4];(x>=u||x<0)&&p++}const _="Number of Weights = "+i/4+`
Maximum influences = `+n+`
Missing Weights = `+r+`
Not Sorted = `+s+`
Not Normalized = `+o+`
WeightCounts = [`+h+`]
Number of bones = `+u+`
Bad Bone Indices = `+p;return{skinned:!0,valid:r===0&&o===0&&p===0,report:_}}_checkDelayState(){const e=this.getScene();return this._geometry?this._geometry.load(e):this.delayLoadState===4&&(this.delayLoadState=2,this._queueLoad(e)),this}_queueLoad(e){e.addPendingData(this);const t=this.delayLoadingFile.indexOf(".babylonbinarymeshdata")!==-1;return q.LoadFile(this.delayLoadingFile,i=>{i instanceof ArrayBuffer?this._delayLoadingFunction(i,this):this._delayLoadingFunction(JSON.parse(i),this),this.instances.forEach(s=>{s.refreshBoundingInfo(),s._syncSubMeshes()}),this.delayLoadState=1,e.removePendingData(this)},()=>{},e.offlineProvider,t),this}isInFrustum(e){return this.delayLoadState===2||!super.isInFrustum(e)?!1:(this._checkDelayState(),!0)}setMaterialById(e){const t=this.getScene().materials;let i;for(i=t.length-1;i>-1;i--)if(t[i].id===e)return this.material=t[i],this;const s=this.getScene().multiMaterials;for(i=s.length-1;i>-1;i--)if(s[i].id===e)return this.material=s[i],this;return this}getAnimatables(){const e=new Array;return this.material&&e.push(this.material),this.skeleton&&e.push(this.skeleton),e}bakeTransformIntoVertices(e){if(!this.isVerticesDataPresent(y.PositionKind))return this;const t=this.subMeshes.splice(0);this._resetPointsArrayCache();let i=this.getVerticesData(y.PositionKind),s=new Array,r;for(r=0;r<i.length;r+=3)g.TransformCoordinates(g.FromArray(i,r),e).toArray(s,r);if(this.setVerticesData(y.PositionKind,s,this.getVertexBuffer(y.PositionKind).isUpdatable()),this.isVerticesDataPresent(y.NormalKind)){for(i=this.getVerticesData(y.NormalKind),s=[],r=0;r<i.length;r+=3)g.TransformNormal(g.FromArray(i,r),e).normalize().toArray(s,r);this.setVerticesData(y.NormalKind,s,this.getVertexBuffer(y.NormalKind).isUpdatable())}return e.determinant()<0&&this.flipFaces(),this.releaseSubMeshes(),this.subMeshes=t,this}bakeCurrentTransformIntoVertices(e=!0){return this.bakeTransformIntoVertices(this.computeWorldMatrix(!0)),this.resetLocalMatrix(e),this}get _positions(){return this._internalAbstractMeshDataInfo._positions?this._internalAbstractMeshDataInfo._positions:this._geometry?this._geometry._positions:null}_resetPointsArrayCache(){return this._geometry&&this._geometry._resetPointsArrayCache(),this}_generatePointsArray(){return this._geometry?this._geometry._generatePointsArray():!1}clone(e="",t=null,i,s=!0){return new V(e,this.getScene(),t,this,i,s)}dispose(e,t=!1){this.morphTargetManager=null,this._geometry&&this._geometry.releaseForMesh(this,!0);const i=this._internalMeshDataInfo;if(i._onBeforeDrawObservable&&i._onBeforeDrawObservable.clear(),i._onBeforeBindObservable&&i._onBeforeBindObservable.clear(),i._onBeforeRenderObservable&&i._onBeforeRenderObservable.clear(),i._onAfterRenderObservable&&i._onAfterRenderObservable.clear(),i._onBetweenPassObservable&&i._onBetweenPassObservable.clear(),this._scene.useClonedMeshMap){if(i.meshMap)for(const s in i.meshMap){const r=i.meshMap[s];r&&(r._internalMeshDataInfo._source=null,i.meshMap[s]=void 0)}i._source&&i._source._internalMeshDataInfo.meshMap&&(i._source._internalMeshDataInfo.meshMap[this.uniqueId]=void 0)}else{const s=this.getScene().meshes;for(const r of s){const n=r;n._internalMeshDataInfo&&n._internalMeshDataInfo._source&&n._internalMeshDataInfo._source===this&&(n._internalMeshDataInfo._source=null)}}i._source=null,this._disposeInstanceSpecificData(),this._disposeThinInstanceSpecificData(),this._internalMeshDataInfo._checkReadinessObserver&&this._scene.onBeforeRenderObservable.remove(this._internalMeshDataInfo._checkReadinessObserver),super.dispose(e,t)}_disposeInstanceSpecificData(){}_disposeThinInstanceSpecificData(){}_invalidateInstanceVertexArrayObject(){}applyDisplacementMap(e,t,i,s,r,n,o=!1){const l=this.getScene(),h=c=>{const u=c.width,d=c.height,p=this.getEngine().createCanvas(u,d).getContext("2d");p.drawImage(c,0,0);const _=p.getImageData(0,0,u,d).data;this.applyDisplacementMapFromBuffer(_,u,d,t,i,r,n,o),s&&s(this)};return q.LoadImage(e,h,()=>{},l.offlineProvider),this}applyDisplacementMapFromBuffer(e,t,i,s,r,n,o,l=!1){if(!this.isVerticesDataPresent(y.PositionKind)||!this.isVerticesDataPresent(y.NormalKind)||!this.isVerticesDataPresent(y.UVKind))return B.Warn("Cannot call applyDisplacementMap: Given mesh is not complete. Position, Normal or UV are missing"),this;const h=this.getVerticesData(y.PositionKind,!0,!0),c=this.getVerticesData(y.NormalKind),u=this.getVerticesData(y.UVKind);let d=g.Zero();const f=g.Zero(),p=le.Zero();n=n||le.Zero(),o=o||new le(1,1);for(let _=0;_<h.length;_+=3){g.FromArrayToRef(h,_,d),g.FromArrayToRef(c,_,f),le.FromArrayToRef(u,_/3*2,p);const m=Math.abs(p.x*o.x+n.x%1)*(t-1)%t|0,v=Math.abs(p.y*o.y+n.y%1)*(i-1)%i|0,x=(m+v*t)*4,b=e[x]/255,S=e[x+1]/255,C=e[x+2]/255,E=b*.3+S*.59+C*.11;f.normalize(),f.scaleInPlace(s+(r-s)*E),d=d.add(f),d.toArray(h,_)}return de.ComputeNormals(h,this.getIndices(),c),l?(this.setVerticesData(y.PositionKind,h),this.setVerticesData(y.NormalKind,c),this.setVerticesData(y.UVKind,u)):(this.updateVerticesData(y.PositionKind,h),this.updateVerticesData(y.NormalKind,c)),this}convertToFlatShadedMesh(){const e=this.getVerticesDataKinds(),t={},i={},s={};let r=!1,n,o;for(n=0;n<e.length;n++){o=e[n];const m=this.getVertexBuffer(o),v=m.getData();if(!((v instanceof Array||v instanceof Float32Array)&&v.length===0)){if(o===y.NormalKind){r=m.isUpdatable(),e.splice(n,1),n--;continue}t[o]=m,i[o]=this.getVerticesData(o),s[o]=[]}}const l=this.subMeshes.slice(0),h=this.getIndices(),c=this.getTotalIndices();let u;for(u=0;u<c;u++){const m=h[u];for(n=0;n<e.length;n++){if(o=e[n],!t[o])continue;const v=t[o].getStrideSize();for(let x=0;x<v;x++)s[o].push(i[o][m*v+x])}}const d=[],f=s[y.PositionKind],p=this.getScene().useRightHandedSystem;let _;for(p?_=this.overrideMaterialSideOrientation===1:_=this.overrideMaterialSideOrientation===0,u=0;u<c;u+=3){h[u]=u,h[u+1]=u+1,h[u+2]=u+2;const m=g.FromArray(f,u*3),v=g.FromArray(f,(u+1)*3),x=g.FromArray(f,(u+2)*3),b=m.subtract(v),S=x.subtract(v),C=g.Normalize(g.Cross(b,S));_&&C.scaleInPlace(-1);for(let E=0;E<3;E++)d.push(C.x),d.push(C.y),d.push(C.z)}for(this.setIndices(h),this.setVerticesData(y.NormalKind,d,r),n=0;n<e.length;n++)o=e[n],s[o]&&this.setVerticesData(o,s[o],t[o].isUpdatable());this.releaseSubMeshes();for(let m=0;m<l.length;m++){const v=l[m];fs.AddToMesh(v.materialIndex,v.indexStart,v.indexCount,v.indexStart,v.indexCount,this)}return this.synchronizeInstances(),this}convertToUnIndexedMesh(){const e=this.getVerticesDataKinds(),t={},i={},s={};let r,n;for(r=0;r<e.length;r++){n=e[r];const u=this.getVertexBuffer(n);t[n]=u,i[n]=t[n].getData(),s[n]=[]}const o=this.subMeshes.slice(0),l=this.getIndices(),h=this.getTotalIndices();let c;for(c=0;c<h;c++){const u=l[c];for(r=0;r<e.length;r++){n=e[r];const d=t[n].getStrideSize();for(let f=0;f<d;f++)s[n].push(i[n][u*d+f])}}for(c=0;c<h;c+=3)l[c]=c,l[c+1]=c+1,l[c+2]=c+2;for(this.setIndices(l),r=0;r<e.length;r++)n=e[r],this.setVerticesData(n,s[n],t[n].isUpdatable(),t[n].getStrideSize());this.releaseSubMeshes();for(let u=0;u<o.length;u++){const d=o[u];fs.AddToMesh(d.materialIndex,d.indexStart,d.indexCount,d.indexStart,d.indexCount,this)}return this._unIndexed=!0,this.synchronizeInstances(),this}flipFaces(e=!1){const t=de.ExtractFromMesh(this);let i;if(e&&this.isVerticesDataPresent(y.NormalKind)&&t.normals)for(i=0;i<t.normals.length;i++)t.normals[i]*=-1;if(t.indices){let s;for(i=0;i<t.indices.length;i+=3)s=t.indices[i+1],t.indices[i+1]=t.indices[i+2],t.indices[i+2]=s}return t.applyToMesh(this,this.isVertexBufferUpdatable(y.PositionKind)),this}increaseVertices(e=1){const t=de.ExtractFromMesh(this),i=t.indices&&!Array.isArray(t.indices)&&Array.from?Array.from(t.indices):t.indices,s=t.positions&&!Array.isArray(t.positions)&&Array.from?Array.from(t.positions):t.positions,r=t.uvs&&!Array.isArray(t.uvs)&&Array.from?Array.from(t.uvs):t.uvs,n=t.normals&&!Array.isArray(t.normals)&&Array.from?Array.from(t.normals):t.normals;if(!i||!s)B.Warn("Couldn't increase number of vertices : VertexData must contain at least indices and positions");else{t.indices=i,t.positions=s,r&&(t.uvs=r),n&&(t.normals=n);const o=e+1,l=new Array;for(let C=0;C<o+1;C++)l[C]=new Array;let h,c;const u=new g(0,0,0),d=new g(0,0,0),f=new le(0,0),p=new Array,_=new Array,m=new Array;let v,x=s.length,b;r&&(b=r.length);let S;n&&(S=n.length);for(let C=0;C<i.length;C+=3){_[0]=i[C],_[1]=i[C+1],_[2]=i[C+2];for(let E=0;E<3;E++)if(h=_[E],c=_[(E+1)%3],m[h]===void 0&&m[c]===void 0?(m[h]=new Array,m[c]=new Array):(m[h]===void 0&&(m[h]=new Array),m[c]===void 0&&(m[c]=new Array)),m[h][c]===void 0&&m[c][h]===void 0){m[h][c]=[],u.x=(s[3*c]-s[3*h])/o,u.y=(s[3*c+1]-s[3*h+1])/o,u.z=(s[3*c+2]-s[3*h+2])/o,n&&(d.x=(n[3*c]-n[3*h])/o,d.y=(n[3*c+1]-n[3*h+1])/o,d.z=(n[3*c+2]-n[3*h+2])/o),r&&(f.x=(r[2*c]-r[2*h])/o,f.y=(r[2*c+1]-r[2*h+1])/o),m[h][c].push(h);for(let A=1;A<o;A++)m[h][c].push(s.length/3),s[x++]=s[3*h]+A*u.x,s[x++]=s[3*h+1]+A*u.y,s[x++]=s[3*h+2]+A*u.z,n&&(n[S++]=n[3*h]+A*d.x,n[S++]=n[3*h+1]+A*d.y,n[S++]=n[3*h+2]+A*d.z),r&&(r[b++]=r[2*h]+A*f.x,r[b++]=r[2*h+1]+A*f.y);m[h][c].push(c),m[c][h]=new Array,v=m[h][c].length;for(let A=0;A<v;A++)m[c][h][A]=m[h][c][v-1-A]}l[0][0]=i[C],l[1][0]=m[i[C]][i[C+1]][1],l[1][1]=m[i[C]][i[C+2]][1];for(let E=2;E<o;E++){l[E][0]=m[i[C]][i[C+1]][E],l[E][E]=m[i[C]][i[C+2]][E],u.x=(s[3*l[E][E]]-s[3*l[E][0]])/E,u.y=(s[3*l[E][E]+1]-s[3*l[E][0]+1])/E,u.z=(s[3*l[E][E]+2]-s[3*l[E][0]+2])/E,n&&(d.x=(n[3*l[E][E]]-n[3*l[E][0]])/E,d.y=(n[3*l[E][E]+1]-n[3*l[E][0]+1])/E,d.z=(n[3*l[E][E]+2]-n[3*l[E][0]+2])/E),r&&(f.x=(r[2*l[E][E]]-r[2*l[E][0]])/E,f.y=(r[2*l[E][E]+1]-r[2*l[E][0]+1])/E);for(let A=1;A<E;A++)l[E][A]=s.length/3,s[x++]=s[3*l[E][0]]+A*u.x,s[x++]=s[3*l[E][0]+1]+A*u.y,s[x++]=s[3*l[E][0]+2]+A*u.z,n&&(n[S++]=n[3*l[E][0]]+A*d.x,n[S++]=n[3*l[E][0]+1]+A*d.y,n[S++]=n[3*l[E][0]+2]+A*d.z),r&&(r[b++]=r[2*l[E][0]]+A*f.x,r[b++]=r[2*l[E][0]+1]+A*f.y)}l[o]=m[i[C+1]][i[C+2]],p.push(l[0][0],l[1][0],l[1][1]);for(let E=1;E<o;E++){let A;for(A=0;A<E;A++)p.push(l[E][A],l[E+1][A],l[E+1][A+1]),p.push(l[E][A],l[E+1][A+1],l[E][A+1]);p.push(l[E][A],l[E+1][A],l[E+1][A+1])}}t.indices=p,t.applyToMesh(this,this.isVertexBufferUpdatable(y.PositionKind))}}forceSharedVertices(){const e=de.ExtractFromMesh(this),t=e.uvs,i=e.indices,s=e.positions,r=e.colors;if(i===void 0||s===void 0||i===null||s===null)B.Warn("VertexData contains empty entries");else{const n=new Array,o=new Array,l=new Array,h=new Array;let c=new Array,u=0;const d={};let f,p;for(let m=0;m<i.length;m+=3){p=[i[m],i[m+1],i[m+2]],c=new Array;for(let v=0;v<3;v++){c[v]="";for(let x=0;x<3;x++)Math.abs(s[3*p[v]+x])<1e-8&&(s[3*p[v]+x]=0),c[v]+=s[3*p[v]+x]+"|"}if(!(c[0]==c[1]||c[0]==c[2]||c[1]==c[2]))for(let v=0;v<3;v++){if(f=d[c[v]],f===void 0){d[c[v]]=u,f=u++;for(let x=0;x<3;x++)n.push(s[3*p[v]+x]);if(r!=null)for(let x=0;x<4;x++)h.push(r[4*p[v]+x]);if(t!=null)for(let x=0;x<2;x++)l.push(t[2*p[v]+x])}o.push(f)}}const _=new Array;de.ComputeNormals(n,o,_),e.positions=n,e.indices=o,e.normals=_,t!=null&&(e.uvs=l),r!=null&&(e.colors=h),e.applyToMesh(this,this.isVertexBufferUpdatable(y.PositionKind))}}static _instancedMeshFactory(e,t){throw Ve("InstancedMesh")}static _PhysicsImpostorParser(e,t,i){throw Ve("PhysicsImpostor")}createInstance(e){return V._instancedMeshFactory(e,this)}synchronizeInstances(){for(let e=0;e<this.instances.length;e++)this.instances[e]._syncSubMeshes();return this}optimizeIndices(e){const t=this.getIndices(),i=this.getVerticesData(y.PositionKind);if(!i||!t)return this;const s=new Array;for(let n=0;n<i.length;n=n+3)s.push(g.FromArray(i,n));const r=new Array;return fr.SyncAsyncForLoop(s.length,40,n=>{const o=s.length-1-n,l=s[o];for(let h=0;h<o;++h){const c=s[h];if(l.equals(c)){r[o]=h;break}}},()=>{for(let o=0;o<t.length;++o)t[o]=r[t[o]]||t[o];const n=this.subMeshes.slice(0);this.setIndices(t),this.subMeshes=n,e&&e(this)}),this}serialize(e={}){e.name=this.name,e.id=this.id,e.uniqueId=this.uniqueId,e.type=this.getClassName(),ot&&ot.HasTags(this)&&(e.tags=ot.GetTags(this)),e.position=this.position.asArray(),this.rotationQuaternion?e.rotationQuaternion=this.rotationQuaternion.asArray():this.rotation&&(e.rotation=this.rotation.asArray()),e.scaling=this.scaling.asArray(),this._postMultiplyPivotMatrix?e.pivotMatrix=this.getPivotMatrix().asArray():e.localMatrix=this.getPivotMatrix().asArray(),e.isEnabled=this.isEnabled(!1),e.isVisible=this.isVisible,e.infiniteDistance=this.infiniteDistance,e.pickable=this.isPickable,e.receiveShadows=this.receiveShadows,e.billboardMode=this.billboardMode,e.visibility=this.visibility,e.checkCollisions=this.checkCollisions,e.isBlocker=this.isBlocker,e.overrideMaterialSideOrientation=this.overrideMaterialSideOrientation,this.parent&&this.parent._serializeAsParent(e),e.isUnIndexed=this.isUnIndexed;const t=this._geometry;if(t&&this.subMeshes){e.geometryUniqueId=t.uniqueId,e.geometryId=t.id,e.subMeshes=[];for(let i=0;i<this.subMeshes.length;i++){const s=this.subMeshes[i];e.subMeshes.push({materialIndex:s.materialIndex,verticesStart:s.verticesStart,verticesCount:s.verticesCount,indexStart:s.indexStart,indexCount:s.indexCount})}}if(this.material?this.material.doNotSerialize||(e.materialUniqueId=this.material.uniqueId,e.materialId=this.material.id):(this.material=null,e.materialUniqueId=this._scene.defaultMaterial.uniqueId,e.materialId=this._scene.defaultMaterial.id),this.morphTargetManager&&(e.morphTargetManagerId=this.morphTargetManager.uniqueId),this.skeleton&&(e.skeletonId=this.skeleton.id,e.numBoneInfluencers=this.numBoneInfluencers),this.getScene()._getComponent(ue.NAME_PHYSICSENGINE)){const i=this.getPhysicsImpostor();i&&(e.physicsMass=i.getParam("mass"),e.physicsFriction=i.getParam("friction"),e.physicsRestitution=i.getParam("mass"),e.physicsImpostor=i.type)}this.metadata&&(e.metadata=this.metadata),e.instances=[];for(let i=0;i<this.instances.length;i++){const s=this.instances[i];if(s.doNotSerialize)continue;const r={name:s.name,id:s.id,isEnabled:s.isEnabled(!1),isVisible:s.isVisible,isPickable:s.isPickable,checkCollisions:s.checkCollisions,position:s.position.asArray(),scaling:s.scaling.asArray()};if(s.parent&&s.parent._serializeAsParent(r),s.rotationQuaternion?r.rotationQuaternion=s.rotationQuaternion.asArray():s.rotation&&(r.rotation=s.rotation.asArray()),this.getScene()._getComponent(ue.NAME_PHYSICSENGINE)){const n=s.getPhysicsImpostor();n&&(r.physicsMass=n.getParam("mass"),r.physicsFriction=n.getParam("friction"),r.physicsRestitution=n.getParam("mass"),r.physicsImpostor=n.type)}s.metadata&&(r.metadata=s.metadata),e.instances.push(r),xe.AppendSerializedAnimations(s,r),r.ranges=s.serializeAnimationRanges()}if(this._thinInstanceDataStorage.instancesCount&&this._thinInstanceDataStorage.matrixData&&(e.thinInstances={instancesCount:this._thinInstanceDataStorage.instancesCount,matrixData:Array.from(this._thinInstanceDataStorage.matrixData),matrixBufferSize:this._thinInstanceDataStorage.matrixBufferSize,enablePicking:this.thinInstanceEnablePicking},this._userThinInstanceBuffersStorage)){const i={data:{},sizes:{},strides:{}};for(const s in this._userThinInstanceBuffersStorage.data)i.data[s]=Array.from(this._userThinInstanceBuffersStorage.data[s]),i.sizes[s]=this._userThinInstanceBuffersStorage.sizes[s],i.strides[s]=this._userThinInstanceBuffersStorage.strides[s];e.thinInstances.userThinInstance=i}return xe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.layerMask=this.layerMask,e.alphaIndex=this.alphaIndex,e.hasVertexAlpha=this.hasVertexAlpha,e.overlayAlpha=this.overlayAlpha,e.overlayColor=this.overlayColor.asArray(),e.renderOverlay=this.renderOverlay,e.applyFog=this.applyFog,this.actionManager&&(e.actions=this.actionManager.serialize(this.name)),e}_syncGeometryWithMorphTargetManager(){if(!this.geometry)return;this._markSubMeshesAsAttributesDirty();const e=this._internalAbstractMeshDataInfo._morphTargetManager;if(e&&e.vertexCount){if(e.vertexCount!==this.getTotalVertices()){B.Error("Mesh is incompatible with morph targets. Targets and mesh must all have the same vertices count."),this.morphTargetManager=null;return}if(e.isUsingTextureForTargets)return;for(let t=0;t<e.numInfluencers;t++){const i=e.getActiveTarget(t),s=i.getPositions();if(!s){B.Error("Invalid morph target. Target must have positions.");return}this.geometry.setVerticesData(y.PositionKind+t,s,!1,3);const r=i.getNormals();r&&this.geometry.setVerticesData(y.NormalKind+t,r,!1,3);const n=i.getTangents();n&&this.geometry.setVerticesData(y.TangentKind+t,n,!1,3);const o=i.getUVs();o&&this.geometry.setVerticesData(y.UVKind+"_"+t,o,!1,2)}}else{let t=0;for(;this.geometry.isVerticesDataPresent(y.PositionKind+t);)this.geometry.removeVerticesData(y.PositionKind+t),this.geometry.isVerticesDataPresent(y.NormalKind+t)&&this.geometry.removeVerticesData(y.NormalKind+t),this.geometry.isVerticesDataPresent(y.TangentKind+t)&&this.geometry.removeVerticesData(y.TangentKind+t),this.geometry.isVerticesDataPresent(y.UVKind+t)&&this.geometry.removeVerticesData(y.UVKind+"_"+t),t++}}static Parse(e,t,i){let s;if(e.type&&e.type==="LinesMesh"?s=V._LinesMeshParser(e,t):e.type&&e.type==="GroundMesh"?s=V._GroundMeshParser(e,t):e.type&&e.type==="GoldbergMesh"?s=V._GoldbergMeshParser(e,t):s=new V(e.name,t),s.id=e.id,s._waitingParsedUniqueId=e.uniqueId,ot&&ot.AddTagsTo(s,e.tags),s.position=g.FromArray(e.position),e.metadata!==void 0&&(s.metadata=e.metadata),e.rotationQuaternion?s.rotationQuaternion=Q.FromArray(e.rotationQuaternion):e.rotation&&(s.rotation=g.FromArray(e.rotation)),s.scaling=g.FromArray(e.scaling),e.localMatrix?s.setPreTransformMatrix(L.FromArray(e.localMatrix)):e.pivotMatrix&&s.setPivotMatrix(L.FromArray(e.pivotMatrix)),s.setEnabled(e.isEnabled),s.isVisible=e.isVisible,s.infiniteDistance=e.infiniteDistance,s.showBoundingBox=e.showBoundingBox,s.showSubMeshesBoundingBox=e.showSubMeshesBoundingBox,e.applyFog!==void 0&&(s.applyFog=e.applyFog),e.pickable!==void 0&&(s.isPickable=e.pickable),e.alphaIndex!==void 0&&(s.alphaIndex=e.alphaIndex),s.receiveShadows=e.receiveShadows,s.billboardMode=e.billboardMode,e.visibility!==void 0&&(s.visibility=e.visibility),s.checkCollisions=e.checkCollisions,s.overrideMaterialSideOrientation=e.overrideMaterialSideOrientation,e.isBlocker!==void 0&&(s.isBlocker=e.isBlocker),s._shouldGenerateFlatShading=e.useFlatShading,e.freezeWorldMatrix&&(s._waitingData.freezeWorldMatrix=e.freezeWorldMatrix),e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),e.actions!==void 0&&(s._waitingData.actions=e.actions),e.overlayAlpha!==void 0&&(s.overlayAlpha=e.overlayAlpha),e.overlayColor!==void 0&&(s.overlayColor=re.FromArray(e.overlayColor)),e.renderOverlay!==void 0&&(s.renderOverlay=e.renderOverlay),s.isUnIndexed=!!e.isUnIndexed,s.hasVertexAlpha=e.hasVertexAlpha,e.delayLoadingFile?(s.delayLoadState=4,s.delayLoadingFile=i+e.delayLoadingFile,s.buildBoundingInfo(g.FromArray(e.boundingBoxMinimum),g.FromArray(e.boundingBoxMaximum)),e._binaryInfo&&(s._binaryInfo=e._binaryInfo),s._delayInfo=[],e.hasUVs&&s._delayInfo.push(y.UVKind),e.hasUVs2&&s._delayInfo.push(y.UV2Kind),e.hasUVs3&&s._delayInfo.push(y.UV3Kind),e.hasUVs4&&s._delayInfo.push(y.UV4Kind),e.hasUVs5&&s._delayInfo.push(y.UV5Kind),e.hasUVs6&&s._delayInfo.push(y.UV6Kind),e.hasColors&&s._delayInfo.push(y.ColorKind),e.hasMatricesIndices&&s._delayInfo.push(y.MatricesIndicesKind),e.hasMatricesWeights&&s._delayInfo.push(y.MatricesWeightsKind),s._delayLoadingFunction=os._ImportGeometry,bi.ForceFullSceneLoadingForIncremental&&s._checkDelayState()):os._ImportGeometry(e,s),e.materialUniqueId?s._waitingMaterialId=e.materialUniqueId:e.materialId&&(s._waitingMaterialId=e.materialId),e.morphTargetManagerId>-1&&(s.morphTargetManager=t.getMorphTargetManagerById(e.morphTargetManagerId)),e.skeletonId!==void 0&&e.skeletonId!==null&&(s.skeleton=t.getLastSkeletonById(e.skeletonId),e.numBoneInfluencers&&(s.numBoneInfluencers=e.numBoneInfluencers)),e.animations){for(let r=0;r<e.animations.length;r++){const n=e.animations[r],o=Si("BABYLON.Animation");o&&s.animations.push(o.Parse(n))}lt.ParseAnimationRanges(s,e,t)}if(e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.layerMask&&!isNaN(e.layerMask)?s.layerMask=Math.abs(parseInt(e.layerMask)):s.layerMask=268435455,e.physicsImpostor&&V._PhysicsImpostorParser(t,s,e),e.lodMeshIds&&(s._waitingData.lods={ids:e.lodMeshIds,distances:e.lodDistances?e.lodDistances:null,coverages:e.lodCoverages?e.lodCoverages:null}),e.instances)for(let r=0;r<e.instances.length;r++){const n=e.instances[r],o=s.createInstance(n.name);if(n.id&&(o.id=n.id),ot&&(n.tags?ot.AddTagsTo(o,n.tags):ot.AddTagsTo(o,e.tags)),o.position=g.FromArray(n.position),n.metadata!==void 0&&(o.metadata=n.metadata),n.parentId!==void 0&&(o._waitingParentId=n.parentId),n.parentInstanceIndex!==void 0&&(o._waitingParentInstanceIndex=n.parentInstanceIndex),n.isEnabled!==void 0&&n.isEnabled!==null&&o.setEnabled(n.isEnabled),n.isVisible!==void 0&&n.isVisible!==null&&(o.isVisible=n.isVisible),n.isPickable!==void 0&&n.isPickable!==null&&(o.isPickable=n.isPickable),n.rotationQuaternion?o.rotationQuaternion=Q.FromArray(n.rotationQuaternion):n.rotation&&(o.rotation=g.FromArray(n.rotation)),o.scaling=g.FromArray(n.scaling),n.checkCollisions!=null&&n.checkCollisions!=null&&(o.checkCollisions=n.checkCollisions),n.pickable!=null&&n.pickable!=null&&(o.isPickable=n.pickable),n.showBoundingBox!=null&&n.showBoundingBox!=null&&(o.showBoundingBox=n.showBoundingBox),n.showSubMeshesBoundingBox!=null&&n.showSubMeshesBoundingBox!=null&&(o.showSubMeshesBoundingBox=n.showSubMeshesBoundingBox),n.alphaIndex!=null&&n.showSubMeshesBoundingBox!=null&&(o.alphaIndex=n.alphaIndex),n.physicsImpostor&&V._PhysicsImpostorParser(t,o,n),n.animations){for(let l=0;l<n.animations.length;l++){const h=n.animations[l],c=Si("BABYLON.Animation");c&&o.animations.push(c.Parse(h))}lt.ParseAnimationRanges(o,n,t),n.autoAnimate&&t.beginAnimation(o,n.autoAnimateFrom,n.autoAnimateTo,n.autoAnimateLoop,n.autoAnimateSpeed||1)}}if(e.thinInstances){const r=e.thinInstances;if(s.thinInstanceEnablePicking=!!r.enablePicking,r.matrixData?(s.thinInstanceSetBuffer("matrix",new Float32Array(r.matrixData),16,!1),s._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,s._thinInstanceDataStorage.instancesCount=r.instancesCount):s._thinInstanceDataStorage.matrixBufferSize=r.matrixBufferSize,e.thinInstances.userThinInstance){const n=e.thinInstances.userThinInstance;for(const o in n.data)s.thinInstanceSetBuffer(o,new Float32Array(n.data[o]),n.strides[o],!1),s._userThinInstanceBuffersStorage.sizes[o]=n.sizes[o]}}return s}setPositionsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourcePositions){const t=this.getVerticesData(y.PositionKind);if(!t)return e._sourcePositions;e._sourcePositions=new Float32Array(t),this.isVertexBufferUpdatable(y.PositionKind)||this.setVerticesData(y.PositionKind,t,!0)}return e._sourcePositions}setNormalsForCPUSkinning(){const e=this._internalMeshDataInfo;if(!e._sourceNormals){const t=this.getVerticesData(y.NormalKind);if(!t)return e._sourceNormals;e._sourceNormals=new Float32Array(t),this.isVertexBufferUpdatable(y.NormalKind)||this.setVerticesData(y.NormalKind,t,!0)}return e._sourceNormals}applySkeleton(e){if(!this.geometry)return this;if(this.geometry._softwareSkinningFrameId==this.getScene().getFrameId())return this;if(this.geometry._softwareSkinningFrameId=this.getScene().getFrameId(),!this.isVerticesDataPresent(y.PositionKind))return this;if(!this.isVerticesDataPresent(y.MatricesIndicesKind))return this;if(!this.isVerticesDataPresent(y.MatricesWeightsKind))return this;const t=this.isVerticesDataPresent(y.NormalKind),i=this._internalMeshDataInfo;if(!i._sourcePositions){const v=this.subMeshes.slice();this.setPositionsForCPUSkinning(),this.subMeshes=v}t&&!i._sourceNormals&&this.setNormalsForCPUSkinning();let s=this.getVerticesData(y.PositionKind);if(!s)return this;s instanceof Float32Array||(s=new Float32Array(s));let r=this.getVerticesData(y.NormalKind);if(t){if(!r)return this;r instanceof Float32Array||(r=new Float32Array(r))}const n=this.getVerticesData(y.MatricesIndicesKind),o=this.getVerticesData(y.MatricesWeightsKind);if(!o||!n)return this;const l=this.numBoneInfluencers>4,h=l?this.getVerticesData(y.MatricesIndicesExtraKind):null,c=l?this.getVerticesData(y.MatricesWeightsExtraKind):null,u=e.getTransformMatrices(this),d=g.Zero(),f=new L,p=new L;let _=0,m;for(let v=0;v<s.length;v+=3,_+=4){let x;for(m=0;m<4;m++)x=o[_+m],x>0&&(L.FromFloat32ArrayToRefScaled(u,Math.floor(n[_+m]*16),x,p),f.addToSelf(p));if(l)for(m=0;m<4;m++)x=c[_+m],x>0&&(L.FromFloat32ArrayToRefScaled(u,Math.floor(h[_+m]*16),x,p),f.addToSelf(p));g.TransformCoordinatesFromFloatsToRef(i._sourcePositions[v],i._sourcePositions[v+1],i._sourcePositions[v+2],f,d),d.toArray(s,v),t&&(g.TransformNormalFromFloatsToRef(i._sourceNormals[v],i._sourceNormals[v+1],i._sourceNormals[v+2],f,d),d.toArray(r,v)),f.reset()}return this.updateVerticesData(y.PositionKind,s),t&&this.updateVerticesData(y.NormalKind,r),this}static MinMax(e){let t=null,i=null;return e.forEach(function(s){const n=s.getBoundingInfo().boundingBox;!t||!i?(t=n.minimumWorld,i=n.maximumWorld):(t.minimizeInPlace(n.minimumWorld),i.maximizeInPlace(n.maximumWorld))}),!t||!i?{min:g.Zero(),max:g.Zero()}:{min:t,max:i}}static Center(e){const t=e instanceof Array?V.MinMax(e):e;return g.Center(t.min,t.max)}static MergeMeshes(e,t=!0,i,s,r,n){return kd(V._MergeMeshesCoroutine(e,t,i,s,r,n,!1))}static MergeMeshesAsync(e,t=!0,i,s,r,n){return T_(V._MergeMeshesCoroutine(e,t,i,s,r,n,!0),$x())}static*_MergeMeshesCoroutine(e,t=!0,i,s,r,n,o){if(e=e.filter(Boolean),e.length===0)return null;let l;if(!i){let A=0;for(l=0;l<e.length;l++)if(A+=e[l].getTotalVertices(),A>=65536)return B.Warn("Cannot merge meshes because resulting mesh will have more than 65536 vertices. Please use allow32BitsIndices = true to use 32 bits indices"),null}n&&(r=!1);const h=new Array,c=new Array,u=new Array,d=e[0].overrideMaterialSideOrientation;for(l=0;l<e.length;l++){const A=e[l];if(A.isAnInstance)return B.Warn("Cannot merge instance meshes."),null;if(d!==A.overrideMaterialSideOrientation)return B.Warn("Cannot merge meshes with different overrideMaterialSideOrientation values."),null;if(r&&u.push(A.getTotalIndices()),n)if(A.material){const M=A.material;if(M instanceof Jn){for(let D=0;D<M.subMaterials.length;D++)h.indexOf(M.subMaterials[D])<0&&h.push(M.subMaterials[D]);for(let D=0;D<A.subMeshes.length;D++)c.push(h.indexOf(M.subMaterials[A.subMeshes[D].materialIndex])),u.push(A.subMeshes[D].indexCount)}else{h.indexOf(M)<0&&h.push(M);for(let D=0;D<A.subMeshes.length;D++)c.push(h.indexOf(M)),u.push(A.subMeshes[D].indexCount)}}else for(let M=0;M<A.subMeshes.length;M++)c.push(0),u.push(A.subMeshes[M].indexCount)}const f=e[0],p=A=>{const M=A.computeWorldMatrix(!0);return[de.ExtractFromMesh(A,!1,!1),M]},[_,m]=p(f);o&&(yield);const v=new Array(e.length-1);for(let A=1;A<e.length;A++)v[A-1]=p(e[A]),o&&(yield);const x=_._mergeCoroutine(m,v,i,o,!t);let b=x.next();for(;!b.done;)o&&(yield),b=x.next();const S=b.value;s||(s=new V(f.name+"_merged",f.getScene()));const C=S._applyToCoroutine(s,void 0,o);let E=C.next();for(;!E.done;)o&&(yield),E=C.next();if(s.checkCollisions=f.checkCollisions,s.overrideMaterialSideOrientation=f.overrideMaterialSideOrientation,t)for(l=0;l<e.length;l++)e[l].dispose();if(r||n){s.releaseSubMeshes(),l=0;let A=0;for(;l<u.length;)fs.CreateFromIndices(0,A,u[l],s,void 0,!1),A+=u[l],l++;for(const M of s.subMeshes)M.refreshBoundingInfo();s.computeWorldMatrix(!0)}if(n){const A=new Jn(f.name+"_merged",f.getScene());A.subMaterials=h;for(let M=0;M<s.subMeshes.length;M++)s.subMeshes[M].materialIndex=c[M];s.material=A}else s.material=f.material;return s}addInstance(e){e._indexInSourceMeshInstanceArray=this.instances.length,this.instances.push(e)}removeInstance(e){const t=e._indexInSourceMeshInstanceArray;if(t!=-1){if(t!==this.instances.length-1){const i=this.instances[this.instances.length-1];this.instances[t]=i,i._indexInSourceMeshInstanceArray=t}e._indexInSourceMeshInstanceArray=-1,this.instances.pop()}}_shouldConvertRHS(){return this.overrideMaterialSideOrientation===ne.CounterClockWiseSideOrientation}}V.FRONTSIDE=de.FRONTSIDE;V.BACKSIDE=de.BACKSIDE;V.DOUBLESIDE=de.DOUBLESIDE;V.DEFAULTSIDE=de.DEFAULTSIDE;V.NO_CAP=0;V.CAP_START=1;V.CAP_END=2;V.CAP_ALL=3;V.NO_FLIP=0;V.FLIP_TILE=1;V.ROTATE_TILE=2;V.FLIP_ROW=3;V.ROTATE_ROW=4;V.FLIP_N_ROTATE_TILE=5;V.FLIP_N_ROTATE_ROW=6;V.CENTER=0;V.LEFT=1;V.RIGHT=2;V.TOP=3;V.BOTTOM=4;V.INSTANCEDMESH_SORT_TRANSPARENT=!1;V._GroundMeshParser=(a,e)=>{throw Ve("GroundMesh")};V._GoldbergMeshParser=(a,e)=>{throw Ve("GoldbergMesh")};V._LinesMeshParser=(a,e)=>{throw Ve("LinesMesh")};he("BABYLON.Mesh",V);V.prototype.setMaterialByID=function(a){return this.setMaterialById(a)};V.CreateDisc=V.CreateDisc||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateBox=V.CreateBox||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateSphere=V.CreateSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateCylinder=V.CreateCylinder||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateTorusKnot=V.CreateTorusKnot||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateTorus=V.CreateTorus||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreatePlane=V.CreatePlane||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateGround=V.CreateGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateTiledGround=V.CreateTiledGround||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateGroundFromHeightMap=V.CreateGroundFromHeightMap||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateTube=V.CreateTube||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreatePolyhedron=V.CreatePolyhedron||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateIcoSphere=V.CreateIcoSphere||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateDecal=V.CreateDecal||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.CreateCapsule=V.CreateCapsule||(()=>{throw new Error("Import MeshBuilder to populate this function")});V.ExtendToGoldberg=V.ExtendToGoldberg||(()=>{throw new Error("Import MeshBuilder to populate this function")});class r1{constructor(){this._zoomStopsAnimation=!1,this._idleRotationSpeed=.05,this._idleRotationWaitTime=2e3,this._idleRotationSpinupTime=2e3,this.targetAlpha=null,this._isPointerDown=!1,this._lastFrameTime=null,this._lastInteractionTime=-1/0,this._cameraRotationSpeed=0,this._lastFrameRadius=0}get name(){return"AutoRotation"}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set idleRotationSpeed(e){this._idleRotationSpeed=e}get idleRotationSpeed(){return this._idleRotationSpeed}set idleRotationWaitTime(e){this._idleRotationWaitTime=e}get idleRotationWaitTime(){return this._idleRotationWaitTime}set idleRotationSpinupTime(e){this._idleRotationSpinupTime=e}get idleRotationSpinupTime(){return this._idleRotationSpinupTime}get rotationInProgress(){return Math.abs(this._cameraRotationSpeed)>0}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ce.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ce.POINTERUP&&(this._isPointerDown=!1)}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{if(this._reachTargetAlpha())return;const i=ps.Now;let s=0;this._lastFrameTime!=null&&(s=i-this._lastFrameTime),this._lastFrameTime=i,this._applyUserInteraction();const r=i-this._lastInteractionTime-this._idleRotationWaitTime,n=Math.max(Math.min(r/this._idleRotationSpinupTime,1),0);this._cameraRotationSpeed=this._idleRotationSpeed*n,this._attachedCamera&&(this._attachedCamera.alpha-=this._cameraRotationSpeed*(s/1e3))})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._attachedCamera=null}resetLastInteractionTime(e){this._lastInteractionTime=e!=null?e:ps.Now}_reachTargetAlpha(){return this._attachedCamera&&this.targetAlpha?Math.abs(this._attachedCamera.alpha-this.targetAlpha)<tt:!1}_userIsZooming(){return this._attachedCamera?this._attachedCamera.inertialRadiusOffset!==0:!1}_shouldAnimationStopForInteraction(){if(!this._attachedCamera)return!1;let e=!1;return this._lastFrameRadius===this._attachedCamera.radius&&this._attachedCamera.inertialRadiusOffset!==0&&(e=!0),this._lastFrameRadius=this._attachedCamera.radius,this._zoomStopsAnimation?e:this._userIsZooming()}_applyUserInteraction(){this._userIsMoving()&&!this._shouldAnimationStopForInteraction()&&(this._lastInteractionTime=ps.Now)}_userIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}class cs{constructor(){this._easingMode=cs.EASINGMODE_EASEIN}setEasingMode(e){const t=Math.min(Math.max(e,0),2);this._easingMode=t}getEasingMode(){return this._easingMode}easeInCore(e){throw new Error("You must implement this method")}ease(e){switch(this._easingMode){case cs.EASINGMODE_EASEIN:return this.easeInCore(e);case cs.EASINGMODE_EASEOUT:return 1-this.easeInCore(1-e)}return e>=.5?(1-this.easeInCore((1-e)*2))*.5+.5:this.easeInCore(e*2)*.5}}cs.EASINGMODE_EASEIN=0;cs.EASINGMODE_EASEOUT=1;cs.EASINGMODE_EASEINOUT=2;class n1 extends cs{easeInCore(e){return e=Math.max(0,Math.min(1,e)),1-Math.sqrt(1-e*e)}}class a1 extends cs{constructor(e=1){super(),this.amplitude=e}easeInCore(e){const t=Math.max(0,this.amplitude);return Math.pow(e,3)-e*t*Math.sin(3.141592653589793*e)}}class o1 extends cs{constructor(e=2){super(),this.exponent=e}easeInCore(e){return this.exponent<=0?e:(Math.exp(this.exponent*e)-1)/(Math.exp(this.exponent)-1)}}class l1 extends cs{easeInCore(e){return e*e}}class C_ extends cs{easeInCore(e){return 1-Math.sin(1.5707963267948966*(1-e))}}var td;(function(a){a[a.NONE=0]="NONE",a[a.STEP=1]="STEP"})(td||(td={}));class Ao{constructor(e,t,i){this.name=e,this.from=t,this.to=i}clone(){return new Ao(this.name,this.from,this.to)}}class ae{constructor(e,t,i,s,r,n){this.name=e,this.targetProperty=t,this.framePerSecond=i,this.dataType=s,this.loopMode=r,this.enableBlending=n,this._easingFunction=null,this._runtimeAnimations=new Array,this._events=new Array,this.blendingSpeed=.01,this._ranges={},this.targetPropertyPath=t.split("."),this.dataType=s,this.loopMode=r===void 0?ae.ANIMATIONLOOPMODE_CYCLE:r,this.uniqueId=ae._UniqueIdGenerator++}static _PrepareAnimation(e,t,i,s,r,n,o,l){let h;if(!isNaN(parseFloat(r))&&isFinite(r)?h=ae.ANIMATIONTYPE_FLOAT:r instanceof Q?h=ae.ANIMATIONTYPE_QUATERNION:r instanceof g?h=ae.ANIMATIONTYPE_VECTOR3:r instanceof le?h=ae.ANIMATIONTYPE_VECTOR2:r instanceof re?h=ae.ANIMATIONTYPE_COLOR3:r instanceof J?h=ae.ANIMATIONTYPE_COLOR4:r instanceof js&&(h=ae.ANIMATIONTYPE_SIZE),h==null)return null;const c=new ae(e,t,i,h,o),u=[{frame:0,value:r},{frame:s,value:n}];return c.setKeys(u),l!==void 0&&c.setEasingFunction(l),c}static CreateAnimation(e,t,i,s){const r=new ae(e+"Animation",e,i,t,ae.ANIMATIONLOOPMODE_CONSTANT);return r.setEasingFunction(s),r}static CreateAndStartAnimation(e,t,i,s,r,n,o,l,h,c,u){const d=ae._PrepareAnimation(e,i,s,r,n,o,l,h);return!d||(t.getScene&&(u=t.getScene()),!u)?null:u.beginDirectAnimation(t,[d],0,r,d.loopMode===1,1,c)}static CreateAndStartHierarchyAnimation(e,t,i,s,r,n,o,l,h,c,u){const d=ae._PrepareAnimation(e,s,r,n,o,l,h,c);return d?t.getScene().beginDirectHierarchyAnimation(t,i,[d],0,n,d.loopMode===1,1,u):null}static CreateMergeAndStartAnimation(e,t,i,s,r,n,o,l,h,c){const u=ae._PrepareAnimation(e,i,s,r,n,o,l,h);return u?(t.animations.push(u),t.getScene().beginAnimation(t,0,r,u.loopMode===1,1,c)):null}static MakeAnimationAdditive(e,t=0,i,s=!1,r){let n=e;if(s&&(n=e.clone(),n.name=r||n.name),!n._keys.length)return n;t=t>=0?t:0;let o=0;const l=n._keys[0];let h=n._keys.length-1;const c=n._keys[h],u={referenceValue:l.value,referencePosition:G.Vector3[0],referenceQuaternion:G.Quaternion[0],referenceScaling:G.Vector3[1],keyPosition:G.Vector3[2],keyQuaternion:G.Quaternion[1],keyScaling:G.Vector3[3]};let d=!1,f=l.frame,p=c.frame;if(i){const x=n.getRange(i);x&&(f=x.from,p=x.to)}let _=l.frame===f,m=c.frame===p;if(n._keys.length===1){const x=n._getKeyValue(n._keys[0]);u.referenceValue=x.clone?x.clone():x,d=!0}else if(t<=l.frame){const x=n._getKeyValue(l.value);u.referenceValue=x.clone?x.clone():x,d=!0}else if(t>=c.frame){const x=n._getKeyValue(c.value);u.referenceValue=x.clone?x.clone():x,d=!0}let v=0;for(;!d||!_||!m&&v<n._keys.length-1;){const x=n._keys[v],b=n._keys[v+1];if(!d&&t>=x.frame&&t<=b.frame){let S;if(t===x.frame)S=n._getKeyValue(x.value);else if(t===b.frame)S=n._getKeyValue(b.value);else{const C={key:v,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT};S=n._interpolate(t,C)}u.referenceValue=S.clone?S.clone():S,d=!0}if(!_&&f>=x.frame&&f<=b.frame){if(f===x.frame)o=v;else if(f===b.frame)o=v+1;else{const S={key:v,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},C=n._interpolate(f,S),E={frame:f,value:C.clone?C.clone():C};n._keys.splice(v+1,0,E),o=v+1}_=!0}if(!m&&p>=x.frame&&p<=b.frame){if(p===x.frame)h=v;else if(p===b.frame)h=v+1;else{const S={key:v,repeatCount:0,loopMode:this.ANIMATIONLOOPMODE_CONSTANT},C=n._interpolate(p,S),E={frame:p,value:C.clone?C.clone():C};n._keys.splice(v+1,0,E),h=v+1}m=!0}v++}for(n.dataType===ae.ANIMATIONTYPE_QUATERNION?u.referenceValue.normalize().conjugateInPlace():n.dataType===ae.ANIMATIONTYPE_MATRIX&&(u.referenceValue.decompose(u.referenceScaling,u.referenceQuaternion,u.referencePosition),u.referenceQuaternion.normalize().conjugateInPlace()),v=o;v<=h;v++){const x=n._keys[v];if(!(v&&n.dataType!==ae.ANIMATIONTYPE_FLOAT&&x.value===l.value))switch(n.dataType){case ae.ANIMATIONTYPE_MATRIX:x.value.decompose(u.keyScaling,u.keyQuaternion,u.keyPosition),u.keyPosition.subtractInPlace(u.referencePosition),u.keyScaling.divideInPlace(u.referenceScaling),u.referenceQuaternion.multiplyToRef(u.keyQuaternion,u.keyQuaternion),L.ComposeToRef(u.keyScaling,u.keyQuaternion,u.keyPosition,x.value);break;case ae.ANIMATIONTYPE_QUATERNION:u.referenceValue.multiplyToRef(x.value,x.value);break;case ae.ANIMATIONTYPE_VECTOR2:case ae.ANIMATIONTYPE_VECTOR3:case ae.ANIMATIONTYPE_COLOR3:case ae.ANIMATIONTYPE_COLOR4:x.value.subtractToRef(u.referenceValue,x.value);break;case ae.ANIMATIONTYPE_SIZE:x.value.width-=u.referenceValue.width,x.value.height-=u.referenceValue.height;break;default:x.value-=u.referenceValue}}return n}static TransitionTo(e,t,i,s,r,n,o,l=null){if(o<=0)return i[e]=t,l&&l(),null;const h=r*(o/1e3);n.setKeys([{frame:0,value:i[e].clone?i[e].clone():i[e]},{frame:h,value:t}]),i.animations||(i.animations=[]),i.animations.push(n);const c=s.beginAnimation(i,0,h,!1);return c.onAnimationEnd=l,c}get runtimeAnimations(){return this._runtimeAnimations}get hasRunningRuntimeAnimations(){for(const e of this._runtimeAnimations)if(!e.isStopped())return!0;return!1}toString(e){let t="Name: "+this.name+", property: "+this.targetProperty;if(t+=", datatype: "+["Float","Vector3","Quaternion","Matrix","Color3","Vector2"][this.dataType],t+=", nKeys: "+(this._keys?this._keys.length:"none"),t+=", nRanges: "+(this._ranges?Object.keys(this._ranges).length:"none"),e){t+=", Ranges: {";let i=!0;for(const s in this._ranges)i&&(t+=", ",i=!1),t+=s;t+="}"}return t}addEvent(e){this._events.push(e),this._events.sort((t,i)=>t.frame-i.frame)}removeEvents(e){for(let t=0;t<this._events.length;t++)this._events[t].frame===e&&(this._events.splice(t,1),t--)}getEvents(){return this._events}createRange(e,t,i){this._ranges[e]||(this._ranges[e]=new Ao(e,t,i))}deleteRange(e,t=!0){const i=this._ranges[e];if(!!i){if(t){const s=i.from,r=i.to;for(let n=this._keys.length-1;n>=0;n--)this._keys[n].frame>=s&&this._keys[n].frame<=r&&this._keys.splice(n,1)}this._ranges[e]=null}}getRange(e){return this._ranges[e]}getKeys(){return this._keys}getHighestFrame(){let e=0;for(let t=0,i=this._keys.length;t<i;t++)e<this._keys[t].frame&&(e=this._keys[t].frame);return e}getEasingFunction(){return this._easingFunction}setEasingFunction(e){this._easingFunction=e}floatInterpolateFunction(e,t,i){return oe.Lerp(e,t,i)}floatInterpolateFunctionWithTangents(e,t,i,s,r){return oe.Hermite(e,t,i,s,r)}quaternionInterpolateFunction(e,t,i){return Q.Slerp(e,t,i)}quaternionInterpolateFunctionWithTangents(e,t,i,s,r){return Q.Hermite(e,t,i,s,r).normalize()}vector3InterpolateFunction(e,t,i){return g.Lerp(e,t,i)}vector3InterpolateFunctionWithTangents(e,t,i,s,r){return g.Hermite(e,t,i,s,r)}vector2InterpolateFunction(e,t,i){return le.Lerp(e,t,i)}vector2InterpolateFunctionWithTangents(e,t,i,s,r){return le.Hermite(e,t,i,s,r)}sizeInterpolateFunction(e,t,i){return js.Lerp(e,t,i)}color3InterpolateFunction(e,t,i){return re.Lerp(e,t,i)}color3InterpolateFunctionWithTangents(e,t,i,s,r){return re.Hermite(e,t,i,s,r)}color4InterpolateFunction(e,t,i){return J.Lerp(e,t,i)}color4InterpolateFunctionWithTangents(e,t,i,s,r){return J.Hermite(e,t,i,s,r)}_getKeyValue(e){return typeof e=="function"?e():e}evaluate(e){return this._interpolate(e,{key:0,repeatCount:0,loopMode:ae.ANIMATIONLOOPMODE_CONSTANT})}_interpolate(e,t){if(t.loopMode===ae.ANIMATIONLOOPMODE_CONSTANT&&t.repeatCount>0)return t.highLimitValue.clone?t.highLimitValue.clone():t.highLimitValue;const i=this._keys,s=i.length;let r=t.key;for(;r>=0&&e<i[r].frame;)--r;for(;r+1<=s-1&&e>=i[r+1].frame;)++r;if(t.key=r,r<0)return this._getKeyValue(i[0].value);if(r+1>s-1)return this._getKeyValue(i[s-1].value);const n=i[r],o=i[r+1],l=this._getKeyValue(n.value),h=this._getKeyValue(o.value);if(n.interpolation===td.STEP)return o.frame>e?l:h;const c=n.outTangent!==void 0&&o.inTangent!==void 0,u=o.frame-n.frame;let d=(e-n.frame)/u;const f=this.getEasingFunction();switch(f!==null&&(d=f.ease(d)),this.dataType){case ae.ANIMATIONTYPE_FLOAT:{const p=c?this.floatInterpolateFunctionWithTangents(l,n.outTangent*u,h,o.inTangent*u,d):this.floatInterpolateFunction(l,h,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return p;case ae.ANIMATIONLOOPMODE_RELATIVE:return t.offsetValue*t.repeatCount+p}break}case ae.ANIMATIONTYPE_QUATERNION:{const p=c?this.quaternionInterpolateFunctionWithTangents(l,n.outTangent.scale(u),h,o.inTangent.scale(u),d):this.quaternionInterpolateFunction(l,h,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return p;case ae.ANIMATIONLOOPMODE_RELATIVE:return p.addInPlace(t.offsetValue.scale(t.repeatCount))}return p}case ae.ANIMATIONTYPE_VECTOR3:{const p=c?this.vector3InterpolateFunctionWithTangents(l,n.outTangent.scale(u),h,o.inTangent.scale(u),d):this.vector3InterpolateFunction(l,h,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return p;case ae.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_VECTOR2:{const p=c?this.vector2InterpolateFunctionWithTangents(l,n.outTangent.scale(u),h,o.inTangent.scale(u),d):this.vector2InterpolateFunction(l,h,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return p;case ae.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_SIZE:{switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return this.sizeInterpolateFunction(l,h,d);case ae.ANIMATIONLOOPMODE_RELATIVE:return this.sizeInterpolateFunction(l,h,d).add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_COLOR3:{const p=c?this.color3InterpolateFunctionWithTangents(l,n.outTangent.scale(u),h,o.inTangent.scale(u),d):this.color3InterpolateFunction(l,h,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return p;case ae.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_COLOR4:{const p=c?this.color4InterpolateFunctionWithTangents(l,n.outTangent.scale(u),h,o.inTangent.scale(u),d):this.color4InterpolateFunction(l,h,d);switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return p;case ae.ANIMATIONLOOPMODE_RELATIVE:return p.add(t.offsetValue.scale(t.repeatCount))}break}case ae.ANIMATIONTYPE_MATRIX:{switch(t.loopMode){case ae.ANIMATIONLOOPMODE_CYCLE:case ae.ANIMATIONLOOPMODE_CONSTANT:return ae.AllowMatricesInterpolation?this.matrixInterpolateFunction(l,h,d,t.workValue):l;case ae.ANIMATIONLOOPMODE_RELATIVE:return l}break}}return 0}matrixInterpolateFunction(e,t,i,s){return ae.AllowMatrixDecomposeForInterpolation?s?(L.DecomposeLerpToRef(e,t,i,s),s):L.DecomposeLerp(e,t,i):s?(L.LerpToRef(e,t,i,s),s):L.Lerp(e,t,i)}clone(){const e=new ae(this.name,this.targetPropertyPath.join("."),this.framePerSecond,this.dataType,this.loopMode);if(e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed,this._keys&&e.setKeys(this._keys),this._ranges){e._ranges={};for(const t in this._ranges){const i=this._ranges[t];!i||(e._ranges[t]=i.clone())}}return e}setKeys(e){this._keys=e.slice(0)}serialize(){const e={};e.name=this.name,e.property=this.targetProperty,e.framePerSecond=this.framePerSecond,e.dataType=this.dataType,e.loopBehavior=this.loopMode,e.enableBlending=this.enableBlending,e.blendingSpeed=this.blendingSpeed;const t=this.dataType;e.keys=[];const i=this.getKeys();for(let s=0;s<i.length;s++){const r=i[s],n={};switch(n.frame=r.frame,t){case ae.ANIMATIONTYPE_FLOAT:n.values=[r.value],r.inTangent!==void 0&&n.values.push(r.inTangent),r.outTangent!==void 0&&(r.inTangent===void 0&&n.values.push(void 0),n.values.push(r.outTangent)),r.interpolation!==void 0&&(r.inTangent===void 0&&n.values.push(void 0),r.outTangent===void 0&&n.values.push(void 0),n.values.push(r.interpolation));break;case ae.ANIMATIONTYPE_QUATERNION:case ae.ANIMATIONTYPE_MATRIX:case ae.ANIMATIONTYPE_VECTOR3:case ae.ANIMATIONTYPE_COLOR3:case ae.ANIMATIONTYPE_COLOR4:n.values=r.value.asArray(),r.inTangent!=null&&n.values.push(r.inTangent.asArray()),r.outTangent!=null&&(r.inTangent===void 0&&n.values.push(void 0),n.values.push(r.outTangent.asArray())),r.interpolation!==void 0&&(r.inTangent===void 0&&n.values.push(void 0),r.outTangent===void 0&&n.values.push(void 0),n.values.push(r.interpolation));break}e.keys.push(n)}e.ranges=[];for(const s in this._ranges){const r=this._ranges[s];if(!r)continue;const n={};n.name=s,n.from=r.from,n.to=r.to,e.ranges.push(n)}return e}static _UniversalLerp(e,t,i){const s=e.constructor;return s.Lerp?s.Lerp(e,t,i):s.Slerp?s.Slerp(e,t,i):e.toFixed?e*(1-i)+i*t:t}static Parse(e){const t=new ae(e.name,e.property,e.framePerSecond,e.dataType,e.loopBehavior),i=e.dataType,s=[];let r,n;for(e.enableBlending&&(t.enableBlending=e.enableBlending),e.blendingSpeed&&(t.blendingSpeed=e.blendingSpeed),n=0;n<e.keys.length;n++){const o=e.keys[n];let l,h,c;switch(i){case ae.ANIMATIONTYPE_FLOAT:r=o.values[0],o.values.length>=2&&(l=o.values[1]),o.values.length>=3&&(h=o.values[2]),o.values.length>=4&&(c=o.values[3]);break;case ae.ANIMATIONTYPE_QUATERNION:if(r=Q.FromArray(o.values),o.values.length>=8){const d=Q.FromArray(o.values.slice(4,8));d.equals(Q.Zero())||(l=d)}if(o.values.length>=12){const d=Q.FromArray(o.values.slice(8,12));d.equals(Q.Zero())||(h=d)}o.values.length>=13&&(c=o.values[12]);break;case ae.ANIMATIONTYPE_MATRIX:r=L.FromArray(o.values),o.values.length>=17&&(c=o.values[16]);break;case ae.ANIMATIONTYPE_COLOR3:r=re.FromArray(o.values),o.values[3]&&(l=re.FromArray(o.values[3])),o.values[4]&&(h=re.FromArray(o.values[4])),o.values[5]&&(c=o.values[5]);break;case ae.ANIMATIONTYPE_COLOR4:r=J.FromArray(o.values),o.values[4]&&(l=J.FromArray(o.values[4])),o.values[5]&&(h=J.FromArray(o.values[5])),o.values[6]&&(c=J.FromArray(o.values[6]));break;case ae.ANIMATIONTYPE_VECTOR3:default:r=g.FromArray(o.values),o.values[3]&&(l=g.FromArray(o.values[3])),o.values[4]&&(h=g.FromArray(o.values[4])),o.values[5]&&(c=o.values[5]);break}const u={};u.frame=o.frame,u.value=r,l!=null&&(u.inTangent=l),h!=null&&(u.outTangent=h),c!=null&&(u.interpolation=c),s.push(u)}if(t.setKeys(s),e.ranges)for(n=0;n<e.ranges.length;n++)r=e.ranges[n],t.createRange(r.name,r.from,r.to);return t}static AppendSerializedAnimations(e,t){xe.AppendSerializedAnimations(e,t)}static ParseFromFileAsync(e,t){return new Promise((i,s)=>{const r=new Ui;r.addEventListener("readystatechange",()=>{if(r.readyState==4)if(r.status==200){let n=JSON.parse(r.responseText);if(n.animations&&(n=n.animations),n.length){const o=new Array;for(const l of n)o.push(this.Parse(l));i(o)}else{const o=this.Parse(n);e&&(o.name=e),i(o)}}else s("Unable to load the animation")}),r.open("GET",t),r.send()})}static ParseFromSnippetAsync(e){return new Promise((t,i)=>{const s=new Ui;s.addEventListener("readystatechange",()=>{if(s.readyState==4)if(s.status==200){const r=JSON.parse(JSON.parse(s.responseText).jsonPayload);if(r.animations){const n=JSON.parse(r.animations),o=new Array;for(const l of n.animations){const h=this.Parse(l);h.snippetId=e,o.push(h)}t(o)}else{const n=JSON.parse(r.animation),o=this.Parse(n);o.snippetId=e,t(o)}}else i("Unable to load the snippet "+e)}),s.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),s.send()})}}ae._UniqueIdGenerator=0;ae.AllowMatricesInterpolation=!1;ae.AllowMatrixDecomposeForInterpolation=!0;ae.SnippetUrl="https://snippet.babylonjs.com";ae.ANIMATIONTYPE_FLOAT=0;ae.ANIMATIONTYPE_VECTOR3=1;ae.ANIMATIONTYPE_QUATERNION=2;ae.ANIMATIONTYPE_MATRIX=3;ae.ANIMATIONTYPE_COLOR3=4;ae.ANIMATIONTYPE_COLOR4=7;ae.ANIMATIONTYPE_VECTOR2=5;ae.ANIMATIONTYPE_SIZE=6;ae.ANIMATIONLOOPMODE_RELATIVE=0;ae.ANIMATIONLOOPMODE_CYCLE=1;ae.ANIMATIONLOOPMODE_CONSTANT=2;ae.CreateFromSnippetAsync=ae.ParseFromSnippetAsync;he("BABYLON.Animation",ae);lt._AnimationRangeFactory=(a,e,t)=>new Ao(a,e,t);class Ia{constructor(){this.transitionDuration=450,this.lowerRadiusTransitionRange=2,this.upperRadiusTransitionRange=-2,this._autoTransitionRange=!1,this._radiusIsAnimating=!1,this._radiusBounceTransition=null,this._animatables=new Array}get name(){return"Bouncing"}get autoTransitionRange(){return this._autoTransitionRange}set autoTransitionRange(e){if(this._autoTransitionRange===e)return;this._autoTransitionRange=e;const t=this._attachedCamera;!t||(e?this._onMeshTargetChangedObserver=t.onMeshTargetChangedObservable.add(i=>{if(!i)return;i.computeWorldMatrix(!0);const s=i.getBoundingInfo().diagonalLength;this.lowerRadiusTransitionRange=s*.05,this.upperRadiusTransitionRange=s*.05}):this._onMeshTargetChangedObserver&&t.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver))}init(){}attach(e){this._attachedCamera=e,this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{!this._attachedCamera||(this._isRadiusAtLimit(this._attachedCamera.lowerRadiusLimit)&&this._applyBoundRadiusAnimation(this.lowerRadiusTransitionRange),this._isRadiusAtLimit(this._attachedCamera.upperRadiusLimit)&&this._applyBoundRadiusAnimation(this.upperRadiusTransitionRange))})}detach(){!this._attachedCamera||(this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null)}_isRadiusAtLimit(e){return this._attachedCamera?this._attachedCamera.radius===e&&!this._radiusIsAnimating:!1}_applyBoundRadiusAnimation(e){if(!this._attachedCamera)return;this._radiusBounceTransition||(Ia.EasingFunction.setEasingMode(Ia.EasingMode),this._radiusBounceTransition=ae.CreateAnimation("radius",ae.ANIMATIONTYPE_FLOAT,60,Ia.EasingFunction)),this._cachedWheelPrecision=this._attachedCamera.wheelPrecision,this._attachedCamera.wheelPrecision=1/0,this._attachedCamera.inertialRadiusOffset=0,this.stopAllAnimations(),this._radiusIsAnimating=!0;const t=ae.TransitionTo("radius",this._attachedCamera.radius+e,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusBounceTransition,this.transitionDuration,()=>this._clearAnimationLocks());t&&this._animatables.push(t)}_clearAnimationLocks(){this._radiusIsAnimating=!1,this._attachedCamera&&(this._attachedCamera.wheelPrecision=this._cachedWheelPrecision)}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0].onAnimationEnd=null,this._animatables[0].stop(),this._animatables.shift()}}Ia.EasingFunction=new a1(.3);Ia.EasingMode=cs.EASINGMODE_EASEOUT;class Ms{constructor(){this.onTargetFramingAnimationEndObservable=new X,this._mode=Ms.FitFrustumSidesMode,this._radiusScale=1,this._positionScale=.5,this._defaultElevation=.3,this._elevationReturnTime=1500,this._elevationReturnWaitTime=1e3,this._zoomStopsAnimation=!1,this._framingTime=1500,this.autoCorrectCameraLimitsAndSensibility=!0,this._isPointerDown=!1,this._lastInteractionTime=-1/0,this._animatables=new Array,this._betaIsAnimating=!1}get name(){return"Framing"}set mode(e){this._mode=e}get mode(){return this._mode}set radiusScale(e){this._radiusScale=e}get radiusScale(){return this._radiusScale}set positionScale(e){this._positionScale=e}get positionScale(){return this._positionScale}set defaultElevation(e){this._defaultElevation=e}get defaultElevation(){return this._defaultElevation}set elevationReturnTime(e){this._elevationReturnTime=e}get elevationReturnTime(){return this._elevationReturnTime}set elevationReturnWaitTime(e){this._elevationReturnWaitTime=e}get elevationReturnWaitTime(){return this._elevationReturnWaitTime}set zoomStopsAnimation(e){this._zoomStopsAnimation=e}get zoomStopsAnimation(){return this._zoomStopsAnimation}set framingTime(e){this._framingTime=e}get framingTime(){return this._framingTime}init(){}attach(e){this._attachedCamera=e;const t=this._attachedCamera.getScene();Ms.EasingFunction.setEasingMode(Ms.EasingMode),this._onPrePointerObservableObserver=t.onPrePointerObservable.add(i=>{if(i.type===Ce.POINTERDOWN){this._isPointerDown=!0;return}i.type===Ce.POINTERUP&&(this._isPointerDown=!1)}),this._onMeshTargetChangedObserver=e.onMeshTargetChangedObservable.add(i=>{i&&this.zoomOnMesh(i,void 0,()=>{this.onTargetFramingAnimationEndObservable.notifyObservers()})}),this._onAfterCheckInputsObserver=e.onAfterCheckInputsObservable.add(()=>{this._applyUserInteraction(),this._maintainCameraAboveGround()})}detach(){if(!this._attachedCamera)return;const e=this._attachedCamera.getScene();this._onPrePointerObservableObserver&&e.onPrePointerObservable.remove(this._onPrePointerObservableObserver),this._onAfterCheckInputsObserver&&this._attachedCamera.onAfterCheckInputsObservable.remove(this._onAfterCheckInputsObserver),this._onMeshTargetChangedObserver&&this._attachedCamera.onMeshTargetChangedObservable.remove(this._onMeshTargetChangedObserver),this._attachedCamera=null}zoomOnMesh(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getBoundingInfo().boundingBox;this.zoomOnBoundingInfo(s.minimumWorld,s.maximumWorld,t,i)}zoomOnMeshHierarchy(e,t=!1,i=null){e.computeWorldMatrix(!0);const s=e.getHierarchyBoundingVectors(!0);this.zoomOnBoundingInfo(s.min,s.max,t,i)}zoomOnMeshesHierarchy(e,t=!1,i=null){const s=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),r=new g(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(let n=0;n<e.length;n++){const o=e[n].getHierarchyBoundingVectors(!0);g.CheckExtends(o.min,s,r),g.CheckExtends(o.max,s,r)}this.zoomOnBoundingInfo(s,r,t,i)}zoomOnBoundingInfo(e,t,i=!1,s=null){let r;if(!this._attachedCamera)return;const n=e.y,o=t.y,l=n+(o-n)*this._positionScale,h=t.subtract(e).scale(.5);if(i)r=new g(0,l,0);else{const d=e.add(h);r=new g(d.x,l,d.z)}this._vectorTransition||(this._vectorTransition=ae.CreateAnimation("target",ae.ANIMATIONTYPE_VECTOR3,60,Ms.EasingFunction)),this._betaIsAnimating=!0;let c=ae.TransitionTo("target",r,this._attachedCamera,this._attachedCamera.getScene(),60,this._vectorTransition,this._framingTime);c&&this._animatables.push(c);let u=0;if(this._mode===Ms.FitFrustumSidesMode){const d=this._calculateLowerRadiusFromModelBoundingSphere(e,t);this.autoCorrectCameraLimitsAndSensibility&&(this._attachedCamera.lowerRadiusLimit=h.length()+this._attachedCamera.minZ),u=d}else this._mode===Ms.IgnoreBoundsSizeMode&&(u=this._calculateLowerRadiusFromModelBoundingSphere(e,t),this.autoCorrectCameraLimitsAndSensibility&&this._attachedCamera.lowerRadiusLimit===null&&(this._attachedCamera.lowerRadiusLimit=this._attachedCamera.minZ));if(this.autoCorrectCameraLimitsAndSensibility){const d=t.subtract(e).length();this._attachedCamera.panningSensibility=5e3/d,this._attachedCamera.wheelPrecision=100/u}this._radiusTransition||(this._radiusTransition=ae.CreateAnimation("radius",ae.ANIMATIONTYPE_FLOAT,60,Ms.EasingFunction)),c=ae.TransitionTo("radius",u,this._attachedCamera,this._attachedCamera.getScene(),60,this._radiusTransition,this._framingTime,()=>{this.stopAllAnimations(),s&&s(),this._attachedCamera&&this._attachedCamera.useInputToRestoreState&&this._attachedCamera.storeState()}),c&&this._animatables.push(c)}_calculateLowerRadiusFromModelBoundingSphere(e,t){const s=t.subtract(e).length(),r=this._getFrustumSlope(),o=s*.5*this._radiusScale,l=o*Math.sqrt(1+1/(r.x*r.x)),h=o*Math.sqrt(1+1/(r.y*r.y));let c=Math.max(l,h);const u=this._attachedCamera;return u?(u.lowerRadiusLimit&&this._mode===Ms.IgnoreBoundsSizeMode&&(c=c<u.lowerRadiusLimit?u.lowerRadiusLimit:c),u.upperRadiusLimit&&(c=c>u.upperRadiusLimit?u.upperRadiusLimit:c),c):0}_maintainCameraAboveGround(){if(this._elevationReturnTime<0)return;const e=ps.Now-this._lastInteractionTime,t=Math.PI*.5-this._defaultElevation,i=Math.PI*.5;if(this._attachedCamera&&!this._betaIsAnimating&&this._attachedCamera.beta>i&&e>=this._elevationReturnWaitTime){this._betaIsAnimating=!0,this.stopAllAnimations(),this._betaTransition||(this._betaTransition=ae.CreateAnimation("beta",ae.ANIMATIONTYPE_FLOAT,60,Ms.EasingFunction));const s=ae.TransitionTo("beta",t,this._attachedCamera,this._attachedCamera.getScene(),60,this._betaTransition,this._elevationReturnTime,()=>{this._clearAnimationLocks(),this.stopAllAnimations()});s&&this._animatables.push(s)}}_getFrustumSlope(){const e=this._attachedCamera;if(!e)return le.Zero();const i=e.getScene().getEngine().getAspectRatio(e),s=Math.tan(e.fov/2),r=s*i;return new le(r,s)}_clearAnimationLocks(){this._betaIsAnimating=!1}_applyUserInteraction(){this.isUserIsMoving&&(this._lastInteractionTime=ps.Now,this.stopAllAnimations(),this._clearAnimationLocks())}stopAllAnimations(){for(this._attachedCamera&&(this._attachedCamera.animations=[]);this._animatables.length;)this._animatables[0]&&(this._animatables[0].onAnimationEnd=null,this._animatables[0].stop()),this._animatables.shift()}get isUserIsMoving(){return this._attachedCamera?this._attachedCamera.inertialAlphaOffset!==0||this._attachedCamera.inertialBetaOffset!==0||this._attachedCamera.inertialRadiusOffset!==0||this._attachedCamera.inertialPanningX!==0||this._attachedCamera.inertialPanningY!==0||this._isPointerDown:!1}}Ms.EasingFunction=new o1;Ms.EasingMode=cs.EASINGMODE_EASEINOUT;Ms.IgnoreBoundsSizeMode=0;Ms.FitFrustumSidesMode=1;class ai extends be{constructor(e,t,i,s=!0){super(e,t,i,s),this._tmpUpVector=g.Zero(),this._tmpTargetVector=g.Zero(),this.cameraDirection=new g(0,0,0),this.cameraRotation=new le(0,0),this.ignoreParentScaling=!1,this.updateUpVectorFromRotation=!1,this._tmpQuaternion=new Q,this.rotation=new g(0,0,0),this.speed=2,this.noRotationConstraint=!1,this.invertRotation=!1,this.inverseRotationSpeed=.2,this.lockedTarget=null,this._currentTarget=g.Zero(),this._initialFocalDistance=1,this._viewMatrix=L.Zero(),this._camMatrix=L.Zero(),this._cameraTransformMatrix=L.Zero(),this._cameraRotationMatrix=L.Zero(),this._referencePoint=new g(0,0,1),this._transformedReferencePoint=g.Zero(),this._defaultUp=g.Up(),this._cachedRotationZ=0,this._cachedQuaternionRotationZ=0}getFrontPosition(e){this.getWorldMatrix();const t=this.getTarget().subtract(this.position);return t.normalize(),t.scaleInPlace(e),this.globalPosition.add(t)}_getLockedTargetPosition(){return this.lockedTarget?(this.lockedTarget.absolutePosition&&this.lockedTarget.computeWorldMatrix(),this.lockedTarget.absolutePosition||this.lockedTarget):null}storeState(){return this._storedPosition=this.position.clone(),this._storedRotation=this.rotation.clone(),this.rotationQuaternion&&(this._storedRotationQuaternion=this.rotationQuaternion.clone()),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.position=this._storedPosition.clone(),this.rotation=this._storedRotation.clone(),this.rotationQuaternion&&(this.rotationQuaternion=this._storedRotationQuaternion.clone()),this.cameraDirection.copyFromFloats(0,0,0),this.cameraRotation.copyFromFloats(0,0),!0):!1}_initCache(){super._initCache(),this._cache.lockedTarget=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotation=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.rotationQuaternion=new Q(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)}_updateCache(e){e||super._updateCache();const t=this._getLockedTargetPosition();t?this._cache.lockedTarget?this._cache.lockedTarget.copyFrom(t):this._cache.lockedTarget=t.clone():this._cache.lockedTarget=null,this._cache.rotation.copyFrom(this.rotation),this.rotationQuaternion&&this._cache.rotationQuaternion.copyFrom(this.rotationQuaternion)}_isSynchronizedViewMatrix(){if(!super._isSynchronizedViewMatrix())return!1;const e=this._getLockedTargetPosition();return(this._cache.lockedTarget?this._cache.lockedTarget.equals(e):!e)&&(this.rotationQuaternion?this.rotationQuaternion.equals(this._cache.rotationQuaternion):this._cache.rotation.equals(this.rotation))}_computeLocalCameraSpeed(){const e=this.getEngine();return this.speed*Math.sqrt(e.getDeltaTime()/(e.getFps()*100))}setTarget(e){this.upVector.normalize(),this._initialFocalDistance=e.subtract(this.position).length(),this.position.z===e.z&&(this.position.z+=tt),this._referencePoint.normalize().scaleInPlace(this._initialFocalDistance),L.LookAtLHToRef(this.position,e,this._defaultUp,this._camMatrix),this._camMatrix.invert(),this.rotation.x=Math.atan(this._camMatrix.m[6]/this._camMatrix.m[10]);const t=e.subtract(this.position);t.x>=0?this.rotation.y=-Math.atan(t.z/t.x)+Math.PI/2:this.rotation.y=-Math.atan(t.z/t.x)-Math.PI/2,this.rotation.z=0,isNaN(this.rotation.x)&&(this.rotation.x=0),isNaN(this.rotation.y)&&(this.rotation.y=0),isNaN(this.rotation.z)&&(this.rotation.z=0),this.rotationQuaternion&&Q.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)}get target(){return this.getTarget()}set target(e){this.setTarget(e)}getTarget(){return this._currentTarget}_decideIfNeedsToMove(){return Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){if(this.parent){this.parent.getWorldMatrix().invertToRef(G.Matrix[0]),g.TransformNormalToRef(this.cameraDirection,G.Matrix[0],G.Vector3[0]),this.position.addInPlace(G.Vector3[0]);return}this.position.addInPlace(this.cameraDirection)}_checkInputs(){const e=this.invertRotation?-this.inverseRotationSpeed:1,t=this._decideIfNeedsToMove(),i=Math.abs(this.cameraRotation.x)>0||Math.abs(this.cameraRotation.y)>0;t&&this._updatePosition(),i&&(this.rotationQuaternion&&this.rotationQuaternion.toEulerAnglesToRef(this.rotation),this.rotation.x+=this.cameraRotation.x*e,this.rotation.y+=this.cameraRotation.y*e,this.noRotationConstraint||(this.rotation.x>1.570796&&(this.rotation.x=1.570796),this.rotation.x<-1.570796&&(this.rotation.x=-1.570796)),this.rotationQuaternion&&this.rotation.lengthSquared()&&Q.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this.rotationQuaternion)),t&&(Math.abs(this.cameraDirection.x)<this.speed*tt&&(this.cameraDirection.x=0),Math.abs(this.cameraDirection.y)<this.speed*tt&&(this.cameraDirection.y=0),Math.abs(this.cameraDirection.z)<this.speed*tt&&(this.cameraDirection.z=0),this.cameraDirection.scaleInPlace(this.inertia)),i&&(Math.abs(this.cameraRotation.x)<this.speed*tt&&(this.cameraRotation.x=0),Math.abs(this.cameraRotation.y)<this.speed*tt&&(this.cameraRotation.y=0),this.cameraRotation.scaleInPlace(this.inertia)),super._checkInputs()}_updateCameraRotationMatrix(){this.rotationQuaternion?this.rotationQuaternion.toRotationMatrix(this._cameraRotationMatrix):L.RotationYawPitchRollToRef(this.rotation.y,this.rotation.x,this.rotation.z,this._cameraRotationMatrix)}_rotateUpVectorWithCameraRotationMatrix(){return g.TransformNormalToRef(this._defaultUp,this._cameraRotationMatrix,this.upVector),this}_getViewMatrix(){return this.lockedTarget&&this.setTarget(this._getLockedTargetPosition()),this._updateCameraRotationMatrix(),this.rotationQuaternion&&this._cachedQuaternionRotationZ!=this.rotationQuaternion.z?(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedQuaternionRotationZ=this.rotationQuaternion.z):this._cachedRotationZ!==this.rotation.z&&(this._rotateUpVectorWithCameraRotationMatrix(),this._cachedRotationZ=this.rotation.z),g.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),this.updateUpVectorFromRotation&&(this.rotationQuaternion?ti.Y.rotateByQuaternionToRef(this.rotationQuaternion,this.upVector):(Q.FromEulerVectorToRef(this.rotation,this._tmpQuaternion),ti.Y.rotateByQuaternionToRef(this._tmpQuaternion,this.upVector))),this._computeViewMatrix(this.position,this._currentTarget,this.upVector),this._viewMatrix}_computeViewMatrix(e,t,i){if(this.ignoreParentScaling){if(this.parent){const s=this.parent.getWorldMatrix();g.TransformCoordinatesToRef(e,s,this._globalPosition),g.TransformCoordinatesToRef(t,s,this._tmpTargetVector),g.TransformNormalToRef(i,s,this._tmpUpVector),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e),this._tmpTargetVector.copyFrom(t),this._tmpUpVector.copyFrom(i);this.getScene().useRightHandedSystem?L.LookAtRHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix):L.LookAtLHToRef(this._globalPosition,this._tmpTargetVector,this._tmpUpVector,this._viewMatrix);return}if(this.getScene().useRightHandedSystem?L.LookAtRHToRef(e,t,i,this._viewMatrix):L.LookAtLHToRef(e,t,i,this._viewMatrix),this.parent){const s=this.parent.getWorldMatrix();this._viewMatrix.invert(),this._viewMatrix.multiplyToRef(s,this._viewMatrix),this._viewMatrix.getTranslationToRef(this._globalPosition),this._viewMatrix.invert(),this._markSyncedWithParent()}else this._globalPosition.copyFrom(e)}createRigCamera(e,t){if(this.cameraRigMode!==be.RIG_MODE_NONE){const i=new ai(e,this.position.clone(),this.getScene());return i.isRigCamera=!0,i.rigParent=this,(this.cameraRigMode===be.RIG_MODE_VR||this.cameraRigMode===be.RIG_MODE_WEBVR)&&(this.rotationQuaternion||(this.rotationQuaternion=new Q),i._cameraRigParams={},i.rotationQuaternion=new Q),i.mode=this.mode,i.orthoLeft=this.orthoLeft,i.orthoRight=this.orthoRight,i.orthoTop=this.orthoTop,i.orthoBottom=this.orthoBottom,i}return null}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(this.computeWorldMatrix(),this.cameraRigMode){case be.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:case be.RIG_MODE_STEREOSCOPIC_OVERUNDER:case be.RIG_MODE_STEREOSCOPIC_INTERLACED:{const i=this.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?1:-1,s=this.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED?-1:1;this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*i,e),this._getRigCamPositionAndTarget(this._cameraRigParams.stereoHalfAngle*s,t);break}case be.RIG_MODE_VR:e.rotationQuaternion?(e.rotationQuaternion.copyFrom(this.rotationQuaternion),t.rotationQuaternion.copyFrom(this.rotationQuaternion)):(e.rotation.copyFrom(this.rotation),t.rotation.copyFrom(this.rotation)),e.position.copyFrom(this.position),t.position.copyFrom(this.position);break}super._updateRigCameras()}_getRigCamPositionAndTarget(e,t){this.getTarget().subtractToRef(this.position,ai._TargetFocalPoint),ai._TargetFocalPoint.normalize().scaleInPlace(this._initialFocalDistance);const s=ai._TargetFocalPoint.addInPlace(this.position);L.TranslationToRef(-s.x,-s.y,-s.z,ai._TargetTransformMatrix),ai._TargetTransformMatrix.multiplyToRef(L.RotationAxis(t.upVector,e),ai._RigCamTransformMatrix),L.TranslationToRef(s.x,s.y,s.z,ai._TargetTransformMatrix),ai._RigCamTransformMatrix.multiplyToRef(ai._TargetTransformMatrix,ai._RigCamTransformMatrix),g.TransformCoordinatesToRef(this.position,ai._RigCamTransformMatrix,t.position),t.setTarget(s)}getClassName(){return"TargetCamera"}}ai._RigCamTransformMatrix=new L;ai._TargetTransformMatrix=new L;ai._TargetFocalPoint=new g;T([Zi()],ai.prototype,"rotation",void 0);T([R()],ai.prototype,"speed",void 0);T([Xl("lockedTargetId")],ai.prototype,"lockedTarget",void 0);var Qi={};class bc{constructor(e){this.attachedToElement=!1,this.attached={},this.camera=e,this.checkInputs=()=>{}}add(e){const t=e.getSimpleName();if(this.attached[t]){B.Warn("camera input of type "+t+" already exists on camera");return}this.attached[t]=e,e.camera=this.camera,e.checkInputs&&(this.checkInputs=this._addCheckInputs(e.checkInputs.bind(e))),this.attachedToElement&&e.attachControl(this.noPreventDefault)}remove(e){for(const t in this.attached){const i=this.attached[t];i===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}removeByType(e){for(const t in this.attached){const i=this.attached[t];i.getClassName()===e&&(i.detachControl(),i.camera=null,delete this.attached[t],this.rebuildInputCheck())}}_addCheckInputs(e){const t=this.checkInputs;return()=>{t(),e()}}attachInput(e){this.attachedToElement&&e.attachControl(this.noPreventDefault)}attachElement(e=!1){if(!this.attachedToElement){e=be.ForceAttachControlToAlwaysPreventDefault?!1:e,this.attachedToElement=!0,this.noPreventDefault=e;for(const t in this.attached)this.attached[t].attachControl(e)}}detachElement(e=!1){for(const t in this.attached)this.attached[t].detachControl(),e&&(this.attached[t].camera=null);this.attachedToElement=!1}rebuildInputCheck(){this.checkInputs=()=>{};for(const e in this.attached){const t=this.attached[e];t.checkInputs&&(this.checkInputs=this._addCheckInputs(t.checkInputs.bind(t)))}}clear(){this.attachedToElement&&this.detachElement(!0),this.attached={},this.attachedToElement=!1,this.checkInputs=()=>{}}serialize(e){const t={};for(const i in this.attached){const s=this.attached[i],r=xe.Serialize(s);t[s.getClassName()]=r}e.inputsmgr=t}parse(e){const t=e.inputsmgr;if(t){this.clear();for(const i in t){const s=Qi[i];if(s){const r=t[i],n=xe.Parse(()=>new s,r,null);this.add(n)}}}else for(const i in this.attached){const s=Qi[this.attached[i].getClassName()];if(s){const r=xe.Parse(()=>new s,e,null);this.remove(this.attached[i]),this.add(r)}}}}class Gd{constructor(){this._currentActiveButton=-1,this.buttons=[0,1,2]}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();let s=0,r=null;this._pointA=null,this._pointB=null,this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._pointerInput=o=>{const l=o.event,h=l.pointerType==="touch";if(t.isInVRExclusivePointerMode||o.type!==Ce.POINTERMOVE&&this.buttons.indexOf(l.button)===-1)return;const c=l.target;if(this._altKey=l.altKey,this._ctrlKey=l.ctrlKey,this._metaKey=l.metaKey,this._shiftKey=l.shiftKey,this._buttonsPressed=l.buttons,t.isPointerLock){const u=l.movementX,d=l.movementY;this.onTouch(null,u,d),this._pointA=null,this._pointB=null}else if(o.type===Ce.POINTERDOWN&&(this._currentActiveButton===-1||h)){try{c==null||c.setPointerCapture(l.pointerId)}catch{}this._pointA===null?this._pointA={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType}:this._pointB===null&&(this._pointB={x:l.clientX,y:l.clientY,pointerId:l.pointerId,type:l.pointerType}),this._currentActiveButton===-1&&!h&&(this._currentActiveButton=l.button),this.onButtonDown(l),e||(l.preventDefault(),i&&i.focus())}else if(o.type===Ce.POINTERDOUBLETAP)this.onDoubleTap(l.pointerType);else if(o.type===Ce.POINTERUP&&(this._currentActiveButton===l.button||h)){try{c==null||c.releasePointerCapture(l.pointerId)}catch{}h||(this._pointB=null),t._badOS?this._pointA=this._pointB=null:this._pointB&&this._pointA&&this._pointA.pointerId==l.pointerId?(this._pointA=this._pointB,this._pointB=null):this._pointA&&this._pointB&&this._pointB.pointerId==l.pointerId?this._pointB=null:this._pointA=this._pointB=null,(s!==0||r)&&(this.onMultiTouch(this._pointA,this._pointB,s,0,r,null),s=0,r=null),this._currentActiveButton=-1,this.onButtonUp(l),e||l.preventDefault()}else if(o.type===Ce.POINTERMOVE){if(e||l.preventDefault(),this._pointA&&this._pointB===null){const u=l.clientX-this._pointA.x,d=l.clientY-this._pointA.y;this.onTouch(this._pointA,u,d),this._pointA.x=l.clientX,this._pointA.y=l.clientY}else if(this._pointA&&this._pointB){const u=this._pointA.pointerId===l.pointerId?this._pointA:this._pointB;u.x=l.clientX,u.y=l.clientY;const d=this._pointA.x-this._pointB.x,f=this._pointA.y-this._pointB.y,p=d*d+f*f,_={x:(this._pointA.x+this._pointB.x)/2,y:(this._pointA.y+this._pointB.y)/2,pointerId:l.pointerId,type:o.type};this.onMultiTouch(this._pointA,this._pointB,s,p,r,_),r=_,s=p}}},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE|Ce.POINTERDOUBLETAP),this._onLostFocus=()=>{this._pointA=this._pointB=null,s=0,r=null,this.onLostFocus()},this._contextMenuBind=this.onContextMenu.bind(this),i&&i.addEventListener("contextmenu",this._contextMenuBind,!1);const n=this.camera.getScene().getEngine().getHostWindow();n&&q.RegisterTopRootEvents(n,[{name:"blur",handler:this._onLostFocus}])}detachControl(){if(this._onLostFocus){const e=this.camera.getScene().getEngine().getHostWindow();e&&q.UnregisterTopRootEvents(e,[{name:"blur",handler:this._onLostFocus}])}if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._contextMenuBind){const e=this.camera.getScene().getEngine().getInputElement();e&&e.removeEventListener("contextmenu",this._contextMenuBind)}this._onLostFocus=null}this._altKey=!1,this._ctrlKey=!1,this._metaKey=!1,this._shiftKey=!1,this._buttonsPressed=0,this._currentActiveButton=-1}getClassName(){return"BaseCameraPointersInput"}getSimpleName(){return"pointers"}onDoubleTap(e){}onTouch(e,t,i){}onMultiTouch(e,t,i,s,r,n){}onContextMenu(e){e.preventDefault()}onButtonDown(e){}onButtonUp(e){}onLostFocus(){}}T([R()],Gd.prototype,"buttons",void 0);class Ns extends Gd{constructor(){super(...arguments),this.buttons=[0,1,2],this.angularSensibilityX=1e3,this.angularSensibilityY=1e3,this.pinchPrecision=12,this.pinchDeltaPercentage=0,this.useNaturalPinchZoom=!1,this.pinchZoom=!0,this.panningSensibility=1e3,this.multiTouchPanning=!0,this.multiTouchPanAndZoom=!0,this.pinchInwards=!0,this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}getClassName(){return"ArcRotateCameraPointersInput"}_computeMultiTouchPanning(e,t){if(this.panningSensibility!==0&&e&&t){const i=t.x-e.x,s=t.y-e.y;this.camera.inertialPanningX+=-i/this.panningSensibility,this.camera.inertialPanningY+=s/this.panningSensibility}}_computePinchZoom(e,t){const i=this.camera.radius||Ns.MinimumRadiusForPinch;this.useNaturalPinchZoom?this.camera.radius=i*Math.sqrt(e)/Math.sqrt(t):this.pinchDeltaPercentage?this.camera.inertialRadiusOffset+=(t-e)*.001*i*this.pinchDeltaPercentage:this.camera.inertialRadiusOffset+=(t-e)/(this.pinchPrecision*(this.pinchInwards?1:-1)*(this.angularSensibilityX+this.angularSensibilityY)/2)}onTouch(e,t,i){this.panningSensibility!==0&&(this._ctrlKey&&this.camera._useCtrlForPanning||this._isPanClick)?(this.camera.inertialPanningX+=-t/this.panningSensibility,this.camera.inertialPanningY+=i/this.panningSensibility):(this.camera.inertialAlphaOffset-=t/this.angularSensibilityX,this.camera.inertialBetaOffset-=i/this.angularSensibilityY)}onDoubleTap(){this.camera.useInputToRestoreState&&this.camera.restoreState()}onMultiTouch(e,t,i,s,r,n){i===0&&r===null||s===0&&n===null||(this.multiTouchPanAndZoom?(this._computePinchZoom(i,s),this._computeMultiTouchPanning(r,n)):this.multiTouchPanning&&this.pinchZoom?(this._twoFingerActivityCount++,this._isPinching||this._twoFingerActivityCount<20&&Math.abs(Math.sqrt(s)-Math.sqrt(i))>this.camera.pinchToPanMaxDistance?(this._computePinchZoom(i,s),this._isPinching=!0):this._computeMultiTouchPanning(r,n)):this.multiTouchPanning?this._computeMultiTouchPanning(r,n):this.pinchZoom&&this._computePinchZoom(i,s))}onButtonDown(e){this._isPanClick=e.button===this.camera._panningMouseButton}onButtonUp(){this._twoFingerActivityCount=0,this._isPinching=!1}onLostFocus(){this._isPanClick=!1,this._twoFingerActivityCount=0,this._isPinching=!1}}Ns.MinimumRadiusForPinch=.001;T([R()],Ns.prototype,"buttons",void 0);T([R()],Ns.prototype,"angularSensibilityX",void 0);T([R()],Ns.prototype,"angularSensibilityY",void 0);T([R()],Ns.prototype,"pinchPrecision",void 0);T([R()],Ns.prototype,"pinchDeltaPercentage",void 0);T([R()],Ns.prototype,"useNaturalPinchZoom",void 0);T([R()],Ns.prototype,"pinchZoom",void 0);T([R()],Ns.prototype,"panningSensibility",void 0);T([R()],Ns.prototype,"multiTouchPanning",void 0);T([R()],Ns.prototype,"multiTouchPanAndZoom",void 0);Qi.ArcRotateCameraPointersInput=Ns;class wr{constructor(){this.keysUp=[38],this.keysDown=[40],this.keysLeft=[37],this.keysRight=[39],this.keysReset=[220],this.panningSensibility=50,this.zoomingSensibility=25,this.useAltToZoom=!0,this.angularSpeed=.01,this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Zn.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysReset.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t];this.keysLeft.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX-=1/this.panningSensibility:e.inertialAlphaOffset-=this.angularSpeed:this.keysUp.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY+=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset+=1/this.zoomingSensibility:e.inertialBetaOffset-=this.angularSpeed:this.keysRight.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningX+=1/this.panningSensibility:e.inertialAlphaOffset+=this.angularSpeed:this.keysDown.indexOf(i)!==-1?this._ctrlPressed&&this.camera._useCtrlForPanning?e.inertialPanningY-=1/this.panningSensibility:this._altPressed&&this.useAltToZoom?e.inertialRadiusOffset-=1/this.zoomingSensibility:e.inertialBetaOffset+=this.angularSpeed:this.keysReset.indexOf(i)!==-1&&e.useInputToRestoreState&&e.restoreState()}}}getClassName(){return"ArcRotateCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}}T([R()],wr.prototype,"keysUp",void 0);T([R()],wr.prototype,"keysDown",void 0);T([R()],wr.prototype,"keysLeft",void 0);T([R()],wr.prototype,"keysRight",void 0);T([R()],wr.prototype,"keysReset",void 0);T([R()],wr.prototype,"panningSensibility",void 0);T([R()],wr.prototype,"zoomingSensibility",void 0);T([R()],wr.prototype,"useAltToZoom",void 0);T([R()],wr.prototype,"angularSpeed",void 0);Qi.ArcRotateCameraKeyboardMoveInput=wr;const h1=40;class Yl{constructor(){this.wheelPrecision=3,this.zoomToMouseLocation=!1,this.wheelDeltaPercentage=0,this.customComputeDeltaFromMouseWheel=null,this._inertialPanning=g.Zero()}_computeDeltaFromMouseWheelLegacyEvent(e,t){let i=0;const s=e*.01*this.wheelDeltaPercentage*t;return e>0?i=s/(1+this.wheelDeltaPercentage):i=s*(1+this.wheelDeltaPercentage),i}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ce.POINTERWHEEL)return;const i=t.event;let s=0;const r=i.deltaMode===ko.DOM_DELTA_LINE?h1:1,n=-(i.deltaY*r);if(this.customComputeDeltaFromMouseWheel)s=this.customComputeDeltaFromMouseWheel(n,this,i);else if(this.wheelDeltaPercentage){if(s=this._computeDeltaFromMouseWheelLegacyEvent(n,this.camera.radius),s>0){let o=this.camera.radius,l=this.camera.inertialRadiusOffset+s;for(let h=0;h<20&&Math.abs(l)>.001;h++)o-=l,l*=this.camera.inertia;o=oe.Clamp(o,0,Number.MAX_VALUE),s=this._computeDeltaFromMouseWheelLegacyEvent(n,o)}}else s=n/(this.wheelPrecision*40);s&&(this.zoomToMouseLocation&&this._hitPlane?this._zoomToMouse(s):this.camera.inertialRadiusOffset+=s),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,Ce.POINTERWHEEL),this.zoomToMouseLocation&&this._inertialPanning.setAll(0)}detachControl(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)}checkInputs(){if(!this.zoomToMouseLocation)return;const e=this.camera;0+e.inertialAlphaOffset+e.inertialBetaOffset+e.inertialRadiusOffset&&(this._updateHitPlane(),e.target.addInPlace(this._inertialPanning),this._inertialPanning.scaleInPlace(e.inertia),this._zeroIfClose(this._inertialPanning))}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}_updateHitPlane(){const e=this.camera,t=e.target.subtract(e.position);this._hitPlane=Hi.FromPositionAndNormal(e.target,t)}_getPosition(){var e;const t=this.camera,i=t.getScene(),s=i.createPickingRay(i.pointerX,i.pointerY,L.Identity(),t,!1);let r=0;return this._hitPlane&&(r=(e=s.intersectsPlane(this._hitPlane))!==null&&e!==void 0?e:0),s.origin.addInPlace(s.direction.scaleInPlace(r))}_zoomToMouse(e){var t,i;const s=this.camera,r=1-s.inertia;if(s.lowerRadiusLimit){const c=(t=s.lowerRadiusLimit)!==null&&t!==void 0?t:0;s.radius-(s.inertialRadiusOffset+e)/r<c&&(e=(s.radius-c)*r-s.inertialRadiusOffset)}if(s.upperRadiusLimit){const c=(i=s.upperRadiusLimit)!==null&&i!==void 0?i:0;s.radius-(s.inertialRadiusOffset+e)/r>c&&(e=(s.radius-c)*r-s.inertialRadiusOffset)}const o=e/r/s.radius,l=this._getPosition(),h=G.Vector3[6];l.subtractToRef(s.target,h),h.scaleInPlace(o),h.scaleInPlace(r),this._inertialPanning.addInPlace(h),s.inertialRadiusOffset+=e}_zeroIfClose(e){Math.abs(e.x)<tt&&(e.x=0),Math.abs(e.y)<tt&&(e.y=0),Math.abs(e.z)<tt&&(e.z=0)}}T([R()],Yl.prototype,"wheelPrecision",void 0);T([R()],Yl.prototype,"zoomToMouseLocation",void 0);T([R()],Yl.prototype,"wheelDeltaPercentage",void 0);Qi.ArcRotateCameraMouseWheelInput=Yl;class zd extends bc{constructor(e){super(e)}addMouseWheel(){return this.add(new Yl),this}addPointers(){return this.add(new Ns),this}addKeyboard(){return this.add(new wr),this}}lt.AddNodeConstructor("ArcRotateCamera",(a,e)=>()=>new yt(a,0,0,1,g.Zero(),e));class yt extends ai{constructor(e,t,i,s,r,n,o=!0){super(e,g.Zero(),n,o),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.lowerAlphaLimit=null,this.upperAlphaLimit=null,this.lowerBetaLimit=.01,this.upperBetaLimit=Math.PI-.01,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.inertialPanningX=0,this.inertialPanningY=0,this.pinchToPanMaxDistance=20,this.panningDistanceLimit=null,this.panningOriginTarget=g.Zero(),this.panningInertia=.9,this.zoomOnFactor=1,this.targetScreenOffset=le.Zero(),this.allowUpsideDown=!0,this.useInputToRestoreState=!0,this._viewMatrix=new L,this.panningAxis=new g(1,1,0),this._transformedDirection=new g,this.mapPanning=!1,this.onMeshTargetChangedObservable=new X,this.checkCollisions=!1,this.collisionRadius=new g(.5,.5,.5),this._previousPosition=g.Zero(),this._collisionVelocity=g.Zero(),this._newPosition=g.Zero(),this._computationVector=g.Zero(),this._onCollisionPositionChange=(l,h,c=null)=>{c?(this.setPosition(h),this.onCollide&&this.onCollide(c)):this._previousPosition.copyFrom(this._position);const u=Math.cos(this.alpha),d=Math.sin(this.alpha),f=Math.cos(this.beta);let p=Math.sin(this.beta);p===0&&(p=1e-4);const _=this._getTargetPosition();this._computationVector.copyFromFloats(this.radius*u*p,this.radius*f,this.radius*d*p),_.addToRef(this._computationVector,this._newPosition),this._position.copyFrom(this._newPosition);let m=this.upVector;this.allowUpsideDown&&this.beta<0&&(m=m.clone(),m=m.negate()),this._computeViewMatrix(this._position,_,m),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y),this._collisionTriggered=!1},this._target=g.Zero(),r&&this.setTarget(r),this.alpha=t,this.beta=i,this.radius=s,this.getViewMatrix(),this.inputs=new zd(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}get target(){return this._target}set target(e){this.setTarget(e)}get targetHost(){return this._targetHost}set targetHost(e){e&&this.setTarget(e)}getTarget(){return this.target}get position(){return this._position}set position(e){this.setPosition(e)}set upVector(e){this._upToYMatrix||(this._yToUpMatrix=new L,this._upToYMatrix=new L,this._upVector=g.Zero()),e.normalize(),this._upVector.copyFrom(e),this.setMatUp()}get upVector(){return this._upVector}setMatUp(){L.RotationAlignToRef(g.UpReadOnly,this._upVector,this._yToUpMatrix),L.RotationAlignToRef(this._upVector,g.UpReadOnly,this._upToYMatrix)}get angularSensibilityX(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityX:0}set angularSensibilityX(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityX=e)}get angularSensibilityY(){const e=this.inputs.attached.pointers;return e?e.angularSensibilityY:0}set angularSensibilityY(e){const t=this.inputs.attached.pointers;t&&(t.angularSensibilityY=e)}get pinchPrecision(){const e=this.inputs.attached.pointers;return e?e.pinchPrecision:0}set pinchPrecision(e){const t=this.inputs.attached.pointers;t&&(t.pinchPrecision=e)}get pinchDeltaPercentage(){const e=this.inputs.attached.pointers;return e?e.pinchDeltaPercentage:0}set pinchDeltaPercentage(e){const t=this.inputs.attached.pointers;t&&(t.pinchDeltaPercentage=e)}get useNaturalPinchZoom(){const e=this.inputs.attached.pointers;return e?e.useNaturalPinchZoom:!1}set useNaturalPinchZoom(e){const t=this.inputs.attached.pointers;t&&(t.useNaturalPinchZoom=e)}get panningSensibility(){const e=this.inputs.attached.pointers;return e?e.panningSensibility:0}set panningSensibility(e){const t=this.inputs.attached.pointers;t&&(t.panningSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get wheelPrecision(){const e=this.inputs.attached.mousewheel;return e?e.wheelPrecision:0}set wheelPrecision(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelPrecision=e)}get zoomToMouseLocation(){const e=this.inputs.attached.mousewheel;return e?e.zoomToMouseLocation:!1}set zoomToMouseLocation(e){const t=this.inputs.attached.mousewheel;t&&(t.zoomToMouseLocation=e)}get wheelDeltaPercentage(){const e=this.inputs.attached.mousewheel;return e?e.wheelDeltaPercentage:0}set wheelDeltaPercentage(e){const t=this.inputs.attached.mousewheel;t&&(t.wheelDeltaPercentage=e)}get bouncingBehavior(){return this._bouncingBehavior}get useBouncingBehavior(){return this._bouncingBehavior!=null}set useBouncingBehavior(e){e!==this.useBouncingBehavior&&(e?(this._bouncingBehavior=new Ia,this.addBehavior(this._bouncingBehavior)):this._bouncingBehavior&&(this.removeBehavior(this._bouncingBehavior),this._bouncingBehavior=null))}get framingBehavior(){return this._framingBehavior}get useFramingBehavior(){return this._framingBehavior!=null}set useFramingBehavior(e){e!==this.useFramingBehavior&&(e?(this._framingBehavior=new Ms,this.addBehavior(this._framingBehavior)):this._framingBehavior&&(this.removeBehavior(this._framingBehavior),this._framingBehavior=null))}get autoRotationBehavior(){return this._autoRotationBehavior}get useAutoRotationBehavior(){return this._autoRotationBehavior!=null}set useAutoRotationBehavior(e){e!==this.useAutoRotationBehavior&&(e?(this._autoRotationBehavior=new r1,this.addBehavior(this._autoRotationBehavior)):this._autoRotationBehavior&&(this.removeBehavior(this._autoRotationBehavior),this._autoRotationBehavior=null))}_initCache(){super._initCache(),this._cache._target=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cache.alpha=void 0,this._cache.beta=void 0,this._cache.radius=void 0,this._cache.targetScreenOffset=le.Zero()}_updateCache(e){e||super._updateCache(),this._cache._target.copyFrom(this._getTargetPosition()),this._cache.alpha=this.alpha,this._cache.beta=this.beta,this._cache.radius=this.radius,this._cache.targetScreenOffset.copyFrom(this.targetScreenOffset)}_getTargetPosition(){if(this._targetHost&&this._targetHost.getAbsolutePosition){const t=this._targetHost.getAbsolutePosition();this._targetBoundingCenter?t.addToRef(this._targetBoundingCenter,this._target):this._target.copyFrom(t)}const e=this._getLockedTargetPosition();return e||this._target}storeState(){return this._storedAlpha=this.alpha,this._storedBeta=this.beta,this._storedRadius=this.radius,this._storedTarget=this._getTargetPosition().clone(),this._storedTargetScreenOffset=this.targetScreenOffset.clone(),super.storeState()}_restoreStateValues(){return super._restoreStateValues()?(this.setTarget(this._storedTarget.clone()),this.alpha=this._storedAlpha,this.beta=this._storedBeta,this.radius=this._storedRadius,this.targetScreenOffset=this._storedTargetScreenOffset.clone(),this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0,!0):!1}_isSynchronizedViewMatrix(){return super._isSynchronizedViewMatrix()?this._cache._target.equals(this._getTargetPosition())&&this._cache.alpha===this.alpha&&this._cache.beta===this.beta&&this._cache.radius===this.radius&&this._cache.targetScreenOffset.equals(this.targetScreenOffset):!1}attachControl(e,t,i=!0,s=2){const r=arguments;t=q.BackCompatCameraNoPreventDefault(r),this._useCtrlForPanning=i,this._panningMouseButton=s,typeof r[0]=="boolean"&&(r.length>1&&(this._useCtrlForPanning=r[1]),r.length>2&&(this._panningMouseButton=r[2])),this.inputs.attachElement(t),this._reset=()=>{this.inertialAlphaOffset=0,this.inertialBetaOffset=0,this.inertialRadiusOffset=0,this.inertialPanningX=0,this.inertialPanningY=0}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){if(!this._collisionTriggered){if(this.inputs.checkInputs(),this.inertialAlphaOffset!==0||this.inertialBetaOffset!==0||this.inertialRadiusOffset!==0){const e=this.invertRotation?-1:1;let t=this.inertialAlphaOffset;this.beta<=0&&(t*=-1),this.getScene().useRightHandedSystem&&(t*=-1),this.parent&&this.parent._getWorldMatrixDeterminant()<0&&(t*=-1),this.alpha+=t*e,this.beta+=this.inertialBetaOffset*e,this.radius-=this.inertialRadiusOffset,this.inertialAlphaOffset*=this.inertia,this.inertialBetaOffset*=this.inertia,this.inertialRadiusOffset*=this.inertia,Math.abs(this.inertialAlphaOffset)<tt&&(this.inertialAlphaOffset=0),Math.abs(this.inertialBetaOffset)<tt&&(this.inertialBetaOffset=0),Math.abs(this.inertialRadiusOffset)<this.speed*tt&&(this.inertialRadiusOffset=0)}if(this.inertialPanningX!==0||this.inertialPanningY!==0){const e=new g(this.inertialPanningX,this.inertialPanningY,this.inertialPanningY);this._viewMatrix.invertToRef(this._cameraTransformMatrix),e.multiplyInPlace(this.panningAxis),g.TransformNormalToRef(e,this._cameraTransformMatrix,this._transformedDirection),(this.mapPanning||!this.panningAxis.y)&&(this._transformedDirection.y=0),this._targetHost||(this.panningDistanceLimit?(this._transformedDirection.addInPlace(this._target),g.DistanceSquared(this._transformedDirection,this.panningOriginTarget)<=this.panningDistanceLimit*this.panningDistanceLimit&&this._target.copyFrom(this._transformedDirection)):this._target.addInPlace(this._transformedDirection)),this.inertialPanningX*=this.panningInertia,this.inertialPanningY*=this.panningInertia,Math.abs(this.inertialPanningX)<this.speed*tt&&(this.inertialPanningX=0),Math.abs(this.inertialPanningY)<this.speed*tt&&(this.inertialPanningY=0)}this._checkLimits(),super._checkInputs()}}_checkLimits(){this.lowerBetaLimit===null||this.lowerBetaLimit===void 0?this.allowUpsideDown&&this.beta>Math.PI&&(this.beta=this.beta-2*Math.PI):this.beta<this.lowerBetaLimit&&(this.beta=this.lowerBetaLimit),this.upperBetaLimit===null||this.upperBetaLimit===void 0?this.allowUpsideDown&&this.beta<-Math.PI&&(this.beta=this.beta+2*Math.PI):this.beta>this.upperBetaLimit&&(this.beta=this.upperBetaLimit),this.lowerAlphaLimit!==null&&this.alpha<this.lowerAlphaLimit&&(this.alpha=this.lowerAlphaLimit),this.upperAlphaLimit!==null&&this.alpha>this.upperAlphaLimit&&(this.alpha=this.upperAlphaLimit),this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit,this.inertialRadiusOffset=0),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit,this.inertialRadiusOffset=0)}rebuildAnglesAndRadius(){this._position.subtractToRef(this._getTargetPosition(),this._computationVector),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&g.TransformCoordinatesToRef(this._computationVector,this._upToYMatrix,this._computationVector),this.radius=this._computationVector.length(),this.radius===0&&(this.radius=1e-4);const e=this.alpha;this._computationVector.x===0&&this._computationVector.z===0?this.alpha=Math.PI/2:this.alpha=Math.acos(this._computationVector.x/Math.sqrt(Math.pow(this._computationVector.x,2)+Math.pow(this._computationVector.z,2))),this._computationVector.z<0&&(this.alpha=2*Math.PI-this.alpha);const t=Math.round((e-this.alpha)/(2*Math.PI));this.alpha+=t*2*Math.PI,this.beta=Math.acos(this._computationVector.y/this.radius),this._checkLimits()}setPosition(e){this._position.equals(e)||(this._position.copyFrom(e),this.rebuildAnglesAndRadius())}setTarget(e,t=!1,i=!1,s=!1){var r;if(s=(r=this.overrideCloneAlphaBetaRadius)!==null&&r!==void 0?r:s,e.getBoundingInfo)t?this._targetBoundingCenter=e.getBoundingInfo().boundingBox.centerWorld.clone():this._targetBoundingCenter=null,e.computeWorldMatrix(),this._targetHost=e,this._target=this._getTargetPosition(),this.onMeshTargetChangedObservable.notifyObservers(this._targetHost);else{const n=e,o=this._getTargetPosition();if(o&&!i&&o.equals(n))return;this._targetHost=null,this._target=n,this._targetBoundingCenter=null,this.onMeshTargetChangedObservable.notifyObservers(null)}s||this.rebuildAnglesAndRadius()}_getViewMatrix(){const e=Math.cos(this.alpha),t=Math.sin(this.alpha),i=Math.cos(this.beta);let s=Math.sin(this.beta);s===0&&(s=1e-4),this.radius===0&&(this.radius=1e-4);const r=this._getTargetPosition();if(this._computationVector.copyFromFloats(this.radius*e*s,this.radius*i,this.radius*t*s),(this._upVector.x!==0||this._upVector.y!==1||this._upVector.z!==0)&&g.TransformCoordinatesToRef(this._computationVector,this._yToUpMatrix,this._computationVector),r.addToRef(this._computationVector,this._newPosition),this.getScene().collisionsEnabled&&this.checkCollisions){const n=this.getScene().collisionCoordinator;this._collider||(this._collider=n.createCollider()),this._collider._radius=this.collisionRadius,this._newPosition.subtractToRef(this._position,this._collisionVelocity),this._collisionTriggered=!0,n.getNewPosition(this._position,this._collisionVelocity,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}else{this._position.copyFrom(this._newPosition);let n=this.upVector;this.allowUpsideDown&&s<0&&(n=n.negate()),this._computeViewMatrix(this._position,r,n),this._viewMatrix.addAtIndex(12,this.targetScreenOffset.x),this._viewMatrix.addAtIndex(13,this.targetScreenOffset.y)}return this._currentTarget=r,this._viewMatrix}zoomOn(e,t=!1){e=e||this.getScene().meshes;const i=V.MinMax(e),s=g.Distance(i.min,i.max);this.radius=s*this.zoomOnFactor,this.focusOn({min:i.min,max:i.max,distance:s},t)}focusOn(e,t=!1){let i,s;if(e.min===void 0){const r=e||this.getScene().meshes;i=V.MinMax(r),s=g.Distance(i.min,i.max)}else{const r=e;i=r,s=r.distance}this._target=V.Center(i),t||(this.maxZ=s*2)}createRigCamera(e,t){let i=0;switch(this.cameraRigMode){case be.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case be.RIG_MODE_STEREOSCOPIC_OVERUNDER:case be.RIG_MODE_STEREOSCOPIC_INTERLACED:case be.RIG_MODE_VR:i=this._cameraRigParams.stereoHalfAngle*(t===0?1:-1);break;case be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:i=this._cameraRigParams.stereoHalfAngle*(t===0?-1:1);break}const s=new yt(e,this.alpha+i,this.beta,this.radius,this._target,this.getScene());return s._cameraRigParams={},s.isRigCamera=!0,s.rigParent=this,s.upVector=this.upVector,s.mode=this.mode,s.orthoLeft=this.orthoLeft,s.orthoRight=this.orthoRight,s.orthoBottom=this.orthoBottom,s.orthoTop=this.orthoTop,s}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];switch(e.beta=t.beta=this.beta,this.cameraRigMode){case be.RIG_MODE_STEREOSCOPIC_ANAGLYPH:case be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:case be.RIG_MODE_STEREOSCOPIC_OVERUNDER:case be.RIG_MODE_STEREOSCOPIC_INTERLACED:case be.RIG_MODE_VR:e.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle;break;case be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED:e.alpha=this.alpha+this._cameraRigParams.stereoHalfAngle,t.alpha=this.alpha-this._cameraRigParams.stereoHalfAngle;break}super._updateRigCameras()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"ArcRotateCamera"}}T([R()],yt.prototype,"alpha",void 0);T([R()],yt.prototype,"beta",void 0);T([R()],yt.prototype,"radius",void 0);T([R()],yt.prototype,"overrideCloneAlphaBetaRadius",void 0);T([Zi("target")],yt.prototype,"_target",void 0);T([Xl("targetHost")],yt.prototype,"_targetHost",void 0);T([R()],yt.prototype,"inertialAlphaOffset",void 0);T([R()],yt.prototype,"inertialBetaOffset",void 0);T([R()],yt.prototype,"inertialRadiusOffset",void 0);T([R()],yt.prototype,"lowerAlphaLimit",void 0);T([R()],yt.prototype,"upperAlphaLimit",void 0);T([R()],yt.prototype,"lowerBetaLimit",void 0);T([R()],yt.prototype,"upperBetaLimit",void 0);T([R()],yt.prototype,"lowerRadiusLimit",void 0);T([R()],yt.prototype,"upperRadiusLimit",void 0);T([R()],yt.prototype,"inertialPanningX",void 0);T([R()],yt.prototype,"inertialPanningY",void 0);T([R()],yt.prototype,"pinchToPanMaxDistance",void 0);T([R()],yt.prototype,"panningDistanceLimit",void 0);T([Zi()],yt.prototype,"panningOriginTarget",void 0);T([R()],yt.prototype,"panningInertia",void 0);T([R()],yt.prototype,"zoomToMouseLocation",null);T([R()],yt.prototype,"zoomOnFactor",void 0);T([Dd()],yt.prototype,"targetScreenOffset",void 0);T([R()],yt.prototype,"allowUpsideDown",void 0);T([R()],yt.prototype,"useInputToRestoreState",void 0);class je extends lt{constructor(e,t){super(e,t),this.diffuse=new re(1,1,1),this.specular=new re(1,1,1),this.falloffType=je.FALLOFF_DEFAULT,this.intensity=1,this._range=Number.MAX_VALUE,this._inverseSquaredRange=0,this._photometricScale=1,this._intensityMode=je.INTENSITYMODE_AUTOMATIC,this._radius=1e-5,this.renderPriority=0,this._shadowEnabled=!0,this._excludeWithLayerMask=0,this._includeOnlyWithLayerMask=0,this._lightmapMode=0,this._excludedMeshesIds=new Array,this._includedOnlyMeshesIds=new Array,this._isLight=!0,this.getScene().addLight(this),this._uniformBuffer=new Pe(this.getScene().getEngine(),void 0,void 0,e),this._buildUniformLayout(),this.includedOnlyMeshes=new Array,this.excludedMeshes=new Array,this._resyncMeshes()}get range(){return this._range}set range(e){this._range=e,this._inverseSquaredRange=1/(this.range*this.range)}get intensityMode(){return this._intensityMode}set intensityMode(e){this._intensityMode=e,this._computePhotometricScale()}get radius(){return this._radius}set radius(e){this._radius=e,this._computePhotometricScale()}get shadowEnabled(){return this._shadowEnabled}set shadowEnabled(e){this._shadowEnabled!==e&&(this._shadowEnabled=e,this._markMeshesAsLightDirty())}get includedOnlyMeshes(){return this._includedOnlyMeshes}set includedOnlyMeshes(e){this._includedOnlyMeshes=e,this._hookArrayForIncludedOnly(e)}get excludedMeshes(){return this._excludedMeshes}set excludedMeshes(e){this._excludedMeshes=e,this._hookArrayForExcluded(e)}get excludeWithLayerMask(){return this._excludeWithLayerMask}set excludeWithLayerMask(e){this._excludeWithLayerMask=e,this._resyncMeshes()}get includeOnlyWithLayerMask(){return this._includeOnlyWithLayerMask}set includeOnlyWithLayerMask(e){this._includeOnlyWithLayerMask=e,this._resyncMeshes()}get lightmapMode(){return this._lightmapMode}set lightmapMode(e){this._lightmapMode!==e&&(this._lightmapMode=e,this._markMeshesAsLightDirty())}transferTexturesToEffect(e,t){return this}_bindLight(e,t,i,s,r=!0){const n=e.toString();let o=!1;if(this._uniformBuffer.bindToEffect(i,"Light"+n),this._renderId!==t.getRenderId()||this._lastUseSpecular!==s||!this._uniformBuffer.useUbo){this._renderId=t.getRenderId(),this._lastUseSpecular=s;const l=this.getScaledIntensity();this.transferToEffect(i,n),this.diffuse.scaleToRef(l,ht.Color3[0]),this._uniformBuffer.updateColor4("vLightDiffuse",ht.Color3[0],this.range,n),s&&(this.specular.scaleToRef(l,ht.Color3[1]),this._uniformBuffer.updateColor4("vLightSpecular",ht.Color3[1],this.radius,n)),o=!0}if(this.transferTexturesToEffect(i,n),t.shadowsEnabled&&this.shadowEnabled&&r){const l=this.getShadowGenerator();l&&(l.bindShadowLight(n,i),o=!0)}o?this._uniformBuffer.update():this._uniformBuffer.bindUniformBuffer()}getClassName(){return"Light"}toString(e){let t="Name: "+this.name;if(t+=", type: "+["Point","Directional","Spot","Hemispheric"][this.getTypeID()],this.animations)for(let i=0;i<this.animations.length;i++)t+=", animation[0]: "+this.animations[i].toString(e);return t}_syncParentEnabledState(){super._syncParentEnabledState(),this.isDisposed()||this._resyncMeshes()}setEnabled(e){super.setEnabled(e),this._resyncMeshes()}getShadowGenerator(){return this._shadowGenerator}getAbsolutePosition(){return g.Zero()}canAffectMesh(e){return e?!(this.includedOnlyMeshes&&this.includedOnlyMeshes.length>0&&this.includedOnlyMeshes.indexOf(e)===-1||this.excludedMeshes&&this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1||this.includeOnlyWithLayerMask!==0&&(this.includeOnlyWithLayerMask&e.layerMask)===0||this.excludeWithLayerMask!==0&&this.excludeWithLayerMask&e.layerMask):!0}dispose(e,t=!1){if(this._shadowGenerator&&(this._shadowGenerator.dispose(),this._shadowGenerator=null),this.getScene().stopAnimation(this),this._parentContainer){const i=this._parentContainer.lights.indexOf(this);i>-1&&this._parentContainer.lights.splice(i,1),this._parentContainer=null}for(const i of this.getScene().meshes)i._removeLightSource(this,!0);this._uniformBuffer.dispose(),this.getScene().removeLight(this),super.dispose(e,t)}getTypeID(){return 0}getScaledIntensity(){return this._photometricScale*this.intensity}clone(e,t=null){const i=je.GetConstructorFromName(this.getTypeID(),e,this.getScene());if(!i)return null;const s=xe.Clone(i,this);return e&&(s.name=e),t&&(s.parent=t),s.setEnabled(this.isEnabled()),this.onClonedObservable.notifyObservers(s),s}serialize(){const e=xe.Serialize(this);return e.uniqueId=this.uniqueId,e.type=this.getTypeID(),this.parent&&this.parent._serializeAsParent(e),this.excludedMeshes.length>0&&(e.excludedMeshesIds=[],this.excludedMeshes.forEach(t=>{e.excludedMeshesIds.push(t.id)})),this.includedOnlyMeshes.length>0&&(e.includedOnlyMeshesIds=[],this.includedOnlyMeshes.forEach(t=>{e.includedOnlyMeshesIds.push(t.id)})),xe.AppendSerializedAnimations(this,e),e.ranges=this.serializeAnimationRanges(),e.isEnabled=this.isEnabled(),e}static GetConstructorFromName(e,t,i){const s=lt.Construct("Light_Type_"+e,t,i);return s||null}static Parse(e,t){const i=je.GetConstructorFromName(e.type,e.name,t);if(!i)return null;const s=xe.Parse(i,e,t);if(e.excludedMeshesIds&&(s._excludedMeshesIds=e.excludedMeshesIds),e.includedOnlyMeshesIds&&(s._includedOnlyMeshesIds=e.includedOnlyMeshesIds),e.parentId!==void 0&&(s._waitingParentId=e.parentId),e.parentInstanceIndex!==void 0&&(s._waitingParentInstanceIndex=e.parentInstanceIndex),e.falloffType!==void 0&&(s.falloffType=e.falloffType),e.lightmapMode!==void 0&&(s.lightmapMode=e.lightmapMode),e.animations){for(let r=0;r<e.animations.length;r++){const n=e.animations[r],o=Si("BABYLON.Animation");o&&s.animations.push(o.Parse(n))}lt.ParseAnimationRanges(s,e,t)}return e.autoAnimate&&t.beginAnimation(s,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),e.isEnabled!==void 0&&s.setEnabled(e.isEnabled),s}_hookArrayForExcluded(e){const t=e.push;e.push=(...s)=>{const r=t.apply(e,s);for(const n of s)n._resyncLightSource(this);return r};const i=e.splice;e.splice=(s,r)=>{const n=i.apply(e,[s,r]);for(const o of n)o._resyncLightSource(this);return n};for(const s of e)s._resyncLightSource(this)}_hookArrayForIncludedOnly(e){const t=e.push;e.push=(...s)=>{const r=t.apply(e,s);return this._resyncMeshes(),r};const i=e.splice;e.splice=(s,r)=>{const n=i.apply(e,[s,r]);return this._resyncMeshes(),n},this._resyncMeshes()}_resyncMeshes(){for(const e of this.getScene().meshes)e._resyncLightSource(this)}_markMeshesAsLightDirty(){for(const e of this.getScene().meshes)e.lightSources.indexOf(this)!==-1&&e._markSubMeshesAsLightDirty()}_computePhotometricScale(){this._photometricScale=this._getPhotometricScale(),this.getScene().resetCachedMaterial()}_getPhotometricScale(){let e=0;const t=this.getTypeID();let i=this.intensityMode;switch(i===je.INTENSITYMODE_AUTOMATIC&&(t===je.LIGHTTYPEID_DIRECTIONALLIGHT?i=je.INTENSITYMODE_ILLUMINANCE:i=je.INTENSITYMODE_LUMINOUSINTENSITY),t){case je.LIGHTTYPEID_POINTLIGHT:case je.LIGHTTYPEID_SPOTLIGHT:switch(i){case je.INTENSITYMODE_LUMINOUSPOWER:e=1/(4*Math.PI);break;case je.INTENSITYMODE_LUMINOUSINTENSITY:e=1;break;case je.INTENSITYMODE_LUMINANCE:e=this.radius*this.radius;break}break;case je.LIGHTTYPEID_DIRECTIONALLIGHT:switch(i){case je.INTENSITYMODE_ILLUMINANCE:e=1;break;case je.INTENSITYMODE_LUMINANCE:{let s=this.radius;s=Math.max(s,.001),e=2*Math.PI*(1-Math.cos(s));break}}break;case je.LIGHTTYPEID_HEMISPHERICLIGHT:e=1;break}return e}_reorderLightsInScene(){const e=this.getScene();this._renderPriority!=0&&(e.requireLightSorting=!0),this.getScene().sortLightsByPriority()}}je.FALLOFF_DEFAULT=Tt.FALLOFF_DEFAULT;je.FALLOFF_PHYSICAL=Tt.FALLOFF_PHYSICAL;je.FALLOFF_GLTF=Tt.FALLOFF_GLTF;je.FALLOFF_STANDARD=Tt.FALLOFF_STANDARD;je.LIGHTMAP_DEFAULT=Tt.LIGHTMAP_DEFAULT;je.LIGHTMAP_SPECULAR=Tt.LIGHTMAP_SPECULAR;je.LIGHTMAP_SHADOWSONLY=Tt.LIGHTMAP_SHADOWSONLY;je.INTENSITYMODE_AUTOMATIC=Tt.INTENSITYMODE_AUTOMATIC;je.INTENSITYMODE_LUMINOUSPOWER=Tt.INTENSITYMODE_LUMINOUSPOWER;je.INTENSITYMODE_LUMINOUSINTENSITY=Tt.INTENSITYMODE_LUMINOUSINTENSITY;je.INTENSITYMODE_ILLUMINANCE=Tt.INTENSITYMODE_ILLUMINANCE;je.INTENSITYMODE_LUMINANCE=Tt.INTENSITYMODE_LUMINANCE;je.LIGHTTYPEID_POINTLIGHT=Tt.LIGHTTYPEID_POINTLIGHT;je.LIGHTTYPEID_DIRECTIONALLIGHT=Tt.LIGHTTYPEID_DIRECTIONALLIGHT;je.LIGHTTYPEID_SPOTLIGHT=Tt.LIGHTTYPEID_SPOTLIGHT;je.LIGHTTYPEID_HEMISPHERICLIGHT=Tt.LIGHTTYPEID_HEMISPHERICLIGHT;T([pi()],je.prototype,"diffuse",void 0);T([pi()],je.prototype,"specular",void 0);T([R()],je.prototype,"falloffType",void 0);T([R()],je.prototype,"intensity",void 0);T([R()],je.prototype,"range",null);T([R()],je.prototype,"intensityMode",null);T([R()],je.prototype,"radius",null);T([R()],je.prototype,"_renderPriority",void 0);T([ie("_reorderLightsInScene")],je.prototype,"renderPriority",void 0);T([R("shadowEnabled")],je.prototype,"_shadowEnabled",void 0);T([R("excludeWithLayerMask")],je.prototype,"_excludeWithLayerMask",void 0);T([R("includeOnlyWithLayerMask")],je.prototype,"_includeOnlyWithLayerMask",void 0);T([R("lightmapMode")],je.prototype,"_lightmapMode",void 0);class za extends je{constructor(){super(...arguments),this._needProjectionMatrixCompute=!0}_setPosition(e){this._position=e}get position(){return this._position}set position(e){this._setPosition(e)}_setDirection(e){this._direction=e}get direction(){return this._direction}set direction(e){this._setDirection(e)}get shadowMinZ(){return this._shadowMinZ}set shadowMinZ(e){this._shadowMinZ=e,this.forceProjectionMatrixCompute()}get shadowMaxZ(){return this._shadowMaxZ}set shadowMaxZ(e){this._shadowMaxZ=e,this.forceProjectionMatrixCompute()}computeTransformedInformation(){return this.parent&&this.parent.getWorldMatrix?(this.transformedPosition||(this.transformedPosition=g.Zero()),g.TransformCoordinatesToRef(this.position,this.parent.getWorldMatrix(),this.transformedPosition),this.direction&&(this.transformedDirection||(this.transformedDirection=g.Zero()),g.TransformNormalToRef(this.direction,this.parent.getWorldMatrix(),this.transformedDirection)),!0):!1}getDepthScale(){return 50}getShadowDirection(e){return this.transformedDirection?this.transformedDirection:this.direction}getAbsolutePosition(){return this.transformedPosition?this.transformedPosition:this.position}setDirectionToTarget(e){return this.direction=g.Normalize(e.subtract(this.position)),this.direction}getRotation(){this.direction.normalize();const e=g.Cross(this.direction,ti.Y),t=g.Cross(e,this.direction);return g.RotationFromAxis(e,t,this.direction)}needCube(){return!1}needProjectionMatrixCompute(){return this._needProjectionMatrixCompute}forceProjectionMatrixCompute(){this._needProjectionMatrixCompute=!0}_initCache(){super._initCache(),this._cache.position=g.Zero()}_isSynchronized(){return!!this._cache.position.equals(this.position)}computeWorldMatrix(e){return!e&&this.isSynchronized()?(this._currentRenderId=this.getScene().getRenderId(),this._worldMatrix):(this._updateCache(),this._cache.position.copyFrom(this.position),this._worldMatrix||(this._worldMatrix=L.Identity()),L.TranslationToRef(this.position.x,this.position.y,this.position.z,this._worldMatrix),this.parent&&this.parent.getWorldMatrix&&(this._worldMatrix.multiplyToRef(this.parent.getWorldMatrix(),this._worldMatrix),this._markSyncedWithParent()),this._worldMatrixDeterminantIsDirty=!0,this._worldMatrix)}getDepthMinZ(e){return this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ}getDepthMaxZ(e){return this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ}setShadowProjectionMatrix(e,t,i){return this.customProjectionMatrixBuilder?this.customProjectionMatrixBuilder(t,i,e):this._setDefaultShadowProjectionMatrix(e,t,i),this}_syncParentEnabledState(){super._syncParentEnabledState(),(!this.parent||!this.parent.getWorldMatrix)&&(this.transformedPosition=null,this.transformedDirection=null)}}T([Zi()],za.prototype,"position",null);T([Zi()],za.prototype,"direction",null);T([R()],za.prototype,"shadowMinZ",null);T([R()],za.prototype,"shadowMaxZ",null);lt.AddNodeConstructor("Light_Type_0",(a,e)=>()=>new Sc(a,g.Zero(),e));class Sc extends za{constructor(e,t,i){super(e,i),this._shadowAngle=Math.PI/2,this.position=t}get shadowAngle(){return this._shadowAngle}set shadowAngle(e){this._shadowAngle=e,this.forceProjectionMatrixCompute()}get direction(){return this._direction}set direction(e){const t=this.needCube();this._direction=e,this.needCube()!==t&&this._shadowGenerator&&this._shadowGenerator.recreateShadowMap()}getClassName(){return"PointLight"}getTypeID(){return je.LIGHTTYPEID_POINTLIGHT}needCube(){return!this.direction}getShadowDirection(e){if(this.direction)return super.getShadowDirection(e);switch(e){case 0:return new g(1,0,0);case 1:return new g(-1,0,0);case 2:return new g(0,-1,0);case 3:return new g(0,1,0);case 4:return new g(0,0,1);case 5:return new g(0,0,-1)}return g.Zero()}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;const r=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,n=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,o=this.getScene().getEngine().useReverseDepthBuffer;L.PerspectiveFovLHToRef(this.shadowAngle,1,o?n:r,o?r:n,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,o)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,0,t):this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,0,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,0,0,t),this}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?e.setFloat3(t,this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z):e.setFloat3(t,this.position.x,this.position.y,this.position.z),this}prepareLightSpecificDefines(e,t){e["POINTLIGHT"+t]=!0}}T([R()],Sc.prototype,"shadowAngle",null);class Bt{constructor(e,t){this.triggerOptions=e,this.onBeforeExecuteObservable=new X,e.parameter?(this.trigger=e.trigger,this._triggerParameter=e.parameter):e.trigger?this.trigger=e.trigger:this.trigger=e,this._nextActiveAction=this,this._condition=t}_prepare(){}getTriggerParameter(){return this._triggerParameter}setTriggerParameter(e){this._triggerParameter=e}_evaluateConditionForCurrentFrame(){const e=this._condition;if(!e)return!0;const t=this._actionManager.getScene().getRenderId();return e._evaluationId!==t&&(e._evaluationId=t,e._currentResult=e.isValid()),e._currentResult}_executeCurrent(e){!this._evaluateConditionForCurrentFrame()||(this.onBeforeExecuteObservable.notifyObservers(this),this._nextActiveAction.execute(e),this.skipToNextActiveAction())}execute(e){}skipToNextActiveAction(){this._nextActiveAction._child?(this._nextActiveAction._child._actionManager||(this._nextActiveAction._child._actionManager=this._actionManager),this._nextActiveAction=this._nextActiveAction._child):this._nextActiveAction=this}then(e){return this._child=e,e._actionManager=this._actionManager,e._prepare(),e}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(e){}_serialize(e,t){const i={type:1,children:[],name:e.name,properties:e.properties||[]};if(this._child&&this._child.serialize(i),this._condition){const s=this._condition.serialize();return s.children.push(i),t&&t.children.push(s),s}return t&&t.children.push(i),i}}Bt._SerializeValueAsString=a=>typeof a=="number"?a.toString():typeof a=="boolean"?a?"true":"false":a instanceof le?a.x+", "+a.y:a instanceof g?a.x+", "+a.y+", "+a.z:a instanceof re?a.r+", "+a.g+", "+a.b:a instanceof J?a.r+", "+a.g+", "+a.b+", "+a.a:a;Bt._GetTargetProperty=a=>({name:"target",targetType:a._isMesh?"MeshProperties":a._isLight?"LightProperties":a._isCamera?"CameraProperties":"SceneProperties",value:a._isScene?"Scene":a.name});he("BABYLON.Action",Bt);class Il{constructor(e){this._actionManager=e}isValid(){return!0}_getProperty(e){return this._actionManager._getProperty(e)}_getEffectiveTarget(e,t){return this._actionManager._getEffectiveTarget(e,t)}serialize(){}_serialize(e){return{type:2,children:[],name:e.name,properties:e.properties}}}class Ai extends Il{constructor(e,t,i,s,r=Ai.IsEqual){super(e),this.propertyPath=i,this.value=s,this.operator=r,this._target=t,this._effectiveTarget=this._getEffectiveTarget(t,this.propertyPath),this._property=this._getProperty(this.propertyPath)}static get IsEqual(){return Ai._IsEqual}static get IsDifferent(){return Ai._IsDifferent}static get IsGreater(){return Ai._IsGreater}static get IsLesser(){return Ai._IsLesser}isValid(){switch(this.operator){case Ai.IsGreater:return this._effectiveTarget[this._property]>this.value;case Ai.IsLesser:return this._effectiveTarget[this._property]<this.value;case Ai.IsEqual:case Ai.IsDifferent:{let e;return this.value.equals?e=this.value.equals(this._effectiveTarget[this._property]):e=this.value===this._effectiveTarget[this._property],this.operator===Ai.IsEqual?e:!e}}return!1}serialize(){return this._serialize({name:"ValueCondition",properties:[Bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Bt._SerializeValueAsString(this.value)},{name:"operator",value:Ai.GetOperatorName(this.operator)}]})}static GetOperatorName(e){switch(e){case Ai._IsEqual:return"IsEqual";case Ai._IsDifferent:return"IsDifferent";case Ai._IsGreater:return"IsGreater";case Ai._IsLesser:return"IsLesser";default:return""}}}Ai._IsEqual=0;Ai._IsDifferent=1;Ai._IsGreater=2;Ai._IsLesser=3;class c1 extends Il{constructor(e,t){super(e),this.predicate=t}isValid(){return this.predicate()}}class u1 extends Il{constructor(e,t,i){super(e),this.value=i,this._target=t}isValid(){return this._target.state===this.value}serialize(){return this._serialize({name:"StateCondition",properties:[Bt._GetTargetProperty(this._target),{name:"value",value:this.value}]})}}he("BABYLON.ValueCondition",Ai);he("BABYLON.PredicateCondition",c1);he("BABYLON.StateCondition",u1);class d1 extends Bt{constructor(e,t,i,s){super(e,s),this.value=i,this._target=t}execute(){this._target.state=this.value}serialize(e){return super._serialize({name:"SetStateAction",properties:[Bt._GetTargetProperty(this._target),{name:"value",value:this.value}]},e)}}class f1 extends Bt{constructor(e,t,i,s,r){super(e,r),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){this._effectiveTarget[this._property]=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"SetValueAction",properties:[Bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Bt._SerializeValueAsString(this.value)}]},e)}}class p1 extends Bt{constructor(e,t,i,s,r){super(e,r),this.propertyPath=i,this.value=s,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath),typeof this._effectiveTarget[this._property]!="number"&&B.Warn("Warning: IncrementValueAction can only be used with number values")}execute(){this._effectiveTarget[this._property]+=this.value,this._target.markAsDirty&&this._target.markAsDirty(this._property)}serialize(e){return super._serialize({name:"IncrementValueAction",properties:[Bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Bt._SerializeValueAsString(this.value)}]},e)}}class _1 extends Bt{constructor(e,t,i,s,r,n){super(e,n),this.from=i,this.to=s,this.loop=r,this._target=t}_prepare(){}execute(){this._actionManager.getScene().beginAnimation(this._target,this.from,this.to,this.loop)}serialize(e){return super._serialize({name:"PlayAnimationAction",properties:[Bt._GetTargetProperty(this._target),{name:"from",value:String(this.from)},{name:"to",value:String(this.to)},{name:"loop",value:Bt._SerializeValueAsString(this.loop)||!1}]},e)}}class m1 extends Bt{constructor(e,t,i){super(e,i),this._target=t}_prepare(){}execute(){this._actionManager.getScene().stopAnimation(this._target)}serialize(e){return super._serialize({name:"StopAnimationAction",properties:[Bt._GetTargetProperty(this._target)]},e)}}class y_ extends Bt{constructor(e=0,t){super(e,t)}execute(){}serialize(e){return super._serialize({name:"DoNothingAction",properties:[]},e)}}class g1 extends Bt{constructor(e,t,i){super(e,i),this.func=t}execute(e){this.func(e)}}class A_ extends Bt{constructor(e,t,i,s){super(e,s),this._target=t,this._parent=i}_prepare(){}execute(){if(this._target.parent===this._parent)return;const e=this._parent.getWorldMatrix().clone();e.invert(),this._target.position=g.TransformCoordinates(this._target.position,e),this._target.parent=this._parent}serialize(e){return super._serialize({name:"SetParentAction",properties:[Bt._GetTargetProperty(this._target),Bt._GetTargetProperty(this._parent)]},e)}}he("BABYLON.SetParentAction",A_);he("BABYLON.ExecuteCodeAction",g1);he("BABYLON.DoNothingAction",y_);he("BABYLON.StopAnimationAction",m1);he("BABYLON.PlayAnimationAction",_1);he("BABYLON.IncrementValueAction",p1);he("BABYLON.SetValueAction",f1);he("BABYLON.SetStateAction",d1);he("BABYLON.SetParentAction",A_);class mt extends ks{constructor(e){super(),e=e||ye.LastCreatedScene,e&&(this._scene=e,e.actionManagers.push(this))}dispose(){const e=this._scene.actionManagers.indexOf(this);for(let t=0;t<this.actions.length;t++){const i=this.actions[t];mt.Triggers[i.trigger]--,mt.Triggers[i.trigger]===0&&delete mt.Triggers[i.trigger]}e>-1&&this._scene.actionManagers.splice(e,1)}getScene(){return this._scene}hasSpecificTriggers(e){for(let t=0;t<this.actions.length;t++){const i=this.actions[t];if(e.indexOf(i.trigger)>-1)return!0}return!1}hasSpecificTriggers2(e,t){for(let i=0;i<this.actions.length;i++){const s=this.actions[i];if(e==s.trigger||t==s.trigger)return!0}return!1}hasSpecificTrigger(e,t){for(let i=0;i<this.actions.length;i++){const s=this.actions[i];if(s.trigger===e)if(t){if(t(s.getTriggerParameter()))return!0}else return!0}return!1}get hasPointerTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=mt.OnPickTrigger&&t.trigger<=mt.OnPointerOutTrigger)return!0}return!1}get hasPickTriggers(){for(let e=0;e<this.actions.length;e++){const t=this.actions[e];if(t.trigger>=mt.OnPickTrigger&&t.trigger<=mt.OnPickUpTrigger)return!0}return!1}registerAction(e){return e.trigger===mt.OnEveryFrameTrigger&&this.getScene().actionManager!==this?(B.Warn("OnEveryFrameTrigger can only be used with scene.actionManager"),null):(this.actions.push(e),mt.Triggers[e.trigger]?mt.Triggers[e.trigger]++:mt.Triggers[e.trigger]=1,e._actionManager=this,e._prepare(),e)}unregisterAction(e){const t=this.actions.indexOf(e);return t!==-1?(this.actions.splice(t,1),mt.Triggers[e.trigger]-=1,mt.Triggers[e.trigger]===0&&delete mt.Triggers[e.trigger],e._actionManager=null,!0):!1}processTrigger(e,t){for(let i=0;i<this.actions.length;i++){const s=this.actions[i];if(s.trigger===e){if(t&&(e===mt.OnKeyUpTrigger||e===mt.OnKeyDownTrigger)){const r=s.getTriggerParameter();if(r&&r!==t.sourceEvent.keyCode){if(!r.toLowerCase)continue;const n=r.toLowerCase();if(n!==t.sourceEvent.key){const o=t.sourceEvent.charCode?t.sourceEvent.charCode:t.sourceEvent.keyCode;if(String.fromCharCode(o).toLowerCase()!==n)continue}}}s._executeCurrent(t)}}}_getEffectiveTarget(e,t){const i=t.split(".");for(let s=0;s<i.length-1;s++)e=e[i[s]];return e}_getProperty(e){const t=e.split(".");return t[t.length-1]}serialize(e){const t={children:new Array,name:e,type:3,properties:new Array};for(let i=0;i<this.actions.length;i++){const s={type:0,children:new Array,name:mt.GetTriggerName(this.actions[i].trigger),properties:new Array},r=this.actions[i].triggerOptions;if(r&&typeof r!="number")if(r.parameter instanceof Node)s.properties.push(Bt._GetTargetProperty(r.parameter));else{const n={};ys.DeepCopy(r.parameter,n,["mesh"]),r.parameter&&r.parameter.mesh&&(n._meshId=r.parameter.mesh.id),s.properties.push({name:"parameter",targetType:null,value:n})}this.actions[i].serialize(s),t.children.push(s)}return t}static Parse(e,t,i){const s=new mt(i);t===null?i.actionManager=s:t.actionManager=s;const r=(l,h)=>{const c=Si("BABYLON."+l);if(c){const u=Object.create(c.prototype);return u.constructor.apply(u,h),u}},n=(l,h,c,u)=>{if(u===null){const _=parseFloat(h);return h==="true"||h==="false"?h==="true":isNaN(_)?h:_}const d=u.split("."),f=h.split(",");for(let _=0;_<d.length;_++)c=c[d[_]];if(typeof c=="boolean")return f[0]==="true";if(typeof c=="string")return f[0];const p=new Array;for(let _=0;_<f.length;_++)p.push(parseFloat(f[_]));return c instanceof g?g.FromArray(p):c instanceof Ge?Ge.FromArray(p):c instanceof re?re.FromArray(p):c instanceof J?J.FromArray(p):parseFloat(f[0])},o=(l,h,c,u,d=null)=>{if(l.detached)return;const f=new Array;let p=null,_=null;const m=l.combine&&l.combine.length>0;if(l.type===2?f.push(s):f.push(h),m){const x=new Array;for(let b=0;b<l.combine.length;b++)o(l.combine[b],mt.NothingTrigger,c,u,x);f.push(x)}else for(let x=0;x<l.properties.length;x++){let b=l.properties[x].value;const S=l.properties[x].name,C=l.properties[x].targetType;S==="target"?C!==null&&C==="SceneProperties"?b=p=i:b=p=i.getNodeByName(b):S==="parent"?b=i.getNodeByName(b):S==="sound"?i.getSoundByName&&(b=i.getSoundByName(b)):S!=="propertyPath"?l.type===2&&S==="operator"?b=Ai[b]:b=n(S,b,p,S==="value"?_:null):_=b,f.push(b)}if(d===null?f.push(c):f.push(null),l.name==="InterpolateValueAction"){const x=f[f.length-2];f[f.length-1]=x,f[f.length-2]=c}let v=r(l.name,f);if(v instanceof Il&&c!==null){const x=new y_(h,c);u?u.then(x):s.registerAction(x),u=x}d===null?v instanceof Il?(c=v,v=u):(c=null,u?u.then(v):s.registerAction(v)):d.push(v);for(let x=0;x<l.children.length;x++)o(l.children[x],h,c,v,null)};for(let l=0;l<e.children.length;l++){let h;const c=e.children[l];if(c.properties.length>0){const u=c.properties[0].value,d=c.properties[0].targetType===null?u:i.getMeshByName(u);d._meshId&&(d.mesh=i.getMeshById(d._meshId)),h={trigger:mt[c.name],parameter:d}}else h=mt[c.name];for(let u=0;u<c.children.length;u++)c.detached||o(c.children[u],h,null,null)}}static GetTriggerName(e){switch(e){case 0:return"NothingTrigger";case 1:return"OnPickTrigger";case 2:return"OnLeftPickTrigger";case 3:return"OnRightPickTrigger";case 4:return"OnCenterPickTrigger";case 5:return"OnPickDownTrigger";case 6:return"OnPickUpTrigger";case 7:return"OnLongPressTrigger";case 8:return"OnPointerOverTrigger";case 9:return"OnPointerOutTrigger";case 10:return"OnEveryFrameTrigger";case 11:return"OnIntersectionEnterTrigger";case 12:return"OnIntersectionExitTrigger";case 13:return"OnKeyDownTrigger";case 14:return"OnKeyUpTrigger";case 15:return"OnPickOutTrigger";default:return""}}}mt.NothingTrigger=0;mt.OnPickTrigger=1;mt.OnLeftPickTrigger=2;mt.OnRightPickTrigger=3;mt.OnCenterPickTrigger=4;mt.OnPickDownTrigger=5;mt.OnDoublePickTrigger=6;mt.OnPickUpTrigger=7;mt.OnPickOutTrigger=16;mt.OnLongPressTrigger=8;mt.OnPointerOverTrigger=9;mt.OnPointerOutTrigger=10;mt.OnEveryFrameTrigger=11;mt.OnIntersectionEnterTrigger=12;mt.OnIntersectionExitTrigger=13;mt.OnKeyDownTrigger=14;mt.OnKeyUpTrigger=15;class v1 extends Bt{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.play()}serialize(e){return super._serialize({name:"PlaySoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}class x1 extends Bt{constructor(e,t,i){super(e,i),this._sound=t}_prepare(){}execute(){this._sound!==void 0&&this._sound.stop()}serialize(e){return super._serialize({name:"StopSoundAction",properties:[{name:"sound",value:this._sound.name}]},e)}}he("BABYLON.PlaySoundAction",v1);he("BABYLON.StopSoundAction",x1);class T1 extends Bt{constructor(e,t,i,s,r=1e3,n,o,l){super(e,n),this.duration=1e3,this.onInterpolationDoneObservable=new X,this.propertyPath=i,this.value=s,this.duration=r,this.stopOtherAnimations=o,this.onInterpolationDone=l,this._target=this._effectiveTarget=t}_prepare(){this._effectiveTarget=this._getEffectiveTarget(this._effectiveTarget,this.propertyPath),this._property=this._getProperty(this.propertyPath)}execute(){const e=this._actionManager.getScene(),t=[{frame:0,value:this._effectiveTarget[this._property]},{frame:100,value:this.value}];let i;if(typeof this.value=="number")i=ae.ANIMATIONTYPE_FLOAT;else if(this.value instanceof re)i=ae.ANIMATIONTYPE_COLOR3;else if(this.value instanceof g)i=ae.ANIMATIONTYPE_VECTOR3;else if(this.value instanceof L)i=ae.ANIMATIONTYPE_MATRIX;else if(this.value instanceof Q)i=ae.ANIMATIONTYPE_QUATERNION;else{B.Warn("InterpolateValueAction: Unsupported type ("+typeof this.value+")");return}const s=new ae("InterpolateValueAction",this._property,100*(1e3/this.duration),i,ae.ANIMATIONLOOPMODE_CONSTANT);s.setKeys(t),this.stopOtherAnimations&&e.stopAnimation(this._effectiveTarget);const r=()=>{this.onInterpolationDoneObservable.notifyObservers(this),this.onInterpolationDone&&this.onInterpolationDone()};e.beginDirectAnimation(this._effectiveTarget,[s],0,100,!1,1,r)}serialize(e){return super._serialize({name:"InterpolateValueAction",properties:[Bt._GetTargetProperty(this._target),{name:"propertyPath",value:this.propertyPath},{name:"value",value:Bt._SerializeValueAsString(this.value)},{name:"duration",value:Bt._SerializeValueAsString(this.duration)},{name:"stopOtherAnimations",value:Bt._SerializeValueAsString(this.stopOtherAnimations)||!1}]},e)}}he("BABYLON.InterpolateValueAction",T1);const b1=Object.freeze(new Q(0,0,0,0)),S1=Object.freeze(g.Zero()),E1=Object.freeze(le.Zero()),C1=Object.freeze(js.Zero()),y1=Object.freeze(re.Black());class A1{constructor(e,t,i,s){if(this._events=new Array,this._currentFrame=0,this._originalValue=new Array,this._originalBlendValue=null,this._offsetsCache={},this._highLimitsCache={},this._stopped=!1,this._blendingFactor=0,this._currentValue=null,this._currentActiveTarget=null,this._directTarget=null,this._targetPath="",this._weight=1,this._ratioOffset=0,this._previousDelay=0,this._previousRatio=0,this._targetIsArray=!1,this._animation=t,this._target=e,this._scene=i,this._host=s,this._activeTargets=[],t._runtimeAnimations.push(this),this._animationState={key:0,repeatCount:0,loopMode:this._getCorrectLoopMode()},this._animation.dataType===ae.ANIMATIONTYPE_MATRIX&&(this._animationState.workValue=L.Zero()),this._keys=this._animation.getKeys(),this._minFrame=this._keys[0].frame,this._maxFrame=this._keys[this._keys.length-1].frame,this._minValue=this._keys[0].value,this._maxValue=this._keys[this._keys.length-1].value,this._minFrame!==0){const n={frame:0,value:this._minValue};this._keys.splice(0,0,n)}if(this._target instanceof Array){let n=0;for(const o of this._target)this._preparePath(o,n),this._getOriginalValues(n),n++;this._targetIsArray=!0}else this._preparePath(this._target),this._getOriginalValues(),this._targetIsArray=!1,this._directTarget=this._activeTargets[0];const r=t.getEvents();r&&r.length>0&&r.forEach(n=>{this._events.push(n._clone())}),this._enableBlending=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.enableBlending:this._animation.enableBlending}get currentFrame(){return this._currentFrame}get weight(){return this._weight}get currentValue(){return this._currentValue}get targetPath(){return this._targetPath}get target(){return this._currentActiveTarget}get isAdditive(){return this._host&&this._host.isAdditive}_preparePath(e,t=0){const i=this._animation.targetPropertyPath;if(i.length>1){let s=e[i[0]];for(let r=1;r<i.length-1;r++)s=s[i[r]];this._targetPath=i[i.length-1],this._activeTargets[t]=s}else this._targetPath=i[0],this._activeTargets[t]=e}get animation(){return this._animation}reset(e=!1){if(e)if(this._target instanceof Array){let t=0;for(const i of this._target)this._originalValue[t]!==void 0&&this._setValue(i,this._activeTargets[t],this._originalValue[t],-1,t),t++}else this._originalValue[0]!==void 0&&this._setValue(this._target,this._directTarget,this._originalValue[0],-1,0);this._offsetsCache={},this._highLimitsCache={},this._currentFrame=0,this._blendingFactor=0;for(let t=0;t<this._events.length;t++)this._events[t].isDone=!1}isStopped(){return this._stopped}dispose(){const e=this._animation.runtimeAnimations.indexOf(this);e>-1&&this._animation.runtimeAnimations.splice(e,1)}setValue(e,t){if(this._targetIsArray){for(let i=0;i<this._target.length;i++){const s=this._target[i];this._setValue(s,this._activeTargets[i],e,t,i)}return}this._setValue(this._target,this._directTarget,e,t,0)}_getOriginalValues(e=0){let t;const i=this._activeTargets[e];i.getRestPose&&this._targetPath==="_matrix"?t=i.getRestPose():t=i[this._targetPath],t&&t.clone?this._originalValue[e]=t.clone():this._originalValue[e]=t}_setValue(e,t,i,s,r){if(this._currentActiveTarget=t,this._weight=s,this._enableBlending&&this._blendingFactor<=1){if(!this._originalBlendValue){const o=t[this._targetPath];o.clone?this._originalBlendValue=o.clone():this._originalBlendValue=o}this._originalBlendValue.m?ae.AllowMatrixDecomposeForInterpolation?this._currentValue?L.DecomposeLerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=L.DecomposeLerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue?L.LerpToRef(this._originalBlendValue,i,this._blendingFactor,this._currentValue):this._currentValue=L.Lerp(this._originalBlendValue,i,this._blendingFactor):this._currentValue=ae._UniversalLerp(this._originalBlendValue,i,this._blendingFactor);const n=e&&e.animationPropertiesOverride?e.animationPropertiesOverride.blendingSpeed:this._animation.blendingSpeed;this._blendingFactor+=n}else this._currentValue?this._currentValue.copyFrom?this._currentValue.copyFrom(i):this._currentValue=i:i!=null&&i.clone?this._currentValue=i.clone():this._currentValue=i;s!==-1?this._scene._registerTargetForLateAnimationBinding(this,this._originalValue[r]):t[this._targetPath]=this._currentValue,e.markAsDirty&&e.markAsDirty(this._animation.targetProperty)}_getCorrectLoopMode(){return this._target&&this._target.animationPropertiesOverride?this._target.animationPropertiesOverride.loopMode:this._animation.loopMode}goToFrame(e){const t=this._animation.getKeys();e<t[0].frame?e=t[0].frame:e>t[t.length-1].frame&&(e=t[t.length-1].frame);const i=this._events;if(i.length)for(let r=0;r<i.length;r++)i[r].onlyOnce||(i[r].isDone=i[r].frame<e);this._currentFrame=e;const s=this._animation._interpolate(e,this._animationState);this.setValue(s,-1)}_prepareForSpeedRatioChange(e){const t=this._previousDelay*(this._animation.framePerSecond*e)/1e3;this._ratioOffset=this._previousRatio-t}animate(e,t,i,s,r,n=-1){const o=this._animation,l=o.targetPropertyPath;if(!l||l.length<1)return this._stopped=!0,!1;let h=!0;(t<this._minFrame||t>this._maxFrame)&&(t=this._minFrame),(i<this._minFrame||i>this._maxFrame)&&(i=this._maxFrame);const c=i-t;let u;const d=e*(o.framePerSecond*r)/1e3+this._ratioOffset;let f=0;if(this._previousDelay=e,this._previousRatio=d,!s&&i>=t&&d>=c)h=!1,f=o._getKeyValue(this._maxValue);else if(!s&&t>=i&&d<=c)h=!1,f=o._getKeyValue(this._minValue);else if(this._animationState.loopMode!==ae.ANIMATIONLOOPMODE_CYCLE){const v=i.toString()+t.toString();if(!this._offsetsCache[v]){this._animationState.repeatCount=0,this._animationState.loopMode=ae.ANIMATIONLOOPMODE_CYCLE;const x=o._interpolate(t,this._animationState),b=o._interpolate(i,this._animationState);switch(this._animationState.loopMode=this._getCorrectLoopMode(),o.dataType){case ae.ANIMATIONTYPE_FLOAT:this._offsetsCache[v]=b-x;break;case ae.ANIMATIONTYPE_QUATERNION:this._offsetsCache[v]=b.subtract(x);break;case ae.ANIMATIONTYPE_VECTOR3:this._offsetsCache[v]=b.subtract(x);break;case ae.ANIMATIONTYPE_VECTOR2:this._offsetsCache[v]=b.subtract(x);break;case ae.ANIMATIONTYPE_SIZE:this._offsetsCache[v]=b.subtract(x);break;case ae.ANIMATIONTYPE_COLOR3:this._offsetsCache[v]=b.subtract(x);break}this._highLimitsCache[v]=b}f=this._highLimitsCache[v],u=this._offsetsCache[v]}if(u===void 0)switch(o.dataType){case ae.ANIMATIONTYPE_FLOAT:u=0;break;case ae.ANIMATIONTYPE_QUATERNION:u=b1;break;case ae.ANIMATIONTYPE_VECTOR3:u=S1;break;case ae.ANIMATIONTYPE_VECTOR2:u=E1;break;case ae.ANIMATIONTYPE_SIZE:u=C1;break;case ae.ANIMATIONTYPE_COLOR3:u=y1}let p;if(this._host&&this._host.syncRoot){const v=this._host.syncRoot,x=(v.masterFrame-v.fromFrame)/(v.toFrame-v.fromFrame);p=t+(i-t)*x}else d>0&&t>i||d<0&&t<i?p=h&&c!==0?i+d%c:t:p=h&&c!==0?t+d%c:i;const _=this._events;if(r>0&&this.currentFrame>p||r<0&&this.currentFrame<p){this._onLoop();for(let v=0;v<_.length;v++)_[v].onlyOnce||(_[v].isDone=!1);this._animationState.key=r>0?0:o.getKeys().length-1}this._currentFrame=p,this._animationState.repeatCount=c===0?0:d/c>>0,this._animationState.highLimitValue=f,this._animationState.offsetValue=u;const m=o._interpolate(p,this._animationState);if(this.setValue(m,n),_.length){for(let v=0;v<_.length;v++)if(c>0&&p>=_[v].frame&&_[v].frame>=t||c<0&&p<=_[v].frame&&_[v].frame<=t){const x=_[v];x.isDone||(x.onlyOnce&&(_.splice(v,1),v--),x.isDone=!0,x.action(p))}}return h||(this._stopped=!0),h}}class Pt extends lt{constructor(e,t,i=null,s=null,r=null,n=null,o=null){super(e,t.getScene()),this.name=e,this.children=new Array,this.animations=new Array,this._index=null,this._absoluteTransform=new L,this._invertedAbsoluteTransform=new L,this._scalingDeterminant=1,this._worldTransform=new L,this._needToDecompose=!0,this._needToCompose=!1,this._linkedTransformNode=null,this._waitingTransformNodeId=null,this._skeleton=t,this._localMatrix=s?s.clone():L.Identity(),this._restPose=r||this._localMatrix.clone(),this._baseMatrix=n||this._localMatrix.clone(),this._index=o,t.bones.push(this),this.setParent(i,!1),(n||s)&&this._updateDifferenceMatrix()}get _matrix(){return this._compose(),this._localMatrix}set _matrix(e){this._needToCompose=!1,e.updateFlag!==this._localMatrix.updateFlag&&(this._localMatrix.copyFrom(e),this._markAsDirtyAndDecompose())}getClassName(){return"Bone"}getSkeleton(){return this._skeleton}get parent(){return this._parentNode}getParent(){return this.parent}getChildren(){return this.children}getIndex(){return this._index===null?this.getSkeleton().bones.indexOf(this):this._index}set parent(e){this.setParent(e)}setParent(e,t=!0){if(this.parent!==e){if(this.parent){const i=this.parent.children.indexOf(this);i!==-1&&this.parent.children.splice(i,1)}this._parentNode=e,this.parent&&this.parent.children.push(this),t&&this._updateDifferenceMatrix(),this.markAsDirty()}}getLocalMatrix(){return this._compose(),this._localMatrix}getBaseMatrix(){return this._baseMatrix}getRestPose(){return this._restPose}setRestPose(e){this._restPose.copyFrom(e)}getBindPose(){return this._baseMatrix}setBindPose(e){this.updateMatrix(e)}getWorldMatrix(){return this._worldTransform}returnToRest(){var e;if(this._linkedTransformNode){const t=G.Vector3[0],i=G.Quaternion[0],s=G.Vector3[1];this.getRestPose().decompose(t,i,s),this._linkedTransformNode.position.copyFrom(s),this._linkedTransformNode.rotationQuaternion=(e=this._linkedTransformNode.rotationQuaternion)!==null&&e!==void 0?e:Q.Identity(),this._linkedTransformNode.rotationQuaternion.copyFrom(i),this._linkedTransformNode.scaling.copyFrom(t)}else this._matrix=this._restPose}getInvertedAbsoluteTransform(){return this._invertedAbsoluteTransform}getAbsoluteTransform(){return this._absoluteTransform}linkTransformNode(e){this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++}getTransformNode(){return this._linkedTransformNode}get position(){return this._decompose(),this._localPosition}set position(e){this._decompose(),this._localPosition.copyFrom(e),this._markAsDirtyAndCompose()}get rotation(){return this.getRotation()}set rotation(e){this.setRotation(e)}get rotationQuaternion(){return this._decompose(),this._localRotation}set rotationQuaternion(e){this.setRotationQuaternion(e)}get scaling(){return this.getScale()}set scaling(e){this.setScale(e)}get animationPropertiesOverride(){return this._skeleton.animationPropertiesOverride}_decompose(){!this._needToDecompose||(this._needToDecompose=!1,this._localScaling||(this._localScaling=g.Zero(),this._localRotation=Q.Zero(),this._localPosition=g.Zero()),this._localMatrix.decompose(this._localScaling,this._localRotation,this._localPosition))}_compose(){if(!!this._needToCompose){if(!this._localScaling){this._needToCompose=!1;return}this._needToCompose=!1,L.ComposeToRef(this._localScaling,this._localRotation,this._localPosition,this._localMatrix)}}updateMatrix(e,t=!0,i=!0){this._baseMatrix.copyFrom(e),t&&this._updateDifferenceMatrix(),i?this._matrix=e:this.markAsDirty()}_updateDifferenceMatrix(e,t=!0){if(e||(e=this._baseMatrix),this.parent?e.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform):this._absoluteTransform.copyFrom(e),this._absoluteTransform.invertToRef(this._invertedAbsoluteTransform),t)for(let i=0;i<this.children.length;i++)this.children[i]._updateDifferenceMatrix();this._scalingDeterminant=this._absoluteTransform.determinant()<0?-1:1}markAsDirty(){return this._currentRenderId++,this._childUpdateId++,this._skeleton._markAsDirty(),this}_markAsDirtyAndCompose(){this.markAsDirty(),this._needToCompose=!0}_markAsDirtyAndDecompose(){this.markAsDirty(),this._needToDecompose=!0}translate(e,t=Ze.LOCAL,i){const s=this.getLocalMatrix();if(t==Ze.LOCAL)s.addAtIndex(12,e.x),s.addAtIndex(13,e.y),s.addAtIndex(14,e.z);else{let r=null;i&&(r=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=Pt._TmpMats[0],o=Pt._TmpVecs[0];this.parent?i&&r?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(r,n)):n.copyFrom(this.parent.getAbsoluteTransform()):L.IdentityToRef(n),n.setTranslationFromFloats(0,0,0),n.invert(),g.TransformCoordinatesToRef(e,n,o),s.addAtIndex(12,o.x),s.addAtIndex(13,o.y),s.addAtIndex(14,o.z)}this._markAsDirtyAndDecompose()}setPosition(e,t=Ze.LOCAL,i){const s=this.getLocalMatrix();if(t==Ze.LOCAL)s.setTranslationFromFloats(e.x,e.y,e.z);else{let r=null;i&&(r=i.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const n=Pt._TmpMats[0],o=Pt._TmpVecs[0];this.parent?(i&&r?(n.copyFrom(this.parent.getAbsoluteTransform()),n.multiplyToRef(r,n)):n.copyFrom(this.parent.getAbsoluteTransform()),n.invert()):L.IdentityToRef(n),g.TransformCoordinatesToRef(e,n,o),s.setTranslationFromFloats(o.x,o.y,o.z)}this._markAsDirtyAndDecompose()}setAbsolutePosition(e,t){this.setPosition(e,Ze.WORLD,t)}scale(e,t,i,s=!1){const r=this.getLocalMatrix(),n=Pt._TmpMats[0];L.ScalingToRef(e,t,i,n),n.multiplyToRef(r,r),n.invert();for(const o of this.children){const l=o.getLocalMatrix();l.multiplyToRef(n,l),l.multiplyAtIndex(12,e),l.multiplyAtIndex(13,t),l.multiplyAtIndex(14,i),o._markAsDirtyAndDecompose()}if(this._markAsDirtyAndDecompose(),s)for(const o of this.children)o.scale(e,t,i,s)}setScale(e){this._decompose(),this._localScaling.copyFrom(e),this._markAsDirtyAndCompose()}getScale(){return this._decompose(),this._localScaling}getScaleToRef(e){this._decompose(),e.copyFrom(this._localScaling)}setYawPitchRoll(e,t,i,s=Ze.LOCAL,r){if(s===Ze.LOCAL){const l=Pt._TmpQuat;Q.RotationYawPitchRollToRef(e,t,i,l),this.setRotationQuaternion(l,s,r);return}const n=Pt._TmpMats[0];if(!this._getNegativeRotationToRef(n,r))return;const o=Pt._TmpMats[1];L.RotationYawPitchRollToRef(e,t,i,o),n.multiplyToRef(o,o),this._rotateWithMatrix(o,s,r)}rotate(e,t,i=Ze.LOCAL,s){const r=Pt._TmpMats[0];r.setTranslationFromFloats(0,0,0),L.RotationAxisToRef(e,t,r),this._rotateWithMatrix(r,i,s)}setAxisAngle(e,t,i=Ze.LOCAL,s){if(i===Ze.LOCAL){const o=Pt._TmpQuat;Q.RotationAxisToRef(e,t,o),this.setRotationQuaternion(o,i,s);return}const r=Pt._TmpMats[0];if(!this._getNegativeRotationToRef(r,s))return;const n=Pt._TmpMats[1];L.RotationAxisToRef(e,t,n),r.multiplyToRef(n,n),this._rotateWithMatrix(n,i,s)}setRotation(e,t=Ze.LOCAL,i){this.setYawPitchRoll(e.y,e.x,e.z,t,i)}setRotationQuaternion(e,t=Ze.LOCAL,i){if(t===Ze.LOCAL){this._decompose(),this._localRotation.copyFrom(e),this._markAsDirtyAndCompose();return}const s=Pt._TmpMats[0];if(!this._getNegativeRotationToRef(s,i))return;const r=Pt._TmpMats[1];L.FromQuaternionToRef(e,r),s.multiplyToRef(r,r),this._rotateWithMatrix(r,t,i)}setRotationMatrix(e,t=Ze.LOCAL,i){if(t===Ze.LOCAL){const n=Pt._TmpQuat;Q.FromRotationMatrixToRef(e,n),this.setRotationQuaternion(n,t,i);return}const s=Pt._TmpMats[0];if(!this._getNegativeRotationToRef(s,i))return;const r=Pt._TmpMats[1];r.copyFrom(e),s.multiplyToRef(e,r),this._rotateWithMatrix(r,t,i)}_rotateWithMatrix(e,t=Ze.LOCAL,i){const s=this.getLocalMatrix(),r=s.m[12],n=s.m[13],o=s.m[14],l=this.getParent(),h=Pt._TmpMats[3],c=Pt._TmpMats[4];l&&t==Ze.WORLD?(i?(h.copyFrom(i.getWorldMatrix()),l.getAbsoluteTransform().multiplyToRef(h,h)):h.copyFrom(l.getAbsoluteTransform()),c.copyFrom(h),c.invert(),s.multiplyToRef(h,s),s.multiplyToRef(e,s),s.multiplyToRef(c,s)):t==Ze.WORLD&&i?(h.copyFrom(i.getWorldMatrix()),c.copyFrom(h),c.invert(),s.multiplyToRef(h,s),s.multiplyToRef(e,s),s.multiplyToRef(c,s)):s.multiplyToRef(e,s),s.setTranslationFromFloats(r,n,o),this.computeAbsoluteTransforms(),this._markAsDirtyAndDecompose()}_getNegativeRotationToRef(e,t){const i=Pt._TmpMats[2];return e.copyFrom(this.getAbsoluteTransform()),t?(e.multiplyToRef(t.getWorldMatrix(),e),L.ScalingToRef(t.scaling.x,t.scaling.y,t.scaling.z,i)):L.IdentityToRef(i),e.invert(),isNaN(e.m[0])?!1:(i.multiplyAtIndex(0,this._scalingDeterminant),e.multiplyToRef(i,e),!0)}getPosition(e=Ze.LOCAL,t=null){const i=g.Zero();return this.getPositionToRef(e,t,i),i}getPositionToRef(e=Ze.LOCAL,t,i){if(e==Ze.LOCAL){const s=this.getLocalMatrix();i.x=s.m[12],i.y=s.m[13],i.z=s.m[14]}else{let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let r=Pt._TmpMats[0];t&&s?(r.copyFrom(this.getAbsoluteTransform()),r.multiplyToRef(s,r)):r=this.getAbsoluteTransform(),i.x=r.m[12],i.y=r.m[13],i.z=r.m[14]}}getAbsolutePosition(e=null){const t=g.Zero();return this.getPositionToRef(Ze.WORLD,e,t),t}getAbsolutePositionToRef(e,t){this.getPositionToRef(Ze.WORLD,e,t)}computeAbsoluteTransforms(){if(this._compose(),this.parent)this._localMatrix.multiplyToRef(this.parent._absoluteTransform,this._absoluteTransform);else{this._absoluteTransform.copyFrom(this._localMatrix);const i=this._skeleton.getPoseMatrix();i&&this._absoluteTransform.multiplyToRef(i,this._absoluteTransform)}const e=this.children,t=e.length;for(let i=0;i<t;i++)e[i].computeAbsoluteTransforms()}getDirection(e,t=null){const i=g.Zero();return this.getDirectionToRef(e,t,i),i}getDirectionToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const r=Pt._TmpMats[0];r.copyFrom(this.getAbsoluteTransform()),t&&s&&r.multiplyToRef(s,r),g.TransformNormalToRef(e,r,i),i.normalize()}getRotation(e=Ze.LOCAL,t=null){const i=g.Zero();return this.getRotationToRef(e,t,i),i}getRotationToRef(e=Ze.LOCAL,t=null,i){const s=Pt._TmpQuat;this.getRotationQuaternionToRef(e,t,s),s.toEulerAnglesToRef(i)}getRotationQuaternion(e=Ze.LOCAL,t=null){const i=Q.Identity();return this.getRotationQuaternionToRef(e,t,i),i}getRotationQuaternionToRef(e=Ze.LOCAL,t=null,i){if(e==Ze.LOCAL)this._decompose(),i.copyFrom(this._localRotation);else{const s=Pt._TmpMats[0],r=this.getAbsoluteTransform();t?r.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(r),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.decompose(void 0,i,void 0)}}getRotationMatrix(e=Ze.LOCAL,t){const i=L.Identity();return this.getRotationMatrixToRef(e,t,i),i}getRotationMatrixToRef(e=Ze.LOCAL,t,i){if(e==Ze.LOCAL)this.getLocalMatrix().getRotationMatrixToRef(i);else{const s=Pt._TmpMats[0],r=this.getAbsoluteTransform();t?r.multiplyToRef(t.getWorldMatrix(),s):s.copyFrom(r),s.multiplyAtIndex(0,this._scalingDeterminant),s.multiplyAtIndex(1,this._scalingDeterminant),s.multiplyAtIndex(2,this._scalingDeterminant),s.getRotationMatrixToRef(i)}}getAbsolutePositionFromLocal(e,t=null){const i=g.Zero();return this.getAbsolutePositionFromLocalToRef(e,t,i),i}getAbsolutePositionFromLocalToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();let r=Pt._TmpMats[0];t&&s?(r.copyFrom(this.getAbsoluteTransform()),r.multiplyToRef(s,r)):r=this.getAbsoluteTransform(),g.TransformCoordinatesToRef(e,r,i)}getLocalPositionFromAbsolute(e,t=null){const i=g.Zero();return this.getLocalPositionFromAbsoluteToRef(e,t,i),i}getLocalPositionFromAbsoluteToRef(e,t=null,i){let s=null;t&&(s=t.getWorldMatrix()),this._skeleton.computeAbsoluteTransforms();const r=Pt._TmpMats[0];r.copyFrom(this.getAbsoluteTransform()),t&&s&&r.multiplyToRef(s,r),r.invert(),g.TransformCoordinatesToRef(e,r,i)}setCurrentPoseAsRest(){this.setRestPose(this.getLocalMatrix())}}Pt._TmpVecs=gi.BuildArray(2,g.Zero);Pt._TmpQuat=Q.Identity();Pt._TmpMats=gi.BuildArray(5,L.Identity);class R_{constructor(e,t,i=0,s=100,r=!1,n=1,o,l,h,c=!1){this.target=t,this.fromFrame=i,this.toFrame=s,this.loopAnimation=r,this.onAnimationEnd=o,this.onAnimationLoop=h,this.isAdditive=c,this._localDelayOffset=null,this._pausedDelay=null,this._manualJumpDelay=null,this._runtimeAnimations=new Array,this._paused=!1,this._speedRatio=1,this._weight=-1,this._syncRoot=null,this._frameToSyncFromJump=null,this.disposeOnEnd=!0,this.animationStarted=!1,this.onAnimationEndObservable=new X,this.onAnimationLoopObservable=new X,this._scene=e,l&&this.appendAnimations(t,l),this._speedRatio=n,e._activeAnimatables.push(this)}get syncRoot(){return this._syncRoot}get masterFrame(){return this._runtimeAnimations.length===0?0:this._runtimeAnimations[0].currentFrame}get weight(){return this._weight}set weight(e){if(e===-1){this._weight=-1;return}this._weight=Math.min(Math.max(e,0),1)}get speedRatio(){return this._speedRatio}set speedRatio(e){for(let t=0;t<this._runtimeAnimations.length;t++)this._runtimeAnimations[t]._prepareForSpeedRatioChange(e);this._speedRatio=e}syncWith(e){if(this._syncRoot=e,e){const t=this._scene._activeAnimatables.indexOf(this);t>-1&&(this._scene._activeAnimatables.splice(t,1),this._scene._activeAnimatables.push(this))}return this}getAnimations(){return this._runtimeAnimations}appendAnimations(e,t){for(let i=0;i<t.length;i++){const s=t[i],r=new A1(e,s,this._scene,this);r._onLoop=()=>{this.onAnimationLoopObservable.notifyObservers(this),this.onAnimationLoop&&this.onAnimationLoop()},this._runtimeAnimations.push(r)}}getAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i].animation;return null}getRuntimeAnimationByTargetProperty(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)if(t[i].animation.targetProperty===e)return t[i];return null}reset(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].reset(!0);this._localDelayOffset=null,this._pausedDelay=null}enableBlending(e){const t=this._runtimeAnimations;for(let i=0;i<t.length;i++)t[i].animation.enableBlending=!0,t[i].animation.blendingSpeed=e}disableBlending(){const e=this._runtimeAnimations;for(let t=0;t<e.length;t++)e[t].animation.enableBlending=!1}goToFrame(e){var t;const i=this._runtimeAnimations;if(i[0]){const s=i[0].animation.framePerSecond;this._frameToSyncFromJump=(t=this._frameToSyncFromJump)!==null&&t!==void 0?t:i[0].currentFrame;const r=this.speedRatio===0?0:(e-this._frameToSyncFromJump)/s*1e3/this.speedRatio;this._manualJumpDelay=-r}for(let s=0;s<i.length;s++)i[s].goToFrame(e)}pause(){this._paused||(this._paused=!0)}restart(){this._paused=!1}_raiseOnAnimationEnd(){this.onAnimationEnd&&this.onAnimationEnd(),this.onAnimationEndObservable.notifyObservers(this)}stop(e,t){if(e||t){const i=this._scene._activeAnimatables.indexOf(this);if(i>-1){const s=this._runtimeAnimations;for(let r=s.length-1;r>=0;r--){const n=s[r];e&&n.animation.name!=e||t&&!t(n.target)||(n.dispose(),s.splice(r,1))}s.length==0&&(this._scene._activeAnimatables.splice(i,1),this._raiseOnAnimationEnd())}}else{const i=this._scene._activeAnimatables.indexOf(this);if(i>-1){this._scene._activeAnimatables.splice(i,1);const s=this._runtimeAnimations;for(let r=0;r<s.length;r++)s[r].dispose();this._raiseOnAnimationEnd()}}}waitAsync(){return new Promise(e=>{this.onAnimationEndObservable.add(()=>{e(this)},void 0,void 0,this,!0)})}_animate(e){if(this._paused)return this.animationStarted=!1,this._pausedDelay===null&&(this._pausedDelay=e),!0;if(this._localDelayOffset===null?(this._localDelayOffset=e,this._pausedDelay=null):this._pausedDelay!==null&&(this._localDelayOffset+=e-this._pausedDelay,this._pausedDelay=null),this._manualJumpDelay!==null&&(this._localDelayOffset+=this._manualJumpDelay,this._manualJumpDelay=null,this._frameToSyncFromJump=null),this._weight===0)return!0;let t=!1;const i=this._runtimeAnimations;let s;for(s=0;s<i.length;s++){const n=i[s].animate(e-this._localDelayOffset,this.fromFrame,this.toFrame,this.loopAnimation,this._speedRatio,this._weight);t=t||n}if(this.animationStarted=t,!t){if(this.disposeOnEnd)for(s=this._scene._activeAnimatables.indexOf(this),this._scene._activeAnimatables.splice(s,1),s=0;s<i.length;s++)i[s].dispose();this._raiseOnAnimationEnd(),this.disposeOnEnd&&(this.onAnimationEnd=null,this.onAnimationLoop=null,this.onAnimationLoopObservable.clear(),this.onAnimationEndObservable.clear())}return t}}ge.prototype._animate=function(){if(!this.animationsEnabled)return;const a=ps.Now;if(!this._animationTimeLast){if(this._pendingData.length>0)return;this._animationTimeLast=a}this.deltaTime=this.useConstantAnimationDeltaTime?16:(a-this._animationTimeLast)*this.animationTimeScale,this._animationTimeLast=a;const e=this._activeAnimatables;if(e.length===0)return;this._animationTime+=this.deltaTime;const t=this._animationTime;for(let i=0;i<e.length;i++){const s=e[i];!s._animate(t)&&s.disposeOnEnd&&i--}this._processLateAnimationBindings()};ge.prototype.beginWeightedAnimation=function(a,e,t,i=1,s,r=1,n,o,l,h,c=!1){const u=this.beginAnimation(a,e,t,s,r,n,o,!1,l,h,c);return u.weight=i,u};ge.prototype.beginAnimation=function(a,e,t,i,s=1,r,n,o=!0,l,h,c=!1){e>t&&s>0&&(s*=-1),o&&this.stopAnimation(a,void 0,l),n||(n=new R_(this,a,e,t,i,s,r,void 0,h,c));const u=l?l(a):!0;if(a.animations&&u&&n.appendAnimations(a,a.animations),a.getAnimatables){const d=a.getAnimatables();for(let f=0;f<d.length;f++)this.beginAnimation(d[f],e,t,i,s,r,n,o,l,h)}return n.reset(),n};ge.prototype.beginHierarchyAnimation=function(a,e,t,i,s,r=1,n,o,l=!0,h,c,u=!1){const d=a.getDescendants(e),f=[];f.push(this.beginAnimation(a,t,i,s,r,n,o,l,h,void 0,u));for(const p of d)f.push(this.beginAnimation(p,t,i,s,r,n,o,l,h,void 0,u));return f};ge.prototype.beginDirectAnimation=function(a,e,t,i,s,r,n,o,l=!1){if(r===void 0&&(r=1),t>i&&r>0)r*=-1;else if(i>t&&r<0){const c=i;i=t,t=c}return new R_(this,a,t,i,s,r,n,e,o,l)};ge.prototype.beginDirectHierarchyAnimation=function(a,e,t,i,s,r,n,o,l,h=!1){const c=a.getDescendants(e),u=[];u.push(this.beginDirectAnimation(a,t,i,s,r,n,o,l,h));for(const d of c)u.push(this.beginDirectAnimation(d,t,i,s,r,n,o,l,h));return u};ge.prototype.getAnimatableByTarget=function(a){for(let e=0;e<this._activeAnimatables.length;e++)if(this._activeAnimatables[e].target===a)return this._activeAnimatables[e];return null};ge.prototype.getAllAnimatablesByTarget=function(a){const e=[];for(let t=0;t<this._activeAnimatables.length;t++)this._activeAnimatables[t].target===a&&e.push(this._activeAnimatables[t]);return e};ge.prototype.stopAnimation=function(a,e,t){const i=this.getAllAnimatablesByTarget(a);for(const s of i)s.stop(e,t)};ge.prototype.stopAllAnimations=function(){if(this._activeAnimatables){for(let a=0;a<this._activeAnimatables.length;a++)this._activeAnimatables[a].stop();this._activeAnimatables.length=0}for(const a of this.animationGroups)a.stop()};ge.prototype._registerTargetForLateAnimationBinding=function(a,e){const t=a.target;this._registeredForLateAnimationBindings.pushNoDuplicate(t),t._lateAnimationHolders||(t._lateAnimationHolders={}),t._lateAnimationHolders[a.targetPath]||(t._lateAnimationHolders[a.targetPath]={totalWeight:0,totalAdditiveWeight:0,animations:[],additiveAnimations:[],originalValue:e}),a.isAdditive?(t._lateAnimationHolders[a.targetPath].additiveAnimations.push(a),t._lateAnimationHolders[a.targetPath].totalAdditiveWeight+=a.weight):(t._lateAnimationHolders[a.targetPath].animations.push(a),t._lateAnimationHolders[a.targetPath].totalWeight+=a.weight)};ge.prototype._processLateAnimationBindingsForMatrices=function(a){if(a.totalWeight===0&&a.totalAdditiveWeight===0)return a.originalValue;let e=1;const t=G.Vector3[0],i=G.Vector3[1],s=G.Quaternion[0];let r=0;const n=a.animations[0],o=a.originalValue;let l=1,h=!1;if(a.totalWeight<1)l=1-a.totalWeight,o.decompose(i,s,t);else{if(r=1,e=a.totalWeight,l=n.weight/e,l==1)if(a.totalAdditiveWeight)h=!0;else return n.currentValue;n.currentValue.decompose(i,s,t)}if(!h){i.scaleInPlace(l),t.scaleInPlace(l),s.scaleInPlace(l);for(let u=r;u<a.animations.length;u++){const d=a.animations[u];if(d.weight===0)continue;l=d.weight/e;const f=G.Vector3[2],p=G.Vector3[3],_=G.Quaternion[1];d.currentValue.decompose(p,_,f),p.scaleAndAddToRef(l,i),_.scaleAndAddToRef(Q.Dot(s,_)>0?l:-l,s),f.scaleAndAddToRef(l,t)}s.normalize()}for(let u=0;u<a.additiveAnimations.length;u++){const d=a.additiveAnimations[u];if(d.weight===0)continue;const f=G.Vector3[2],p=G.Vector3[3],_=G.Quaternion[1];d.currentValue.decompose(p,_,f),p.multiplyToRef(i,p),g.LerpToRef(i,p,d.weight,i),s.multiplyToRef(_,_),Q.SlerpToRef(s,_,d.weight,s),f.scaleAndAddToRef(d.weight,t)}const c=n?n._animationState.workValue:G.Matrix[0].clone();return L.ComposeToRef(i,s,t,c),c};ge.prototype._processLateAnimationBindingsForQuaternions=function(a,e){if(a.totalWeight===0&&a.totalAdditiveWeight===0)return e;const t=a.animations[0],i=a.originalValue;let s=e;if(a.totalWeight===0&&a.totalAdditiveWeight>0)s.copyFrom(i);else if(a.animations.length===1){if(Q.SlerpToRef(i,t.currentValue,Math.min(1,a.totalWeight),s),a.totalAdditiveWeight===0)return s}else if(a.animations.length>1){let r=1,n,o;if(a.totalWeight<1){const h=1-a.totalWeight;n=[],o=[],n.push(i),o.push(h)}else{if(a.animations.length===2&&(Q.SlerpToRef(a.animations[0].currentValue,a.animations[1].currentValue,a.animations[1].weight/a.totalWeight,e),a.totalAdditiveWeight===0))return e;n=[],o=[],r=a.totalWeight}for(let h=0;h<a.animations.length;h++){const c=a.animations[h];n.push(c.currentValue),o.push(c.weight/r)}let l=0;for(let h=0;h<n.length;){if(!h){Q.SlerpToRef(n[h],n[h+1],o[h+1]/(o[h]+o[h+1]),e),s=e,l=o[h]+o[h+1],h+=2;continue}l+=o[h],Q.SlerpToRef(s,n[h],o[h]/l,s),h++}}for(let r=0;r<a.additiveAnimations.length;r++){const n=a.additiveAnimations[r];n.weight!==0&&(s.multiplyToRef(n.currentValue,G.Quaternion[0]),Q.SlerpToRef(s,G.Quaternion[0],n.weight,s))}return s};ge.prototype._processLateAnimationBindings=function(){if(!!this._registeredForLateAnimationBindings.length){for(let a=0;a<this._registeredForLateAnimationBindings.length;a++){const e=this._registeredForLateAnimationBindings.data[a];for(const t in e._lateAnimationHolders){const i=e._lateAnimationHolders[t],s=i.animations[0],r=i.originalValue;if(r==null)continue;const n=ae.AllowMatrixDecomposeForInterpolation&&r.m;let o=e[t];if(n)o=this._processLateAnimationBindingsForMatrices(i);else if(r.w!==void 0)o=this._processLateAnimationBindingsForQuaternions(i,o||Q.Identity());else{let h=0,c=1;if(i.totalWeight<1)s&&r.scale?o=r.scale(1-i.totalWeight):s?o=r*(1-i.totalWeight):r.clone?o=r.clone():o=r;else if(s){c=i.totalWeight;const u=s.weight/c;u!==1?s.currentValue.scale?o=s.currentValue.scale(u):o=s.currentValue*u:o=s.currentValue,h=1}for(let u=h;u<i.animations.length;u++){const d=i.animations[u],f=d.weight/c;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f;else continue}for(let u=0;u<i.additiveAnimations.length;u++){const d=i.additiveAnimations[u],f=d.weight;if(f)d.currentValue.scaleAndAddToRef?d.currentValue.scaleAndAddToRef(f,o):o+=d.currentValue*f;else continue}}e[t]=o}e._lateAnimationHolders={}}this._registeredForLateAnimationBindings.reset()}};Pt.prototype.copyAnimationRange=function(a,e,t,i=!1,s=null){this.animations.length===0&&(this.animations.push(new ae(this.name,"_matrix",a.animations[0].framePerSecond,ae.ANIMATIONTYPE_MATRIX,0)),this.animations[0].setKeys([]));const r=a.animations[0].getRange(e);if(!r)return!1;const n=r.from,o=r.to,l=a.animations[0].getKeys(),h=a.length,c=a.getParent(),u=this.getParent(),d=i&&c&&h&&this.length&&h!==this.length,f=d&&u&&c?u.length/c.length:1,p=i&&!u&&s&&(s.x!==1||s.y!==1||s.z!==1),_=this.animations[0].getKeys();let m,v,x;for(let b=0,S=l.length;b<S;b++)m=l[b],m.frame>=n&&m.frame<=o&&(i?(x=m.value.clone(),d?(v=x.getTranslation(),x.setTranslation(v.scaleInPlace(f))):p&&s?(v=x.getTranslation(),x.setTranslation(v.multiplyInPlace(s))):x=m.value):x=m.value,_.push({frame:m.frame+t,value:x}));return this.animations[0].createRange(e,n+t,o+t),!0};class R1{getClassName(){return"TargetedAnimation"}serialize(){const e={};return e.animation=this.animation.serialize(),e.targetId=this.target.id,e}}class Qh{constructor(e,t=null){this.name=e,this._targetedAnimations=new Array,this._animatables=new Array,this._from=Number.MAX_VALUE,this._to=-Number.MAX_VALUE,this._speedRatio=1,this._loopAnimation=!1,this._isAdditive=!1,this._parentContainer=null,this.onAnimationEndObservable=new X,this.onAnimationLoopObservable=new X,this.onAnimationGroupLoopObservable=new X,this.onAnimationGroupEndObservable=new X,this.onAnimationGroupPauseObservable=new X,this.onAnimationGroupPlayObservable=new X,this.metadata=null,this._animationLoopFlags=[],this._scene=t||ye.LastCreatedScene,this.uniqueId=this._scene.getUniqueId(),this._scene.addAnimationGroup(this)}get from(){return this._from}get to(){return this._to}get isStarted(){return this._isStarted}get isPlaying(){return this._isStarted&&!this._isPaused}get speedRatio(){return this._speedRatio}set speedRatio(e){if(this._speedRatio!==e){this._speedRatio=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.speedRatio=this._speedRatio}}}get loopAnimation(){return this._loopAnimation}set loopAnimation(e){if(this._loopAnimation!==e){this._loopAnimation=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.loopAnimation=this._loopAnimation}}}get isAdditive(){return this._isAdditive}set isAdditive(e){if(this._isAdditive!==e){this._isAdditive=e;for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.isAdditive=this._isAdditive}}}get targetedAnimations(){return this._targetedAnimations}get animatables(){return this._animatables}get children(){return this._targetedAnimations}addTargetedAnimation(e,t){const i=new R1;i.animation=e,i.target=t;const s=e.getKeys();return this._from>s[0].frame&&(this._from=s[0].frame),this._to<s[s.length-1].frame&&(this._to=s[s.length-1].frame),this._targetedAnimations.push(i),i}normalize(e=null,t=null){e==null&&(e=this._from),t==null&&(t=this._to);for(let i=0;i<this._targetedAnimations.length;i++){const r=this._targetedAnimations[i].animation.getKeys(),n=r[0],o=r[r.length-1];if(n.frame>e){const l={frame:e,value:n.value,inTangent:n.inTangent,outTangent:n.outTangent,interpolation:n.interpolation};r.splice(0,0,l)}if(o.frame<t){const l={frame:t,value:o.value,inTangent:o.inTangent,outTangent:o.outTangent,interpolation:o.interpolation};r.push(l)}}return this._from=e,this._to=t,this}_processLoop(e,t,i){e.onAnimationLoop=()=>{this.onAnimationLoopObservable.notifyObservers(t),!this._animationLoopFlags[i]&&(this._animationLoopFlags[i]=!0,this._animationLoopCount++,this._animationLoopCount===this._targetedAnimations.length&&(this.onAnimationGroupLoopObservable.notifyObservers(this),this._animationLoopCount=0,this._animationLoopFlags.length=0))}}start(e=!1,t=1,i,s,r){if(this._isStarted||this._targetedAnimations.length===0)return this;this._loopAnimation=e,this._animationLoopCount=0,this._animationLoopFlags.length=0;for(let n=0;n<this._targetedAnimations.length;n++){const o=this._targetedAnimations[n],l=this._scene.beginDirectAnimation(o.target,[o.animation],i!==void 0?i:this._from,s!==void 0?s:this._to,e,t,void 0,void 0,r!==void 0?r:this._isAdditive);l.onAnimationEnd=()=>{this.onAnimationEndObservable.notifyObservers(o),this._checkAnimationGroupEnded(l)},this._processLoop(l,o,n),this._animatables.push(l)}return this._speedRatio=t,this._isStarted=!0,this._isPaused=!1,this.onAnimationGroupPlayObservable.notifyObservers(this),this}pause(){if(!this._isStarted)return this;this._isPaused=!0;for(let e=0;e<this._animatables.length;e++)this._animatables[e].pause();return this.onAnimationGroupPauseObservable.notifyObservers(this),this}play(e){return this.isStarted&&this._animatables.length===this._targetedAnimations.length?(e!==void 0&&(this.loopAnimation=e),this.restart()):(this.stop(),this.start(e,this._speedRatio)),this._isPaused=!1,this}reset(){if(!this._isStarted)return this.play(),this.goToFrame(0),this.stop(),this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].reset();return this}restart(){if(!this._isStarted)return this;for(let e=0;e<this._animatables.length;e++)this._animatables[e].restart();return this.onAnimationGroupPlayObservable.notifyObservers(this),this}stop(){if(!this._isStarted)return this;const e=this._animatables.slice();for(let t=0;t<e.length;t++)e[t].stop();return this._isStarted=!1,this}setWeightForAllAnimatables(e){for(let t=0;t<this._animatables.length;t++){const i=this._animatables[t];i.weight=e}return this}syncAllAnimationsWith(e){for(let t=0;t<this._animatables.length;t++)this._animatables[t].syncWith(e);return this}goToFrame(e){if(!this._isStarted)return this;for(let t=0;t<this._animatables.length;t++)this._animatables[t].goToFrame(e);return this}dispose(){this._targetedAnimations.length=0,this._animatables.length=0;const e=this._scene.animationGroups.indexOf(this);if(e>-1&&this._scene.animationGroups.splice(e,1),this._parentContainer){const t=this._parentContainer.animationGroups.indexOf(this);t>-1&&this._parentContainer.animationGroups.splice(t,1),this._parentContainer=null}this.onAnimationEndObservable.clear(),this.onAnimationGroupEndObservable.clear(),this.onAnimationGroupPauseObservable.clear(),this.onAnimationGroupPlayObservable.clear(),this.onAnimationLoopObservable.clear(),this.onAnimationGroupLoopObservable.clear()}_checkAnimationGroupEnded(e){const t=this._animatables.indexOf(e);t>-1&&this._animatables.splice(t,1),this._animatables.length===0&&(this._isStarted=!1,this.onAnimationGroupEndObservable.notifyObservers(this))}clone(e,t,i=!1){const s=new Qh(e||this.name,this._scene);for(const r of this._targetedAnimations)s.addTargetedAnimation(i?r.animation.clone():r.animation,t?t(r.target):r.target);return s}serialize(){const e={};e.name=this.name,e.from=this.from,e.to=this.to,e.targetedAnimations=[];for(let t=0;t<this.targetedAnimations.length;t++){const i=this.targetedAnimations[t];e.targetedAnimations[t]=i.serialize()}return ot&&ot.HasTags(this)&&(e.tags=ot.GetTags(this)),this.metadata&&(e.metadata=this.metadata),e}static Parse(e,t){const i=new Qh(e.name,t);for(let s=0;s<e.targetedAnimations.length;s++){const r=e.targetedAnimations[s],n=ae.Parse(r.animation),o=r.targetId;if(r.animation.property==="influence"){const l=t.getMorphTargetById(o);l&&i.addTargetedAnimation(n,l)}else{const l=t.getNodeById(o);l!=null&&i.addTargetedAnimation(n,l)}}return e.from!==null&&e.to!==null&&i.normalize(e.from,e.to),ot&&ot.AddTagsTo(i,e.tags),e.metadata!==void 0&&(i.metadata=e.metadata),i}static MakeAnimationAdditive(e,t=0,i,s=!1,r){let n=e;s&&(n=e.clone(r||n.name));const o=n.targetedAnimations;for(let l=0;l<o.length;l++){const h=o[l];ae.MakeAnimationAdditive(h.animation,t,i)}return n.isAdditive=!0,n}getClassName(){return"AnimationGroup"}toString(e){let t="Name: "+this.name;return t+=", type: "+this.getClassName(),e&&(t+=", from: "+this._from,t+=", to: "+this._to,t+=", isStarted: "+this._isStarted,t+=", speedRatio: "+this._speedRatio,t+=", targetedAnimations length: "+this._targetedAnimations.length,t+=", animatables length: "+this._animatables),t}}class I1 extends li{}class P1{constructor(){this.rootNodes=[],this.skeletons=[],this.animationGroups=[]}}class I_ extends li{constructor(e){super(),this._wasAddedToScene=!1,e=e||ye.LastCreatedScene,e&&(this.scene=e,this.sounds=[],this.effectLayers=[],this.layers=[],this.lensFlareSystems=[],this.proceduralTextures=[],this.reflectionProbes=[],e.onDisposeObservable.add(()=>{this._wasAddedToScene||this.dispose()}),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{for(const t of this.geometries)t._rebuild();for(const t of this.meshes)t._rebuild();for(const t of this.particleSystems)t.rebuild();for(const t of this.textures)t._rebuild()}))}instantiateModelsToScene(e,t=!1,i){const s={},r={},n=new P1,o=[],l=[],h={doNotInstantiate:!0,...i};h.doNotInstantiate||(h.doNotInstantiate=p=>!!p.skeleton);const c=(p,_)=>{if(s[p.uniqueId]=_.uniqueId,r[_.uniqueId]=_,e&&(_.name=e(p.name)),_ instanceof V){const m=_;if(m.morphTargetManager){const v=p.morphTargetManager;m.morphTargetManager=v.clone();for(let x=0;x<v.numTargets;x++){const b=v.getTarget(x),S=m.morphTargetManager.getTarget(x);s[b.uniqueId]=S.uniqueId,r[S.uniqueId]=S}}}};this.transformNodes.forEach(p=>{if(!(h.predicate&&!h.predicate(p))&&!p.parent){const _=p.instantiateHierarchy(null,h,(m,v)=>{c(m,v)});_&&n.rootNodes.push(_)}});const u=this.meshes.some(p=>p.getClassName()==="InstancedMesh"),d=[],f=(p,_)=>{if(c(p,_),_.material){const m=_;if(m.material)if(t){const v=p.material;if(l.indexOf(v)===-1){let x=v.clone(e?e(v.name):"Clone of "+v.name);if(l.push(v),s[v.uniqueId]=x.uniqueId,r[x.uniqueId]=x,v.getClassName()==="MultiMaterial"){const b=v;for(const S of b.subMaterials)!S||(x=S.clone(e?e(S.name):"Clone of "+S.name),l.push(S),s[S.uniqueId]=x.uniqueId,r[x.uniqueId]=x);b.subMaterials=b.subMaterials.map(S=>S&&r[s[S.uniqueId]])}}m.getClassName()!=="InstancedMesh"&&(m.material=r[s[v.uniqueId]])}else m.material.getClassName()==="MultiMaterial"?this.scene.multiMaterials.indexOf(m.material)===-1&&this.scene.addMultiMaterial(m.material):this.scene.materials.indexOf(m.material)===-1&&this.scene.addMaterial(m.material)}};return this.meshes.forEach((p,_)=>{if(!(h.predicate&&!h.predicate(p))&&!p.parent){const m=p.getClassName()==="InstancedMesh";let v;if(m){const S=p.sourceMesh,C=this.meshes.indexOf(S);C!==-1&&d[C]&&(v=d[C])}const x=m?p.instantiateHierarchy(null,{...h,newSourcedMesh:v},f):p.instantiateHierarchy(null,h,f);x&&(u&&x.getClassName()!=="InstancedMesh"&&(d[_]=x),n.rootNodes.push(x))}}),this.skeletons.forEach(p=>{if(h.predicate&&!h.predicate(p))return;const _=p.clone(e?e(p.name):"Clone of "+p.name);for(const m of this.meshes)if(m.skeleton===p&&!m.isAnInstance){const v=r[s[m.uniqueId]];if(v.isAnInstance||(v.skeleton=_,o.indexOf(_)!==-1))continue;o.push(_);for(const x of _.bones)x._linkedTransformNode&&(x._linkedTransformNode=r[s[x._linkedTransformNode.uniqueId]])}n.skeletons.push(_)}),this.animationGroups.forEach(p=>{if(h.predicate&&!h.predicate(p))return;const _=p.clone(e?e(p.name):"Clone of "+p.name,m=>r[s[m.uniqueId]]||m);n.animationGroups.push(_)}),n}addAllToScene(){if(!this._wasAddedToScene){this._wasAddedToScene=!0,this.addToScene(null),this.environmentTexture&&(this.scene.environmentTexture=this.environmentTexture);for(const e of this.scene._serializableComponents)e.addFromContainer(this);this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null}}addToScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.addCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.addLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.addMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.addSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.addAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.addAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.addMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.addMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.addMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.addGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.addTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.addActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.addTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.addReflectionProbe(t)})}removeAllFromScene(){this._wasAddedToScene=!1,this.removeFromScene(null),this.environmentTexture===this.scene.environmentTexture&&(this.scene.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this)}removeFromScene(e=null){this.cameras.forEach(t=>{e&&!e(t)||this.scene.removeCamera(t)}),this.lights.forEach(t=>{e&&!e(t)||this.scene.removeLight(t)}),this.meshes.forEach(t=>{e&&!e(t)||this.scene.removeMesh(t)}),this.skeletons.forEach(t=>{e&&!e(t)||this.scene.removeSkeleton(t)}),this.animations.forEach(t=>{e&&!e(t)||this.scene.removeAnimation(t)}),this.animationGroups.forEach(t=>{e&&!e(t)||this.scene.removeAnimationGroup(t)}),this.multiMaterials.forEach(t=>{e&&!e(t)||this.scene.removeMultiMaterial(t)}),this.materials.forEach(t=>{e&&!e(t)||this.scene.removeMaterial(t)}),this.morphTargetManagers.forEach(t=>{e&&!e(t)||this.scene.removeMorphTargetManager(t)}),this.geometries.forEach(t=>{e&&!e(t)||this.scene.removeGeometry(t)}),this.transformNodes.forEach(t=>{e&&!e(t)||this.scene.removeTransformNode(t)}),this.actionManagers.forEach(t=>{e&&!e(t)||this.scene.removeActionManager(t)}),this.textures.forEach(t=>{e&&!e(t)||this.scene.removeTexture(t)}),this.reflectionProbes.forEach(t=>{e&&!e(t)||this.scene.removeReflectionProbe(t)})}dispose(){this.cameras.slice(0).forEach(e=>{e.dispose()}),this.cameras.length=0,this.lights.slice(0).forEach(e=>{e.dispose()}),this.lights.length=0,this.meshes.slice(0).forEach(e=>{e.dispose()}),this.meshes.length=0,this.skeletons.slice(0).forEach(e=>{e.dispose()}),this.skeletons.length=0,this.animationGroups.slice(0).forEach(e=>{e.dispose()}),this.animationGroups.length=0,this.multiMaterials.slice(0).forEach(e=>{e.dispose()}),this.multiMaterials.length=0,this.materials.slice(0).forEach(e=>{e.dispose()}),this.materials.length=0,this.geometries.slice(0).forEach(e=>{e.dispose()}),this.geometries.length=0,this.transformNodes.slice(0).forEach(e=>{e.dispose()}),this.transformNodes.length=0,this.actionManagers.slice(0).forEach(e=>{e.dispose()}),this.actionManagers.length=0,this.textures.slice(0).forEach(e=>{e.dispose()}),this.textures.length=0,this.reflectionProbes.slice(0).forEach(e=>{e.dispose()}),this.reflectionProbes.length=0,this.environmentTexture&&(this.environmentTexture.dispose(),this.environmentTexture=null);for(const e of this.scene._serializableComponents)e.removeFromContainer(this,!0);this._onContextRestoredObserver&&(this.scene.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}_moveAssets(e,t,i){if(!!e)for(const s of e){let r=!0;if(i){for(const n of i)if(s===n){r=!1;break}}r&&(t.push(s),s._parentContainer=this)}}moveAllFromScene(e){this._wasAddedToScene=!1,e===void 0&&(e=new I1);for(const t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=this[t]||(t==="environmentTexture"?null:[]),this._moveAssets(this.scene[t],this[t],e[t]));this.environmentTexture=this.scene.environmentTexture,this.removeAllFromScene()}createRootMesh(){const e=new V("assetContainerRootMesh",this.scene);return this.meshes.forEach(t=>{t.parent||e.addChild(t)}),this.meshes.unshift(e),e}mergeAnimationsTo(e=ye.LastCreatedScene,t,i=null){if(!e)return B.Error("No scene available to merge animations to"),[];const s=i||(o=>{let l=null;const h=o.animations.length?o.animations[0].targetProperty:"",c=o.name.split(".").join("").split("_primitive")[0];switch(h){case"position":case"rotationQuaternion":l=e.getTransformNodeByName(o.name)||e.getTransformNodeByName(c);break;case"influence":l=e.getMorphTargetByName(o.name)||e.getMorphTargetByName(c);break;default:l=e.getNodeByName(o.name)||e.getNodeByName(c)}return l});this.getNodes().forEach(o=>{const l=s(o);if(l!==null){for(const h of o.animations){const c=l.animations.filter(u=>u.targetProperty===h.targetProperty);for(const u of c){const d=l.animations.indexOf(u,0);d>-1&&l.animations.splice(d,1)}}l.animations=l.animations.concat(o.animations)}});const n=new Array;return this.animationGroups.slice().forEach(o=>{n.push(o.clone(o.name,s)),o.animatables.forEach(l=>{l.stop()})}),t.forEach(o=>{const l=s(o.target);l&&(e.beginAnimation(l,o.fromFrame,o.toFrame,o.loopAnimation,o.speedRatio,o.onAnimationEnd?o.onAnimationEnd:void 0,void 0,!0,void 0,o.onAnimationLoop?o.onAnimationLoop:void 0),e.stopAnimation(o.target))}),n}}k.AudioEngineFactory=(a,e,t)=>new M1(a,e,t);class M1{constructor(e=null,t=null,i=null){if(this._audioContext=null,this._audioContextInitialized=!1,this._muteButton=null,this._audioDestination=null,this.canUseWebAudio=!1,this.WarnedWebAudioUnsupported=!1,this.isMP3supported=!1,this.isOGGsupported=!1,this.unlocked=!0,this.useCustomUnlockedButton=!1,this.onAudioUnlockedObservable=new X,this.onAudioLockedObservable=new X,this._tryToRun=!1,this._onResize=()=>{this._moveButtonToTopLeft()},!Ht())return;typeof window.AudioContext<"u"&&(this.canUseWebAudio=!0);const s=document.createElement("audio");this._hostElement=e,this._audioContext=t,this._audioDestination=i;try{s&&!!s.canPlayType&&(s.canPlayType('audio/mpeg; codecs="mp3"').replace(/^no$/,"")||s.canPlayType("audio/mp3").replace(/^no$/,""))&&(this.isMP3supported=!0)}catch{}try{s&&!!s.canPlayType&&s.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,"")&&(this.isOGGsupported=!0)}catch{}}get audioContext(){return this._audioContextInitialized?!this.unlocked&&!this._muteButton&&this._displayMuteButton():this._initializeAudioContext(),this._audioContext}lock(){this._triggerSuspendedState()}unlock(){this._triggerRunningState()}_resumeAudioContext(){let e;return this._audioContext.resume!==void 0&&(e=this._audioContext.resume()),e||Promise.resolve()}_initializeAudioContext(){try{this.canUseWebAudio&&(this._audioContext||(this._audioContext=new AudioContext),this.masterGain=this._audioContext.createGain(),this.masterGain.gain.value=1,this._audioDestination||(this._audioDestination=this._audioContext.destination),this.masterGain.connect(this._audioDestination),this._audioContextInitialized=!0,this._audioContext.state==="running"&&this._triggerRunningState())}catch(e){this.canUseWebAudio=!1,B.Error("Web Audio: "+e.message)}}_triggerRunningState(){this._tryToRun||(this._tryToRun=!0,this._resumeAudioContext().then(()=>{this._tryToRun=!1,this._muteButton&&this._hideMuteButton(),this.unlocked=!0,this.onAudioUnlockedObservable.notifyObservers(this)}).catch(()=>{this._tryToRun=!1,this.unlocked=!1}))}_triggerSuspendedState(){this.unlocked=!1,this.onAudioLockedObservable.notifyObservers(this),this._displayMuteButton()}_displayMuteButton(){if(this.useCustomUnlockedButton||this._muteButton)return;this._muteButton=document.createElement("BUTTON"),this._muteButton.className="babylonUnmuteIcon",this._muteButton.id="babylonUnmuteIconBtn",this._muteButton.title="Unmute";const e=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20version%3D%221.1%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2239%22%20height%3D%2232%22%20viewBox%3D%220%200%2039%2032%22%3E%3Cpath%20fill%3D%22white%22%20d%3D%22M9.625%2018.938l-0.031%200.016h-4.953q-0.016%200-0.031-0.016v-12.453q0-0.016%200.031-0.016h4.953q0.031%200%200.031%200.016v12.453zM12.125%207.688l8.719-8.703v27.453l-8.719-8.719-0.016-0.047v-9.938zM23.359%207.875l1.406-1.406%204.219%204.203%204.203-4.203%201.422%201.406-4.219%204.219%204.219%204.203-1.484%201.359-4.141-4.156-4.219%204.219-1.406-1.422%204.219-4.203z%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E":"https://cdn.babylonjs.com/Assets/audio.png",t=".babylonUnmuteIcon { position: absolute; left: 20px; top: 20px; height: 40px; width: 60px; background-color: rgba(51,51,51,0.7); background-image: url("+e+");  background-size: 80%; background-repeat:no-repeat; background-position: center; background-position-y: 4px; border: none; outline: none; transition: transform 0.125s ease-out; cursor: pointer; z-index: 9999; } .babylonUnmuteIcon:hover { transform: scale(1.05) } .babylonUnmuteIcon:active { background-color: rgba(51,51,51,1) }",i=document.createElement("style");i.appendChild(document.createTextNode(t)),document.getElementsByTagName("head")[0].appendChild(i),document.body.appendChild(this._muteButton),this._moveButtonToTopLeft(),this._muteButton.addEventListener("touchend",()=>{this._triggerRunningState()},!0),this._muteButton.addEventListener("click",()=>{this._triggerRunningState()},!0),window.addEventListener("resize",this._onResize)}_moveButtonToTopLeft(){this._hostElement&&this._muteButton&&(this._muteButton.style.top=this._hostElement.offsetTop+20+"px",this._muteButton.style.left=this._hostElement.offsetLeft+20+"px")}_hideMuteButton(){this._muteButton&&(document.body.removeChild(this._muteButton),this._muteButton=null)}dispose(){this.canUseWebAudio&&this._audioContextInitialized&&(this._connectedAnalyser&&this._audioContext&&(this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser.dispose(),this.masterGain.disconnect(),this.masterGain.connect(this._audioContext.destination),this._connectedAnalyser=null),this.masterGain.gain.value=1),this.WarnedWebAudioUnsupported=!1,this._hideMuteButton(),window.removeEventListener("resize",this._onResize),this.onAudioUnlockedObservable.clear(),this.onAudioLockedObservable.clear()}getGlobalVolume(){return this.canUseWebAudio&&this._audioContextInitialized?this.masterGain.gain.value:-1}setGlobalVolume(e){this.canUseWebAudio&&this._audioContextInitialized&&(this.masterGain.gain.value=e)}connectToAnalyser(e){this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this.canUseWebAudio&&this._audioContextInitialized&&this._audioContext&&(this._connectedAnalyser=e,this.masterGain.disconnect(),this._connectedAnalyser.connectAudioNodes(this.masterGain,this._audioContext.destination))}}class Gr{constructor(e,t,i,s=null,r){var n,o,l,h,c;if(this.autoplay=!1,this._loop=!1,this.useCustomAttenuation=!1,this.isPlaying=!1,this.isPaused=!1,this.refDistance=1,this.rolloffFactor=1,this.maxDistance=100,this.distanceModel="linear",this.metadata=null,this.onEndedObservable=new X,this._spatialSound=!1,this._panningModel="equalpower",this._playbackRate=1,this._streaming=!1,this._startTime=0,this._startOffset=0,this._position=g.Zero(),this._localDirection=new g(1,0,0),this._volume=1,this._isReadyToPlay=!1,this._isDirectional=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._coneOuterGain=0,this._isOutputConnected=!1,this._urlType="Unknown",this.name=e,i=i||ye.LastCreatedScene,!!i)if(this._scene=i,Gr._SceneComponentInitialization(i),this._readyToPlayCallback=s,this._customAttenuationFunction=(u,d,f,p,_)=>d<f?u*(1-d/f):0,r&&(this.autoplay=r.autoplay||!1,this._loop=r.loop||!1,r.volume!==void 0&&(this._volume=r.volume),this._spatialSound=(n=r.spatialSound)!==null&&n!==void 0?n:!1,this.maxDistance=(o=r.maxDistance)!==null&&o!==void 0?o:100,this.useCustomAttenuation=(l=r.useCustomAttenuation)!==null&&l!==void 0?l:!1,this.rolloffFactor=r.rolloffFactor||1,this.refDistance=r.refDistance||1,this.distanceModel=r.distanceModel||"linear",this._playbackRate=r.playbackRate||1,this._streaming=(h=r.streaming)!==null&&h!==void 0?h:!1,this._length=r.length,this._offset=r.offset),((c=k.audioEngine)===null||c===void 0?void 0:c.canUseWebAudio)&&k.audioEngine.audioContext){this._soundGain=k.audioEngine.audioContext.createGain(),this._soundGain.gain.value=this._volume,this._inputAudioNode=this._soundGain,this._outputAudioNode=this._soundGain,this._spatialSound&&this._createSpatialParameters(),this._scene.mainSoundTrack.addSound(this);let u=!0;if(t)try{typeof t=="string"?this._urlType="String":t instanceof ArrayBuffer?this._urlType="ArrayBuffer":t instanceof HTMLMediaElement?this._urlType="MediaElement":t instanceof MediaStream?this._urlType="MediaStream":t instanceof AudioBuffer?this._urlType="AudioBuffer":Array.isArray(t)&&(this._urlType="Array");let d=[],f=!1;switch(this._urlType){case"MediaElement":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=k.audioEngine.audioContext.createMediaElementSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"MediaStream":this._streaming=!0,this._isReadyToPlay=!0,this._streamingSource=k.audioEngine.audioContext.createMediaStreamSource(t),this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback();break;case"ArrayBuffer":t.byteLength>0&&(f=!0,this._soundLoaded(t));break;case"AudioBuffer":this._audioBufferLoaded(t);break;case"String":d.push(t);case"Array":d.length===0&&(d=t);for(let p=0;p<d.length;p++){const _=d[p];if(f=r&&r.skipCodecCheck||_.indexOf(".mp3",_.length-4)!==-1&&k.audioEngine.isMP3supported||_.indexOf(".ogg",_.length-4)!==-1&&k.audioEngine.isOGGsupported||_.indexOf(".wav",_.length-4)!==-1||_.indexOf(".m4a",_.length-4)!==-1||_.indexOf(".mp4",_.length-4)!==-1||_.indexOf("blob:")!==-1,f){this._streaming?(this._htmlAudioElement=new Audio(_),this._htmlAudioElement.controls=!1,this._htmlAudioElement.loop=this.loop,q.SetCorsBehavior(_,this._htmlAudioElement),this._htmlAudioElement.preload="auto",this._htmlAudioElement.addEventListener("canplaythrough",()=>{this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback()}),document.body.appendChild(this._htmlAudioElement),this._htmlAudioElement.load()):this._scene._loadFile(_,m=>{this._soundLoaded(m)},void 0,!0,!0,m=>{m&&B.Error("XHR "+m.status+" error on: "+_+"."),B.Error("Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)});break}}break;default:u=!1;break}u?f||(this._isReadyToPlay=!0,this._readyToPlayCallback&&window.setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)):B.Error("Parameter must be a URL to the sound, an Array of URLs (.mp3 & .ogg) or an ArrayBuffer of the sound.")}catch{B.Error("Unexpected error. Sound creation aborted."),this._scene.mainSoundTrack.removeSound(this)}}else this._scene.mainSoundTrack.addSound(this),k.audioEngine&&!k.audioEngine.WarnedWebAudioUnsupported&&(B.Error("Web Audio is not supported by your browser."),k.audioEngine.WarnedWebAudioUnsupported=!0),this._readyToPlayCallback&&window.setTimeout(()=>{this._readyToPlayCallback&&this._readyToPlayCallback()},1e3)}get loop(){return this._loop}set loop(e){e!==this._loop&&(this._loop=e,this.updateOptions({loop:e}))}get currentTime(){var e;if(this._htmlAudioElement)return this._htmlAudioElement.currentTime;let t=this._startOffset;return this.isPlaying&&((e=k.audioEngine)===null||e===void 0?void 0:e.audioContext)&&(t+=k.audioEngine.audioContext.currentTime-this._startTime),t}get spatialSound(){return this._spatialSound}set spatialSound(e){var t;this._spatialSound=e,this._spatialSound&&((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&k.audioEngine.audioContext&&this._createSpatialParameters()}dispose(){var e;!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio&&(this.isPlaying&&this.stop(),this._isReadyToPlay=!1,this.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(this):this._scene.soundTracks&&this._scene.soundTracks[this.soundTrackId].removeSound(this),this._soundGain&&(this._soundGain.disconnect(),this._soundGain=null),this._soundPanner&&(this._soundPanner.disconnect(),this._soundPanner=null),this._soundSource&&(this._soundSource.disconnect(),this._soundSource=null),this._audioBuffer=null,this._htmlAudioElement&&(this._htmlAudioElement.pause(),this._htmlAudioElement.src="",document.body.removeChild(this._htmlAudioElement)),this._streamingSource&&this._streamingSource.disconnect(),this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._connectedTransformNode=null))}isReady(){return this._isReadyToPlay}getClassName(){return"Sound"}_audioBufferLoaded(e){var t;!(!((t=k.audioEngine)===null||t===void 0)&&t.audioContext)||(this._audioBuffer=e,this._isReadyToPlay=!0,this.autoplay&&this.play(0,this._offset,this._length),this._readyToPlayCallback&&this._readyToPlayCallback())}_soundLoaded(e){var t;!(!((t=k.audioEngine)===null||t===void 0)&&t.audioContext)||k.audioEngine.audioContext.decodeAudioData(e,i=>{this._audioBufferLoaded(i)},i=>{B.Error("Error while decoding audio data for: "+this.name+" / Error: "+i)})}setAudioBuffer(e){var t;!((t=k.audioEngine)===null||t===void 0)&&t.canUseWebAudio&&(this._audioBuffer=e,this._isReadyToPlay=!0)}updateOptions(e){var t,i,s,r,n,o,l,h,c,u;e&&(this.loop=(t=e.loop)!==null&&t!==void 0?t:this.loop,this.maxDistance=(i=e.maxDistance)!==null&&i!==void 0?i:this.maxDistance,this.useCustomAttenuation=(s=e.useCustomAttenuation)!==null&&s!==void 0?s:this.useCustomAttenuation,this.rolloffFactor=(r=e.rolloffFactor)!==null&&r!==void 0?r:this.rolloffFactor,this.refDistance=(n=e.refDistance)!==null&&n!==void 0?n:this.refDistance,this.distanceModel=(o=e.distanceModel)!==null&&o!==void 0?o:this.distanceModel,this._playbackRate=(l=e.playbackRate)!==null&&l!==void 0?l:this._playbackRate,this._length=(h=e.length)!==null&&h!==void 0?h:void 0,this._offset=(c=e.offset)!==null&&c!==void 0?c:void 0,this.setVolume((u=e.volume)!==null&&u!==void 0?u:this._volume),this._updateSpatialParameters(),this.isPlaying&&(this._streaming&&this._htmlAudioElement?(this._htmlAudioElement.playbackRate=this._playbackRate,this._htmlAudioElement.loop!==this.loop&&(this._htmlAudioElement.loop=this.loop)):this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.loop!==this.loop&&(this._soundSource.loop=this.loop),this._offset!==void 0&&this._soundSource.loopStart!==this._offset&&(this._soundSource.loopStart=this._offset),this._length!==void 0&&this._length!==this._soundSource.loopEnd&&(this._soundSource.loopEnd=(this._offset|0)+this._length))))}_createSpatialParameters(){var e,t;((e=k.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&k.audioEngine.audioContext&&(this._scene.headphone&&(this._panningModel="HRTF"),this._soundPanner=(t=this._soundPanner)!==null&&t!==void 0?t:k.audioEngine.audioContext.createPanner(),this._soundPanner&&this._outputAudioNode&&(this._updateSpatialParameters(),this._soundPanner.connect(this._outputAudioNode),this._inputAudioNode=this._soundPanner))}_updateSpatialParameters(){this._spatialSound&&this._soundPanner&&(this.useCustomAttenuation?(this._soundPanner.distanceModel="linear",this._soundPanner.maxDistance=Number.MAX_VALUE,this._soundPanner.refDistance=1,this._soundPanner.rolloffFactor=1,this._soundPanner.panningModel=this._panningModel):(this._soundPanner.distanceModel=this.distanceModel,this._soundPanner.maxDistance=this.maxDistance,this._soundPanner.refDistance=this.refDistance,this._soundPanner.rolloffFactor=this.rolloffFactor,this._soundPanner.panningModel=this._panningModel))}switchPanningModelToHRTF(){this._panningModel="HRTF",this._switchPanningModel()}switchPanningModelToEqualPower(){this._panningModel="equalpower",this._switchPanningModel()}_switchPanningModel(){var e;((e=k.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.panningModel=this._panningModel)}connectToSoundTrackAudioNode(e){var t;((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._isOutputConnected&&this._outputAudioNode.disconnect(),this._outputAudioNode.connect(e),this._isOutputConnected=!0)}setDirectionalCone(e,t,i){if(t<e){B.Error("setDirectionalCone(): outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,this._coneOuterAngle=t,this._coneOuterGain=i,this._isDirectional=!0,this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){var t;if(e!=this._coneInnerAngle){if(this._coneOuterAngle<e){B.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e,((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle)}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){var t;if(e!=this._coneOuterAngle){if(e<this._coneInnerAngle){B.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e,((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&(this._soundPanner.coneOuterAngle=this._coneOuterAngle)}}setPosition(e){var t;e.equals(this._position)||(this._position.copyFrom(e),((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._spatialSound&&this._soundPanner&&!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z))}setLocalDirectionToMesh(e){var t;this._localDirection=e,((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._connectedTransformNode&&this.isPlaying&&this._updateDirection()}_updateDirection(){if(!this._connectedTransformNode||!this._soundPanner)return;const e=this._connectedTransformNode.getWorldMatrix(),t=g.TransformNormal(this._localDirection,e);t.normalize(),this._soundPanner.orientationX.value=t.x,this._soundPanner.orientationY.value=t.y,this._soundPanner.orientationZ.value=t.z}updateDistanceFromListener(){var e;if(((e=k.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&this._connectedTransformNode&&this.useCustomAttenuation&&this._soundGain&&this._scene.activeCamera){const t=this._connectedTransformNode.getDistanceToCamera(this._scene.activeCamera);this._soundGain.gain.value=this._customAttenuationFunction(this._volume,t,this.maxDistance,this.refDistance,this.rolloffFactor)}}setAttenuationFunction(e){this._customAttenuationFunction=e}play(e,t,i){var s,r,n,o;if(this._isReadyToPlay&&this._scene.audioEnabled&&((s=k.audioEngine)===null||s===void 0?void 0:s.audioContext))try{this._startOffset<0&&(e=-this._startOffset,this._startOffset=0);let l=e?((r=k.audioEngine)===null||r===void 0?void 0:r.audioContext.currentTime)+e:(n=k.audioEngine)===null||n===void 0?void 0:n.audioContext.currentTime;if((!this._soundSource||!this._streamingSource)&&this._spatialSound&&this._soundPanner&&(!isNaN(this._position.x)&&!isNaN(this._position.y)&&!isNaN(this._position.z)&&(this._soundPanner.positionX.value=this._position.x,this._soundPanner.positionY.value=this._position.y,this._soundPanner.positionZ.value=this._position.z),this._isDirectional&&(this._soundPanner.coneInnerAngle=this._coneInnerAngle,this._soundPanner.coneOuterAngle=this._coneOuterAngle,this._soundPanner.coneOuterGain=this._coneOuterGain,this._connectedTransformNode?this._updateDirection():this._soundPanner.setOrientation(this._localDirection.x,this._localDirection.y,this._localDirection.z))),this._streaming){if(this._streamingSource||(this._streamingSource=k.audioEngine.audioContext.createMediaElementSource(this._htmlAudioElement),this._htmlAudioElement.onended=()=>{this._onended()},this._htmlAudioElement.playbackRate=this._playbackRate),this._streamingSource.disconnect(),this._inputAudioNode&&this._streamingSource.connect(this._inputAudioNode),this._htmlAudioElement){const h=()=>{var c,u;if(!((c=k.audioEngine)===null||c===void 0)&&c.unlocked){const d=this._htmlAudioElement.play();d!==void 0&&d.catch(()=>{var f,p;(f=k.audioEngine)===null||f===void 0||f.lock(),(this.loop||this.autoplay)&&((p=k.audioEngine)===null||p===void 0||p.onAudioUnlockedObservable.addOnce(()=>{h()}))})}else(this.loop||this.autoplay)&&((u=k.audioEngine)===null||u===void 0||u.onAudioUnlockedObservable.addOnce(()=>{h()}))};h()}}else{const h=()=>{var c,u,d;if(!((c=k.audioEngine)===null||c===void 0)&&c.audioContext){if(i=i||this._length,t=t||this._offset,this._soundSource){const f=this._soundSource;f.onended=()=>{f.disconnect()}}if(this._soundSource=(u=k.audioEngine)===null||u===void 0?void 0:u.audioContext.createBufferSource(),this._soundSource&&this._inputAudioNode){this._soundSource.buffer=this._audioBuffer,this._soundSource.connect(this._inputAudioNode),this._soundSource.loop=this.loop,t!==void 0&&(this._soundSource.loopStart=t),i!==void 0&&(this._soundSource.loopEnd=(t|0)+i),this._soundSource.playbackRate.value=this._playbackRate,this._soundSource.onended=()=>{this._onended()},l=e?((d=k.audioEngine)===null||d===void 0?void 0:d.audioContext.currentTime)+e:k.audioEngine.audioContext.currentTime;const f=this.isPaused?this._startOffset%this._soundSource.buffer.duration:t||0;this._soundSource.start(l,f,this.loop?void 0:i)}}};((o=k.audioEngine)===null||o===void 0?void 0:o.audioContext.state)==="suspended"?setTimeout(()=>{var c;((c=k.audioEngine)===null||c===void 0?void 0:c.audioContext.state)==="suspended"?(k.audioEngine.lock(),(this.loop||this.autoplay)&&k.audioEngine.onAudioUnlockedObservable.addOnce(()=>{h()})):h()},500):h()}this._startTime=l,this.isPlaying=!0,this.isPaused=!1}catch(l){B.Error("Error while trying to play audio: "+this.name+", "+l.message)}}_onended(){this.isPlaying=!1,this._startOffset=0,this.onended&&this.onended(),this.onEndedObservable.notifyObservers(this)}stop(e){var t;if(this.isPlaying){if(this._streaming)this._htmlAudioElement?(this._htmlAudioElement.pause(),this._htmlAudioElement.currentTime>0&&(this._htmlAudioElement.currentTime=0)):this._streamingSource.disconnect(),this.isPlaying=!1;else if(((t=k.audioEngine)===null||t===void 0?void 0:t.audioContext)&&this._soundSource){const i=e?k.audioEngine.audioContext.currentTime+e:void 0;this._soundSource.stop(i),i===void 0?(this.isPlaying=!1,this._soundSource.onended=()=>{}):this._soundSource.onended=()=>{this.isPlaying=!1},this.isPaused||(this._startOffset=0)}}}pause(){var e;this.isPlaying&&(this.isPaused=!0,this._streaming?(this._htmlAudioElement?this._htmlAudioElement.pause():this._streamingSource.disconnect(),this.isPlaying=!1):!((e=k.audioEngine)===null||e===void 0)&&e.audioContext&&(this.stop(0),this._startOffset+=k.audioEngine.audioContext.currentTime-this._startTime))}setVolume(e,t){var i;((i=k.audioEngine)===null||i===void 0?void 0:i.canUseWebAudio)&&this._soundGain&&(t&&k.audioEngine.audioContext?(this._soundGain.gain.cancelScheduledValues(k.audioEngine.audioContext.currentTime),this._soundGain.gain.setValueAtTime(this._soundGain.gain.value,k.audioEngine.audioContext.currentTime),this._soundGain.gain.linearRampToValueAtTime(e,k.audioEngine.audioContext.currentTime+t)):this._soundGain.gain.value=e),this._volume=e}setPlaybackRate(e){this._playbackRate=e,this.isPlaying&&(this._streaming&&this._htmlAudioElement?this._htmlAudioElement.playbackRate=this._playbackRate:this._soundSource&&(this._soundSource.playbackRate.value=this._playbackRate))}getVolume(){return this._volume}attachToMesh(e){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null),this._connectedTransformNode=e,this._spatialSound||(this._spatialSound=!0,this._createSpatialParameters(),this.isPlaying&&this.loop&&(this.stop(),this.play(0,this._offset,this._length))),this._onRegisterAfterWorldMatrixUpdate(this._connectedTransformNode),this._registerFunc=t=>this._onRegisterAfterWorldMatrixUpdate(t),this._connectedTransformNode.registerAfterWorldMatrixUpdate(this._registerFunc)}detachFromMesh(){this._connectedTransformNode&&this._registerFunc&&(this._connectedTransformNode.unregisterAfterWorldMatrixUpdate(this._registerFunc),this._registerFunc=null,this._connectedTransformNode=null)}_onRegisterAfterWorldMatrixUpdate(e){var t;if(!e.getBoundingInfo)this.setPosition(e.absolutePosition);else{const s=e.getBoundingInfo();this.setPosition(s.boundingSphere.centerWorld)}((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._isDirectional&&this.isPlaying&&this._updateDirection()}clone(){if(this._streaming)return null;{const e=()=>{this._isReadyToPlay?(i._audioBuffer=this.getAudioBuffer(),i._isReadyToPlay=!0,i.autoplay&&i.play(0,this._offset,this._length)):window.setTimeout(e,300)},t={autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,useCustomAttenuation:this.useCustomAttenuation,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel},i=new Gr(this.name+"_cloned",new ArrayBuffer(0),this._scene,null,t);return this.useCustomAttenuation&&i.setAttenuationFunction(this._customAttenuationFunction),i.setPosition(this._position),i.setPlaybackRate(this._playbackRate),e(),i}}getAudioBuffer(){return this._audioBuffer}getSoundSource(){return this._soundSource}getSoundGain(){return this._soundGain}serialize(){const e={name:this.name,url:this.name,autoplay:this.autoplay,loop:this.loop,volume:this._volume,spatialSound:this._spatialSound,maxDistance:this.maxDistance,rolloffFactor:this.rolloffFactor,refDistance:this.refDistance,distanceModel:this.distanceModel,playbackRate:this._playbackRate,panningModel:this._panningModel,soundTrackId:this.soundTrackId,metadata:this.metadata};return this._spatialSound&&(this._connectedTransformNode&&(e.connectedMeshId=this._connectedTransformNode.id),e.position=this._position.asArray(),e.refDistance=this.refDistance,e.distanceModel=this.distanceModel,e.isDirectional=this._isDirectional,e.localDirectionToMesh=this._localDirection.asArray(),e.coneInnerAngle=this._coneInnerAngle,e.coneOuterAngle=this._coneOuterAngle,e.coneOuterGain=this._coneOuterGain),e}static Parse(e,t,i,s){const r=e.name;let n;e.url?n=i+e.url:n=i+r;const o={autoplay:e.autoplay,loop:e.loop,volume:e.volume,spatialSound:e.spatialSound,maxDistance:e.maxDistance,rolloffFactor:e.rolloffFactor,refDistance:e.refDistance,distanceModel:e.distanceModel,playbackRate:e.playbackRate};let l;if(!s)l=new Gr(r,n,t,()=>{t.removePendingData(l)},o),t.addPendingData(l);else{const h=()=>{s._isReadyToPlay?(l._audioBuffer=s.getAudioBuffer(),l._isReadyToPlay=!0,l.autoplay&&l.play(0,l._offset,l._length)):window.setTimeout(h,300)};l=new Gr(r,new ArrayBuffer(0),t,null,o),h()}if(e.position){const h=g.FromArray(e.position);l.setPosition(h)}if(e.isDirectional&&(l.setDirectionalCone(e.coneInnerAngle||360,e.coneOuterAngle||360,e.coneOuterGain||0),e.localDirectionToMesh)){const h=g.FromArray(e.localDirectionToMesh);l.setLocalDirectionToMesh(h)}if(e.connectedMeshId){const h=t.getMeshById(e.connectedMeshId);h&&l.attachToMesh(h)}return e.metadata&&(l.metadata=e.metadata),l}}Gr._SceneComponentInitialization=a=>{throw Ve("AudioSceneComponent")};class D1{constructor(e,t={}){this.id=-1,this._isInitialized=!1,e=e||ye.LastCreatedScene,e&&(this._scene=e,this.soundCollection=new Array,this._options=t,!this._options.mainTrack&&this._scene.soundTracks&&(this._scene.soundTracks.push(this),this.id=this._scene.soundTracks.length-1))}_initializeSoundTrackAudioGraph(){var e;((e=k.audioEngine)===null||e===void 0?void 0:e.canUseWebAudio)&&k.audioEngine.audioContext&&(this._outputAudioNode=k.audioEngine.audioContext.createGain(),this._outputAudioNode.connect(k.audioEngine.masterGain),this._options&&this._options.volume&&(this._outputAudioNode.gain.value=this._options.volume),this._isInitialized=!0)}dispose(){if(k.audioEngine&&k.audioEngine.canUseWebAudio){for(this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas();this.soundCollection.length;)this.soundCollection[0].dispose();this._outputAudioNode&&this._outputAudioNode.disconnect(),this._outputAudioNode=null}}addSound(e){var t;this._isInitialized||this._initializeSoundTrackAudioGraph(),((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&e.connectToSoundTrackAudioNode(this._outputAudioNode),e.soundTrackId&&(e.soundTrackId===-1?this._scene.mainSoundTrack.removeSound(e):this._scene.soundTracks&&this._scene.soundTracks[e.soundTrackId].removeSound(e)),this.soundCollection.push(e),e.soundTrackId=this.id}removeSound(e){const t=this.soundCollection.indexOf(e);t!==-1&&this.soundCollection.splice(t,1)}setVolume(e){var t;((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.gain.value=e)}switchPanningModelToHRTF(){var e;if(!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToHRTF()}switchPanningModelToEqualPower(){var e;if(!((e=k.audioEngine)===null||e===void 0)&&e.canUseWebAudio)for(let t=0;t<this.soundCollection.length;t++)this.soundCollection[t].switchPanningModelToEqualPower()}connectToAnalyser(e){var t;this._connectedAnalyser&&this._connectedAnalyser.stopDebugCanvas(),this._connectedAnalyser=e,((t=k.audioEngine)===null||t===void 0?void 0:t.canUseWebAudio)&&this._outputAudioNode&&(this._outputAudioNode.disconnect(),this._connectedAnalyser.connectAudioNodes(this._outputAudioNode,k.audioEngine.masterGain))}}li.AddParser(ue.NAME_AUDIO,(a,e,t,i)=>{var s;let r=[],n;if(t.sounds=t.sounds||[],a.sounds!==void 0&&a.sounds!==null)for(let o=0,l=a.sounds.length;o<l;o++){const h=a.sounds[o];!((s=k.audioEngine)===null||s===void 0)&&s.canUseWebAudio?(h.url||(h.url=h.name),r[h.url]?t.sounds.push(Gr.Parse(h,e,i,r[h.url])):(n=Gr.Parse(h,e,i),r[h.url]=n,t.sounds.push(n))):t.sounds.push(new Gr(h.name,null,e))}r=[]});Object.defineProperty(ge.prototype,"mainSoundTrack",{get:function(){let a=this._getComponent(ue.NAME_AUDIO);return a||(a=new tr(this),this._addComponent(a)),this._mainSoundTrack||(this._mainSoundTrack=new D1(this,{mainTrack:!0})),this._mainSoundTrack},enumerable:!0,configurable:!0});ge.prototype.getSoundByName=function(a){let e;for(e=0;e<this.mainSoundTrack.soundCollection.length;e++)if(this.mainSoundTrack.soundCollection[e].name===a)return this.mainSoundTrack.soundCollection[e];if(this.soundTracks){for(let t=0;t<this.soundTracks.length;t++)for(e=0;e<this.soundTracks[t].soundCollection.length;e++)if(this.soundTracks[t].soundCollection[e].name===a)return this.soundTracks[t].soundCollection[e]}return null};Object.defineProperty(ge.prototype,"audioEnabled",{get:function(){let a=this._getComponent(ue.NAME_AUDIO);return a||(a=new tr(this),this._addComponent(a)),a.audioEnabled},set:function(a){let e=this._getComponent(ue.NAME_AUDIO);e||(e=new tr(this),this._addComponent(e)),a?e.enableAudio():e.disableAudio()},enumerable:!0,configurable:!0});Object.defineProperty(ge.prototype,"headphone",{get:function(){let a=this._getComponent(ue.NAME_AUDIO);return a||(a=new tr(this),this._addComponent(a)),a.headphone},set:function(a){let e=this._getComponent(ue.NAME_AUDIO);e||(e=new tr(this),this._addComponent(e)),a?e.switchAudioModeForHeadphones():e.switchAudioModeForNormalSpeakers()},enumerable:!0,configurable:!0});Object.defineProperty(ge.prototype,"audioListenerPositionProvider",{get:function(){let a=this._getComponent(ue.NAME_AUDIO);return a||(a=new tr(this),this._addComponent(a)),a.audioListenerPositionProvider},set:function(a){let e=this._getComponent(ue.NAME_AUDIO);if(e||(e=new tr(this),this._addComponent(e)),typeof a!="function")throw new Error("The value passed to [Scene.audioListenerPositionProvider] must be a function that returns a Vector3");e.audioListenerPositionProvider=a},enumerable:!0,configurable:!0});Object.defineProperty(ge.prototype,"audioPositioningRefreshRate",{get:function(){let a=this._getComponent(ue.NAME_AUDIO);return a||(a=new tr(this),this._addComponent(a)),a.audioPositioningRefreshRate},set:function(a){let e=this._getComponent(ue.NAME_AUDIO);e||(e=new tr(this),this._addComponent(e)),e.audioPositioningRefreshRate=a},enumerable:!0,configurable:!0});class tr{constructor(e){this.name=ue.NAME_AUDIO,this._audioEnabled=!0,this._headphone=!1,this.audioPositioningRefreshRate=500,this._audioListenerPositionProvider=null,this._cachedCameraDirection=new g,this._cachedCameraPosition=new g,this._lastCheck=0,this._invertMatrixTemp=new L,this._cameraDirectionTemp=new g,e=e||ye.LastCreatedScene,e&&(this.scene=e,e.soundTracks=new Array,e.sounds=new Array)}get audioEnabled(){return this._audioEnabled}get headphone(){return this._headphone}get audioListenerPositionProvider(){return this._audioListenerPositionProvider}set audioListenerPositionProvider(e){this._audioListenerPositionProvider=e}register(){this.scene._afterRenderStage.registerStep(ue.STEP_AFTERRENDER_AUDIO,this,this._afterRender)}rebuild(){}serialize(e){if(e.sounds=[],this.scene.soundTracks)for(let t=0;t<this.scene.soundTracks.length;t++){const i=this.scene.soundTracks[t];for(let s=0;s<i.soundCollection.length;s++)e.sounds.push(i.soundCollection[s].serialize())}}addFromContainer(e){!e.sounds||e.sounds.forEach(t=>{t.play(),t.autoplay=!0,this.scene.mainSoundTrack.addSound(t)})}removeFromContainer(e,t=!1){!e.sounds||e.sounds.forEach(i=>{i.stop(),i.autoplay=!1,this.scene.mainSoundTrack.removeSound(i),t&&i.dispose()})}dispose(){const e=this.scene;if(e._mainSoundTrack&&e.mainSoundTrack.dispose(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].dispose()}disableAudio(){const e=this.scene;this._audioEnabled=!1,k.audioEngine&&k.audioEngine.audioContext&&k.audioEngine.audioContext.suspend();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].pause();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].pause()}enableAudio(){const e=this.scene;this._audioEnabled=!0,k.audioEngine&&k.audioEngine.audioContext&&k.audioEngine.audioContext.resume();let t;for(t=0;t<e.mainSoundTrack.soundCollection.length;t++)e.mainSoundTrack.soundCollection[t].isPaused&&e.mainSoundTrack.soundCollection[t].play();if(e.soundTracks)for(t=0;t<e.soundTracks.length;t++)for(let i=0;i<e.soundTracks[t].soundCollection.length;i++)e.soundTracks[t].soundCollection[i].isPaused&&e.soundTracks[t].soundCollection[i].play()}switchAudioModeForHeadphones(){const e=this.scene;if(this._headphone=!0,e.mainSoundTrack.switchPanningModelToHRTF(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToHRTF()}switchAudioModeForNormalSpeakers(){const e=this.scene;if(this._headphone=!1,e.mainSoundTrack.switchPanningModelToEqualPower(),e.soundTracks)for(let t=0;t<e.soundTracks.length;t++)e.soundTracks[t].switchPanningModelToEqualPower()}_afterRender(){const e=ps.Now;if(this._lastCheck&&e-this._lastCheck<this.audioPositioningRefreshRate)return;this._lastCheck=e;const t=this.scene;if(!this._audioEnabled||!t._mainSoundTrack||!t.soundTracks||t._mainSoundTrack.soundCollection.length===0&&t.soundTracks.length===1)return;const i=k.audioEngine;if(!!i&&i.audioContext){if(this._audioListenerPositionProvider){const r=this._audioListenerPositionProvider();r.x=r.x||0,r.y=r.y||0,r.z=r.z||0,i.audioContext.listener.setPosition(r.x,r.y,r.z)}else{let r;t.activeCameras&&t.activeCameras.length>0?r=t.activeCameras[0]:r=t.activeCamera,r?(this._cachedCameraPosition.equals(r.globalPosition)||(this._cachedCameraPosition.copyFrom(r.globalPosition),i.audioContext.listener.setPosition(r.globalPosition.x,r.globalPosition.y,r.globalPosition.z)),r.rigCameras&&r.rigCameras.length>0&&(r=r.rigCameras[0]),r.getViewMatrix().invertToRef(this._invertMatrixTemp),g.TransformNormalToRef(tr._CameraDirection,this._invertMatrixTemp,this._cameraDirectionTemp),this._cameraDirectionTemp.normalize(),!isNaN(this._cameraDirectionTemp.x)&&!isNaN(this._cameraDirectionTemp.y)&&!isNaN(this._cameraDirectionTemp.z)&&(this._cachedCameraDirection.equals(this._cameraDirectionTemp)||(this._cachedCameraDirection.copyFrom(this._cameraDirectionTemp),i.audioContext.listener.setOrientation(this._cameraDirectionTemp.x,this._cameraDirectionTemp.y,this._cameraDirectionTemp.z,0,1,0)))):i.audioContext.listener.setPosition(0,0,0)}let s;for(s=0;s<t.mainSoundTrack.soundCollection.length;s++){const r=t.mainSoundTrack.soundCollection[s];r.useCustomAttenuation&&r.updateDistanceFromListener()}if(t.soundTracks)for(s=0;s<t.soundTracks.length;s++)for(let r=0;r<t.soundTracks[s].soundCollection.length;r++){const n=t.soundTracks[s].soundCollection[r];n.useCustomAttenuation&&n.updateDistanceFromListener()}}}}tr._CameraDirection=new g(0,0,-1);Gr._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_AUDIO);e||(e=new tr(a),a._addComponent(e))};class Go{constructor(e){this._texture=null,this._isEnabled=!0,this.isEnabled=!0,this.time=0,e=e||ye.LastCreatedScene,e&&(this._scene=e,this.animationParameters=new Ge(0,0,0,30))}_markSubMeshesAsAttributesDirty(){for(const e of this._scene.meshes)e.bakedVertexAnimationManager===this&&e._markSubMeshesAsAttributesDirty()}bind(e,t=!1){if(!this._texture||!this._isEnabled)return;const i=this._texture.getSize();e.setFloat2("bakedVertexAnimationTextureSizeInverted",1/i.width,1/i.height),e.setFloat("bakedVertexAnimationTime",this.time),t||e.setVector4("bakedVertexAnimationSettings",this.animationParameters),e.setTexture("bakedVertexAnimationTexture",this._texture)}clone(){const e=new Go(this._scene);return this.copyTo(e),e}setAnimationParameters(e,t,i=0,s=30){this.animationParameters=new Ge(e,t,i,s)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"BakedVertexAnimationManager"}copyTo(e){xe.Clone(()=>e,this)}serialize(){return xe.Serialize(this)}parse(e,t,i){xe.Parse(()=>this,e,t,i)}}T([Qe(),ie("_markSubMeshesAsAttributesDirty")],Go.prototype,"texture",void 0);T([R(),ie("_markSubMeshesAsAttributesDirty")],Go.prototype,"isEnabled",void 0);T([R()],Go.prototype,"animationParameters",void 0);T([R()],Go.prototype,"time",void 0);Te.prototype.updateRawTexture=function(a,e,t,i,s=null,r=0,n=!1){if(!a)return;const o=this._getRGBABufferInternalSizedFormat(r,t,n),l=this._getInternalFormat(t),h=this._getWebGLTextureType(r);this._bindTextureDirectly(this._gl.TEXTURE_2D,a,!0),this._unpackFlipY(i===void 0?!0:!!i),this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.type=r,a.invertY=i,a._compression=s),a.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),s&&e?this._gl.compressedTexImage2D(this._gl.TEXTURE_2D,0,this.getCaps().s3tc[s],a.width,a.height,0,e):this._gl.texImage2D(this._gl.TEXTURE_2D,0,o,a.width,a.height,0,l,h,e),a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),a.isReady=!0};Te.prototype.createRawTexture=function(a,e,t,i,s,r,n,o=null,l=0,h=0,c=!1){const u=new gt(this,We.Raw);u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=s,u.samplingMode=n,u.invertY=r,u._compression=o,u.type=l,u._useSRGBBuffer=this._getUseSRGBBuffer(c,!s),this._doNotHandleContextLost||(u._bufferView=a),this.updateRawTexture(u,a,i,r,o,l,u._useSRGBBuffer),this._bindTextureDirectly(this._gl.TEXTURE_2D,u,!0);const d=this._getSamplingParameters(n,s);return this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MAG_FILTER,d.mag),this._gl.texParameteri(this._gl.TEXTURE_2D,this._gl.TEXTURE_MIN_FILTER,d.min),s&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(this._gl.TEXTURE_2D,null),this._internalTexturesCache.push(u),u};Te.prototype.createRawCubeTexture=function(a,e,t,i,s,r,n,o=null){const l=this._gl,h=new gt(this,We.CubeRaw);h.isCube=!0,h.format=t,h.type=i,this._doNotHandleContextLost||(h._bufferViewArray=a);const c=this._getWebGLTextureType(i);let u=this._getInternalFormat(t);u===l.RGB&&(u=l.RGBA),c===l.FLOAT&&!this._caps.textureFloatLinearFiltering?(s=!1,n=1,B.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===this._gl.HALF_FLOAT_OES&&!this._caps.textureHalfFloatLinearFiltering?(s=!1,n=1,B.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):c===l.FLOAT&&!this._caps.textureFloatRender?(s=!1,B.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):c===l.HALF_FLOAT&&!this._caps.colorBufferFloat&&(s=!1,B.Warn("Render to half float textures is not supported. Mipmap generation forced to false."));const d=e,f=d;h.width=d,h.height=f,!this.needPOTTextures||q.IsExponentOfTwo(h.width)&&q.IsExponentOfTwo(h.height)||(s=!1),a&&this.updateRawCubeTexture(h,a,t,i,r,o),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,h,!0),a&&s&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP);const _=this._getSamplingParameters(n,s);return l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MAG_FILTER,_.mag),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_MIN_FILTER,_.min),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_CUBE_MAP,l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),this._bindTextureDirectly(l.TEXTURE_CUBE_MAP,null),h.generateMipMaps=s,h.samplingMode=n,h};Te.prototype.updateRawCubeTexture=function(a,e,t,i,s,r=null,n=0){a._bufferViewArray=e,a.format=t,a.type=i,a.invertY=s,a._compression=r;const o=this._gl,l=this._getWebGLTextureType(i);let h=this._getInternalFormat(t);const c=this._getRGBABufferInternalSizedFormat(i);let u=!1;h===o.RGB&&(h=o.RGBA,u=!0),this._bindTextureDirectly(o.TEXTURE_CUBE_MAP,a,!0),this._unpackFlipY(s===void 0?!0:!!s),a.width%4!==0&&o.pixelStorei(o.UNPACK_ALIGNMENT,1);for(let f=0;f<6;f++){let p=e[f];r?o.compressedTexImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,this.getCaps().s3tc[r],a.width,a.height,0,p):(u&&(p=P_(p,a.width,a.height,i)),o.texImage2D(o.TEXTURE_CUBE_MAP_POSITIVE_X+f,n,c,a.width,a.height,0,h,l,p))}(!this.needPOTTextures||q.IsExponentOfTwo(a.width)&&q.IsExponentOfTwo(a.height))&&a.generateMipMaps&&n===0&&this._gl.generateMipmap(this._gl.TEXTURE_CUBE_MAP),this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP,null),a.isReady=!0};Te.prototype.createRawCubeTextureFromUrl=function(a,e,t,i,s,r,n,o,l=null,h=null,c=3,u=!1){const d=this._gl,f=this.createRawCubeTexture(null,t,i,s,!r,u,c,null);e==null||e.addPendingData(f),f.url=a,this._internalTexturesCache.push(f);const p=(m,v)=>{e==null||e.removePendingData(f),h&&m&&h(m.status+" "+m.statusText,v)},_=m=>{const v=f.width,x=n(m);if(!!x){if(o){const b=this._getWebGLTextureType(s);let S=this._getInternalFormat(i);const C=this._getRGBABufferInternalSizedFormat(s);let E=!1;S===d.RGB&&(S=d.RGBA,E=!0),this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,f,!0),this._unpackFlipY(!1);const A=o(x);for(let M=0;M<A.length;M++){const D=v>>M;for(let P=0;P<6;P++){let O=A[M][P];E&&(O=P_(O,D,D,s)),d.texImage2D(P,M,C,D,D,0,S,b,O)}}this._bindTextureDirectly(d.TEXTURE_CUBE_MAP,null)}else this.updateRawCubeTexture(f,x,i,s,u);f.isReady=!0,e==null||e.removePendingData(f),f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),l&&l()}};return this._loadFile(a,m=>{_(m)},void 0,e==null?void 0:e.offlineProvider,!0,p),f};function P_(a,e,t,i){let s,r=1;i===1?s=new Float32Array(e*t*4):i===2?(s=new Uint16Array(e*t*4),r=15360):i===7?s=new Uint32Array(e*t*4):s=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const l=(o*e+n)*3,h=(o*e+n)*4;s[h+0]=a[l+0],s[h+1]=a[l+1],s[h+2]=a[l+2],s[h+3]=r}return s}function M_(a){return function(e,t,i,s,r,n,o,l,h=null,c=0){const u=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,d=a?We.Raw3D:We.Raw2DArray,f=new gt(this,d);f.baseWidth=t,f.baseHeight=i,f.baseDepth=s,f.width=t,f.height=i,f.depth=s,f.format=r,f.type=c,f.generateMipMaps=n,f.samplingMode=l,a?f.is3D=!0:f.is2DArray=!0,this._doNotHandleContextLost||(f._bufferView=e),a?this.updateRawTexture3D(f,e,r,o,h,c):this.updateRawTexture2DArray(f,e,r,o,h,c),this._bindTextureDirectly(u,f,!0);const p=this._getSamplingParameters(l,n);return this._gl.texParameteri(u,this._gl.TEXTURE_MAG_FILTER,p.mag),this._gl.texParameteri(u,this._gl.TEXTURE_MIN_FILTER,p.min),n&&this._gl.generateMipmap(u),this._bindTextureDirectly(u,null),this._internalTexturesCache.push(f),f}}Te.prototype.createRawTexture2DArray=M_(!1);Te.prototype.createRawTexture3D=M_(!0);function D_(a){return function(e,t,i,s,r=null,n=0){const o=a?this._gl.TEXTURE_3D:this._gl.TEXTURE_2D_ARRAY,l=this._getWebGLTextureType(n),h=this._getInternalFormat(i),c=this._getRGBABufferInternalSizedFormat(n,i);this._bindTextureDirectly(o,e,!0),this._unpackFlipY(s===void 0?!0:!!s),this._doNotHandleContextLost||(e._bufferView=t,e.format=i,e.invertY=s,e._compression=r),e.width%4!==0&&this._gl.pixelStorei(this._gl.UNPACK_ALIGNMENT,1),r&&t?this._gl.compressedTexImage3D(o,0,this.getCaps().s3tc[r],e.width,e.height,e.depth,0,t):this._gl.texImage3D(o,0,c,e.width,e.height,e.depth,0,h,l,t),e.generateMipMaps&&this._gl.generateMipmap(o),this._bindTextureDirectly(o,null),e.isReady=!0}}Te.prototype.updateRawTexture2DArray=D_(!1);Te.prototype.updateRawTexture3D=D_(!0);class Ts extends H{constructor(e,t,i,s,r,n=!0,o=!1,l=3,h=0,c,u){super(null,r,!n,o,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,c),this.format=s,this._engine&&(!this._engine._caps.textureFloatLinearFiltering&&h===1&&(l=1),!this._engine._caps.textureHalfFloatLinearFiltering&&h===2&&(l=1),this._texture=this._engine.createRawTexture(e,t,i,s,n,o,l,null,h,c!=null?c:0,u!=null?u:!1),this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE)}update(e){this._getEngine().updateRawTexture(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type,this._texture._useSRGBBuffer)}static CreateLuminanceTexture(e,t,i,s,r=!0,n=!1,o=3){return new Ts(e,t,i,1,s,r,n,o)}static CreateLuminanceAlphaTexture(e,t,i,s,r=!0,n=!1,o=3){return new Ts(e,t,i,2,s,r,n,o)}static CreateAlphaTexture(e,t,i,s,r=!0,n=!1,o=3){return new Ts(e,t,i,0,s,r,n,o)}static CreateRGBTexture(e,t,i,s,r=!0,n=!1,o=3,l=0,h=0,c=!1){return new Ts(e,t,i,4,s,r,n,o,l,h,c)}static CreateRGBATexture(e,t,i,s,r=!0,n=!1,o=3,l=0,h=0,c=!1){return new Ts(e,t,i,5,s,r,n,o,l,h,c)}static CreateRGBAStorageTexture(e,t,i,s,r=!0,n=!1,o=3,l=0,h=!1){return new Ts(e,t,i,5,s,r,n,o,l,1,h)}static CreateRTexture(e,t,i,s,r=!0,n=!1,o=H.TRILINEAR_SAMPLINGMODE,l=1){return new Ts(e,t,i,6,s,r,n,o,l)}static CreateRStorageTexture(e,t,i,s,r=!0,n=!1,o=H.TRILINEAR_SAMPLINGMODE,l=1){return new Ts(e,t,i,6,s,r,n,o,l,1)}}class $e{constructor(e,t,i=Number.MAX_VALUE){this.origin=e,this.direction=t,this.length=i}clone(){return new $e(this.origin.clone(),this.direction.clone(),this.length)}intersectsBoxMinMax(e,t,i=0){const s=$e._TmpVector3[0].copyFromFloats(e.x-i,e.y-i,e.z-i),r=$e._TmpVector3[1].copyFromFloats(t.x+i,t.y+i,t.z+i);let n=0,o=Number.MAX_VALUE,l,h,c,u;if(Math.abs(this.direction.x)<1e-7){if(this.origin.x<s.x||this.origin.x>r.x)return!1}else if(l=1/this.direction.x,h=(s.x-this.origin.x)*l,c=(r.x-this.origin.x)*l,c===-1/0&&(c=1/0),h>c&&(u=h,h=c,c=u),n=Math.max(h,n),o=Math.min(c,o),n>o)return!1;if(Math.abs(this.direction.y)<1e-7){if(this.origin.y<s.y||this.origin.y>r.y)return!1}else if(l=1/this.direction.y,h=(s.y-this.origin.y)*l,c=(r.y-this.origin.y)*l,c===-1/0&&(c=1/0),h>c&&(u=h,h=c,c=u),n=Math.max(h,n),o=Math.min(c,o),n>o)return!1;if(Math.abs(this.direction.z)<1e-7){if(this.origin.z<s.z||this.origin.z>r.z)return!1}else if(l=1/this.direction.z,h=(s.z-this.origin.z)*l,c=(r.z-this.origin.z)*l,c===-1/0&&(c=1/0),h>c&&(u=h,h=c,c=u),n=Math.max(h,n),o=Math.min(c,o),n>o)return!1;return!0}intersectsBox(e,t=0){return this.intersectsBoxMinMax(e.minimum,e.maximum,t)}intersectsSphere(e,t=0){const i=e.center.x-this.origin.x,s=e.center.y-this.origin.y,r=e.center.z-this.origin.z,n=i*i+s*s+r*r,o=e.radius+t,l=o*o;if(n<=l)return!0;const h=i*this.direction.x+s*this.direction.y+r*this.direction.z;return h<0?!1:n-h*h<=l}intersectsTriangle(e,t,i){const s=$e._TmpVector3[0],r=$e._TmpVector3[1],n=$e._TmpVector3[2],o=$e._TmpVector3[3],l=$e._TmpVector3[4];t.subtractToRef(e,s),i.subtractToRef(e,r),g.CrossToRef(this.direction,r,n);const h=g.Dot(s,n);if(h===0)return null;const c=1/h;this.origin.subtractToRef(e,o);const u=g.Dot(o,n)*c;if(u<0||u>1)return null;g.CrossToRef(o,s,l);const d=g.Dot(this.direction,l)*c;if(d<0||u+d>1)return null;const f=g.Dot(r,l)*c;return f>this.length?null:new ed(1-u-d,u,f)}intersectsPlane(e){let t;const i=g.Dot(e.normal,this.direction);if(Math.abs(i)<999999997475243e-21)return null;{const s=g.Dot(e.normal,this.origin);return t=(-e.d-s)/i,t<0?t<-999999997475243e-21?null:0:t}}intersectsAxis(e,t=0){switch(e){case"y":{const i=(this.origin.y-t)/this.direction.y;return i>0?null:new g(this.origin.x+this.direction.x*-i,t,this.origin.z+this.direction.z*-i)}case"x":{const i=(this.origin.x-t)/this.direction.x;return i>0?null:new g(t,this.origin.y+this.direction.y*-i,this.origin.z+this.direction.z*-i)}case"z":{const i=(this.origin.z-t)/this.direction.z;return i>0?null:new g(this.origin.x+this.direction.x*-i,this.origin.y+this.direction.y*-i,t)}default:return null}}intersectsMesh(e,t){const i=G.Matrix[0];return e.getWorldMatrix().invertToRef(i),this._tmpRay?$e.TransformToRef(this,i,this._tmpRay):this._tmpRay=$e.Transform(this,i),e.intersects(this._tmpRay,t)}intersectsMeshes(e,t,i){i?i.length=0:i=[];for(let s=0;s<e.length;s++){const r=this.intersectsMesh(e[s],t);r.hit&&i.push(r)}return i.sort(this._comparePickingInfo),i}_comparePickingInfo(e,t){return e.distance<t.distance?-1:e.distance>t.distance?1:0}intersectionSegment(e,t,i){const s=this.origin,r=G.Vector3[0],n=G.Vector3[1],o=G.Vector3[2],l=G.Vector3[3];t.subtractToRef(e,r),this.direction.scaleToRef($e._Rayl,o),s.addToRef(o,n),e.subtractToRef(s,l);const h=g.Dot(r,r),c=g.Dot(r,o),u=g.Dot(o,o),d=g.Dot(r,l),f=g.Dot(o,l),p=h*u-c*c;let _,m=p,v,x=p;p<$e._Smallnum?(_=0,m=1,v=f,x=u):(_=c*f-u*d,v=h*f-c*d,_<0?(_=0,v=f,x=u):_>m&&(_=m,v=f+c,x=u)),v<0?(v=0,-d<0?_=0:-d>h?_=m:(_=-d,m=h)):v>x&&(v=x,-d+c<0?_=0:-d+c>h?_=m:(_=-d+c,m=h));const b=Math.abs(_)<$e._Smallnum?0:_/m,S=Math.abs(v)<$e._Smallnum?0:v/x,C=G.Vector3[4];o.scaleToRef(S,C);const E=G.Vector3[5];r.scaleToRef(b,E),E.addInPlace(l);const A=G.Vector3[6];return E.subtractToRef(C,A),S>0&&S<=this.length&&A.lengthSquared()<i*i?E.length():-1}update(e,t,i,s,r,n,o,l=!1){if(l){$e._RayDistant||($e._RayDistant=$e.Zero()),$e._RayDistant.unprojectRayToRef(e,t,i,s,L.IdentityReadOnly,n,o);const h=G.Matrix[0];r.invertToRef(h),$e.TransformToRef($e._RayDistant,h,this)}else this.unprojectRayToRef(e,t,i,s,r,n,o);return this}static Zero(){return new $e(g.Zero(),g.Zero())}static CreateNew(e,t,i,s,r,n,o){return $e.Zero().update(e,t,i,s,r,n,o)}static CreateNewFromTo(e,t,i=L.IdentityReadOnly){const s=t.subtract(e),r=Math.sqrt(s.x*s.x+s.y*s.y+s.z*s.z);return s.normalize(),$e.Transform(new $e(e,s,r),i)}static Transform(e,t){const i=new $e(new g(0,0,0),new g(0,0,0));return $e.TransformToRef(e,t,i),i}static TransformToRef(e,t,i){g.TransformCoordinatesToRef(e.origin,t,i.origin),g.TransformNormalToRef(e.direction,t,i.direction),i.length=e.length;const s=i.direction,r=s.length();if(!(r===0||r===1)){const n=1/r;s.x*=n,s.y*=n,s.z*=n,i.length*=r}}unprojectRayToRef(e,t,i,s,r,n,o){var l;const h=G.Matrix[0];r.multiplyToRef(n,h),h.multiplyToRef(o,h),h.invert();const c=G.Vector3[0];c.x=e/i*2-1,c.y=-(t/s*2-1),c.z=!((l=ye.LastCreatedEngine)===null||l===void 0)&&l.isNDCHalfZRange?0:-1;const u=G.Vector3[1].copyFromFloats(c.x,c.y,1-1e-8),d=G.Vector3[2],f=G.Vector3[3];g._UnprojectFromInvertedMatrixToRef(c,h,d),g._UnprojectFromInvertedMatrixToRef(u,h,f),this.origin.copyFrom(d),f.subtractToRef(d,this.direction),this.direction.normalize()}}$e._TmpVector3=gi.BuildArray(6,g.Zero);$e._RayDistant=$e.Zero();$e._Smallnum=1e-8;$e._Rayl=1e9;ge.prototype.createPickingRay=function(a,e,t,i,s=!1){const r=$e.Zero();return this.createPickingRayToRef(a,e,t,r,i,s),r};ge.prototype.createPickingRayToRef=function(a,e,t,i,s,r=!1,n=!1){const o=this.getEngine();if(!s){if(!this.activeCamera)return this;s=this.activeCamera}const h=s.viewport.toGlobal(o.getRenderWidth(),o.getRenderHeight());return a=a/o.getHardwareScalingLevel()-h.x,e=e/o.getHardwareScalingLevel()-(o.getRenderHeight()-h.y-h.height),i.update(a,e,h.width,h.height,t||L.IdentityReadOnly,r?L.IdentityReadOnly:s.getViewMatrix(),s.getProjectionMatrix(),n),this};ge.prototype.createPickingRayInCameraSpace=function(a,e,t){const i=$e.Zero();return this.createPickingRayInCameraSpaceToRef(a,e,i,t),i};ge.prototype.createPickingRayInCameraSpaceToRef=function(a,e,t,i){if(!ki)return this;const s=this.getEngine();if(!i){if(!this.activeCamera)throw new Error("Active camera not set");i=this.activeCamera}const n=i.viewport.toGlobal(s.getRenderWidth(),s.getRenderHeight()),o=L.Identity();return a=a/s.getHardwareScalingLevel()-n.x,e=e/s.getHardwareScalingLevel()-(s.getRenderHeight()-n.y-n.height),t.update(a,e,n.width,n.height,o,o,i.getProjectionMatrix()),this};ge.prototype._internalPickForMesh=function(a,e,t,i,s,r,n,o){const l=e(i,t.enableDistantPicking),h=t.intersects(l,s,n,r,i,o);return!h||!h.hit||!s&&a!=null&&h.distance>=a.distance?null:h};ge.prototype._internalPick=function(a,e,t,i,s){if(!ki)return null;let r=null;for(let n=0;n<this.meshes.length;n++){const o=this.meshes[n];if(e){if(!e(o))continue}else if(!o.isEnabled()||!o.isVisible||!o.isPickable)continue;const l=o.getWorldMatrix();if(o.hasThinInstances&&o.thinInstanceEnablePicking){const h=this._internalPickForMesh(r,a,o,l,!0,!0,s);if(h){if(i)return h;const c=G.Matrix[1],u=o.thinInstanceGetWorldMatrices();for(let d=0;d<u.length;d++){u[d].multiplyToRef(l,c);const p=this._internalPickForMesh(r,a,o,c,t,i,s,!0);if(p&&(r=p,r.thinInstanceIndex=d,t))return r}}}else{const h=this._internalPickForMesh(r,a,o,l,t,i,s);if(h&&(r=h,t))return r}}return r||new ki};ge.prototype._internalMultiPick=function(a,e,t){if(!ki)return null;const i=new Array;for(let s=0;s<this.meshes.length;s++){const r=this.meshes[s];if(e){if(!e(r))continue}else if(!r.isEnabled()||!r.isVisible||!r.isPickable)continue;const n=r.getWorldMatrix();if(r.hasThinInstances&&r.thinInstanceEnablePicking){if(this._internalPickForMesh(null,a,r,n,!0,!0,t)){const l=G.Matrix[1],h=r.thinInstanceGetWorldMatrices();for(let c=0;c<h.length;c++){h[c].multiplyToRef(n,l);const d=this._internalPickForMesh(null,a,r,l,!1,!1,t,!0);d&&(d.thinInstanceIndex=c,i.push(d))}}}else{const o=this._internalPickForMesh(null,a,r,n,!1,!1,t);o&&i.push(o)}}return i};ge.prototype.pickWithBoundingInfo=function(a,e,t,i,s){if(!ki)return null;const r=this._internalPick(n=>(this._tempPickingRay||(this._tempPickingRay=$e.Zero()),this.createPickingRayToRef(a,e,n,this._tempPickingRay,s||null),this._tempPickingRay),t,i,!0);return r&&(r.ray=this.createPickingRay(a,e,L.Identity(),s||null)),r};ge.prototype.pick=function(a,e,t,i,s,r,n=!1){if(!ki)return null;const o=this._internalPick((l,h)=>(this._tempPickingRay||(this._tempPickingRay=$e.Zero()),this.createPickingRayToRef(a,e,l,this._tempPickingRay,s||null,!1,h),this._tempPickingRay),t,i,!1,r);return o&&(o.ray=this.createPickingRay(a,e,L.Identity(),s||null)),o};ge.prototype.pickWithRay=function(a,e,t,i){const s=this._internalPick(r=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=L.Identity()),r.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=$e.Zero()),$e.TransformToRef(a,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t,!1,i);return s&&(s.ray=a),s};ge.prototype.multiPick=function(a,e,t,i,s){return this._internalMultiPick(r=>this.createPickingRay(a,e,r,i||null),t,s)};ge.prototype.multiPickWithRay=function(a,e,t){return this._internalMultiPick(i=>(this._pickWithRayInverseMatrix||(this._pickWithRayInverseMatrix=L.Identity()),i.invertToRef(this._pickWithRayInverseMatrix),this._cachedRayForTransform||(this._cachedRayForTransform=$e.Zero()),$e.TransformToRef(a,this._pickWithRayInverseMatrix,this._cachedRayForTransform),this._cachedRayForTransform),e,t)};be.prototype.getForwardRay=function(a=100,e,t){return this.getForwardRayToRef(new $e(g.Zero(),g.Zero(),a),a,e,t)};be.prototype.getForwardRayToRef=function(a,e=100,t,i){return t||(t=this.getWorldMatrix()),a.length=e,i?a.origin.copyFrom(i):a.origin.copyFrom(this.position),G.Vector3[2].set(0,0,this._scene.useRightHandedSystem?-1:1),g.TransformNormalToRef(G.Vector3[2],t,G.Vector3[3]),g.NormalizeToRef(G.Vector3[3],a.direction),a};new g;new g;new g;function O_(a){const e=[],t=[],i=[],s=[],r=a.width||a.size||1,n=a.height||a.size||1,o=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,l=r/2,h=n/2;t.push(-l,-h,0),i.push(0,0,-1),s.push(0,nt.UseOpenGLOrientationForUV?1:0),t.push(l,-h,0),i.push(0,0,-1),s.push(1,nt.UseOpenGLOrientationForUV?1:0),t.push(l,h,0),i.push(0,0,-1),s.push(1,nt.UseOpenGLOrientationForUV?0:1),t.push(-l,h,0),i.push(0,0,-1),s.push(0,nt.UseOpenGLOrientationForUV?0:1),e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),de._ComputeSides(o,t,e,i,s,a.frontUVs,a.backUVs);const c=new de;return c.indices=e,c.positions=t,c.normals=i,c.uvs=s,c}function Ec(a,e={},t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,O_(e).applyToMesh(i,e.updatable),e.sourcePlane&&(i.translate(e.sourcePlane.normal,-e.sourcePlane.d),i.setDirection(e.sourcePlane.normal.scale(-1))),i}de.CreatePlane=O_;V.CreatePlane=(a,e,t,i,s)=>Ec(a,{size:e,width:e,height:e,sideOrientation:s,updatable:i},t);class pt{}pt.ANCHOR_SYSTEM="xr-anchor-system";pt.BACKGROUND_REMOVER="xr-background-remover";pt.HIT_TEST="xr-hit-test";pt.MESH_DETECTION="xr-mesh-detection";pt.PHYSICS_CONTROLLERS="xr-physics-controller";pt.PLANE_DETECTION="xr-plane-detection";pt.POINTER_SELECTION="xr-controller-pointer-selection";pt.TELEPORTATION="xr-controller-teleportation";pt.FEATURE_POINTS="xr-feature-points";pt.HAND_TRACKING="xr-hand-tracking";pt.IMAGE_TRACKING="xr-image-tracking";pt.NEAR_INTERACTION="xr-near-interaction";pt.DOM_OVERLAY="xr-dom-overlay";pt.MOVEMENT="xr-controller-movement";pt.LIGHT_ESTIMATION="xr-light-estimation";pt.EYE_TRACKING="xr-eye-tracking";pt.WALKING_LOCOMOTION="xr-walking-locomotion";pt.LAYERS="xr-layers";class ii{constructor(e){this._xrSessionManager=e,this._features={},this._xrSessionManager.onXRSessionInit.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&!i.featureImplementation.attached&&!i.featureImplementation.disableAutoAttach&&this.attachFeature(t)})}),this._xrSessionManager.onXRSessionEnded.add(()=>{this.getEnabledFeatures().forEach(t=>{const i=this._features[t];i.enabled&&i.featureImplementation.attached&&this.detachFeature(t)})})}static AddWebXRFeature(e,t,i=1,s=!1){this._AvailableFeatures[e]=this._AvailableFeatures[e]||{latest:i},i>this._AvailableFeatures[e].latest&&(this._AvailableFeatures[e].latest=i),s&&(this._AvailableFeatures[e].stable=i),this._AvailableFeatures[e][i]=t}static ConstructFeature(e,t=1,i,s){const r=this._AvailableFeatures[e][t];if(!r)throw new Error("feature not found");return r(i,s)}static GetAvailableFeatures(){return Object.keys(this._AvailableFeatures)}static GetAvailableVersions(e){return Object.keys(this._AvailableFeatures[e])}static GetLatestVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].latest||-1}static GetStableVersionOfFeature(e){return this._AvailableFeatures[e]&&this._AvailableFeatures[e].stable||-1}attachFeature(e){const t=this._features[e];t&&t.enabled&&!t.featureImplementation.attached&&t.featureImplementation.attach()}detachFeature(e){const t=this._features[e];t&&t.featureImplementation.attached&&t.featureImplementation.detach()}disableFeature(e){const t=typeof e=="string"?e:e.Name,i=this._features[t];return i&&i.enabled?(i.enabled=!1,this.detachFeature(t),i.featureImplementation.dispose(),delete this._features[t],!0):!1}dispose(){this.getEnabledFeatures().forEach(e=>{this.disableFeature(e)})}enableFeature(e,t="latest",i={},s=!0,r=!0){const n=typeof e=="string"?e:e.Name;let o=0;if(typeof t=="string"){if(!t)throw new Error(`Error in provided version - ${n} (${t})`);if(t==="stable"?o=ii.GetStableVersionOfFeature(n):t==="latest"?o=ii.GetLatestVersionOfFeature(n):o=+t,o===-1||isNaN(o))throw new Error(`feature not found - ${n} (${t})`)}else o=t;const l=ii._ConflictingFeatures[n];if(l!==void 0&&this.getEnabledFeatures().indexOf(l)!==-1)throw new Error(`Feature ${n} cannot be enabled while ${l} is enabled.`);const h=this._features[n],c=ii.ConstructFeature(n,o,this._xrSessionManager,i);if(!c)throw new Error(`feature not found - ${n}`);h&&this.disableFeature(n);const u=c();if(u.dependsOn&&!u.dependsOn.every(f=>!!this._features[f]))throw new Error(`Dependant features missing. Make sure the following features are enabled - ${u.dependsOn.join(", ")}`);if(u.isCompatible())return this._features[n]={featureImplementation:u,enabled:!0,version:o,required:r},s?this._xrSessionManager.session&&!this._features[n].featureImplementation.attached&&this.attachFeature(n):this._features[n].featureImplementation.disableAutoAttach=!0,this._features[n].featureImplementation;if(r)throw new Error("required feature not compatible");return q.Warn(`Feature ${n} not compatible with the current environment/browser and was not enabled.`),u}getEnabledFeature(e){return this._features[e]&&this._features[e].featureImplementation}getEnabledFeatures(){return Object.keys(this._features)}async _extendXRSessionInitObject(e){const t=this.getEnabledFeatures();for(const i of t){const s=this._features[i],r=s.featureImplementation.xrNativeFeatureName;if(r&&(s.required?(e.requiredFeatures=e.requiredFeatures||[],e.requiredFeatures.indexOf(r)===-1&&e.requiredFeatures.push(r)):(e.optionalFeatures=e.optionalFeatures||[],e.optionalFeatures.indexOf(r)===-1&&e.optionalFeatures.push(r))),s.featureImplementation.getXRSessionInitExtension){const n=await s.featureImplementation.getXRSessionInitExtension();e={...e,...n}}}return e}}ii._AvailableFeatures={};ii._ConflictingFeatures={[pt.TELEPORTATION]:pt.MOVEMENT,[pt.MOVEMENT]:pt.TELEPORTATION};class Ji{constructor(e){this._xrSessionManager=e,this._attached=!1,this._removeOnDetach=[],this.isDisposed=!1,this.disableAutoAttach=!1,this.xrNativeFeatureName=""}get attached(){return this._attached}attach(e){if(this.isDisposed)return!1;if(e)this.attached&&this.detach();else if(this.attached)return!1;return this._attached=!0,this._addNewAttachObserver(this._xrSessionManager.onXRFrameObservable,t=>this._onXRFrame(t)),!0}detach(){return this._attached?(this._attached=!1,this._removeOnDetach.forEach(e=>{e.observable.remove(e.observer)}),!0):(this.disableAutoAttach=!0,!1)}dispose(){this.detach(),this.isDisposed=!0}isCompatible(){return!0}_addNewAttachObserver(e,t){this._removeOnDetach.push({observable:e,observer:e.add(t)})}}class Nt{constructor(e,t){this.type=e,this.jointData=t,t.nativeParams=t.nativeParams||{}}get physicsJoint(){return this._physicsJoint}set physicsJoint(e){this._physicsJoint,this._physicsJoint=e}set physicsPlugin(e){this._physicsPlugin=e}executeNativeFunction(e){e(this._physicsPlugin.world,this._physicsJoint)}}Nt.DistanceJoint=0;Nt.HingeJoint=1;Nt.BallAndSocketJoint=2;Nt.WheelJoint=3;Nt.SliderJoint=4;Nt.PrismaticJoint=5;Nt.UniversalJoint=6;Nt.Hinge2Joint=Nt.WheelJoint;Nt.PointToPointJoint=8;Nt.SpringJoint=9;Nt.LockJoint=10;V._PhysicsImpostorParser=function(a,e,t){return new Oe(e,t.physicsImpostor,{mass:t.physicsMass,friction:t.physicsFriction,restitution:t.physicsRestitution},a)};class Oe{constructor(e,t,i={mass:0},s){if(this.object=e,this.type=t,this._options=i,this._scene=s,this._pluginData={},this._bodyUpdateRequired=!1,this._onBeforePhysicsStepCallbacks=new Array,this._onAfterPhysicsStepCallbacks=new Array,this._onPhysicsCollideCallbacks=[],this._deltaPosition=g.Zero(),this._isDisposed=!1,this.soft=!1,this.segments=0,this._tmpQuat=new Q,this._tmpQuat2=new Q,this.beforeStep=()=>{!this._physicsEngine||(this.object.translate(this._deltaPosition,-1),this._deltaRotationConjugated&&this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotationConjugated,this.object.rotationQuaternion),this.object.computeWorldMatrix(!1),this.object.parent&&this.object.rotationQuaternion?(this.getParentsRotation(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this._tmpQuat)):this._tmpQuat.copyFrom(this.object.rotationQuaternion||new Q),this._options.disableBidirectionalTransformation||this.object.rotationQuaternion&&this._physicsEngine.getPhysicsPlugin().setPhysicsBodyTransformation(this,this.object.getAbsolutePosition(),this._tmpQuat),this._onBeforePhysicsStepCallbacks.forEach(r=>{r(this)}))},this.afterStep=()=>{!this._physicsEngine||(this._onAfterPhysicsStepCallbacks.forEach(r=>{r(this)}),this._physicsEngine.getPhysicsPlugin().setTransformationFromPhysicsBody(this),this.object.parent&&this.object.rotationQuaternion&&(this.getParentsRotation(),this._tmpQuat.conjugateInPlace(),this._tmpQuat.multiplyToRef(this.object.rotationQuaternion,this.object.rotationQuaternion)),this.object.setAbsolutePosition(this.object.position),this._deltaRotation?(this.object.rotationQuaternion&&this.object.rotationQuaternion.multiplyToRef(this._deltaRotation,this.object.rotationQuaternion),this._deltaPosition.applyRotationQuaternionToRef(this._deltaRotation,Oe._TmpVecs[0]),this.object.translate(Oe._TmpVecs[0],1)):this.object.translate(this._deltaPosition,1),this.object.computeWorldMatrix(!0))},this.onCollideEvent=null,this.onCollide=r=>{if(!this._onPhysicsCollideCallbacks.length&&!this.onCollideEvent||!this._physicsEngine)return;const n=this._physicsEngine.getImpostorWithPhysicsBody(r.body);n&&(this.onCollideEvent&&this.onCollideEvent(this,n),this._onPhysicsCollideCallbacks.filter(o=>o.otherImpostors.indexOf(n)!==-1).forEach(o=>{o.callback(this,n,r.point,r.distance,r.impulse,r.normal)}))},!this.object){B.Error("No object was provided. A physics object is obligatory");return}this.object.parent&&i.mass!==0&&B.Warn("A physics impostor has been created for an object which has a parent. Babylon physics currently works in local space so unexpected issues may occur."),!this._scene&&e.getScene&&(this._scene=e.getScene()),this._scene&&(this.type>100&&(this.soft=!0),this._physicsEngine=this._scene.getPhysicsEngine(),this._physicsEngine?(this.object.rotationQuaternion||(this.object.rotation?this.object.rotationQuaternion=Q.RotationYawPitchRoll(this.object.rotation.y,this.object.rotation.x,this.object.rotation.z):this.object.rotationQuaternion=new Q),this._options.mass=i.mass===void 0?0:i.mass,this._options.friction=i.friction===void 0?.2:i.friction,this._options.restitution=i.restitution===void 0?.2:i.restitution,this.soft&&(this._options.mass=this._options.mass>0?this._options.mass:1,this._options.pressure=i.pressure===void 0?200:i.pressure,this._options.stiffness=i.stiffness===void 0?1:i.stiffness,this._options.velocityIterations=i.velocityIterations===void 0?20:i.velocityIterations,this._options.positionIterations=i.positionIterations===void 0?20:i.positionIterations,this._options.fixedPoints=i.fixedPoints===void 0?0:i.fixedPoints,this._options.margin=i.margin===void 0?0:i.margin,this._options.damping=i.damping===void 0?0:i.damping,this._options.path=i.path===void 0?null:i.path,this._options.shape=i.shape===void 0?null:i.shape),this._joints=[],!this.object.parent||this._options.ignoreParent?this._init():this.object.parent.physicsImpostor&&B.Warn("You must affect impostors to children before affecting impostor to parent.")):B.Error("Physics not enabled. Please use scene.enablePhysics(...) before creating impostors."))}get isDisposed(){return this._isDisposed}get mass(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyMass(this):0}set mass(e){this.setMass(e)}get friction(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyFriction(this):0}set friction(e){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyFriction(this,e)}get restitution(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getBodyRestitution(this):0}set restitution(e){!this._physicsEngine||this._physicsEngine.getPhysicsPlugin().setBodyRestitution(this,e)}get pressure(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.setBodyPressure?e.getBodyPressure(this):0}set pressure(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyPressure||t.setBodyPressure(this,e)}get stiffness(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyStiffness?e.getBodyStiffness(this):0}set stiffness(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyStiffness||t.setBodyStiffness(this,e)}get velocityIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyVelocityIterations?e.getBodyVelocityIterations(this):0}set velocityIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyVelocityIterations||t.setBodyVelocityIterations(this,e)}get positionIterations(){if(!this._physicsEngine)return 0;const e=this._physicsEngine.getPhysicsPlugin();return e.getBodyPositionIterations?e.getBodyPositionIterations(this):0}set positionIterations(e){if(!this._physicsEngine)return;const t=this._physicsEngine.getPhysicsPlugin();!t.setBodyPositionIterations||t.setBodyPositionIterations(this,e)}_init(){!this._physicsEngine||(this._physicsEngine.removeImpostor(this),this.physicsBody=null,this._parent=this._parent||this._getPhysicsParent(),!this._isDisposed&&(!this.parent||this._options.ignoreParent)&&this._physicsEngine.addImpostor(this))}_getPhysicsParent(){return this.object.parent instanceof ct?this.object.parent.physicsImpostor:null}isBodyInitRequired(){return this._bodyUpdateRequired||!this._physicsBody&&(!this._parent||!!this._options.ignoreParent)}setScalingUpdated(){this.forceUpdate()}forceUpdate(){this._init(),this.parent&&!this._options.ignoreParent&&this.parent.forceUpdate()}get physicsBody(){return this._parent&&!this._options.ignoreParent?this._parent.physicsBody:this._physicsBody}get parent(){return!this._options.ignoreParent&&this._parent?this._parent:null}set parent(e){this._parent=e}set physicsBody(e){this._physicsBody&&this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().removePhysicsBody(this),this._physicsBody=e,this.resetUpdateFlags()}resetUpdateFlags(){this._bodyUpdateRequired=!1}getObjectExtents(){if(this.object.getBoundingInfo){const e=this.object.rotationQuaternion,t=this.object.scaling.clone();this.object.rotationQuaternion=Oe.IDENTITY_QUATERNION;const i=this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0);i&&i.decompose(t,void 0,void 0);const r=this.object.getBoundingInfo().boundingBox.extendSize.scale(2).multiplyInPlace(t);return r.x=Math.abs(r.x),r.y=Math.abs(r.y),r.z=Math.abs(r.z),this.object.rotationQuaternion=e,this.object.computeWorldMatrix&&this.object.computeWorldMatrix(!0),r}else return Oe.DEFAULT_OBJECT_SIZE}getObjectCenter(){return this.object.getBoundingInfo?this.object.getBoundingInfo().boundingBox.centerWorld:this.object.position}getParam(e){return this._options[e]}setParam(e,t){this._options[e]=t,this._bodyUpdateRequired=!0}setMass(e){this.getParam("mass")!==e&&this.setParam("mass",e),this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setBodyMass(this,e)}getLinearVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getLinearVelocity(this):g.Zero()}setLinearVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setLinearVelocity(this,e)}getAngularVelocity(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getAngularVelocity(this):g.Zero()}setAngularVelocity(e){this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().setAngularVelocity(this,e)}executeNativeFunction(e){this._physicsEngine&&e(this._physicsEngine.getPhysicsPlugin().world,this.physicsBody)}registerBeforePhysicsStep(e){this._onBeforePhysicsStepCallbacks.push(e)}unregisterBeforePhysicsStep(e){const t=this._onBeforePhysicsStepCallbacks.indexOf(e);t>-1?this._onBeforePhysicsStepCallbacks.splice(t,1):B.Warn("Function to remove was not found")}registerAfterPhysicsStep(e){this._onAfterPhysicsStepCallbacks.push(e)}unregisterAfterPhysicsStep(e){const t=this._onAfterPhysicsStepCallbacks.indexOf(e);t>-1?this._onAfterPhysicsStepCallbacks.splice(t,1):B.Warn("Function to remove was not found")}registerOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];this._onPhysicsCollideCallbacks.push({callback:t,otherImpostors:i})}unregisterOnPhysicsCollide(e,t){const i=e instanceof Array?e:[e];let s=-1;this._onPhysicsCollideCallbacks.some((n,o)=>{if(n.callback===t&&n.otherImpostors.length===i.length){const l=n.otherImpostors.every(h=>i.indexOf(h)>-1);return l&&(s=o),l}return!1})?this._onPhysicsCollideCallbacks.splice(s,1):B.Warn("Function to remove was not found")}getParentsRotation(){let e=this.object.parent;for(this._tmpQuat.copyFromFloats(0,0,0,1);e;)e.rotationQuaternion?this._tmpQuat2.copyFrom(e.rotationQuaternion):Q.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,e.rotation.z,this._tmpQuat2),this._tmpQuat.multiplyToRef(this._tmpQuat2,this._tmpQuat),e=e.parent;return this._tmpQuat}applyForce(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyForce(this,e,t),this}applyImpulse(e,t){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().applyImpulse(this,e,t),this}createJoint(e,t,i){const s=new Nt(t,i);return this.addJoint(e,s),this}addJoint(e,t){return this._joints.push({otherImpostor:e,joint:t}),this._physicsEngine&&this._physicsEngine.addJoint(this,e,t),this}addAnchor(e,t,i,s,r){if(!this._physicsEngine)return this;const n=this._physicsEngine.getPhysicsPlugin();return n.appendAnchor?(this._physicsEngine&&n.appendAnchor(this,e,t,i,s,r),this):this}addHook(e,t,i,s){if(!this._physicsEngine)return this;const r=this._physicsEngine.getPhysicsPlugin();return r.appendAnchor?(this._physicsEngine&&r.appendHook(this,e,t,i,s),this):this}sleep(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().sleepBody(this),this}wakeUp(){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().wakeUpBody(this),this}clone(e){return e?new Oe(e,this.type,this._options,this._scene):null}dispose(){!this._physicsEngine||(this._joints.forEach(e=>{this._physicsEngine&&this._physicsEngine.removeJoint(this,e.otherImpostor,e.joint)}),this._physicsEngine.removeImpostor(this),this.parent&&this.parent.forceUpdate(),this._isDisposed=!0)}setDeltaPosition(e){this._deltaPosition.copyFrom(e)}setDeltaRotation(e){this._deltaRotation||(this._deltaRotation=new Q),this._deltaRotation.copyFrom(e),this._deltaRotationConjugated=this._deltaRotation.conjugate()}getBoxSizeToRef(e){return this._physicsEngine&&this._physicsEngine.getPhysicsPlugin().getBoxSizeToRef(this,e),this}getRadius(){return this._physicsEngine?this._physicsEngine.getPhysicsPlugin().getRadius(this):0}syncBoneWithImpostor(e,t,i,s,r){const n=Oe._TmpVecs[0],o=this.object;if(o.rotationQuaternion)if(r){const l=Oe._TmpQuat;o.rotationQuaternion.multiplyToRef(r,l),e.setRotationQuaternion(l,Ze.WORLD,t)}else e.setRotationQuaternion(o.rotationQuaternion,Ze.WORLD,t);n.x=0,n.y=0,n.z=0,i&&(n.x=i.x,n.y=i.y,n.z=i.z,e.getDirectionToRef(n,t,n),s==null&&(s=i.length()),n.x*=s,n.y*=s,n.z*=s),e.getParent()?(n.addInPlace(o.getAbsolutePosition()),e.setAbsolutePosition(n,t)):(t.setAbsolutePosition(o.getAbsolutePosition()),t.position.x-=n.x,t.position.y-=n.y,t.position.z-=n.z)}syncImpostorWithBone(e,t,i,s,r,n){const o=this.object;if(o.rotationQuaternion)if(r){const c=Oe._TmpQuat;e.getRotationQuaternionToRef(Ze.WORLD,t,c),c.multiplyToRef(r,o.rotationQuaternion)}else e.getRotationQuaternionToRef(Ze.WORLD,t,o.rotationQuaternion);const l=Oe._TmpVecs[0],h=Oe._TmpVecs[1];n||(n=Oe._TmpVecs[2],n.x=0,n.y=1,n.z=0),e.getDirectionToRef(n,t,h),e.getAbsolutePositionToRef(t,l),s==null&&i&&(s=i.length()),s!=null&&(l.x+=h.x*s,l.y+=h.y*s,l.z+=h.z*s),o.setAbsolutePosition(l)}}Oe.DEFAULT_OBJECT_SIZE=new g(1,1,1);Oe.IDENTITY_QUATERNION=Q.Identity();Oe._TmpVecs=gi.BuildArray(3,g.Zero);Oe._TmpQuat=Q.Identity();Oe.NoImpostor=0;Oe.SphereImpostor=1;Oe.BoxImpostor=2;Oe.PlaneImpostor=3;Oe.MeshImpostor=4;Oe.CapsuleImpostor=6;Oe.CylinderImpostor=7;Oe.ParticleImpostor=8;Oe.HeightmapImpostor=9;Oe.ConvexHullImpostor=10;Oe.CustomImpostor=100;Oe.RopeImpostor=101;Oe.ClothImpostor=102;Oe.SoftbodyImpostor=103;var Nn;(function(a){a[a.Clean=0]="Clean",a[a.Stop=1]="Stop",a[a.Sync=2]="Sync",a[a.NoSync=3]="NoSync"})(Nn||(Nn={}));class Be{static get ForceFullSceneLoadingForIncremental(){return bi.ForceFullSceneLoadingForIncremental}static set ForceFullSceneLoadingForIncremental(e){bi.ForceFullSceneLoadingForIncremental=e}static get ShowLoadingScreen(){return bi.ShowLoadingScreen}static set ShowLoadingScreen(e){bi.ShowLoadingScreen=e}static get loggingLevel(){return bi.loggingLevel}static set loggingLevel(e){bi.loggingLevel=e}static get CleanBoneMatrixWeights(){return bi.CleanBoneMatrixWeights}static set CleanBoneMatrixWeights(e){bi.CleanBoneMatrixWeights=e}static GetDefaultPlugin(){return Be._RegisteredPlugins[".babylon"]}static _GetPluginForExtension(e){const t=Be._RegisteredPlugins[e];return t||(B.Warn("Unable to find a plugin to load "+e+" files. Trying to use .babylon default plugin. To load from a specific filetype (eg. gltf) see: https://doc.babylonjs.com/features/featuresDeepDive/importers/loadingFileTypes"),Be.GetDefaultPlugin())}static _GetPluginForDirectLoad(e){for(const t in Be._RegisteredPlugins){const i=Be._RegisteredPlugins[t].plugin;if(i.canDirectLoad&&i.canDirectLoad(e))return Be._RegisteredPlugins[t]}return Be.GetDefaultPlugin()}static _GetPluginForFilename(e){const t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));const i=e.lastIndexOf("."),s=e.substring(i,e.length).toLowerCase();return Be._GetPluginForExtension(s)}static _GetDirectLoad(e){return e.substr(0,5)==="data:"?e.substr(5):null}static _FormatErrorMessage(e,t,i){let s="Unable to load from "+e.url;return t?s+=`: ${t}`:i&&(s+=`: ${i}`),s}static _LoadData(e,t,i,s,r,n,o){const l=Be._GetDirectLoad(e.url),h=o?Be._GetPluginForExtension(o):l?Be._GetPluginForDirectLoad(e.url):Be._GetPluginForFilename(e.url);let c;if(h.plugin.createPlugin!==void 0?c=h.plugin.createPlugin():c=h.plugin,!c)throw"The loader plugin corresponding to the file type you are trying to load has not been found. If using es6, please import the plugin you wish to use before.";if(Be.OnPluginActivatedObservable.notifyObservers(c),l&&(c.canDirectLoad&&c.canDirectLoad(e.url)||!Id(e.url))){if(c.directLoad){const b=c.directLoad(t,l);b.then?b.then(S=>{i(c,S)}).catch(S=>{r("Error in directLoad of _loadData: "+S,S)}):i(c,b)}else i(c,l);return c}const u=h.isBinary,d=(b,S)=>{if(t.isDisposed){r("Scene has been disposed");return}i(c,b,S)};let f=null,p=!1;const _=c.onDisposeObservable;_&&_.add(()=>{p=!0,f&&(f.abort(),f=null),n()});const m=()=>{if(p)return;const b=(C,E)=>{r(C==null?void 0:C.statusText,E)},S=e.file||e.url;f=c.loadFile?c.loadFile(t,S,d,s,u,b):t._loadFile(S,d,s,!0,u,b)},v=t.getEngine();let x=v.enableOfflineSupport;if(x){let b=!1;for(const S of t.disableOfflineSupportExceptionRules)if(S.test(e.url)){b=!0;break}x=!b}return x&&k.OfflineProviderFactory?t.offlineProvider=k.OfflineProviderFactory(e.url,m,v.disableManifestCheck):m(),c}static _GetFileInfo(e,t){let i,s,r=null;if(!t)i=e,s=q.GetFilename(e),e=q.GetFolderPath(e);else if(t.name){const n=t;i=`file:${n.name}`,s=n.name,r=n}else if(typeof t=="string"&&t.startsWith("data:"))i=t,s="";else{const n=t;if(n.substr(0,1)==="/")return q.Error("Wrong sceneFilename parameter"),null;i=e+n,s=n}return{url:i,rootUrl:e,name:s,file:r}}static GetPluginForExtension(e){return Be._GetPluginForExtension(e).plugin}static IsPluginForExtensionAvailable(e){return!!Be._RegisteredPlugins[e]}static RegisterPlugin(e){if(typeof e.extensions=="string"){const t=e.extensions;Be._RegisteredPlugins[t.toLowerCase()]={plugin:e,isBinary:!1}}else{const t=e.extensions;Object.keys(t).forEach(i=>{Be._RegisteredPlugins[i.toLowerCase()]={plugin:e,isBinary:t[i].isBinary}})}}static ImportMesh(e,t,i="",s=ye.LastCreatedScene,r=null,n=null,o=null,l=null){if(!s)return B.Error("No scene available to import mesh to"),null;const h=Be._GetFileInfo(t,i);if(!h)return null;const c={};s.addPendingData(c);const u=()=>{s.removePendingData(c)},d=(_,m)=>{const v=Be._FormatErrorMessage(h,_,m);o?o(s,v,new Xr(v,Hn.SceneLoaderError,m)):B.Error(v),u()},f=n?_=>{try{n(_)}catch(m){d("Error in onProgress callback: "+m,m)}}:void 0,p=(_,m,v,x,b,S,C)=>{if(s.importedMeshesFiles.push(h.url),r)try{r(_,m,v,x,b,S,C)}catch(E){d("Error in onSuccess callback: "+E,E)}s.removePendingData(c)};return Be._LoadData(h,s,(_,m,v)=>{if(_.rewriteRootURL&&(h.rootUrl=_.rewriteRootURL(h.rootUrl,v)),_.importMesh){const x=_,b=new Array,S=new Array,C=new Array;if(!x.importMesh(e,s,m,h.rootUrl,b,S,C,d))return;s.loadingPluginName=_.name,p(b,S,C,[],[],[],[])}else _.importMeshAsync(e,s,m,h.rootUrl,f,h.name).then(b=>{s.loadingPluginName=_.name,p(b.meshes,b.particleSystems,b.skeletons,b.animationGroups,b.transformNodes,b.geometries,b.lights)}).catch(b=>{d(b.message,b)})},f,d,u,l)}static ImportMeshAsync(e,t,i="",s=ye.LastCreatedScene,r=null,n=null){return new Promise((o,l)=>{Be.ImportMesh(e,t,i,s,(h,c,u,d,f,p,_)=>{o({meshes:h,particleSystems:c,skeletons:u,animationGroups:d,transformNodes:f,geometries:p,lights:_})},r,(h,c,u)=>{l(u||new Error(c))},n)})}static Load(e,t="",i=ye.LastCreatedEngine,s=null,r=null,n=null,o=null){return i?Be.Append(e,t,new ge(i),s,r,n,o):(q.Error("No engine available"),null)}static LoadAsync(e,t="",i=ye.LastCreatedEngine,s=null,r=null){return new Promise((n,o)=>{Be.Load(e,t,i,l=>{n(l)},s,(l,h,c)=>{o(c||new Error(h))},r)})}static Append(e,t="",i=ye.LastCreatedScene,s=null,r=null,n=null,o=null){if(!i)return B.Error("No scene available to append to"),null;const l=Be._GetFileInfo(e,t);if(!l)return null;const h={};i.addPendingData(h);const c=()=>{i.removePendingData(h)};Be.ShowLoadingScreen&&!this._ShowingLoadingScreen&&(this._ShowingLoadingScreen=!0,i.getEngine().displayLoadingUI(),i.executeWhenReady(()=>{i.getEngine().hideLoadingUI(),this._ShowingLoadingScreen=!1}));const u=(p,_)=>{const m=Be._FormatErrorMessage(l,p,_);n?n(i,m,new Xr(m,Hn.SceneLoaderError,_)):B.Error(m),c()},d=r?p=>{try{r(p)}catch(_){u("Error in onProgress callback",_)}}:void 0,f=()=>{if(s)try{s(i)}catch(p){u("Error in onSuccess callback",p)}i.removePendingData(h)};return Be._LoadData(l,i,(p,_)=>{if(p.load){if(!p.load(i,_,l.rootUrl,u))return;i.loadingPluginName=p.name,f()}else p.loadAsync(i,_,l.rootUrl,d,l.name).then(()=>{i.loadingPluginName=p.name,f()}).catch(v=>{u(v.message,v)})},d,u,c,o)}static AppendAsync(e,t="",i=ye.LastCreatedScene,s=null,r=null){return new Promise((n,o)=>{Be.Append(e,t,i,l=>{n(l)},s,(l,h,c)=>{o(c||new Error(h))},r)})}static LoadAssetContainer(e,t="",i=ye.LastCreatedScene,s=null,r=null,n=null,o=null){if(!i)return B.Error("No scene available to load asset container to"),null;const l=Be._GetFileInfo(e,t);if(!l)return null;const h={};i.addPendingData(h);const c=()=>{i.removePendingData(h)},u=(p,_)=>{const m=Be._FormatErrorMessage(l,p,_);n?n(i,m,new Xr(m,Hn.SceneLoaderError,_)):B.Error(m),c()},d=r?p=>{try{r(p)}catch(_){u("Error in onProgress callback",_)}}:void 0,f=p=>{if(s)try{s(p)}catch(_){u("Error in onSuccess callback",_)}i.removePendingData(h)};return Be._LoadData(l,i,(p,_)=>{if(p.loadAssetContainer){const v=p.loadAssetContainer(i,_,l.rootUrl,u);if(!v)return;i.loadingPluginName=p.name,f(v)}else p.loadAssetContainerAsync?p.loadAssetContainerAsync(i,_,l.rootUrl,d,l.name).then(v=>{i.loadingPluginName=p.name,f(v)}).catch(v=>{u(v.message,v)}):u("LoadAssetContainer is not supported by this plugin. Plugin did not provide a loadAssetContainer or loadAssetContainerAsync method.")},d,u,c,o)}static LoadAssetContainerAsync(e,t="",i=ye.LastCreatedScene,s=null,r=null){return new Promise((n,o)=>{Be.LoadAssetContainer(e,t,i,l=>{n(l)},s,(l,h,c)=>{o(c||new Error(h))},r)})}static ImportAnimations(e,t="",i=ye.LastCreatedScene,s=!0,r=Nn.Clean,n=null,o=null,l=null,h=null,c=null){if(!i){B.Error("No scene available to load animations to");return}if(s){for(const p of i.animatables)p.reset();i.stopAllAnimations(),i.animationGroups.slice().forEach(p=>{p.dispose()}),i.getNodes().forEach(p=>{p.animations&&(p.animations=[])})}else switch(r){case Nn.Clean:i.animationGroups.slice().forEach(f=>{f.dispose()});break;case Nn.Stop:i.animationGroups.forEach(f=>{f.stop()});break;case Nn.Sync:i.animationGroups.forEach(f=>{f.reset(),f.restart()});break;case Nn.NoSync:break;default:B.Error("Unknown animation group loading mode value '"+r+"'");return}const u=i.animatables.length,d=f=>{f.mergeAnimationsTo(i,i.animatables.slice(u),n),f.dispose(),i.onAnimationFileImportedObservable.notifyObservers(i),o&&o(i)};this.LoadAssetContainer(e,t,i,d,l,h,c)}static ImportAnimationsAsync(e,t="",i=ye.LastCreatedScene,s=!0,r=Nn.Clean,n=null,o=null,l=null,h=null,c=null){return new Promise((u,d)=>{Be.ImportAnimations(e,t,i,s,r,n,f=>{u(f)},l,(f,p,_)=>{d(_||new Error(p))},c)})}}Be.NO_LOGGING=0;Be.MINIMAL_LOGGING=1;Be.SUMMARY_LOGGING=2;Be.DETAILED_LOGGING=3;Be.OnPluginActivatedObservable=new X;Be._RegisteredPlugins={};Be._ShowingLoadingScreen=!1;class zo extends ne{constructor(e,t,i=!0){super(e,t),this._normalMatrix=new L,this._storeEffectOnSubMeshes=i}getEffect(){return this._storeEffectOnSubMeshes?this._activeEffect:super.getEffect()}isReady(e,t){return e?!this._storeEffectOnSubMeshes||!e.subMeshes||e.subMeshes.length===0?!0:this.isReadyForSubMesh(e,e.subMeshes[0],t):!1}_isReadyForSubMesh(e){const t=e.materialDefines;return!!(!this.checkReadyOnEveryCall&&e.effect&&t&&t._renderId===this.getScene().getRenderId())}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindOnlyNormalMatrix(e){this._activeEffect.setMatrix("normalMatrix",e)}bind(e,t){!t||this.bindForSubMesh(e,t,t.subMeshes[0])}_afterBind(e,t=null){super._afterBind(e,t),this.getScene()._cachedEffect=t}_mustRebind(e,t,i=1){return e.isCachedMaterialInvalid(this,t,i)}}var I;(function(a){a[a.Float=1]="Float",a[a.Int=2]="Int",a[a.Vector2=4]="Vector2",a[a.Vector3=8]="Vector3",a[a.Vector4=16]="Vector4",a[a.Color3=32]="Color3",a[a.Color4=64]="Color4",a[a.Matrix=128]="Matrix",a[a.Object=256]="Object",a[a.AutoDetect=1024]="AutoDetect",a[a.BasedOnInput=2048]="BasedOnInput"})(I||(I={}));var U;(function(a){a[a.Vertex=1]="Vertex",a[a.Fragment=2]="Fragment",a[a.Neutral=4]="Neutral",a[a.VertexAndFragment=3]="VertexAndFragment"})(U||(U={}));class Cf{constructor(){this.supportUniformBuffers=!1,this.attributes=new Array,this.uniforms=new Array,this.constants=new Array,this.samplers=new Array,this.functions={},this.extensions={},this.counters={},this._attributeDeclaration="",this._uniformDeclaration="",this._constantDeclaration="",this._samplerDeclaration="",this._varyingTransfer="",this._injectAtEnd="",this._repeatableContentAnchorIndex=0,this._builtCompilationString="",this.compilationString=""}finalize(e){const t=e.sharedData.emitComments,i=this.target===U.Fragment;this.compilationString=`\r
${t?`//Entry point\r
`:""}void main(void) {\r
${this.compilationString}`,this._constantDeclaration&&(this.compilationString=`\r
${t?`//Constants\r
`:""}${this._constantDeclaration}\r
${this.compilationString}`);let s="";for(const r in this.functions)s+=this.functions[r]+`\r
`;this.compilationString=`\r
${s}\r
${this.compilationString}`,!i&&this._varyingTransfer&&(this.compilationString=`${this.compilationString}\r
${this._varyingTransfer}`),this._injectAtEnd&&(this.compilationString=`${this.compilationString}\r
${this._injectAtEnd}`),this.compilationString=`${this.compilationString}\r
}`,this.sharedData.varyingDeclaration&&(this.compilationString=`\r
${t?`//Varyings\r
`:""}${this.sharedData.varyingDeclaration}\r
${this.compilationString}`),this._samplerDeclaration&&(this.compilationString=`\r
${t?`//Samplers\r
`:""}${this._samplerDeclaration}\r
${this.compilationString}`),this._uniformDeclaration&&(this.compilationString=`\r
${t?`//Uniforms\r
`:""}${this._uniformDeclaration}\r
${this.compilationString}`),this._attributeDeclaration&&!i&&(this.compilationString=`\r
${t?`//Attributes\r
`:""}${this._attributeDeclaration}\r
${this.compilationString}`),this.compilationString=`precision highp float;\r
`+this.compilationString;for(const r in this.extensions){const n=this.extensions[r];this.compilationString=`\r
${n}\r
${this.compilationString}`}this._builtCompilationString=this.compilationString}get _repeatableContentAnchor(){return`###___ANCHOR${this._repeatableContentAnchorIndex++}___###`}_getFreeVariableName(e){return e=e.replace(/[^a-zA-Z_]+/g,""),this.sharedData.variableNames[e]===void 0?(this.sharedData.variableNames[e]=0,e==="output"||e==="texture"?e+this.sharedData.variableNames[e]:e):(this.sharedData.variableNames[e]++,e+this.sharedData.variableNames[e])}_getFreeDefineName(e){return this.sharedData.defineNames[e]===void 0?this.sharedData.defineNames[e]=0:this.sharedData.defineNames[e]++,e+this.sharedData.defineNames[e]}_excludeVariableName(e){this.sharedData.variableNames[e]=0}_emit2DSampler(e){this.samplers.indexOf(e)<0&&(this._samplerDeclaration+=`uniform sampler2D ${e};\r
`,this.samplers.push(e))}_getGLType(e){switch(e){case I.Float:return"float";case I.Int:return"int";case I.Vector2:return"vec2";case I.Color3:case I.Vector3:return"vec3";case I.Color4:case I.Vector4:return"vec4";case I.Matrix:return"mat4"}return""}_emitExtension(e,t,i=""){this.extensions[e]||(i&&(t=`#if ${i}\r
${t}\r
#endif`),this.extensions[e]=t)}_emitFunction(e,t,i){this.functions[e]||(this.sharedData.emitComments&&(t=i+`\r
`+t),this.functions[e]=t)}_emitCodeFromInclude(e,t,i){if(i&&i.repeatKey)return`#include<${e}>[0..${i.repeatKey}]\r
`;let s=Rt.IncludesShadersStore[e]+`\r
`;if(this.sharedData.emitComments&&(s=t+`\r
`+s),!i)return s;if(i.replaceStrings)for(let r=0;r<i.replaceStrings.length;r++){const n=i.replaceStrings[r];s=s.replace(n.search,n.replace)}return s}_emitFunctionFromInclude(e,t,i,s=""){const r=e+s;if(!this.functions[r]){if(!i||!i.removeAttributes&&!i.removeUniforms&&!i.removeVaryings&&!i.removeIfDef&&!i.replaceStrings){i&&i.repeatKey?this.functions[r]=`#include<${e}>[0..${i.repeatKey}]\r
`:this.functions[r]=`#include<${e}>\r
`,this.sharedData.emitComments&&(this.functions[r]=t+`\r
`+this.functions[r]);return}if(this.functions[r]=Rt.IncludesShadersStore[e],this.sharedData.emitComments&&(this.functions[r]=t+`\r
`+this.functions[r]),i.removeIfDef&&(this.functions[r]=this.functions[r].replace(/^\s*?#ifdef.+$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#endif.*$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#else.*$/gm,""),this.functions[r]=this.functions[r].replace(/^\s*?#elif.*$/gm,"")),i.removeAttributes&&(this.functions[r]=this.functions[r].replace(/^\s*?attribute.+$/gm,"")),i.removeUniforms&&(this.functions[r]=this.functions[r].replace(/^\s*?uniform.+$/gm,"")),i.removeVaryings&&(this.functions[r]=this.functions[r].replace(/^\s*?varying.+$/gm,"")),i.replaceStrings)for(let n=0;n<i.replaceStrings.length;n++){const o=i.replaceStrings[n];this.functions[r]=this.functions[r].replace(o.search,o.replace)}}}_registerTempVariable(e){return this.sharedData.temps.indexOf(e)!==-1?!1:(this.sharedData.temps.push(e),!0)}_emitVaryingFromString(e,t,i="",s=!1){return this.sharedData.varyings.indexOf(e)!==-1?!1:(this.sharedData.varyings.push(e),i&&(i.startsWith("defined(")?this.sharedData.varyingDeclaration+=`#if ${i}\r
`:this.sharedData.varyingDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\r
`),this.sharedData.varyingDeclaration+=`varying ${t} ${e};\r
`,i&&(this.sharedData.varyingDeclaration+=`#endif\r
`),!0)}_emitUniformFromString(e,t,i="",s=!1){this.uniforms.indexOf(e)===-1&&(this.uniforms.push(e),i&&(i.startsWith("defined(")?this._uniformDeclaration+=`#if ${i}\r
`:this._uniformDeclaration+=`${s?"#ifndef":"#ifdef"} ${i}\r
`),this._uniformDeclaration+=`uniform ${t} ${e};\r
`,i&&(this._uniformDeclaration+=`#endif\r
`))}_emitFloat(e){return e.toString()===e.toFixed(0)?`${e}.0`:e.toString()}}class O1{constructor(){this.temps=new Array,this.varyings=new Array,this.varyingDeclaration="",this.inputBlocks=new Array,this.textureBlocks=new Array,this.bindableBlocks=new Array,this.forcedBindableBlocks=new Array,this.blocksWithFallbacks=new Array,this.blocksWithDefines=new Array,this.repeatableContentBlocks=new Array,this.dynamicUniformBlocks=new Array,this.blockingBlocks=new Array,this.animatedInputs=new Array,this.variableNames={},this.defineNames={},this.hints={needWorldViewMatrix:!1,needWorldViewProjectionMatrix:!1,needAlphaBlending:!1,needAlphaTesting:!1},this.checks={emitVertex:!1,emitFragment:!1,notConnectedNonOptionalInputs:new Array},this.allowEmptyVertexProgram=!1,this.variableNames.position=0,this.variableNames.normal=0,this.variableNames.tangent=0,this.variableNames.uv=0,this.variableNames.uv2=0,this.variableNames.uv3=0,this.variableNames.uv4=0,this.variableNames.uv5=0,this.variableNames.uv6=0,this.variableNames.color=0,this.variableNames.matricesIndices=0,this.variableNames.matricesWeights=0,this.variableNames.matricesIndicesExtra=0,this.variableNames.matricesWeightsExtra=0,this.variableNames.diffuseBase=0,this.variableNames.specularBase=0,this.variableNames.worldPos=0,this.variableNames.shadow=0,this.variableNames.view=0,this.variableNames.vTBN=0,this.defineNames.MAINUV0=0,this.defineNames.MAINUV1=0,this.defineNames.MAINUV2=0,this.defineNames.MAINUV3=0,this.defineNames.MAINUV4=0,this.defineNames.MAINUV5=0,this.defineNames.MAINUV6=0,this.defineNames.MAINUV7=0}emitErrors(){let e="";!this.checks.emitVertex&&!this.allowEmptyVertexProgram&&(e+=`NodeMaterial does not have a vertex output. You need to at least add a block that generates a glPosition value.\r
`),this.checks.emitFragment||(e+=`NodeMaterial does not have a fragment output. You need to at least add a block that generates a glFragColor value.\r
`);for(const t of this.checks.notConnectedNonOptionalInputs)e+=`input ${t.name} from block ${t.ownerBlock.name}[${t.ownerBlock.getClassName()}] is not connected and is not optional.\r
`;if(e)throw`Build of NodeMaterial failed:\r
`+e}}var Ks;(function(a){a[a.Compatible=0]="Compatible",a[a.TypeIncompatible=1]="TypeIncompatible",a[a.TargetIncompatible=2]="TargetIncompatible",a[a.HierarchyIssue=3]="HierarchyIssue"})(Ks||(Ks={}));var fi;(function(a){a[a.Input=0]="Input",a[a.Output=1]="Output"})(fi||(fi={}));class Ro{constructor(e,t,i){this._connectedPoint=null,this._endpoints=new Array,this._typeConnectionSource=null,this._defaultConnectionPointType=null,this._linkedConnectionSource=null,this._acceptedConnectionPointType=null,this._type=I.Float,this._enforceAssociatedVariableName=!1,this.needDualDirectionValidation=!1,this.acceptedConnectionPointTypes=new Array,this.excludedConnectionPointTypes=new Array,this.onConnectionObservable=new X,this.isExposedOnFrame=!1,this.exposedPortPosition=-1,this._prioritizeVertex=!1,this._target=U.VertexAndFragment,this._ownerBlock=t,this.name=e,this._direction=i}static AreEquivalentTypes(e,t){switch(e){case I.Vector3:{if(t===I.Color3)return!0;break}case I.Vector4:{if(t===I.Color4)return!0;break}case I.Color3:{if(t===I.Vector3)return!0;break}case I.Color4:{if(t===I.Vector4)return!0;break}}return!1}get direction(){return this._direction}get associatedVariableName(){return this._ownerBlock.isInput?this._ownerBlock.associatedVariableName:(!this._enforceAssociatedVariableName||!this._associatedVariableName)&&this._connectedPoint?this._connectedPoint.associatedVariableName:this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get innerType(){return this._linkedConnectionSource&&this._linkedConnectionSource.isConnected?this.type:this._type}get type(){if(this._type===I.AutoDetect){if(this._ownerBlock.isInput)return this._ownerBlock.type;if(this._connectedPoint)return this._connectedPoint.type;if(this._linkedConnectionSource&&this._linkedConnectionSource.isConnected)return this._linkedConnectionSource.type}if(this._type===I.BasedOnInput){if(this._typeConnectionSource)return!this._typeConnectionSource.isConnected&&this._defaultConnectionPointType?this._defaultConnectionPointType:this._typeConnectionSource.type;if(this._defaultConnectionPointType)return this._defaultConnectionPointType}return this._type}set type(e){this._type=e}get target(){return!this._prioritizeVertex||!this._ownerBlock?this._target:this._target!==U.VertexAndFragment?this._target:this._ownerBlock.target===U.Fragment?U.Fragment:U.Vertex}set target(e){this._target=e}get isConnected(){return this.connectedPoint!==null||this.hasEndpoints}get isConnectedToInputBlock(){return this.connectedPoint!==null&&this.connectedPoint.ownerBlock.isInput}get connectInputBlock(){return this.isConnectedToInputBlock?this.connectedPoint.ownerBlock:null}get connectedPoint(){return this._connectedPoint}get ownerBlock(){return this._ownerBlock}get sourceBlock(){return this._connectedPoint?this._connectedPoint.ownerBlock:null}get connectedBlocks(){return this._endpoints.length===0?[]:this._endpoints.map(e=>e.ownerBlock)}get endpoints(){return this._endpoints}get hasEndpoints(){return this._endpoints&&this._endpoints.length>0}get isDirectlyConnectedToVertexOutput(){if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===U.Vertex||(e.ownerBlock.target===U.Neutral||e.ownerBlock.target===U.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isDirectlyConnectedToVertexOutput))return!0;return!1}get isConnectedInVertexShader(){if(this.target===U.Vertex)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===U.Vertex||e.target===U.Vertex||(e.ownerBlock.target===U.Neutral||e.ownerBlock.target===U.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInVertexShader))return!0;return!1}get isConnectedInFragmentShader(){if(this.target===U.Fragment)return!0;if(!this.hasEndpoints)return!1;for(const e of this._endpoints)if(e.ownerBlock.target===U.Fragment||(e.ownerBlock.target===U.Neutral||e.ownerBlock.target===U.VertexAndFragment)&&e.ownerBlock.outputs.some(t=>t.isConnectedInFragmentShader))return!0;return!1}createCustomInputBlock(){return null}getClassName(){return"NodeMaterialConnectionPoint"}canConnectTo(e){return this.checkCompatibilityState(e)===Ks.Compatible}checkCompatibilityState(e){const t=this._ownerBlock,i=e.ownerBlock;if(t.target===U.Fragment){if(i.target===U.Vertex)return Ks.TargetIncompatible;for(const n of i.outputs)if(n.ownerBlock.target!=U.Neutral&&n.isConnectedInVertexShader)return Ks.TargetIncompatible}if(this.type!==e.type&&e.innerType!==I.AutoDetect)return Ro.AreEquivalentTypes(this.type,e.type)||e.acceptedConnectionPointTypes&&e.acceptedConnectionPointTypes.indexOf(this.type)!==-1||e._acceptedConnectionPointType&&Ro.AreEquivalentTypes(e._acceptedConnectionPointType.type,this.type)?Ks.Compatible:Ks.TypeIncompatible;if(e.excludedConnectionPointTypes&&e.excludedConnectionPointTypes.indexOf(this.type)!==-1)return Ks.TypeIncompatible;let s=i,r=t;return this.direction===fi.Input&&(s=t,r=i),s.isAnAncestorOf(r)?Ks.HierarchyIssue:Ks.Compatible}connectTo(e,t=!1){if(!t&&!this.canConnectTo(e))throw"Cannot connect these two connectors.";return this._endpoints.push(e),e._connectedPoint=this,this._enforceAssociatedVariableName=!1,this.onConnectionObservable.notifyObservers(e),e.onConnectionObservable.notifyObservers(this),this}disconnectFrom(e){const t=this._endpoints.indexOf(e);return t===-1?this:(this._endpoints.splice(t,1),e._connectedPoint=null,this._enforceAssociatedVariableName=!1,e._enforceAssociatedVariableName=!1,this)}serialize(e=!0){const t={};return t.name=this.name,t.displayName=this.displayName,e&&this.connectedPoint&&(t.inputName=this.name,t.targetBlockId=this.connectedPoint.ownerBlock.uniqueId,t.targetConnectionName=this.connectedPoint.name,t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),(this.isExposedOnFrame||this.exposedPortPosition>=0)&&(t.isExposedOnFrame=!0,t.exposedPortPosition=this.exposedPortPosition),t}dispose(){this.onConnectionObservable.clear()}}class Ie{constructor(e,t=U.Vertex,i=!1,s=!1){this._isFinalMerger=!1,this._isInput=!1,this._name="",this._isUnique=!1,this.inputsAreExclusive=!1,this._codeVariableName="",this._inputs=new Array,this._outputs=new Array,this.comments="",this.visibleInInspector=!1,this.visibleOnFrame=!1,this._target=t,this._originalTargetIsNeutral=t===U.Neutral,this._isFinalMerger=i,this._isInput=s,this._name=e,this.uniqueId=xc.UniqueId}get name(){return this._name}set name(e){!this.validateBlockName(e)||(this._name=e)}get isUnique(){return this._isUnique}get isFinalMerger(){return this._isFinalMerger}get isInput(){return this._isInput}get buildId(){return this._buildId}set buildId(e){this._buildId=e}get target(){return this._target}set target(e){(this._target&e)===0&&(this._target=e)}get inputs(){return this._inputs}get outputs(){return this._outputs}getInputByName(e){const t=this._inputs.filter(i=>i.name===e);return t.length?t[0]:null}getOutputByName(e){const t=this._outputs.filter(i=>i.name===e);return t.length?t[0]:null}initialize(e){}bind(e,t,i,s){}_declareOutput(e,t){return`${t._getGLType(e.type)} ${e.associatedVariableName}`}_writeVariable(e){return e.connectedPoint?`${e.associatedVariableName}`:"0."}_writeFloat(e){let t=e.toString();return t.indexOf(".")===-1&&(t+=".0"),`${t}`}getClassName(){return"NodeMaterialBlock"}registerInput(e,t,i=!1,s,r){return r=r!=null?r:new Ro(e,this,fi.Input),r.type=t,r.isOptional=i,s&&(r.target=s),this._inputs.push(r),this}registerOutput(e,t,i,s){return s=s!=null?s:new Ro(e,this,fi.Output),s.type=t,i&&(s.target=i),this._outputs.push(s),this}getFirstAvailableInput(e=null){for(const t of this._inputs)if(!t.connectedPoint&&(!e||e.type===t.type||t.type===I.AutoDetect))return t;return null}getFirstAvailableOutput(e=null){for(const t of this._outputs)if(!e||!e.target||e.target===U.Neutral||(e.target&t.target)!==0)return t;return null}getSiblingOutput(e){const t=this._outputs.indexOf(e);return t===-1||t>=this._outputs.length?null:this._outputs[t+1]}isAnAncestorOf(e){for(const t of this._outputs)if(!!t.hasEndpoints){for(const i of t.endpoints)if(i.ownerBlock===e||i.ownerBlock.isAnAncestorOf(e))return!0}return!1}connectTo(e,t){if(this._outputs.length===0)return;let i=t&&t.output?this.getOutputByName(t.output):this.getFirstAvailableOutput(e),s=!0;for(;s;){const r=t&&t.input?e.getInputByName(t.input):e.getFirstAvailableInput(i);if(i&&r&&i.canConnectTo(r))i.connectTo(r),s=!1;else if(i)i=this.getSiblingOutput(i);else throw"Unable to find a compatible match"}return this}_buildBlock(e){}updateUniformsAndSamples(e,t,i,s){}provideFallbacks(e,t){}initializeDefines(e,t,i,s=!1){}prepareDefines(e,t,i,s=!1,r){}autoConfigure(e){}replaceRepeatableContent(e,t,i,s){}get willBeGeneratedIntoVertexShaderFromFragmentShader(){return this.isInput||this.isFinalMerger||this._outputs.some(e=>e.isDirectlyConnectedToVertexOutput)||this.target===U.Vertex?!1:!!((this.target===U.VertexAndFragment||this.target===U.Neutral)&&this._outputs.some(e=>e.isConnectedInVertexShader))}isReady(e,t,i,s=!1){return!0}_linkConnectionTypes(e,t,i=!1){i?this._inputs[t]._acceptedConnectionPointType=this._inputs[e]:this._inputs[e]._linkedConnectionSource=this._inputs[t],this._inputs[t]._linkedConnectionSource=this._inputs[e]}_processBuild(e,t,i,s){e.build(t,s);const r=t._vertexState!=null,n=e._buildTarget===U.Vertex&&e.target!==U.VertexAndFragment;if(r&&((e.target&e._buildTarget)===0||(e.target&i.target)===0||this.target!==U.VertexAndFragment&&n)&&(!e.isInput&&t.target!==e._buildTarget||e.isInput&&e.isAttribute&&!e._noContextSwitch)){const o=i.connectedPoint;t._vertexState._emitVaryingFromString("v_"+o.associatedVariableName,t._getGLType(o.type))&&(t._vertexState.compilationString+=`${"v_"+o.associatedVariableName} = ${o.associatedVariableName};\r
`),i.associatedVariableName="v_"+o.associatedVariableName,i._enforceAssociatedVariableName=!0}}validateBlockName(e){const t=["position","normal","tangent","particle_positionw","uv","uv2","uv3","uv4","uv5","uv6","position2d","particle_uv","matricesIndices","matricesWeights","world0","world1","world2","world3","particle_color","particle_texturemask"];for(const i of t)if(e===i)return!1;return!0}build(e,t){if(this._buildId===e.sharedData.buildId)return!0;if(!this.isInput)for(const i of this._outputs)i.associatedVariableName||(i.associatedVariableName=e._getFreeVariableName(i.name));for(const i of this._inputs){if(!i.connectedPoint){i.isOptional||e.sharedData.checks.notConnectedNonOptionalInputs.push(i);continue}if(this.target!==U.Neutral&&((i.target&this.target)===0||(i.target&e.target)===0))continue;const s=i.connectedPoint.ownerBlock;s&&s!==this&&this._processBuild(s,e,i,t)}if(this._buildId===e.sharedData.buildId)return!0;if(e.sharedData.verbose&&console.log(`${e.target===U.Vertex?"Vertex shader":"Fragment shader"}: Building ${this.name} [${this.getClassName()}]`),this.isFinalMerger)switch(e.target){case U.Vertex:e.sharedData.checks.emitVertex=!0;break;case U.Fragment:e.sharedData.checks.emitFragment=!0;break}!this.isInput&&e.sharedData.emitComments&&(e.compilationString+=`\r
//${this.name}\r
`),this._buildBlock(e),this._buildId=e.sharedData.buildId,this._buildTarget=e.target;for(const i of this._outputs)if((i.target&e.target)!==0)for(const s of i.endpoints){const r=s.ownerBlock;r&&(r.target&e.target)!==0&&t.indexOf(r)!==-1&&this._processBuild(r,e,s,t)}return!1}_inputRename(e){return e}_outputRename(e){return e}_dumpPropertiesCode(){const e=this._codeVariableName;return`${e}.visibleInInspector = ${this.visibleInInspector};\r
${e}.visibleOnFrame = ${this.visibleOnFrame};\r
${e}.target = ${this.target};\r
`}_dumpCode(e,t){t.push(this);let i;const s=this.name.replace(/[^A-Za-z_]+/g,"");if(this._codeVariableName=s||`${this.getClassName()}_${this.uniqueId}`,e.indexOf(this._codeVariableName)!==-1){let r=0;do r++,this._codeVariableName=s+r;while(e.indexOf(this._codeVariableName)!==-1)}e.push(this._codeVariableName),i=`\r
// ${this.getClassName()}\r
`,this.comments&&(i+=`// ${this.comments}\r
`),i+=`var ${this._codeVariableName} = new BABYLON.${this.getClassName()}("${this.name}");\r
`,i+=this._dumpPropertiesCode();for(const r of this.inputs){if(!r.isConnected)continue;const o=r.connectedPoint.ownerBlock;t.indexOf(o)===-1&&(i+=o._dumpCode(e,t))}for(const r of this.outputs)if(!!r.hasEndpoints)for(const n of r.endpoints){const o=n.ownerBlock;o&&t.indexOf(o)===-1&&(i+=o._dumpCode(e,t))}return i}_dumpCodeForOutputConnections(e){let t="";if(e.indexOf(this)!==-1)return t;e.push(this);for(const i of this.inputs){if(!i.isConnected)continue;const s=i.connectedPoint,r=s.ownerBlock;t+=r._dumpCodeForOutputConnections(e),t+=`${r._codeVariableName}.${r._outputRename(s.name)}.connectTo(${this._codeVariableName}.${this._inputRename(i.name)});\r
`}return t}clone(e,t=""){const i=this.serialize(),s=Si(i.customType);if(s){const r=new s;return r._deserialize(i,e,t),r}return null}serialize(){const e={};e.customType="BABYLON."+this.getClassName(),e.id=this.uniqueId,e.name=this.name,e.comments=this.comments,e.visibleInInspector=this.visibleInInspector,e.visibleOnFrame=this.visibleOnFrame,e.target=this.target,e.inputs=[],e.outputs=[];for(const t of this.inputs)e.inputs.push(t.serialize());for(const t of this.outputs)e.outputs.push(t.serialize(!1));return e}_deserialize(e,t,i){var s;this.name=e.name,this.comments=e.comments,this.visibleInInspector=!!e.visibleInInspector,this.visibleOnFrame=!!e.visibleOnFrame,this._target=(s=e.target)!==null&&s!==void 0?s:this.target,this._deserializePortDisplayNamesAndExposedOnFrame(e)}_deserializePortDisplayNamesAndExposedOnFrame(e){const t=e.inputs,i=e.outputs;t&&t.forEach((s,r)=>{s.displayName&&(this.inputs[r].displayName=s.displayName),s.isExposedOnFrame&&(this.inputs[r].isExposedOnFrame=s.isExposedOnFrame,this.inputs[r].exposedPortPosition=s.exposedPortPosition)}),i&&i.forEach((s,r)=>{s.displayName&&(this.outputs[r].displayName=s.displayName),s.isExposedOnFrame&&(this.outputs[r].isExposedOnFrame=s.isExposedOnFrame,this.outputs[r].exposedPortPosition=s.exposedPortPosition)})}dispose(){for(const e of this.inputs)e.dispose();for(const e of this.outputs)e.dispose()}}class id extends Ie{constructor(e){super(e,U.Neutral),this.complementW=1,this.complementZ=0,this.target=U.Vertex,this.registerInput("vector",I.AutoDetect),this.registerInput("transform",I.Matrix),this.registerOutput("output",I.Vector4),this.registerOutput("xyz",I.Vector3),this._inputs[0].onConnectionObservable.add(t=>{if(t.ownerBlock.isInput){const i=t.ownerBlock;(i.name==="normal"||i.name==="tangent")&&(this.complementW=0)}})}getClassName(){return"TransformBlock"}get vector(){return this._inputs[0]}get output(){return this._outputs[0]}get xyz(){return this._outputs[1]}get transform(){return this._inputs[1]}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.transform;if(t.connectedPoint){if(this.complementW===0){const s=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",s),e.sharedData.blocksWithDefines.push(this);const r=e._getFreeVariableName(`${i.associatedVariableName}_NUS`);switch(e.compilationString+=`mat3 ${r} = mat3(${i.associatedVariableName});\r
`,e.compilationString+=`#ifdef NONUNIFORMSCALING\r
`,e.compilationString+=`${r} = transposeMat3(inverseMat3(${r}));\r
`,e.compilationString+=`#endif\r
`,t.connectedPoint.type){case I.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${r} * vec3(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}), ${this._writeFloat(this.complementW)});\r
`;break;case I.Vector3:case I.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${r} * ${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = vec4(${r} * ${t.associatedVariableName}.xyz, ${this._writeFloat(this.complementW)});\r
`;break}}else{const s=i.associatedVariableName;switch(t.connectedPoint.type){case I.Vector2:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementZ)}, ${this._writeFloat(this.complementW)});\r
`;break;case I.Vector3:case I.Color3:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * vec4(${t.associatedVariableName}, ${this._writeFloat(this.complementW)});\r
`;break;default:e.compilationString+=this._declareOutput(this.output,e)+` = ${s} * ${t.associatedVariableName};\r
`;break}}this.xyz.hasEndpoints&&(e.compilationString+=this._declareOutput(this.xyz,e)+` = ${this.output.associatedVariableName}.xyz;\r
`)}return this}prepareDefines(e,t,i){e.nonUniformScaling&&i.setValue("NONUNIFORMSCALING",!0)}serialize(){const e=super.serialize();return e.complementZ=this.complementZ,e.complementW=this.complementW,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.complementZ=e.complementZ!==void 0?e.complementZ:0,this.complementW=e.complementW!==void 0?e.complementW:1}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.complementZ = ${this.complementZ};\r
`;return e+=`${this._codeVariableName}.complementW = ${this.complementW};\r
`,e}}he("BABYLON.TransformBlock",id);class Mh extends Ie{constructor(e){super(e,U.Vertex,!0),this.registerInput("vector",I.Vector4)}getClassName(){return"VertexOutputBlock"}get vector(){return this._inputs[0]}_isLogarithmicDepthEnabled(e){for(const t of e)if(t.useLogarithmicDepth)return!0;return!1}_buildBlock(e){super._buildBlock(e);const t=this.vector;return e.compilationString+=`gl_Position = ${t.associatedVariableName};\r
`,this._isLogarithmicDepthEnabled(e.sharedData.fragmentOutputNodes)&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.compilationString+=`vFragmentDepth = 1.0 + gl_Position.w;\r
`,e.compilationString+=`gl_Position.z = log2(max(0.000001, vFragmentDepth)) * logarithmicDepthConstant;\r
`),this}}he("BABYLON.VertexOutputBlock",Mh);var at;(function(a){a[a.Boolean=0]="Boolean",a[a.Float=1]="Float",a[a.Int=2]="Int",a[a.Vector2=3]="Vector2",a[a.List=4]="List"})(at||(at={}));function ft(a,e=at.Boolean,t="PROPERTIES",i){return(s,r)=>{let n=s._propStore;n||(n=[],s._propStore=n),n.push({propertyName:r,displayName:a,type:e,groupName:t,options:i!=null?i:{}})}}class kn extends Ie{constructor(e){super(e,U.Fragment,!0),this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this.useLogarithmicDepth=!1,this.registerInput("rgba",I.Color4,!0),this.registerInput("rgb",I.Color3,!0),this.registerInput("a",I.Float,!0),this.rgb.acceptedConnectionPointTypes.push(I.Float)}getClassName(){return"FragmentOutputBlock"}initialize(e){e._excludeVariableName("logarithmicDepthConstant"),e._excludeVariableName("vFragmentDepth")}get rgba(){return this._inputs[0]}get rgb(){return this._inputs[1]}get a(){return this._inputs[2]}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToLinearSpace,!0),i.setValue(this._gammaDefineName,this.convertToGammaSpace,!0)}bind(e,t,i){this.useLogarithmicDepth&&i&&se.BindLogDepth(void 0,e,i.getScene())}_buildBlock(e){super._buildBlock(e);const t=this.rgba,i=this.rgb,s=this.a;e.sharedData.hints.needAlphaBlending=t.isConnected||s.isConnected,e.sharedData.blocksWithDefines.push(this),this.useLogarithmicDepth&&(e._emitUniformFromString("logarithmicDepthConstant","float"),e._emitVaryingFromString("vFragmentDepth","float"),e.sharedData.bindableBlocks.push(this)),this._linearDefineName=e._getFreeDefineName("CONVERTTOLINEAR"),this._gammaDefineName=e._getFreeDefineName("CONVERTTOGAMMA");const r=`//${this.name}`;if(e._emitFunctionFromInclude("helperFunctions",r),t.connectedPoint)s.isConnected?e.compilationString+=`gl_FragColor = vec4(${t.associatedVariableName}.rgb, ${s.associatedVariableName});\r
`:e.compilationString+=`gl_FragColor = ${t.associatedVariableName};\r
`;else if(i.connectedPoint){let n="1.0";s.connectedPoint&&(n=s.associatedVariableName),i.connectedPoint.type===I.Float?e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${i.associatedVariableName}, ${i.associatedVariableName}, ${n});\r
`:e.compilationString+=`gl_FragColor = vec4(${i.associatedVariableName}, ${n});\r
`}else e.sharedData.checks.notConnectedNonOptionalInputs.push(t);return e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`gl_FragColor = toLinearSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`gl_FragColor = toGammaSpace(gl_FragColor);\r
`,e.compilationString+=`#endif\r
`,this.useLogarithmicDepth&&(e.compilationString+=`gl_FragDepthEXT = log2(vFragmentDepth) * logarithmicDepthConstant * 0.5;\r
`),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.useLogarithmicDepth = ${this.useLogarithmicDepth};\r
`,e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.useLogarithmicDepth=this.useLogarithmicDepth,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=e.convertToLinearSpace,this.useLogarithmicDepth=(s=e.useLogarithmicDepth)!==null&&s!==void 0?s:!1}}T([ft("Convert to gamma space",at.Boolean,"PROPERTIES",{notifiers:{update:!0}})],kn.prototype,"convertToGammaSpace",void 0);T([ft("Convert to linear space",at.Boolean,"PROPERTIES",{notifiers:{update:!0}})],kn.prototype,"convertToLinearSpace",void 0);T([ft("Use logarithmic depth",at.Boolean,"PROPERTIES")],kn.prototype,"useLogarithmicDepth",void 0);he("BABYLON.FragmentOutputBlock",kn);var ji;(function(a){a[a.Uniform=0]="Uniform",a[a.Attribute=1]="Attribute",a[a.Varying=2]="Varying",a[a.Undefined=3]="Undefined"})(ji||(ji={}));var Ke;(function(a){a[a.World=1]="World",a[a.View=2]="View",a[a.Projection=3]="Projection",a[a.ViewProjection=4]="ViewProjection",a[a.WorldView=5]="WorldView",a[a.WorldViewProjection=6]="WorldViewProjection",a[a.CameraPosition=7]="CameraPosition",a[a.FogColor=8]="FogColor",a[a.DeltaTime=9]="DeltaTime",a[a.CameraParameters=10]="CameraParameters",a[a.MaterialAlpha=11]="MaterialAlpha"})(Ke||(Ke={}));var Ca;(function(a){a[a.None=0]="None",a[a.Time=1]="Time"})(Ca||(Ca={}));const w1={position2d:"position",particle_uv:"vUV",particle_color:"vColor",particle_texturemask:"textureMask",particle_positionw:"vPositionW"},Au={particle_uv:!0,particle_color:!0,particle_texturemask:!0,particle_positionw:!0},yf={particle_texturemask:!0};class Ye extends Ie{constructor(e,t=U.Vertex,i=I.AutoDetect){super(e,t,!1,!0),this._mode=ji.Undefined,this._animationType=Ca.None,this.min=0,this.max=0,this.isBoolean=!1,this.matrixMode=0,this._systemValue=null,this.isConstant=!1,this.groupInInspector="",this.onValueChangedObservable=new X,this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._type=i,this.setDefaultValue(),this.registerOutput("output",i)}get type(){if(this._type===I.AutoDetect){if(this.isUniform&&this.value!=null){if(!isNaN(this.value))return this._type=I.Float,this._type;switch(this.value.getClassName()){case"Vector2":return this._type=I.Vector2,this._type;case"Vector3":return this._type=I.Vector3,this._type;case"Vector4":return this._type=I.Vector4,this._type;case"Color3":return this._type=I.Color3,this._type;case"Color4":return this._type=I.Color4,this._type;case"Matrix":return this._type=I.Matrix,this._type}}if(this.isAttribute)switch(this.name){case"position":case"normal":case"particle_positionw":return this._type=I.Vector3,this._type;case"uv":case"uv2":case"uv3":case"uv4":case"uv5":case"uv6":case"position2d":case"particle_uv":return this._type=I.Vector2,this._type;case"matricesIndices":case"matricesWeights":case"world0":case"world1":case"world2":case"world3":case"tangent":return this._type=I.Vector4,this._type;case"color":case"instanceColor":case"particle_color":case"particle_texturemask":return this._type=I.Color4,this._type}if(this.isSystemValue)switch(this._systemValue){case Ke.World:case Ke.WorldView:case Ke.WorldViewProjection:case Ke.View:case Ke.ViewProjection:case Ke.Projection:return this._type=I.Matrix,this._type;case Ke.CameraPosition:return this._type=I.Vector3,this._type;case Ke.FogColor:return this._type=I.Color3,this._type;case Ke.DeltaTime:case Ke.MaterialAlpha:return this._type=I.Float,this._type;case Ke.CameraParameters:return this._type=I.Vector4,this._type}}return this._type}validateBlockName(e){return this.isAttribute?!0:super.validateBlockName(e)}get output(){return this._outputs[0]}setAsAttribute(e){return this._mode=ji.Attribute,e&&(this.name=e),this}setAsSystemValue(e){return this.systemValue=e,this}get value(){return this._storedValue}set value(e){this.type===I.Float&&(this.isBoolean?e=e?1:0:this.min!==this.max&&(e=Math.max(this.min,e),e=Math.min(this.max,e))),this._storedValue=e,this._mode=ji.Uniform,this.onValueChangedObservable.notifyObservers(this)}get valueCallback(){return this._valueCallback}set valueCallback(e){this._valueCallback=e,this._mode=ji.Uniform}get associatedVariableName(){return this._associatedVariableName}set associatedVariableName(e){this._associatedVariableName=e}get animationType(){return this._animationType}set animationType(e){this._animationType=e}get isUndefined(){return this._mode===ji.Undefined}get isUniform(){return this._mode===ji.Uniform}set isUniform(e){this._mode=e?ji.Uniform:ji.Undefined,this.associatedVariableName=""}get isAttribute(){return this._mode===ji.Attribute}set isAttribute(e){this._mode=e?ji.Attribute:ji.Undefined,this.associatedVariableName=""}get isVarying(){return this._mode===ji.Varying}set isVarying(e){this._mode=e?ji.Varying:ji.Undefined,this.associatedVariableName=""}get isSystemValue(){return this._systemValue!=null}get systemValue(){return this._systemValue}set systemValue(e){this._mode=ji.Uniform,this.associatedVariableName="",this._systemValue=e}getClassName(){return"InputBlock"}animate(e){switch(this._animationType){case Ca.Time:{this.type===I.Float&&(this.value+=e.getAnimationRatio()*.01);break}}}_emitDefine(e){return e[0]==="!"?`#ifndef ${e.substring(1)}\r
`:`#ifdef ${e}\r
`}initialize(){this.associatedVariableName=""}setDefaultValue(){switch(this.type){case I.Float:this.value=0;break;case I.Vector2:this.value=le.Zero();break;case I.Vector3:this.value=g.Zero();break;case I.Vector4:this.value=Ge.Zero();break;case I.Color3:this.value=re.White();break;case I.Color4:this.value=new J(1,1,1,1);break;case I.Matrix:this.value=L.Identity();break}}_emitConstant(e){switch(this.type){case I.Float:return`${e._emitFloat(this.value)}`;case I.Vector2:return`vec2(${this.value.x}, ${this.value.y})`;case I.Vector3:return`vec3(${this.value.x}, ${this.value.y}, ${this.value.z})`;case I.Vector4:return`vec4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;case I.Color3:return ht.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ht.Color3[0].toGammaSpaceToRef(ht.Color3[0]),this.convertToLinearSpace&&ht.Color3[0].toLinearSpaceToRef(ht.Color3[0]),`vec3(${ht.Color3[0].r}, ${ht.Color3[0].g}, ${ht.Color3[0].b})`;case I.Color4:return ht.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ht.Color4[0].toGammaSpaceToRef(ht.Color4[0]),this.convertToLinearSpace&&ht.Color4[0].toLinearSpaceToRef(ht.Color4[0]),`vec4(${ht.Color4[0].r}, ${ht.Color4[0].g}, ${ht.Color4[0].b}, ${ht.Color4[0].a})`}return""}get _noContextSwitch(){return Au[this.name]}_emit(e,t){var i;if(this.isUniform){if(this.associatedVariableName||(this.associatedVariableName=e._getFreeVariableName("u_"+this.name)),this.isConstant){if(e.constants.indexOf(this.associatedVariableName)!==-1)return;e.constants.push(this.associatedVariableName),e._constantDeclaration+=this._declareOutput(this.output,e)+` = ${this._emitConstant(e)};\r
`;return}if(e.uniforms.indexOf(this.associatedVariableName)!==-1)return;e.uniforms.push(this.associatedVariableName),t&&(e._uniformDeclaration+=this._emitDefine(t)),e._uniformDeclaration+=`uniform ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,t&&(e._uniformDeclaration+=`#endif\r
`);const s=e.sharedData.hints;if(this._systemValue!==null&&this._systemValue!==void 0)switch(this._systemValue){case Ke.WorldView:s.needWorldViewMatrix=!0;break;case Ke.WorldViewProjection:s.needWorldViewProjectionMatrix=!0;break}else this._animationType!==Ca.None&&e.sharedData.animatedInputs.push(this);return}if(this.isAttribute){if(this.associatedVariableName=(i=w1[this.name])!==null&&i!==void 0?i:this.name,this.target===U.Vertex&&e._vertexState){Au[this.name]?yf[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):this._emit(e._vertexState,t);return}if(e.attributes.indexOf(this.associatedVariableName)!==-1)return;e.attributes.push(this.associatedVariableName),Au[this.name]?yf[this.name]?e._emitUniformFromString(this.associatedVariableName,e._getGLType(this.type),t):e._emitVaryingFromString(this.associatedVariableName,e._getGLType(this.type),t):(t&&(e._attributeDeclaration+=this._emitDefine(t)),e._attributeDeclaration+=`attribute ${e._getGLType(this.type)} ${this.associatedVariableName};\r
`,t&&(e._attributeDeclaration+=`#endif\r
`))}}_transmitWorld(e,t,i,s){if(!this._systemValue)return;const r=this.associatedVariableName;switch(this._systemValue){case Ke.World:e.setMatrix(r,t);break;case Ke.WorldView:e.setMatrix(r,i);break;case Ke.WorldViewProjection:e.setMatrix(r,s);break}}_transmit(e,t,i){if(this.isAttribute)return;const s=this.associatedVariableName;if(this._systemValue){switch(this._systemValue){case Ke.World:case Ke.WorldView:case Ke.WorldViewProjection:return;case Ke.View:e.setMatrix(s,t.getViewMatrix());break;case Ke.Projection:e.setMatrix(s,t.getProjectionMatrix());break;case Ke.ViewProjection:e.setMatrix(s,t.getTransformMatrix());break;case Ke.CameraPosition:t.bindEyePosition(e,s,!0);break;case Ke.FogColor:e.setColor3(s,t.fogColor);break;case Ke.DeltaTime:e.setFloat(s,t.deltaTime/1e3);break;case Ke.CameraParameters:t.activeCamera&&e.setFloat4(s,t.getEngine().hasOriginBottomLeft?-1:1,t.activeCamera.minZ,t.activeCamera.maxZ,1/t.activeCamera.maxZ);break;case Ke.MaterialAlpha:e.setFloat(s,i.alpha);break}return}const r=this._valueCallback?this._valueCallback():this._storedValue;if(r!==null)switch(this.type){case I.Float:e.setFloat(s,r);break;case I.Int:e.setInt(s,r);break;case I.Color3:ht.Color3[0].set(this.value.r,this.value.g,this.value.b),this.convertToGammaSpace&&ht.Color3[0].toGammaSpaceToRef(ht.Color3[0]),this.convertToLinearSpace&&ht.Color3[0].toLinearSpaceToRef(ht.Color3[0]),e.setColor3(s,ht.Color3[0]);break;case I.Color4:ht.Color4[0].set(this.value.r,this.value.g,this.value.b,this.value.a),this.convertToGammaSpace&&ht.Color4[0].toGammaSpaceToRef(ht.Color4[0]),this.convertToLinearSpace&&ht.Color4[0].toLinearSpaceToRef(ht.Color4[0]),e.setDirectColor4(s,ht.Color4[0]);break;case I.Vector2:e.setVector2(s,r);break;case I.Vector3:e.setVector3(s,r);break;case I.Vector4:e.setVector4(s,r);break;case I.Matrix:e.setMatrix(s,r);break}}_buildBlock(e){super._buildBlock(e),(this.isUniform||this.isSystemValue)&&e.sharedData.inputBlocks.push(this),this._emit(e)}_dumpPropertiesCode(){const e=this._codeVariableName;if(this.isAttribute)return super._dumpPropertiesCode()+`${e}.setAsAttribute("${this.name}");\r
`;if(this.isSystemValue)return super._dumpPropertiesCode()+`${e}.setAsSystemValue(BABYLON.NodeMaterialSystemValues.${Ke[this._systemValue]});\r
`;if(this.isUniform){const t=[];let i="";switch(this.type){case I.Float:i=`${this.value}`;break;case I.Vector2:i=`new BABYLON.Vector2(${this.value.x}, ${this.value.y})`;break;case I.Vector3:i=`new BABYLON.Vector3(${this.value.x}, ${this.value.y}, ${this.value.z})`;break;case I.Vector4:i=`new BABYLON.Vector4(${this.value.x}, ${this.value.y}, ${this.value.z}, ${this.value.w})`;break;case I.Color3:i=`new BABYLON.Color3(${this.value.r}, ${this.value.g}, ${this.value.b})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case I.Color4:i=`new BABYLON.Color4(${this.value.r}, ${this.value.g}, ${this.value.b}, ${this.value.a})`,this.convertToGammaSpace&&(i+=".toGammaSpace()"),this.convertToLinearSpace&&(i+=".toLinearSpace()");break;case I.Matrix:i=`BABYLON.Matrix.FromArray([${this.value.m}])`;break}return t.push(`${e}.value = ${i}`),this.type===I.Float&&t.push(`${e}.min = ${this.min}`,`${e}.max = ${this.max}`,`${e}.isBoolean = ${this.isBoolean}`,`${e}.matrixMode = ${this.matrixMode}`,`${e}.animationType = BABYLON.AnimatedInputBlockTypes.${Ca[this.animationType]}`),t.push(`${e}.isConstant = ${this.isConstant}`),t.push(""),super._dumpPropertiesCode()+t.join(`;\r
`)}return super._dumpPropertiesCode()}dispose(){this.onValueChangedObservable.clear(),super.dispose()}serialize(){const e=super.serialize();return e.type=this.type,e.mode=this._mode,e.systemValue=this._systemValue,e.animationType=this._animationType,e.min=this.min,e.max=this.max,e.isBoolean=this.isBoolean,e.matrixMode=this.matrixMode,e.isConstant=this.isConstant,e.groupInInspector=this.groupInInspector,e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this._storedValue!=null&&this._mode===ji.Uniform&&(this._storedValue.asArray?(e.valueType="BABYLON."+this._storedValue.getClassName(),e.value=this._storedValue.asArray()):(e.valueType="number",e.value=this._storedValue)),e}_deserialize(e,t,i){if(this._mode=e.mode,super._deserialize(e,t,i),this._type=e.type,this._systemValue=e.systemValue||e.wellKnownValue,this._animationType=e.animationType,this.min=e.min||0,this.max=e.max||0,this.isBoolean=!!e.isBoolean,this.matrixMode=e.matrixMode||0,this.isConstant=!!e.isConstant,this.groupInInspector=e.groupInInspector||"",this.convertToGammaSpace=!!e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.name==="tangent"&&e.mode===ji.Attribute&&e.type===I.Vector3&&(this._type=I.Vector4),!!e.valueType)if(e.valueType==="number")this._storedValue=e.value;else{const s=Si(e.valueType);s&&(this._storedValue=s.FromArray(e.value))}}}he("BABYLON.InputBlock",Ye);class w_ extends Ie{constructor(e){super(e,U.VertexAndFragment),this._samplerName="textureSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",I.Vector2,!1,U.VertexAndFragment),this.registerOutput("rgba",I.Color4,U.Neutral),this.registerOutput("rgb",I.Color3,U.Neutral),this.registerOutput("r",I.Float,U.Neutral),this.registerOutput("g",I.Float,U.Neutral),this.registerOutput("b",I.Float,U.Neutral),this.registerOutput("a",I.Float,U.Neutral),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"CurrentScreenBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?U.VertexAndFragment:U.Fragment}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec2")),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name,!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===U.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r
`;return}if(this.uv.ownerBlock.target===U.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName});\r
`;return}e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r
`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===U.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}if(this.uv.ownerBlock.target===U.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.blockingBlocks.indexOf(this)<0&&e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.indexOf(this)<0&&e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.indexOf(this)<0&&e.sharedData.blocksWithDefines.push(this),e.target!==U.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;e._emit2DSampler(this._samplerName),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=H.Parse(e.texture,t,i))}}he("BABYLON.CurrentScreenBlock",w_);class N_ extends Ie{constructor(e){super(e,U.Fragment),this._samplerName="diffuseSampler",this.convertToGammaSpace=!1,this.convertToLinearSpace=!1,this._isUnique=!1,this.registerInput("uv",I.Vector2,!1,U.VertexAndFragment),this.registerOutput("rgba",I.Color4,U.Neutral),this.registerOutput("rgb",I.Color3,U.Neutral),this.registerOutput("r",I.Float,U.Neutral),this.registerOutput("g",I.Float,U.Neutral),this.registerOutput("b",I.Float,U.Neutral),this.registerOutput("a",I.Float,U.Neutral),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4)}getClassName(){return"ParticleTextureBlock"}get uv(){return this._inputs[0]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}initialize(e){e._excludeVariableName("diffuseSampler")}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="particle_uv");t||(t=new Ye("uv"),t.setAsAttribute("particle_uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){i.setValue(this._linearDefineName,this.convertToGammaSpace,!0),i.setValue(this._gammaDefineName,this.convertToLinearSpace,!0)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}_writeOutput(e,t,i){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,e.compilationString+=`#ifdef ${this._linearDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef ${this._gammaDefineName}\r
`,e.compilationString+=`${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_buildBlock(e){if(super._buildBlock(e),e.target===U.Vertex)return;this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e._emit2DSampler(this._samplerName),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA");const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this.uv.associatedVariableName});\r
`;for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,i.name);return this}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=H.Parse(e.texture,t,i))}}he("BABYLON.ParticleTextureBlock",N_);class F_ extends Ie{constructor(e){super(e,U.Fragment),this._isUnique=!0,this.registerInput("color",I.Color4,!1,U.Fragment),this.registerOutput("rampColor",I.Color4,U.Fragment)}getClassName(){return"ParticleRampGradientBlock"}get color(){return this._inputs[0]}get rampColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("remapRanges"),e._excludeVariableName("rampSampler"),e._excludeVariableName("baseColor"),e._excludeVariableName("alpha"),e._excludeVariableName("remappedColorIndex"),e._excludeVariableName("rampColor"),e._excludeVariableName("finalAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==U.Vertex)return e._emit2DSampler("rampSampler"),e._emitVaryingFromString("remapRanges","vec4","RAMPGRADIENT"),e.compilationString+=`
            #ifdef RAMPGRADIENT
                vec4 baseColor = ${this.color.associatedVariableName};
                float alpha = ${this.color.associatedVariableName}.a;

                float remappedColorIndex = clamp((alpha - remapRanges.x) / remapRanges.y, 0.0, 1.0);

                vec4 rampColor = texture2D(rampSampler, vec2(1.0 - remappedColorIndex, 0.));
                baseColor.rgb *= rampColor.rgb;

                // Remapped alpha
                float finalAlpha = baseColor.a;
                baseColor.a = clamp((alpha * rampColor.a - remapRanges.z) / remapRanges.w, 0.0, 1.0);

                ${this._declareOutput(this.rampColor,e)} = baseColor;
            #else
                ${this._declareOutput(this.rampColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}he("BABYLON.ParticleRampGradientBlock",F_);class L_ extends Ie{constructor(e){super(e,U.Fragment),this._isUnique=!0,this.registerInput("color",I.Color4,!1,U.Fragment),this.registerInput("alphaTexture",I.Float,!1,U.Fragment),this.registerInput("alphaColor",I.Float,!1,U.Fragment),this.registerOutput("blendColor",I.Color4,U.Fragment)}getClassName(){return"ParticleBlendMultiplyBlock"}get color(){return this._inputs[0]}get alphaTexture(){return this._inputs[1]}get alphaColor(){return this._inputs[2]}get blendColor(){return this._outputs[0]}initialize(e){e._excludeVariableName("sourceAlpha")}_buildBlock(e){if(super._buildBlock(e),e.target!==U.Vertex)return e.compilationString+=`
            #ifdef BLENDMULTIPLYMODE
                ${this._declareOutput(this.blendColor,e)};
                float sourceAlpha = ${this.alphaColor.associatedVariableName} * ${this.alphaTexture.associatedVariableName};
                ${this.blendColor.associatedVariableName}.rgb = ${this.color.associatedVariableName}.rgb * sourceAlpha + vec3(1.0) * (1.0 - sourceAlpha);
                ${this.blendColor.associatedVariableName}.a = ${this.color.associatedVariableName}.a;
            #else
                ${this._declareOutput(this.blendColor,e)} = ${this.color.associatedVariableName};
            #endif
        `,this}}he("BABYLON.ParticleBlendMultiplyBlock",L_);class Wa{constructor(){this._defines={},this._currentRank=32,this._maxRank=-1,this._mesh=null}unBindMesh(){this._mesh=null}addFallback(e,t){this._defines[e]||(e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e),this._defines[e]=new Array),this._defines[e].push(t)}addCPUSkinningFallback(e,t){this._mesh=t,e<this._currentRank&&(this._currentRank=e),e>this._maxRank&&(this._maxRank=e)}get hasMoreFallbacks(){return this._currentRank<=this._maxRank}reduce(e,t){if(this._mesh&&this._mesh.computeBonesUsingShaders&&this._mesh.numBoneInfluencers>0){this._mesh.computeBonesUsingShaders=!1,e=e.replace("#define NUM_BONE_INFLUENCERS "+this._mesh.numBoneInfluencers,"#define NUM_BONE_INFLUENCERS 0"),t._bonesComputationForcedToCPU=!0;const i=this._mesh.getScene();for(let s=0;s<i.meshes.length;s++){const r=i.meshes[s];if(!r.material){!this._mesh.material&&r.computeBonesUsingShaders&&r.numBoneInfluencers>0&&(r.computeBonesUsingShaders=!1);continue}if(!(!r.computeBonesUsingShaders||r.numBoneInfluencers===0)){if(r.material.getEffect()===t)r.computeBonesUsingShaders=!1;else if(r.subMeshes){for(const n of r.subMeshes)if(n.effect===t){r.computeBonesUsingShaders=!1;break}}}}}else{const i=this._defines[this._currentRank];if(i)for(let s=0;s<i.length;s++)e=e.replace("#define "+i[s],"");this._currentRank++}return e}}class Dh extends Ie{constructor(e){super(e,U.Neutral),this.xSwizzle="x",this.ySwizzle="y",this.zSwizzle="z",this.wSwizzle="w",this.registerInput("xyzw ",I.Vector4,!0),this.registerInput("xyz ",I.Vector3,!0),this.registerInput("xy ",I.Vector2,!0),this.registerInput("zw ",I.Vector2,!0),this.registerInput("x",I.Float,!0),this.registerInput("y",I.Float,!0),this.registerInput("z",I.Float,!0),this.registerInput("w",I.Float,!0),this.registerOutput("xyzw",I.Vector4),this.registerOutput("xyz",I.Vector3),this.registerOutput("xy",I.Vector2),this.registerOutput("zw",I.Vector2)}getClassName(){return"VectorMergerBlock"}get xyzwIn(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get zwIn(){return this._inputs[3]}get x(){return this._inputs[4]}get y(){return this._inputs[5]}get z(){return this._inputs[6]}get w(){return this._inputs[7]}get xyzw(){return this._outputs[0]}get xyzOut(){return this._outputs[1]}get xyOut(){return this._outputs[2]}get zwOut(){return this._outputs[3]}get xy(){return this.xyOut}get xyz(){return this.xyzOut}_inputRename(e){return e==="xyzw "?"xyzwIn":e==="xyz "?"xyzIn":e==="xy "?"xyIn":e==="zw "?"zwIn":e}_buildSwizzle(e){const t=this.xSwizzle+this.ySwizzle+this.zSwizzle+this.wSwizzle;return"."+t.substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.x,i=this.y,s=this.z,r=this.w,n=this.xyIn,o=this.zwIn,l=this.xyzIn,h=this.xyzwIn,c=this._outputs[0],u=this._outputs[1],d=this._outputs[2],f=this._outputs[3];return h.isConnected?(c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = ${h.associatedVariableName}${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${h.associatedVariableName}${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${h.associatedVariableName}${this._buildSwizzle(2)};\r
`)):l.isConnected?(c.hasEndpoints&&(e.compilationString+=this._declareOutput(c,e)+` = vec4(${l.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = ${l.associatedVariableName}${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${l.associatedVariableName}${this._buildSwizzle(2)};\r
`)):n.isConnected?(c.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(c,e)+` = vec4(${n.associatedVariableName}, ${o.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(c,e)+` = vec4(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec3(${n.associatedVariableName}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = ${n.associatedVariableName}${this._buildSwizzle(2)};\r
`),f.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(f,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(f,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(2)};\r
`)):(c.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(c,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${o.associatedVariableName})${this._buildSwizzle(4)};\r
`:e.compilationString+=this._declareOutput(c,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\r
`),u.hasEndpoints&&(e.compilationString+=this._declareOutput(u,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\r
`),d.hasEndpoints&&(e.compilationString+=this._declareOutput(d,e)+` = vec2(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"})${this._buildSwizzle(2)};\r
`),f.hasEndpoints&&(o.isConnected?e.compilationString+=this._declareOutput(f,e)+` = ${o.associatedVariableName}${this._buildSwizzle(2)};\r
`:e.compilationString+=this._declareOutput(f,e)+` = vec2(${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(2)};\r
`)),this}serialize(){const e=super.serialize();return e.xSwizzle=this.xSwizzle,e.ySwizzle=this.ySwizzle,e.zSwizzle=this.zSwizzle,e.wSwizzle=this.wSwizzle,e}_deserialize(e,t,i){var s,r,n,o;super._deserialize(e,t,i),this.xSwizzle=(s=e.xSwizzle)!==null&&s!==void 0?s:"x",this.ySwizzle=(r=e.ySwizzle)!==null&&r!==void 0?r:"y",this.zSwizzle=(n=e.zSwizzle)!==null&&n!==void 0?n:"z",this.wSwizzle=(o=e.wSwizzle)!==null&&o!==void 0?o:"w"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.xSwizzle = "${this.xSwizzle}";\r
`,e+=`${this._codeVariableName}.ySwizzle = "${this.ySwizzle}";\r
`,e+=`${this._codeVariableName}.zSwizzle = "${this.zSwizzle}";\r
`,e+=`${this._codeVariableName}.wSwizzle = "${this.wSwizzle}";\r
`,e}}he("BABYLON.VectorMergerBlock",Dh);class Cc extends Ie{constructor(e){super(e,U.Neutral),this.sourceRange=new le(-1,1),this.targetRange=new le(0,1),this.registerInput("input",I.AutoDetect),this.registerInput("sourceMin",I.Float,!0),this.registerInput("sourceMax",I.Float,!0),this.registerInput("targetMin",I.Float,!0),this.registerInput("targetMax",I.Float,!0),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"RemapBlock"}get input(){return this._inputs[0]}get sourceMin(){return this._inputs[1]}get sourceMax(){return this._inputs[2]}get targetMin(){return this._inputs[3]}get targetMax(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.sourceMin.isConnected?this.sourceMin.associatedVariableName:this._writeFloat(this.sourceRange.x),s=this.sourceMax.isConnected?this.sourceMax.associatedVariableName:this._writeFloat(this.sourceRange.y),r=this.targetMin.isConnected?this.targetMin.associatedVariableName:this._writeFloat(this.targetRange.x),n=this.targetMax.isConnected?this.targetMax.associatedVariableName:this._writeFloat(this.targetRange.y);return e.compilationString+=this._declareOutput(t,e)+` = ${r} + (${this._inputs[0].associatedVariableName} - ${i}) * (${n} - ${r}) / (${s} - ${i});\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.sourceRange = new BABYLON.Vector2(${this.sourceRange.x}, ${this.sourceRange.y});\r
`;return e+=`${this._codeVariableName}.targetRange = new BABYLON.Vector2(${this.targetRange.x}, ${this.targetRange.y});\r
`,e}serialize(){const e=super.serialize();return e.sourceRange=this.sourceRange.asArray(),e.targetRange=this.targetRange.asArray(),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.sourceRange=le.FromArray(e.sourceRange),this.targetRange=le.FromArray(e.targetRange)}}T([ft("From",at.Vector2)],Cc.prototype,"sourceRange",void 0);T([ft("To",at.Vector2)],Cc.prototype,"targetRange",void 0);he("BABYLON.RemapBlock",Cc);class sd extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MultiplyBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} * ${this.right.associatedVariableName};\r
`,this}}he("BABYLON.MultiplyBlock",sd);var Ps;(function(a){a[a.Material=0]="Material",a[a.PostProcess=1]="PostProcess",a[a.Particle=2]="Particle",a[a.ProceduralTexture=3]="ProceduralTexture"})(Ps||(Ps={}));class Pa{constructor(){this.direction1=new g(0,1,0),this.direction2=new g(0,1,0),this.minEmitBox=new g(-.5,-.5,-.5),this.maxEmitBox=new g(.5,.5,.5)}startDirectionFunction(e,t,i,s){const r=oe.RandomRange(this.direction1.x,this.direction2.x),n=oe.RandomRange(this.direction1.y,this.direction2.y),o=oe.RandomRange(this.direction1.z,this.direction2.z);if(s){t.x=r,t.y=n,t.z=o;return}g.TransformNormalFromFloatsToRef(r,n,o,e,t)}startPositionFunction(e,t,i,s){const r=oe.RandomRange(this.minEmitBox.x,this.maxEmitBox.x),n=oe.RandomRange(this.minEmitBox.y,this.maxEmitBox.y),o=oe.RandomRange(this.minEmitBox.z,this.maxEmitBox.z);if(s){t.x=r,t.y=n,t.z=o;return}g.TransformCoordinatesFromFloatsToRef(r,n,o,e,t)}clone(){const e=new Pa;return ys.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2),e.setVector3("minEmitBox",this.minEmitBox),e.setVector3("maxEmitBox",this.maxEmitBox)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3),e.addUniform("minEmitBox",3),e.addUniform("maxEmitBox",3)}getEffectDefines(){return"#define BOXEMITTER"}getClassName(){return"BoxParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e.minEmitBox=this.minEmitBox.asArray(),e.maxEmitBox=this.maxEmitBox.asArray(),e}parse(e){g.FromArrayToRef(e.direction1,0,this.direction1),g.FromArrayToRef(e.direction2,0,this.direction2),g.FromArrayToRef(e.minEmitBox,0,this.minEmitBox),g.FromArrayToRef(e.maxEmitBox,0,this.maxEmitBox)}}class yc{constructor(e=1,t=Math.PI,i=0){this.directionRandomizer=i,this.radiusRange=1,this.heightRange=1,this.emitFromSpawnPointOnly=!1,this.angle=t,this.radius=e}get radius(){return this._radius}set radius(e){this._radius=e,this._buildHeight()}get angle(){return this._angle}set angle(e){this._angle=e,this._buildHeight()}_buildHeight(){this._angle!==0?this._height=this._radius/Math.tan(this._angle/2):this._height=1}startDirectionFunction(e,t,i,s){s?G.Vector3[0].copyFrom(i._localPosition).normalize():i.position.subtractToRef(e.getTranslation(),G.Vector3[0]).normalize();const r=oe.RandomRange(0,this.directionRandomizer),n=oe.RandomRange(0,this.directionRandomizer),o=oe.RandomRange(0,this.directionRandomizer);t.x=G.Vector3[0].x+r,t.y=G.Vector3[0].y+n,t.z=G.Vector3[0].z+o,t.normalize()}startPositionFunction(e,t,i,s){const r=oe.RandomRange(0,Math.PI*2);let n;this.emitFromSpawnPointOnly?n=1e-4:(n=oe.RandomRange(0,this.heightRange),n=1-n*n);let o=this._radius-oe.RandomRange(0,this._radius*this.radiusRange);o=o*n;const l=o*Math.sin(r),h=o*Math.cos(r),c=n*this._height;if(s){t.x=l,t.y=c,t.z=h;return}g.TransformCoordinatesFromFloatsToRef(l,c,h,e,t)}clone(){const e=new yc(this._radius,this._angle,this.directionRandomizer);return ys.DeepCopy(this,e),e}applyToShader(e){e.setFloat2("radius",this._radius,this.radiusRange),e.setFloat("coneAngle",this._angle),e.setFloat2("height",this._height,this.heightRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",2),e.addUniform("coneAngle",1),e.addUniform("height",2),e.addUniform("directionRandomizer",1)}getEffectDefines(){let e="#define CONEEMITTER";return this.emitFromSpawnPointOnly&&(e+=`
#define CONEEMITTERSPAWNPOINT`),e}getClassName(){return"ConeParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this._radius,e.angle=this._angle,e.directionRandomizer=this.directionRandomizer,e.radiusRange=this.radiusRange,e.heightRange=this.heightRange,e.emitFromSpawnPointOnly=this.emitFromSpawnPointOnly,e}parse(e){this.radius=e.radius,this.angle=e.angle,this.directionRandomizer=e.directionRandomizer,this.radiusRange=e.radiusRange!==void 0?e.radiusRange:1,this.heightRange=e.radiusRange!==void 0?e.heightRange:1,this.emitFromSpawnPointOnly=e.emitFromSpawnPointOnly!==void 0?e.emitFromSpawnPointOnly:!1}}class Kl{constructor(e=1,t=1,i=1,s=0){this.radius=e,this.height=t,this.radiusRange=i,this.directionRandomizer=s,this._tempVector=g.Zero()}startDirectionFunction(e,t,i,s,r){i.position.subtractToRef(e.getTranslation(),this._tempVector),this._tempVector.normalize(),g.TransformNormalToRef(this._tempVector,r,this._tempVector);const n=oe.RandomRange(-this.directionRandomizer/2,this.directionRandomizer/2);let o=Math.atan2(this._tempVector.x,this._tempVector.z);if(o+=oe.RandomRange(-Math.PI/2,Math.PI/2)*this.directionRandomizer,this._tempVector.y=n,this._tempVector.x=Math.sin(o),this._tempVector.z=Math.cos(o),this._tempVector.normalize(),s){t.copyFrom(this._tempVector);return}g.TransformNormalFromFloatsToRef(this._tempVector.x,this._tempVector.y,this._tempVector.z,e,t)}startPositionFunction(e,t,i,s){const r=oe.RandomRange(-this.height/2,this.height/2),n=oe.RandomRange(0,2*Math.PI),o=oe.RandomRange((1-this.radiusRange)*(1-this.radiusRange),1),l=Math.sqrt(o)*this.radius,h=l*Math.cos(n),c=l*Math.sin(n);if(s){t.copyFromFloats(h,r,c);return}g.TransformCoordinatesFromFloatsToRef(h,r,c,e,t)}clone(){const e=new Kl(this.radius,this.directionRandomizer);return ys.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define CYLINDEREMITTER"}getClassName(){return"CylinderParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.height=this.height,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.height=e.height,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Ac extends Kl{constructor(e=1,t=1,i=1,s=new g(0,1,0),r=new g(0,1,0)){super(e,t,i),this.direction1=s,this.direction2=r}startDirectionFunction(e,t){const i=oe.RandomRange(this.direction1.x,this.direction2.x),s=oe.RandomRange(this.direction1.y,this.direction2.y),r=oe.RandomRange(this.direction1.z,this.direction2.z);g.TransformNormalFromFloatsToRef(i,s,r,e,t)}clone(){const e=new Ac(this.radius,this.height,this.radiusRange,this.direction1,this.direction2);return ys.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("height",this.height),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("height",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define CYLINDEREMITTER
#define DIRECTEDCYLINDEREMITTER`}getClassName(){return"CylinderDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class Rc{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const r=i.position.subtract(e.getTranslation()).normalize(),n=oe.RandomRange(0,this.directionRandomizer),o=oe.RandomRange(0,this.directionRandomizer),l=oe.RandomRange(0,this.directionRandomizer);if(r.x+=n,r.y+=o,r.z+=l,r.normalize(),s){t.copyFrom(r);return}g.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}startPositionFunction(e,t,i,s){const r=this.radius-oe.RandomRange(0,this.radius*this.radiusRange),n=oe.RandomRange(0,1),o=oe.RandomRange(0,2*Math.PI),l=Math.acos(2*n-1),h=r*Math.cos(o)*Math.sin(l),c=r*Math.cos(l),u=r*Math.sin(o)*Math.sin(l);if(s){t.copyFromFloats(h,Math.abs(c),u);return}g.TransformCoordinatesFromFloatsToRef(h,Math.abs(c),u,e,t)}clone(){const e=new Rc(this.radius,this.directionRandomizer);return ys.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define HEMISPHERICEMITTER"}getClassName(){return"HemisphericParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Ic{constructor(){this.direction1=new g(0,1,0),this.direction2=new g(0,1,0)}startDirectionFunction(e,t,i,s){const r=oe.RandomRange(this.direction1.x,this.direction2.x),n=oe.RandomRange(this.direction1.y,this.direction2.y),o=oe.RandomRange(this.direction1.z,this.direction2.z);if(s){t.copyFromFloats(r,n,o);return}g.TransformNormalFromFloatsToRef(r,n,o,e,t)}startPositionFunction(e,t,i,s){if(s){t.copyFromFloats(0,0,0);return}g.TransformCoordinatesFromFloatsToRef(0,0,0,e,t)}clone(){const e=new Ic;return ys.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return"#define POINTEMITTER"}getClassName(){return"PointParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){g.FromArrayToRef(e.direction1,0,this.direction1),g.FromArrayToRef(e.direction2,0,this.direction2)}}class $l{constructor(e=1,t=1,i=0){this.radius=e,this.radiusRange=t,this.directionRandomizer=i}startDirectionFunction(e,t,i,s){const r=i.position.subtract(e.getTranslation()).normalize(),n=oe.RandomRange(0,this.directionRandomizer),o=oe.RandomRange(0,this.directionRandomizer),l=oe.RandomRange(0,this.directionRandomizer);if(r.x+=n,r.y+=o,r.z+=l,r.normalize(),s){t.copyFrom(r);return}g.TransformNormalFromFloatsToRef(r.x,r.y,r.z,e,t)}startPositionFunction(e,t,i,s){const r=this.radius-oe.RandomRange(0,this.radius*this.radiusRange),n=oe.RandomRange(0,1),o=oe.RandomRange(0,2*Math.PI),l=Math.acos(2*n-1),h=r*Math.cos(o)*Math.sin(l),c=r*Math.cos(l),u=r*Math.sin(o)*Math.sin(l);if(s){t.copyFromFloats(h,c,u);return}g.TransformCoordinatesFromFloatsToRef(h,c,u,e,t)}clone(){const e=new $l(this.radius,this.directionRandomizer);return ys.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setFloat("directionRandomizer",this.directionRandomizer)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("directionRandomizer",1)}getEffectDefines(){return"#define SPHEREEMITTER"}getClassName(){return"SphereParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e.radius=this.radius,e.radiusRange=this.radiusRange,e.directionRandomizer=this.directionRandomizer,e}parse(e){this.radius=e.radius,this.radiusRange=e.radiusRange,this.directionRandomizer=e.directionRandomizer}}class Pc extends $l{constructor(e=1,t=new g(0,1,0),i=new g(0,1,0)){super(e),this.direction1=t,this.direction2=i}startDirectionFunction(e,t){const i=oe.RandomRange(this.direction1.x,this.direction2.x),s=oe.RandomRange(this.direction1.y,this.direction2.y),r=oe.RandomRange(this.direction1.z,this.direction2.z);g.TransformNormalFromFloatsToRef(i,s,r,e,t)}clone(){const e=new Pc(this.radius,this.direction1,this.direction2);return ys.DeepCopy(this,e),e}applyToShader(e){e.setFloat("radius",this.radius),e.setFloat("radiusRange",this.radiusRange),e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("radius",1),e.addUniform("radiusRange",1),e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return`#define SPHEREEMITTER
#define DIRECTEDSPHEREEMITTER`}getClassName(){return"SphereDirectedParticleEmitter"}serialize(){const e=super.serialize();return e.direction1=this.direction1.asArray(),e.direction2=this.direction2.asArray(),e}parse(e){super.parse(e),this.direction1.copyFrom(e.direction1),this.direction2.copyFrom(e.direction2)}}class Ma{constructor(){this.particlePositionGenerator=()=>{},this.particleDestinationGenerator=()=>{}}startDirectionFunction(e,t,i,s){const r=G.Vector3[0];if(this.particleDestinationGenerator){this.particleDestinationGenerator(-1,i,r);const n=G.Vector3[1];r.subtractToRef(i.position,n),n.scaleToRef(1/i.lifeTime,r)}else r.set(0,0,0);if(s){t.copyFrom(r);return}g.TransformNormalToRef(r,e,t)}startPositionFunction(e,t,i,s){const r=G.Vector3[0];if(this.particlePositionGenerator?this.particlePositionGenerator(-1,i,r):r.set(0,0,0),s){t.copyFrom(r);return}g.TransformCoordinatesToRef(r,e,t)}clone(){const e=new Ma;return ys.DeepCopy(this,e),e}applyToShader(e){}buildUniformLayout(e){}getEffectDefines(){return"#define CUSTOMEMITTER"}getClassName(){return"CustomParticleEmitter"}serialize(){const e={};return e.type=this.getClassName(),e}parse(e){}}class Wd{constructor(e=null){this._indices=null,this._positions=null,this._normals=null,this._storedNormal=g.Zero(),this._mesh=null,this.direction1=new g(0,1,0),this.direction2=new g(0,1,0),this.useMeshNormalsForDirection=!0,this.mesh=e}get mesh(){return this._mesh}set mesh(e){this._mesh!==e&&(this._mesh=e,e?(this._indices=e.getIndices(),this._positions=e.getVerticesData(y.PositionKind),this._normals=e.getVerticesData(y.NormalKind)):(this._indices=null,this._positions=null,this._normals=null))}startDirectionFunction(e,t,i,s){if(this.useMeshNormalsForDirection&&this._normals){g.TransformNormalToRef(this._storedNormal,e,t);return}const r=oe.RandomRange(this.direction1.x,this.direction2.x),n=oe.RandomRange(this.direction1.y,this.direction2.y),o=oe.RandomRange(this.direction1.z,this.direction2.z);if(s){t.copyFromFloats(r,n,o);return}g.TransformNormalFromFloatsToRef(r,n,o,e,t)}startPositionFunction(e,t,i,s){if(!this._indices||!this._positions)return;const r=3*Math.random()*(this._indices.length/3)|0,n=Math.random(),o=Math.random()*(1-n),l=1-n-o,h=this._indices[r],c=this._indices[r+1],u=this._indices[r+2],d=G.Vector3[0],f=G.Vector3[1],p=G.Vector3[2],_=G.Vector3[3];g.FromArrayToRef(this._positions,h*3,d),g.FromArrayToRef(this._positions,c*3,f),g.FromArrayToRef(this._positions,u*3,p),_.x=n*d.x+o*f.x+l*p.x,_.y=n*d.y+o*f.y+l*p.y,_.z=n*d.z+o*f.z+l*p.z,s?t.copyFromFloats(_.x,_.y,_.z):g.TransformCoordinatesFromFloatsToRef(_.x,_.y,_.z,e,t),this.useMeshNormalsForDirection&&this._normals&&(g.FromArrayToRef(this._normals,h*3,d),g.FromArrayToRef(this._normals,c*3,f),g.FromArrayToRef(this._normals,u*3,p),this._storedNormal.x=n*d.x+o*f.x+l*p.x,this._storedNormal.y=n*d.y+o*f.y+l*p.y,this._storedNormal.z=n*d.z+o*f.z+l*p.z)}clone(){const e=new Wd(this.mesh);return ys.DeepCopy(this,e),e}applyToShader(e){e.setVector3("direction1",this.direction1),e.setVector3("direction2",this.direction2)}buildUniformLayout(e){e.addUniform("direction1",3),e.addUniform("direction2",3)}getEffectDefines(){return""}getClassName(){return"MeshParticleEmitter"}serialize(){var e;const t={};return t.type=this.getClassName(),t.direction1=this.direction1.asArray(),t.direction2=this.direction2.asArray(),t.meshId=(e=this.mesh)===null||e===void 0?void 0:e.id,t.useMeshNormalsForDirection=this.useMeshNormalsForDirection,t}parse(e,t){g.FromArrayToRef(e.direction1,0,this.direction1),g.FromArrayToRef(e.direction2,0,this.direction2),e.meshId&&t&&(this.mesh=t.getLastMeshById(e.meshId)),this.useMeshNormalsForDirection=e.useMeshNormalsForDirection}}class Dr{constructor(e){this.animations=[],this.renderingGroupId=0,this.emitter=g.Zero(),this.emitRate=10,this.manualEmitCount=-1,this.updateSpeed=.01,this.targetStopDuration=0,this.disposeOnStop=!1,this.minEmitPower=1,this.maxEmitPower=1,this.minLifeTime=1,this.maxLifeTime=1,this.minSize=1,this.maxSize=1,this.minScaleX=1,this.maxScaleX=1,this.minScaleY=1,this.maxScaleY=1,this.minInitialRotation=0,this.maxInitialRotation=0,this.minAngularSpeed=0,this.maxAngularSpeed=0,this.layerMask=268435455,this.customShader=null,this.preventAutoStart=!1,this._wasDispatched=!1,this._rootUrl="",this.noiseStrength=new g(10,10,10),this.onAnimationEnd=null,this.blendMode=Dr.BLENDMODE_ONEONE,this.forceDepthWrite=!1,this.preWarmCycles=0,this.preWarmStepOffset=1,this.spriteCellChangeSpeed=1,this.startSpriteCellID=0,this.endSpriteCellID=0,this.spriteCellWidth=0,this.spriteCellHeight=0,this.spriteCellLoop=!0,this.spriteRandomStartCell=!1,this.translationPivot=new le(0,0),this.beginAnimationOnStart=!1,this.beginAnimationFrom=0,this.beginAnimationTo=60,this.beginAnimationLoop=!1,this.worldOffset=new g(0,0,0),this._useLogarithmicDepth=!1,this.gravity=g.Zero(),this._colorGradients=null,this._sizeGradients=null,this._lifeTimeGradients=null,this._angularSpeedGradients=null,this._velocityGradients=null,this._limitVelocityGradients=null,this._dragGradients=null,this._emitRateGradients=null,this._startSizeGradients=null,this._rampGradients=null,this._colorRemapGradients=null,this._alphaRemapGradients=null,this.startDelay=0,this.limitVelocityDamping=.4,this.color1=new J(1,1,1,1),this.color2=new J(1,1,1,1),this.colorDead=new J(0,0,0,1),this.textureMask=new J(1,1,1,1),this._isSubEmitter=!1,this._billboardMode=7,this._isBillboardBased=!0,this._imageProcessingConfigurationDefines=new Gx,this.id=e,this.name=e}get noiseTexture(){return this._noiseTexture}set noiseTexture(e){this._noiseTexture!==e&&(this._noiseTexture=e,this._reset())}get isAnimationSheetEnabled(){return this._isAnimationSheetEnabled}set isAnimationSheetEnabled(e){this._isAnimationSheetEnabled!=e&&(this._isAnimationSheetEnabled=e,this._reset())}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}getScene(){return this._scene}_hasTargetStopDurationDependantGradient(){return this._startSizeGradients&&this._startSizeGradients.length>0||this._emitRateGradients&&this._emitRateGradients.length>0||this._lifeTimeGradients&&this._lifeTimeGradients.length>0}getDragGradients(){return this._dragGradients}getLimitVelocityGradients(){return this._limitVelocityGradients}getColorGradients(){return this._colorGradients}getSizeGradients(){return this._sizeGradients}getColorRemapGradients(){return this._colorRemapGradients}getAlphaRemapGradients(){return this._alphaRemapGradients}getLifeTimeGradients(){return this._lifeTimeGradients}getAngularSpeedGradients(){return this._angularSpeedGradients}getVelocityGradients(){return this._velocityGradients}getStartSizeGradients(){return this._startSizeGradients}getEmitRateGradients(){return this._emitRateGradients}get direction1(){return this.particleEmitterType.direction1?this.particleEmitterType.direction1:g.Zero()}set direction1(e){this.particleEmitterType.direction1&&(this.particleEmitterType.direction1=e)}get direction2(){return this.particleEmitterType.direction2?this.particleEmitterType.direction2:g.Zero()}set direction2(e){this.particleEmitterType.direction2&&(this.particleEmitterType.direction2=e)}get minEmitBox(){return this.particleEmitterType.minEmitBox?this.particleEmitterType.minEmitBox:g.Zero()}set minEmitBox(e){this.particleEmitterType.minEmitBox&&(this.particleEmitterType.minEmitBox=e)}get maxEmitBox(){return this.particleEmitterType.maxEmitBox?this.particleEmitterType.maxEmitBox:g.Zero()}set maxEmitBox(e){this.particleEmitterType.maxEmitBox&&(this.particleEmitterType.maxEmitBox=e)}get billboardMode(){return this._billboardMode}set billboardMode(e){this._billboardMode!==e&&(this._billboardMode=e,this._reset())}get isBillboardBased(){return this._isBillboardBased}set isBillboardBased(e){this._isBillboardBased!==e&&(this._isBillboardBased=e,this._reset())}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(!e&&this._scene?this._imageProcessingConfiguration=this._scene.imageProcessingConfiguration:this._imageProcessingConfiguration=e)}_reset(){}_removeGradientAndTexture(e,t,i){if(!t)return this;let s=0;for(const r of t){if(r.gradient===e){t.splice(s,1);break}s++}return i&&i.dispose(),this}createPointEmitter(e,t){const i=new Ic;return i.direction1=e,i.direction2=t,this.particleEmitterType=i,i}createHemisphericEmitter(e=1,t=1){const i=new Rc(e,t);return this.particleEmitterType=i,i}createSphereEmitter(e=1,t=1){const i=new $l(e,t);return this.particleEmitterType=i,i}createDirectedSphereEmitter(e=1,t=new g(0,1,0),i=new g(0,1,0)){const s=new Pc(e,t,i);return this.particleEmitterType=s,s}createCylinderEmitter(e=1,t=1,i=1,s=0){const r=new Kl(e,t,i,s);return this.particleEmitterType=r,r}createDirectedCylinderEmitter(e=1,t=1,i=1,s=new g(0,1,0),r=new g(0,1,0)){const n=new Ac(e,t,i,s,r);return this.particleEmitterType=n,n}createConeEmitter(e=1,t=Math.PI/4){const i=new yc(e,t);return this.particleEmitterType=i,i}createBoxEmitter(e,t,i,s){const r=new Pa;return this.particleEmitterType=r,this.direction1=e,this.direction2=t,this.minEmitBox=i,this.maxEmitBox=s,r}}Dr.BLENDMODE_ONEONE=0;Dr.BLENDMODE_STANDARD=1;Dr.BLENDMODE_ADD=2;Dr.BLENDMODE_MULTIPLY=3;Dr.BLENDMODE_MULTIPLYADD=4;class B_ extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("rgba",I.Color4,!0),this.registerInput("rgb ",I.Color3,!0),this.registerOutput("rgb",I.Color3),this.registerOutput("r",I.Float),this.registerOutput("g",I.Float),this.registerOutput("b",I.Float),this.registerOutput("a",I.Float),this.inputsAreExclusive=!0}getClassName(){return"ColorSplitterBlock"}get rgba(){return this._inputs[0]}get rgbIn(){return this._inputs[1]}get rgbOut(){return this._outputs[0]}get r(){return this._outputs[1]}get g(){return this._outputs[2]}get b(){return this._outputs[3]}get a(){return this._outputs[4]}_inputRename(e){return e==="rgb "?"rgbIn":e}_outputRename(e){return e==="rgb"?"rgbOut":e}_buildBlock(e){super._buildBlock(e);const t=this.rgba.isConnected?this.rgba:this.rgbIn;if(!t.isConnected)return;const i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],o=this._outputs[4];return i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.rgb;\r
`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.r;\r
`),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${t.associatedVariableName}.g;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.b;\r
`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.a;\r
`),this}}he("BABYLON.ColorSplitterBlock",B_);class N1{constructor(e){this.name=ue.NAME_PROCEDURALTEXTURE,this.scene=e,this.scene.proceduralTextures=new Array}register(){this.scene._beforeClearStage.registerStep(ue.STEP_BEFORECLEAR_PROCEDURALTEXTURE,this,this._beforeClear)}rebuild(){}dispose(){}_beforeClear(){if(this.scene.proceduralTexturesEnabled){q.StartPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0);for(let e=0;e<this.scene.proceduralTextures.length;e++){const t=this.scene.proceduralTextures[e];t._shouldRender()&&t.render()}q.EndPerformanceCounter("Procedural textures",this.scene.proceduralTextures.length>0)}}}const F1="proceduralVertexShader",L1=`attribute vec2 position;
varying vec2 vPosition;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vPosition=position;
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[F1]=L1;class Qr extends H{constructor(e,t,i,s,r=null,n=!0,o=!1,l=0){super(null,s,!n),this.isEnabled=!0,this.autoClear=!0,this.onGeneratedObservable=new X,this.onBeforeGenerationObservable=new X,this.nodeMaterialSource=null,this._textures={},this._currentRefreshId=-1,this._frameId=-1,this._refreshRate=1,this._vertexBuffers={},this._uniforms=new Array,this._samplers=new Array,this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors4={},this._vectors2={},this._vectors3={},this._matrices={},this._fallbackTextureUsed=!1,this._cachedDefines=null,this._contentUpdateId=-1,this._rtWrapper=null,s=this.getScene()||ye.LastCreatedScene;let h=s._getComponent(ue.NAME_PROCEDURALTEXTURE);h||(h=new N1(s),s._addComponent(h)),s.proceduralTextures.push(this),this._fullEngine=s.getEngine(),this.name=e,this.isRenderTarget=!0,this._size=t,this._textureType=l,this._generateMipMaps=n,this._drawWrapper=new Vi(this._fullEngine),this.setFragment(i),this._fallbackTexture=r;const c=this._createRtWrapper(o,t,n,l);this._texture=c.texture;const u=[];u.push(1,1),u.push(-1,1),u.push(-1,-1),u.push(1,-1),this._vertexBuffers[y.PositionKind]=new y(this._fullEngine,u,y.PositionKind,!1,!1,2),this._createIndexBuffer()}_createRtWrapper(e,t,i,s){return e?(this._rtWrapper=this._fullEngine.createRenderTargetCubeTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this.setFloat("face",0)):this._rtWrapper=this._fullEngine.createRenderTargetTexture(t,{generateMipMaps:i,generateDepthBuffer:!1,generateStencilBuffer:!1,type:s}),this._rtWrapper}getEffect(){return this._drawWrapper.effect}_setEffect(e){this._drawWrapper.effect=e}getContent(){return this._contentData&&this._frameId===this._contentUpdateId?this._contentData:(this._contentData?this._contentData.then(e=>{this._contentData=this.readPixels(0,0,e),this._contentUpdateId=this._frameId}):(this._contentData=this.readPixels(0,0),this._contentUpdateId=this._frameId),this._contentData)}_createIndexBuffer(){const e=this._fullEngine,t=[];t.push(0),t.push(1),t.push(2),t.push(0),t.push(2),t.push(3),this._indexBuffer=e.createIndexBuffer(t)}_rebuild(){const e=this._vertexBuffers[y.PositionKind];e&&e._rebuild(),this._createIndexBuffer(),this.refreshRate===si.REFRESHRATE_RENDER_ONCE&&(this.refreshRate=si.REFRESHRATE_RENDER_ONCE)}reset(){var e;(e=this._drawWrapper.effect)===null||e===void 0||e.dispose()}_getDefines(){return""}isReady(){const e=this._fullEngine;let t;if(this.nodeMaterialSource)return this._drawWrapper.effect.isReady();if(!this._fragment)return!1;if(this._fallbackTextureUsed)return!0;if(!this._texture)return!1;const i=this._getDefines();return this._drawWrapper.effect&&i===this._cachedDefines&&this._drawWrapper.effect.isReady()?!0:(this._fragment.fragmentElement!==void 0?t={vertex:"procedural",fragmentElement:this._fragment.fragmentElement}:t={vertex:"procedural",fragment:this._fragment},this._cachedDefines!==i&&(this._cachedDefines=i,this._drawWrapper.effect=e.createEffect(t,[y.PositionKind],this._uniforms,this._samplers,i,void 0,void 0,()=>{var s;(s=this._rtWrapper)===null||s===void 0||s.dispose(),this._rtWrapper=this._texture=null,this._fallbackTexture&&(this._texture=this._fallbackTexture._texture,this._texture&&this._texture.incrementReferences()),this._fallbackTextureUsed=!0})),this._drawWrapper.effect.isReady())}resetRefreshCounter(){this._currentRefreshId=-1}setFragment(e){this._fragment=e}get refreshRate(){return this._refreshRate}set refreshRate(e){this._refreshRate=e,this.resetRefreshCounter()}_shouldRender(){return!this.isEnabled||!this.isReady()||!this._texture?(this._texture&&(this._texture.isReady=!1),!1):this._fallbackTextureUsed?!1:this._currentRefreshId===-1?(this._currentRefreshId=1,this._frameId++,!0):this.refreshRate===this._currentRefreshId?(this._currentRefreshId=1,this._frameId++,!0):(this._currentRefreshId++,!1)}getRenderSize(){return this._size}resize(e,t){if(this._fallbackTextureUsed||!this._rtWrapper||!this._texture)return;const i=this._texture.isCube;this._rtWrapper.dispose();const s=this._createRtWrapper(i,e,t,this._textureType);this._texture=s.texture,this._size=e,this._generateMipMaps=t}_checkUniform(e){this._uniforms.indexOf(e)===-1&&this._uniforms.push(e)}setTexture(e,t){return this._samplers.indexOf(e)===-1&&this._samplers.push(e),this._textures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}render(e){var t,i;const s=this.getScene();if(!s)return;const r=this._fullEngine;if(r.enableEffect(this._drawWrapper),this.onBeforeGenerationObservable.notifyObservers(this),r.setState(!1),!this.nodeMaterialSource){for(const o in this._textures)this._drawWrapper.effect.setTexture(o,this._textures[o]);for(const o in this._ints)this._drawWrapper.effect.setInt(o,this._ints[o]);for(const o in this._floats)this._drawWrapper.effect.setFloat(o,this._floats[o]);for(const o in this._floatsArrays)this._drawWrapper.effect.setArray(o,this._floatsArrays[o]);for(const o in this._colors3)this._drawWrapper.effect.setColor3(o,this._colors3[o]);for(const o in this._colors4){const l=this._colors4[o];this._drawWrapper.effect.setFloat4(o,l.r,l.g,l.b,l.a)}for(const o in this._vectors2)this._drawWrapper.effect.setVector2(o,this._vectors2[o]);for(const o in this._vectors3)this._drawWrapper.effect.setVector3(o,this._vectors3[o]);for(const o in this._matrices)this._drawWrapper.effect.setMatrix(o,this._matrices[o])}if(!this._texture||!this._rtWrapper)return;(t=r._debugPushGroup)===null||t===void 0||t.call(r,`procedural texture generation for ${this.name}`,1);const n=r.currentViewport;if(this.isCube)for(let o=0;o<6;o++)r.bindFramebuffer(this._rtWrapper,o,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this._drawWrapper.effect.setFloat("face",o),this.autoClear&&r.clear(s.clearColor,!0,!1,!1),r.drawElementsType(ne.TriangleFillMode,0,6);else r.bindFramebuffer(this._rtWrapper,0,void 0,void 0,!0),r.bindBuffers(this._vertexBuffers,this._indexBuffer,this._drawWrapper.effect),this.autoClear&&r.clear(s.clearColor,!0,!1,!1),r.drawElementsType(ne.TriangleFillMode,0,6);r.unBindFramebuffer(this._rtWrapper,this.isCube),n&&r.setViewport(n),this.isCube&&r.generateMipMapsForCubemap(this._texture),(i=r._debugPopGroup)===null||i===void 0||i.call(r,1),this.onGenerated&&this.onGenerated(),this.onGeneratedObservable.notifyObservers(this)}clone(){const e=this.getSize(),t=new Qr(this.name,e.width,this._fragment,this.getScene(),this._fallbackTexture,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t}dispose(){const e=this.getScene();if(!e)return;const t=e.proceduralTextures.indexOf(this);t>=0&&e.proceduralTextures.splice(t,1);const i=this._vertexBuffers[y.PositionKind];i&&(i.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&this._fullEngine._releaseBuffer(this._indexBuffer)&&(this._indexBuffer=null),this.onGeneratedObservable.clear(),this.onBeforeGenerationObservable.clear(),super.dispose()}}T([R()],Qr.prototype,"isEnabled",void 0);T([R()],Qr.prototype,"autoClear",void 0);T([R()],Qr.prototype,"_generateMipMaps",void 0);T([R()],Qr.prototype,"_size",void 0);T([R()],Qr.prototype,"refreshRate",null);he("BABYLON.ProceduralTexture",Qr);var xi;(function(a){a[a.Cos=0]="Cos",a[a.Sin=1]="Sin",a[a.Abs=2]="Abs",a[a.Exp=3]="Exp",a[a.Exp2=4]="Exp2",a[a.Round=5]="Round",a[a.Floor=6]="Floor",a[a.Ceiling=7]="Ceiling",a[a.Sqrt=8]="Sqrt",a[a.Log=9]="Log",a[a.Tan=10]="Tan",a[a.ArcTan=11]="ArcTan",a[a.ArcCos=12]="ArcCos",a[a.ArcSin=13]="ArcSin",a[a.Fract=14]="Fract",a[a.Sign=15]="Sign",a[a.Radians=16]="Radians",a[a.Degrees=17]="Degrees"})(xi||(xi={}));class U_ extends Ie{constructor(e){super(e,U.Neutral),this.operation=xi.Cos,this.registerInput("input",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"TrigonometryBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];let i="";switch(this.operation){case xi.Cos:{i="cos";break}case xi.Sin:{i="sin";break}case xi.Abs:{i="abs";break}case xi.Exp:{i="exp";break}case xi.Exp2:{i="exp2";break}case xi.Round:{i="round";break}case xi.Floor:{i="floor";break}case xi.Ceiling:{i="ceil";break}case xi.Sqrt:{i="sqrt";break}case xi.Log:{i="log";break}case xi.Tan:{i="tan";break}case xi.ArcTan:{i="atan";break}case xi.ArcCos:{i="acos";break}case xi.ArcSin:{i="asin";break}case xi.Fract:{i="fract";break}case xi.Sign:{i="sign";break}case xi.Radians:{i="radians";break}case xi.Degrees:{i="degrees";break}}return e.compilationString+=this._declareOutput(t,e)+` = ${i}(${this.input.associatedVariableName});\r
`,this}serialize(){const e=super.serialize();return e.operation=this.operation,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.operation=e.operation}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.operation = BABYLON.TrigonometryBlockOperations.${xi[this.operation]};\r
`}}he("BABYLON.TrigonometryBlock",U_);const Ru={effect:null,subMesh:null};class xh extends rr{constructor(){super(),this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.EXPOSURE=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.BUMPDIRECTUV=0,this.rebuild()}setValue(e,t,i=!1){this[e]===void 0&&this._keys.push(e),i&&this[e]!==t&&this.markAsUnprocessed(),this[e]=t}}class di extends zo{constructor(e,t,i={}){super(e,t||ye.LastCreatedScene),this._buildId=di._BuildIdGenerator++,this._buildWasSuccessful=!1,this._cachedWorldViewMatrix=new L,this._cachedWorldViewProjectionMatrix=new L,this._optimizers=new Array,this._animationFrame=-1,this.BJSNODEMATERIALEDITOR=this._getGlobalNodeMaterialEditor(),this.editorData=null,this.ignoreAlpha=!1,this.maxSimultaneousLights=4,this.onBuildObservable=new X,this._vertexOutputNodes=new Array,this._fragmentOutputNodes=new Array,this.attachedBlocks=new Array,this._mode=Ps.Material,this.forceAlphaBlending=!1,this._options={emitComments:!1,...i},this._attachImageProcessingConfiguration(null)}_getGlobalNodeMaterialEditor(){if(typeof NODEEDITOR<"u")return NODEEDITOR;if(typeof BABYLON<"u"&&typeof BABYLON.NodeEditor<"u")return BABYLON}get options(){return this._options}set options(e){this._options=e}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get mode(){return this._mode}set mode(e){this._mode=e}get buildId(){return this._buildId}set buildId(e){this._buildId=e}getClassName(){return"NodeMaterial"}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}getBlockByName(e){let t=null;for(const i of this.attachedBlocks)if(i.name===e)if(!t)t=i;else return q.Warn("More than one block was found with the name `"+e+"`"),t;return t}getBlockByPredicate(e){for(const t of this.attachedBlocks)if(e(t))return t;return null}getInputBlockByPredicate(e){for(const t of this.attachedBlocks)if(t.isInput&&e(t))return t;return null}getInputBlocks(){const e=[];for(const t of this.attachedBlocks)t.isInput&&e.push(t);return e}registerOptimizer(e){if(!(this._optimizers.indexOf(e)>-1))return this._optimizers.push(e),this}unregisterOptimizer(e){const t=this._optimizers.indexOf(e);if(t!==-1)return this._optimizers.splice(t,1),this}addOutputNode(e){if(e.target===null)throw"This node is not meant to be an output node. You may want to explicitly set its target value.";return(e.target&U.Vertex)!==0&&this._addVertexOutputNode(e),(e.target&U.Fragment)!==0&&this._addFragmentOutputNode(e),this}removeOutputNode(e){return e.target===null?this:((e.target&U.Vertex)!==0&&this._removeVertexOutputNode(e),(e.target&U.Fragment)!==0&&this._removeFragmentOutputNode(e),this)}_addVertexOutputNode(e){if(this._vertexOutputNodes.indexOf(e)===-1)return e.target=U.Vertex,this._vertexOutputNodes.push(e),this}_removeVertexOutputNode(e){const t=this._vertexOutputNodes.indexOf(e);if(t!==-1)return this._vertexOutputNodes.splice(t,1),this}_addFragmentOutputNode(e){if(this._fragmentOutputNodes.indexOf(e)===-1)return e.target=U.Fragment,this._fragmentOutputNodes.push(e),this}_removeFragmentOutputNode(e){const t=this._fragmentOutputNodes.indexOf(e);if(t!==-1)return this._fragmentOutputNodes.splice(t,1),this}needAlphaBlending(){return this.ignoreAlpha?!1:this.forceAlphaBlending||this.alpha<1||this._sharedData&&this._sharedData.hints.needAlphaBlending}needAlphaTesting(){return this._sharedData&&this._sharedData.hints.needAlphaTesting}_initializeBlock(e,t,i,s=!0){if(e.initialize(t),s&&e.autoConfigure(this),e._preparationId=this._buildId,this.attachedBlocks.indexOf(e)===-1){if(e.isUnique){const r=e.getClassName();for(const n of this.attachedBlocks)if(n.getClassName()===r)throw`Cannot have multiple blocks of type ${r} in the same NodeMaterial`}this.attachedBlocks.push(e)}for(const r of e.inputs){r.associatedVariableName="";const n=r.connectedPoint;if(n){const o=n.ownerBlock;o!==e&&((o.target===U.VertexAndFragment||t.target===U.Fragment&&o.target===U.Vertex&&o._preparationId!==this._buildId)&&i.push(o),this._initializeBlock(o,t,i,s))}}for(const r of e.outputs)r.associatedVariableName=""}_resetDualBlocks(e,t){e.target===U.VertexAndFragment&&(e.buildId=t);for(const i of e.inputs){const s=i.connectedPoint;if(s){const r=s.ownerBlock;r!==e&&this._resetDualBlocks(r,t)}}}removeBlock(e){const t=this.attachedBlocks.indexOf(e);t>-1&&this.attachedBlocks.splice(t,1),e.isFinalMerger&&this.removeOutputNode(e)}build(e=!1,t=!0,i=!0){this._buildWasSuccessful=!1;const s=this.getScene().getEngine(),r=this._mode===Ps.Particle;if(this._vertexOutputNodes.length===0&&!r)throw"You must define at least one vertexOutputNode";if(this._fragmentOutputNodes.length===0)throw"You must define at least one fragmentOutputNode";this._vertexCompilationState=new Cf,this._vertexCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._vertexCompilationState.target=U.Vertex,this._fragmentCompilationState=new Cf,this._fragmentCompilationState.supportUniformBuffers=s.supportsUniformBuffers,this._fragmentCompilationState.target=U.Fragment,this._sharedData=new O1,this._sharedData.fragmentOutputNodes=this._fragmentOutputNodes,this._vertexCompilationState.sharedData=this._sharedData,this._fragmentCompilationState.sharedData=this._sharedData,this._sharedData.buildId=this._buildId,this._sharedData.emitComments=this._options.emitComments,this._sharedData.verbose=e,this._sharedData.scene=this.getScene(),this._sharedData.allowEmptyVertexProgram=r;const n=[],o=[];for(const h of this._vertexOutputNodes)n.push(h),this._initializeBlock(h,this._vertexCompilationState,o,i);for(const h of this._fragmentOutputNodes)o.push(h),this._initializeBlock(h,this._fragmentCompilationState,n,i);this.optimize();for(const h of n)h.build(this._vertexCompilationState,n);this._fragmentCompilationState.uniforms=this._vertexCompilationState.uniforms.slice(0),this._fragmentCompilationState._uniformDeclaration=this._vertexCompilationState._uniformDeclaration,this._fragmentCompilationState._constantDeclaration=this._vertexCompilationState._constantDeclaration,this._fragmentCompilationState._vertexState=this._vertexCompilationState;for(const h of o)this._resetDualBlocks(h,this._buildId-1);for(const h of o)h.build(this._fragmentCompilationState,o);this._vertexCompilationState.finalize(this._vertexCompilationState),this._fragmentCompilationState.finalize(this._fragmentCompilationState),t&&(this._buildId=di._BuildIdGenerator++),this._sharedData.emitErrors(),e&&(console.log("Vertex shader:"),console.log(this._vertexCompilationState.compilationString),console.log("Fragment shader:"),console.log(this._fragmentCompilationState.compilationString)),this._buildWasSuccessful=!0,this.onBuildObservable.notifyObservers(this);const l=this.getScene().meshes;for(const h of l)if(!!h.subMeshes)for(const c of h.subMeshes){if(c.getMaterial()!==this||!c.materialDefines)continue;const u=c.materialDefines;u.markAllAsDirty(),u.reset()}}optimize(){for(const e of this._optimizers)e.optimize(this._vertexOutputNodes,this._fragmentOutputNodes)}_prepareDefinesForAttributes(e,t){const i=t.NORMAL,s=t.TANGENT;t.NORMAL=e.isVerticesDataPresent(y.NormalKind),t.TANGENT=e.isVerticesDataPresent(y.TangentKind);let r=!1;for(let n=1;n<=6;++n){const o=t["UV"+n];t["UV"+n]=e.isVerticesDataPresent(`uv${n===1?"":n}`),r=r||t["UV"+n]!==o}(i!==t.NORMAL||s!==t.TANGENT||r)&&t.markAsAttributesDirty()}createPostProcess(e,t=1,i=1,s,r,n=0,o=5){return this.mode!==Ps.PostProcess?(console.log("Incompatible material mode"),null):this._createEffectForPostProcess(null,e,t,i,s,r,n,o)}createEffectForPostProcess(e){this._createEffectForPostProcess(e)}_createEffectForPostProcess(e,t,i=1,s=1,r,n,o=0,l=5){let h=this.name+this._buildId;const c=new xh,u=new ct(h+"PostProcess",this.getScene());let d=this._buildId;return this._processDefines(u,c),Rt.RegisterShader(h,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),e?e.updateEffect(c.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,h,h):e=new Fe(this.name+"PostProcess",h,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,i,t,s,r,n,c.toString(),o,h,{maxSimultaneousLights:this.maxSimultaneousLights},!1,l),e.nodeMaterialSource=this,e.onApplyObservable.add(f=>{d!==this._buildId&&(delete Rt.ShadersStore[h+"VertexShader"],delete Rt.ShadersStore[h+"PixelShader"],h=this.name+this._buildId,c.markAllAsDirty(),d=this._buildId),this._processDefines(u,c)&&(Rt.RegisterShader(h,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),yo.SetImmediate(()=>e.updateEffect(c.toString(),this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,{maxSimultaneousLights:this.maxSimultaneousLights},void 0,void 0,h,h))),this._checkInternals(f)}),e}createProceduralTexture(e,t){if(this.mode!==Ps.ProceduralTexture)return console.log("Incompatible material mode"),null;let i=this.name+this._buildId;const s=new Qr(i,e,null,t),r=new ct(i+"Procedural",this.getScene());r.reservedDataStore={hidden:!0};const n=new xh,o=this._processDefines(r,n);Rt.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString);let l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[y.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),o==null?void 0:o.fallbacks,void 0);s.nodeMaterialSource=this,s._setEffect(l);let h=this._buildId;return s.onBeforeGenerationObservable.add(()=>{h!==this._buildId&&(delete Rt.ShadersStore[i+"VertexShader"],delete Rt.ShadersStore[i+"PixelShader"],i=this.name+this._buildId,n.markAllAsDirty(),h=this._buildId);const c=this._processDefines(r,n);c&&(Rt.RegisterShader(i,this._fragmentCompilationState._builtCompilationString,this._vertexCompilationState._builtCompilationString),yo.SetImmediate(()=>{l=this.getScene().getEngine().createEffect({vertexElement:i,fragmentElement:i},[y.PositionKind],this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString(),c==null?void 0:c.fallbacks,void 0),s._setEffect(l)})),this._checkInternals(l)}),s}_createEffectForParticles(e,t,i,s,r,n,o,l=""){let h=this.name+this._buildId+"_"+t;n||(n=new xh),o||(o=this.getScene().getMeshByName(this.name+"Particle"),o||(o=new ct(this.name+"Particle",this.getScene()),o.reservedDataStore={hidden:!0}));let c=this._buildId;const u=[];let d=l;if(!r){const f=this._processDefines(o,n);Rt.RegisterShader(h,this._fragmentCompilationState._builtCompilationString),e.fillDefines(u,t),d=u.join(`
`),r=this.getScene().getEngine().createEffectForParticles(h,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+d,f==null?void 0:f.fallbacks,i,s,e),e.setCustomEffect(r,t)}r.onBindObservable.add(f=>{c!==this._buildId&&(delete Rt.ShadersStore[h+"PixelShader"],h=this.name+this._buildId+"_"+t,n.markAllAsDirty(),c=this._buildId),u.length=0,e.fillDefines(u,t);const p=u.join(`
`);p!==d&&(n.markAllAsDirty(),d=p);const _=this._processDefines(o,n);if(_){Rt.RegisterShader(h,this._fragmentCompilationState._builtCompilationString),f=this.getScene().getEngine().createEffectForParticles(h,this._fragmentCompilationState.uniforms,this._fragmentCompilationState.samplers,n.toString()+`
`+d,_==null?void 0:_.fallbacks,i,s,e),e.setCustomEffect(f,t),this._createEffectForParticles(e,t,i,s,f,n,o,l);return}this._checkInternals(f)})}_checkInternals(e){if(this._sharedData.animatedInputs){const t=this.getScene(),i=t.getFrameId();if(this._animationFrame!==i){for(const s of this._sharedData.animatedInputs)s.animate(t);this._animationFrame=i}}for(const t of this._sharedData.bindableBlocks)t.bind(e,this);for(const t of this._sharedData.inputBlocks)t._transmit(e,this.getScene(),this)}createEffectForParticles(e,t,i){if(this.mode!==Ps.Particle){console.log("Incompatible material mode");return}this._createEffectForParticles(e,Dr.BLENDMODE_ONEONE,t,i),this._createEffectForParticles(e,Dr.BLENDMODE_MULTIPLY,t,i)}createAsShadowDepthWrapper(e){if(this.mode!==Ps.Material){console.log("Incompatible material mode");return}e.shadowDepthWrapper=new BABYLON.ShadowDepthWrapper(this,this.getScene())}_processDefines(e,t,i=!1,s){let r=null;if(this._sharedData.blocksWithDefines.forEach(n=>{n.initializeDefines(e,this,t,i)}),this._sharedData.blocksWithDefines.forEach(n=>{n.prepareDefines(e,this,t,i,s)}),t.isDirty){const n=t._areLightsDisposed;t.markAsProcessed(),this._vertexCompilationState.compilationString=this._vertexCompilationState._builtCompilationString,this._fragmentCompilationState.compilationString=this._fragmentCompilationState._builtCompilationString,this._sharedData.repeatableContentBlocks.forEach(u=>{u.replaceRepeatableContent(this._vertexCompilationState,this._fragmentCompilationState,e,t)});const o=[];this._sharedData.dynamicUniformBlocks.forEach(u=>{u.updateUniformsAndSamples(this._vertexCompilationState,this,t,o)});const l=this._vertexCompilationState.uniforms;this._fragmentCompilationState.uniforms.forEach(u=>{l.indexOf(u)===-1&&l.push(u)});const h=this._vertexCompilationState.samplers;this._fragmentCompilationState.samplers.forEach(u=>{h.indexOf(u)===-1&&h.push(u)});const c=new Wa;this._sharedData.blocksWithFallbacks.forEach(u=>{u.provideFallbacks(e,c)}),r={lightDisposed:n,uniformBuffers:o,mergedUniforms:l,mergedSamplers:h,fallbacks:c}}return r}isReadyForSubMesh(e,t,i=!1){if(!this._buildWasSuccessful)return!1;const s=this.getScene();if(this._sharedData.animatedInputs){const l=s.getFrameId();if(this._animationFrame!==l){for(const h of this._sharedData.animatedInputs)h.animate(s);this._animationFrame=l}}if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new xh);const r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(this._prepareDefinesForAttributes(e,r),this._sharedData.blockingBlocks.some(l=>!l.isReady(e,this,r,i)))return!1;const o=this._processDefines(e,r,i,t);if(o){const l=t.effect,h=r.toString();let c=n.createEffect({vertex:"nodeMaterial"+this._buildId,fragment:"nodeMaterial"+this._buildId,vertexSource:this._vertexCompilationState.compilationString,fragmentSource:this._fragmentCompilationState.compilationString},{attributes:this._vertexCompilationState.attributes,uniformsNames:o.mergedUniforms,uniformBuffersNames:o.uniformBuffers,samplers:o.mergedSamplers,defines:h,fallbacks:o.fallbacks,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this.maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS}},n);if(c)if(this._onEffectCreatedObservable&&(Ru.effect=c,Ru.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Ru)),this.allowShaderHotSwapping&&l&&!c.isReady()){if(c=l,r.markAsUnprocessed(),o.lightDisposed)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(c,r,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,s.performancePriority!==Qs.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}get compiledShaders(){return`// Vertex shader\r
${this._vertexCompilationState.compilationString}\r
\r
// Fragment shader\r
${this._fragmentCompilationState.compilationString}`}bindOnlyWorldMatrix(e){const t=this.getScene();if(!this._activeEffect)return;const i=this._sharedData.hints;i.needWorldViewMatrix&&e.multiplyToRef(t.getViewMatrix(),this._cachedWorldViewMatrix),i.needWorldViewProjectionMatrix&&e.multiplyToRef(t.getTransformMatrix(),this._cachedWorldViewProjectionMatrix);for(const s of this._sharedData.inputBlocks)s._transmitWorld(this._activeEffect,e,this._cachedWorldViewMatrix,this._cachedWorldViewProjectionMatrix)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.effect;if(!r)return;this._activeEffect=r,this.bindOnlyWorldMatrix(e);const n=this._mustRebind(s,r,t.visibility),o=this._sharedData;if(n){for(const l of o.bindableBlocks)l.bind(r,this,t,i);for(const l of o.forcedBindableBlocks)l.bind(r,this,t,i);for(const l of o.inputBlocks)l._transmit(r,s,this)}else if(!this.isFrozen)for(const l of o.forcedBindableBlocks)l.bind(r,this,t,i);this._afterBind(t,this._activeEffect)}getActiveTextures(){const e=super.getActiveTextures();return this._sharedData&&e.push(...this._sharedData.textureBlocks.filter(t=>t.texture).map(t=>t.texture)),e}getTextureBlocks(){return this._sharedData?this._sharedData.textureBlocks:[]}hasTexture(e){if(super.hasTexture(e))return!0;if(!this._sharedData)return!1;for(const t of this._sharedData.textureBlocks)if(t.texture===e)return!0;return!1}dispose(e,t,i){if(t)for(const s of this.getTextureBlocks().filter(r=>r.texture).map(r=>r.texture))s.dispose();for(const s of this.attachedBlocks)s.dispose();this.attachedBlocks.length=0,this._sharedData=null,this._vertexCompilationState=null,this._fragmentCompilationState=null,this.onBuildObservable.clear(),this._imageProcessingObserver&&(this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingObserver=null),super.dispose(e,t,i)}_createNodeEditor(){this.BJSNODEMATERIALEDITOR.NodeEditor.Show({nodeMaterial:this})}edit(e){return new Promise(t=>{if(this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),typeof this.BJSNODEMATERIALEDITOR>"u"){const i=e&&e.editorURL?e.editorURL:di.EditorURL;q.LoadScript(i,()=>{this.BJSNODEMATERIALEDITOR=this.BJSNODEMATERIALEDITOR||this._getGlobalNodeMaterialEditor(),this._createNodeEditor(),t()})}else this._createNodeEditor(),t()})}clear(){this._vertexOutputNodes.length=0,this._fragmentOutputNodes.length=0,this.attachedBlocks.length=0}setToDefault(){this.clear(),this.editorData=null;const e=new Ye("Position");e.setAsAttribute("position");const t=new Ye("World");t.setAsSystemValue(Ke.World);const i=new id("WorldPos");e.connectTo(i),t.connectTo(i);const s=new Ye("ViewProjection");s.setAsSystemValue(Ke.ViewProjection);const r=new id("WorldPos * ViewProjectionTransform");i.connectTo(r),s.connectTo(r);const n=new Mh("VertexOutput");r.connectTo(n);const o=new Ye("color");o.value=new J(.8,.8,.8,1);const l=new kn("FragmentOutput");o.connectTo(l),this.addOutputNode(n),this.addOutputNode(l),this._mode=Ps.Material}setToDefaultPostProcess(){this.clear(),this.editorData=null;const e=new Ye("Position");e.setAsAttribute("position2d");const t=new Ye("Constant1");t.isConstant=!0,t.value=1;const i=new Dh("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Mh("VertexOutput");i.connectTo(s);const r=new Ye("Scale");r.visibleInInspector=!0,r.value=new le(1,1);const n=new Cc("uv0");e.connectTo(n);const o=new sd("UV scale");n.connectTo(o),r.connectTo(o);const l=new w_("CurrentScreen");o.connectTo(l),l.texture=new H("https://assets.babylonjs.com/nme/currentScreenPostProcess.png",this.getScene());const h=new kn("FragmentOutput");l.connectTo(h,{output:"rgba"}),this.addOutputNode(s),this.addOutputNode(h),this._mode=Ps.PostProcess}setToDefaultProceduralTexture(){this.clear(),this.editorData=null;const e=new Ye("Position");e.setAsAttribute("position2d");const t=new Ye("Constant1");t.isConstant=!0,t.value=1;const i=new Dh("Position3D");e.connectTo(i),t.connectTo(i,{input:"w"});const s=new Mh("VertexOutput");i.connectTo(s);const r=new Ye("Time");r.value=0,r.min=0,r.max=0,r.isBoolean=!1,r.matrixMode=0,r.animationType=Ca.Time,r.isConstant=!1;const n=new Ye("Color3");n.value=new re(1,1,1),n.isConstant=!1;const o=new kn("FragmentOutput"),l=new Dh("VectorMerger");l.visibleInInspector=!1;const h=new U_("Cos");h.operation=xi.Cos,e.connectTo(l),r.output.connectTo(h.input),h.output.connectTo(l.z),l.xyzOut.connectTo(o.rgb),this.addOutputNode(s),this.addOutputNode(o),this._mode=Ps.ProceduralTexture}setToDefaultParticle(){this.clear(),this.editorData=null;const e=new Ye("uv");e.setAsAttribute("particle_uv");const t=new N_("ParticleTexture");e.connectTo(t);const i=new Ye("Color");i.setAsAttribute("particle_color");const s=new sd("Texture * Color");t.connectTo(s),i.connectTo(s);const r=new F_("ParticleRampGradient");s.connectTo(r);const n=new B_("ColorSplitter");i.connectTo(n);const o=new L_("ParticleBlendMultiply");r.connectTo(o),t.connectTo(o,{output:"a"}),n.connectTo(o,{output:"a"});const l=new kn("FragmentOutput");o.connectTo(l),this.addOutputNode(l),this._mode=Ps.Particle}async loadAsync(e,t=""){return di.ParseFromFileAsync("",e,this.getScene(),t,!0,this)}_gatherBlocks(e,t){if(t.indexOf(e)===-1){t.push(e);for(const i of e.inputs){const s=i.connectedPoint;if(s){const r=s.ownerBlock;r!==e&&this._gatherBlocks(r,t)}}}}generateCode(){let e=[];const t=[],i=["const","var","let"];for(const n of this._vertexOutputNodes)this._gatherBlocks(n,t);const s=[];for(const n of this._fragmentOutputNodes)this._gatherBlocks(n,s);let r=`var nodeMaterial = new BABYLON.NodeMaterial("${this.name||"node material"}");\r
`;for(const n of t)n.isInput&&e.indexOf(n)===-1&&(r+=n._dumpCode(i,e));for(const n of s)n.isInput&&e.indexOf(n)===-1&&(r+=n._dumpCode(i,e));e=[],r+=`\r
// Connections\r
`;for(const n of this._vertexOutputNodes)r+=n._dumpCodeForOutputConnections(e);for(const n of this._fragmentOutputNodes)r+=n._dumpCodeForOutputConnections(e);r+=`\r
// Output nodes\r
`;for(const n of this._vertexOutputNodes)r+=`nodeMaterial.addOutputNode(${n._codeVariableName});\r
`;for(const n of this._fragmentOutputNodes)r+=`nodeMaterial.addOutputNode(${n._codeVariableName});\r
`;return r+=`nodeMaterial.build();\r
`,r}serialize(e){const t=e?{}:xe.Serialize(this);t.editorData=JSON.parse(JSON.stringify(this.editorData));let i=[];if(e)i=e;else{t.customType="BABYLON.NodeMaterial",t.outputNodes=[];for(const s of this._vertexOutputNodes)this._gatherBlocks(s,i),t.outputNodes.push(s.uniqueId);for(const s of this._fragmentOutputNodes)this._gatherBlocks(s,i),t.outputNodes.indexOf(s.uniqueId)===-1&&t.outputNodes.push(s.uniqueId)}t.blocks=[];for(const s of i)t.blocks.push(s.serialize());if(!e)for(const s of this.attachedBlocks)i.indexOf(s)===-1&&t.blocks.push(s.serialize());return t}_restoreConnections(e,t,i){for(const s of e.outputs)for(const r of t.blocks){const n=i[r.id];if(!!n){for(const o of r.inputs)if(i[o.targetBlockId]===e&&o.targetConnectionName===s.name){const l=n.getInputByName(o.inputName);if(!l||l.isConnected)continue;s.connectTo(l,!0),this._restoreConnections(n,t,i);continue}}}}parseSerializedObject(e,t="",i=!1){var s;i||this.clear();const r={};for(const n of e.blocks){const o=Si(n.customType);if(o){const l=new o;l._deserialize(n,this.getScene(),t),r[n.id]=l,this.attachedBlocks.push(l)}}for(let n=0;n<e.blocks.length;n++){const o=e.blocks[n],l=r[o.id];!l||l.inputs.length&&!i||this._restoreConnections(l,e,r)}if(e.outputNodes)for(const n of e.outputNodes)this.addOutputNode(r[n]);if(e.locations||e.editorData&&e.editorData.locations){const n=e.locations||e.editorData.locations;for(const l of n)r[l.blockId]&&(l.blockId=r[l.blockId].uniqueId);i&&this.editorData&&this.editorData.locations&&n.concat(this.editorData.locations),e.locations?this.editorData={locations:n}:(this.editorData=e.editorData,this.editorData.locations=n);const o=[];for(const l in r)o[l]=r[l].uniqueId;this.editorData.map=o}this.comment=e.comment,e.forceAlphaBlending!==void 0&&(this.forceAlphaBlending=e.forceAlphaBlending),i||(this._mode=(s=e.mode)!==null&&s!==void 0?s:Ps.Material)}loadFromSerialization(e,t="",i=!1){this.parseSerializedObject(e,t,i)}clone(e,t=!1){const i=this.serialize(),s=xe.Clone(()=>new di(e,this.getScene(),this.options),this);return s.id=e,s.name=e,s.parseSerializedObject(i),s._buildId=this._buildId,s.build(!1,!t),s}static Parse(e,t,i=""){const s=xe.Parse(()=>new di(e.name,t),e,t,i);return s.parseSerializedObject(e,i),s.build(),s}static async ParseFromFileAsync(e,t,i,s="",r=!1,n){const o=n!=null?n:new di(e,i),l=await i._loadFileAsync(t),h=JSON.parse(l);return o.parseSerializedObject(h,s),r||o.build(),o}static ParseFromSnippetAsync(e,t=ye.LastCreatedScene,i="",s,r=!1){return e==="_BLANK"?Promise.resolve(di.CreateDefault("blank",t)):new Promise((n,o)=>{const l=new Ui;l.addEventListener("readystatechange",()=>{if(l.readyState==4)if(l.status==200){const h=JSON.parse(JSON.parse(l.responseText).jsonPayload),c=JSON.parse(h.nodeMaterial);s||(s=xe.Parse(()=>new di(e,t),c,t,i),s.uniqueId=t.getUniqueId()),s.parseSerializedObject(c),s.snippetId=e;try{r||s.build(),n(s)}catch(u){o(u)}}else o("Unable to load the snippet "+e)}),l.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),l.send()})}static CreateDefault(e,t){const i=new di(e,t);return i.setToDefault(),i.build(),i}}di._BuildIdGenerator=0;di.EditorURL=`https://unpkg.com/babylonjs-node-editor@${k.Version}/babylon.nodeEditor.js`;di.SnippetUrl="https://snippet.babylonjs.com";di.IgnoreTexturesAtLoadTime=!1;T([R()],di.prototype,"ignoreAlpha",void 0);T([R()],di.prototype,"maxSimultaneousLights",void 0);T([R("mode")],di.prototype,"_mode",void 0);T([R("comment")],di.prototype,"comment",void 0);T([R()],di.prototype,"forceAlphaBlending",void 0);he("BABYLON.NodeMaterial",di);function V_(a){const e=a.sideOrientation||de.DEFAULTSIDE,t=a.radius||1,i=a.flat===void 0?!0:a.flat,s=a.subdivisions||4,r=a.radiusX||t,n=a.radiusY||t,o=a.radiusZ||t,l=(1+Math.sqrt(5))/2,h=[-1,l,-0,1,l,0,-1,-l,0,1,-l,0,0,-1,-l,0,1,-l,0,-1,l,0,1,l,l,0,1,l,0,-1,-l,0,1,-l,0,-1],c=[0,11,5,0,5,1,0,1,7,0,7,10,12,22,23,1,5,20,5,11,4,23,22,13,22,18,6,7,1,8,14,21,4,14,4,2,16,13,6,15,6,19,3,8,9,4,21,5,13,17,23,6,13,22,19,6,18,9,8,1],u=[0,1,2,3,4,5,6,7,8,9,10,11,0,2,3,3,3,4,7,8,9,9,10,11],d=[5,1,3,1,6,4,0,0,5,3,4,2,2,2,4,0,2,0,1,1,6,0,6,2,0,4,3,3,4,4,3,1,4,2,4,4,0,2,1,1,2,2,3,3,1,3,2,4],f=138/1024,p=239/1024,_=60/1024,m=26/1024,v=-40/1024,x=20/1024,b=[0,0,0,0,1,0,0,1,1,0,0,0,1,1,0,0,1,1,1,0],S=new Array,C=new Array,E=new Array,A=new Array;let M=0;const D=new Array(3),P=new Array(3);let O;for(O=0;O<3;O++)D[O]=g.Zero(),P[O]=le.Zero();for(let $=0;$<20;$++){for(O=0;O<3;O++){const K=c[3*$+O];D[O].copyFromFloats(h[3*u[K]],h[3*u[K]+1],h[3*u[K]+2]),D[O].normalize(),P[O].copyFromFloats(d[2*K]*f+_+b[$]*v,d[2*K+1]*p+m+b[$]*x)}const W=(K,te,ve,_e)=>{const j=g.Lerp(D[0],D[2],te/s),ee=g.Lerp(D[1],D[2],te/s),F=s===te?D[2]:g.Lerp(j,ee,K/(s-te));F.normalize();let z;if(i){const ut=g.Lerp(D[0],D[2],_e/s),me=g.Lerp(D[1],D[2],_e/s);z=g.Lerp(ut,me,ve/(s-_e))}else z=new g(F.x,F.y,F.z);z.x/=r,z.y/=n,z.z/=o,z.normalize();const Z=le.Lerp(P[0],P[2],te/s),Ee=le.Lerp(P[1],P[2],te/s),He=s===te?P[2]:le.Lerp(Z,Ee,K/(s-te));C.push(F.x*r,F.y*n,F.z*o),E.push(z.x,z.y,z.z),A.push(He.x,nt.UseOpenGLOrientationForUV?1-He.y:He.y),S.push(M),M++};for(let K=0;K<s;K++)for(let te=0;te+K<s;te++)W(te,K,te+1/3,K+1/3),W(te+1,K,te+1/3,K+1/3),W(te,K+1,te+1/3,K+1/3),te+K+1<s&&(W(te+1,K,te+2/3,K+2/3),W(te+1,K+1,te+2/3,K+2/3),W(te,K+1,te+2/3,K+2/3))}de._ComputeSides(e,C,S,E,A,a.frontUVs,a.backUVs);const N=new de;return N.indices=S,N.positions=C,N.normals=E,N.uvs=A,N}function Hd(a,e={},t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,V_(e).applyToMesh(i,e.updatable),i}de.CreateIcoSphere=V_;V.CreateIcoSphere=(a,e,t)=>Hd(a,e,t);var Fn;(function(a){a.WRIST="wrist",a.THUMB="thumb",a.INDEX="index",a.MIDDLE="middle",a.RING="ring",a.LITTLE="little"})(Fn||(Fn={}));var Ne;(function(a){a.WRIST="wrist",a.THUMB_METACARPAL="thumb-metacarpal",a.THUMB_PHALANX_PROXIMAL="thumb-phalanx-proximal",a.THUMB_PHALANX_DISTAL="thumb-phalanx-distal",a.THUMB_TIP="thumb-tip",a.INDEX_FINGER_METACARPAL="index-finger-metacarpal",a.INDEX_FINGER_PHALANX_PROXIMAL="index-finger-phalanx-proximal",a.INDEX_FINGER_PHALANX_INTERMEDIATE="index-finger-phalanx-intermediate",a.INDEX_FINGER_PHALANX_DISTAL="index-finger-phalanx-distal",a.INDEX_FINGER_TIP="index-finger-tip",a.MIDDLE_FINGER_METACARPAL="middle-finger-metacarpal",a.MIDDLE_FINGER_PHALANX_PROXIMAL="middle-finger-phalanx-proximal",a.MIDDLE_FINGER_PHALANX_INTERMEDIATE="middle-finger-phalanx-intermediate",a.MIDDLE_FINGER_PHALANX_DISTAL="middle-finger-phalanx-distal",a.MIDDLE_FINGER_TIP="middle-finger-tip",a.RING_FINGER_METACARPAL="ring-finger-metacarpal",a.RING_FINGER_PHALANX_PROXIMAL="ring-finger-phalanx-proximal",a.RING_FINGER_PHALANX_INTERMEDIATE="ring-finger-phalanx-intermediate",a.RING_FINGER_PHALANX_DISTAL="ring-finger-phalanx-distal",a.RING_FINGER_TIP="ring-finger-tip",a.PINKY_FINGER_METACARPAL="pinky-finger-metacarpal",a.PINKY_FINGER_PHALANX_PROXIMAL="pinky-finger-phalanx-proximal",a.PINKY_FINGER_PHALANX_INTERMEDIATE="pinky-finger-phalanx-intermediate",a.PINKY_FINGER_PHALANX_DISTAL="pinky-finger-phalanx-distal",a.PINKY_FINGER_TIP="pinky-finger-tip"})(Ne||(Ne={}));const Cr=[Ne.WRIST,Ne.THUMB_METACARPAL,Ne.THUMB_PHALANX_PROXIMAL,Ne.THUMB_PHALANX_DISTAL,Ne.THUMB_TIP,Ne.INDEX_FINGER_METACARPAL,Ne.INDEX_FINGER_PHALANX_PROXIMAL,Ne.INDEX_FINGER_PHALANX_INTERMEDIATE,Ne.INDEX_FINGER_PHALANX_DISTAL,Ne.INDEX_FINGER_TIP,Ne.MIDDLE_FINGER_METACARPAL,Ne.MIDDLE_FINGER_PHALANX_PROXIMAL,Ne.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Ne.MIDDLE_FINGER_PHALANX_DISTAL,Ne.MIDDLE_FINGER_TIP,Ne.RING_FINGER_METACARPAL,Ne.RING_FINGER_PHALANX_PROXIMAL,Ne.RING_FINGER_PHALANX_INTERMEDIATE,Ne.RING_FINGER_PHALANX_DISTAL,Ne.RING_FINGER_TIP,Ne.PINKY_FINGER_METACARPAL,Ne.PINKY_FINGER_PHALANX_PROXIMAL,Ne.PINKY_FINGER_PHALANX_INTERMEDIATE,Ne.PINKY_FINGER_PHALANX_DISTAL,Ne.PINKY_FINGER_TIP],B1={[Fn.WRIST]:[Ne.WRIST],[Fn.THUMB]:[Ne.THUMB_METACARPAL,Ne.THUMB_PHALANX_PROXIMAL,Ne.THUMB_PHALANX_DISTAL,Ne.THUMB_TIP],[Fn.INDEX]:[Ne.INDEX_FINGER_METACARPAL,Ne.INDEX_FINGER_PHALANX_PROXIMAL,Ne.INDEX_FINGER_PHALANX_INTERMEDIATE,Ne.INDEX_FINGER_PHALANX_DISTAL,Ne.INDEX_FINGER_TIP],[Fn.MIDDLE]:[Ne.MIDDLE_FINGER_METACARPAL,Ne.MIDDLE_FINGER_PHALANX_PROXIMAL,Ne.MIDDLE_FINGER_PHALANX_INTERMEDIATE,Ne.MIDDLE_FINGER_PHALANX_DISTAL,Ne.MIDDLE_FINGER_TIP],[Fn.RING]:[Ne.RING_FINGER_METACARPAL,Ne.RING_FINGER_PHALANX_PROXIMAL,Ne.RING_FINGER_PHALANX_INTERMEDIATE,Ne.RING_FINGER_PHALANX_DISTAL,Ne.RING_FINGER_TIP],[Fn.LITTLE]:[Ne.PINKY_FINGER_METACARPAL,Ne.PINKY_FINGER_PHALANX_PROXIMAL,Ne.PINKY_FINGER_PHALANX_INTERMEDIATE,Ne.PINKY_FINGER_PHALANX_DISTAL,Ne.PINKY_FINGER_TIP]};class U1{constructor(e,t,i,s,r=!1,n=!1,o=1){this.xrController=e,this._jointMeshes=t,this._handMesh=i,this.rigMapping=s,this._leftHandedMeshes=r,this._jointsInvisible=n,this._jointScaleFactor=o,this._jointTransforms=new Array(Cr.length),this._jointTransformMatrices=new Float32Array(Cr.length*16),this._tempJointMatrix=new L,this._jointRadii=new Float32Array(Cr.length),this._scene=t[0].getScene();for(let l=0;l<this._jointTransforms.length;l++){const h=this._jointTransforms[l]=new ke(Cr[l],this._scene);h.rotationQuaternion=new Q,t[l].rotationQuaternion=new Q}i&&this.setHandMesh(i,s),this.xrController.motionController&&(this.xrController.motionController.rootMesh?this.xrController.motionController.rootMesh.setEnabled(!1):this.xrController.motionController.onModelLoadedObservable.add(l=>{l.rootMesh&&l.rootMesh.setEnabled(!1)})),this.xrController.onMotionControllerInitObservable.add(l=>{l.onModelLoadedObservable.add(h=>{h.rootMesh&&h.rootMesh.setEnabled(!1)}),l.rootMesh&&l.rootMesh.setEnabled(!1)})}get handMesh(){return this._handMesh}getHandPartMeshes(e){return B1[e].map(t=>this._jointMeshes[Cr.indexOf(t)])}getJointMesh(e){return this._jointMeshes[Cr.indexOf(e)]}setHandMesh(e,t){if(this._handMesh=e,e.alwaysSelectAsActiveMesh=!0,e.getChildMeshes().forEach(i=>i.alwaysSelectAsActiveMesh=!0),this._handMesh.skeleton){const i=this._handMesh.skeleton;Cr.forEach((s,r)=>{const n=i.getBoneIndexByName(t?t[s]:s);n!==-1&&i.bones[n].linkTransformNode(this._jointTransforms[r])})}}updateFromXRFrame(e,t){const i=this.xrController.inputSource.hand;if(!i)return;const s=i,r=Cr.map(o=>s[o]||i.get(o));let n=!1;if(e.fillPoses&&e.fillJointRadii)n=e.fillPoses(r,t,this._jointTransformMatrices)&&e.fillJointRadii(r,this._jointRadii);else if(e.getJointPose){n=!0;for(let o=0;o<r.length;o++){const l=e.getJointPose(r[o],t);if(l)this._jointTransformMatrices.set(l.transform.matrix,o*16),this._jointRadii[o]=l.radius||.008;else{n=!1;break}}}!n||(Cr.forEach((o,l)=>{const h=this._jointTransforms[l];L.FromArrayToRef(this._jointTransformMatrices,l*16,this._tempJointMatrix),this._tempJointMatrix.decompose(void 0,h.rotationQuaternion,h.position);const c=this._jointRadii[l]*this._jointScaleFactor,u=this._jointMeshes[l];u.isVisible=!this._handMesh&&!this._jointsInvisible,u.position.copyFrom(h.position),u.rotationQuaternion.copyFrom(h.rotationQuaternion),u.scaling.setAll(c),this._scene.useRightHandedSystem||(u.position.z*=-1,u.rotationQuaternion.z*=-1,u.rotationQuaternion.w*=-1,this._leftHandedMeshes&&this._handMesh&&(h.position.z*=-1,h.rotationQuaternion.z*=-1,h.rotationQuaternion.w*=-1))}),this._handMesh&&(this._handMesh.isVisible=!0))}dispose(){this._handMesh&&(this._handMesh.isVisible=!1)}}class Et extends Ji{constructor(e,t){super(e),this.options=t,this._attachedHands={},this._trackingHands={left:null,right:null},this._handResources={jointMeshes:null,handMeshes:null,rigMappings:null},this.onHandAddedObservable=new X,this.onHandRemovedObservable=new X,this._attachHand=r=>{var n,o,l;if(!r.inputSource.hand||r.inputSource.handedness=="none"||!this._handResources.jointMeshes)return;const h=r.inputSource.handedness,c=new U1(r,this._handResources.jointMeshes[h],this._handResources.handMeshes&&this._handResources.handMeshes[h],this._handResources.rigMappings&&this._handResources.rigMappings[h],(n=this.options.handMeshes)===null||n===void 0?void 0:n.meshesUseLeftHandedCoordinates,(o=this.options.jointMeshes)===null||o===void 0?void 0:o.invisible,(l=this.options.jointMeshes)===null||l===void 0?void 0:l.scaleFactor);this._attachedHands[r.uniqueId]=c,this._trackingHands[h]=c,this.onHandAddedObservable.notifyObservers(c)},this._detachHand=r=>{this._detachHandById(r.uniqueId)},this.xrNativeFeatureName="hand-tracking";const s=t.jointMeshes;if(s&&(typeof s.disableDefaultHandMesh<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.disableDefaultMeshes=s.disableDefaultHandMesh),typeof s.handMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.customMeshes=s.handMeshes),typeof s.leftHandedSystemMeshes<"u"&&(t.handMeshes=t.handMeshes||{},t.handMeshes.meshesUseLeftHandedCoordinates=s.leftHandedSystemMeshes),typeof s.rigMapping<"u")){t.handMeshes=t.handMeshes||{};const r={},n={};[[s.rigMapping.left,r],[s.rigMapping.right,n]].forEach(o=>{const l=o[0],h=o[1];l.forEach((c,u)=>{h[Cr[u]]=c})}),t.handMeshes.customRigMappings={left:r,right:n}}}static _GenerateTrackedJointMeshes(e){const t={};return["left","right"].map(i=>{var s,r,n,o,l;const h=[],c=((s=e.jointMeshes)===null||s===void 0?void 0:s.sourceMesh)||Hd("jointParent",Et._ICOSPHERE_PARAMS);c.isVisible=!!(!((r=e.jointMeshes)===null||r===void 0)&&r.keepOriginalVisible);for(let u=0;u<Cr.length;++u){let d=c.createInstance(`${i}-handJoint-${u}`);if(!((n=e.jointMeshes)===null||n===void 0)&&n.onHandJointMeshGenerated){const f=e.jointMeshes.onHandJointMeshGenerated(d,u,i);f&&f!==d&&(d.dispose(),d=f)}if(d.isPickable=!1,!((o=e.jointMeshes)===null||o===void 0)&&o.enablePhysics){const f=((l=e.jointMeshes)===null||l===void 0?void 0:l.physicsProps)||{};d.scaling.setAll(.02);const p=f.impostorType!==void 0?f.impostorType:Oe.SphereImpostor;d.physicsImpostor=new Oe(d,p,{mass:0,...f})}d.rotationQuaternion=new Q,d.isVisible=!1,h.push(d)}t[i]=h}),{left:t.left,right:t.right}}static _GenerateDefaultHandMeshesAsync(e,t){return new Promise(async i=>{var s,r,n,o,l;const h={};!((r=(s=Et._RightHandGLB)===null||s===void 0?void 0:s.meshes[1])===null||r===void 0)&&r.isDisposed()&&(Et._RightHandGLB=null),!((o=(n=Et._LeftHandGLB)===null||n===void 0?void 0:n.meshes[1])===null||o===void 0)&&o.isDisposed()&&(Et._LeftHandGLB=null);const c=!!(Et._RightHandGLB&&Et._LeftHandGLB),u=await Promise.all([Et._RightHandGLB||Be.ImportMeshAsync("",Et.DEFAULT_HAND_MODEL_BASE_URL,Et.DEFAULT_HAND_MODEL_RIGHT_FILENAME,e),Et._LeftHandGLB||Be.ImportMeshAsync("",Et.DEFAULT_HAND_MODEL_BASE_URL,Et.DEFAULT_HAND_MODEL_LEFT_FILENAME,e)]);Et._RightHandGLB=u[0],Et._LeftHandGLB=u[1];const d=new di("handShader",e,{emitComments:!1});await d.loadAsync(Et.DEFAULT_HAND_MODEL_SHADER_URL),d.needDepthPrePass=!0,d.transparencyMode=ne.MATERIAL_ALPHABLEND,d.alphaMode=2,d.build(!1);const f={base:re.FromInts(116,63,203),fresnel:re.FromInts(149,102,229),fingerColor:re.FromInts(177,130,255),tipFresnel:re.FromInts(220,200,255),...(l=t==null?void 0:t.handMeshes)===null||l===void 0?void 0:l.customColors},p={base:d.getBlockByName("baseColor"),fresnel:d.getBlockByName("fresnelColor"),fingerColor:d.getBlockByName("fingerColor"),tipFresnel:d.getBlockByName("tipFresnelColor")};p.base.value=f.base,p.fresnel.value=f.fresnel,p.fingerColor.value=f.fingerColor,p.tipFresnel.value=f.tipFresnel,["left","right"].forEach(_=>{const m=_=="left"?Et._LeftHandGLB:Et._RightHandGLB;if(!m)throw new Error("Could not load hand model");const v=m.meshes[1];v._internalAbstractMeshDataInfo._computeBonesUsingShaders=!0,v.material=d.clone(`${_}HandShaderClone`,!0),v.isVisible=!1,h[_]=v,!c&&!e.useRightHandedSystem&&m.meshes[1].rotate(ti.Y,Math.PI)}),d.dispose(),i({left:h.left,right:h.right})})}static _GenerateDefaultHandMeshRigMapping(e){const t=e=="right"?"R":"L";return{[Ne.WRIST]:`wrist_${t}`,[Ne.THUMB_METACARPAL]:`thumb_metacarpal_${t}`,[Ne.THUMB_PHALANX_PROXIMAL]:`thumb_proxPhalanx_${t}`,[Ne.THUMB_PHALANX_DISTAL]:`thumb_distPhalanx_${t}`,[Ne.THUMB_TIP]:`thumb_tip_${t}`,[Ne.INDEX_FINGER_METACARPAL]:`index_metacarpal_${t}`,[Ne.INDEX_FINGER_PHALANX_PROXIMAL]:`index_proxPhalanx_${t}`,[Ne.INDEX_FINGER_PHALANX_INTERMEDIATE]:`index_intPhalanx_${t}`,[Ne.INDEX_FINGER_PHALANX_DISTAL]:`index_distPhalanx_${t}`,[Ne.INDEX_FINGER_TIP]:`index_tip_${t}`,[Ne.MIDDLE_FINGER_METACARPAL]:`middle_metacarpal_${t}`,[Ne.MIDDLE_FINGER_PHALANX_PROXIMAL]:`middle_proxPhalanx_${t}`,[Ne.MIDDLE_FINGER_PHALANX_INTERMEDIATE]:`middle_intPhalanx_${t}`,[Ne.MIDDLE_FINGER_PHALANX_DISTAL]:`middle_distPhalanx_${t}`,[Ne.MIDDLE_FINGER_TIP]:`middle_tip_${t}`,[Ne.RING_FINGER_METACARPAL]:`ring_metacarpal_${t}`,[Ne.RING_FINGER_PHALANX_PROXIMAL]:`ring_proxPhalanx_${t}`,[Ne.RING_FINGER_PHALANX_INTERMEDIATE]:`ring_intPhalanx_${t}`,[Ne.RING_FINGER_PHALANX_DISTAL]:`ring_distPhalanx_${t}`,[Ne.RING_FINGER_TIP]:`ring_tip_${t}`,[Ne.PINKY_FINGER_METACARPAL]:`little_metacarpal_${t}`,[Ne.PINKY_FINGER_PHALANX_PROXIMAL]:`little_proxPhalanx_${t}`,[Ne.PINKY_FINGER_PHALANX_INTERMEDIATE]:`little_intPhalanx_${t}`,[Ne.PINKY_FINGER_PHALANX_DISTAL]:`little_distPhalanx_${t}`,[Ne.PINKY_FINGER_TIP]:`little_tip_${t}`}}isCompatible(){return typeof XRHand<"u"}getHandByControllerId(e){return this._attachedHands[e]}getHandByHandedness(e){return e=="none"?null:this._trackingHands[e]}attach(){var e,t,i,s;return super.attach()?(this._handResources={jointMeshes:Et._GenerateTrackedJointMeshes(this.options),handMeshes:((e=this.options.handMeshes)===null||e===void 0?void 0:e.customMeshes)||null,rigMappings:((t=this.options.handMeshes)===null||t===void 0?void 0:t.customRigMappings)||null},!(!((i=this.options.handMeshes)===null||i===void 0)&&i.customMeshes)&&!(!((s=this.options.handMeshes)===null||s===void 0)&&s.disableDefaultMeshes)&&Et._GenerateDefaultHandMeshesAsync(ye.LastCreatedScene,this.options).then(r=>{var n,o;this._handResources.handMeshes=r,this._handResources.rigMappings={left:Et._GenerateDefaultHandMeshRigMapping("left"),right:Et._GenerateDefaultHandMeshRigMapping("right")},(n=this._trackingHands.left)===null||n===void 0||n.setHandMesh(this._handResources.handMeshes.left,this._handResources.rigMappings.left),(o=this._trackingHands.right)===null||o===void 0||o.setHandMesh(this._handResources.handMeshes.right,this._handResources.rigMappings.right)}),this.options.xrInput.controllers.forEach(this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerAddedObservable,this._attachHand),this._addNewAttachObserver(this.options.xrInput.onControllerRemovedObservable,this._detachHand),!0):!1}_onXRFrame(e){var t,i;(t=this._trackingHands.left)===null||t===void 0||t.updateFromXRFrame(e,this._xrSessionManager.referenceSpace),(i=this._trackingHands.right)===null||i===void 0||i.updateFromXRFrame(e,this._xrSessionManager.referenceSpace)}_detachHandById(e){var t;const i=this.getHandByControllerId(e);if(i){const s=i.xrController.inputSource.handedness=="left"?"left":"right";((t=this._trackingHands[s])===null||t===void 0?void 0:t.xrController.uniqueId)===e&&(this._trackingHands[s]=null),this.onHandRemovedObservable.notifyObservers(i),i.dispose(),delete this._attachedHands[e]}}detach(){return super.detach()?(Object.keys(this._attachedHands).forEach(e=>this._detachHandById(e)),!0):!1}dispose(){var e;super.dispose(),this.onHandAddedObservable.clear(),this.onHandRemovedObservable.clear(),this._handResources.handMeshes&&!(!((e=this.options.handMeshes)===null||e===void 0)&&e.customMeshes)&&(this._handResources.handMeshes.left.dispose(),this._handResources.handMeshes.right.dispose(),Et._RightHandGLB=null,Et._LeftHandGLB=null),this._handResources.jointMeshes&&(this._handResources.jointMeshes.left.forEach(t=>t.dispose()),this._handResources.jointMeshes.right.forEach(t=>t.dispose()))}}Et.Name=pt.HAND_TRACKING;Et.Version=1;Et.DEFAULT_HAND_MODEL_BASE_URL="https://assets.babylonjs.com/meshes/HandMeshes/";Et.DEFAULT_HAND_MODEL_RIGHT_FILENAME="r_hand_rhs.glb";Et.DEFAULT_HAND_MODEL_LEFT_FILENAME="l_hand_rhs.glb";Et.DEFAULT_HAND_MODEL_SHADER_URL="https://assets.babylonjs.com/meshes/HandMeshes/handsShader.json";Et._ICOSPHERE_PARAMS={radius:.5,flat:!1,subdivisions:2};Et._RightHandGLB=null;Et._LeftHandGLB=null;ii.AddWebXRFeature(Et.Name,(a,e)=>()=>new Et(a,e),Et.Version,!1);var Af;(function(a){a[a.ABOVE_FINGER_TIPS=0]="ABOVE_FINGER_TIPS",a[a.RADIAL_SIDE=1]="RADIAL_SIDE",a[a.ULNAR_SIDE=2]="ULNAR_SIDE",a[a.BELOW_WRIST=3]="BELOW_WRIST"})(Af||(Af={}));var Rf;(function(a){a[a.LOOK_AT_CAMERA=0]="LOOK_AT_CAMERA",a[a.HAND_ROTATION=1]="HAND_ROTATION"})(Rf||(Rf={}));var If;(function(a){a[a.ALWAYS_VISIBLE=0]="ALWAYS_VISIBLE",a[a.PALM_UP=1]="PALM_UP",a[a.GAZE_FOCUS=2]="GAZE_FOCUS",a[a.PALM_AND_GAZE=3]="PALM_AND_GAZE"})(If||(If={}));g.Zero(),g.Zero(),g.Zero(),g.Zero(),g.Zero(),g.Zero();Q.Identity();L.Identity(),L.Identity();gi.BuildArray(10,g.Zero);Q.Identity();gi.BuildArray(5,L.Identity);class Pl{constructor(e,t,i){this.name=e,this.id=t,this.bones=new Array,this.needInitialSkinMatrix=!1,this._isDirty=!0,this._meshesWithPoseMatrix=new Array,this._identity=L.Identity(),this._ranges={},this._absoluteTransformIsDirty=!0,this._canUseTextureForBones=!1,this._uniqueId=0,this._numBonesWithLinkedTransformNode=0,this._hasWaitingData=null,this._parentContainer=null,this.doNotSerialize=!1,this._useTextureToStoreBoneMatrices=!0,this._animationPropertiesOverride=null,this.onBeforeComputeObservable=new X,this.bones=[],this._scene=i||ye.LastCreatedScene,this._uniqueId=this._scene.getUniqueId(),this._scene.addSkeleton(this),this._isDirty=!0;const s=this._scene.getEngine().getCaps();this._canUseTextureForBones=s.textureFloat&&s.maxVertexTextureImageUnits>0}get useTextureToStoreBoneMatrices(){return this._useTextureToStoreBoneMatrices}set useTextureToStoreBoneMatrices(e){this._useTextureToStoreBoneMatrices=e,this._markAsDirty()}get animationPropertiesOverride(){return this._animationPropertiesOverride?this._animationPropertiesOverride:this._scene.animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get isUsingTextureForMatrices(){return this.useTextureToStoreBoneMatrices&&this._canUseTextureForBones}get uniqueId(){return this._uniqueId}getClassName(){return"Skeleton"}getChildren(){return this.bones.filter(e=>!e.getParent())}getTransformMatrices(e){return this.needInitialSkinMatrix?(e._bonesTransformMatrices||this.prepare(),e._bonesTransformMatrices):(this._transformMatrices||this.prepare(),this._transformMatrices)}getTransformMatrixTexture(e){return this.needInitialSkinMatrix&&e._transformMatrixTexture?e._transformMatrixTexture:this._transformMatrixTexture}getScene(){return this._scene}toString(e){let t=`Name: ${this.name}, nBones: ${this.bones.length}`;if(t+=`, nAnimationRanges: ${this._ranges?Object.keys(this._ranges).length:"none"}`,e){t+=", Ranges: {";let i=!0;for(const s in this._ranges)i&&(t+=", ",i=!1),t+=s;t+="}"}return t}getBoneIndexByName(e){for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].name===e)return t;return-1}createAnimationRange(e,t,i){if(!this._ranges[e]){this._ranges[e]=new Ao(e,t,i);for(let s=0,r=this.bones.length;s<r;s++)this.bones[s].animations[0]&&this.bones[s].animations[0].createRange(e,t,i)}}deleteAnimationRange(e,t=!0){for(let i=0,s=this.bones.length;i<s;i++)this.bones[i].animations[0]&&this.bones[i].animations[0].deleteRange(e,t);this._ranges[e]=null}getAnimationRange(e){return this._ranges[e]||null}getAnimationRanges(){const e=[];let t;for(t in this._ranges)e.push(this._ranges[t]);return e}copyAnimationRange(e,t,i=!1){if(this._ranges[t]||!e.getAnimationRange(t))return!1;let s=!0;const r=this._getHighestAnimationFrame()+1,n={},o=e.bones;let l,h;for(h=0,l=o.length;h<l;h++)n[o[h].name]=o[h];this.bones.length!==o.length&&(B.Warn(`copyAnimationRange: this rig has ${this.bones.length} bones, while source as ${o.length}`),s=!1);const c=i&&this.dimensionsAtRest&&e.dimensionsAtRest?this.dimensionsAtRest.divide(e.dimensionsAtRest):null;for(h=0,l=this.bones.length;h<l;h++){const d=this.bones[h].name,f=n[d];f?s=s&&this.bones[h].copyAnimationRange(f,t,r,i,c):(B.Warn("copyAnimationRange: not same rig, missing source bone "+d),s=!1)}const u=e.getAnimationRange(t);return u&&(this._ranges[t]=new Ao(t,u.from+r,u.to+r)),s}returnToRest(){for(const e of this.bones)e._index!==-1&&e.returnToRest()}_getHighestAnimationFrame(){let e=0;for(let t=0,i=this.bones.length;t<i;t++)if(this.bones[t].animations[0]){const s=this.bones[t].animations[0].getHighestFrame();e<s&&(e=s)}return e}beginAnimation(e,t,i,s){const r=this.getAnimationRange(e);return r?this._scene.beginAnimation(this,r.from,r.to,t,i,s):null}static MakeAnimationAdditive(e,t=0,i){const s=e.getAnimationRange(i);if(!s)return null;const r=e._scene.getAllAnimatablesByTarget(e);let n=null;for(let l=0;l<r.length;l++){const h=r[l];if(h.fromFrame===(s==null?void 0:s.from)&&h.toFrame===(s==null?void 0:s.to)){n=h;break}}const o=e.getAnimatables();for(let l=0;l<o.length;l++){const c=o[l].animations;if(!!c)for(let u=0;u<c.length;u++)ae.MakeAnimationAdditive(c[u],t,i)}return n&&(n.isAdditive=!0),e}_markAsDirty(){this._isDirty=!0,this._absoluteTransformIsDirty=!0}_registerMeshWithPoseMatrix(e){this._meshesWithPoseMatrix.push(e)}_unregisterMeshWithPoseMatrix(e){const t=this._meshesWithPoseMatrix.indexOf(e);t>-1&&this._meshesWithPoseMatrix.splice(t,1)}_computeTransformMatrices(e,t){this.onBeforeComputeObservable.notifyObservers(this);for(let i=0;i<this.bones.length;i++){const s=this.bones[i];s._childUpdateId++;const r=s.getParent();if(r?s.getLocalMatrix().multiplyToRef(r.getWorldMatrix(),s.getWorldMatrix()):t?s.getLocalMatrix().multiplyToRef(t,s.getWorldMatrix()):s.getWorldMatrix().copyFrom(s.getLocalMatrix()),s._index!==-1){const n=s._index===null?i:s._index;s.getInvertedAbsoluteTransform().multiplyToArray(s.getWorldMatrix(),e,n*16)}}this._identity.copyToArray(e,this.bones.length*16)}prepare(){if(this._numBonesWithLinkedTransformNode>0){for(const e of this.bones)if(e._linkedTransformNode){const t=e._linkedTransformNode;e.position=t.position,t.rotationQuaternion?e.rotationQuaternion=t.rotationQuaternion:e.rotation=t.rotation,e.scaling=t.scaling}}if(this.needInitialSkinMatrix)for(const e of this._meshesWithPoseMatrix){const t=e.getPoseMatrix();let i=this._isDirty;if((!e._bonesTransformMatrices||e._bonesTransformMatrices.length!==16*(this.bones.length+1))&&(e._bonesTransformMatrices=new Float32Array(16*(this.bones.length+1)),i=!0),!!i){if(this._synchronizedWithMesh!==e){this._synchronizedWithMesh=e;for(const s of this.bones)s.getParent()||(s.getBaseMatrix().multiplyToRef(t,G.Matrix[1]),s._updateDifferenceMatrix(G.Matrix[1]));if(this.isUsingTextureForMatrices){const s=(this.bones.length+1)*4;(!e._transformMatrixTexture||e._transformMatrixTexture.getSize().width!==s)&&(e._transformMatrixTexture&&e._transformMatrixTexture.dispose(),e._transformMatrixTexture=Ts.CreateRGBATexture(e._bonesTransformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))}}this._computeTransformMatrices(e._bonesTransformMatrices,t),this.isUsingTextureForMatrices&&e._transformMatrixTexture&&e._transformMatrixTexture.update(e._bonesTransformMatrices)}}else{if(!this._isDirty)return;(!this._transformMatrices||this._transformMatrices.length!==16*(this.bones.length+1))&&(this._transformMatrices=new Float32Array(16*(this.bones.length+1)),this.isUsingTextureForMatrices&&(this._transformMatrixTexture&&this._transformMatrixTexture.dispose(),this._transformMatrixTexture=Ts.CreateRGBATexture(this._transformMatrices,(this.bones.length+1)*4,1,this._scene,!1,!1,1,1))),this._computeTransformMatrices(this._transformMatrices,null),this.isUsingTextureForMatrices&&this._transformMatrixTexture&&this._transformMatrixTexture.update(this._transformMatrices)}this._isDirty=!1}getAnimatables(){if(!this._animatables||this._animatables.length!==this.bones.length){this._animatables=[];for(let e=0;e<this.bones.length;e++)this._animatables.push(this.bones[e])}return this._animatables}clone(e,t){const i=new Pl(e,t||e,this._scene);i.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let s=0;s<this.bones.length;s++){const r=this.bones[s];let n=null;const o=r.getParent();if(o){const h=this.bones.indexOf(o);n=i.bones[h]}const l=new Pt(r.name,i,n,r.getBaseMatrix().clone(),r.getRestPose().clone());l._index=r._index,r._linkedTransformNode&&l.linkTransformNode(r._linkedTransformNode),ys.DeepCopy(r.animations,l.animations)}if(this._ranges){i._ranges={};for(const s in this._ranges){const r=this._ranges[s];r&&(i._ranges[s]=r.clone())}}return this._isDirty=!0,i}enableBlending(e=.01){this.bones.forEach(t=>{t.animations.forEach(i=>{i.enableBlending=!0,i.blendingSpeed=e})})}dispose(){if(this._meshesWithPoseMatrix.length=0,this.getScene().stopAnimation(this),this.getScene().removeSkeleton(this),this._parentContainer){const e=this._parentContainer.skeletons.indexOf(this);e>-1&&this._parentContainer.skeletons.splice(e,1),this._parentContainer=null}this._transformMatrixTexture&&(this._transformMatrixTexture.dispose(),this._transformMatrixTexture=null)}serialize(){var e;const t={};t.name=this.name,t.id=this.id,this.dimensionsAtRest&&(t.dimensionsAtRest=this.dimensionsAtRest.asArray()),t.bones=[],t.needInitialSkinMatrix=this.needInitialSkinMatrix;for(let i=0;i<this.bones.length;i++){const s=this.bones[i],r=s.getParent(),n={parentBoneIndex:r?this.bones.indexOf(r):-1,index:s.getIndex(),name:s.name,id:s.id,matrix:s.getBaseMatrix().toArray(),rest:s.getRestPose().toArray(),linkedTransformNodeId:(e=s.getTransformNode())===null||e===void 0?void 0:e.id};t.bones.push(n),s.length&&(n.length=s.length),s.metadata&&(n.metadata=s.metadata),s.animations&&s.animations.length>0&&(n.animation=s.animations[0].serialize()),t.ranges=[];for(const o in this._ranges){const l=this._ranges[o];if(!l)continue;const h={};h.name=o,h.from=l.from,h.to=l.to,t.ranges.push(h)}}return t}static Parse(e,t){const i=new Pl(e.name,e.id,t);e.dimensionsAtRest&&(i.dimensionsAtRest=g.FromArray(e.dimensionsAtRest)),i.needInitialSkinMatrix=e.needInitialSkinMatrix;let s;for(s=0;s<e.bones.length;s++){const r=e.bones[s],n=e.bones[s].index;let o=null;r.parentBoneIndex>-1&&(o=i.bones[r.parentBoneIndex]);const l=r.rest?L.FromArray(r.rest):null,h=new Pt(r.name,i,o,L.FromArray(r.matrix),l,null,n);r.id!==void 0&&r.id!==null&&(h.id=r.id),r.length&&(h.length=r.length),r.metadata&&(h.metadata=r.metadata),r.animation&&h.animations.push(ae.Parse(r.animation)),r.linkedTransformNodeId!==void 0&&r.linkedTransformNodeId!==null&&(i._hasWaitingData=!0,h._waitingTransformNodeId=r.linkedTransformNodeId)}if(e.ranges)for(s=0;s<e.ranges.length;s++){const r=e.ranges[s];i.createAnimationRange(r.name,r.from,r.to)}return i}computeAbsoluteTransforms(e=!1){(this._absoluteTransformIsDirty||e)&&(this.bones[0].computeAbsoluteTransforms(),this._absoluteTransformIsDirty=!1)}getPoseMatrix(){let e=null;return this._meshesWithPoseMatrix.length>0&&(e=this._meshesWithPoseMatrix[0].getPoseMatrix()),e}sortBones(){const e=new Array,t=new Array(this.bones.length);for(let i=0;i<this.bones.length;i++)this._sortBones(i,e,t);this.bones=e}_sortBones(e,t,i){if(i[e])return;i[e]=!0;const s=this.bones[e];if(!s)return;s._index===void 0&&(s._index=e);const r=s.getParent();r&&this._sortBones(this.bones.indexOf(r),t,i),t.push(s)}setCurrentPoseAsRest(){this.bones.forEach(e=>{e.setCurrentPoseAsRest()})}}class V1{constructor(e,t,i=3){this._engine=e,this._engine._storageBuffers.push(this),this._create(t,i)}_create(e,t){this._bufferSize=e,this._creationFlags=t,this._buffer=this._engine.createStorageBuffer(e,t)}_rebuild(){this._create(this._bufferSize,this._creationFlags)}getBuffer(){return this._buffer}update(e,t,i){!this._buffer||this._engine.updateStorageBuffer(this._buffer,e,t,i)}read(e,t,i){return this._engine.readFromStorageBuffer(this._buffer,e,t,i)}dispose(){const e=this._engine._storageBuffers,t=e.indexOf(this);t!==-1&&(e[t]=e[e.length-1],e.pop()),this._engine._releaseBuffer(this._buffer),this._buffer=null}}class Mc{constructor(){this.wheelPrecisionX=3,this.wheelPrecisionY=3,this.wheelPrecisionZ=3,this.onChangedObservable=new X,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._ffMultiplier=12,this._normalize=120}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ce.POINTERWHEEL)return;const i=t.event,s=i.deltaMode===ko.DOM_DELTA_LINE?this._ffMultiplier:1;this._wheelDeltaX+=this.wheelPrecisionX*s*i.deltaX/this._normalize,this._wheelDeltaY-=this.wheelPrecisionY*s*i.deltaY/this._normalize,this._wheelDeltaZ+=this.wheelPrecisionZ*s*i.deltaZ/this._normalize,i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,Ce.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null),this.onChangedObservable&&this.onChangedObservable.clear()}checkInputs(){this.onChangedObservable.notifyObservers({wheelDeltaX:this._wheelDeltaX,wheelDeltaY:this._wheelDeltaY,wheelDeltaZ:this._wheelDeltaZ}),this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0}getClassName(){return"BaseCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}T([R()],Mc.prototype,"wheelPrecisionX",void 0);T([R()],Mc.prototype,"wheelPrecisionY",void 0);T([R()],Mc.prototype,"wheelPrecisionZ",void 0);class oi{constructor(e,t,i,s=0,r=1,n=2,o=3){this.id=e,this.index=t,this.browserGamepad=i,this._leftStick={x:0,y:0},this._rightStick={x:0,y:0},this._isConnected=!0,this._invertLeftStickY=!1,this.type=oi.GAMEPAD,this._leftStickAxisX=s,this._leftStickAxisY=r,this._rightStickAxisX=n,this._rightStickAxisY=o,this.browserGamepad.axes.length>=2&&(this._leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]}),this.browserGamepad.axes.length>=4&&(this._rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}get isConnected(){return this._isConnected}onleftstickchanged(e){this._onleftstickchanged=e}onrightstickchanged(e){this._onrightstickchanged=e}get leftStick(){return this._leftStick}set leftStick(e){this._onleftstickchanged&&(this._leftStick.x!==e.x||this._leftStick.y!==e.y)&&this._onleftstickchanged(e),this._leftStick=e}get rightStick(){return this._rightStick}set rightStick(e){this._onrightstickchanged&&(this._rightStick.x!==e.x||this._rightStick.y!==e.y)&&this._onrightstickchanged(e),this._rightStick=e}update(){this._leftStick&&(this.leftStick={x:this.browserGamepad.axes[this._leftStickAxisX],y:this.browserGamepad.axes[this._leftStickAxisY]},this._invertLeftStickY&&(this.leftStick.y*=-1)),this._rightStick&&(this.rightStick={x:this.browserGamepad.axes[this._rightStickAxisX],y:this.browserGamepad.axes[this._rightStickAxisY]})}dispose(){}}oi.GAMEPAD=0;oi.GENERIC=1;oi.XBOX=2;oi.POSE_ENABLED=3;oi.DUALSHOCK=4;class k1 extends oi{constructor(e,t,i){super(e,t,i),this.onButtonDownObservable=new X,this.onButtonUpObservable=new X,this.type=oi.GENERIC,this._buttons=new Array(i.buttons.length)}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._buttons[e]=this._setButtonValue(this.browserGamepad.buttons[e].value,this._buttons[e],e)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear()}}class Dc{constructor(){this.gamepadRotationSensibility=80,this.gamepadMoveSensibility=40,this._yAxisScale=1}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==oi.POSE_ENABLED&&(!this.gamepad||t.type===oi.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(oi.XBOX)}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad){const e=this.camera,t=this.gamepad.rightStick;if(t){if(t.x!=0){const s=t.x/this.gamepadRotationSensibility;s!=0&&Math.abs(s)>.005&&(e.inertialAlphaOffset+=s)}if(t.y!=0){const s=t.y/this.gamepadRotationSensibility*this._yAxisScale;s!=0&&Math.abs(s)>.005&&(e.inertialBetaOffset+=s)}}const i=this.gamepad.leftStick;if(i&&i.y!=0){const s=i.y/this.gamepadMoveSensibility;s!=0&&Math.abs(s)>.005&&(this.camera.inertialRadiusOffset-=s)}}}getClassName(){return"ArcRotateCameraGamepadInput"}getSimpleName(){return"gamepad"}}T([R()],Dc.prototype,"gamepadRotationSensibility",void 0);T([R()],Dc.prototype,"gamepadMoveSensibility",void 0);Qi.ArcRotateCameraGamepadInput=Dc;zd.prototype.addVRDeviceOrientation=function(){return this.add(new k_),this};class k_{constructor(){this.alphaCorrection=1,this.gammaCorrection=1,this._alpha=0,this._gamma=0,this._dirty=!1,this._deviceOrientationHandler=this._onOrientationEvent.bind(this)}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this.camera.attachControl(e);const t=this.camera.getScene().getEngine().getHostWindow();t&&(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t.addEventListener("deviceorientation",this._deviceOrientationHandler):q.Warn("Permission not granted.")}).catch(i=>{q.Error(i)}):t.addEventListener("deviceorientation",this._deviceOrientationHandler))}_onOrientationEvent(e){e.alpha!==null&&(this._alpha=(+e.alpha|0)*this.alphaCorrection),e.gamma!==null&&(this._gamma=(+e.gamma|0)*this.gammaCorrection),this._dirty=!0}checkInputs(){this._dirty&&(this._dirty=!1,this._gamma<0&&(this._gamma=180+this._gamma),this.camera.alpha=-this._alpha/180*Math.PI%Math.PI*2,this.camera.beta=this._gamma/180*Math.PI)}detachControl(){window.removeEventListener("deviceorientation",this._deviceOrientationHandler)}getClassName(){return"ArcRotateCameraVRDeviceOrientationInput"}getSimpleName(){return"VRDeviceOrientation"}}Qi.ArcRotateCameraVRDeviceOrientationInput=k_;class ha{constructor(){this.keysForward=[87],this.keysBackward=[83],this.keysUp=[69],this.keysDown=[81],this.keysRight=[68],this.keysLeft=[65],this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(t.type===Zn.KEYDOWN)(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysForward.indexOf(i.keyCode)!==-1||this.keysBackward.indexOf(i.keyCode)!==-1||this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),e||i.preventDefault()}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}getClassName(){return"FlyCameraKeyboardInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();this.keysForward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,s):this.keysBackward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-s):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,s,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-s,0):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(s,0,0):this.keysLeft.indexOf(i)!==-1&&e._localDirection.copyFromFloats(-s,0,0),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),g.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}}T([R()],ha.prototype,"keysForward",void 0);T([R()],ha.prototype,"keysBackward",void 0);T([R()],ha.prototype,"keysUp",void 0);T([R()],ha.prototype,"keysDown",void 0);T([R()],ha.prototype,"keysRight",void 0);T([R()],ha.prototype,"keysLeft",void 0);Qi.FlyCameraKeyboardInput=ha;class Oc{constructor(){this.buttons=[0,1,2],this.buttonsYaw=[-1,0,1],this.buttonsPitch=[-1,0,1],this.buttonsRoll=[2],this.activeButton=-1,this.angularSensibility=1e3,this._previousPosition=null}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._noPreventDefault=e,this._observer=this.camera.getScene().onPointerObservable.add(t=>{this._pointerInput(t)},Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE),this._rollObserver=this.camera.getScene().onBeforeRenderObservable.add(()=>{this.camera.rollCorrect&&this.camera.restoreRoll(this.camera.rollCorrect)})}detachControl(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this.camera.getScene().onBeforeRenderObservable.remove(this._rollObserver),this._observer=null,this._rollObserver=null,this._previousPosition=null,this._noPreventDefault=void 0)}getClassName(){return"FlyCameraMouseInput"}getSimpleName(){return"mouse"}_pointerInput(e){const t=e.event,s=this.camera.getEngine();if(s.isInVRExclusivePointerMode||!this.touchEnabled&&t.pointerType==="touch"||e.type!==Ce.POINTERMOVE&&this.buttons.indexOf(t.button)===-1)return;const r=t.target;if(e.type===Ce.POINTERDOWN){try{r==null||r.setPointerCapture(t.pointerId)}catch{}this._previousPosition={x:t.clientX,y:t.clientY},this.activeButton=t.button,this._noPreventDefault||(t.preventDefault(),this._element.focus()),s.isPointerLock&&this._onMouseMove(e.event)}else if(e.type===Ce.POINTERUP){try{r==null||r.releasePointerCapture(t.pointerId)}catch{}this.activeButton=-1,this._previousPosition=null,this._noPreventDefault||t.preventDefault()}else if(e.type===Ce.POINTERMOVE){if(!this._previousPosition){s.isPointerLock&&this._onMouseMove(e.event);return}const n=t.clientX-this._previousPosition.x,o=t.clientY-this._previousPosition.y;this._rotateCamera(n,o),this._previousPosition={x:t.clientX,y:t.clientY},this._noPreventDefault||t.preventDefault()}}_onMouseMove(e){const i=this.camera.getEngine();if(!i.isPointerLock||i.isInVRExclusivePointerMode)return;const s=e.movementX,r=e.movementY;this._rotateCamera(s,r),this._previousPosition=null,this._noPreventDefault||e.preventDefault()}_rotateCamera(e,t){const i=this.camera;this.camera.getScene().useRightHandedSystem&&(e*=-1),i.parent&&i.parent._getWorldMatrixDeterminant()<0&&(e*=-1);const r=e/this.angularSensibility,n=t/this.angularSensibility,o=Q.RotationYawPitchRoll(i.rotation.y,i.rotation.x,i.rotation.z);let l;if(this.buttonsPitch.some(h=>h===this.activeButton)&&(l=Q.RotationAxis(ti.X,n),o.multiplyInPlace(l)),this.buttonsYaw.some(h=>h===this.activeButton)){l=Q.RotationAxis(ti.Y,r),o.multiplyInPlace(l);const h=i.bankedTurnLimit+i._trackRoll;if(i.bankedTurn&&-h<i.rotation.z&&i.rotation.z<h){const c=i.bankedTurnMultiplier*-r;l=Q.RotationAxis(ti.Z,c),o.multiplyInPlace(l)}}this.buttonsRoll.some(h=>h===this.activeButton)&&(l=Q.RotationAxis(ti.Z,-r),i._trackRoll-=r,o.multiplyInPlace(l)),o.toEulerAnglesToRef(i.rotation)}}T([R()],Oc.prototype,"buttons",void 0);T([R()],Oc.prototype,"angularSensibility",void 0);Qi.FlyCameraMouseInput=Oc;class Yi{constructor(){this.keysHeightOffsetIncr=[38],this.keysHeightOffsetDecr=[40],this.keysHeightOffsetModifierAlt=!1,this.keysHeightOffsetModifierCtrl=!1,this.keysHeightOffsetModifierShift=!1,this.keysRotationOffsetIncr=[37],this.keysRotationOffsetDecr=[39],this.keysRotationOffsetModifierAlt=!1,this.keysRotationOffsetModifierCtrl=!1,this.keysRotationOffsetModifierShift=!1,this.keysRadiusIncr=[40],this.keysRadiusDecr=[38],this.keysRadiusModifierAlt=!0,this.keysRadiusModifierCtrl=!1,this.keysRadiusModifierShift=!1,this.heightSensibility=1,this.rotationSensibility=1,this.radiusSensibility=1,this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Zn.KEYDOWN)this._ctrlPressed=i.ctrlKey,this._altPressed=i.altKey,this._shiftPressed=i.shiftKey,(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),i.preventDefault&&(e||i.preventDefault()));else if(this.keysHeightOffsetIncr.indexOf(i.keyCode)!==-1||this.keysHeightOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetIncr.indexOf(i.keyCode)!==-1||this.keysRotationOffsetDecr.indexOf(i.keyCode)!==-1||this.keysRadiusIncr.indexOf(i.keyCode)!==-1||this.keysRadiusDecr.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),i.preventDefault&&(e||i.preventDefault())}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){this._onKeyboardObserver&&this._keys.forEach(e=>{this.keysHeightOffsetIncr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset+=this.heightSensibility:this.keysHeightOffsetDecr.indexOf(e)!==-1&&this._modifierHeightOffset()?this.camera.heightOffset-=this.heightSensibility:this.keysRotationOffsetIncr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset+=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRotationOffsetDecr.indexOf(e)!==-1&&this._modifierRotationOffset()?(this.camera.rotationOffset-=this.rotationSensibility,this.camera.rotationOffset%=360):this.keysRadiusIncr.indexOf(e)!==-1&&this._modifierRadius()?this.camera.radius+=this.radiusSensibility:this.keysRadiusDecr.indexOf(e)!==-1&&this._modifierRadius()&&(this.camera.radius-=this.radiusSensibility)})}getClassName(){return"FollowCameraKeyboardMoveInput"}getSimpleName(){return"keyboard"}_modifierHeightOffset(){return this.keysHeightOffsetModifierAlt===this._altPressed&&this.keysHeightOffsetModifierCtrl===this._ctrlPressed&&this.keysHeightOffsetModifierShift===this._shiftPressed}_modifierRotationOffset(){return this.keysRotationOffsetModifierAlt===this._altPressed&&this.keysRotationOffsetModifierCtrl===this._ctrlPressed&&this.keysRotationOffsetModifierShift===this._shiftPressed}_modifierRadius(){return this.keysRadiusModifierAlt===this._altPressed&&this.keysRadiusModifierCtrl===this._ctrlPressed&&this.keysRadiusModifierShift===this._shiftPressed}}T([R()],Yi.prototype,"keysHeightOffsetIncr",void 0);T([R()],Yi.prototype,"keysHeightOffsetDecr",void 0);T([R()],Yi.prototype,"keysHeightOffsetModifierAlt",void 0);T([R()],Yi.prototype,"keysHeightOffsetModifierCtrl",void 0);T([R()],Yi.prototype,"keysHeightOffsetModifierShift",void 0);T([R()],Yi.prototype,"keysRotationOffsetIncr",void 0);T([R()],Yi.prototype,"keysRotationOffsetDecr",void 0);T([R()],Yi.prototype,"keysRotationOffsetModifierAlt",void 0);T([R()],Yi.prototype,"keysRotationOffsetModifierCtrl",void 0);T([R()],Yi.prototype,"keysRotationOffsetModifierShift",void 0);T([R()],Yi.prototype,"keysRadiusIncr",void 0);T([R()],Yi.prototype,"keysRadiusDecr",void 0);T([R()],Yi.prototype,"keysRadiusModifierAlt",void 0);T([R()],Yi.prototype,"keysRadiusModifierCtrl",void 0);T([R()],Yi.prototype,"keysRadiusModifierShift",void 0);T([R()],Yi.prototype,"heightSensibility",void 0);T([R()],Yi.prototype,"rotationSensibility",void 0);T([R()],Yi.prototype,"radiusSensibility",void 0);Qi.FollowCameraKeyboardMoveInput=Yi;class Ha{constructor(){this.axisControlRadius=!0,this.axisControlHeight=!1,this.axisControlRotation=!1,this.wheelPrecision=3,this.wheelDeltaPercentage=0}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),this._wheel=t=>{if(t.type!==Ce.POINTERWHEEL)return;const i=t.event;let s=0;const r=Math.max(-1,Math.min(1,i.deltaY));this.wheelDeltaPercentage?(console.assert(this.axisControlRadius+this.axisControlHeight+this.axisControlRotation<=1,"wheelDeltaPercentage only usable when mouse wheel controls ONE axis. Currently enabled: axisControlRadius: "+this.axisControlRadius+", axisControlHeightOffset: "+this.axisControlHeight+", axisControlRotationOffset: "+this.axisControlRotation),this.axisControlRadius?s=r*.01*this.wheelDeltaPercentage*this.camera.radius:this.axisControlHeight?s=r*.01*this.wheelDeltaPercentage*this.camera.heightOffset:this.axisControlRotation&&(s=r*.01*this.wheelDeltaPercentage*this.camera.rotationOffset)):s=r*this.wheelPrecision,s&&(this.axisControlRadius?this.camera.radius+=s:this.axisControlHeight?this.camera.heightOffset-=s:this.axisControlRotation&&(this.camera.rotationOffset-=s)),i.preventDefault&&(e||i.preventDefault())},this._observer=this.camera.getScene().onPointerObservable.add(this._wheel,Ce.POINTERWHEEL)}detachControl(){this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null,this._wheel=null)}getClassName(){return"ArcRotateCameraMouseWheelInput"}getSimpleName(){return"mousewheel"}}T([R()],Ha.prototype,"axisControlRadius",void 0);T([R()],Ha.prototype,"axisControlHeight",void 0);T([R()],Ha.prototype,"axisControlRotation",void 0);T([R()],Ha.prototype,"wheelPrecision",void 0);T([R()],Ha.prototype,"wheelDeltaPercentage",void 0);Qi.FollowCameraMouseWheelInput=Ha;class Fs extends Gd{constructor(){super(...arguments),this.angularSensibilityX=1,this.angularSensibilityY=1,this.pinchPrecision=1e4,this.pinchDeltaPercentage=0,this.axisXControlRadius=!1,this.axisXControlHeight=!1,this.axisXControlRotation=!0,this.axisYControlRadius=!1,this.axisYControlHeight=!0,this.axisYControlRotation=!1,this.axisPinchControlRadius=!0,this.axisPinchControlHeight=!1,this.axisPinchControlRotation=!1,this.warningEnable=!0,this._warningCounter=0}getClassName(){return"FollowCameraPointersInput"}onTouch(e,t,i){this._warning(),this.axisXControlRotation?this.camera.rotationOffset+=t/this.angularSensibilityX:this.axisYControlRotation&&(this.camera.rotationOffset+=i/this.angularSensibilityX),this.axisXControlHeight?this.camera.heightOffset+=t/this.angularSensibilityY:this.axisYControlHeight&&(this.camera.heightOffset+=i/this.angularSensibilityY),this.axisXControlRadius?this.camera.radius-=t/this.angularSensibilityY:this.axisYControlRadius&&(this.camera.radius-=i/this.angularSensibilityY)}onMultiTouch(e,t,i,s,r,n){if(i===0&&r===null||s===0&&n===null)return;let o=(s-i)/(this.pinchPrecision*(this.angularSensibilityX+this.angularSensibilityY)/2);this.pinchDeltaPercentage?(o*=.01*this.pinchDeltaPercentage,this.axisPinchControlRotation&&(this.camera.rotationOffset+=o*this.camera.rotationOffset),this.axisPinchControlHeight&&(this.camera.heightOffset+=o*this.camera.heightOffset),this.axisPinchControlRadius&&(this.camera.radius-=o*this.camera.radius)):(this.axisPinchControlRotation&&(this.camera.rotationOffset+=o),this.axisPinchControlHeight&&(this.camera.heightOffset+=o),this.axisPinchControlRadius&&(this.camera.radius-=o))}_warning(){if(!this.warningEnable||this._warningCounter++%100!==0)return;const e="It probably only makes sense to control ONE camera property with each pointer axis. Set 'warningEnable = false' if you are sure. Currently enabled: ";console.assert(this.axisXControlRotation+this.axisXControlHeight+this.axisXControlRadius<=1,e+"axisXControlRotation: "+this.axisXControlRotation+", axisXControlHeight: "+this.axisXControlHeight+", axisXControlRadius: "+this.axisXControlRadius),console.assert(this.axisYControlRotation+this.axisYControlHeight+this.axisYControlRadius<=1,e+"axisYControlRotation: "+this.axisYControlRotation+", axisYControlHeight: "+this.axisYControlHeight+", axisYControlRadius: "+this.axisYControlRadius),console.assert(this.axisPinchControlRotation+this.axisPinchControlHeight+this.axisPinchControlRadius<=1,e+"axisPinchControlRotation: "+this.axisPinchControlRotation+", axisPinchControlHeight: "+this.axisPinchControlHeight+", axisPinchControlRadius: "+this.axisPinchControlRadius)}}T([R()],Fs.prototype,"angularSensibilityX",void 0);T([R()],Fs.prototype,"angularSensibilityY",void 0);T([R()],Fs.prototype,"pinchPrecision",void 0);T([R()],Fs.prototype,"pinchDeltaPercentage",void 0);T([R()],Fs.prototype,"axisXControlRadius",void 0);T([R()],Fs.prototype,"axisXControlHeight",void 0);T([R()],Fs.prototype,"axisXControlRotation",void 0);T([R()],Fs.prototype,"axisYControlRadius",void 0);T([R()],Fs.prototype,"axisYControlHeight",void 0);T([R()],Fs.prototype,"axisYControlRotation",void 0);T([R()],Fs.prototype,"axisPinchControlRadius",void 0);T([R()],Fs.prototype,"axisPinchControlHeight",void 0);T([R()],Fs.prototype,"axisPinchControlRotation",void 0);Qi.FollowCameraPointersInput=Fs;class Nr{constructor(){this.keysUp=[38],this.keysUpward=[33],this.keysDown=[40],this.keysDownward=[34],this.keysLeft=[37],this.keysRight=[39],this.rotationSpeed=.5,this.keysRotateLeft=[],this.keysRotateRight=[],this._keys=new Array}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),!this._onCanvasBlurObserver&&(this._scene=this.camera.getScene(),this._engine=this._scene.getEngine(),this._onCanvasBlurObserver=this._engine.onCanvasBlurObservable.add(()=>{this._keys.length=0}),this._onKeyboardObserver=this._scene.onKeyboardObservable.add(t=>{const i=t.event;if(!i.metaKey){if(t.type===Zn.KEYDOWN)(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1)&&(this._keys.indexOf(i.keyCode)===-1&&this._keys.push(i.keyCode),e||i.preventDefault());else if(this.keysUp.indexOf(i.keyCode)!==-1||this.keysDown.indexOf(i.keyCode)!==-1||this.keysLeft.indexOf(i.keyCode)!==-1||this.keysRight.indexOf(i.keyCode)!==-1||this.keysUpward.indexOf(i.keyCode)!==-1||this.keysDownward.indexOf(i.keyCode)!==-1||this.keysRotateLeft.indexOf(i.keyCode)!==-1||this.keysRotateRight.indexOf(i.keyCode)!==-1){const s=this._keys.indexOf(i.keyCode);s>=0&&this._keys.splice(s,1),e||i.preventDefault()}}}))}detachControl(){this._scene&&(this._onKeyboardObserver&&this._scene.onKeyboardObservable.remove(this._onKeyboardObserver),this._onCanvasBlurObserver&&this._engine.onCanvasBlurObservable.remove(this._onCanvasBlurObserver),this._onKeyboardObserver=null,this._onCanvasBlurObserver=null),this._keys.length=0}checkInputs(){if(this._onKeyboardObserver){const e=this.camera;for(let t=0;t<this._keys.length;t++){const i=this._keys[t],s=e._computeLocalCameraSpeed();this.keysLeft.indexOf(i)!==-1?e._localDirection.copyFromFloats(-s,0,0):this.keysUp.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,s):this.keysRight.indexOf(i)!==-1?e._localDirection.copyFromFloats(s,0,0):this.keysDown.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,0,-s):this.keysUpward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,s,0):this.keysDownward.indexOf(i)!==-1?e._localDirection.copyFromFloats(0,-s,0):this.keysRotateLeft.indexOf(i)!==-1?(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y-=this._getLocalRotation()):this.keysRotateRight.indexOf(i)!==-1&&(e._localDirection.copyFromFloats(0,0,0),e.cameraRotation.y+=this._getLocalRotation()),e.getScene().useRightHandedSystem&&(e._localDirection.z*=-1),e.getViewMatrix().invertToRef(e._cameraTransformMatrix),g.TransformNormalToRef(e._localDirection,e._cameraTransformMatrix,e._transformedDirection),e.cameraDirection.addInPlace(e._transformedDirection)}}}getClassName(){return"FreeCameraKeyboardMoveInput"}_onLostFocus(){this._keys.length=0}getSimpleName(){return"keyboard"}_getLocalRotation(){let e=this.rotationSpeed*this._engine.getDeltaTime()/1e3;return this.camera.getScene().useRightHandedSystem&&(e*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(e*=-1),e}}T([R()],Nr.prototype,"keysUp",void 0);T([R()],Nr.prototype,"keysUpward",void 0);T([R()],Nr.prototype,"keysDown",void 0);T([R()],Nr.prototype,"keysDownward",void 0);T([R()],Nr.prototype,"keysLeft",void 0);T([R()],Nr.prototype,"keysRight",void 0);T([R()],Nr.prototype,"rotationSpeed",void 0);T([R()],Nr.prototype,"keysRotateLeft",void 0);T([R()],Nr.prototype,"keysRotateRight",void 0);Qi.FreeCameraKeyboardMoveInput=Nr;class wc{constructor(e=!0){this.touchEnabled=e,this.buttons=[0,1,2],this.angularSensibility=2e3,this._previousPosition=null,this.onPointerMovedObservable=new X,this._allowCameraRotation=!0,this._currentActiveButton=-1}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);const t=this.camera.getEngine(),i=t.getInputElement();this._pointerInput||(this._pointerInput=s=>{const r=s.event,n=r.pointerType==="touch";if(t.isInVRExclusivePointerMode||!this.touchEnabled&&n||s.type!==Ce.POINTERMOVE&&this.buttons.indexOf(r.button)===-1)return;const o=r.target;if(s.type===Ce.POINTERDOWN&&(this._currentActiveButton===-1||n)){try{o==null||o.setPointerCapture(r.pointerId)}catch{}this._currentActiveButton===-1&&(this._currentActiveButton=r.button),this._previousPosition={x:r.clientX,y:r.clientY},e||(r.preventDefault(),i&&i.focus()),t.isPointerLock&&this._onMouseMove&&this._onMouseMove(s.event)}else if(s.type===Ce.POINTERUP&&(this._currentActiveButton===r.button||n)){try{o==null||o.releasePointerCapture(r.pointerId)}catch{}this._currentActiveButton=-1,this._previousPosition=null,e||r.preventDefault()}else if(s.type===Ce.POINTERMOVE){if(t.isPointerLock&&this._onMouseMove)this._onMouseMove(s.event);else if(this._previousPosition){let l=r.clientX-this._previousPosition.x;const h=r.clientY-this._previousPosition.y;this.camera.getScene().useRightHandedSystem&&(l*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(l*=-1),this._allowCameraRotation&&(this.camera.cameraRotation.y+=l/this.angularSensibility,this.camera.cameraRotation.x+=h/this.angularSensibility),this.onPointerMovedObservable.notifyObservers({offsetX:l,offsetY:h}),this._previousPosition={x:r.clientX,y:r.clientY},e||r.preventDefault()}}}),this._onMouseMove=s=>{if(!t.isPointerLock||t.isInVRExclusivePointerMode)return;let r=s.movementX;this.camera.getScene().useRightHandedSystem&&(r*=-1),this.camera.parent&&this.camera.parent._getWorldMatrixDeterminant()<0&&(r*=-1),this.camera.cameraRotation.y+=r/this.angularSensibility;const n=s.movementY;this.camera.cameraRotation.x+=n/this.angularSensibility,this._previousPosition=null,e||s.preventDefault()},this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE),i&&(this._contextMenuBind=this.onContextMenu.bind(this),i.addEventListener("contextmenu",this._contextMenuBind,!1))}onContextMenu(e){e.preventDefault()}detachControl(){if(this._observer){if(this.camera.getScene().onPointerObservable.remove(this._observer),this._contextMenuBind){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("contextmenu",this._contextMenuBind)}this.onPointerMovedObservable&&this.onPointerMovedObservable.clear(),this._observer=null,this._onMouseMove=null,this._previousPosition=null}this._currentActiveButton=-1}getClassName(){return"FreeCameraMouseInput"}getSimpleName(){return"mouse"}}T([R()],wc.prototype,"buttons",void 0);T([R()],wc.prototype,"angularSensibility",void 0);Qi.FreeCameraMouseInput=wc;var It;(function(a){a[a.MoveRelative=0]="MoveRelative",a[a.RotateRelative=1]="RotateRelative",a[a.MoveScene=2]="MoveScene"})(It||(It={}));class Fr extends Mc{constructor(){super(...arguments),this._moveRelative=g.Zero(),this._rotateRelative=g.Zero(),this._moveScene=g.Zero(),this._wheelXAction=It.MoveRelative,this._wheelXActionCoordinate=va.X,this._wheelYAction=It.MoveRelative,this._wheelYActionCoordinate=va.Z,this._wheelZAction=null,this._wheelZActionCoordinate=null}getClassName(){return"FreeCameraMouseWheelInput"}set wheelXMoveRelative(e){e===null&&this._wheelXAction!==It.MoveRelative||(this._wheelXAction=It.MoveRelative,this._wheelXActionCoordinate=e)}get wheelXMoveRelative(){return this._wheelXAction!==It.MoveRelative?null:this._wheelXActionCoordinate}set wheelYMoveRelative(e){e===null&&this._wheelYAction!==It.MoveRelative||(this._wheelYAction=It.MoveRelative,this._wheelYActionCoordinate=e)}get wheelYMoveRelative(){return this._wheelYAction!==It.MoveRelative?null:this._wheelYActionCoordinate}set wheelZMoveRelative(e){e===null&&this._wheelZAction!==It.MoveRelative||(this._wheelZAction=It.MoveRelative,this._wheelZActionCoordinate=e)}get wheelZMoveRelative(){return this._wheelZAction!==It.MoveRelative?null:this._wheelZActionCoordinate}set wheelXRotateRelative(e){e===null&&this._wheelXAction!==It.RotateRelative||(this._wheelXAction=It.RotateRelative,this._wheelXActionCoordinate=e)}get wheelXRotateRelative(){return this._wheelXAction!==It.RotateRelative?null:this._wheelXActionCoordinate}set wheelYRotateRelative(e){e===null&&this._wheelYAction!==It.RotateRelative||(this._wheelYAction=It.RotateRelative,this._wheelYActionCoordinate=e)}get wheelYRotateRelative(){return this._wheelYAction!==It.RotateRelative?null:this._wheelYActionCoordinate}set wheelZRotateRelative(e){e===null&&this._wheelZAction!==It.RotateRelative||(this._wheelZAction=It.RotateRelative,this._wheelZActionCoordinate=e)}get wheelZRotateRelative(){return this._wheelZAction!==It.RotateRelative?null:this._wheelZActionCoordinate}set wheelXMoveScene(e){e===null&&this._wheelXAction!==It.MoveScene||(this._wheelXAction=It.MoveScene,this._wheelXActionCoordinate=e)}get wheelXMoveScene(){return this._wheelXAction!==It.MoveScene?null:this._wheelXActionCoordinate}set wheelYMoveScene(e){e===null&&this._wheelYAction!==It.MoveScene||(this._wheelYAction=It.MoveScene,this._wheelYActionCoordinate=e)}get wheelYMoveScene(){return this._wheelYAction!==It.MoveScene?null:this._wheelYActionCoordinate}set wheelZMoveScene(e){e===null&&this._wheelZAction!==It.MoveScene||(this._wheelZAction=It.MoveScene,this._wheelZActionCoordinate=e)}get wheelZMoveScene(){return this._wheelZAction!==It.MoveScene?null:this._wheelZActionCoordinate}checkInputs(){if(this._wheelDeltaX===0&&this._wheelDeltaY===0&&this._wheelDeltaZ==0)return;this._moveRelative.setAll(0),this._rotateRelative.setAll(0),this._moveScene.setAll(0),this._updateCamera(),this.camera.getScene().useRightHandedSystem&&(this._moveRelative.z*=-1);const e=L.Zero();this.camera.getViewMatrix().invertToRef(e);const t=g.Zero();g.TransformNormalToRef(this._moveRelative,e,t),this.camera.cameraRotation.x+=this._rotateRelative.x/200,this.camera.cameraRotation.y+=this._rotateRelative.y/200,this.camera.cameraDirection.addInPlace(t),this.camera.cameraDirection.addInPlace(this._moveScene),super.checkInputs()}_updateCamera(){this._updateCameraProperty(this._wheelDeltaX,this._wheelXAction,this._wheelXActionCoordinate),this._updateCameraProperty(this._wheelDeltaY,this._wheelYAction,this._wheelYActionCoordinate),this._updateCameraProperty(this._wheelDeltaZ,this._wheelZAction,this._wheelZActionCoordinate)}_updateCameraProperty(e,t,i){if(e===0||t===null||i===null)return;let s=null;switch(t){case It.MoveRelative:s=this._moveRelative;break;case It.RotateRelative:s=this._rotateRelative;break;case It.MoveScene:s=this._moveScene;break}switch(i){case va.X:s.set(e,0,0);break;case va.Y:s.set(0,e,0);break;case va.Z:s.set(0,0,e);break}}}T([R()],Fr.prototype,"wheelXMoveRelative",null);T([R()],Fr.prototype,"wheelYMoveRelative",null);T([R()],Fr.prototype,"wheelZMoveRelative",null);T([R()],Fr.prototype,"wheelXRotateRelative",null);T([R()],Fr.prototype,"wheelYRotateRelative",null);T([R()],Fr.prototype,"wheelZRotateRelative",null);T([R()],Fr.prototype,"wheelXMoveScene",null);T([R()],Fr.prototype,"wheelYMoveScene",null);T([R()],Fr.prototype,"wheelZMoveScene",null);Qi.FreeCameraMouseWheelInput=Fr;class Nc{constructor(e=!1){this.allowMouse=e,this.touchAngularSensibility=2e5,this.touchMoveSensibility=250,this.singleFingerRotate=!1,this._offsetX=null,this._offsetY=null,this._pointerPressed=new Array,this._isSafari=q.IsSafari()}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments);let t=null;if(this._pointerInput===void 0&&(this._onLostFocus=()=>{this._offsetX=null,this._offsetY=null},this._pointerInput=i=>{const s=i.event,r=s.pointerType==="mouse"||this._isSafari&&typeof s.pointerType>"u";if(!(!this.allowMouse&&r)){if(i.type===Ce.POINTERDOWN){if(e||s.preventDefault(),this._pointerPressed.push(s.pointerId),this._pointerPressed.length!==1)return;t={x:s.clientX,y:s.clientY}}else if(i.type===Ce.POINTERUP){e||s.preventDefault();const n=this._pointerPressed.indexOf(s.pointerId);if(n===-1||(this._pointerPressed.splice(n,1),n!=0))return;t=null,this._offsetX=null,this._offsetY=null}else if(i.type===Ce.POINTERMOVE){if(e||s.preventDefault(),!t||this._pointerPressed.indexOf(s.pointerId)!=0)return;this._offsetX=s.clientX-t.x,this._offsetY=-(s.clientY-t.y)}}}),this._observer=this.camera.getScene().onPointerObservable.add(this._pointerInput,Ce.POINTERDOWN|Ce.POINTERUP|Ce.POINTERMOVE),this._onLostFocus){const s=this.camera.getEngine().getInputElement();s&&s.addEventListener("blur",this._onLostFocus)}}detachControl(){if(this._pointerInput){if(this._observer&&(this.camera.getScene().onPointerObservable.remove(this._observer),this._observer=null),this._onLostFocus){const t=this.camera.getEngine().getInputElement();t&&t.removeEventListener("blur",this._onLostFocus),this._onLostFocus=null}this._pointerPressed.length=0,this._offsetX=null,this._offsetY=null}}checkInputs(){if(this._offsetX===null||this._offsetY===null||this._offsetX===0&&this._offsetY===0)return;const e=this.camera;if(e.cameraRotation.y=this._offsetX/this.touchAngularSensibility,this.singleFingerRotate&&this._pointerPressed.length===1||!this.singleFingerRotate&&this._pointerPressed.length>1)e.cameraRotation.x=-this._offsetY/this.touchAngularSensibility;else{const i=e._computeLocalCameraSpeed(),s=new g(0,0,this.touchMoveSensibility!==0?i*this._offsetY/this.touchMoveSensibility:0);L.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,e._cameraRotationMatrix),e.cameraDirection.addInPlace(g.TransformCoordinates(s,e._cameraRotationMatrix))}}getClassName(){return"FreeCameraTouchInput"}getSimpleName(){return"touch"}}T([R()],Nc.prototype,"touchAngularSensibility",void 0);T([R()],Nc.prototype,"touchMoveSensibility",void 0);Qi.FreeCameraTouchInput=Nc;class Fc extends bc{constructor(e){super(e),this._mouseInput=null,this._mouseWheelInput=null}addKeyboard(){return this.add(new Nr),this}addMouse(e=!0){return this._mouseInput||(this._mouseInput=new wc(e),this.add(this._mouseInput)),this}removeMouse(){return this._mouseInput&&this.remove(this._mouseInput),this}addMouseWheel(){return this._mouseWheelInput||(this._mouseWheelInput=new Fr,this.add(this._mouseWheelInput)),this}removeMouseWheel(){return this._mouseWheelInput&&this.remove(this._mouseWheelInput),this}addTouch(){return this.add(new Nc),this}clear(){super.clear(),this._mouseInput=null}}Fc.prototype.addDeviceOrientation=function(a){return this._deviceOrientationInput||(this._deviceOrientationInput=new G_,a&&(this._deviceOrientationInput.smoothFactor=a),this.add(this._deviceOrientationInput)),this};class G_{constructor(){this._screenOrientationAngle=0,this._screenQuaternion=new Q,this._alpha=0,this._beta=0,this._gamma=0,this.smoothFactor=0,this._onDeviceOrientationChangedObservable=new X,this._orientationChanged=()=>{this._screenOrientationAngle=window.orientation!==void 0?+window.orientation:window.screen.orientation&&window.screen.orientation.angle?window.screen.orientation.angle:0,this._screenOrientationAngle=-q.ToRadians(this._screenOrientationAngle/2),this._screenQuaternion.copyFromFloats(0,Math.sin(this._screenOrientationAngle),0,Math.cos(this._screenOrientationAngle))},this._deviceOrientation=e=>{this.smoothFactor?(this._alpha=e.alpha!==null?q.SmoothAngleChange(this._alpha,e.alpha,this.smoothFactor):0,this._beta=e.beta!==null?q.SmoothAngleChange(this._beta,e.beta,this.smoothFactor):0,this._gamma=e.gamma!==null?q.SmoothAngleChange(this._gamma,e.gamma,this.smoothFactor):0):(this._alpha=e.alpha!==null?e.alpha:0,this._beta=e.beta!==null?e.beta:0,this._gamma=e.gamma!==null?e.gamma:0),e.alpha!==null&&this._onDeviceOrientationChangedObservable.notifyObservers()},this._constantTranform=new Q(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._orientationChanged()}static WaitForOrientationChangeAsync(e){return new Promise((t,i)=>{let s=!1;const r=()=>{window.removeEventListener("deviceorientation",r),s=!0,t()};e&&setTimeout(()=>{s||(window.removeEventListener("deviceorientation",r),i("WaitForOrientationChangeAsync timed out"))},e),typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(n=>{n=="granted"?window.addEventListener("deviceorientation",r):q.Warn("Permission not granted.")}).catch(n=>{q.Error(n)}):window.addEventListener("deviceorientation",r)})}get camera(){return this._camera}set camera(e){this._camera=e,this._camera!=null&&!this._camera.rotationQuaternion&&(this._camera.rotationQuaternion=new Q),this._camera&&this._camera.onDisposeObservable.add(()=>{this._onDeviceOrientationChangedObservable.clear()})}attachControl(){const e=this.camera.getScene().getEngine().getHostWindow();if(e){const t=()=>{e.addEventListener("orientationchange",this._orientationChanged),e.addEventListener("deviceorientation",this._deviceOrientation),this._orientationChanged()};typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then(i=>{i==="granted"?t():q.Warn("Permission not granted.")}).catch(i=>{q.Error(i)}):t()}}detachControl(){window.removeEventListener("orientationchange",this._orientationChanged),window.removeEventListener("deviceorientation",this._deviceOrientation),this._alpha=0}checkInputs(){!this._alpha||(Q.RotationYawPitchRollToRef(q.ToRadians(this._alpha),q.ToRadians(this._beta),-q.ToRadians(this._gamma),this.camera.rotationQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._screenQuaternion),this._camera.rotationQuaternion.multiplyInPlace(this._constantTranform),this._camera.rotationQuaternion.z*=-1,this._camera.rotationQuaternion.w*=-1)}getClassName(){return"FreeCameraDeviceOrientationInput"}getSimpleName(){return"deviceOrientation"}}Qi.FreeCameraDeviceOrientationInput=G_;class Lc{constructor(){this.gamepadAngularSensibility=200,this.gamepadMoveSensibility=40,this.deadzoneDelta=.1,this._yAxisScale=1,this._cameraTransform=L.Identity(),this._deltaTransform=g.Zero(),this._vector3=g.Zero(),this._vector2=le.Zero()}get invertYAxis(){return this._yAxisScale!==1}set invertYAxis(e){this._yAxisScale=e?-1:1}attachControl(){const e=this.camera.getScene().gamepadManager;this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{t.type!==oi.POSE_ENABLED&&(!this.gamepad||t.type===oi.XBOX)&&(this.gamepad=t)}),this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{this.gamepad===t&&(this.gamepad=null)}),this.gamepad=e.getGamepadByType(oi.XBOX),!this.gamepad&&e.gamepads.length&&(this.gamepad=e.gamepads[0])}detachControl(){this.camera.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.camera.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),this.gamepad=null}checkInputs(){if(this.gamepad&&this.gamepad.leftStick){const e=this.camera,t=this.gamepad.leftStick;this.gamepadMoveSensibility!==0&&(t.x=Math.abs(t.x)>this.deadzoneDelta?t.x/this.gamepadMoveSensibility:0,t.y=Math.abs(t.y)>this.deadzoneDelta?t.y/this.gamepadMoveSensibility:0);let i=this.gamepad.rightStick;i&&this.gamepadAngularSensibility!==0?(i.x=Math.abs(i.x)>this.deadzoneDelta?i.x/this.gamepadAngularSensibility:0,i.y=(Math.abs(i.y)>this.deadzoneDelta?i.y/this.gamepadAngularSensibility:0)*this._yAxisScale):i={x:0,y:0},e.rotationQuaternion?e.rotationQuaternion.toRotationMatrix(this._cameraTransform):L.RotationYawPitchRollToRef(e.rotation.y,e.rotation.x,0,this._cameraTransform);const s=e._computeLocalCameraSpeed()*50;this._vector3.copyFromFloats(t.x*s,0,-t.y*s),g.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform),e.cameraDirection.addInPlace(this._deltaTransform),this._vector2.copyFromFloats(i.y,i.x),e.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraGamepadInput"}getSimpleName(){return"gamepad"}}T([R()],Lc.prototype,"gamepadAngularSensibility",void 0);T([R()],Lc.prototype,"gamepadMoveSensibility",void 0);Qi.FreeCameraGamepadInput=Lc;var yi;(function(a){a[a.X=0]="X",a[a.Y=1]="Y",a[a.Z=2]="Z"})(yi||(yi={}));class Ae{constructor(e,t){const i={...Ae._GetDefaultOptions(),...t};if(e?this._leftJoystick=!0:this._leftJoystick=!1,Ae._GlobalJoystickIndex++,this._axisTargetedByLeftAndRight=yi.X,this._axisTargetedByUpAndDown=yi.Y,this.reverseLeftRight=!1,this.reverseUpDown=!1,this._touches=new Zu,this.deltaPosition=g.Zero(),this._joystickSensibility=25,this._inversedSensibility=1/(this._joystickSensibility/1e3),this._onResize=()=>{Ae._VJCanvasWidth=window.innerWidth,Ae._VJCanvasHeight=window.innerHeight,Ae.Canvas&&(Ae.Canvas.width=Ae._VJCanvasWidth,Ae.Canvas.height=Ae._VJCanvasHeight),Ae._HalfWidth=Ae._VJCanvasWidth/2},!Ae.Canvas){window.addEventListener("resize",this._onResize,!1),Ae.Canvas=document.createElement("canvas"),Ae._VJCanvasWidth=window.innerWidth,Ae._VJCanvasHeight=window.innerHeight,Ae.Canvas.width=window.innerWidth,Ae.Canvas.height=window.innerHeight,Ae.Canvas.style.width="100%",Ae.Canvas.style.height="100%",Ae.Canvas.style.position="absolute",Ae.Canvas.style.backgroundColor="transparent",Ae.Canvas.style.top="0px",Ae.Canvas.style.left="0px",Ae.Canvas.style.zIndex="5",Ae.Canvas.style.touchAction="none",Ae.Canvas.setAttribute("touch-action","none");const s=Ae.Canvas.getContext("2d");if(!s)throw new Error("Unable to create canvas for virtual joystick");Ae._VJCanvasContext=s,Ae._VJCanvasContext.strokeStyle="#ffffff",Ae._VJCanvasContext.lineWidth=2,document.body.appendChild(Ae.Canvas)}Ae._HalfWidth=Ae.Canvas.width/2,this.pressed=!1,this.limitToContainer=i.limitToContainer,this._joystickColor=i.color,this.containerSize=i.containerSize,this.puckSize=i.puckSize,i.position&&this.setPosition(i.position.x,i.position.y),i.puckImage&&this.setPuckImage(i.puckImage),i.containerImage&&this.setContainerImage(i.containerImage),i.alwaysVisible&&Ae._AlwaysVisibleSticks++,this.alwaysVisible=i.alwaysVisible,this._joystickPointerId=-1,this._joystickPointerPos=new le(0,0),this._joystickPreviousPointerPos=new le(0,0),this._joystickPointerStartPos=new le(0,0),this._deltaJoystickVector=new le(0,0),this._onPointerDownHandlerRef=s=>{this._onPointerDown(s)},this._onPointerMoveHandlerRef=s=>{this._onPointerMove(s)},this._onPointerUpHandlerRef=s=>{this._onPointerUp(s)},Ae.Canvas.addEventListener("pointerdown",this._onPointerDownHandlerRef,!1),Ae.Canvas.addEventListener("pointermove",this._onPointerMoveHandlerRef,!1),Ae.Canvas.addEventListener("pointerup",this._onPointerUpHandlerRef,!1),Ae.Canvas.addEventListener("pointerout",this._onPointerUpHandlerRef,!1),Ae.Canvas.addEventListener("contextmenu",s=>{s.preventDefault()},!1),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}static _GetDefaultOptions(){return{puckSize:40,containerSize:60,color:"cyan",puckImage:void 0,containerImage:void 0,position:void 0,alwaysVisible:!1,limitToContainer:!1}}setJoystickSensibility(e){this._joystickSensibility=e,this._inversedSensibility=1/(this._joystickSensibility/1e3)}_onPointerDown(e){let t;e.preventDefault(),this._leftJoystick===!0?t=e.clientX<Ae._HalfWidth:t=e.clientX>Ae._HalfWidth,t&&this._joystickPointerId<0?(this._joystickPointerId=e.pointerId,this._joystickPosition?(this._joystickPointerStartPos=this._joystickPosition.clone(),this._joystickPointerPos=this._joystickPosition.clone(),this._joystickPreviousPointerPos=this._joystickPosition.clone(),this._onPointerMove(e)):(this._joystickPointerStartPos.x=e.clientX,this._joystickPointerStartPos.y=e.clientY,this._joystickPointerPos=this._joystickPointerStartPos.clone(),this._joystickPreviousPointerPos=this._joystickPointerStartPos.clone()),this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this.pressed=!0,this._touches.add(e.pointerId.toString(),e)):Ae._GlobalJoystickIndex<2&&this._action&&(this._action(),this._touches.add(e.pointerId.toString(),{x:e.clientX,y:e.clientY,prevX:e.clientX,prevY:e.clientY}))}_onPointerMove(e){if(this._joystickPointerId==e.pointerId){if(this.limitToContainer){const n=new le(e.clientX-this._joystickPointerStartPos.x,e.clientY-this._joystickPointerStartPos.y),o=n.length();o>this.containerSize&&n.scaleInPlace(this.containerSize/o),this._joystickPointerPos.x=this._joystickPointerStartPos.x+n.x,this._joystickPointerPos.y=this._joystickPointerStartPos.y+n.y}else this._joystickPointerPos.x=e.clientX,this._joystickPointerPos.y=e.clientY;this._deltaJoystickVector=this._joystickPointerPos.clone(),this._deltaJoystickVector=this._deltaJoystickVector.subtract(this._joystickPointerStartPos),0<Ae._AlwaysVisibleSticks&&(this._leftJoystick?this._joystickPointerPos.x=Math.min(Ae._HalfWidth,this._joystickPointerPos.x):this._joystickPointerPos.x=Math.max(Ae._HalfWidth,this._joystickPointerPos.x));const i=(this.reverseLeftRight?-1:1)*this._deltaJoystickVector.x/this._inversedSensibility;switch(this._axisTargetedByLeftAndRight){case yi.X:this.deltaPosition.x=Math.min(1,Math.max(-1,i));break;case yi.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,i));break;case yi.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,i));break}const r=(this.reverseUpDown?1:-1)*this._deltaJoystickVector.y/this._inversedSensibility;switch(this._axisTargetedByUpAndDown){case yi.X:this.deltaPosition.x=Math.min(1,Math.max(-1,r));break;case yi.Y:this.deltaPosition.y=Math.min(1,Math.max(-1,r));break;case yi.Z:this.deltaPosition.z=Math.min(1,Math.max(-1,r));break}}else{const t=this._touches.get(e.pointerId.toString());t&&(t.x=e.clientX,t.y=e.clientY)}}_onPointerUp(e){if(this._joystickPointerId==e.pointerId)this._clearPreviousDraw(),this._joystickPointerId=-1,this.pressed=!1;else{const t=this._touches.get(e.pointerId.toString());t&&Ae._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88)}this._deltaJoystickVector.x=0,this._deltaJoystickVector.y=0,this._touches.remove(e.pointerId.toString())}setJoystickColor(e){this._joystickColor=e}set containerSize(e){this._joystickContainerSize=e,this._clearContainerSize=~~(this._joystickContainerSize*2.1),this._clearContainerSizeOffset=~~(this._clearContainerSize/2)}get containerSize(){return this._joystickContainerSize}set puckSize(e){this._joystickPuckSize=e,this._clearPuckSize=~~(this._joystickPuckSize*2.1),this._clearPuckSizeOffset=~~(this._clearPuckSize/2)}get puckSize(){return this._joystickPuckSize}clearPosition(){this.alwaysVisible=!1,this._joystickPosition=null}set alwaysVisible(e){this._alwaysVisible!==e&&(e&&this._joystickPosition?(Ae._AlwaysVisibleSticks++,this._alwaysVisible=!0):(Ae._AlwaysVisibleSticks--,this._alwaysVisible=!1))}get alwaysVisible(){return this._alwaysVisible}setPosition(e,t){this._joystickPointerStartPos&&this._clearPreviousDraw(),this._joystickPosition=new le(e,t)}setActionOnTouch(e){this._action=e}setAxisForLeftRight(e){switch(e){case yi.X:case yi.Y:case yi.Z:this._axisTargetedByLeftAndRight=e;break;default:this._axisTargetedByLeftAndRight=yi.X;break}}setAxisForUpDown(e){switch(e){case yi.X:case yi.Y:case yi.Z:this._axisTargetedByUpAndDown=e;break;default:this._axisTargetedByUpAndDown=yi.Y;break}}_clearPreviousDraw(){const e=this._joystickPosition||this._joystickPointerStartPos;Ae._VJCanvasContext.clearRect(e.x-this._clearContainerSizeOffset,e.y-this._clearContainerSizeOffset,this._clearContainerSize,this._clearContainerSize),Ae._VJCanvasContext.clearRect(this._joystickPreviousPointerPos.x-this._clearPuckSizeOffset,this._joystickPreviousPointerPos.y-this._clearPuckSizeOffset,this._clearPuckSize,this._clearPuckSize)}setContainerImage(e){const t=new Image;t.src=e,t.onload=()=>this._containerImage=t}setPuckImage(e){const t=new Image;t.src=e,t.onload=()=>this._puckImage=t}_drawContainer(){const e=this._joystickPosition||this._joystickPointerStartPos;this._clearPreviousDraw(),this._containerImage?Ae._VJCanvasContext.drawImage(this._containerImage,e.x-this.containerSize,e.y-this.containerSize,this.containerSize*2,this.containerSize*2):(Ae._VJCanvasContext.beginPath(),Ae._VJCanvasContext.strokeStyle=this._joystickColor,Ae._VJCanvasContext.lineWidth=2,Ae._VJCanvasContext.arc(e.x,e.y,this.containerSize,0,Math.PI*2,!0),Ae._VJCanvasContext.stroke(),Ae._VJCanvasContext.closePath(),Ae._VJCanvasContext.beginPath(),Ae._VJCanvasContext.lineWidth=6,Ae._VJCanvasContext.strokeStyle=this._joystickColor,Ae._VJCanvasContext.arc(e.x,e.y,this.puckSize,0,Math.PI*2,!0),Ae._VJCanvasContext.stroke(),Ae._VJCanvasContext.closePath())}_drawPuck(){this._puckImage?Ae._VJCanvasContext.drawImage(this._puckImage,this._joystickPointerPos.x-this.puckSize,this._joystickPointerPos.y-this.puckSize,this.puckSize*2,this.puckSize*2):(Ae._VJCanvasContext.beginPath(),Ae._VJCanvasContext.strokeStyle=this._joystickColor,Ae._VJCanvasContext.lineWidth=2,Ae._VJCanvasContext.arc(this._joystickPointerPos.x,this._joystickPointerPos.y,this.puckSize,0,Math.PI*2,!0),Ae._VJCanvasContext.stroke(),Ae._VJCanvasContext.closePath())}_drawVirtualJoystick(){this.alwaysVisible&&this._drawContainer(),this.pressed&&this._touches.forEach((e,t)=>{t.pointerId===this._joystickPointerId?(this.alwaysVisible||this._drawContainer(),this._drawPuck(),this._joystickPreviousPointerPos=this._joystickPointerPos.clone()):(Ae._VJCanvasContext.clearRect(t.prevX-44,t.prevY-44,88,88),Ae._VJCanvasContext.beginPath(),Ae._VJCanvasContext.fillStyle="white",Ae._VJCanvasContext.beginPath(),Ae._VJCanvasContext.strokeStyle="red",Ae._VJCanvasContext.lineWidth=6,Ae._VJCanvasContext.arc(t.x,t.y,40,0,Math.PI*2,!0),Ae._VJCanvasContext.stroke(),Ae._VJCanvasContext.closePath(),t.prevX=t.x,t.prevY=t.y)}),requestAnimationFrame(()=>{this._drawVirtualJoystick()})}releaseCanvas(){Ae.Canvas&&(Ae.Canvas.removeEventListener("pointerdown",this._onPointerDownHandlerRef),Ae.Canvas.removeEventListener("pointermove",this._onPointerMoveHandlerRef),Ae.Canvas.removeEventListener("pointerup",this._onPointerUpHandlerRef),Ae.Canvas.removeEventListener("pointerout",this._onPointerUpHandlerRef),window.removeEventListener("resize",this._onResize),document.body.removeChild(Ae.Canvas),Ae.Canvas=null)}}Ae._GlobalJoystickIndex=0;Ae._AlwaysVisibleSticks=0;Fc.prototype.addVirtualJoystick=function(){return this.add(new z_),this};class z_{getLeftJoystick(){return this._leftjoystick}getRightJoystick(){return this._rightjoystick}checkInputs(){if(this._leftjoystick){const e=this.camera,t=e._computeLocalCameraSpeed()*50,i=L.RotationYawPitchRoll(e.rotation.y,e.rotation.x,0),s=g.TransformCoordinates(new g(this._leftjoystick.deltaPosition.x*t,this._leftjoystick.deltaPosition.y*t,this._leftjoystick.deltaPosition.z*t),i);e.cameraDirection=e.cameraDirection.add(s),e.cameraRotation=e.cameraRotation.addVector3(this._rightjoystick.deltaPosition),this._leftjoystick.pressed||(this._leftjoystick.deltaPosition=this._leftjoystick.deltaPosition.scale(.9)),this._rightjoystick.pressed||(this._rightjoystick.deltaPosition=this._rightjoystick.deltaPosition.scale(.9))}}attachControl(){this._leftjoystick=new Ae(!0),this._leftjoystick.setAxisForUpDown(yi.Z),this._leftjoystick.setAxisForLeftRight(yi.X),this._leftjoystick.setJoystickSensibility(.15),this._rightjoystick=new Ae(!1),this._rightjoystick.setAxisForUpDown(yi.X),this._rightjoystick.setAxisForLeftRight(yi.Y),this._rightjoystick.reverseUpDown=!0,this._rightjoystick.setJoystickSensibility(.05),this._rightjoystick.setJoystickColor("yellow")}detachControl(){this._leftjoystick.releaseCanvas(),this._rightjoystick.releaseCanvas()}getClassName(){return"FreeCameraVirtualJoystickInput"}getSimpleName(){return"virtualJoystick"}}Qi.FreeCameraVirtualJoystickInput=z_;class ws extends ai{constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new g(.5,1,.5),this.ellipsoidOffset=new g(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this._needMoveForGravity=!1,this._oldPosition=g.Zero(),this._diffPosition=g.Zero(),this._newPosition=g.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(r,n,o=null)=>{(h=>{this._newPosition.copyFrom(h),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>k.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&o&&this.onCollide(o))})(n)},this.inputs=new Fc(this),this.inputs.addKeyboard().addMouse()}get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysUpward(){const e=this.inputs.attached.keyboard;return e?e.keysUpward:[]}set keysUpward(e){const t=this.inputs.attached.keyboard;t&&(t.keysUpward=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysDownward(){const e=this.inputs.attached.keyboard;return e?e.keysDownward:[]}set keysDownward(e){const t=this.inputs.attached.keyboard;t&&(t.keysDownward=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}get keysRotateLeft(){const e=this.inputs.attached.keyboard;return e?e.keysRotateLeft:[]}set keysRotateLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateLeft=e)}get keysRotateRight(){const e=this.inputs.attached.keyboard;return e?e.keysRotateRight:[]}set keysRotateRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRotateRight=e)}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new g(0,0,0),this.cameraRotation=new le(0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=g.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=g.Zero(),this._transformedDirection=g.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FreeCamera"}}T([Zi()],ws.prototype,"ellipsoid",void 0);T([Zi()],ws.prototype,"ellipsoidOffset",void 0);T([R()],ws.prototype,"checkCollisions",void 0);T([R()],ws.prototype,"applyGravity",void 0);lt.AddNodeConstructor("TouchCamera",(a,e)=>()=>new W_(a,g.Zero(),e));class W_ extends ws{get touchAngularSensibility(){const e=this.inputs.attached.touch;return e?e.touchAngularSensibility:0}set touchAngularSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchAngularSensibility=e)}get touchMoveSensibility(){const e=this.inputs.attached.touch;return e?e.touchMoveSensibility:0}set touchMoveSensibility(e){const t=this.inputs.attached.touch;t&&(t.touchMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addTouch(),this._setupInputs()}getClassName(){return"TouchCamera"}_setupInputs(){const e=this.inputs.attached.touch,t=this.inputs.attached.mouse;t?t.touchEnabled=!1:e.allowMouse=!0}}lt.AddNodeConstructor("DeviceOrientationCamera",(a,e)=>()=>new Xd(a,g.Zero(),e));class Xd extends ws{constructor(e,t,i){super(e,t,i),this._tmpDragQuaternion=new Q,this._disablePointerInputWhenUsingDeviceOrientation=!0,this._dragFactor=0,this._quaternionCache=new Q,this.inputs.addDeviceOrientation(),this.inputs._deviceOrientationInput&&this.inputs._deviceOrientationInput._onDeviceOrientationChangedObservable.addOnce(()=>{this._disablePointerInputWhenUsingDeviceOrientation&&this.inputs._mouseInput&&(this.inputs._mouseInput._allowCameraRotation=!1,this.inputs._mouseInput.onPointerMovedObservable.add(s=>{this._dragFactor!=0&&(this._initialQuaternion||(this._initialQuaternion=new Q),Q.FromEulerAnglesToRef(0,s.offsetX*this._dragFactor,0,this._tmpDragQuaternion),this._initialQuaternion.multiplyToRef(this._tmpDragQuaternion,this._initialQuaternion))}))})}get disablePointerInputWhenUsingDeviceOrientation(){return this._disablePointerInputWhenUsingDeviceOrientation}set disablePointerInputWhenUsingDeviceOrientation(e){this._disablePointerInputWhenUsingDeviceOrientation=e}enableHorizontalDragging(e=1/300){this._dragFactor=e}getClassName(){return"DeviceOrientationCamera"}_checkInputs(){super._checkInputs(),this._quaternionCache.copyFrom(this.rotationQuaternion),this._initialQuaternion&&this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion)}resetToCurrentRotation(e=ti.Y){!this.rotationQuaternion||(this._initialQuaternion||(this._initialQuaternion=new Q),this._initialQuaternion.copyFrom(this._quaternionCache||this.rotationQuaternion),["x","y","z"].forEach(t=>{e[t]?this._initialQuaternion[t]*=-1:this._initialQuaternion[t]=0}),this._initialQuaternion.normalize(),this._initialQuaternion.multiplyToRef(this.rotationQuaternion,this.rotationQuaternion))}}class G1 extends bc{constructor(e){super(e)}addKeyboard(){return this.add(new ha),this}addMouse(){return this.add(new Oc),this}}class Bc extends ai{constructor(e,t,i,s=!0){super(e,t,i,s),this.ellipsoid=new g(1,1,1),this.ellipsoidOffset=new g(0,0,0),this.checkCollisions=!1,this.applyGravity=!1,this.cameraDirection=g.Zero(),this._trackRoll=0,this.rollCorrect=100,this.bankedTurn=!1,this.bankedTurnLimit=Math.PI/2,this.bankedTurnMultiplier=1,this._needMoveForGravity=!1,this._oldPosition=g.Zero(),this._diffPosition=g.Zero(),this._newPosition=g.Zero(),this._collisionMask=-1,this._onCollisionPositionChange=(r,n,o=null)=>{(h=>{this._newPosition.copyFrom(h),this._newPosition.subtractToRef(this._oldPosition,this._diffPosition),this._diffPosition.length()>k.CollisionsEpsilon&&(this.position.addInPlace(this._diffPosition),this.onCollide&&o&&this.onCollide(o))})(n)},this.inputs=new G1(this),this.inputs.addKeyboard().addMouse()}get angularSensibility(){const e=this.inputs.attached.mouse;return e?e.angularSensibility:0}set angularSensibility(e){const t=this.inputs.attached.mouse;t&&(t.angularSensibility=e)}get keysForward(){const e=this.inputs.attached.keyboard;return e?e.keysForward:[]}set keysForward(e){const t=this.inputs.attached.keyboard;t&&(t.keysForward=e)}get keysBackward(){const e=this.inputs.attached.keyboard;return e?e.keysBackward:[]}set keysBackward(e){const t=this.inputs.attached.keyboard;t&&(t.keysBackward=e)}get keysUp(){const e=this.inputs.attached.keyboard;return e?e.keysUp:[]}set keysUp(e){const t=this.inputs.attached.keyboard;t&&(t.keysUp=e)}get keysDown(){const e=this.inputs.attached.keyboard;return e?e.keysDown:[]}set keysDown(e){const t=this.inputs.attached.keyboard;t&&(t.keysDown=e)}get keysLeft(){const e=this.inputs.attached.keyboard;return e?e.keysLeft:[]}set keysLeft(e){const t=this.inputs.attached.keyboard;t&&(t.keysLeft=e)}get keysRight(){const e=this.inputs.attached.keyboard;return e?e.keysRight:[]}set keysRight(e){const t=this.inputs.attached.keyboard;t&&(t.keysRight=e)}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t)}detachControl(){this.inputs.detachElement(),this.cameraDirection=new g(0,0,0)}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}_collideWithWorld(e){let t;this.parent?t=g.TransformCoordinates(this.position,this.parent.getWorldMatrix()):t=this.position,t.subtractFromFloatsToRef(0,this.ellipsoid.y,0,this._oldPosition),this._oldPosition.addInPlace(this.ellipsoidOffset);const i=this.getScene().collisionCoordinator;this._collider||(this._collider=i.createCollider()),this._collider._radius=this.ellipsoid,this._collider.collisionMask=this._collisionMask;let s=e;this.applyGravity&&(s=e.add(this.getScene().gravity)),i.getNewPosition(this._oldPosition,s,this._collider,3,null,this._onCollisionPositionChange,this.uniqueId)}_checkInputs(){this._localDirection||(this._localDirection=g.Zero(),this._transformedDirection=g.Zero()),this.inputs.checkInputs(),super._checkInputs()}_decideIfNeedsToMove(){return this._needMoveForGravity||Math.abs(this.cameraDirection.x)>0||Math.abs(this.cameraDirection.y)>0||Math.abs(this.cameraDirection.z)>0}_updatePosition(){this.checkCollisions&&this.getScene().collisionsEnabled?this._collideWithWorld(this.cameraDirection):super._updatePosition()}restoreRoll(e){const t=this._trackRoll,i=this.rotation.z,s=t-i,r=.001;Math.abs(s)>=r&&(this.rotation.z+=s/e,Math.abs(t-this.rotation.z)<=r&&(this.rotation.z=t))}dispose(){this.inputs.clear(),super.dispose()}getClassName(){return"FlyCamera"}}T([Zi()],Bc.prototype,"ellipsoid",void 0);T([Zi()],Bc.prototype,"ellipsoidOffset",void 0);T([R()],Bc.prototype,"checkCollisions",void 0);T([R()],Bc.prototype,"applyGravity",void 0);class z1 extends bc{constructor(e){super(e)}addKeyboard(){return this.add(new Yi),this}addMouseWheel(){return this.add(new Ha),this}addPointers(){return this.add(new Fs),this}addVRDeviceOrientation(){return console.warn("DeviceOrientation support not yet implemented for FollowCamera."),this}}lt.AddNodeConstructor("FollowCamera",(a,e)=>()=>new nr(a,g.Zero(),e));lt.AddNodeConstructor("ArcFollowCamera",(a,e)=>()=>new W1(a,0,0,1,null,e));class nr extends ai{constructor(e,t,i,s=null){super(e,t,i),this.radius=12,this.lowerRadiusLimit=null,this.upperRadiusLimit=null,this.rotationOffset=0,this.lowerRotationOffsetLimit=null,this.upperRotationOffsetLimit=null,this.heightOffset=4,this.lowerHeightOffsetLimit=null,this.upperHeightOffsetLimit=null,this.cameraAcceleration=.05,this.maxCameraSpeed=20,this.lockedTarget=s,this.inputs=new z1(this),this.inputs.addKeyboard().addMouseWheel().addPointers()}_follow(e){if(!e)return;const t=G.Matrix[0];e.absoluteRotationQuaternion.toRotationMatrix(t);const i=Math.atan2(t.m[8],t.m[10]),s=q.ToRadians(this.rotationOffset)+i,r=e.getAbsolutePosition(),n=r.x+Math.sin(s)*this.radius,o=r.z+Math.cos(s)*this.radius,l=n-this.position.x,h=r.y+this.heightOffset-this.position.y,c=o-this.position.z;let u=l*this.cameraAcceleration*2,d=h*this.cameraAcceleration,f=c*this.cameraAcceleration*2;(u>this.maxCameraSpeed||u<-this.maxCameraSpeed)&&(u=u<1?-this.maxCameraSpeed:this.maxCameraSpeed),(d>this.maxCameraSpeed||d<-this.maxCameraSpeed)&&(d=d<1?-this.maxCameraSpeed:this.maxCameraSpeed),(f>this.maxCameraSpeed||f<-this.maxCameraSpeed)&&(f=f<1?-this.maxCameraSpeed:this.maxCameraSpeed),this.position=new g(this.position.x+u,this.position.y+d,this.position.z+f),this.setTarget(r)}attachControl(e,t){t=q.BackCompatCameraNoPreventDefault(arguments),this.inputs.attachElement(t),this._reset=()=>{}}detachControl(){this.inputs.detachElement(),this._reset&&this._reset()}_checkInputs(){this.inputs.checkInputs(),this._checkLimits(),super._checkInputs(),this.lockedTarget&&this._follow(this.lockedTarget)}_checkLimits(){this.lowerRadiusLimit!==null&&this.radius<this.lowerRadiusLimit&&(this.radius=this.lowerRadiusLimit),this.upperRadiusLimit!==null&&this.radius>this.upperRadiusLimit&&(this.radius=this.upperRadiusLimit),this.lowerHeightOffsetLimit!==null&&this.heightOffset<this.lowerHeightOffsetLimit&&(this.heightOffset=this.lowerHeightOffsetLimit),this.upperHeightOffsetLimit!==null&&this.heightOffset>this.upperHeightOffsetLimit&&(this.heightOffset=this.upperHeightOffsetLimit),this.lowerRotationOffsetLimit!==null&&this.rotationOffset<this.lowerRotationOffsetLimit&&(this.rotationOffset=this.lowerRotationOffsetLimit),this.upperRotationOffsetLimit!==null&&this.rotationOffset>this.upperRotationOffsetLimit&&(this.rotationOffset=this.upperRotationOffsetLimit)}getClassName(){return"FollowCamera"}}T([R()],nr.prototype,"radius",void 0);T([R()],nr.prototype,"lowerRadiusLimit",void 0);T([R()],nr.prototype,"upperRadiusLimit",void 0);T([R()],nr.prototype,"rotationOffset",void 0);T([R()],nr.prototype,"lowerRotationOffsetLimit",void 0);T([R()],nr.prototype,"upperRotationOffsetLimit",void 0);T([R()],nr.prototype,"heightOffset",void 0);T([R()],nr.prototype,"lowerHeightOffsetLimit",void 0);T([R()],nr.prototype,"upperHeightOffsetLimit",void 0);T([R()],nr.prototype,"cameraAcceleration",void 0);T([R()],nr.prototype,"maxCameraSpeed",void 0);T([Xl("lockedTargetId")],nr.prototype,"lockedTarget",void 0);class W1 extends ai{constructor(e,t,i,s,r,n){super(e,g.Zero(),n),this.alpha=t,this.beta=i,this.radius=s,this._cartesianCoordinates=g.Zero(),this.setMeshTarget(r)}setMeshTarget(e){this._meshTarget=e,this._follow()}_follow(){if(!this._meshTarget)return;this._cartesianCoordinates.x=this.radius*Math.cos(this.alpha)*Math.cos(this.beta),this._cartesianCoordinates.y=this.radius*Math.sin(this.beta),this._cartesianCoordinates.z=this.radius*Math.sin(this.alpha)*Math.cos(this.beta);const e=this._meshTarget.getAbsolutePosition();this.position=e.add(this._cartesianCoordinates),this.setTarget(e)}_checkInputs(){super._checkInputs(),this._follow()}getClassName(){return"ArcFollowCamera"}}var jr;(function(a){a[a.VIVE=0]="VIVE",a[a.OCULUS=1]="OCULUS",a[a.WINDOWS=2]="WINDOWS",a[a.GEAR_VR=3]="GEAR_VR",a[a.DAYDREAM=4]="DAYDREAM",a[a.GENERIC=5]="GENERIC"})(jr||(jr={}));class Cn{static InitiateController(e){for(const t of this._ControllerFactories)if(t.canCreate(e))return t.create(e);if(this._DefaultControllerFactory)return this._DefaultControllerFactory(e);throw"The type of gamepad you are trying to load needs to be imported first or is not supported."}}Cn._ControllerFactories=[];Cn._DefaultControllerFactory=null;class Ml extends oi{constructor(e){super(e.id,e.index,e),this.isXR=!1,this._deviceRoomPosition=g.Zero(),this._deviceRoomRotationQuaternion=new Q,this.devicePosition=g.Zero(),this.deviceRotationQuaternion=new Q,this.deviceScaleFactor=1,this._trackPosition=!0,this._maxRotationDistFromHeadset=Math.PI/5,this._draggedRoomRotation=0,this._leftHandSystemQuaternion=new Q,this._deviceToWorld=L.Identity(),this._pointingPoseNode=null,this._workingMatrix=L.Identity(),this._meshAttachedObservable=new X,this.type=oi.POSE_ENABLED,this.controllerType=jr.GENERIC,this.position=g.Zero(),this.rotationQuaternion=new Q,this._calculatedPosition=g.Zero(),this._calculatedRotation=new Q,Q.RotationYawPitchRollToRef(Math.PI,0,0,this._leftHandSystemQuaternion)}_disableTrackPosition(e){this._trackPosition&&(this._calculatedPosition.copyFrom(e),this._trackPosition=!1)}update(){super.update(),this._updatePoseAndMesh()}_updatePoseAndMesh(){if(this.isXR)return;const e=this.browserGamepad.pose;if(this.updateFromDevice(e),!this._trackPosition&&ye.LastCreatedScene&&ye.LastCreatedScene.activeCamera&&ye.LastCreatedScene.activeCamera.devicePosition){const t=ye.LastCreatedScene.activeCamera;if(t._computeDevicePosition(),this._deviceToWorld.setTranslation(t.devicePosition),t.deviceRotationQuaternion){t._deviceRoomRotationQuaternion.toEulerAnglesToRef(G.Vector3[0]);const i=Math.atan2(Math.sin(G.Vector3[0].y-this._draggedRoomRotation),Math.cos(G.Vector3[0].y-this._draggedRoomRotation));if(Math.abs(i)>this._maxRotationDistFromHeadset){const s=i-(i<0?-this._maxRotationDistFromHeadset:this._maxRotationDistFromHeadset);this._draggedRoomRotation+=s;const r=Math.sin(-s),n=Math.cos(-s);this._calculatedPosition.x=this._calculatedPosition.x*n-this._calculatedPosition.z*r,this._calculatedPosition.z=this._calculatedPosition.x*r+this._calculatedPosition.z*n}}}g.TransformCoordinatesToRef(this._calculatedPosition,this._deviceToWorld,this.devicePosition),this._deviceToWorld.getRotationMatrixToRef(this._workingMatrix),Q.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this.deviceRotationQuaternion.multiplyInPlace(this._calculatedRotation),this._mesh&&(this._mesh.position.copyFrom(this.devicePosition),this._mesh.rotationQuaternion&&this._mesh.rotationQuaternion.copyFrom(this.deviceRotationQuaternion))}updateFromDevice(e){if(!this.isXR&&e){this.rawPose=e,e.position&&(this._deviceRoomPosition.copyFromFloats(e.position[0],e.position[1],-e.position[2]),this._mesh&&this._mesh.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1),this._trackPosition&&this._deviceRoomPosition.scaleToRef(this.deviceScaleFactor,this._calculatedPosition),this._calculatedPosition.addInPlace(this.position));const t=this.rawPose;e.orientation&&t.orientation&&t.orientation.length===4&&(this._deviceRoomRotationQuaternion.copyFromFloats(t.orientation[0],t.orientation[1],-t.orientation[2],-t.orientation[3]),this._mesh&&(this._mesh.getScene().useRightHandedSystem?(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1):this._deviceRoomRotationQuaternion.multiplyToRef(this._leftHandSystemQuaternion,this._deviceRoomRotationQuaternion)),this._deviceRoomRotationQuaternion.multiplyToRef(this.rotationQuaternion,this._calculatedRotation))}}attachToMesh(e){if(this._mesh&&(this._mesh.parent=null),this._mesh=e,this._poseControlledCamera&&(this._mesh.parent=this._poseControlledCamera),this._mesh.rotationQuaternion||(this._mesh.rotationQuaternion=new Q),!this.isXR&&(this._updatePoseAndMesh(),this._pointingPoseNode)){const t=[];let i=this._pointingPoseNode;for(;i.parent;)t.push(i.parent),i=i.parent;t.reverse().forEach(s=>{s.computeWorldMatrix(!0)})}this._meshAttachedObservable.notifyObservers(e)}attachToPoseControlledCamera(e){this._poseControlledCamera=e,this._mesh&&(this._mesh.parent=this._poseControlledCamera)}dispose(){this._mesh&&this._mesh.dispose(),this._mesh=null,super.dispose()}get mesh(){return this._mesh}getForwardRay(e=100){if(!this.mesh)return new $e(g.Zero(),new g(0,0,1),e);const t=this._pointingPoseNode?this._pointingPoseNode.getWorldMatrix():this.mesh.getWorldMatrix(),i=t.getTranslation(),s=new g(0,0,-1),r=g.TransformNormal(s,t),n=g.Normalize(r);return new $e(i,n,e)}}Ml.POINTING_POSE="POINTING_POSE";var Vs;(function(a){a[a.A=0]="A",a[a.B=1]="B",a[a.X=2]="X",a[a.Y=3]="Y",a[a.LB=4]="LB",a[a.RB=5]="RB",a[a.Back=8]="Back",a[a.Start=9]="Start",a[a.LeftStick=10]="LeftStick",a[a.RightStick=11]="RightStick"})(Vs||(Vs={}));var ho;(function(a){a[a.Up=12]="Up",a[a.Down=13]="Down",a[a.Left=14]="Left",a[a.Right=15]="Right"})(ho||(ho={}));class H1 extends oi{constructor(e,t,i,s=!1){super(e,t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new X,this.onButtonUpObservable=new X,this.onPadDownObservable=new X,this.onPadUpObservable=new X,this._buttonA=0,this._buttonB=0,this._buttonX=0,this._buttonY=0,this._buttonBack=0,this._buttonStart=0,this._buttonLB=0,this._buttonRB=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this._isXboxOnePad=!1,this.type=oi.XBOX,this._isXboxOnePad=s}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonA(){return this._buttonA}set buttonA(e){this._buttonA=this._setButtonValue(e,this._buttonA,Vs.A)}get buttonB(){return this._buttonB}set buttonB(e){this._buttonB=this._setButtonValue(e,this._buttonB,Vs.B)}get buttonX(){return this._buttonX}set buttonX(e){this._buttonX=this._setButtonValue(e,this._buttonX,Vs.X)}get buttonY(){return this._buttonY}set buttonY(e){this._buttonY=this._setButtonValue(e,this._buttonY,Vs.Y)}get buttonStart(){return this._buttonStart}set buttonStart(e){this._buttonStart=this._setButtonValue(e,this._buttonStart,Vs.Start)}get buttonBack(){return this._buttonBack}set buttonBack(e){this._buttonBack=this._setButtonValue(e,this._buttonBack,Vs.Back)}get buttonLB(){return this._buttonLB}set buttonLB(e){this._buttonLB=this._setButtonValue(e,this._buttonLB,Vs.LB)}get buttonRB(){return this._buttonRB}set buttonRB(e){this._buttonRB=this._setButtonValue(e,this._buttonRB,Vs.RB)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,Vs.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,Vs.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,ho.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,ho.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,ho.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,ho.Right)}update(){super.update(),this._isXboxOnePad?(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value):(this.buttonA=this.browserGamepad.buttons[0].value,this.buttonB=this.browserGamepad.buttons[1].value,this.buttonX=this.browserGamepad.buttons[2].value,this.buttonY=this.browserGamepad.buttons[3].value,this.buttonLB=this.browserGamepad.buttons[4].value,this.buttonRB=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonBack=this.browserGamepad.buttons[8].value,this.buttonStart=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value)}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}var ur;(function(a){a[a.Cross=0]="Cross",a[a.Circle=1]="Circle",a[a.Square=2]="Square",a[a.Triangle=3]="Triangle",a[a.L1=4]="L1",a[a.R1=5]="R1",a[a.Share=8]="Share",a[a.Options=9]="Options",a[a.LeftStick=10]="LeftStick",a[a.RightStick=11]="RightStick"})(ur||(ur={}));var co;(function(a){a[a.Up=12]="Up",a[a.Down=13]="Down",a[a.Left=14]="Left",a[a.Right=15]="Right"})(co||(co={}));class X1 extends oi{constructor(e,t,i){super(e.replace("STANDARD GAMEPAD","SONY PLAYSTATION DUALSHOCK"),t,i,0,1,2,3),this._leftTrigger=0,this._rightTrigger=0,this.onButtonDownObservable=new X,this.onButtonUpObservable=new X,this.onPadDownObservable=new X,this.onPadUpObservable=new X,this._buttonCross=0,this._buttonCircle=0,this._buttonSquare=0,this._buttonTriangle=0,this._buttonShare=0,this._buttonOptions=0,this._buttonL1=0,this._buttonR1=0,this._buttonLeftStick=0,this._buttonRightStick=0,this._dPadUp=0,this._dPadDown=0,this._dPadLeft=0,this._dPadRight=0,this.type=oi.DUALSHOCK}onlefttriggerchanged(e){this._onlefttriggerchanged=e}onrighttriggerchanged(e){this._onrighttriggerchanged=e}get leftTrigger(){return this._leftTrigger}set leftTrigger(e){this._onlefttriggerchanged&&this._leftTrigger!==e&&this._onlefttriggerchanged(e),this._leftTrigger=e}get rightTrigger(){return this._rightTrigger}set rightTrigger(e){this._onrighttriggerchanged&&this._rightTrigger!==e&&this._onrighttriggerchanged(e),this._rightTrigger=e}onbuttondown(e){this._onbuttondown=e}onbuttonup(e){this._onbuttonup=e}ondpaddown(e){this._ondpaddown=e}ondpadup(e){this._ondpadup=e}_setButtonValue(e,t,i){return e!==t&&(e===1&&(this._onbuttondown&&this._onbuttondown(i),this.onButtonDownObservable.notifyObservers(i)),e===0&&(this._onbuttonup&&this._onbuttonup(i),this.onButtonUpObservable.notifyObservers(i))),e}_setDPadValue(e,t,i){return e!==t&&(e===1&&(this._ondpaddown&&this._ondpaddown(i),this.onPadDownObservable.notifyObservers(i)),e===0&&(this._ondpadup&&this._ondpadup(i),this.onPadUpObservable.notifyObservers(i))),e}get buttonCross(){return this._buttonCross}set buttonCross(e){this._buttonCross=this._setButtonValue(e,this._buttonCross,ur.Cross)}get buttonCircle(){return this._buttonCircle}set buttonCircle(e){this._buttonCircle=this._setButtonValue(e,this._buttonCircle,ur.Circle)}get buttonSquare(){return this._buttonSquare}set buttonSquare(e){this._buttonSquare=this._setButtonValue(e,this._buttonSquare,ur.Square)}get buttonTriangle(){return this._buttonTriangle}set buttonTriangle(e){this._buttonTriangle=this._setButtonValue(e,this._buttonTriangle,ur.Triangle)}get buttonOptions(){return this._buttonOptions}set buttonOptions(e){this._buttonOptions=this._setButtonValue(e,this._buttonOptions,ur.Options)}get buttonShare(){return this._buttonShare}set buttonShare(e){this._buttonShare=this._setButtonValue(e,this._buttonShare,ur.Share)}get buttonL1(){return this._buttonL1}set buttonL1(e){this._buttonL1=this._setButtonValue(e,this._buttonL1,ur.L1)}get buttonR1(){return this._buttonR1}set buttonR1(e){this._buttonR1=this._setButtonValue(e,this._buttonR1,ur.R1)}get buttonLeftStick(){return this._buttonLeftStick}set buttonLeftStick(e){this._buttonLeftStick=this._setButtonValue(e,this._buttonLeftStick,ur.LeftStick)}get buttonRightStick(){return this._buttonRightStick}set buttonRightStick(e){this._buttonRightStick=this._setButtonValue(e,this._buttonRightStick,ur.RightStick)}get dPadUp(){return this._dPadUp}set dPadUp(e){this._dPadUp=this._setDPadValue(e,this._dPadUp,co.Up)}get dPadDown(){return this._dPadDown}set dPadDown(e){this._dPadDown=this._setDPadValue(e,this._dPadDown,co.Down)}get dPadLeft(){return this._dPadLeft}set dPadLeft(e){this._dPadLeft=this._setDPadValue(e,this._dPadLeft,co.Left)}get dPadRight(){return this._dPadRight}set dPadRight(e){this._dPadRight=this._setDPadValue(e,this._dPadRight,co.Right)}update(){super.update(),this.buttonCross=this.browserGamepad.buttons[0].value,this.buttonCircle=this.browserGamepad.buttons[1].value,this.buttonSquare=this.browserGamepad.buttons[2].value,this.buttonTriangle=this.browserGamepad.buttons[3].value,this.buttonL1=this.browserGamepad.buttons[4].value,this.buttonR1=this.browserGamepad.buttons[5].value,this.leftTrigger=this.browserGamepad.buttons[6].value,this.rightTrigger=this.browserGamepad.buttons[7].value,this.buttonShare=this.browserGamepad.buttons[8].value,this.buttonOptions=this.browserGamepad.buttons[9].value,this.buttonLeftStick=this.browserGamepad.buttons[10].value,this.buttonRightStick=this.browserGamepad.buttons[11].value,this.dPadUp=this.browserGamepad.buttons[12].value,this.dPadDown=this.browserGamepad.buttons[13].value,this.dPadLeft=this.browserGamepad.buttons[14].value,this.dPadRight=this.browserGamepad.buttons[15].value}dispose(){super.dispose(),this.onButtonDownObservable.clear(),this.onButtonUpObservable.clear(),this.onPadDownObservable.clear(),this.onPadUpObservable.clear()}}class Y1{constructor(e){if(this._scene=e,this._babylonGamepads=[],this._oneGamepadConnected=!1,this._isMonitoring=!1,this.onGamepadDisconnectedObservable=new X,Ht()?(this._gamepadEventSupported="GamepadEvent"in window,this._gamepadSupport=navigator&&navigator.getGamepads):this._gamepadEventSupported=!1,this.onGamepadConnectedObservable=new X(t=>{for(const i in this._babylonGamepads){const s=this._babylonGamepads[i];s&&s._isConnected&&this.onGamepadConnectedObservable.notifyObserver(t,s)}}),this._onGamepadConnectedEvent=t=>{const i=t.gamepad;if(i.index in this._babylonGamepads&&this._babylonGamepads[i.index].isConnected)return;let s;this._babylonGamepads[i.index]?(s=this._babylonGamepads[i.index],s.browserGamepad=i,s._isConnected=!0):s=this._addNewGamepad(i),this.onGamepadConnectedObservable.notifyObservers(s),this._startMonitoringGamepads()},this._onGamepadDisconnectedEvent=t=>{const i=t.gamepad;for(const s in this._babylonGamepads)if(this._babylonGamepads[s].index===i.index){const r=this._babylonGamepads[s];r._isConnected=!1,this.onGamepadDisconnectedObservable.notifyObservers(r),r.dispose&&r.dispose();break}},this._gamepadSupport)if(this._updateGamepadObjects(),this._babylonGamepads.length&&this._startMonitoringGamepads(),this._gamepadEventSupported){const t=this._scene?this._scene.getEngine().getHostWindow():window;t&&(t.addEventListener("gamepadconnected",this._onGamepadConnectedEvent,!1),t.addEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent,!1))}else this._startMonitoringGamepads()}get gamepads(){return this._babylonGamepads}getGamepadByType(e=oi.XBOX){for(const t of this._babylonGamepads)if(t&&t.type===e)return t;return null}dispose(){this._gamepadEventSupported&&(this._onGamepadConnectedEvent&&window.removeEventListener("gamepadconnected",this._onGamepadConnectedEvent),this._onGamepadDisconnectedEvent&&window.removeEventListener("gamepaddisconnected",this._onGamepadDisconnectedEvent),this._onGamepadConnectedEvent=null,this._onGamepadDisconnectedEvent=null),this._babylonGamepads.forEach(e=>{e.dispose()}),this.onGamepadConnectedObservable.clear(),this.onGamepadDisconnectedObservable.clear(),this._oneGamepadConnected=!1,this._stopMonitoringGamepads(),this._babylonGamepads=[]}_addNewGamepad(e){this._oneGamepadConnected||(this._oneGamepadConnected=!0);let t;const i=e.id.search("054c")!==-1&&e.id.search("0ce6")===-1,s=e.id.search("Xbox One")!==-1;return s||e.id.search("Xbox 360")!==-1||e.id.search("xinput")!==-1||e.id.search("045e")!==-1&&e.id.search("Surface Dock")===-1?t=new H1(e.id,e.index,e,s):i?t=new X1(e.id,e.index,e):e.pose?t=Cn.InitiateController(e):t=new k1(e.id,e.index,e),this._babylonGamepads[t.index]=t,t}_startMonitoringGamepads(){this._isMonitoring||(this._isMonitoring=!0,this._scene||this._checkGamepadsStatus())}_stopMonitoringGamepads(){this._isMonitoring=!1}_checkGamepadsStatus(){this._updateGamepadObjects();for(const e in this._babylonGamepads){const t=this._babylonGamepads[e];if(!(!t||!t.isConnected))try{t.update()}catch{this._loggedErrors.indexOf(t.index)===-1&&(q.Warn(`Error updating gamepad ${t.id}`),this._loggedErrors.push(t.index))}}this._isMonitoring&&!this._scene&&k.QueueNewFrame(()=>{this._checkGamepadsStatus()})}_updateGamepadObjects(){const e=navigator.getGamepads?navigator.getGamepads():[];for(let t=0;t<e.length;t++){const i=e[t];if(i)if(this._babylonGamepads[i.index])this._babylonGamepads[t].browserGamepad=i,this._babylonGamepads[t].isConnected||(this._babylonGamepads[t]._isConnected=!0,this.onGamepadConnectedObservable.notifyObservers(this._babylonGamepads[t]));else{const s=this._addNewGamepad(i);this.onGamepadConnectedObservable.notifyObservers(s)}}}}Object.defineProperty(ge.prototype,"gamepadManager",{get:function(){if(!this._gamepadManager){this._gamepadManager=new Y1(this);let a=this._getComponent(ue.NAME_GAMEPAD);a||(a=new K1(this),this._addComponent(a))}return this._gamepadManager},enumerable:!0,configurable:!0});Fc.prototype.addGamepad=function(){return this.add(new Lc),this};zd.prototype.addGamepad=function(){return this.add(new Dc),this};class K1{constructor(e){this.name=ue.NAME_GAMEPAD,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(ue.STEP_BEFORECAMERAUPDATE_GAMEPAD,this,this._beforeCameraUpdate)}rebuild(){}dispose(){const e=this.scene._gamepadManager;e&&(e.dispose(),this.scene._gamepadManager=null)}_beforeCameraUpdate(){const e=this.scene._gamepadManager;e&&e._isMonitoring&&e._checkGamepadsStatus()}}lt.AddNodeConstructor("FreeCamera",(a,e)=>()=>new Wo(a,g.Zero(),e));class Wo extends W_{get gamepadAngularSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadAngularSensibility:0}set gamepadAngularSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadAngularSensibility=e)}get gamepadMoveSensibility(){const e=this.inputs.attached.gamepad;return e?e.gamepadMoveSensibility:0}set gamepadMoveSensibility(e){const t=this.inputs.attached.gamepad;t&&(t.gamepadMoveSensibility=e)}constructor(e,t,i){super(e,t,i),this.inputs.addGamepad()}getClassName(){return"UniversalCamera"}}be._CreateDefaultParsedCamera=(a,e)=>new Wo(a,g.Zero(),e);lt.AddNodeConstructor("GamepadCamera",(a,e)=>()=>new Yd(a,g.Zero(),e));class Yd extends Wo{constructor(e,t,i){super(e,t,i)}getClassName(){return"GamepadCamera"}}const $1="anaglyphPixelShader",j1=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D leftSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 leftFrag=texture2D(leftSampler,vUV);
leftFrag=vec4(1.0,leftFrag.g,leftFrag.b,1.0);
vec4 rightFrag=texture2D(textureSampler,vUV);
rightFrag=vec4(rightFrag.r,1.0,1.0,1.0);
gl_FragColor=vec4(rightFrag.rgb*leftFrag.rgb,1.0);
}`;Y.ShadersStore[$1]=j1;class H_ extends Fe{constructor(e,t,i,s,r,n){super(e,"anaglyph",null,["leftSampler"],t,i[1],s,r,n),this._passedProcess=i[0]._rigPostProcess,this.onApplyObservable.add(o=>{o.setTextureFromPostProcess("leftSampler",this._passedProcess)})}getClassName(){return"AnaglyphPostProcess"}}he("BABYLON.AnaglyphPostProcess",H_);function Uc(a){a._rigCameras[0]._rigPostProcess=new Sn(a.name+"_passthru",1,a._rigCameras[0]),a._rigCameras[1]._rigPostProcess=new H_(a.name+"_anaglyph",1,a._rigCameras)}lt.AddNodeConstructor("AnaglyphArcRotateCamera",(a,e,t)=>()=>new q1(a,0,0,1,g.Zero(),t.interaxial_distance,e));class q1 extends yt{constructor(e,t,i,s,r,n,o){super(e,t,i,s,r,o),this._setRigMode=Uc.bind(null,this),this.interaxialDistance=n,this.setCameraRigMode(be.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:n})}getClassName(){return"AnaglyphArcRotateCamera"}}lt.AddNodeConstructor("AnaglyphFreeCamera",(a,e,t)=>()=>new Q1(a,g.Zero(),t.interaxial_distance,e));class Q1 extends ws{constructor(e,t,i,s){super(e,t,s),this._setRigMode=Uc.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(be.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphFreeCamera"}}lt.AddNodeConstructor("AnaglyphGamepadCamera",(a,e,t)=>()=>new Z1(a,g.Zero(),t.interaxial_distance,e));class Z1 extends Yd{constructor(e,t,i,s){super(e,t,s),this._setRigMode=Uc.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(be.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphGamepadCamera"}}lt.AddNodeConstructor("AnaglyphUniversalCamera",(a,e,t)=>()=>new J1(a,g.Zero(),t.interaxial_distance,e));class J1 extends Wo{constructor(e,t,i,s){super(e,t,s),this._setRigMode=Uc.bind(null,this),this.interaxialDistance=i,this.setCameraRigMode(be.RIG_MODE_STEREOSCOPIC_ANAGLYPH,{interaxialDistance:i})}getClassName(){return"AnaglyphUniversalCamera"}}const eT="stereoscopicInterlacePixelShader",tT=`const vec3 TWO=vec3(2.0,2.0,2.0);
varying vec2 vUV;
uniform sampler2D camASampler;
uniform sampler2D textureSampler;
uniform vec2 stepSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
bool useCamA;
bool useCamB;
vec2 texCoord1;
vec2 texCoord2;
vec3 frag1;
vec3 frag2;
#ifdef IS_STEREOSCOPIC_HORIZ
useCamB=vUV.x>0.5;
useCamA=!useCamB;
texCoord1=vec2(useCamB ? (vUV.x-0.5)*2.0 : vUV.x*2.0,vUV.y);
texCoord2=vec2(texCoord1.x+stepSize.x,vUV.y);
#else
#ifdef IS_STEREOSCOPIC_INTERLACED
float rowNum=floor(vUV.y/stepSize.y);
useCamA=mod(rowNum,2.0)==1.0;
useCamB=mod(rowNum,2.0)==0.0;
texCoord1=vec2(vUV.x,vUV.y);
texCoord2=vec2(vUV.x,vUV.y);
#else
useCamB=vUV.y>0.5;
useCamA=!useCamB;
texCoord1=vec2(vUV.x,useCamB ? (vUV.y-0.5)*2.0 : vUV.y*2.0);
texCoord2=vec2(vUV.x,texCoord1.y+stepSize.y);
#endif
#endif
if (useCamB){
frag1=texture2D(textureSampler,texCoord1).rgb;
frag2=texture2D(textureSampler,texCoord2).rgb;
}else if (useCamA){
frag1=texture2D(camASampler ,texCoord1).rgb;
frag2=texture2D(camASampler ,texCoord2).rgb;
}else {
discard;
}
gl_FragColor=vec4((frag1+frag2)/TWO,1.0);
}
`;Y.ShadersStore[eT]=tT;class iT extends Fe{constructor(e,t,i,s,r,n,o){super(e,"stereoscopicInterlace",["stepSize"],["camASampler"],1,t[1],r,n,o,s?"#define IS_STEREOSCOPIC_INTERLACED 1":i?"#define IS_STEREOSCOPIC_HORIZ 1":void 0),this._passedProcess=t[0]._rigPostProcess,this._stepSize=new le(1/this.width,1/this.height),this.onSizeChangedObservable.add(()=>{this._stepSize=new le(1/this.width,1/this.height)}),this.onApplyObservable.add(l=>{l.setTextureFromPostProcess("camASampler",this._passedProcess),l.setFloat2("stepSize",this._stepSize.x,this._stepSize.y)})}getClassName(){return"StereoscopicInterlacePostProcessI"}}function Vc(a){const e=a.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL||a.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED,t=a.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_CROSSEYED;a.cameraRigMode===be.RIG_MODE_STEREOSCOPIC_INTERLACED?(a._rigCameras[0]._rigPostProcess=new Sn(a.name+"_passthru",1,a._rigCameras[0]),a._rigCameras[1]._rigPostProcess=new iT(a.name+"_stereoInterlace",a._rigCameras,!1,!0)):(a._rigCameras[t?1:0].viewport=new Es(0,0,e?.5:1,e?1:.5),a._rigCameras[t?0:1].viewport=new Es(e?.5:0,e?0:.5,e?.5:1,e?1:.5))}lt.AddNodeConstructor("StereoscopicArcRotateCamera",(a,e,t)=>()=>new sT(a,0,0,1,g.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class sT extends yt{constructor(e,t,i,s,r,n,o,l){super(e,t,i,s,r,l),this._setRigMode=Vc.bind(null,this),this.interaxialDistance=n,this.isStereoscopicSideBySide=o,this.setCameraRigMode(o?be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:be.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:n})}getClassName(){return"StereoscopicArcRotateCamera"}}lt.AddNodeConstructor("StereoscopicFreeCamera",(a,e,t)=>()=>new rT(a,g.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class rT extends ws{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=Vc.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:be.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicFreeCamera"}}lt.AddNodeConstructor("StereoscopicGamepadCamera",(a,e,t)=>()=>new nT(a,g.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class nT extends Yd{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=Vc.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:be.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicGamepadCamera"}}lt.AddNodeConstructor("StereoscopicFreeCamera",(a,e,t)=>()=>new aT(a,g.Zero(),t.interaxial_distance,t.isStereoscopicSideBySide,e));class aT extends Wo{constructor(e,t,i,s,r){super(e,t,r),this._setRigMode=Vc.bind(null,this),this.interaxialDistance=i,this.isStereoscopicSideBySide=s,this.setCameraRigMode(s?be.RIG_MODE_STEREOSCOPIC_SIDEBYSIDE_PARALLEL:be.RIG_MODE_STEREOSCOPIC_OVERUNDER,{interaxialDistance:i})}getClassName(){return"StereoscopicUniversalCamera"}}lt.AddNodeConstructor("VirtualJoysticksCamera",(a,e)=>()=>new oT(a,g.Zero(),e));class oT extends ws{constructor(e,t,i){super(e,t,i),this.inputs.addVirtualJoystick()}getClassName(){return"VirtualJoysticksCamera"}}class Xa{constructor(){this.compensateDistortion=!0,this.multiviewEnabled=!1}get aspectRatio(){return this.hResolution/(2*this.vResolution)}get aspectRatioFov(){return 2*Math.atan(this.postProcessScaleFactor*this.vScreenSize/(2*this.eyeToScreenDistance))}get leftHMatrix(){const e=this.hScreenSize/4-this.lensSeparationDistance/2,t=4*e/this.hScreenSize;return L.Translation(t,0,0)}get rightHMatrix(){const e=this.hScreenSize/4-this.lensSeparationDistance/2,t=4*e/this.hScreenSize;return L.Translation(-t,0,0)}get leftPreViewMatrix(){return L.Translation(.5*this.interpupillaryDistance,0,0)}get rightPreViewMatrix(){return L.Translation(-.5*this.interpupillaryDistance,0,0)}static GetDefault(){const e=new Xa;return e.hResolution=1280,e.vResolution=800,e.hScreenSize=.149759993,e.vScreenSize=.0935999975,e.vScreenCenter=.0467999987,e.eyeToScreenDistance=.0410000011,e.lensSeparationDistance=.063500002,e.interpupillaryDistance=.064000003,e.distortionK=[1,.219999999,.239999995,0],e.chromaAbCorrection=[.995999992,-.00400000019,1.01400006,0],e.postProcessScaleFactor=1.714605507808412,e.lensCenterOffset=.151976421,e}}const lT="vrDistortionCorrectionPixelShader",hT=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 LensCenter;
uniform vec2 Scale;
uniform vec2 ScaleIn;
uniform vec4 HmdWarpParam;
vec2 HmdWarp(vec2 in01) {
vec2 theta=(in01-LensCenter)*ScaleIn; 
float rSq=theta.x*theta.x+theta.y*theta.y;
vec2 rvector=theta*(HmdWarpParam.x+HmdWarpParam.y*rSq+HmdWarpParam.z*rSq*rSq+HmdWarpParam.w*rSq*rSq*rSq);
return LensCenter+Scale*rvector;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 tc=HmdWarp(vUV);
if (tc.x <0.0 || tc.x>1.0 || tc.y<0.0 || tc.y>1.0)
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
else{
gl_FragColor=texture2D(textureSampler,tc);
}
}`;Y.ShadersStore[lT]=hT;class Pf extends Fe{constructor(e,t,i,s){super(e,"vrDistortionCorrection",["LensCenter","Scale","ScaleIn","HmdWarpParam"],null,s.postProcessScaleFactor,t,H.BILINEAR_SAMPLINGMODE),this._isRightEye=i,this._distortionFactors=s.distortionK,this._postProcessScaleFactor=s.postProcessScaleFactor,this._lensCenterOffset=s.lensCenterOffset,this.adaptScaleToCurrentViewport=!0,this.onSizeChangedObservable.add(()=>{this._scaleIn=new le(2,2/this.aspectRatio),this._scaleFactor=new le(.5*(1/this._postProcessScaleFactor),.5*(1/this._postProcessScaleFactor)*this.aspectRatio),this._lensCenter=new le(this._isRightEye?.5-this._lensCenterOffset*.5:.5+this._lensCenterOffset*.5,.5)}),this.onApplyObservable.add(r=>{r.setFloat2("LensCenter",this._lensCenter.x,this._lensCenter.y),r.setFloat2("Scale",this._scaleFactor.x,this._scaleFactor.y),r.setFloat2("ScaleIn",this._scaleIn.x,this._scaleIn.y),r.setFloat4("HmdWarpParam",this._distortionFactors[0],this._distortionFactors[1],this._distortionFactors[2],this._distortionFactors[3])})}getClassName(){return"VRDistortionCorrectionPostProcess"}}const cT="vrMultiviewToSingleviewPixelShader",uT=`precision mediump sampler2DArray;
varying vec2 vUV;
uniform sampler2DArray multiviewSampler;
uniform int imageIndex;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(multiviewSampler,vec3(vUV,imageIndex));
}`;Y.ShadersStore[cT]=uT;class rd extends si{set samples(e){this._samples=e}constructor(e,t=512){super("multiview rtt",t,e,!1,!0,0,!1,void 0,!1,!1,!0,void 0,!0),this._renderTarget=this.getScene().getEngine().createMultiviewRenderTargetTexture(this.getRenderWidth(),this.getRenderHeight()),this._texture=this._renderTarget.texture,this._texture.isMultiview=!0,this._texture.format=5,this.samples=this._getEngine().getCaps().maxSamples||this.samples,this._texture.samples=this._samples}_bindFrameBuffer(){!this._renderTarget||this.getScene().getEngine().bindMultiviewFramebuffer(this._renderTarget)}getViewCount(){return 2}}k.prototype.createMultiviewRenderTargetTexture=function(a,e){const t=this._gl;if(!this.getCaps().multiview)throw"Multiview is not supported";const i=this._createHardwareRenderTargetWrapper(!1,!1,{width:a,height:e});i._framebuffer=t.createFramebuffer();const s=new gt(this,We.Unknown,!0);return s.width=a,s.height=e,s.isMultiview=!0,i._colorTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._colorTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.RGBA8,a,e,2),i._depthStencilTextureArray=t.createTexture(),t.bindTexture(t.TEXTURE_2D_ARRAY,i._depthStencilTextureArray),t.texStorage3D(t.TEXTURE_2D_ARRAY,1,t.DEPTH24_STENCIL8,a,e,2),s.isReady=!0,i.setTextures(s),i._depthStencilTexture=s,i};k.prototype.bindMultiviewFramebuffer=function(a){const e=a,t=this._gl,i=this.getCaps().oculusMultiview||this.getCaps().multiview;if(this.bindFramebuffer(e,void 0,void 0,void 0,!0),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer),e._colorTextureArray&&e._depthStencilTextureArray)this.getCaps().oculusMultiview?(i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,e.samples,0,2),i.framebufferTextureMultisampleMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,e.samples,0,2)):(i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.COLOR_ATTACHMENT0,e._colorTextureArray,0,0,2),i.framebufferTextureMultiviewOVR(t.DRAW_FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,e._depthStencilTextureArray,0,0,2));else throw"Invalid multiview frame buffer"};be.prototype._useMultiviewToSingleView=!1;be.prototype._multiviewTexture=null;be.prototype._resizeOrCreateMultiviewTexture=function(a,e){this._multiviewTexture?(this._multiviewTexture.getRenderWidth()!=a||this._multiviewTexture.getRenderHeight()!=e)&&(this._multiviewTexture.dispose(),this._multiviewTexture=new rd(this.getScene(),{width:a,height:e})):this._multiviewTexture=new rd(this.getScene(),{width:a,height:e})};function X_(a,e){const t=new Pe(a,void 0,!0,e);return t.addUniform("viewProjection",16),t.addUniform("viewProjectionR",16),t.addUniform("view",16),t.addUniform("projection",16),t.addUniform("vEyePosition",4),t}const dT=ge.prototype.createSceneUniformBuffer;ge.prototype._transformMatrixR=L.Zero();ge.prototype._multiviewSceneUbo=null;ge.prototype._createMultiviewUbo=function(){this._multiviewSceneUbo=X_(this.getEngine(),"scene_multiview")};ge.prototype.createSceneUniformBuffer=function(a){return this._multiviewSceneUbo?X_(this.getEngine(),a):dT.bind(this)(a)};ge.prototype._updateMultiviewUbo=function(a,e){a&&e&&a.multiplyToRef(e,this._transformMatrixR),a&&e&&(a.multiplyToRef(e,G.Matrix[0]),$s.GetRightPlaneToRef(G.Matrix[0],this._frustumPlanes[3])),this._multiviewSceneUbo&&(this._multiviewSceneUbo.updateMatrix("viewProjection",this.getTransformMatrix()),this._multiviewSceneUbo.updateMatrix("viewProjectionR",this._transformMatrixR),this._multiviewSceneUbo.updateMatrix("view",this._viewMatrix),this._multiviewSceneUbo.updateMatrix("projection",this._projectionMatrix))};ge.prototype._renderMultiviewToSingleView=function(a){a._resizeOrCreateMultiviewTexture(a._rigPostProcess&&a._rigPostProcess&&a._rigPostProcess.width>0?a._rigPostProcess.width:this.getEngine().getRenderWidth(!0),a._rigPostProcess&&a._rigPostProcess&&a._rigPostProcess.height>0?a._rigPostProcess.height:this.getEngine().getRenderHeight(!0)),this._multiviewSceneUbo||this._createMultiviewUbo(),a.outputRenderTarget=a._multiviewTexture,this._renderForCamera(a),a.outputRenderTarget=null;for(let e=0;e<a._rigCameras.length;e++){const t=this.getEngine();this._activeCamera=a._rigCameras[e],t.setViewport(this._activeCamera.viewport),this.postProcessManager&&(this.postProcessManager._prepareFrame(),this.postProcessManager._finalizeFrame(this._activeCamera.isIntermediate))}};class Y_ extends Fe{getClassName(){return"VRMultiviewToSingleviewPostProcess"}constructor(e,t,i){super(e,"vrMultiviewToSingleview",["imageIndex"],["multiviewSampler"],i,t,H.BILINEAR_SAMPLINGMODE);const s=t!=null?t:this.getCamera();this.onSizeChangedObservable.add(()=>{}),this.onApplyObservable.add(r=>{s._scene.activeCamera&&s._scene.activeCamera.isLeftCamera?r.setInt("imageIndex",0):r.setInt("imageIndex",1),r.setTexture("multiviewSampler",s._multiviewTexture)})}}function Kd(a,e){const t=e.vrCameraMetrics||Xa.GetDefault();a._rigCameras[0]._cameraRigParams.vrMetrics=t,a._rigCameras[0].viewport=new Es(0,0,.5,1),a._rigCameras[0]._cameraRigParams.vrWorkMatrix=new L,a._rigCameras[0]._cameraRigParams.vrHMatrix=t.leftHMatrix,a._rigCameras[0]._cameraRigParams.vrPreViewMatrix=t.leftPreViewMatrix,a._rigCameras[0].getProjectionMatrix=a._rigCameras[0]._getVRProjectionMatrix,a._rigCameras[1]._cameraRigParams.vrMetrics=t,a._rigCameras[1].viewport=new Es(.5,0,.5,1),a._rigCameras[1]._cameraRigParams.vrWorkMatrix=new L,a._rigCameras[1]._cameraRigParams.vrHMatrix=t.rightHMatrix,a._rigCameras[1]._cameraRigParams.vrPreViewMatrix=t.rightPreViewMatrix,a._rigCameras[1].getProjectionMatrix=a._rigCameras[1]._getVRProjectionMatrix,t.multiviewEnabled&&(a.getScene().getEngine().getCaps().multiview?(a._useMultiviewToSingleView=!0,a._rigPostProcess=new Y_("VRMultiviewToSingleview",a,t.postProcessScaleFactor)):(B.Warn("Multiview is not supported, falling back to standard rendering"),t.multiviewEnabled=!1)),t.compensateDistortion&&(a._rigCameras[0]._rigPostProcess=new Pf("VR_Distort_Compensation_Left",a._rigCameras[0],!1,t),a._rigCameras[1]._rigPostProcess=new Pf("VR_Distort_Compensation_Right",a._rigCameras[1],!0,t))}lt.AddNodeConstructor("VRDeviceOrientationArcRotateCamera",(a,e)=>()=>new fT(a,0,0,1,g.Zero(),e));class fT extends yt{constructor(e,t,i,s,r,n,o=!0,l=Xa.GetDefault()){super(e,t,i,s,r,n),this._setRigMode=Kd.bind(null,this),l.compensateDistortion=o,this.setCameraRigMode(be.RIG_MODE_VR,{vrCameraMetrics:l}),this.inputs.addVRDeviceOrientation()}getClassName(){return"VRDeviceOrientationArcRotateCamera"}}lt.AddNodeConstructor("VRDeviceOrientationFreeCamera",(a,e)=>()=>new $d(a,g.Zero(),e));class $d extends Xd{constructor(e,t,i,s=!0,r=Xa.GetDefault()){super(e,t,i),this._setRigMode=Kd.bind(null,this),r.compensateDistortion=s,this.setCameraRigMode(be.RIG_MODE_VR,{vrCameraMetrics:r})}getClassName(){return"VRDeviceOrientationFreeCamera"}}lt.AddNodeConstructor("VRDeviceOrientationGamepadCamera",(a,e)=>()=>new pT(a,g.Zero(),e));class pT extends $d{constructor(e,t,i,s=!0,r=Xa.GetDefault()){super(e,t,i,s,r),this._setRigMode=Kd.bind(null,this),this.inputs.addGamepad()}getClassName(){return"VRDeviceOrientationGamepadCamera"}}lt.AddNodeConstructor("Light_Type_3",(a,e)=>()=>new ea(a,g.Zero(),e));class ea extends je{constructor(e,t,i){super(e,i),this.groundColor=new re(0,0,0),this.direction=t||g.Up()}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightGround",3),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}getClassName(){return"HemisphericLight"}setDirectionToTarget(e){return this.direction=g.Normalize(e.subtract(g.Zero())),this.direction}getShadowGenerator(){return null}transferToEffect(e,t){const i=g.Normalize(this.direction);return this._uniformBuffer.updateFloat4("vLightData",i.x,i.y,i.z,0,t),this._uniformBuffer.updateColor3("vLightGround",this.groundColor.scale(this.intensity),t),this}transferToNodeMaterialEffect(e,t){const i=g.Normalize(this.direction);return e.setFloat3(t,i.x,i.y,i.z),this}computeWorldMatrix(){return this._worldMatrix||(this._worldMatrix=L.Identity()),this._worldMatrix}getTypeID(){return je.LIGHTTYPEID_HEMISPHERICLIGHT}prepareLightSpecificDefines(e,t){e["HEMILIGHT"+t]=!0}}T([pi()],ea.prototype,"groundColor",void 0);T([Zi()],ea.prototype,"direction",void 0);function _T(a,e){if(e.vrDisplay){const t=e.vrDisplay.getEyeParameters("left"),i=e.vrDisplay.getEyeParameters("right");a._rigCameras[0].viewport=new Es(0,0,.5,1),a._rigCameras[0].setCameraRigParameter("left",!0),a._rigCameras[0].setCameraRigParameter("specs",e.specs),a._rigCameras[0].setCameraRigParameter("eyeParameters",t),a._rigCameras[0].setCameraRigParameter("frameData",e.frameData),a._rigCameras[0].setCameraRigParameter("parentCamera",e.parentCamera),a._rigCameras[0]._cameraRigParams.vrWorkMatrix=new L,a._rigCameras[0].getProjectionMatrix=a._getWebVRProjectionMatrix,a._rigCameras[0].parent=a,a._rigCameras[0]._getViewMatrix=a._getWebVRViewMatrix,a._rigCameras[1].viewport=new Es(.5,0,.5,1),a._rigCameras[1].setCameraRigParameter("eyeParameters",i),a._rigCameras[1].setCameraRigParameter("specs",e.specs),a._rigCameras[1].setCameraRigParameter("frameData",e.frameData),a._rigCameras[1].setCameraRigParameter("parentCamera",e.parentCamera),a._rigCameras[1]._cameraRigParams.vrWorkMatrix=new L,a._rigCameras[1].getProjectionMatrix=a._getWebVRProjectionMatrix,a._rigCameras[1].parent=a,a._rigCameras[1]._getViewMatrix=a._getWebVRViewMatrix}}Object.defineProperty(k.prototype,"isInVRExclusivePointerMode",{get:function(){return this._vrExclusivePointerMode},enumerable:!0,configurable:!0});k.prototype._prepareVRComponent=function(){this._vrSupported=!1,this._vrExclusivePointerMode=!1,this.onVRDisplayChangedObservable=new X,this.onVRRequestPresentComplete=new X,this.onVRRequestPresentStart=new X};k.prototype.isVRDevicePresent=function(){return!!this._vrDisplay};k.prototype.getVRDevice=function(){return this._vrDisplay};k.prototype.initWebVR=function(){return this.initWebVRAsync(),this.onVRDisplayChangedObservable};k.prototype.initWebVRAsync=function(){const a=()=>{const e={vrDisplay:this._vrDisplay,vrSupported:this._vrSupported};this.onVRDisplayChangedObservable.notifyObservers(e),this._webVRInitPromise=new Promise(t=>{t(e)})};if(!this._onVrDisplayConnect){this._onVrDisplayConnect=t=>{this._vrDisplay=t.display,a()},this._onVrDisplayDisconnect=()=>{this._vrDisplay.cancelAnimationFrame(this._frameHandler),this._vrDisplay=void 0,this._frameHandler=k.QueueNewFrame(this._boundRenderFunction),a()},this._onVrDisplayPresentChange=()=>{this._vrExclusivePointerMode=this._vrDisplay&&this._vrDisplay.isPresenting};const e=this.getHostWindow();e&&(e.addEventListener("vrdisplayconnect",this._onVrDisplayConnect),e.addEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),e.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange))}return this._webVRInitPromise=this._webVRInitPromise||this._getVRDisplaysAsync(),this._webVRInitPromise.then(a),this._webVRInitPromise};k.prototype._getVRDisplaysAsync=function(){return new Promise(a=>{navigator.getVRDisplays?navigator.getVRDisplays().then(e=>{this._vrSupported=!0,this._vrDisplay=e[0],a({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported})}):(this._vrDisplay=void 0,this._vrSupported=!1,a({vrDisplay:this._vrDisplay,vrSupported:this._vrSupported}))})};k.prototype.enableVR=function(a){if(this._vrDisplay&&!this._vrDisplay.isPresenting){const e=()=>{this.onVRRequestPresentComplete.notifyObservers(!0),this._onVRFullScreenTriggered()},t=()=>{this.onVRRequestPresentComplete.notifyObservers(!1)};this.onVRRequestPresentStart.notifyObservers(this);const i={highRefreshRate:this.vrPresentationAttributes?this.vrPresentationAttributes.highRefreshRate:!1,foveationLevel:this.vrPresentationAttributes?this.vrPresentationAttributes.foveationLevel:1,multiview:(this.getCaps().multiview||this.getCaps().oculusMultiview)&&a.useMultiview};this._vrDisplay.requestPresent([{source:this.getRenderingCanvas(),attributes:i,...i}]).then(e).catch(t)}};k.prototype._onVRFullScreenTriggered=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting){this._oldSize=new js(this.getRenderWidth(),this.getRenderHeight()),this._oldHardwareScaleFactor=this.getHardwareScalingLevel();const a=this._vrDisplay.getEyeParameters("left");this.setHardwareScalingLevel(1),this.setSize(a.renderWidth*2,a.renderHeight)}else this.setHardwareScalingLevel(this._oldHardwareScaleFactor),this.setSize(this._oldSize.width,this._oldSize.height)};k.prototype.disableVR=function(){this._vrDisplay&&this._vrDisplay.isPresenting&&this._vrDisplay.exitPresent().then(()=>this._onVRFullScreenTriggered()).catch(()=>this._onVRFullScreenTriggered()),Ht()&&(window.removeEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted),window.removeEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted),this._onVrDisplayConnect&&(window.removeEventListener("vrdisplayconnect",this._onVrDisplayConnect),this._onVrDisplayDisconnect&&window.removeEventListener("vrdisplaydisconnect",this._onVrDisplayDisconnect),this._onVrDisplayPresentChange&&window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChange),this._onVrDisplayConnect=null,this._onVrDisplayDisconnect=null))};k.prototype._connectVREvents=function(a,e){if(this._onVRDisplayPointerRestricted=()=>{a&&a.requestPointerLock()},this._onVRDisplayPointerUnrestricted=()=>{if(!e){const t=this.getHostWindow();t.document&&t.document.exitPointerLock&&t.document.exitPointerLock();return}!e.exitPointerLock||e.exitPointerLock()},Ht()){const t=this.getHostWindow();t.addEventListener("vrdisplaypointerrestricted",this._onVRDisplayPointerRestricted,!1),t.addEventListener("vrdisplaypointerunrestricted",this._onVRDisplayPointerUnrestricted,!1)}};k.prototype._submitVRFrame=function(){if(this._vrDisplay&&this._vrDisplay.isPresenting)try{this._vrDisplay.submitFrame()}catch(a){q.Warn("webVR submitFrame has had an unexpected failure: "+a)}};k.prototype.isVRPresenting=function(){return this._vrDisplay&&this._vrDisplay.isPresenting};k.prototype._requestVRFrame=function(){this._frameHandler=k.QueueNewFrame(this._boundRenderFunction,this._vrDisplay)};lt.AddNodeConstructor("WebVRFreeCamera",(a,e)=>()=>new jd(a,g.Zero(),e));lt.AddNodeConstructor("WebVRGamepadCamera",(a,e)=>()=>new jd(a,g.Zero(),e));class jd extends ws{constructor(e,t,i,s={}){super(e,t,i),this._webVROptions=s,this._vrDevice=null,this.rawPose=null,this._specsVersion="1.1",this._attached=!1,this._descendants=[],this._deviceRoomPosition=g.Zero(),this._deviceRoomRotationQuaternion=Q.Identity(),this._standingMatrix=null,this.devicePosition=g.Zero(),this.deviceRotationQuaternion=Q.Identity(),this.deviceScaleFactor=1,this._deviceToWorld=L.Identity(),this._worldToDevice=L.Identity(),this.controllers=[],this.onControllersAttachedObservable=new X,this.onControllerMeshLoadedObservable=new X,this.onPoseUpdatedFromDeviceObservable=new X,this._poseSet=!1,this.rigParenting=!0,this._defaultHeight=void 0,this._setRigMode=_T.bind(null,this),this._detachIfAttached=()=>{const n=this.getEngine().getVRDevice();n&&!n.isPresenting&&this.detachControl()},this._workingVector=g.Zero(),this._oneVector=g.One(),this._workingMatrix=L.Identity(),this._tmpMatrix=new L,this._cache.position=g.Zero(),s.defaultHeight&&(this._defaultHeight=s.defaultHeight,this.position.y=this._defaultHeight),this.minZ=.1,arguments.length===5&&(this._webVROptions=arguments[4]),this._webVROptions.trackPosition==null&&(this._webVROptions.trackPosition=!0),this._webVROptions.controllerMeshes==null&&(this._webVROptions.controllerMeshes=!0),this._webVROptions.defaultLightingOnControllers==null&&(this._webVROptions.defaultLightingOnControllers=!0),this.rotationQuaternion=new Q,this._webVROptions&&this._webVROptions.positionScale&&(this.deviceScaleFactor=this._webVROptions.positionScale);const r=this.getEngine();this._onVREnabled=n=>{n&&this.initControllers()},r.onVRRequestPresentComplete.add(this._onVREnabled),r.initWebVR().add(n=>{!n.vrDisplay||this._vrDevice===n.vrDisplay||(this._vrDevice=n.vrDisplay,this.setCameraRigMode(be.RIG_MODE_WEBVR,{parentCamera:this,vrDisplay:this._vrDevice,frameData:this._frameData,specs:this._specsVersion}),this._attached&&this.getEngine().enableVR(this._webVROptions))}),typeof VRFrameData<"u"&&(this._frameData=new VRFrameData),s.useMultiview&&(this.getScene().getEngine().getCaps().multiview?(this._useMultiviewToSingleView=!0,this._rigPostProcess=new Y_("VRMultiviewToSingleview",this,1)):(B.Warn("Multiview is not supported, falling back to standard rendering"),this._useMultiviewToSingleView=!1)),this.getScene().onBeforeCameraRenderObservable.add(n=>{n.parent===this&&this.rigParenting&&(this._descendants=this.getDescendants(!0,o=>{const l=this.controllers.some(c=>c._mesh===o),h=this._rigCameras.indexOf(o)!==-1;return!l&&!h}),this._descendants.forEach(o=>{o.parent=n}))}),this.getScene().onAfterCameraRenderObservable.add(n=>{n.parent===this&&this.rigParenting&&this._descendants.forEach(o=>{o.parent=this})})}deviceDistanceToRoomGround(){return this._standingMatrix?(this._standingMatrix.getTranslationToRef(this._workingVector),this._deviceRoomPosition.y+this._workingVector.y):this._defaultHeight||0}useStandingMatrix(e=t=>{}){this.getEngine().initWebVRAsync().then(t=>{!t.vrDisplay||!t.vrDisplay.stageParameters||!t.vrDisplay.stageParameters.sittingToStandingTransform||!this._webVROptions.trackPosition?e(!1):(this._standingMatrix=new L,L.FromFloat32ArrayToRefScaled(t.vrDisplay.stageParameters.sittingToStandingTransform,0,1,this._standingMatrix),this.getScene().useRightHandedSystem||this._standingMatrix&&this._standingMatrix.toggleModelMatrixHandInPlace(),e(!0))})}useStandingMatrixAsync(){return new Promise(e=>{this.useStandingMatrix(t=>{e(t)})})}dispose(){this._detachIfAttached(),this.getEngine().onVRRequestPresentComplete.removeCallback(this._onVREnabled),this._updateCacheWhenTrackingDisabledObserver&&this._scene.onBeforeRenderObservable.remove(this._updateCacheWhenTrackingDisabledObserver),super.dispose()}getControllerByName(e){for(const t of this.controllers)if(t.hand===e)return t;return null}get leftController(){return this._leftController||(this._leftController=this.getControllerByName("left")),this._leftController}get rightController(){return this._rightController||(this._rightController=this.getControllerByName("right")),this._rightController}getForwardRay(e=100){return this.leftCamera?super.getForwardRay(e,this.leftCamera.getWorldMatrix(),this.leftCamera.globalPosition):super.getForwardRay(e)}_checkInputs(){this._vrDevice&&this._vrDevice.isPresenting&&(this._vrDevice.getFrameData(this._frameData),this.updateFromDevice(this._frameData.pose)),super._checkInputs()}updateFromDevice(e){e&&e.orientation&&e.orientation.length===4&&(this.rawPose=e,this._deviceRoomRotationQuaternion.copyFromFloats(e.orientation[0],e.orientation[1],-e.orientation[2],-e.orientation[3]),this.getScene().useRightHandedSystem&&(this._deviceRoomRotationQuaternion.z*=-1,this._deviceRoomRotationQuaternion.w*=-1),this._webVROptions.trackPosition&&this.rawPose.position&&(this._deviceRoomPosition.copyFromFloats(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2]),this.getScene().useRightHandedSystem&&(this._deviceRoomPosition.z*=-1)),this._poseSet=!0)}attachControl(e){e=q.BackCompatCameraNoPreventDefault(arguments),super.attachControl(e),this._attached=!0,e=be.ForceAttachControlToAlwaysPreventDefault?!1:e,this._vrDevice&&this.getEngine().enableVR(this._webVROptions);const t=this._scene.getEngine().getHostWindow();t&&t.addEventListener("vrdisplaypresentchange",this._detachIfAttached)}detachControl(){this.getScene().gamepadManager.onGamepadConnectedObservable.remove(this._onGamepadConnectedObserver),this.getScene().gamepadManager.onGamepadDisconnectedObservable.remove(this._onGamepadDisconnectedObserver),super.detachControl(),this._attached=!1,this.getEngine().disableVR(),window.removeEventListener("vrdisplaypresentchange",this._detachIfAttached)}getClassName(){return"WebVRFreeCamera"}resetToCurrentRotation(){this._vrDevice.resetPose()}_updateRigCameras(){const e=this._rigCameras[0],t=this._rigCameras[1];e.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),t.rotationQuaternion.copyFrom(this._deviceRoomRotationQuaternion),e.position.copyFrom(this._deviceRoomPosition),t.position.copyFrom(this._deviceRoomPosition)}_correctPositionIfNotTrackPosition(e,t=!1){this.rawPose&&this.rawPose.position&&!this._webVROptions.trackPosition&&(L.TranslationToRef(this.rawPose.position[0],this.rawPose.position[1],-this.rawPose.position[2],this._tmpMatrix),t||this._tmpMatrix.invert(),this._tmpMatrix.multiplyToRef(e,e))}_updateCache(e){(!this.rotationQuaternion.equals(this._cache.rotationQuaternion)||!this.position.equals(this._cache.position))&&(this._updateCacheCalled||(this._updateCacheCalled=!0,this.update()),this.rotationQuaternion.toRotationMatrix(this._workingMatrix),g.TransformCoordinatesToRef(this._deviceRoomPosition,this._workingMatrix,this._workingVector),this.devicePosition.subtractToRef(this._workingVector,this._workingVector),L.ComposeToRef(this._oneVector,this.rotationQuaternion,this._workingVector,this._deviceToWorld),this._deviceToWorld.getTranslationToRef(this._workingVector),this._workingVector.addInPlace(this.position),this._workingVector.subtractInPlace(this._cache.position),this._deviceToWorld.setTranslation(this._workingVector),this._deviceToWorld.invertToRef(this._worldToDevice),this.controllers.forEach(t=>{t._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(t._deviceToWorld),t.update()})),e||super._updateCache(),this._updateCacheCalled=!1}_computeDevicePosition(){g.TransformCoordinatesToRef(this._deviceRoomPosition,this._deviceToWorld,this.devicePosition)}update(){this._computeDevicePosition(),L.FromQuaternionToRef(this._deviceRoomRotationQuaternion,this._workingMatrix),this._workingMatrix.multiplyToRef(this._deviceToWorld,this._workingMatrix),Q.FromRotationMatrixToRef(this._workingMatrix,this.deviceRotationQuaternion),this._poseSet&&this.onPoseUpdatedFromDeviceObservable.notifyObservers(null),super.update()}_getViewMatrix(){return L.Identity()}_getWebVRViewMatrix(){const e=this._cameraRigParams.parentCamera;e._updateCache();const t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftViewMatrix:this._cameraRigParams.frameData.rightViewMatrix;return L.FromArrayToRef(t,0,this._webvrViewMatrix),this.getScene().useRightHandedSystem||this._webvrViewMatrix.toggleModelMatrixHandInPlace(),this._webvrViewMatrix.getRotationMatrixToRef(this._cameraRotationMatrix),g.TransformCoordinatesToRef(this._referencePoint,this._cameraRotationMatrix,this._transformedReferencePoint),this.position.addToRef(this._transformedReferencePoint,this._currentTarget),e.deviceScaleFactor!==1&&(this._webvrViewMatrix.invert(),e.deviceScaleFactor&&(this._webvrViewMatrix.multiplyAtIndex(12,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(13,e.deviceScaleFactor),this._webvrViewMatrix.multiplyAtIndex(14,e.deviceScaleFactor)),this._webvrViewMatrix.invert()),e._correctPositionIfNotTrackPosition(this._webvrViewMatrix,!0),e._worldToDevice.multiplyToRef(this._webvrViewMatrix,this._webvrViewMatrix),this._workingMatrix=this._workingMatrix||L.Identity(),this._webvrViewMatrix.invertToRef(this._workingMatrix),this._workingMatrix.multiplyToRef(e.getWorldMatrix(),this._workingMatrix),this._workingMatrix.getTranslationToRef(this._globalPosition),this._markSyncedWithParent(),this._webvrViewMatrix}_getWebVRProjectionMatrix(){const e=this.parent;e._vrDevice.depthNear=e.minZ,e._vrDevice.depthFar=e.maxZ;const t=this._cameraRigParams.left?this._cameraRigParams.frameData.leftProjectionMatrix:this._cameraRigParams.frameData.rightProjectionMatrix;return L.FromArrayToRef(t,0,this._projectionMatrix),this.getScene().useRightHandedSystem||this._projectionMatrix.toggleProjectionMatrixHandInPlace(),this._projectionMatrix}initControllers(){this.controllers.length=0;const e=this.getScene().gamepadManager;this._onGamepadDisconnectedObserver=e.onGamepadDisconnectedObservable.add(t=>{if(t.type===oi.POSE_ENABLED){const i=t;i.defaultModel&&i.defaultModel.setEnabled(!1),i.hand==="right"&&(this._rightController=null),i.hand==="left"&&(this._leftController=null);const s=this.controllers.indexOf(i);s!==-1&&this.controllers.splice(s,1)}}),this._onGamepadConnectedObserver=e.onGamepadConnectedObservable.add(t=>{if(t.type===oi.POSE_ENABLED){const i=t;if(this._webVROptions.trackPosition||(i._disableTrackPosition(new g(i.hand=="left"?-.15:.15,-.5,.25)),this._updateCacheWhenTrackingDisabledObserver||(this._updateCacheWhenTrackingDisabledObserver=this._scene.onBeforeRenderObservable.add(()=>{this._updateCache()}))),i.deviceScaleFactor=this.deviceScaleFactor,i._deviceToWorld.copyFrom(this._deviceToWorld),this._correctPositionIfNotTrackPosition(i._deviceToWorld),this._webVROptions.controllerMeshes&&(i.defaultModel?i.defaultModel.setEnabled(!0):i.initControllerMesh(this.getScene(),s=>{if(s.scaling.scaleInPlace(this.deviceScaleFactor),this.onControllerMeshLoadedObservable.notifyObservers(i),this._webVROptions.defaultLightingOnControllers){this._lightOnControllers||(this._lightOnControllers=new ea("vrControllersLight",new g(0,1,0),this.getScene()));const r=function(n,o){const l=n.getChildren();l&&l.length!==0&&l.forEach(h=>{o.includedOnlyMeshes.push(h),r(h,o)})};this._lightOnControllers.includedOnlyMeshes.push(s),r(s,this._lightOnControllers)}})),i.attachToPoseControlledCamera(this),this.controllers.indexOf(i)===-1){this.controllers.push(i);let s=!1;for(let r=0;r<this.controllers.length;r++)this.controllers[r].controllerType===jr.VIVE&&(s?this.controllers[r].hand="right":(s=!0,this.controllers[r].hand="left"));this.controllers.length>=2&&this.onControllersAttachedObservable.notifyObservers(this.controllers)}}})}}class Ya extends Ml{constructor(e){super(e),this.onTriggerStateChangedObservable=new X,this.onMainButtonStateChangedObservable=new X,this.onSecondaryButtonStateChangedObservable=new X,this.onPadStateChangedObservable=new X,this.onPadValuesChangedObservable=new X,this.pad={x:0,y:0},this._changes={pressChanged:!1,touchChanged:!1,valueChanged:!1,changed:!1},this._buttons=new Array(e.buttons.length),this.hand=e.hand}onButtonStateChange(e){this._onButtonStateChange=e}get defaultModel(){return this._defaultModel}update(){super.update();for(let e=0;e<this._buttons.length;e++)this._setButtonValue(this.browserGamepad.buttons[e],this._buttons[e],e);(this.leftStick.x!==this.pad.x||this.leftStick.y!==this.pad.y)&&(this.pad.x=this.leftStick.x,this.pad.y=this.leftStick.y,this.onPadValuesChangedObservable.notifyObservers(this.pad))}_setButtonValue(e,t,i){if(e||(e={pressed:!1,touched:!1,value:0}),!t){this._buttons[i]={pressed:e.pressed,touched:e.touched,value:e.value};return}this._checkChanges(e,t),this._changes.changed&&(this._onButtonStateChange&&this._onButtonStateChange(this.index,i,e),this._handleButtonChange(i,e,this._changes)),this._buttons[i].pressed=e.pressed,this._buttons[i].touched=e.touched,this._buttons[i].value=e.value<1e-8?0:e.value}_checkChanges(e,t){return this._changes.pressChanged=e.pressed!==t.pressed,this._changes.touchChanged=e.touched!==t.touched,this._changes.valueChanged=e.value!==t.value,this._changes.changed=this._changes.pressChanged||this._changes.touchChanged||this._changes.valueChanged,this._changes}dispose(){super.dispose(),this._defaultModel=null,this.onTriggerStateChangedObservable.clear(),this.onMainButtonStateChangedObservable.clear(),this.onSecondaryButtonStateChangedObservable.clear(),this.onPadStateChangedObservable.clear(),this.onPadValuesChangedObservable.clear()}}class Zh{constructor(){this.previousWorldMatrices={},this.previousBones={}}static AddUniforms(e){e.push("previousWorld","previousViewProjection","mPreviousBones")}static AddSamplers(e){}bindForSubMesh(e,t,i,s,r){if(t.prePassRenderer&&t.prePassRenderer.enabled&&t.prePassRenderer.currentRTisSceneRT&&t.prePassRenderer.getIndex(2)!==-1){this.previousWorldMatrices[i.uniqueId]||(this.previousWorldMatrices[i.uniqueId]=s.clone()),this.previousViewProjection||(this.previousViewProjection=t.getTransformMatrix().clone(),this.currentViewProjection=t.getTransformMatrix().clone());const n=t.getEngine();this.currentViewProjection.updateFlag!==t.getTransformMatrix().updateFlag?(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection),this.currentViewProjection.copyFrom(t.getTransformMatrix())):this._lastUpdateFrameId!==n.frameId&&(this._lastUpdateFrameId=n.frameId,this.previousViewProjection.copyFrom(this.currentViewProjection)),e.setMatrix("previousWorld",this.previousWorldMatrices[i.uniqueId]),e.setMatrix("previousViewProjection",this.previousViewProjection),this.previousWorldMatrices[i.uniqueId]=s.clone()}}}class ce{static get DiffuseTextureEnabled(){return this._DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){this._DiffuseTextureEnabled!==e&&(this._DiffuseTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get DetailTextureEnabled(){return this._DetailTextureEnabled}static set DetailTextureEnabled(e){this._DetailTextureEnabled!==e&&(this._DetailTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get AmbientTextureEnabled(){return this._AmbientTextureEnabled}static set AmbientTextureEnabled(e){this._AmbientTextureEnabled!==e&&(this._AmbientTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get OpacityTextureEnabled(){return this._OpacityTextureEnabled}static set OpacityTextureEnabled(e){this._OpacityTextureEnabled!==e&&(this._OpacityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ReflectionTextureEnabled(){return this._ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){this._ReflectionTextureEnabled!==e&&(this._ReflectionTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get EmissiveTextureEnabled(){return this._EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){this._EmissiveTextureEnabled!==e&&(this._EmissiveTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get SpecularTextureEnabled(){return this._SpecularTextureEnabled}static set SpecularTextureEnabled(e){this._SpecularTextureEnabled!==e&&(this._SpecularTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get BumpTextureEnabled(){return this._BumpTextureEnabled}static set BumpTextureEnabled(e){this._BumpTextureEnabled!==e&&(this._BumpTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get LightmapTextureEnabled(){return this._LightmapTextureEnabled}static set LightmapTextureEnabled(e){this._LightmapTextureEnabled!==e&&(this._LightmapTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get RefractionTextureEnabled(){return this._RefractionTextureEnabled}static set RefractionTextureEnabled(e){this._RefractionTextureEnabled!==e&&(this._RefractionTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ColorGradingTextureEnabled(){return this._ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){this._ColorGradingTextureEnabled!==e&&(this._ColorGradingTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get FresnelEnabled(){return this._FresnelEnabled}static set FresnelEnabled(e){this._FresnelEnabled!==e&&(this._FresnelEnabled=e,k.MarkAllMaterialsAsDirty(4))}static get ClearCoatTextureEnabled(){return this._ClearCoatTextureEnabled}static set ClearCoatTextureEnabled(e){this._ClearCoatTextureEnabled!==e&&(this._ClearCoatTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ClearCoatBumpTextureEnabled(){return this._ClearCoatBumpTextureEnabled}static set ClearCoatBumpTextureEnabled(e){this._ClearCoatBumpTextureEnabled!==e&&(this._ClearCoatBumpTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ClearCoatTintTextureEnabled(){return this._ClearCoatTintTextureEnabled}static set ClearCoatTintTextureEnabled(e){this._ClearCoatTintTextureEnabled!==e&&(this._ClearCoatTintTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get SheenTextureEnabled(){return this._SheenTextureEnabled}static set SheenTextureEnabled(e){this._SheenTextureEnabled!==e&&(this._SheenTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get AnisotropicTextureEnabled(){return this._AnisotropicTextureEnabled}static set AnisotropicTextureEnabled(e){this._AnisotropicTextureEnabled!==e&&(this._AnisotropicTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get ThicknessTextureEnabled(){return this._ThicknessTextureEnabled}static set ThicknessTextureEnabled(e){this._ThicknessTextureEnabled!==e&&(this._ThicknessTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get RefractionIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set RefractionIntensityTextureEnabled(e){this._RefractionIntensityTextureEnabled!==e&&(this._RefractionIntensityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get TranslucencyIntensityTextureEnabled(){return this._ThicknessTextureEnabled}static set TranslucencyIntensityTextureEnabled(e){this._TranslucencyIntensityTextureEnabled!==e&&(this._TranslucencyIntensityTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}static get IridescenceTextureEnabled(){return this._IridescenceTextureEnabled}static set IridescenceTextureEnabled(e){this._IridescenceTextureEnabled!==e&&(this._IridescenceTextureEnabled=e,k.MarkAllMaterialsAsDirty(1))}}ce._DiffuseTextureEnabled=!0;ce._DetailTextureEnabled=!0;ce._AmbientTextureEnabled=!0;ce._OpacityTextureEnabled=!0;ce._ReflectionTextureEnabled=!0;ce._EmissiveTextureEnabled=!0;ce._SpecularTextureEnabled=!0;ce._BumpTextureEnabled=!0;ce._LightmapTextureEnabled=!0;ce._RefractionTextureEnabled=!0;ce._ColorGradingTextureEnabled=!0;ce._FresnelEnabled=!0;ce._ClearCoatTextureEnabled=!0;ce._ClearCoatBumpTextureEnabled=!0;ce._ClearCoatTintTextureEnabled=!0;ce._SheenTextureEnabled=!0;ce._AnisotropicTextureEnabled=!0;ce._ThicknessTextureEnabled=!0;ce._RefractionIntensityTextureEnabled=!0;ce._TranslucencyIntensityTextureEnabled=!0;ce._IridescenceTextureEnabled=!0;const mT="defaultFragmentDeclaration",gT=`uniform vec4 vEyePosition;
uniform vec4 vDiffuseColor;
#ifdef SPECULARTERM
uniform vec4 vSpecularColor;
#endif
uniform vec3 vEmissiveColor;
uniform vec3 vAmbientColor;
uniform float visibility;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY 
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef ALPHATEST
uniform float alphaCutOff;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFRACTION
uniform vec4 vRefractionInfos;
#ifndef REFRACTIONMAP_3D
uniform mat4 refractionMatrix;
#endif
#ifdef REFRACTIONFRESNEL
uniform vec4 refractionLeftColor;
uniform vec4 refractionRightColor;
#endif
#if defined(USE_LOCAL_REFRACTIONMAP_CUBIC) && defined(REFRACTIONMAP_3D)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
#endif
#ifdef DIFFUSEFRESNEL
uniform vec4 diffuseLeftColor;
uniform vec4 diffuseRightColor;
#endif
#ifdef OPACITYFRESNEL
uniform vec4 opacityParts;
#endif
#ifdef EMISSIVEFRESNEL
uniform vec4 emissiveLeftColor;
uniform vec4 emissiveRightColor;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#if defined(REFLECTIONMAP_PLANAR) || defined(REFLECTIONMAP_CUBIC) || defined(REFLECTIONMAP_PROJECTION) || defined(REFLECTIONMAP_EQUIRECTANGULAR) || defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_SKYBOX)
uniform mat4 reflectionMatrix;
#endif
#ifndef REFLECTIONMAP_SKYBOX
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 reflectionLeftColor;
uniform vec4 reflectionRightColor;
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;Y.IncludesShadersStore[mT]=gT;const vT="sceneUboDeclaration",xT=`layout(std140,column_major) uniform;
uniform Scene {
mat4 viewProjection;
#ifdef MULTIVIEW
mat4 viewProjectionR;
#endif 
mat4 view;
mat4 projection;
vec4 vEyePosition;
};
`;Y.IncludesShadersStore[vT]=xT;const TT="meshUboDeclaration",bT=`#ifdef WEBGL2
uniform mat4 world;
uniform float visibility;
#else
layout(std140,column_major) uniform;
uniform Mesh
{
mat4 world;
float visibility;
};
#endif
#define WORLD_UBO
`;Y.IncludesShadersStore[TT]=bT;const ST="defaultUboDeclaration",ET=`layout(std140,column_major) uniform;
uniform Material
{
vec4 diffuseLeftColor;
vec4 diffuseRightColor;
vec4 opacityParts;
vec4 reflectionLeftColor;
vec4 reflectionRightColor;
vec4 refractionLeftColor;
vec4 refractionRightColor;
vec4 emissiveLeftColor;
vec4 emissiveRightColor;
vec2 vDiffuseInfos;
vec2 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vReflectionInfos;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec2 vSpecularInfos;
vec3 vBumpInfos;
mat4 diffuseMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 reflectionMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 specularMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
float pointSize;
float alphaCutOff;
mat4 refractionMatrix;
vec4 vRefractionInfos;
vec3 vRefractionPosition;
vec3 vRefractionSize;
vec4 vSpecularColor;
vec3 vEmissiveColor;
vec4 vDiffuseColor;
vec3 vAmbientColor;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Y.IncludesShadersStore[ST]=ET;const CT="prePassDeclaration",yT=`#ifdef PREPASS
#extension GL_EXT_draw_buffers : require
layout(location=0) out highp vec4 glFragData[{X}];highp vec4 gl_FragColor;
#ifdef PREPASS_DEPTH
varying highp vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
varying highp vec4 vCurrentPosition;varying highp vec4 vPreviousPosition;
#endif
#endif
`;Y.IncludesShadersStore[CT]=yT;const AT="oitDeclaration",RT=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
#extension GL_EXT_draw_buffers : require
layout(location=0) out vec2 depth; 
layout(location=1) out vec4 frontColor;
layout(location=2) out vec4 backColor;
#define MAX_DEPTH 99999.0
highp vec4 gl_FragColor;
uniform sampler2D oitDepthSampler;
uniform sampler2D oitFrontColorSampler;
#endif
`;Y.IncludesShadersStore[AT]=RT;const IT="mainUVVaryingDeclaration",PT=`#ifdef MAINUV{X}
varying vec2 vMainUV{X};
#endif
`;Y.IncludesShadersStore[IT]=PT;const MT="helperFunctions",DT=`const float PI=3.1415926535897932384626433832795;
const float HALF_MIN=5.96046448e-08; 
const float LinearEncodePowerApprox=2.2;
const float GammaEncodePowerApprox=1.0/LinearEncodePowerApprox;
const vec3 LuminanceEncodeApprox=vec3(0.2126,0.7152,0.0722);
const float Epsilon=0.0000001;
#define saturate(x) clamp(x,0.0,1.0)
#define absEps(x) abs(x)+Epsilon
#define maxEps(x) max(x,Epsilon)
#define saturateEps(x) clamp(x,Epsilon,1.0)
mat3 transposeMat3(mat3 inMatrix) {
vec3 i0=inMatrix[0];
vec3 i1=inMatrix[1];
vec3 i2=inMatrix[2];
mat3 outMatrix=mat3(
vec3(i0.x,i1.x,i2.x),
vec3(i0.y,i1.y,i2.y),
vec3(i0.z,i1.z,i2.z)
);
return outMatrix;
}
mat3 inverseMat3(mat3 inMatrix) {
float a00=inMatrix[0][0],a01=inMatrix[0][1],a02=inMatrix[0][2];
float a10=inMatrix[1][0],a11=inMatrix[1][1],a12=inMatrix[1][2];
float a20=inMatrix[2][0],a21=inMatrix[2][1],a22=inMatrix[2][2];
float b01=a22*a11-a12*a21;
float b11=-a22*a10+a12*a20;
float b21=a21*a10-a11*a20;
float det=a00*b01+a01*b11+a02*b21;
return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),
b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),
b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;
}
#if USE_EXACT_SRGB_CONVERSIONS
vec3 toLinearSpaceExact(vec3 color)
{
vec3 nearZeroSection=0.0773993808*color;
vec3 remainingSection=pow(0.947867299*(color+vec3(0.055)),vec3(2.4));
#if defined(WEBGL2) || defined(WEBGPU)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.04045)));
#else
return
vec3(
color.r<=0.04045 ? nearZeroSection.r : remainingSection.r,
color.g<=0.04045 ? nearZeroSection.g : remainingSection.g,
color.b<=0.04045 ? nearZeroSection.b : remainingSection.b);
#endif
}
vec3 toGammaSpaceExact(vec3 color)
{
vec3 nearZeroSection=12.92*color;
vec3 remainingSection=1.055*pow(color,vec3(0.41666))-vec3(0.055);
#if defined(WEBGL2) || defined(WEBGPU)
return mix(remainingSection,nearZeroSection,lessThanEqual(color,vec3(0.0031308)));
#else
return
vec3(
color.r<=0.0031308 ? nearZeroSection.r : remainingSection.r,
color.g<=0.0031308 ? nearZeroSection.g : remainingSection.g,
color.b<=0.0031308 ? nearZeroSection.b : remainingSection.b);
#endif
}
#endif
float toLinearSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=0.0773993808*color;
float remainingSection=pow(0.947867299*(color+0.055),2.4);
return color<=0.04045 ? nearZeroSection : remainingSection;
#else
return pow(color,LinearEncodePowerApprox);
#endif
}
vec3 toLinearSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toLinearSpaceExact(color);
#else
return pow(color,vec3(LinearEncodePowerApprox));
#endif
}
vec4 toLinearSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toLinearSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(LinearEncodePowerApprox)),color.a);
#endif
}
float toGammaSpace(float color)
{
#if USE_EXACT_SRGB_CONVERSIONS
float nearZeroSection=12.92*color;
float remainingSection=1.055*pow(color,0.41666)-0.055;
return color<=0.0031308 ? nearZeroSection : remainingSection;
#else
return pow(color,GammaEncodePowerApprox);
#endif
}
vec3 toGammaSpace(vec3 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return toGammaSpaceExact(color);
#else
return pow(color,vec3(GammaEncodePowerApprox));
#endif
}
vec4 toGammaSpace(vec4 color)
{
#if USE_EXACT_SRGB_CONVERSIONS
return vec4(toGammaSpaceExact(color.rgb),color.a);
#else
return vec4(pow(color.rgb,vec3(GammaEncodePowerApprox)),color.a);
#endif
}
float square(float value)
{
return value*value;
}
vec3 square(vec3 value)
{
return value*value;
}
float pow5(float value) {
float sq=value*value;
return sq*sq*value;
}
float getLuminance(vec3 color)
{
return clamp(dot(color,LuminanceEncodeApprox),0.,1.);
}
float getRand(vec2 seed) {
return fract(sin(dot(seed.xy ,vec2(12.9898,78.233)))*43758.5453);
}
float dither(vec2 seed,float varianceAmount) {
float rand=getRand(seed);
float normVariance=varianceAmount/255.0;
float dither=mix(-normVariance,normVariance,rand);
return dither;
}
const float rgbdMaxRange=255.0;
vec4 toRGBD(vec3 color) {
float maxRGB=maxEps(max(color.r,max(color.g,color.b)));
float D =max(rgbdMaxRange/maxRGB,1.);
D =clamp(floor(D)/255.0,0.,1.);
vec3 rgb=color.rgb*D;
rgb=toGammaSpace(rgb);
return vec4(clamp(rgb,0.,1.),D); 
}
vec3 fromRGBD(vec4 rgbd) {
rgbd.rgb=toLinearSpace(rgbd.rgb);
return rgbd.rgb/rgbd.a;
}
vec3 parallaxCorrectNormal( vec3 vertexPos,vec3 origVec,vec3 cubeSize,vec3 cubePos ) {
vec3 invOrigVec=vec3(1.0,1.0,1.0)/origVec;
vec3 halfSize=cubeSize*0.5;
vec3 intersecAtMaxPlane=(cubePos+halfSize-vertexPos)*invOrigVec;
vec3 intersecAtMinPlane=(cubePos-halfSize-vertexPos)*invOrigVec;
vec3 largestIntersec=max(intersecAtMaxPlane,intersecAtMinPlane);
float distance=min(min(largestIntersec.x,largestIntersec.y),largestIntersec.z);
vec3 intersectPositionWS=vertexPos+origVec*distance;
return intersectPositionWS-cubePos;
}
`;Y.IncludesShadersStore[MT]=DT;const OT="lightFragmentDeclaration",wT=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X};
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#endif
`;Y.IncludesShadersStore[OT]=wT;const NT="lightUboDeclaration",FT=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef PROJECTEDLIGHTTEXTURE{X}
uniform mat4 textureProjectionMatrix{X};
uniform sampler2D projectionLightSampler{X};
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float viewFrustumZ{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float frustumLengths{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float cascadeBlendFactor{X};
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
uniform highp sampler2DArray depthSampler{X};
uniform vec2 lightSizeUVCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float depthCorrection{X}[SHADOWCSMNUM_CASCADES{X}];
uniform float penumbraDarkness{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DArrayShadow shadowSampler{X};
#else
uniform highp sampler2DArray shadowSampler{X};
#endif
#ifdef SHADOWCSMDEBUG{X}
const vec3 vCascadeColorsMultiplier{X}[8]=vec3[8]
(
vec3 ( 1.5,0.0,0.0 ),
vec3 ( 0.0,1.5,0.0 ),
vec3 ( 0.0,0.0,5.5 ),
vec3 ( 1.5,0.0,5.5 ),
vec3 ( 1.5,1.5,0.0 ),
vec3 ( 1.0,1.0,1.0 ),
vec3 ( 0.0,1.0,5.5 ),
vec3 ( 0.5,3.5,0.75 )
);
vec3 shadowDebug{X};
#endif
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
int index{X}=-1;
#else
int index{X}=SHADOWCSMNUM_CASCADES{X}-1;
#endif
float diff{X}=0.;
#elif defined(SHADOWCUBE{X})
uniform samplerCube shadowSampler{X}; 
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
#if defined(SHADOWPCSS{X})
uniform highp sampler2DShadow shadowSampler{X};
uniform highp sampler2D depthSampler{X};
#elif defined(SHADOWPCF{X})
uniform highp sampler2DShadow shadowSampler{X};
#else
uniform sampler2D shadowSampler{X};
#endif
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;Y.IncludesShadersStore[NT]=FT;const LT="lightsFragmentFunctions",BT=`struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef NDOTL
float ndl;
#endif
};
lightingInfo computeLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 lightVectorW;
float attenuation=1.0;
if (lightData.w==0.)
{
vec3 direction=lightData.xyz-vPositionW;
attenuation=max(0.,1.0-length(direction)/range);
lightVectorW=normalize(direction);
}
else
{
lightVectorW=normalize(-lightData.xyz);
}
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
lightingInfo computeSpotLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec4 lightDirection,vec3 diffuseColor,vec3 specularColor,float range,float glossiness) {
lightingInfo result;
vec3 direction=lightData.xyz-vPositionW;
vec3 lightVectorW=normalize(direction);
float attenuation=max(0.,1.0-length(direction)/range);
float cosAngle=max(0.,dot(lightDirection.xyz,-lightVectorW));
if (cosAngle>=lightDirection.w)
{
cosAngle=max(0.,pow(cosAngle,lightData.w));
attenuation*=cosAngle;
float ndl=max(0.,dot(vNormal,lightVectorW));
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=ndl*diffuseColor*attenuation;
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightVectorW);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor*attenuation;
#endif
return result;
}
result.diffuse=vec3(0.);
#ifdef SPECULARTERM
result.specular=vec3(0.);
#endif
#ifdef NDOTL
result.ndl=0.;
#endif
return result;
}
lightingInfo computeHemisphericLighting(vec3 viewDirectionW,vec3 vNormal,vec4 lightData,vec3 diffuseColor,vec3 specularColor,vec3 groundColor,float glossiness) {
lightingInfo result;
float ndl=dot(vNormal,lightData.xyz)*0.5+0.5;
#ifdef NDOTL
result.ndl=ndl;
#endif
result.diffuse=mix(groundColor,diffuseColor,ndl);
#ifdef SPECULARTERM
vec3 angleW=normalize(viewDirectionW+lightData.xyz);
float specComp=max(0.,dot(vNormal,angleW));
specComp=pow(specComp,max(1.,glossiness));
result.specular=specComp*specularColor;
#endif
return result;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return textureColor;
}`;Y.IncludesShadersStore[LT]=BT;const UT="shadowsFragmentFunctions",VT=`#ifdef SHADOWS
#ifndef SHADOWFLOAT
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}
#endif
float computeFallOff(float value,vec2 clipSpace,float frustumEdgeFalloff)
{
float mask=smoothstep(1.0-frustumEdgeFalloff,1.00000012,clamp(dot(clipSpace,clipSpace),0.,1.));
return mix(value,1.0,mask);
}
#define inline
float computeShadowCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadow=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadow=textureCube(shadowSampler,directionToLight).x;
#endif
return depth>shadow ? darkness : 1.0;
}
#define inline
float computeShadowWithPoissonSamplingCube(vec3 lightPosition,samplerCube shadowSampler,float mapSize,float darkness,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
depth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
float visibility=1.;
vec3 poissonDisk[4];
poissonDisk[0]=vec3(-1.0,1.0,-1.0);
poissonDisk[1]=vec3(1.0,-1.0,-1.0);
poissonDisk[2]=vec3(-1.0,-1.0,-1.0);
poissonDisk[3]=vec3(1.0,-1.0,1.0);
#ifndef SHADOWFLOAT
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize))<depth) visibility-=0.25;
if (unpack(textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize))<depth) visibility-=0.25;
#else
if (textureCube(shadowSampler,directionToLight+poissonDisk[0]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[1]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[2]*mapSize).x<depth) visibility-=0.25;
if (textureCube(shadowSampler,directionToLight+poissonDisk[3]*mapSize).x<depth) visibility-=0.25;
#endif
return min(1.0,visibility+darkness);
}
#define inline
float computeShadowWithESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness); 
return esm;
}
#define inline
float computeShadowWithCloseESMCube(vec3 lightPosition,samplerCube shadowSampler,float darkness,float depthScale,vec2 depthValues)
{
vec3 directionToLight=vPositionW-lightPosition;
float depth=length(directionToLight);
depth=(depth+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depth,0.,1.0);
directionToLight=normalize(directionToLight);
directionToLight.y=-directionToLight.y;
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(textureCube(shadowSampler,directionToLight));
#else
float shadowMapSample=textureCube(shadowSampler,directionToLight).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return esm;
}
#if defined(WEBGL2) || defined(WEBGPU)
#define inline
float computeShadowCSM(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
vec3 uvLayer=vec3(uv.x,uv.y,layer);
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uvLayer));
#else
float shadow=texture2D(shadowSampler,uvLayer).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
#endif
#define inline
float computeShadow(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadow=unpack(texture2D(shadowSampler,uv));
#else
float shadow=texture2D(shadowSampler,uv).x;
#endif
return shadowPixelDepth>shadow ? computeFallOff(darkness,clipSpace.xy,frustumEdgeFalloff) : 1.;
}
}
#define inline
float computeShadowWithPoissonSampling(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float mapSize,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
float visibility=1.;
vec2 poissonDisk[4];
poissonDisk[0]=vec2(-0.94201624,-0.39906216);
poissonDisk[1]=vec2(0.94558609,-0.76890725);
poissonDisk[2]=vec2(-0.094184101,-0.92938870);
poissonDisk[3]=vec2(0.34495938,0.29387760);
#ifndef SHADOWFLOAT
if (unpack(texture2D(shadowSampler,uv+poissonDisk[0]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[1]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[2]*mapSize))<shadowPixelDepth) visibility-=0.25;
if (unpack(texture2D(shadowSampler,uv+poissonDisk[3]*mapSize))<shadowPixelDepth) visibility-=0.25;
#else
if (texture2D(shadowSampler,uv+poissonDisk[0]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[1]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[2]*mapSize).x<shadowPixelDepth) visibility-=0.25;
if (texture2D(shadowSampler,uv+poissonDisk[3]*mapSize).x<shadowPixelDepth) visibility-=0.25;
#endif
return computeFallOff(min(1.0,visibility+darkness),clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0);
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(texture2D(shadowSampler,uv));
#else
float shadowMapSample=texture2D(shadowSampler,uv).x;
#endif
float esm=1.0-clamp(exp(min(87.,depthScale*shadowPixelDepth))*shadowMapSample,0.,1.-darkness);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithCloseESM(vec4 vPositionFromLight,float depthMetric,sampler2D shadowSampler,float darkness,float depthScale,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec2 uv=0.5*clipSpace.xy+vec2(0.5);
if (uv.x<0. || uv.x>1.0 || uv.y<0. || uv.y>1.0)
{
return 1.0;
}
else
{
float shadowPixelDepth=clamp(depthMetric,0.,1.0); 
#ifndef SHADOWFLOAT
float shadowMapSample=unpack(texture2D(shadowSampler,uv));
#else
float shadowMapSample=texture2D(shadowSampler,uv).x;
#endif
float esm=clamp(exp(min(87.,-depthScale*(shadowPixelDepth-shadowMapSample))),darkness,1.);
return computeFallOff(esm,clipSpace.xy,frustumEdgeFalloff);
}
}
#ifdef IS_NDC_HALF_ZRANGE
#define ZINCLIP clipSpace.z
#else
#define ZINCLIP uvDepth.z
#endif
#if defined(WEBGL2) || defined(WEBGPU)
#define GREATEST_LESS_THAN_ONE 0.99999994
#define inline
float computeShadowWithCSMPCF1(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float shadow=texture2D(shadowSampler,uvDepthLayer);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF3(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithCSMPCF5(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArrayShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[0]),layer,uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[0]),layer,uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[0]),layer,uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[1]),layer,uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[1]),layer,uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[1]),layer,uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[0],v[2]),layer,uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[1],v[2]),layer,uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec4(base_uv.xy+vec2(u[2],v[2]),layer,uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
#define inline
float computeShadowWithPCF1(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float shadow=texture2D(shadowSampler,uvDepth);
shadow=mix(darkness,1.,shadow);
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF3(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=3.-2.*st;
vec2 uvw1=1.+2.*st;
vec2 u=vec2((2.-st.x)/uvw0.x-1.,st.x/uvw1.x+1.)*shadowMapSizeAndInverse.y;
vec2 v=vec2((2.-st.y)/uvw0.y-1.,st.y/uvw1.y+1.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));
shadow=shadow/16.;
shadow=mix(darkness,1.,shadow);
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCF5(vec4 vPositionFromLight,float depthMetric,highp sampler2DShadow shadowSampler,vec2 shadowMapSizeAndInverse,float darkness,float frustumEdgeFalloff)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
vec2 uv=uvDepth.xy*shadowMapSizeAndInverse.x; 
uv+=0.5; 
vec2 st=fract(uv); 
vec2 base_uv=floor(uv)-0.5; 
base_uv*=shadowMapSizeAndInverse.y; 
vec2 uvw0=4.-3.*st;
vec2 uvw1=vec2(7.);
vec2 uvw2=1.+3.*st;
vec3 u=vec3((3.-2.*st.x)/uvw0.x-2.,(3.+st.x)/uvw1.x,st.x/uvw2.x+2.)*shadowMapSizeAndInverse.y;
vec3 v=vec3((3.-2.*st.y)/uvw0.y-2.,(3.+st.y)/uvw1.y,st.y/uvw2.y+2.)*shadowMapSizeAndInverse.y;
float shadow=0.;
shadow+=uvw0.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[0]),uvDepth.z));
shadow+=uvw1.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[0]),uvDepth.z));
shadow+=uvw2.x*uvw0.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[0]),uvDepth.z));
shadow+=uvw0.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[1]),uvDepth.z));
shadow+=uvw1.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[1]),uvDepth.z));
shadow+=uvw2.x*uvw1.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[1]),uvDepth.z));
shadow+=uvw0.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[0],v[2]),uvDepth.z));
shadow+=uvw1.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[1],v[2]),uvDepth.z));
shadow+=uvw2.x*uvw2.y*texture2D(shadowSampler,vec3(base_uv.xy+vec2(u[2],v[2]),uvDepth.z));
shadow=shadow/144.;
shadow=mix(darkness,1.,shadow);
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
const vec3 PoissonSamplers32[64]=vec3[64](
vec3(0.06407013,0.05409927,0.),
vec3(0.7366577,0.5789394,0.),
vec3(-0.6270542,-0.5320278,0.),
vec3(-0.4096107,0.8411095,0.),
vec3(0.6849564,-0.4990818,0.),
vec3(-0.874181,-0.04579735,0.),
vec3(0.9989998,0.0009880066,0.),
vec3(-0.004920578,-0.9151649,0.),
vec3(0.1805763,0.9747483,0.),
vec3(-0.2138451,0.2635818,0.),
vec3(0.109845,0.3884785,0.),
vec3(0.06876755,-0.3581074,0.),
vec3(0.374073,-0.7661266,0.),
vec3(0.3079132,-0.1216763,0.),
vec3(-0.3794335,-0.8271583,0.),
vec3(-0.203878,-0.07715034,0.),
vec3(0.5912697,0.1469799,0.),
vec3(-0.88069,0.3031784,0.),
vec3(0.5040108,0.8283722,0.),
vec3(-0.5844124,0.5494877,0.),
vec3(0.6017799,-0.1726654,0.),
vec3(-0.5554981,0.1559997,0.),
vec3(-0.3016369,-0.3900928,0.),
vec3(-0.5550632,-0.1723762,0.),
vec3(0.925029,0.2995041,0.),
vec3(-0.2473137,0.5538505,0.),
vec3(0.9183037,-0.2862392,0.),
vec3(0.2469421,0.6718712,0.),
vec3(0.3916397,-0.4328209,0.),
vec3(-0.03576927,-0.6220032,0.),
vec3(-0.04661255,0.7995201,0.),
vec3(0.4402924,0.3640312,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.),
vec3(0.,0.,0.)
);
const vec3 PoissonSamplers64[64]=vec3[64](
vec3(-0.613392,0.617481,0.),
vec3(0.170019,-0.040254,0.),
vec3(-0.299417,0.791925,0.),
vec3(0.645680,0.493210,0.),
vec3(-0.651784,0.717887,0.),
vec3(0.421003,0.027070,0.),
vec3(-0.817194,-0.271096,0.),
vec3(-0.705374,-0.668203,0.),
vec3(0.977050,-0.108615,0.),
vec3(0.063326,0.142369,0.),
vec3(0.203528,0.214331,0.),
vec3(-0.667531,0.326090,0.),
vec3(-0.098422,-0.295755,0.),
vec3(-0.885922,0.215369,0.),
vec3(0.566637,0.605213,0.),
vec3(0.039766,-0.396100,0.),
vec3(0.751946,0.453352,0.),
vec3(0.078707,-0.715323,0.),
vec3(-0.075838,-0.529344,0.),
vec3(0.724479,-0.580798,0.),
vec3(0.222999,-0.215125,0.),
vec3(-0.467574,-0.405438,0.),
vec3(-0.248268,-0.814753,0.),
vec3(0.354411,-0.887570,0.),
vec3(0.175817,0.382366,0.),
vec3(0.487472,-0.063082,0.),
vec3(-0.084078,0.898312,0.),
vec3(0.488876,-0.783441,0.),
vec3(0.470016,0.217933,0.),
vec3(-0.696890,-0.549791,0.),
vec3(-0.149693,0.605762,0.),
vec3(0.034211,0.979980,0.),
vec3(0.503098,-0.308878,0.),
vec3(-0.016205,-0.872921,0.),
vec3(0.385784,-0.393902,0.),
vec3(-0.146886,-0.859249,0.),
vec3(0.643361,0.164098,0.),
vec3(0.634388,-0.049471,0.),
vec3(-0.688894,0.007843,0.),
vec3(0.464034,-0.188818,0.),
vec3(-0.440840,0.137486,0.),
vec3(0.364483,0.511704,0.),
vec3(0.034028,0.325968,0.),
vec3(0.099094,-0.308023,0.),
vec3(0.693960,-0.366253,0.),
vec3(0.678884,-0.204688,0.),
vec3(0.001801,0.780328,0.),
vec3(0.145177,-0.898984,0.),
vec3(0.062655,-0.611866,0.),
vec3(0.315226,-0.604297,0.),
vec3(-0.780145,0.486251,0.),
vec3(-0.371868,0.882138,0.),
vec3(0.200476,0.494430,0.),
vec3(-0.494552,-0.711051,0.),
vec3(0.612476,0.705252,0.),
vec3(-0.578845,-0.768792,0.),
vec3(-0.772454,-0.090976,0.),
vec3(0.504440,0.372295,0.),
vec3(0.155736,0.065157,0.),
vec3(0.391522,0.849605,0.),
vec3(-0.620106,-0.328104,0.),
vec3(0.789239,-0.419965,0.),
vec3(-0.545396,0.538133,0.),
vec3(-0.178564,-0.596057,0.)
);
#define inline
float computeShadowWithCSMPCSS(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=clamp(ZINCLIP,0.,GREATEST_LESS_THAN_ONE);
vec4 uvDepthLayer=vec4(uvDepth.x,uvDepth.y,layer,uvDepth.z);
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,vec3(uvDepth.xy+(lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse*PoissonSamplers32[i].xy),layer)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)*depthCorrection+AAOffset);
vec4 filterRadius=vec4(penumbraRatio*lightSizeUV*lightSizeUVCorrection*shadowMapSizeInverse,0.,0.);
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec4 offset=vec4(poissonSamplers[i],0.);
offset=vec4(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.,0.);
shadow+=texture2D(shadowSampler,uvDepthLayer+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,min((depthMetric-avgBlockerDepth)*depthCorrection*penumbraDarkness,1.));
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
#define inline
float computeShadowWithPCSS(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,int searchTapCount,int pcfTapCount,vec3[64] poissonSamplers)
{
if (depthMetric>1.0 || depthMetric<0.0) {
return 1.0;
}
else
{
vec3 clipSpace=vPositionFromLight.xyz/vPositionFromLight.w;
vec3 uvDepth=vec3(0.5*clipSpace.xyz+vec3(0.5));
uvDepth.z=ZINCLIP;
float blockerDepth=0.0;
float sumBlockerDepth=0.0;
float numBlocker=0.0;
for (int i=0; i<searchTapCount; i ++) {
blockerDepth=texture2D(depthSampler,uvDepth.xy+(lightSizeUV*shadowMapSizeInverse*PoissonSamplers32[i].xy)).r;
if (blockerDepth<depthMetric) {
sumBlockerDepth+=blockerDepth;
numBlocker++;
}
}
if (numBlocker<1.0) {
return 1.0;
}
else
{
float avgBlockerDepth=sumBlockerDepth/numBlocker;
float AAOffset=shadowMapSizeInverse*10.;
float penumbraRatio=((depthMetric-avgBlockerDepth)+AAOffset);
float filterRadius=penumbraRatio*lightSizeUV*shadowMapSizeInverse;
float random=getRand(vPositionFromLight.xy);
float rotationAngle=random*3.1415926;
vec2 rotationVector=vec2(cos(rotationAngle),sin(rotationAngle));
float shadow=0.;
for (int i=0; i<pcfTapCount; i++) {
vec3 offset=poissonSamplers[i];
offset=vec3(offset.x*rotationVector.x-offset.y*rotationVector.y,offset.y*rotationVector.x+offset.x*rotationVector.y,0.);
shadow+=texture2D(shadowSampler,uvDepth+offset*filterRadius);
}
shadow/=float(pcfTapCount);
shadow=mix(shadow,1.,depthMetric-avgBlockerDepth);
shadow=mix(darkness,1.,shadow);
return computeFallOff(shadow,clipSpace.xy,frustumEdgeFalloff);
}
}
}
#define inline
float computeShadowWithPCSS16(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS32(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32);
}
#define inline
float computeShadowWithPCSS64(vec4 vPositionFromLight,float depthMetric,sampler2D depthSampler,highp sampler2DShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff)
{
return computeShadowWithPCSS(vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64);
}
#define inline
float computeShadowWithCSMPCSS16(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,16,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS32(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,16,32,PoissonSamplers32,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#define inline
float computeShadowWithCSMPCSS64(float layer,vec4 vPositionFromLight,float depthMetric,highp sampler2DArray depthSampler,highp sampler2DArrayShadow shadowSampler,float shadowMapSizeInverse,float lightSizeUV,float darkness,float frustumEdgeFalloff,vec2 lightSizeUVCorrection,float depthCorrection,float penumbraDarkness)
{
return computeShadowWithCSMPCSS(layer,vPositionFromLight,depthMetric,depthSampler,shadowSampler,shadowMapSizeInverse,lightSizeUV,darkness,frustumEdgeFalloff,32,64,PoissonSamplers64,lightSizeUVCorrection,depthCorrection,penumbraDarkness);
}
#endif
#endif
`;Y.IncludesShadersStore[UT]=VT;const kT="samplerFragmentDeclaration",GT=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
uniform sampler2D _SAMPLERNAME_Sampler;
#endif
`;Y.IncludesShadersStore[kT]=GT;const zT="fresnelFunction",WT=`#ifdef FRESNEL
float computeFresnelTerm(vec3 viewDirection,vec3 worldNormal,float bias,float power)
{
float fresnelTerm=pow(bias+abs(dot(viewDirection,worldNormal)),power);
return clamp(fresnelTerm,0.,1.);
}
#endif
`;Y.IncludesShadersStore[zT]=WT;const HT="reflectionFunction",XT=`vec3 computeFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0); 
}
vec3 computeMirroredFixedEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 direction)
{
float lon=atan(direction.z,direction.x);
float lat=acos(direction.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(1.0-s,t,0); 
}
vec3 computeEquirectangularCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 cameraToVertex=normalize(worldPos.xyz-eyePosition);
vec3 r=normalize(reflect(cameraToVertex,worldNormal));
r=vec3(reflectionMatrix*vec4(r,0));
float lon=atan(r.z,r.x);
float lat=acos(r.y);
vec2 sphereCoords=vec2(lon,lat)*RECIPROCAL_PI2*2.0;
float s=sphereCoords.x*0.5+0.5;
float t=sphereCoords.y;
return vec3(s,t,0);
}
vec3 computeSphericalCoords(vec4 worldPos,vec3 worldNormal,mat4 view,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(vec3(view*worldPos));
vec3 viewNormal=normalize(vec3(view*vec4(worldNormal,0.0)));
vec3 r=reflect(viewDir,viewNormal);
r=vec3(reflectionMatrix*vec4(r,0));
r.z=r.z-1.0;
float m=2.0*length(r);
return vec3(r.x/m+0.5,1.0-r.y/m-0.5,0);
}
vec3 computePlanarCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=worldPos.xyz-eyePosition;
vec3 coords=normalize(reflect(viewDir,worldNormal));
return vec3(reflectionMatrix*vec4(coords,1));
}
vec3 computeCubicCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeCubicLocalCoords(vec4 worldPos,vec3 worldNormal,vec3 eyePosition,mat4 reflectionMatrix,vec3 reflectionSize,vec3 reflectionPosition)
{
vec3 viewDir=normalize(worldPos.xyz-eyePosition);
vec3 coords=reflect(viewDir,worldNormal);
coords=parallaxCorrectNormal(worldPos.xyz,coords,reflectionSize,reflectionPosition);
coords=vec3(reflectionMatrix*vec4(coords,0));
#ifdef INVERTCUBICMAP
coords.y*=-1.0;
#endif
return coords;
}
vec3 computeProjectionCoords(vec4 worldPos,mat4 view,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*(view*worldPos));
}
vec3 computeSkyBoxCoords(vec3 positionW,mat4 reflectionMatrix)
{
return vec3(reflectionMatrix*vec4(positionW,1.));
}
#ifdef REFLECTION
vec3 computeReflectionCoords(vec4 worldPos,vec3 worldNormal)
{
#ifdef REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeMirroredFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR_FIXED
vec3 direction=normalize(vDirectionW);
return computeFixedEquirectangularCoords(worldPos,worldNormal,direction);
#endif
#ifdef REFLECTIONMAP_EQUIRECTANGULAR
return computeEquirectangularCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SPHERICAL
return computeSphericalCoords(worldPos,worldNormal,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_PLANAR
return computePlanarCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_CUBIC
#ifdef USE_LOCAL_REFLECTIONMAP_CUBIC
return computeCubicLocalCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix,vReflectionSize,vReflectionPosition);
#else
return computeCubicCoords(worldPos,worldNormal,vEyePosition.xyz,reflectionMatrix);
#endif
#endif
#ifdef REFLECTIONMAP_PROJECTION
return computeProjectionCoords(worldPos,view,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_SKYBOX
return computeSkyBoxCoords(vPositionUVW,reflectionMatrix);
#endif
#ifdef REFLECTIONMAP_EXPLICIT
return vec3(0,0,0);
#endif
}
#endif
`;Y.IncludesShadersStore[HT]=XT;const YT="imageProcessingDeclaration",KT=`#ifdef EXPOSURE
uniform float exposureLinear;
#endif
#ifdef CONTRAST
uniform float contrast;
#endif
#if defined(VIGNETTE) || defined(DITHER)
uniform vec2 vInverseScreenSize;
#endif
#ifdef VIGNETTE
uniform vec4 vignetteSettings1;
uniform vec4 vignetteSettings2;
#endif
#ifdef COLORCURVES
uniform vec4 vCameraColorCurveNegative;
uniform vec4 vCameraColorCurveNeutral;
uniform vec4 vCameraColorCurvePositive;
#endif
#ifdef COLORGRADING
#ifdef COLORGRADING3D
uniform highp sampler3D txColorTransform;
#else
uniform sampler2D txColorTransform;
#endif
uniform vec4 colorTransformSettings;
#endif
#ifdef DITHER
uniform float ditherIntensity;
#endif
`;Y.IncludesShadersStore[YT]=KT;const $T="imageProcessingFunctions",jT=`#if defined(COLORGRADING) && !defined(COLORGRADING3D)
/** 
* Polyfill for SAMPLE_TEXTURE_3D,which is unsupported in WebGL.
* sampler3dSetting.x=textureOffset (0.5/textureSize).
* sampler3dSetting.y=textureSize.
*/
#define inline
vec3 sampleTexture3D(sampler2D colorTransform,vec3 color,vec2 sampler3dSetting)
{
float sliceSize=2.0*sampler3dSetting.x; 
#ifdef SAMPLER3DGREENDEPTH
float sliceContinuous=(color.g-sampler3dSetting.x)*sampler3dSetting.y;
#else
float sliceContinuous=(color.b-sampler3dSetting.x)*sampler3dSetting.y;
#endif
float sliceInteger=floor(sliceContinuous);
float sliceFraction=sliceContinuous-sliceInteger;
#ifdef SAMPLER3DGREENDEPTH
vec2 sliceUV=color.rb;
#else
vec2 sliceUV=color.rg;
#endif
sliceUV.x*=sliceSize;
sliceUV.x+=sliceInteger*sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice0Color=texture2D(colorTransform,sliceUV);
sliceUV.x+=sliceSize;
sliceUV=saturate(sliceUV);
vec4 slice1Color=texture2D(colorTransform,sliceUV);
vec3 result=mix(slice0Color.rgb,slice1Color.rgb,sliceFraction);
#ifdef SAMPLER3DBGRMAP
color.rgb=result.rgb;
#else
color.rgb=result.bgr;
#endif
return color;
}
#endif
#ifdef TONEMAPPING_ACES
const mat3 ACESInputMat=mat3(
vec3(0.59719,0.07600,0.02840),
vec3(0.35458,0.90834,0.13383),
vec3(0.04823,0.01566,0.83777)
);
const mat3 ACESOutputMat=mat3(
vec3( 1.60475,-0.10208,-0.00327),
vec3(-0.53108, 1.10813,-0.07276),
vec3(-0.07367,-0.00605, 1.07602)
);
vec3 RRTAndODTFit(vec3 v)
{
vec3 a=v*(v+0.0245786)-0.000090537;
vec3 b=v*(0.983729*v+0.4329510)+0.238081;
return a/b;
}
vec3 ACESFitted(vec3 color)
{
color=ACESInputMat*color;
color=RRTAndODTFit(color);
color=ACESOutputMat*color;
color=saturate(color);
return color;
}
#endif
vec4 applyImageProcessing(vec4 result) {
#ifdef EXPOSURE
result.rgb*=exposureLinear;
#endif
#ifdef VIGNETTE
vec2 viewportXY=gl_FragCoord.xy*vInverseScreenSize;
viewportXY=viewportXY*2.0-1.0;
vec3 vignetteXY1=vec3(viewportXY*vignetteSettings1.xy+vignetteSettings1.zw,1.0);
float vignetteTerm=dot(vignetteXY1,vignetteXY1);
float vignette=pow(vignetteTerm,vignetteSettings2.w);
vec3 vignetteColor=vignetteSettings2.rgb;
#ifdef VIGNETTEBLENDMODEMULTIPLY
vec3 vignetteColorMultiplier=mix(vignetteColor,vec3(1,1,1),vignette);
result.rgb*=vignetteColorMultiplier;
#endif
#ifdef VIGNETTEBLENDMODEOPAQUE
result.rgb=mix(vignetteColor,result.rgb,vignette);
#endif
#endif
#ifdef TONEMAPPING
#ifdef TONEMAPPING_ACES
result.rgb=ACESFitted(result.rgb);
#else
const float tonemappingCalibration=1.590579;
result.rgb=1.0-exp2(-tonemappingCalibration*result.rgb);
#endif
#endif
result.rgb=toGammaSpace(result.rgb);
result.rgb=saturate(result.rgb);
#ifdef CONTRAST
vec3 resultHighContrast=result.rgb*result.rgb*(3.0-2.0*result.rgb);
if (contrast<1.0) {
result.rgb=mix(vec3(0.5,0.5,0.5),result.rgb,contrast);
} else {
result.rgb=mix(result.rgb,resultHighContrast,contrast-1.0);
}
#endif
#ifdef COLORGRADING
vec3 colorTransformInput=result.rgb*colorTransformSettings.xxx+colorTransformSettings.yyy;
#ifdef COLORGRADING3D
vec3 colorTransformOutput=texture(txColorTransform,colorTransformInput).rgb;
#else
vec3 colorTransformOutput=sampleTexture3D(txColorTransform,colorTransformInput,colorTransformSettings.yz).rgb;
#endif
result.rgb=mix(result.rgb,colorTransformOutput,colorTransformSettings.www);
#endif
#ifdef COLORCURVES
float luma=getLuminance(result.rgb);
vec2 curveMix=clamp(vec2(luma*3.0-1.5,luma*-3.0+1.5),vec2(0.0),vec2(1.0));
vec4 colorCurve=vCameraColorCurveNeutral+curveMix.x*vCameraColorCurvePositive-curveMix.y*vCameraColorCurveNegative;
result.rgb*=colorCurve.rgb;
result.rgb=mix(vec3(luma),result.rgb,colorCurve.a);
#endif
#ifdef DITHER
float rand=getRand(gl_FragCoord.xy*vInverseScreenSize);
float dither=mix(-ditherIntensity,ditherIntensity,rand);
result.rgb=saturate(result.rgb+vec3(dither));
#endif
return result;
}`;Y.IncludesShadersStore[$T]=jT;const qT="bumpFragmentMainFunctions",QT=`#if defined(BUMP) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC) || defined(DETAIL)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#ifdef OBJECTSPACE_NORMALMAP
uniform mat4 normalMatrix;
#endif
vec3 perturbNormalBase(mat3 cotangentFrame,vec3 normal,float scale)
{
#ifdef NORMALXYSCALE
normal=normalize(normal*vec3(scale,scale,1.0));
#endif
return normalize(cotangentFrame*normal);
}
vec3 perturbNormal(mat3 cotangentFrame,vec3 textureSample,float scale)
{
return perturbNormalBase(cotangentFrame,textureSample*2.0-1.0,scale);
}
mat3 cotangent_frame(vec3 normal,vec3 p,vec2 uv,vec2 tangentSpaceParams)
{
vec3 dp1=dFdx(p);
vec3 dp2=dFdy(p);
vec2 duv1=dFdx(uv);
vec2 duv2=dFdy(uv);
vec3 dp2perp=cross(dp2,normal);
vec3 dp1perp=cross(normal,dp1);
vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;
vec3 bitangent=dp2perp*duv1.y+dp1perp*duv2.y;
tangent*=tangentSpaceParams.x;
bitangent*=tangentSpaceParams.y;
float invmax=inversesqrt(max(dot(tangent,tangent),dot(bitangent,bitangent)));
return mat3(tangent*invmax,bitangent*invmax,normal);
}
#endif
`;Y.IncludesShadersStore[qT]=QT;const ZT="bumpFragmentFunctions",JT=`#if defined(BUMP)
#include<samplerFragmentDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump)
#endif
#if defined(DETAIL)
#include<samplerFragmentDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_SAMPLERNAME_,detail)
#endif
#if defined(BUMP) && defined(PARALLAX)
const float minSamples=4.;
const float maxSamples=15.;
const int iMaxSamples=15;
vec2 parallaxOcclusion(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale) {
float parallaxLimit=length(vViewDirCoT.xy)/vViewDirCoT.z;
parallaxLimit*=parallaxScale;
vec2 vOffsetDir=normalize(vViewDirCoT.xy);
vec2 vMaxOffset=vOffsetDir*parallaxLimit;
float numSamples=maxSamples+(dot(vViewDirCoT,vNormalCoT)*(minSamples-maxSamples));
float stepSize=1.0/numSamples;
float currRayHeight=1.0;
vec2 vCurrOffset=vec2(0,0);
vec2 vLastOffset=vec2(0,0);
float lastSampledHeight=1.0;
float currSampledHeight=1.0;
for (int i=0; i<iMaxSamples; i++)
{
currSampledHeight=texture2D(bumpSampler,texCoord+vCurrOffset).w;
if (currSampledHeight>currRayHeight)
{
float delta1=currSampledHeight-currRayHeight;
float delta2=(currRayHeight+stepSize)-lastSampledHeight;
float ratio=delta1/(delta1+delta2);
vCurrOffset=(ratio)* vLastOffset+(1.0-ratio)*vCurrOffset;
break;
}
else
{
currRayHeight-=stepSize;
vLastOffset=vCurrOffset;
vCurrOffset+=stepSize*vMaxOffset;
lastSampledHeight=currSampledHeight;
}
}
return vCurrOffset;
}
vec2 parallaxOffset(vec3 viewDir,float heightScale)
{
float height=texture2D(bumpSampler,vBumpUV).w;
vec2 texCoordOffset=heightScale*viewDir.xy*height;
return -texCoordOffset;
}
#endif
`;Y.IncludesShadersStore[ZT]=JT;const eb="clipPlaneFragmentDeclaration",tb=`#ifdef CLIPPLANE
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
varying float fClipDistance6;
#endif
`;Y.IncludesShadersStore[eb]=tb;const ib="logDepthDeclaration",sb=`#ifdef LOGARITHMICDEPTH
uniform float logarithmicDepthConstant;
varying float vFragmentDepth;
#endif
`;Y.IncludesShadersStore[ib]=sb;const rb="fogFragmentDeclaration",nb=`#ifdef FOG
#define FOGMODE_NONE 0.
#define FOGMODE_EXP 1.
#define FOGMODE_EXP2 2.
#define FOGMODE_LINEAR 3.
#define E 2.71828
uniform vec4 vFogInfos;
uniform vec3 vFogColor;
varying vec3 vFogDistance;
float CalcFogFactor()
{
float fogCoeff=1.0;
float fogStart=vFogInfos.y;
float fogEnd=vFogInfos.z;
float fogDensity=vFogInfos.w;
float fogDistance=length(vFogDistance);
if (FOGMODE_LINEAR==vFogInfos.x)
{
fogCoeff=(fogEnd-fogDistance)/(fogEnd-fogStart);
}
else if (FOGMODE_EXP==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDensity);
}
else if (FOGMODE_EXP2==vFogInfos.x)
{
fogCoeff=1.0/pow(E,fogDistance*fogDistance*fogDensity*fogDensity);
}
return clamp(fogCoeff,0.0,1.0);
}
#endif
`;Y.IncludesShadersStore[rb]=nb;const ab="clipPlaneFragment",ob=`#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
if (false) {}
#endif
#ifdef CLIPPLANE
else if (fClipDistance>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE2
else if (fClipDistance2>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE3
else if (fClipDistance3>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE4
else if (fClipDistance4>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE5
else if (fClipDistance5>0.0)
{
discard;
}
#endif
#ifdef CLIPPLANE6
else if (fClipDistance6>0.0)
{
discard;
}
#endif
`;Y.IncludesShadersStore[ab]=ob;const lb="bumpFragment",hb=`vec2 uvOffset=vec2(0.0,0.0);
#if defined(BUMP) || defined(PARALLAX) || defined(DETAIL)
#ifdef NORMALXYSCALE
float normalScale=1.0;
#elif defined(BUMP)
float normalScale=vBumpInfos.y;
#else
float normalScale=1.0;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#elif defined(BUMP)
vec2 TBNUV=gl_FrontFacing ? vBumpUV : -vBumpUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vTangentSpaceParams);
#else
vec2 TBNUV=gl_FrontFacing ? vDetailUV : -vDetailUV;
mat3 TBN=cotangent_frame(normalW*normalScale,vPositionW,TBNUV,vec2(1.,1.));
#endif
#elif defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
mat3 TBN=vTBN;
#else
vec2 TBNUV=gl_FrontFacing ? vMainUV1 : -vMainUV1;
mat3 TBN=cotangent_frame(normalW,vPositionW,TBNUV,vec2(1.,1.));
#endif
#endif
#ifdef PARALLAX
mat3 invTBN=transposeMat3(TBN);
#ifdef PARALLAXOCCLUSION
uvOffset=parallaxOcclusion(invTBN*-viewDirectionW,invTBN*normalW,vBumpUV,vBumpInfos.z);
#else
uvOffset=parallaxOffset(invTBN*viewDirectionW,vBumpInfos.z);
#endif
#endif
#ifdef DETAIL
vec4 detailColor=texture2D(detailSampler,vDetailUV+uvOffset);
vec2 detailNormalRG=detailColor.wy*2.0-1.0;
float detailNormalB=sqrt(1.-saturate(dot(detailNormalRG,detailNormalRG)));
vec3 detailNormal=vec3(detailNormalRG,detailNormalB);
#endif
#ifdef BUMP
#ifdef OBJECTSPACE_NORMALMAP
normalW=normalize(texture2D(bumpSampler,vBumpUV).xyz *2.0-1.0);
normalW=normalize(mat3(normalMatrix)*normalW);
#elif !defined(DETAIL)
normalW=perturbNormal(TBN,texture2D(bumpSampler,vBumpUV+uvOffset).xyz,vBumpInfos.y);
#else
vec3 bumpNormal=texture2D(bumpSampler,vBumpUV+uvOffset).xyz*2.0-1.0;
#if DETAIL_NORMALBLENDMETHOD==0 
detailNormal.xy*=vDetailInfos.z;
vec3 blendedNormal=normalize(vec3(bumpNormal.xy+detailNormal.xy,bumpNormal.z*detailNormal.z));
#elif DETAIL_NORMALBLENDMETHOD==1 
detailNormal.xy*=vDetailInfos.z;
bumpNormal+=vec3(0.0,0.0,1.0);
detailNormal*=vec3(-1.0,-1.0,1.0);
vec3 blendedNormal=bumpNormal*dot(bumpNormal,detailNormal)/bumpNormal.z-detailNormal;
#endif
normalW=perturbNormalBase(TBN,blendedNormal,vBumpInfos.y);
#endif
#elif defined(DETAIL)
detailNormal.xy*=vDetailInfos.z;
normalW=perturbNormalBase(TBN,detailNormal,vDetailInfos.z);
#endif
`;Y.IncludesShadersStore[lb]=hb;const cb="depthPrePass",ub=`#ifdef DEPTHPREPASS
gl_FragColor=vec4(0.,0.,0.,1.0);
return;
#endif
`;Y.IncludesShadersStore[cb]=ub;const db="lightFragment",fb=`#ifdef LIGHT{X}
#if defined(SHADOWONLY) || defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X}) && defined(LIGHTMAPNOSPECULAR{X})
#else
#ifdef PBR
#ifdef SPOTLIGHT{X}
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(POINTLIGHT{X})
preInfo=computePointAndSpotPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(HEMILIGHT{X})
preInfo=computeHemisphericPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#elif defined(DIRLIGHT{X})
preInfo=computeDirectionalPreLightingInfo(light{X}.vLightData,viewDirectionW,normalW);
#endif
preInfo.NdotV=NdotV;
#ifdef SPOTLIGHT{X}
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff_GLTF(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
preInfo.attenuation*=computeDirectionalLightFalloff_Physical(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
preInfo.attenuation*=computeDirectionalLightFalloff_Standard(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
preInfo.attenuation*=computeDirectionalLightFalloff(light{X}.vLightDirection.xyz,preInfo.L,light{X}.vLightDirection.w,light{X}.vLightData.w,light{X}.vLightFalloff.z,light{X}.vLightFalloff.w);
#endif
#elif defined(POINTLIGHT{X})
#ifdef LIGHT_FALLOFF_GLTF{X}
preInfo.attenuation=computeDistanceLightFalloff_GLTF(preInfo.lightDistanceSquared,light{X}.vLightFalloff.y);
#elif defined(LIGHT_FALLOFF_PHYSICAL{X})
preInfo.attenuation=computeDistanceLightFalloff_Physical(preInfo.lightDistanceSquared);
#elif defined(LIGHT_FALLOFF_STANDARD{X})
preInfo.attenuation=computeDistanceLightFalloff_Standard(preInfo.lightOffset,light{X}.vLightFalloff.x);
#else
preInfo.attenuation=computeDistanceLightFalloff(preInfo.lightOffset,preInfo.lightDistanceSquared,light{X}.vLightFalloff.x,light{X}.vLightFalloff.y);
#endif
#else
preInfo.attenuation=1.0;
#endif
#ifdef HEMILIGHT{X}
preInfo.roughness=roughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(roughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#ifdef IRIDESCENCE
preInfo.iridescenceIntensity=iridescenceIntensity;
#endif
#ifdef HEMILIGHT{X}
info.diffuse=computeHemisphericDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb,light{X}.vLightGround);
#elif defined(SS_TRANSLUCENCY)
info.diffuse=computeDiffuseAndTransmittedLighting(preInfo,light{X}.vLightDiffuse.rgb,subSurfaceOut.transmittance);
#else
info.diffuse=computeDiffuseLighting(preInfo,light{X}.vLightDiffuse.rgb);
#endif
#ifdef SPECULARTERM
#ifdef ANISOTROPIC
info.specular=computeAnisotropicSpecularLighting(preInfo,viewDirectionW,normalW,anisotropicOut.anisotropicTangent,anisotropicOut.anisotropicBitangent,anisotropicOut.anisotropy,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#else
info.specular=computeSpecularLighting(preInfo,normalW,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#endif
#ifdef SHEEN
#ifdef SHEEN_LINKWITHALBEDO
preInfo.roughness=sheenOut.sheenIntensity;
#else
#ifdef HEMILIGHT{X}
preInfo.roughness=sheenOut.sheenRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(sheenOut.sheenRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
#endif
info.sheen=computeSheenLighting(preInfo,normalW,sheenOut.sheenColor,specularEnvironmentR90,AARoughnessFactors.x,light{X}.vLightDiffuse.rgb);
#endif
#ifdef CLEARCOAT
#ifdef HEMILIGHT{X}
preInfo.roughness=clearcoatOut.clearCoatRoughness;
#else
preInfo.roughness=adjustRoughnessFromLightProperties(clearcoatOut.clearCoatRoughness,light{X}.vLightSpecular.a,preInfo.lightDistance);
#endif
info.clearCoat=computeClearCoatLighting(preInfo,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatAARoughnessFactors.x,clearcoatOut.clearCoatIntensity,light{X}.vLightDiffuse.rgb);
#ifdef CLEARCOAT_TINT
absorption=computeClearCoatLightingAbsorption(clearcoatOut.clearCoatNdotVRefract,preInfo.L,clearcoatOut.clearCoatNormalW,clearcoatOut.clearCoatColor,clearcoatOut.clearCoatThickness,clearcoatOut.clearCoatIntensity);
info.diffuse*=absorption;
#ifdef SPECULARTERM
info.specular*=absorption;
#endif
#endif
info.diffuse*=info.clearCoat.w;
#ifdef SPECULARTERM
info.specular*=info.clearCoat.w;
#endif
#ifdef SHEEN
info.sheen*=info.clearCoat.w;
#endif
#endif
#else
#ifdef SPOTLIGHT{X}
info=computeSpotLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDirection,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#elif defined(HEMILIGHT{X})
info=computeHemisphericLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightGround,glossiness);
#elif defined(POINTLIGHT{X}) || defined(DIRLIGHT{X})
info=computeLighting(viewDirectionW,normalW,light{X}.vLightData,light{X}.vLightDiffuse.rgb,light{X}.vLightSpecular.rgb,light{X}.vLightDiffuse.a,glossiness);
#endif
#endif
#ifdef PROJECTEDLIGHTTEXTURE{X}
info.diffuse*=computeProjectionTextureDiffuseLighting(projectionLightSampler{X},textureProjectionMatrix{X});
#endif
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) 
{
#ifdef SHADOWCSM_RIGHTHANDED{X}
diff{X}=viewFrustumZ{X}[i]+vPositionFromCamera{X}.z;
#else
diff{X}=viewFrustumZ{X}[i]-vPositionFromCamera{X}.z;
#endif
if (diff{X}>=0.) {
index{X}=i;
break;
}
}
#ifdef SHADOWCSMUSESHADOWMAXZ{X}
if (index{X}>=0)
#endif
{
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
shadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
shadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=vec3(shadow)*vCascadeColorsMultiplier{X}[index{X}];
#endif
#ifndef SHADOWCSMNOBLEND{X}
float frustumLength=frustumLengths{X}[index{X}];
float diffRatio=clamp(diff{X}/frustumLength,0.,1.)*cascadeBlendFactor{X};
if (index{X}<(SHADOWCSMNUM_CASCADES{X}-1) && diffRatio<1.)
{
index{X}+=1;
float nextShadow=0.;
#if defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCF1(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCF3(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
nextShadow=computeShadowWithCSMPCF5(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
nextShadow=computeShadowWithCSMPCSS16(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#elif defined(SHADOWMEDIUMQUALITY{X})
nextShadow=computeShadowWithCSMPCSS32(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#else
nextShadow=computeShadowWithCSMPCSS64(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w,lightSizeUVCorrection{X}[index{X}],depthCorrection{X}[index{X}],penumbraDarkness{X});
#endif
#else
nextShadow=computeShadowCSM(float(index{X}),vPositionFromLight{X}[index{X}],vDepthMetric{X}[index{X}],shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
shadow=mix(nextShadow,shadow,diffRatio);
#ifdef SHADOWCSMDEBUG{X}
shadowDebug{X}=mix(vec3(nextShadow)*vCascadeColorsMultiplier{X}[index{X}],shadowDebug{X},diffRatio);
#endif
}
#endif
}
#elif defined(SHADOWCLOSEESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithCloseESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithCloseESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWESM{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithESMCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.depthValues);
#else
shadow=computeShadowWithESM(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.z,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPOISSON{X})
#if defined(SHADOWCUBE{X})
shadow=computeShadowWithPoissonSamplingCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadowWithPoissonSampling(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCF{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCF1(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCF3(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCF5(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.yz,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#elif defined(SHADOWPCSS{X})
#if defined(SHADOWLOWQUALITY{X})
shadow=computeShadowWithPCSS16(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#elif defined(SHADOWMEDIUMQUALITY{X})
shadow=computeShadowWithPCSS32(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#else
shadow=computeShadowWithPCSS64(vPositionFromLight{X},vDepthMetric{X},depthSampler{X},shadowSampler{X},light{X}.shadowsInfo.y,light{X}.shadowsInfo.z,light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#else
#if defined(SHADOWCUBE{X})
shadow=computeShadowCube(light{X}.vLightData.xyz,shadowSampler{X},light{X}.shadowsInfo.x,light{X}.depthValues);
#else
shadow=computeShadow(vPositionFromLight{X},vDepthMetric{X},shadowSampler{X},light{X}.shadowsInfo.x,light{X}.shadowsInfo.w);
#endif
#endif
#ifdef SHADOWONLY
#ifndef SHADOWINUSE
#define SHADOWINUSE
#endif
globalShadow+=shadow;
shadowLightCount+=1.0;
#endif
#else
shadow=1.;
#endif
#ifndef SHADOWONLY
#ifdef CUSTOMUSERLIGHTING
diffuseBase+=computeCustomDiffuseLighting(info,diffuseBase,shadow);
#ifdef SPECULARTERM
specularBase+=computeCustomSpecularLighting(info,specularBase,shadow);
#endif
#elif defined(LIGHTMAP) && defined(LIGHTMAPEXCLUDED{X})
diffuseBase+=lightmapColor.rgb*shadow;
#ifdef SPECULARTERM
#ifndef LIGHTMAPNOSPECULAR{X}
specularBase+=info.specular*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef CLEARCOAT
#ifndef LIGHTMAPNOSPECULAR{X}
clearCoatBase+=info.clearCoat.rgb*shadow*lightmapColor.rgb;
#endif
#endif
#ifdef SHEEN
#ifndef LIGHTMAPNOSPECULAR{X}
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#else
#ifdef SHADOWCSMDEBUG{X}
diffuseBase+=info.diffuse*shadowDebug{X};
#else 
diffuseBase+=info.diffuse*shadow;
#endif
#ifdef SPECULARTERM
specularBase+=info.specular*shadow;
#endif
#ifdef CLEARCOAT
clearCoatBase+=info.clearCoat.rgb*shadow;
#endif
#ifdef SHEEN
sheenBase+=info.sheen.rgb*shadow;
#endif
#endif
#endif
#endif
`;Y.IncludesShadersStore[db]=fb;const pb="logDepthFragment",_b=`#ifdef LOGARITHMICDEPTH
gl_FragDepthEXT=log2(vFragmentDepth)*logarithmicDepthConstant*0.5;
#endif
`;Y.IncludesShadersStore[pb]=_b;const mb="fogFragment",gb=`#ifdef FOG
float fog=CalcFogFactor();
#ifdef PBR
fog=toLinearSpace(fog);
#endif
color.rgb=mix(vFogColor,color.rgb,fog);
#endif
`;Y.IncludesShadersStore[mb]=gb;const vb="oitFragment",xb=`#ifdef ORDER_INDEPENDENT_TRANSPARENCY
float fragDepth=gl_FragCoord.z; 
#ifdef ORDER_INDEPENDENT_TRANSPARENCY_16BITS
uint halfFloat=packHalf2x16(vec2(fragDepth));
vec2 full=unpackHalf2x16(halfFloat);
fragDepth=full.x;
#endif
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec2 lastDepth=texelFetch(oitDepthSampler,fragCoord,0).rg;
vec4 lastFrontColor=texelFetch(oitFrontColorSampler,fragCoord,0);
depth.rg=vec2(-MAX_DEPTH);
frontColor=lastFrontColor;
backColor=vec4(0.0);
#ifdef USE_REVERSE_DEPTHBUFFER
float furthestDepth=-lastDepth.x;
float nearestDepth=lastDepth.y;
#else
float nearestDepth=-lastDepth.x;
float furthestDepth=lastDepth.y;
#endif
float alphaMultiplier=1.0-lastFrontColor.a;
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth>nearestDepth || fragDepth<furthestDepth) {
#else
if (fragDepth<nearestDepth || fragDepth>furthestDepth) {
#endif
return;
}
#ifdef USE_REVERSE_DEPTHBUFFER
if (fragDepth<nearestDepth && fragDepth>furthestDepth) {
#else
if (fragDepth>nearestDepth && fragDepth<furthestDepth) {
#endif
depth.rg=vec2(-fragDepth,fragDepth);
return;
}
#endif
`;Y.IncludesShadersStore[vb]=xb;const Tb="defaultPixelShader",bb=`#include<__decl__defaultFragment>
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
#include<oitDeclaration>
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#include<helperFunctions>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<samplerFragmentDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_SAMPLERNAME_,diffuse)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#ifdef REFRACTION
#ifdef REFRACTIONMAP_3D
uniform samplerCube refractionCubeSampler;
#else
uniform sampler2D refraction2DSampler;
#endif
#endif
#if defined(SPECULARTERM)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_SAMPLERNAME_,specular)
#endif
#include<fresnelFunction>
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
uniform samplerCube reflectionCubeSampler;
#else
uniform sampler2D reflection2DSampler;
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#include<imageProcessingDeclaration>
#include<imageProcessingFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
vec4 baseColor=vec4(1.,1.,1.,1.);
vec3 diffuseColor=vDiffuseColor.rgb;
float alpha=vDiffuseColor.a;
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(-cross(dFdx(vPositionW),dFdy(vPositionW)));
#endif
#include<bumpFragment>
#ifdef TWOSIDEDLIGHTING
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
#ifdef DIFFUSE
baseColor=texture2D(diffuseSampler,vDiffuseUV+uvOffset);
#if defined(ALPHATEST) && !defined(ALPHATEST_AFTERALLALPHACOMPUTATIONS)
if (baseColor.a<alphaCutOff)
discard;
#endif
#ifdef ALPHAFROMDIFFUSE
alpha*=baseColor.a;
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
baseColor.rgb*=vDiffuseInfos.y;
#endif
#include<depthPrePass>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
baseColor.rgb*=vColor.rgb;
#endif
#ifdef DETAIL
baseColor.rgb=baseColor.rgb*2.0*mix(0.5,detailColor.r,vDetailInfos.y);
#endif
#define CUSTOM_FRAGMENT_UPDATE_DIFFUSE
vec3 baseAmbientColor=vec3(1.,1.,1.);
#ifdef AMBIENT
baseAmbientColor=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb*vAmbientInfos.y;
#endif
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
#ifdef SPECULARTERM
float glossiness=vSpecularColor.a;
vec3 specularColor=vSpecularColor.rgb;
#ifdef SPECULAR
vec4 specularMapColor=texture2D(specularSampler,vSpecularUV+uvOffset);
specularColor=specularMapColor.rgb;
#ifdef GLOSSINESS
glossiness=glossiness*specularMapColor.a;
#endif
#endif
#else
float glossiness=0.;
#endif
vec3 diffuseBase=vec3(0.,0.,0.);
lightingInfo info;
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
float shadow=1.;
#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
#include<lightFragment>[0..maxSimultaneousLights]
vec4 refractionColor=vec4(0.,0.,0.,1.);
#ifdef REFRACTION
vec3 refractionVector=normalize(refract(-viewDirectionW,normalW,vRefractionInfos.y));
#ifdef REFRACTIONMAP_3D
#ifdef USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,vRefractionSize,vRefractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
if (dot(refractionVector,viewDirectionW)<1.0) {
refractionColor=textureCube(refractionCubeSampler,refractionVector);
}
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
refractionColor=texture2D(refraction2DSampler,refractionCoords);
#endif
#ifdef RGBDREFRACTION
refractionColor.rgb=fromRGBD(refractionColor);
#endif
#ifdef IS_REFRACTION_LINEAR
refractionColor.rgb=toGammaSpace(refractionColor.rgb);
#endif
refractionColor.rgb*=vRefractionInfos.x;
#endif
vec4 reflectionColor=vec4(0.,0.,0.,1.);
#ifdef REFLECTION
vec3 vReflectionUVW=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
vReflectionUVW.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
#ifdef ROUGHNESS
float bias=vReflectionInfos.y;
#ifdef SPECULARTERM
#ifdef SPECULAR
#ifdef GLOSSINESS
bias*=(1.0-specularMapColor.a);
#endif
#endif
#endif
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW,bias);
#else
reflectionColor=textureCube(reflectionCubeSampler,vReflectionUVW);
#endif
#else
vec2 coords=vReflectionUVW.xy;
#ifdef REFLECTIONMAP_PROJECTION
coords/=vReflectionUVW.z;
#endif
coords.y=1.0-coords.y;
reflectionColor=texture2D(reflection2DSampler,coords);
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef IS_REFLECTION_LINEAR
reflectionColor.rgb=toGammaSpace(reflectionColor.rgb);
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#ifdef REFLECTIONFRESNEL
float reflectionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,reflectionRightColor.a,reflectionLeftColor.a);
#ifdef REFLECTIONFRESNELFROMSPECULAR
#ifdef SPECULARTERM
reflectionColor.rgb*=specularColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#else
reflectionColor.rgb*=reflectionLeftColor.rgb*(1.0-reflectionFresnelTerm)+reflectionFresnelTerm*reflectionRightColor.rgb;
#endif
#endif
#endif
#ifdef REFRACTIONFRESNEL
float refractionFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,refractionRightColor.a,refractionLeftColor.a);
refractionColor.rgb*=refractionLeftColor.rgb*(1.0-refractionFresnelTerm)+refractionFresnelTerm*refractionRightColor.rgb;
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#ifdef OPACITYRGB
opacityMap.rgb=opacityMap.rgb*vec3(0.3,0.59,0.11);
alpha*=(opacityMap.x+opacityMap.y+opacityMap.z)* vOpacityInfos.y;
#else
alpha*=opacityMap.a*vOpacityInfos.y;
#endif
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#ifdef OPACITYFRESNEL
float opacityFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,opacityParts.z,opacityParts.w);
alpha+=opacityParts.x*(1.0-opacityFresnelTerm)+opacityFresnelTerm*opacityParts.y;
#endif
#ifdef ALPHATEST
#ifdef ALPHATEST_AFTERALLALPHACOMPUTATIONS
if (alpha<alphaCutOff)
discard;
#endif
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
vec3 emissiveColor=vEmissiveColor;
#ifdef EMISSIVE
emissiveColor+=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb*vEmissiveInfos.y;
#endif
#ifdef EMISSIVEFRESNEL
float emissiveFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,emissiveRightColor.a,emissiveLeftColor.a);
emissiveColor*=emissiveLeftColor.rgb*(1.0-emissiveFresnelTerm)+emissiveFresnelTerm*emissiveRightColor.rgb;
#endif
#ifdef DIFFUSEFRESNEL
float diffuseFresnelTerm=computeFresnelTerm(viewDirectionW,normalW,diffuseRightColor.a,diffuseLeftColor.a);
diffuseBase*=diffuseLeftColor.rgb*(1.0-diffuseFresnelTerm)+diffuseFresnelTerm*diffuseRightColor.rgb;
#endif
#ifdef EMISSIVEASILLUMINATION
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
#ifdef LINKEMISSIVEWITHDIFFUSE
vec3 finalDiffuse=clamp((diffuseBase+emissiveColor)*diffuseColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#else
vec3 finalDiffuse=clamp(diffuseBase*diffuseColor+emissiveColor+vAmbientColor,0.0,1.0)*baseColor.rgb;
#endif
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase*specularColor;
#ifdef SPECULAROVERALPHA
alpha=clamp(alpha+dot(finalSpecular,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#else
vec3 finalSpecular=vec3(0.0);
#endif
#ifdef REFLECTIONOVERALPHA
alpha=clamp(alpha+dot(reflectionColor.rgb,vec3(0.3,0.59,0.11)),0.,1.);
#endif
#ifdef EMISSIVEASILLUMINATION
vec4 color=vec4(clamp(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+emissiveColor+refractionColor.rgb,0.0,1.0),alpha);
#else
vec4 color=vec4(finalDiffuse*baseAmbientColor+finalSpecular+reflectionColor.rgb+refractionColor.rgb,alpha);
#endif
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
color.rgb*=lightmapColor.rgb;
#else
color.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
color.rgb=max(color.rgb,0.);
#include<logDepthFragment>
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
color.rgb=toLinearSpace(color.rgb);
#else
#ifdef IMAGEPROCESSING
color.rgb=toLinearSpace(color.rgb);
color=applyImageProcessing(color);
#endif
#endif
color.a*=visibility;
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=color.a>0.4 ? 1.0 : 0.0;
gl_FragData[0]=color; 
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_IRRADIANCE
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(0.0,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#if defined(SPECULARTERM)
#if defined(SPECULAR)
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularMapColor)*writeGeometryInfo; 
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(specularColor,1.0)*writeGeometryInfo;
#endif
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(0.0,0.0,0.0,1.0)*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=color;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=color.rgb*color.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-color.a);
} else {
backColor+=color;
}
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Y.ShadersStore[Tb]=bb;const Sb="defaultVertexDeclaration",Eb=`uniform mat4 viewProjection;
uniform mat4 view;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec2 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#if defined(SPECULAR) && defined(SPECULARTERM)
uniform vec2 vSpecularInfos;
uniform mat4 specularMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef REFLECTION
uniform mat4 reflectionMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;Y.IncludesShadersStore[Sb]=Eb;const Cb="uvAttributeDeclaration",yb=`#ifdef UV{X}
attribute vec2 uv{X};
#endif
`;Y.IncludesShadersStore[Cb]=yb;const Ab="bonesDeclaration",Rb=`#if NUM_BONE_INFLUENCERS>0
attribute vec4 matricesIndices;
attribute vec4 matricesWeights;
#if NUM_BONE_INFLUENCERS>4
attribute vec4 matricesIndicesExtra;
attribute vec4 matricesWeightsExtra;
#endif
#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#ifdef BONETEXTURE
uniform sampler2D boneSampler;
uniform float boneTextureWidth;
#else
uniform mat4 mBones[BonesPerMesh];
#ifdef BONES_VELOCITY_ENABLED
uniform mat4 mPreviousBones[BonesPerMesh];
#endif
#endif
#ifdef BONETEXTURE
#define inline
mat4 readMatrixFromRawSampler(sampler2D smp,float index)
{
float offset=index *4.0;
float dx=1.0/boneTextureWidth;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),0.));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),0.));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),0.));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),0.));
return mat4(m0,m1,m2,m3);
}
#endif
#endif
#endif
`;Y.IncludesShadersStore[Ab]=Rb;const Ib="bakedVertexAnimationDeclaration",Pb=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
uniform float bakedVertexAnimationTime;
uniform vec2 bakedVertexAnimationTextureSizeInverted;
uniform vec4 bakedVertexAnimationSettings;
uniform sampler2D bakedVertexAnimationTexture;
#ifdef INSTANCES
attribute vec4 bakedVertexAnimationSettingsInstanced;
#endif
#define inline
mat4 readMatrixFromRawSamplerVAT(sampler2D smp,float index,float frame)
{
float offset=index*4.0;
float frameUV=(frame+0.5)*bakedVertexAnimationTextureSizeInverted.y;
float dx=bakedVertexAnimationTextureSizeInverted.x;
vec4 m0=texture2D(smp,vec2(dx*(offset+0.5),frameUV));
vec4 m1=texture2D(smp,vec2(dx*(offset+1.5),frameUV));
vec4 m2=texture2D(smp,vec2(dx*(offset+2.5),frameUV));
vec4 m3=texture2D(smp,vec2(dx*(offset+3.5),frameUV));
return mat4(m0,m1,m2,m3);
}
#endif
`;Y.IncludesShadersStore[Ib]=Pb;const Mb="instancesDeclaration",Db=`#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#ifdef INSTANCESCOLOR
attribute vec4 instanceColor;
#endif
#if defined(THIN_INSTANCES) && !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
attribute vec4 previousWorld0;
attribute vec4 previousWorld1;
attribute vec4 previousWorld2;
attribute vec4 previousWorld3;
#ifdef THIN_INSTANCES
uniform mat4 previousWorld;
#endif
#endif
#else
#if !defined(WORLD_UBO)
uniform mat4 world;
#endif
#if defined(VELOCITY) || defined(PREPASS_VELOCITY)
uniform mat4 previousWorld;
#endif
#endif
`;Y.IncludesShadersStore[Mb]=Db;const Ob="prePassVertexDeclaration",wb=`#ifdef PREPASS
#ifdef PREPASS_DEPTH
varying vec3 vViewPos;
#endif
#ifdef PREPASS_VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#endif
`;Y.IncludesShadersStore[Ob]=wb;const Nb="samplerVertexDeclaration",Fb=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
varying vec2 v_VARYINGNAME_UV;
#endif
`;Y.IncludesShadersStore[Nb]=Fb;const Lb="bumpVertexDeclaration",Bb=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL) 
varying mat3 vTBN;
#endif
#endif
`;Y.IncludesShadersStore[Lb]=Bb;const Ub="clipPlaneVertexDeclaration",Vb=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
varying float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
varying float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
varying float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
varying float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
varying float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
varying float fClipDistance6;
#endif
`;Y.IncludesShadersStore[Ub]=Vb;const kb="fogVertexDeclaration",Gb=`#ifdef FOG
varying vec3 vFogDistance;
#endif
`;Y.IncludesShadersStore[kb]=Gb;const zb="lightVxFragmentDeclaration",Wb=`#ifdef LIGHT{X}
uniform vec4 vLightData{X};
uniform vec4 vLightDiffuse{X};
#ifdef SPECULARTERM
uniform vec4 vLightSpecular{X};
#else
vec4 vLightSpecular{X}=vec4(0.);
#endif
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
uniform vec4 shadowsInfo{X};
uniform vec2 depthValues{X};
#endif
#ifdef SPOTLIGHT{X}
uniform vec4 vLightDirection{X};
uniform vec4 vLightFalloff{X};
#elif defined(POINTLIGHT{X})
uniform vec4 vLightFalloff{X};
#elif defined(HEMILIGHT{X})
uniform vec3 vLightGround{X};
#endif
#endif
`;Y.IncludesShadersStore[zb]=Wb;const Hb="lightVxUboDeclaration",Xb=`#ifdef LIGHT{X}
uniform Light{X}
{
vec4 vLightData;
vec4 vLightDiffuse;
vec4 vLightSpecular;
#ifdef SPOTLIGHT{X}
vec4 vLightDirection;
vec4 vLightFalloff;
#elif defined(POINTLIGHT{X})
vec4 vLightFalloff;
#elif defined(HEMILIGHT{X})
vec3 vLightGround;
#endif
vec4 shadowsInfo;
vec2 depthValues;
} light{X};
#ifdef SHADOW{X}
#ifdef SHADOWCSM{X}
uniform mat4 lightMatrix{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromLight{X}[SHADOWCSMNUM_CASCADES{X}];
varying float vDepthMetric{X}[SHADOWCSMNUM_CASCADES{X}];
varying vec4 vPositionFromCamera{X};
#elif defined(SHADOWCUBE{X})
#else
varying vec4 vPositionFromLight{X};
varying float vDepthMetric{X};
uniform mat4 lightMatrix{X};
#endif
#endif
#endif
`;Y.IncludesShadersStore[Hb]=Xb;const Yb="morphTargetsVertexGlobalDeclaration",Kb=`#ifdef MORPHTARGETS
uniform float morphTargetInfluences[NUM_MORPH_INFLUENCERS];
#ifdef MORPHTARGETS_TEXTURE 
precision mediump sampler2DArray; 
uniform float morphTargetTextureIndices[NUM_MORPH_INFLUENCERS];
uniform vec3 morphTargetTextureInfo;
uniform sampler2DArray morphTargets;
vec3 readVector3FromRawSampler(int targetIndex,float vertexIndex)
{ 
float y=floor(vertexIndex/morphTargetTextureInfo.y);
float x=vertexIndex-y*morphTargetTextureInfo.y;
vec3 textureUV=vec3((x+0.5)/morphTargetTextureInfo.y,(y+0.5)/morphTargetTextureInfo.z,morphTargetTextureIndices[targetIndex]);
return texture(morphTargets,textureUV).xyz;
}
#endif
#endif
`;Y.IncludesShadersStore[Yb]=Kb;const $b="morphTargetsVertexDeclaration",jb=`#ifdef MORPHTARGETS
#ifndef MORPHTARGETS_TEXTURE
attribute vec3 position{X};
#ifdef MORPHTARGETS_NORMAL
attribute vec3 normal{X};
#endif
#ifdef MORPHTARGETS_TANGENT
attribute vec3 tangent{X};
#endif
#ifdef MORPHTARGETS_UV
attribute vec2 uv_{X};
#endif
#endif
#endif
`;Y.IncludesShadersStore[$b]=jb;const qb="morphTargetsVertexGlobal",Qb=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE
float vertexID;
#endif
#endif
`;Y.IncludesShadersStore[qb]=Qb;const Zb="morphTargetsVertex",Jb=`#ifdef MORPHTARGETS
#ifdef MORPHTARGETS_TEXTURE 
vertexID=float(gl_VertexID)*morphTargetTextureInfo.x;
positionUpdated+=(readVector3FromRawSampler({X},vertexID)-position)*morphTargetInfluences[{X}];
vertexID+=1.0;
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(readVector3FromRawSampler({X},vertexID) -normal)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(readVector3FromRawSampler({X},vertexID).xy-uv)*morphTargetInfluences[{X}];
vertexID+=1.0;
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(readVector3FromRawSampler({X},vertexID) -tangent.xyz)*morphTargetInfluences[{X}];
#endif
#else
positionUpdated+=(position{X}-position)*morphTargetInfluences[{X}];
#ifdef MORPHTARGETS_NORMAL
normalUpdated+=(normal{X}-normal)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_TANGENT
tangentUpdated.xyz+=(tangent{X}-tangent.xyz)*morphTargetInfluences[{X}];
#endif
#ifdef MORPHTARGETS_UV
uvUpdated+=(uv_{X}-uv)*morphTargetInfluences[{X}];
#endif
#endif
#endif
`;Y.IncludesShadersStore[Zb]=Jb;const eS="instancesVertex",tS=`#ifdef INSTANCES
mat4 finalWorld=mat4(world0,world1,world2,world3);
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=mat4(previousWorld0,previousWorld1,previousWorld2,previousWorld3);
#endif
#ifdef THIN_INSTANCES
finalWorld=world*finalWorld;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
finalPreviousWorld=previousWorld*finalPreviousWorld;
#endif
#endif
#else
mat4 finalWorld=world;
#if defined(PREPASS_VELOCITY) || defined(VELOCITY)
mat4 finalPreviousWorld=previousWorld;
#endif
#endif
`;Y.IncludesShadersStore[eS]=tS;const iS="bonesVertex",sS=`#ifndef BAKED_VERTEX_ANIMATION_TEXTURE
#if NUM_BONE_INFLUENCERS>0
mat4 influence;
#ifdef BONETEXTURE
influence=readMatrixFromRawSampler(boneSampler,matricesIndices[0])*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[1])*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[2])*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=readMatrixFromRawSampler(boneSampler,matricesIndices[3])*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[0])*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[1])*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[2])*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=readMatrixFromRawSampler(boneSampler,matricesIndicesExtra[3])*matricesWeightsExtra[3];
#endif
#else
influence=mBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
influence+=mBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
influence+=mBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
influence+=mBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
influence+=mBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
influence+=mBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
influence+=mBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
influence+=mBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
#endif
finalWorld=finalWorld*influence;
#endif
#endif
`;Y.IncludesShadersStore[iS]=sS;const rS="bakedVertexAnimation",nS=`#ifdef BAKED_VERTEX_ANIMATION_TEXTURE
{
#ifdef INSTANCES
#define BVASNAME bakedVertexAnimationSettingsInstanced
#else
#define BVASNAME bakedVertexAnimationSettings
#endif
float VATStartFrame=BVASNAME.x;
float VATEndFrame=BVASNAME.y;
float VATOffsetFrame=BVASNAME.z;
float VATSpeed=BVASNAME.w;
float totalFrames=VATEndFrame-VATStartFrame+1.0;
float time=bakedVertexAnimationTime*VATSpeed/totalFrames;
float frameCorrection=time<1.0 ? 0.0 : 1.0;
float numOfFrames=totalFrames-frameCorrection;
float VATFrameNum=fract(time)*numOfFrames;
VATFrameNum=mod(VATFrameNum+VATOffsetFrame,numOfFrames);
VATFrameNum=floor(VATFrameNum);
VATFrameNum+=VATStartFrame+frameCorrection;
mat4 VATInfluence;
VATInfluence=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[0],VATFrameNum)*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[1],VATFrameNum)*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[2],VATFrameNum)*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndices[3],VATFrameNum)*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[0],VATFrameNum)*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[1],VATFrameNum)*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[2],VATFrameNum)*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
VATInfluence+=readMatrixFromRawSamplerVAT(bakedVertexAnimationTexture,matricesIndicesExtra[3],VATFrameNum)*matricesWeightsExtra[3];
#endif
finalWorld=finalWorld*VATInfluence;
}
#endif
`;Y.IncludesShadersStore[rS]=nS;const aS="prePassVertex",oS=`#ifdef PREPASS_DEPTH
vViewPos=(view*worldPos).rgb;
#endif
#if defined(PREPASS_VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*worldPos;
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif 
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif 
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif 
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif 
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif 
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
`;Y.IncludesShadersStore[aS]=oS;const lS="uvVariableDeclaration",hS=`#if !defined(UV{X}) && defined(MAINUV{X})
vec2 uv{X}=vec2(0.,0.);
#endif
#ifdef MAINUV{X}
vMainUV{X}=uv{X};
#endif
`;Y.IncludesShadersStore[lS]=hS;const cS="samplerVertexImplementation",uS=`#if defined(_DEFINENAME_) && _DEFINENAME_DIRECTUV==0
if (v_INFONAME_==0.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uvUpdated,1.0,0.0));
}
#ifdef UV2
else if (v_INFONAME_==1.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv2,1.0,0.0));
}
#endif
#ifdef UV3
else if (v_INFONAME_==2.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv3,1.0,0.0));
}
#endif
#ifdef UV4
else if (v_INFONAME_==3.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv4,1.0,0.0));
}
#endif
#ifdef UV5
else if (v_INFONAME_==4.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv5,1.0,0.0));
}
#endif
#ifdef UV6
else if (v_INFONAME_==5.)
{
v_VARYINGNAME_UV=vec2(_MATRIXNAME_Matrix*vec4(uv6,1.0,0.0));
}
#endif
#endif
`;Y.IncludesShadersStore[cS]=uS;const dS="bumpVertex",fS=`#if defined(BUMP) || defined(PARALLAX) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#if defined(TANGENT) && defined(NORMAL)
vec3 tbnNormal=normalize(normalUpdated);
vec3 tbnTangent=normalize(tangentUpdated.xyz);
vec3 tbnBitangent=cross(tbnNormal,tbnTangent)*tangentUpdated.w;
vTBN=mat3(finalWorld)*mat3(tbnTangent,tbnBitangent,tbnNormal);
#endif
#endif
`;Y.IncludesShadersStore[dS]=fS;const pS="clipPlaneVertex",_S=`#ifdef CLIPPLANE
fClipDistance=dot(worldPos,vClipPlane);
#endif
#ifdef CLIPPLANE2
fClipDistance2=dot(worldPos,vClipPlane2);
#endif
#ifdef CLIPPLANE3
fClipDistance3=dot(worldPos,vClipPlane3);
#endif
#ifdef CLIPPLANE4
fClipDistance4=dot(worldPos,vClipPlane4);
#endif
#ifdef CLIPPLANE5
fClipDistance5=dot(worldPos,vClipPlane5);
#endif
#ifdef CLIPPLANE6
fClipDistance6=dot(worldPos,vClipPlane6);
#endif
`;Y.IncludesShadersStore[pS]=_S;const mS="fogVertex",gS=`#ifdef FOG
vFogDistance=(view*worldPos).xyz;
#endif
`;Y.IncludesShadersStore[mS]=gS;const vS="shadowsVertex",xS=`#ifdef SHADOWS
#if defined(SHADOWCSM{X})
vPositionFromCamera{X}=view*worldPos;
for (int i=0; i<SHADOWCSMNUM_CASCADES{X}; i++) {
vPositionFromLight{X}[i]=lightMatrix{X}[i]*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}[i]=(-vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}[i]=(vPositionFromLight{X}[i].z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
}
#elif defined(SHADOW{X}) && !defined(SHADOWCUBE{X})
vPositionFromLight{X}=lightMatrix{X}*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric{X}=(-vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#else
vDepthMetric{X}=(vPositionFromLight{X}.z+light{X}.depthValues.x)/light{X}.depthValues.y;
#endif
#endif
#endif
`;Y.IncludesShadersStore[vS]=xS;const TS="vertexColorMixing",bS=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
vColor=vec4(1.0);
#ifdef VERTEXCOLOR
#ifdef VERTEXALPHA
vColor*=color;
#else
vColor.rgb*=color.rgb;
#endif
#endif
#ifdef INSTANCESCOLOR
vColor*=instanceColor;
#endif
#endif
`;Y.IncludesShadersStore[TS]=bS;const SS="pointCloudVertex",ES=`#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
`;Y.IncludesShadersStore[SS]=ES;const CS="logDepthVertex",yS=`#ifdef LOGARITHMICDEPTH
vFragmentDepth=1.0+gl_Position.w;
gl_Position.z=log2(max(0.000001,vFragmentDepth))*logarithmicDepthConstant;
#endif
`;Y.IncludesShadersStore[CS]=yS;const AS="defaultVertexShader",RS=`#include<__decl__defaultVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<mainUVVaryingDeclaration>[1..7]
#include<samplerVertexDeclaration>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#if defined(SPECULARTERM)
#include<samplerVertexDeclaration>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular)
#endif
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
vPositionW=vec3(worldPos);
#include<prePassVertex>
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,DIFFUSE,_VARYINGNAME_,Diffuse,_MATRIXNAME_,diffuse,_INFONAME_,DiffuseInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#if defined(SPECULARTERM)
#include<samplerVertexImplementation>(_DEFINENAME_,SPECULAR,_VARYINGNAME_,Specular,_MATRIXNAME_,specular,_INFONAME_,SpecularInfos.x)
#endif
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#include<pointCloudVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}
`;Y.ShadersStore[AS]=RS;class Gn{constructor(e){this._plugins=[],this._activePlugins=[],this._activePluginsForExtraEvents=[],this._material=e,this._scene=e.getScene(),this._engine=this._scene.getEngine()}_addPlugin(e){for(let s=0;s<this._plugins.length;++s)if(this._plugins[s].name===e.name)throw`Plugin "${e.name}" already added to the material "${this._material.name}"!`;if(this._material._uniformBufferLayoutBuilt)throw`The plugin "${e.name}" can't be added to the material "${this._material.name}" because this material has already been used for rendering! Please add plugins to materials before any rendering with this material occurs.`;const t=e.getClassName();Gn._MaterialPluginClassToMainDefine[t]||(Gn._MaterialPluginClassToMainDefine[t]="MATERIALPLUGIN_"+ ++Gn._MaterialPluginCounter),this._material._callbackPluginEventGeneric=this._handlePluginEvent.bind(this),this._plugins.push(e),this._plugins.sort((s,r)=>s.priority-r.priority),this._codeInjectionPoints={};const i={};i[Gn._MaterialPluginClassToMainDefine[t]]={type:"boolean",default:!0};for(const s of this._plugins)s.collectDefines(i),this._collectPointNames("vertex",s.getCustomCode("vertex")),this._collectPointNames("fragment",s.getCustomCode("fragment"));this._defineNamesFromPlugins=i}_activatePlugin(e){this._activePlugins.indexOf(e)===-1&&(this._activePlugins.push(e),this._activePlugins.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventIsReadyForSubMesh=this._handlePluginEventIsReadyForSubMesh.bind(this),this._material._callbackPluginEventPrepareDefinesBeforeAttributes=this._handlePluginEventPrepareDefinesBeforeAttributes.bind(this),this._material._callbackPluginEventPrepareDefines=this._handlePluginEventPrepareDefines.bind(this),this._material._callbackPluginEventBindForSubMesh=this._handlePluginEventBindForSubMesh.bind(this),e.registerForExtraEvents&&(this._activePluginsForExtraEvents.push(e),this._activePluginsForExtraEvents.sort((t,i)=>t.priority-i.priority),this._material._callbackPluginEventHasRenderTargetTextures=this._handlePluginEventHasRenderTargetTextures.bind(this),this._material._callbackPluginEventFillRenderTargetTextures=this._handlePluginEventFillRenderTargetTextures.bind(this),this._material._callbackPluginEventHardBindForSubMesh=this._handlePluginEventHardBindForSubMesh.bind(this)))}getPlugin(e){for(let t=0;t<this._plugins.length;++t)if(this._plugins[t].name===e)return this._plugins[t];return null}_handlePluginEventIsReadyForSubMesh(e){let t=!0;for(const i of this._activePlugins)t=t&&i.isReadyForSubMesh(e.defines,this._scene,this._engine,e.subMesh);e.isReadyForSubMesh=t}_handlePluginEventPrepareDefinesBeforeAttributes(e){for(const t of this._activePlugins)t.prepareDefinesBeforeAttributes(e.defines,this._scene,e.mesh)}_handlePluginEventPrepareDefines(e){for(const t of this._activePlugins)t.prepareDefines(e.defines,this._scene,e.mesh)}_handlePluginEventHardBindForSubMesh(e){for(const t of this._activePluginsForExtraEvents)t.hardBindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventBindForSubMesh(e){for(const t of this._activePlugins)t.bindForSubMesh(this._material._uniformBuffer,this._scene,this._engine,e.subMesh)}_handlePluginEventHasRenderTargetTextures(e){let t=!1;for(const i of this._activePluginsForExtraEvents)if(t=i.hasRenderTargetTextures(),t)break;e.hasRenderTargetTextures=t}_handlePluginEventFillRenderTargetTextures(e){for(const t of this._activePluginsForExtraEvents)t.fillRenderTargetTextures(e.renderTargets)}_handlePluginEvent(e,t){switch(e){case Wi.GetActiveTextures:{const i=t;for(const s of this._activePlugins)s.getActiveTextures(i.activeTextures);break}case Wi.GetAnimatables:{const i=t;for(const s of this._activePlugins)s.getAnimatables(i.animatables);break}case Wi.HasTexture:{const i=t;let s=!1;for(const r of this._activePlugins)if(s=r.hasTexture(i.texture),s)break;i.hasTexture=s;break}case Wi.Disposed:{const i=t;for(const s of this._plugins)s.dispose(i.forceDisposeTextures);break}case Wi.GetDefineNames:{const i=t;i.defineNames=this._defineNamesFromPlugins;break}case Wi.PrepareEffect:{const i=t;for(const s of this._activePlugins)i.fallbackRank=s.addFallbacks(i.defines,i.fallbacks,i.fallbackRank),s.getAttributes(i.attributes,this._scene,i.mesh);this._uniformList.length>0&&i.uniforms.push(...this._uniformList),this._samplerList.length>0&&i.samplers.push(...this._samplerList),this._uboList.length>0&&i.uniformBuffersNames.push(...this._uboList),i.customCode=this._injectCustomCode(i.customCode);break}case Wi.PrepareUniformBuffer:{const i=t;this._uboDeclaration="",this._vertexDeclaration="",this._fragmentDeclaration="",this._uniformList=[],this._samplerList=[],this._uboList=[];for(const s of this._plugins){const r=s.getUniforms();if(r){if(r.ubo)for(const n of r.ubo)i.ubo.addUniform(n.name,n.size),this._uboDeclaration+=`${n.type} ${n.name};\r
`,this._uniformList.push(n.name);r.vertex&&(this._vertexDeclaration+=r.vertex+`\r
`),r.fragment&&(this._fragmentDeclaration+=r.fragment+`\r
`)}s.getSamplers(this._samplerList),s.getUniformBuffersNames(this._uboList)}break}}}_collectPointNames(e,t){if(!!t)for(const i in t)this._codeInjectionPoints[e]||(this._codeInjectionPoints[e]={}),this._codeInjectionPoints[e][i]=!0}_injectCustomCode(e){return(t,i)=>{var s;e&&(i=e(t,i)),this._uboDeclaration&&(i=i.replace("#define ADDITIONAL_UBO_DECLARATION",this._uboDeclaration)),this._vertexDeclaration&&(i=i.replace("#define ADDITIONAL_VERTEX_DECLARATION",this._vertexDeclaration)),this._fragmentDeclaration&&(i=i.replace("#define ADDITIONAL_FRAGMENT_DECLARATION",this._fragmentDeclaration));const r=(s=this._codeInjectionPoints)===null||s===void 0?void 0:s[t];if(!r)return i;for(const n in r){let o="";for(const l of this._activePlugins){const h=l.getCustomCode(t);h!=null&&h[n]&&(o+=h[n]+`\r
`)}if(o.length>0)if(n.charAt(0)==="!"){const l=new RegExp(n.substring(1),"g");let h=l.exec(i);for(;h!==null;){let c=o;for(let u=0;u<h.length;++u)c=c.replace("$"+u,h[u]);i=i.replace(h[0],c),h=l.exec(i)}}else{const l="#define "+n;i=i.replace(l,`\r
`+o+`\r
`+l)}}return i}}}Gn._MaterialPluginClassToMainDefine={};Gn._MaterialPluginCounter=0;class Zr{constructor(e,t,i,s,r=!0,n=!1){this.priority=500,this.registerForExtraEvents=!1,this._material=e,this.name=t,this.priority=i,e.pluginManager||(e.pluginManager=new Gn(e)),this._pluginDefineNames=s,this._pluginManager=e.pluginManager,r&&this._pluginManager._addPlugin(this),n&&this._enable(!0),this.markAllDefinesAsDirty=e._dirtyCallbacks[63]}_enable(e){e&&this._pluginManager._activatePlugin(this)}getClassName(){return"MaterialPluginBase"}isReadyForSubMesh(e,t,i,s){return!0}hardBindForSubMesh(e,t,i,s){}bindForSubMesh(e,t,i,s){}dispose(e){}getCustomCode(e){return null}collectDefines(e){if(!!this._pluginDefineNames)for(const t of Object.keys(this._pluginDefineNames)){if(t[0]==="_")continue;const i=typeof this._pluginDefineNames[t];e[t]={type:i==="number"?"number":i==="string"?"string":i==="boolean"?"boolean":"object",default:this._pluginDefineNames[t]}}}prepareDefinesBeforeAttributes(e,t,i){}prepareDefines(e,t,i){}hasTexture(e){return!1}hasRenderTargetTextures(){return!1}fillRenderTargetTextures(e){}getActiveTextures(e){}getAnimatables(e){}addFallbacks(e,t,i){return i}getSamplers(e){}getAttributes(e,t,i){}getUniformBuffersNames(e){}getUniforms(){return{}}copyTo(e){xe.Clone(()=>e,this)}serialize(){return xe.Serialize(this)}parse(e,t,i){xe.Parse(()=>this,e,t,i)}}T([R()],Zr.prototype,"name",void 0);T([R()],Zr.prototype,"priority",void 0);T([R()],Zr.prototype,"registerForExtraEvents",void 0);class IS extends rr{constructor(){super(...arguments),this.DETAIL=!1,this.DETAILDIRECTUV=0,this.DETAIL_NORMALBLENDMETHOD=0}}class ca extends Zr{constructor(e,t=!0){super(e,"DetailMap",140,new IS,t),this._texture=null,this.diffuseBlendLevel=1,this.roughnessBlendLevel=1,this.bumpLevel=1,this._normalBlendMethod=ne.MATERIAL_NORMALBLENDMETHOD_WHITEOUT,this._isEnabled=!1,this.isEnabled=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isReadyForSubMesh(e,t,i){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&i.getCaps().standardDerivatives&&this._texture&&ce.DetailTextureEnabled&&!this._texture.isReady()):!0}prepareDefines(e,t){if(this._isEnabled){e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod;const i=t.getEngine();e._areTexturesDirty&&(i.getCaps().standardDerivatives&&this._texture&&ce.DetailTextureEnabled&&this._isEnabled?(se.PrepareDefinesForMergedUV(this._texture,e,"DETAIL"),e.DETAIL_NORMALBLENDMETHOD=this._normalBlendMethod):e.DETAIL=!1)}else e.DETAIL=!1}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&this._texture&&ce.DetailTextureEnabled&&(e.updateFloat4("vDetailInfos",this._texture.coordinatesIndex,this.diffuseBlendLevel,this.bumpLevel,this.roughnessBlendLevel),se.BindTextureMatrix(this._texture,e,"detail")),t.texturesEnabled&&this._texture&&ce.DetailTextureEnabled&&e.setTexture("detailSampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){var t;e&&((t=this._texture)===null||t===void 0||t.dispose())}getClassName(){return"DetailMapConfiguration"}getSamplers(e){e.push("detailSampler")}getUniforms(){return{ubo:[{name:"vDetailInfos",size:4,type:"vec4"},{name:"detailMatrix",size:16,type:"mat4"}]}}}T([Qe("detailTexture"),ie("_markAllSubMeshesAsTexturesDirty")],ca.prototype,"texture",void 0);T([R()],ca.prototype,"diffuseBlendLevel",void 0);T([R()],ca.prototype,"roughnessBlendLevel",void 0);T([R()],ca.prototype,"bumpLevel",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],ca.prototype,"normalBlendMethod",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],ca.prototype,"isEnabled",void 0);const Iu={effect:null,subMesh:null};class PS extends rr{constructor(e){super(e),this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.OPACITY=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.REFLECTION=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.SPECULAR=!1,this.SPECULARDIRECTUV=0,this.BUMP=!1,this.BUMPDIRECTUV=0,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.SPECULAROVERALPHA=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHAFROMDIFFUSE=!1,this.POINTSIZE=!1,this.FOG=!1,this.SPECULARTERM=!1,this.DIFFUSEFRESNEL=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONFRESNEL=!1,this.REFRACTIONFRESNEL=!1,this.EMISSIVEFRESNEL=!1,this.FRESNEL=!1,this.NORMAL=!1,this.TANGENT=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.VERTEXCOLOR=!1,this.VERTEXALPHA=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.GLOSSINESS=!1,this.ROUGHNESS=!1,this.EMISSIVEASILLUMINATION=!1,this.LINKEMISSIVEWITHDIFFUSE=!1,this.REFLECTIONFRESNELFROMSPECULAR=!1,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.USELIGHTMAPASSHADOWMAP=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.INVERTCUBICMAP=!1,this.LOGARITHMICDEPTH=!1,this.REFRACTION=!1,this.REFRACTIONMAP_3D=!1,this.REFLECTIONOVERALPHA=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.NONUNIFORMSCALING=!1,this.PREMULTIPLYALPHA=!1,this.ALPHATEST_AFTERALLALPHACOMPUTATIONS=!1,this.ALPHABLEND=!0,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.RGBDLIGHTMAP=!1,this.RGBDREFLECTION=!1,this.RGBDREFRACTION=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.IS_REFLECTION_LINEAR=!1,this.IS_REFRACTION_LINEAR=!1,this.EXPOSURE=!1,this.rebuild()}setReflectionMode(e){const t=["REFLECTIONMAP_CUBIC","REFLECTIONMAP_EXPLICIT","REFLECTIONMAP_PLANAR","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_PROJECTION","REFLECTIONMAP_SKYBOX","REFLECTIONMAP_SPHERICAL","REFLECTIONMAP_EQUIRECTANGULAR","REFLECTIONMAP_EQUIRECTANGULAR_FIXED","REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"];for(const i of t)this[i]=i===e}}class pe extends zo{constructor(e,t){super(e,t),this._diffuseTexture=null,this._ambientTexture=null,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._specularTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._refractionTexture=null,this.ambientColor=new re(0,0,0),this.diffuseColor=new re(1,1,1),this.specularColor=new re(1,1,1),this.emissiveColor=new re(0,0,0),this.specularPower=64,this._useAlphaFromDiffuseTexture=!1,this._useEmissiveAsIllumination=!1,this._linkEmissiveWithDiffuse=!1,this._useSpecularOverAlpha=!1,this._useReflectionOverAlpha=!1,this._disableLighting=!1,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this._roughness=0,this.indexOfRefraction=.98,this.invertRefractionY=!0,this.alphaCutOff=.4,this._useLightmapAsShadowmap=!1,this._useReflectionFresnelFromSpecular=!1,this._useGlossinessFromSpecularMapAlpha=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._renderTargets=new mi(16),this._worldViewProjectionMatrix=L.Zero(),this._globalAmbientColor=new re(0,0,0),this._cacheHasRenderTargetTextures=!1,this.detailMap=new ca(this),this._attachImageProcessingConfiguration(null),this.prePassConfiguration=new Zh,this.getRenderTargetTextures=()=>(this._renderTargets.reset(),pe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),pe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&this._renderTargets.push(this._refractionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get isPrePassCapable(){return!this.disableDepthWrite}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}get canRenderToMRT(){return!0}get hasRenderTargetTextures(){return pe.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget||pe.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}getClassName(){return"StandardMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported,this._markAllSubMeshesAsMiscDirty()}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromDiffuseTexture()||this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled}needAlphaTesting(){return this._forceAlphaTest?!0:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===ne.MATERIAL_ALPHATEST)}_shouldUseAlphaFromDiffuseTexture(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha&&this._useAlphaFromDiffuseTexture&&this._transparencyMode!==ne.MATERIAL_OPAQUE}_hasAlphaChannel(){return this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._diffuseTexture}isReadyForSubMesh(e,t,i=!1){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Wi.GetDefineNames,this._eventInfo),t.materialDefines=new PS(this._eventInfo.defineNames));const s=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();r._needNormals=se.PrepareDefinesForLights(s,e,r,!0,this._maxSimultaneousLights,this._disableLighting),se.PrepareDefinesForMultiview(s,r);const o=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(s,r,this.canRenderToMRT&&!o),se.PrepareDefinesForOIT(s,r,o),r._areTexturesDirty){this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r._needUVs=!1;for(let l=1;l<=6;++l)r["MAINUV"+l]=!1;if(s.texturesEnabled){if(r.DIFFUSEDIRECTUV=0,r.BUMPDIRECTUV=0,r.AMBIENTDIRECTUV=0,r.OPACITYDIRECTUV=0,r.EMISSIVEDIRECTUV=0,r.SPECULARDIRECTUV=0,r.LIGHTMAPDIRECTUV=0,this._diffuseTexture&&pe.DiffuseTextureEnabled)if(this._diffuseTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE");else return!1;else r.DIFFUSE=!1;if(this._ambientTexture&&pe.AmbientTextureEnabled)if(this._ambientTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._ambientTexture,r,"AMBIENT");else return!1;else r.AMBIENT=!1;if(this._opacityTexture&&pe.OpacityTextureEnabled)if(this._opacityTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._opacityTexture,r,"OPACITY"),r.OPACITYRGB=this._opacityTexture.getAlphaFromRGB;else return!1;else r.OPACITY=!1;if(this._reflectionTexture&&pe.ReflectionTextureEnabled)if(this._reflectionTexture.isReadyOrNotBlocking()){switch(r._needNormals=!0,r.REFLECTION=!0,r.ROUGHNESS=this._roughness>0,r.REFLECTIONOVERALPHA=this._useReflectionOverAlpha,r.INVERTCUBICMAP=this._reflectionTexture.coordinatesMode===H.INVCUBIC_MODE,r.REFLECTIONMAP_3D=this._reflectionTexture.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!this._reflectionTexture.invertZ:this._reflectionTexture.invertZ,r.RGBDREFLECTION=this._reflectionTexture.isRGBD,this._reflectionTexture.coordinatesMode){case H.EXPLICIT_MODE:r.setReflectionMode("REFLECTIONMAP_EXPLICIT");break;case H.PLANAR_MODE:r.setReflectionMode("REFLECTIONMAP_PLANAR");break;case H.PROJECTION_MODE:r.setReflectionMode("REFLECTIONMAP_PROJECTION");break;case H.SKYBOX_MODE:r.setReflectionMode("REFLECTIONMAP_SKYBOX");break;case H.SPHERICAL_MODE:r.setReflectionMode("REFLECTIONMAP_SPHERICAL");break;case H.EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR");break;case H.FIXED_EQUIRECTANGULAR_MODE:r.setReflectionMode("REFLECTIONMAP_EQUIRECTANGULAR_FIXED");break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.setReflectionMode("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED");break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:r.setReflectionMode("REFLECTIONMAP_CUBIC");break}r.USE_LOCAL_REFLECTIONMAP_CUBIC=!!this._reflectionTexture.boundingBoxSize}else return!1;else r.REFLECTION=!1,r.REFLECTIONMAP_OPPOSITEZ=!1;if(this._emissiveTexture&&pe.EmissiveTextureEnabled)if(this._emissiveTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._emissiveTexture,r,"EMISSIVE");else return!1;else r.EMISSIVE=!1;if(this._lightmapTexture&&pe.LightmapTextureEnabled)if(this._lightmapTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._lightmapTexture,r,"LIGHTMAP"),r.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,r.RGBDLIGHTMAP=this._lightmapTexture.isRGBD;else return!1;else r.LIGHTMAP=!1;if(this._specularTexture&&pe.SpecularTextureEnabled)if(this._specularTexture.isReadyOrNotBlocking())se.PrepareDefinesForMergedUV(this._specularTexture,r,"SPECULAR"),r.GLOSSINESS=this._useGlossinessFromSpecularMapAlpha;else return!1;else r.SPECULAR=!1;if(s.getEngine().getCaps().standardDerivatives&&this._bumpTexture&&pe.BumpTextureEnabled){if(this._bumpTexture.isReady())se.PrepareDefinesForMergedUV(this._bumpTexture,r,"BUMP"),r.PARALLAX=this._useParallax,r.PARALLAXOCCLUSION=this._useParallaxOcclusion;else return!1;r.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap}else r.BUMP=!1,r.PARALLAX=!1,r.PARALLAXOCCLUSION=!1;if(this._refractionTexture&&pe.RefractionTextureEnabled)if(this._refractionTexture.isReadyOrNotBlocking())r._needUVs=!0,r.REFRACTION=!0,r.REFRACTIONMAP_3D=this._refractionTexture.isCube,r.RGBDREFRACTION=this._refractionTexture.isRGBD,r.USE_LOCAL_REFRACTIONMAP_CUBIC=!!this._refractionTexture.boundingBoxSize;else return!1;else r.REFRACTION=!1;r.TWOSIDEDLIGHTING=!this._backFaceCulling&&this._twoSidedLighting}else r.DIFFUSE=!1,r.AMBIENT=!1,r.OPACITY=!1,r.REFLECTION=!1,r.EMISSIVE=!1,r.LIGHTMAP=!1,r.BUMP=!1,r.REFRACTION=!1;r.ALPHAFROMDIFFUSE=this._shouldUseAlphaFromDiffuseTexture(),r.EMISSIVEASILLUMINATION=this._useEmissiveAsIllumination,r.LINKEMISSIVEWITHDIFFUSE=this._linkEmissiveWithDiffuse,r.SPECULAROVERALPHA=this._useSpecularOverAlpha,r.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,r.ALPHATEST_AFTERALLALPHACOMPUTATIONS=this.transparencyMode!==null,r.ALPHABLEND=this.transparencyMode===null||this.needAlphaBlendingForMesh(e)}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=r,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh)return!1;if(r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r),r.IS_REFLECTION_LINEAR=this.reflectionTexture!=null&&!this.reflectionTexture.gammaSpace,r.IS_REFRACTION_LINEAR=this.refractionTexture!=null&&!this.refractionTexture.gammaSpace}if(r._areFresnelDirty&&(pe.FresnelEnabled?(this._diffuseFresnelParameters||this._opacityFresnelParameters||this._emissiveFresnelParameters||this._refractionFresnelParameters||this._reflectionFresnelParameters)&&(r.DIFFUSEFRESNEL=this._diffuseFresnelParameters&&this._diffuseFresnelParameters.isEnabled,r.OPACITYFRESNEL=this._opacityFresnelParameters&&this._opacityFresnelParameters.isEnabled,r.REFLECTIONFRESNEL=this._reflectionFresnelParameters&&this._reflectionFresnelParameters.isEnabled,r.REFLECTIONFRESNELFROMSPECULAR=this._useReflectionFresnelFromSpecular,r.REFRACTIONFRESNEL=this._refractionFresnelParameters&&this._refractionFresnelParameters.isEnabled,r.EMISSIVEFRESNEL=this._emissiveFresnelParameters&&this._emissiveFresnelParameters.isEnabled,r._needNormals=!0,r.FRESNEL=!0):r.FRESNEL=!1),se.PrepareDefinesForMisc(e,s,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,r),se.PrepareDefinesForFrameBoundValues(s,n,r,i,null,t.getRenderingMesh().hasThinInstances),this._eventInfo.defines=r,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(e,r,!0,!0,!0),this._callbackPluginEventPrepareDefines(this._eventInfo),r.isDirty){const l=r._areLightsDisposed;r.markAsProcessed();const h=new Wa;r.REFLECTION&&h.addFallback(0,"REFLECTION"),r.SPECULAR&&h.addFallback(0,"SPECULAR"),r.BUMP&&h.addFallback(0,"BUMP"),r.PARALLAX&&h.addFallback(1,"PARALLAX"),r.PARALLAXOCCLUSION&&h.addFallback(0,"PARALLAXOCCLUSION"),r.SPECULAROVERALPHA&&h.addFallback(0,"SPECULAROVERALPHA"),r.FOG&&h.addFallback(1,"FOG"),r.POINTSIZE&&h.addFallback(0,"POINTSIZE"),r.LOGARITHMICDEPTH&&h.addFallback(0,"LOGARITHMICDEPTH"),se.HandleFallbacksForShadows(r,h,this._maxSimultaneousLights),r.SPECULARTERM&&h.addFallback(0,"SPECULARTERM"),r.DIFFUSEFRESNEL&&h.addFallback(1,"DIFFUSEFRESNEL"),r.OPACITYFRESNEL&&h.addFallback(2,"OPACITYFRESNEL"),r.REFLECTIONFRESNEL&&h.addFallback(3,"REFLECTIONFRESNEL"),r.EMISSIVEFRESNEL&&h.addFallback(4,"EMISSIVEFRESNEL"),r.FRESNEL&&h.addFallback(4,"FRESNEL"),r.MULTIVIEW&&h.addFallback(0,"MULTIVIEW");const c=[y.PositionKind];r.NORMAL&&c.push(y.NormalKind),r.TANGENT&&c.push(y.TangentKind);for(let b=1;b<=6;++b)r["UV"+b]&&c.push(`uv${b===1?"":b}`);r.VERTEXCOLOR&&c.push(y.ColorKind),se.PrepareAttributesForBones(c,e,r,h),se.PrepareAttributesForInstances(c,r),se.PrepareAttributesForMorphTargets(c,e,r),se.PrepareAttributesForBakedVertexAnimation(c,e,r);let u="default";const d=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vDiffuseColor","vSpecularColor","vEmissiveColor","visibility","vFogInfos","vFogColor","pointSize","vDiffuseInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vEmissiveInfos","vSpecularInfos","vBumpInfos","vLightmapInfos","vRefractionInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","diffuseMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","specularMatrix","bumpMatrix","normalMatrix","lightmapMatrix","refractionMatrix","diffuseLeftColor","diffuseRightColor","opacityParts","reflectionLeftColor","reflectionRightColor","emissiveLeftColor","emissiveRightColor","refractionLeftColor","refractionRightColor","vReflectionPosition","vReflectionSize","vRefractionPosition","vRefractionSize","logarithmicDepthConstant","vTangentSpaceParams","alphaCutOff","boneTextureWidth","morphTargetTextureInfo","morphTargetTextureIndices"],f=["diffuseSampler","ambientSampler","opacitySampler","reflectionCubeSampler","reflection2DSampler","emissiveSampler","specularSampler","bumpSampler","lightmapSampler","refractionCubeSampler","refraction2DSampler","boneSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],p=["Material","Scene","Mesh"];this._eventInfo.fallbacks=h,this._eventInfo.fallbackRank=0,this._eventInfo.defines=r,this._eventInfo.uniforms=d,this._eventInfo.attributes=c,this._eventInfo.samplers=f,this._eventInfo.uniformBuffersNames=p,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Wi.PrepareEffect,this._eventInfo),Zh.AddUniforms(d),qe&&(qe.PrepareUniforms(d,r),qe.PrepareSamplers(f,r)),se.PrepareUniformsAndSamplersList({uniformsNames:d,uniformBuffersNames:p,samplers:f,defines:r,maxSimultaneousLights:this._maxSimultaneousLights});const _={};this.customShaderNameResolve&&(u=this.customShaderNameResolve(u,d,p,f,r,c,_));const m=r.toString(),v=t.effect;let x=s.getEngine().createEffect(u,{attributes:c,uniformsNames:d,uniformBuffersNames:p,samplers:f,defines:m,fallbacks:h,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:r.NUM_MORPH_INFLUENCERS},processFinalCode:_.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:r.PREPASS},n);if(x)if(this._onEffectCreatedObservable&&(Iu.effect=x,Iu.subMesh=t,this._onEffectCreatedObservable.notifyObservers(Iu)),this.allowShaderHotSwapping&&v&&!x.isReady()){if(x=v,r.markAsUnprocessed(),l)return r._areLightsDisposed=!0,!1}else s.resetCachedMaterial(),t.setEffect(x,r,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,s.performancePriority!==Qs.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("diffuseLeftColor",4),e.addUniform("diffuseRightColor",4),e.addUniform("opacityParts",4),e.addUniform("reflectionLeftColor",4),e.addUniform("reflectionRightColor",4),e.addUniform("refractionLeftColor",4),e.addUniform("refractionRightColor",4),e.addUniform("emissiveLeftColor",4),e.addUniform("emissiveRightColor",4),e.addUniform("vDiffuseInfos",2),e.addUniform("vAmbientInfos",2),e.addUniform("vOpacityInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vSpecularInfos",2),e.addUniform("vBumpInfos",3),e.addUniform("diffuseMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("reflectionMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("specularMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("pointSize",1),e.addUniform("alphaCutOff",1),e.addUniform("refractionMatrix",16),e.addUniform("vRefractionInfos",4),e.addUniform("vRefractionPosition",3),e.addUniform("vRefractionSize",3),e.addUniform("vSpecularColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vDiffuseColor",4),e.addUniform("vAmbientColor",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s;const r=this.getScene(),n=i.materialDefines;if(!n)return;const o=i.effect;if(!o)return;this._activeEffect=o,t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e),this._uniformBuffer.bindToEffect(o,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,r,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),n.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const l=this._mustRebind(r,o,t.visibility);se.BindBonesParameters(t,o);const h=this._uniformBuffer;if(l){if(this.bindViewProjection(o),!h.useUbo||!this.isFrozen||!h.isSync){if(pe.FresnelEnabled&&n.FRESNEL&&(this.diffuseFresnelParameters&&this.diffuseFresnelParameters.isEnabled&&(h.updateColor4("diffuseLeftColor",this.diffuseFresnelParameters.leftColor,this.diffuseFresnelParameters.power),h.updateColor4("diffuseRightColor",this.diffuseFresnelParameters.rightColor,this.diffuseFresnelParameters.bias)),this.opacityFresnelParameters&&this.opacityFresnelParameters.isEnabled&&h.updateColor4("opacityParts",new re(this.opacityFresnelParameters.leftColor.toLuminance(),this.opacityFresnelParameters.rightColor.toLuminance(),this.opacityFresnelParameters.bias),this.opacityFresnelParameters.power),this.reflectionFresnelParameters&&this.reflectionFresnelParameters.isEnabled&&(h.updateColor4("reflectionLeftColor",this.reflectionFresnelParameters.leftColor,this.reflectionFresnelParameters.power),h.updateColor4("reflectionRightColor",this.reflectionFresnelParameters.rightColor,this.reflectionFresnelParameters.bias)),this.refractionFresnelParameters&&this.refractionFresnelParameters.isEnabled&&(h.updateColor4("refractionLeftColor",this.refractionFresnelParameters.leftColor,this.refractionFresnelParameters.power),h.updateColor4("refractionRightColor",this.refractionFresnelParameters.rightColor,this.refractionFresnelParameters.bias)),this.emissiveFresnelParameters&&this.emissiveFresnelParameters.isEnabled&&(h.updateColor4("emissiveLeftColor",this.emissiveFresnelParameters.leftColor,this.emissiveFresnelParameters.power),h.updateColor4("emissiveRightColor",this.emissiveFresnelParameters.rightColor,this.emissiveFresnelParameters.bias))),r.texturesEnabled){if(this._diffuseTexture&&pe.DiffuseTextureEnabled&&(h.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),se.BindTextureMatrix(this._diffuseTexture,h,"diffuse")),this._ambientTexture&&pe.AmbientTextureEnabled&&(h.updateFloat2("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level),se.BindTextureMatrix(this._ambientTexture,h,"ambient")),this._opacityTexture&&pe.OpacityTextureEnabled&&(h.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,h,"opacity")),this._hasAlphaChannel()&&h.updateFloat("alphaCutOff",this.alphaCutOff),this._reflectionTexture&&pe.ReflectionTextureEnabled&&(h.updateFloat2("vReflectionInfos",this._reflectionTexture.level,this.roughness),h.updateMatrix("reflectionMatrix",this._reflectionTexture.getReflectionTextureMatrix()),this._reflectionTexture.boundingBoxSize)){const c=this._reflectionTexture;h.updateVector3("vReflectionPosition",c.boundingBoxPosition),h.updateVector3("vReflectionSize",c.boundingBoxSize)}if(this._emissiveTexture&&pe.EmissiveTextureEnabled&&(h.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,h,"emissive")),this._lightmapTexture&&pe.LightmapTextureEnabled&&(h.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,h,"lightmap")),this._specularTexture&&pe.SpecularTextureEnabled&&(h.updateFloat2("vSpecularInfos",this._specularTexture.coordinatesIndex,this._specularTexture.level),se.BindTextureMatrix(this._specularTexture,h,"specular")),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&pe.BumpTextureEnabled&&(h.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,1/this._bumpTexture.level,this.parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,h,"bump"),r._mirroredCameraPosition?h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):h.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1)),this._refractionTexture&&pe.RefractionTextureEnabled){let c=1;if(this._refractionTexture.isCube||(h.updateMatrix("refractionMatrix",this._refractionTexture.getReflectionTextureMatrix()),this._refractionTexture.depth&&(c=this._refractionTexture.depth)),h.updateFloat4("vRefractionInfos",this._refractionTexture.level,this.indexOfRefraction,c,this.invertRefractionY?-1:1),this._refractionTexture.boundingBoxSize){const u=this._refractionTexture;h.updateVector3("vRefractionPosition",u.boundingBoxPosition),h.updateVector3("vRefractionSize",u.boundingBoxSize)}}}this.pointsCloud&&h.updateFloat("pointSize",this.pointSize),n.SPECULARTERM&&h.updateColor4("vSpecularColor",this.specularColor,this.specularPower),h.updateColor3("vEmissiveColor",pe.EmissiveTextureEnabled?this.emissiveColor:re.BlackReadOnly),h.updateColor4("vDiffuseColor",this.diffuseColor,this.alpha),r.ambientColor.multiplyToRef(this.ambientColor,this._globalAmbientColor),h.updateColor3("vAmbientColor",this._globalAmbientColor)}r.texturesEnabled&&(this._diffuseTexture&&pe.DiffuseTextureEnabled&&o.setTexture("diffuseSampler",this._diffuseTexture),this._ambientTexture&&pe.AmbientTextureEnabled&&o.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&pe.OpacityTextureEnabled&&o.setTexture("opacitySampler",this._opacityTexture),this._reflectionTexture&&pe.ReflectionTextureEnabled&&(this._reflectionTexture.isCube?o.setTexture("reflectionCubeSampler",this._reflectionTexture):o.setTexture("reflection2DSampler",this._reflectionTexture)),this._emissiveTexture&&pe.EmissiveTextureEnabled&&o.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&pe.LightmapTextureEnabled&&o.setTexture("lightmapSampler",this._lightmapTexture),this._specularTexture&&pe.SpecularTextureEnabled&&o.setTexture("specularSampler",this._specularTexture),this._bumpTexture&&r.getEngine().getCaps().standardDerivatives&&pe.BumpTextureEnabled&&o.setTexture("bumpSampler",this._bumpTexture),this._refractionTexture&&pe.RefractionTextureEnabled&&(this._refractionTexture.isCube?o.setTexture("refractionCubeSampler",this._refractionTexture):o.setTexture("refraction2DSampler",this._refractionTexture))),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(o),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),se.BindClipPlane(o,r),this.bindEyePosition(o)}else r.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(l||!this.isFrozen)&&(r.lightsEnabled&&!this._disableLighting&&se.BindLights(r,t,o,n,this._maxSimultaneousLights),(r.fogEnabled&&t.applyFog&&r.fogMode!==ge.FOGMODE_NONE||this._reflectionTexture||this._refractionTexture||t.receiveShadows||n.PREPASS)&&this.bindView(o),se.BindFogParameters(r,t,o),n.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(t,o),n.BAKED_VERTEX_ANIMATION_TEXTURE&&((s=t.bakedVertexAnimationManager)===null||s===void 0||s.bind(o,n.INSTANCES)),this.useLogarithmicDepth&&se.BindLogDepth(n,o,r),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),h.update()}getAnimatables(){const e=super.getAnimatables();return this._diffuseTexture&&this._diffuseTexture.animations&&this._diffuseTexture.animations.length>0&&e.push(this._diffuseTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._specularTexture&&this._specularTexture.animations&&this._specularTexture.animations.length>0&&e.push(this._specularTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture),e}getActiveTextures(){const e=super.getActiveTextures();return this._diffuseTexture&&e.push(this._diffuseTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._specularTexture&&e.push(this._specularTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),this._refractionTexture&&e.push(this._refractionTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._diffuseTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._emissiveTexture===e||this._specularTexture===e||this._bumpTexture===e||this._lightmapTexture===e||this._refractionTexture===e)}dispose(e,t){var i,s,r,n,o,l,h,c,u;t&&((i=this._diffuseTexture)===null||i===void 0||i.dispose(),(s=this._ambientTexture)===null||s===void 0||s.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(o=this._emissiveTexture)===null||o===void 0||o.dispose(),(l=this._specularTexture)===null||l===void 0||l.dispose(),(h=this._bumpTexture)===null||h===void 0||h.dispose(),(c=this._lightmapTexture)===null||c===void 0||c.dispose(),(u=this._refractionTexture)===null||u===void 0||u.dispose()),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}clone(e){const t=xe.Clone(()=>new pe(e,this.getScene()),this);return t.name=e,t.id=e,this.stencil.copyTo(t.stencil),t}static Parse(e,t,i){const s=xe.Parse(()=>new pe(e.name,t),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),s}static get DiffuseTextureEnabled(){return ce.DiffuseTextureEnabled}static set DiffuseTextureEnabled(e){ce.DiffuseTextureEnabled=e}static get DetailTextureEnabled(){return ce.DetailTextureEnabled}static set DetailTextureEnabled(e){ce.DetailTextureEnabled=e}static get AmbientTextureEnabled(){return ce.AmbientTextureEnabled}static set AmbientTextureEnabled(e){ce.AmbientTextureEnabled=e}static get OpacityTextureEnabled(){return ce.OpacityTextureEnabled}static set OpacityTextureEnabled(e){ce.OpacityTextureEnabled=e}static get ReflectionTextureEnabled(){return ce.ReflectionTextureEnabled}static set ReflectionTextureEnabled(e){ce.ReflectionTextureEnabled=e}static get EmissiveTextureEnabled(){return ce.EmissiveTextureEnabled}static set EmissiveTextureEnabled(e){ce.EmissiveTextureEnabled=e}static get SpecularTextureEnabled(){return ce.SpecularTextureEnabled}static set SpecularTextureEnabled(e){ce.SpecularTextureEnabled=e}static get BumpTextureEnabled(){return ce.BumpTextureEnabled}static set BumpTextureEnabled(e){ce.BumpTextureEnabled=e}static get LightmapTextureEnabled(){return ce.LightmapTextureEnabled}static set LightmapTextureEnabled(e){ce.LightmapTextureEnabled=e}static get RefractionTextureEnabled(){return ce.RefractionTextureEnabled}static set RefractionTextureEnabled(e){ce.RefractionTextureEnabled=e}static get ColorGradingTextureEnabled(){return ce.ColorGradingTextureEnabled}static set ColorGradingTextureEnabled(e){ce.ColorGradingTextureEnabled=e}static get FresnelEnabled(){return ce.FresnelEnabled}static set FresnelEnabled(e){ce.FresnelEnabled=e}}T([Qe("diffuseTexture")],pe.prototype,"_diffuseTexture",void 0);T([ie("_markAllSubMeshesAsTexturesAndMiscDirty")],pe.prototype,"diffuseTexture",void 0);T([Qe("ambientTexture")],pe.prototype,"_ambientTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"ambientTexture",void 0);T([Qe("opacityTexture")],pe.prototype,"_opacityTexture",void 0);T([ie("_markAllSubMeshesAsTexturesAndMiscDirty")],pe.prototype,"opacityTexture",void 0);T([Qe("reflectionTexture")],pe.prototype,"_reflectionTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"reflectionTexture",void 0);T([Qe("emissiveTexture")],pe.prototype,"_emissiveTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"emissiveTexture",void 0);T([Qe("specularTexture")],pe.prototype,"_specularTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"specularTexture",void 0);T([Qe("bumpTexture")],pe.prototype,"_bumpTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"bumpTexture",void 0);T([Qe("lightmapTexture")],pe.prototype,"_lightmapTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"lightmapTexture",void 0);T([Qe("refractionTexture")],pe.prototype,"_refractionTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"refractionTexture",void 0);T([pi("ambient")],pe.prototype,"ambientColor",void 0);T([pi("diffuse")],pe.prototype,"diffuseColor",void 0);T([pi("specular")],pe.prototype,"specularColor",void 0);T([pi("emissive")],pe.prototype,"emissiveColor",void 0);T([R()],pe.prototype,"specularPower",void 0);T([R("useAlphaFromDiffuseTexture")],pe.prototype,"_useAlphaFromDiffuseTexture",void 0);T([ie("_markAllSubMeshesAsTexturesAndMiscDirty")],pe.prototype,"useAlphaFromDiffuseTexture",void 0);T([R("useEmissiveAsIllumination")],pe.prototype,"_useEmissiveAsIllumination",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useEmissiveAsIllumination",void 0);T([R("linkEmissiveWithDiffuse")],pe.prototype,"_linkEmissiveWithDiffuse",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"linkEmissiveWithDiffuse",void 0);T([R("useSpecularOverAlpha")],pe.prototype,"_useSpecularOverAlpha",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useSpecularOverAlpha",void 0);T([R("useReflectionOverAlpha")],pe.prototype,"_useReflectionOverAlpha",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useReflectionOverAlpha",void 0);T([R("disableLighting")],pe.prototype,"_disableLighting",void 0);T([ie("_markAllSubMeshesAsLightsDirty")],pe.prototype,"disableLighting",void 0);T([R("useObjectSpaceNormalMap")],pe.prototype,"_useObjectSpaceNormalMap",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useObjectSpaceNormalMap",void 0);T([R("useParallax")],pe.prototype,"_useParallax",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useParallax",void 0);T([R("useParallaxOcclusion")],pe.prototype,"_useParallaxOcclusion",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useParallaxOcclusion",void 0);T([R()],pe.prototype,"parallaxScaleBias",void 0);T([R("roughness")],pe.prototype,"_roughness",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"roughness",void 0);T([R()],pe.prototype,"indexOfRefraction",void 0);T([R()],pe.prototype,"invertRefractionY",void 0);T([R()],pe.prototype,"alphaCutOff",void 0);T([R("useLightmapAsShadowmap")],pe.prototype,"_useLightmapAsShadowmap",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useLightmapAsShadowmap",void 0);T([Hl("diffuseFresnelParameters")],pe.prototype,"_diffuseFresnelParameters",void 0);T([ie("_markAllSubMeshesAsFresnelDirty")],pe.prototype,"diffuseFresnelParameters",void 0);T([Hl("opacityFresnelParameters")],pe.prototype,"_opacityFresnelParameters",void 0);T([ie("_markAllSubMeshesAsFresnelAndMiscDirty")],pe.prototype,"opacityFresnelParameters",void 0);T([Hl("reflectionFresnelParameters")],pe.prototype,"_reflectionFresnelParameters",void 0);T([ie("_markAllSubMeshesAsFresnelDirty")],pe.prototype,"reflectionFresnelParameters",void 0);T([Hl("refractionFresnelParameters")],pe.prototype,"_refractionFresnelParameters",void 0);T([ie("_markAllSubMeshesAsFresnelDirty")],pe.prototype,"refractionFresnelParameters",void 0);T([Hl("emissiveFresnelParameters")],pe.prototype,"_emissiveFresnelParameters",void 0);T([ie("_markAllSubMeshesAsFresnelDirty")],pe.prototype,"emissiveFresnelParameters",void 0);T([R("useReflectionFresnelFromSpecular")],pe.prototype,"_useReflectionFresnelFromSpecular",void 0);T([ie("_markAllSubMeshesAsFresnelDirty")],pe.prototype,"useReflectionFresnelFromSpecular",void 0);T([R("useGlossinessFromSpecularMapAlpha")],pe.prototype,"_useGlossinessFromSpecularMapAlpha",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"useGlossinessFromSpecularMapAlpha",void 0);T([R("maxSimultaneousLights")],pe.prototype,"_maxSimultaneousLights",void 0);T([ie("_markAllSubMeshesAsLightsDirty")],pe.prototype,"maxSimultaneousLights",void 0);T([R("invertNormalMapX")],pe.prototype,"_invertNormalMapX",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"invertNormalMapX",void 0);T([R("invertNormalMapY")],pe.prototype,"_invertNormalMapY",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"invertNormalMapY",void 0);T([R("twoSidedLighting")],pe.prototype,"_twoSidedLighting",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],pe.prototype,"twoSidedLighting",void 0);T([R()],pe.prototype,"useLogarithmicDepth",null);he("BABYLON.StandardMaterial",pe);ge.DefaultMaterialFactory=a=>new pe("default material",a);Te.prototype.createDynamicTexture=function(a,e,t,i){const s=new gt(this,We.Dynamic);return s.baseWidth=a,s.baseHeight=e,t&&(a=this.needPOTTextures?Te.GetExponentOfTwo(a,this._caps.maxTextureSize):a,e=this.needPOTTextures?Te.GetExponentOfTwo(e,this._caps.maxTextureSize):e),s.width=a,s.height=e,s.isReady=!1,s.generateMipMaps=t,s.samplingMode=i,this.updateTextureSamplingMode(i,s),this._internalTexturesCache.push(s),s};Te.prototype.updateDynamicTexture=function(a,e,t,i=!1,s,r=!1,n=!1){if(!a)return;const o=this._gl,l=o.TEXTURE_2D,h=this._bindTextureDirectly(l,a,!0,r);this._unpackFlipY(t===void 0?a.invertY:t),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1);const c=this._getWebGLTextureType(a.type),u=this._getInternalFormat(s||a.format),d=this._getRGBABufferInternalSizedFormat(a.type,u);o.texImage2D(l,0,d,u,c,e),a.generateMipMaps&&o.generateMipmap(l),h||this._bindTextureDirectly(l,null),i&&o.pixelStorei(o.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),a.isReady=!0};class ta extends H{constructor(e,t,i=null,s=!1,r=3,n=5,o){super(null,i,!s,o,r,void 0,void 0,void 0,void 0,n),this.name=e,this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE,this._generateMipMaps=s;const l=this._getEngine();if(!l)return;t.getContext?(this._canvas=t,this._texture=l.createDynamicTexture(t.width,t.height,s,r)):(this._canvas=l.createCanvas(1,1),t.width||t.width===0?this._texture=l.createDynamicTexture(t.width,t.height,s,r):this._texture=l.createDynamicTexture(t,t,s,r));const h=this.getSize();this._canvas.width!==h.width&&(this._canvas.width=h.width),this._canvas.height!==h.height&&(this._canvas.height=h.height),this._context=this._canvas.getContext("2d")}getClassName(){return"DynamicTexture"}get canRescale(){return!0}_recreate(e){this._canvas.width=e.width,this._canvas.height=e.height,this.releaseInternalTexture(),this._texture=this._getEngine().createDynamicTexture(e.width,e.height,this._generateMipMaps,this.samplingMode)}scale(e){const t=this.getSize();t.width*=e,t.height*=e,this._recreate(t)}scaleTo(e,t){const i=this.getSize();i.width=e,i.height=t,this._recreate(i)}getContext(){return this._context}clear(){const e=this.getSize();this._context.fillRect(0,0,e.width,e.height)}update(e,t=!1,i=!1){this._getEngine().updateDynamicTexture(this._texture,this._canvas,e===void 0?!0:e,t,this._format||void 0,void 0,i)}drawText(e,t,i,s,r,n,o,l=!0){const h=this.getSize();if(n&&(this._context.fillStyle=n,this._context.fillRect(0,0,h.width,h.height)),this._context.font=s,t==null){const c=this._context.measureText(e);t=(h.width-c.width)/2}if(i==null){const c=parseInt(s.replace(/\D/g,""));i=h.height/2+c/3.65}this._context.fillStyle=r||"",this._context.fillText(e,t,i),l&&this.update(o)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new ta(this.name,t,e,this._generateMipMaps);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.wrapU=this.wrapU,i.wrapV=this.wrapV,i}serialize(){const e=this.getScene();e&&!e.isReady()&&B.Warn("The scene must be ready before serializing the dynamic texture");const t=super.serialize();return ta._IsCanvasElement(this._canvas)&&(t.base64String=this._canvas.toDataURL()),t.invertY=this._invertY,t.samplingMode=this.samplingMode,t}static _IsCanvasElement(e){return e.toDataURL!==void 0}_rebuild(){this.update()}}const MS="imageProcessingPixelShader",DS=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<imageProcessingDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 result=texture2D(textureSampler,vUV);
#ifdef IMAGEPROCESSING
#ifndef FROMLINEARSPACE
result.rgb=toLinearSpace(result.rgb);
#endif
result=applyImageProcessing(result);
#else
#ifdef FROMLINEARSPACE
result=applyImageProcessing(result);
#endif
#endif
gl_FragColor=result;
}`;Y.ShadersStore[MS]=DS;class kc extends Fe{constructor(e,t,i=null,s,r,n,o=0,l){super(e,"imageProcessing",[],[],t,i,s,r,n,null,o,"postprocess",null,!0),this._fromLinearSpace=!0,this._defines={IMAGEPROCESSING:!1,VIGNETTE:!1,VIGNETTEBLENDMODEMULTIPLY:!1,VIGNETTEBLENDMODEOPAQUE:!1,TONEMAPPING:!1,TONEMAPPING_ACES:!1,CONTRAST:!1,COLORCURVES:!1,COLORGRADING:!1,COLORGRADING3D:!1,FROMLINEARSPACE:!1,SAMPLER3DGREENDEPTH:!1,SAMPLER3DBGRMAP:!1,DITHER:!1,IMAGEPROCESSINGPOSTPROCESS:!1,EXPOSURE:!1,SKIPFINALCOLORCLAMP:!1},l?(l.applyByPostProcess=!0,this._attachImageProcessingConfiguration(l,!0),this._updateParameters()):(this._attachImageProcessingConfiguration(null,!0),this.imageProcessingConfiguration.applyByPostProcess=!0),this.onApply=h=>{this.imageProcessingConfiguration.bind(h,this.aspectRatio)}}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){e.applyByPostProcess=!0,this._attachImageProcessingConfiguration(e)}_attachImageProcessingConfiguration(e,t=!1){if(e!==this._imageProcessingConfiguration){if(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e)this._imageProcessingConfiguration=e;else{let i=null;const s=this.getEngine(),r=this.getCamera();if(r)i=r.getScene();else if(s&&s.scenes){const n=s.scenes;i=n[n.length-1]}else i=ye.LastCreatedScene;i?this._imageProcessingConfiguration=i.imageProcessingConfiguration:this._imageProcessingConfiguration=new qe}this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateParameters()})),t||this._updateParameters()}}get isSupported(){const e=this.getEffect();return!e||e.isSupported}get colorCurves(){return this.imageProcessingConfiguration.colorCurves}set colorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get colorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set colorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get colorGradingTexture(){return this.imageProcessingConfiguration.colorGradingTexture}set colorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get colorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set colorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get exposure(){return this.imageProcessingConfiguration.exposure}set exposure(e){this.imageProcessingConfiguration.exposure=e}get toneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set toneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get toneMappingType(){return this._imageProcessingConfiguration.toneMappingType}set toneMappingType(e){this._imageProcessingConfiguration.toneMappingType=e}get contrast(){return this.imageProcessingConfiguration.contrast}set contrast(e){this.imageProcessingConfiguration.contrast=e}get vignetteStretch(){return this.imageProcessingConfiguration.vignetteStretch}set vignetteStretch(e){this.imageProcessingConfiguration.vignetteStretch=e}get vignetteCentreX(){return this.imageProcessingConfiguration.vignetteCentreX}set vignetteCentreX(e){this.imageProcessingConfiguration.vignetteCentreX=e}get vignetteCentreY(){return this.imageProcessingConfiguration.vignetteCentreY}set vignetteCentreY(e){this.imageProcessingConfiguration.vignetteCentreY=e}get vignetteWeight(){return this.imageProcessingConfiguration.vignetteWeight}set vignetteWeight(e){this.imageProcessingConfiguration.vignetteWeight=e}get vignetteColor(){return this.imageProcessingConfiguration.vignetteColor}set vignetteColor(e){this.imageProcessingConfiguration.vignetteColor=e}get vignetteCameraFov(){return this.imageProcessingConfiguration.vignetteCameraFov}set vignetteCameraFov(e){this.imageProcessingConfiguration.vignetteCameraFov=e}get vignetteBlendMode(){return this.imageProcessingConfiguration.vignetteBlendMode}set vignetteBlendMode(e){this.imageProcessingConfiguration.vignetteBlendMode=e}get vignetteEnabled(){return this.imageProcessingConfiguration.vignetteEnabled}set vignetteEnabled(e){this.imageProcessingConfiguration.vignetteEnabled=e}get ditheringIntensity(){return this.imageProcessingConfiguration.ditheringIntensity}set ditheringIntensity(e){this.imageProcessingConfiguration.ditheringIntensity=e}get ditheringEnabled(){return this.imageProcessingConfiguration.ditheringEnabled}set ditheringEnabled(e){this.imageProcessingConfiguration.ditheringEnabled=e}get fromLinearSpace(){return this._fromLinearSpace}set fromLinearSpace(e){this._fromLinearSpace!==e&&(this._fromLinearSpace=e,this._updateParameters())}getClassName(){return"ImageProcessingPostProcess"}_updateParameters(){this._defines.FROMLINEARSPACE=this._fromLinearSpace,this.imageProcessingConfiguration.prepareDefines(this._defines,!0);let e="";for(const s in this._defines)this._defines[s]&&(e+=`#define ${s};\r
`);const t=["textureSampler"],i=["scale"];qe&&(qe.PrepareSamplers(t,this._defines),qe.PrepareUniforms(i,this._defines)),this.updateEffect(e,i,t)}dispose(e){super.dispose(e),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),this._imageProcessingConfiguration&&(this.imageProcessingConfiguration.applyByPostProcess=!1)}}T([R()],kc.prototype,"_fromLinearSpace",void 0);class qd{constructor(e,t,i,s,r){this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.createRenderTargetTextureProvider=r}get isFixedFoveationSupported(){return this.layerType=="XRWebGLLayer"&&typeof this.layer.fixedFoveation=="number"}get fixedFoveation(){return this.isFixedFoveationSupported?this.layer.fixedFoveation:null}set fixedFoveation(e){if(this.isFixedFoveationSupported){const t=Math.max(0,Math.min(1,e||0));this.layer.fixedFoveation=t}}}class Qd{constructor(e,t){this._scene=e,this.layerWrapper=t,this._renderTargetTextures=new Array,this._engine=e.getEngine()}_createInternalTexture(e,t){const i=new gt(this._engine,We.Unknown,!0);return i.width=e.width,i.height=e.height,i._hardwareTexture=new zl(t,this._engine._gl),i.isReady=!0,i}_createRenderTargetTexture(e,t,i,s,r,n){if(!this._engine)throw new Error("Engine is disposed");const o={width:e,height:t},l=n?new rd(this._scene,o):new si("XR renderTargetTexture",o,this._scene),h=l.renderTarget;if((i||!s)&&(h._framebuffer=i),s)if(n)h._colorTextureArray=s;else{const c=this._createInternalTexture(o,s);h.setTexture(c,0),l._texture=c}return r&&(n?h._depthStencilTextureArray=r:h._depthStencilTexture=this._createInternalTexture(o,r)),l.disableRescaling(),typeof XRWebGLBinding<"u"&&(l.skipInitialClear=!0),this._renderTargetTextures.push(l),l}_destroyRenderTargetTexture(e){this._renderTargetTextures.splice(this._renderTargetTextures.indexOf(e),1),e.dispose()}getFramebufferDimensions(){return this._framebufferDimensions}dispose(){this._renderTargetTextures.forEach(e=>e.dispose()),this._renderTargetTextures.length=0}}class Zd extends qd{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new OS(t.scene,this)),this.layer=e}}class OS extends Qd{constructor(e,t){super(e,t),this.layerWrapper=t,this._layer=t.layer,this._framebufferDimensions={framebufferWidth:this._layer.framebufferWidth,framebufferHeight:this._layer.framebufferHeight}}trySetViewportForView(e,t){const i=this._layer.getViewport(t);if(!i)return!1;const s=this._framebufferDimensions.framebufferWidth,r=this._framebufferDimensions.framebufferHeight;return e.x=i.x/s,e.y=i.y/r,e.width=i.width/s,e.height=i.height/r,!0}getRenderTargetTextureForEye(e){const t=this._layer.framebufferWidth,i=this._layer.framebufferHeight,s=this._layer.framebuffer;return(!this._rtt||t!==this._framebufferDimensions.framebufferWidth||i!==this._framebufferDimensions.framebufferHeight||s!==this._framebuffer)&&(this._rtt=this._createRenderTargetTexture(t,i,s),this._framebufferDimensions.framebufferWidth=t,this._framebufferDimensions.framebufferHeight=i,this._framebuffer=s),this._rtt}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}}class Gc{static GetDefaults(e){const t=new Gc;return t.canvasOptions={antialias:!0,depth:!0,stencil:e?e.isStencilEnable:!0,alpha:!0,framebufferScaleFactor:1},t.newCanvasCssStyle="position:absolute; bottom:0px;right:0px;z-index:10;width:90%;height:100%;background-color: #000000;",t}}class wS{constructor(e,t=Gc.GetDefaults()){if(this._options=t,this._canvas=null,this._engine=null,this.xrLayer=null,this._xrLayerWrapper=null,this.onXRLayerInitObservable=new X,this._engine=e.scene.getEngine(),this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),t.canvasElement)this._setManagedOutputCanvas(t.canvasElement);else{const i=document.createElement("canvas");i.style.cssText=this._options.newCanvasCssStyle||"position:absolute; bottom:0px;right:0px;",this._setManagedOutputCanvas(i)}e.onXRSessionInit.add(()=>{this._addCanvas()}),e.onXRSessionEnded.add(()=>{this._removeCanvas()})}dispose(){this._removeCanvas(),this._setManagedOutputCanvas(null)}async initializeXRLayerAsync(e){const t=()=>(this.xrLayer=new XRWebGLLayer(e,this.canvasContext,this._options.canvasOptions),this._xrLayerWrapper=new Zd(this.xrLayer),this.onXRLayerInitObservable.notifyObservers(this.xrLayer),this.xrLayer);return this.canvasContext.makeXRCompatible?this.canvasContext.makeXRCompatible().then(()=>{},()=>{q.Warn("Error executing makeXRCompatible. This does not mean that the session will work incorrectly.")}).then(()=>t()):Promise.resolve(t())}_addCanvas(){this._canvas&&this._engine&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.appendChild(this._canvas),this.xrLayer?this._setCanvasSize(!0):this.onXRLayerInitObservable.addOnce(()=>{this._setCanvasSize(!0)})}_removeCanvas(){this._canvas&&this._engine&&document.body.contains(this._canvas)&&this._canvas!==this._engine.getRenderingCanvas()&&document.body.removeChild(this._canvas),this._setCanvasSize(!1)}_setCanvasSize(e=!0,t=this._xrLayerWrapper){!this._canvas||!this._engine||(e?t&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=t.getWidth()+"px",this._canvas.style.height=t.getHeight()+"px"):this._engine.setSize(t.getWidth(),t.getHeight())):this._originalCanvasSize&&(this._canvas!==this._engine.getRenderingCanvas()?(this._canvas.style.width=this._originalCanvasSize.width+"px",this._canvas.style.height=this._originalCanvasSize.height+"px"):this._engine.setSize(this._originalCanvasSize.width,this._originalCanvasSize.height)))}_setManagedOutputCanvas(e){this._removeCanvas(),e?(this._originalCanvasSize={width:e.offsetWidth,height:e.offsetHeight},this._canvas=e,this.canvasContext=this._canvas.getContext("webgl2"),this.canvasContext||(this.canvasContext=this._canvas.getContext("webgl"))):(this._canvas=null,this.canvasContext=null)}}class NS extends qd{constructor(e){super(()=>e.framebufferWidth,()=>e.framebufferHeight,e,"XRWebGLLayer",t=>new FS(t,this)),this.layer=e}}class FS extends Qd{constructor(e,t){super(e.scene,t),this.layerWrapper=t,this._nativeRTTProvider=navigator.xr.getNativeRenderTargetProvider(e.session,this._createRenderTargetTexture.bind(this),this._destroyRenderTargetTexture.bind(this)),this._nativeLayer=t.layer}trySetViewportForView(e){return e.x=0,e.y=0,e.width=1,e.height=1,!0}getRenderTargetTextureForEye(e){return this._nativeRTTProvider.getRenderTargetForEye(e)}getRenderTargetTextureForView(e){return this._nativeRTTProvider.getRenderTargetForEye(e.eye)}getFramebufferDimensions(){return{framebufferWidth:this._nativeLayer.framebufferWidth,framebufferHeight:this._nativeLayer.framebufferHeight}}}class LS{constructor(e){this._nativeRenderTarget=navigator.xr.getWebXRRenderTarget(e.scene.getEngine())}async initializeXRLayerAsync(e){return await this._nativeRenderTarget.initializeXRLayerAsync(e),this.xrLayer=this._nativeRenderTarget.xrLayer,this.xrLayer}dispose(){}}class zc{constructor(e){this.scene=e,this.currentTimestamp=-1,this.defaultHeightCompensation=1.7,this.onXRFrameObservable=new X,this.onXRReferenceSpaceChanged=new X,this.onXRSessionEnded=new X,this.onXRSessionInit=new X,this.inXRFrameLoop=!1,this.inXRSession=!1,this._engine=e.getEngine(),this._onEngineDisposedObserver=this._engine.onDisposeObservable.addOnce(()=>{this._engine=null}),e.onDisposeObservable.addOnce(()=>{this.dispose()})}get referenceSpace(){return this._referenceSpace}set referenceSpace(e){this._referenceSpace=e,this.onXRReferenceSpaceChanged.notifyObservers(this._referenceSpace)}get sessionMode(){return this._sessionMode}dispose(){var e;this.inXRSession&&this.exitXRAsync(),this.onXRFrameObservable.clear(),this.onXRSessionEnded.clear(),this.onXRReferenceSpaceChanged.clear(),this.onXRSessionInit.clear(),(e=this._engine)===null||e===void 0||e.onDisposeObservable.remove(this._onEngineDisposedObserver),this._engine=null}exitXRAsync(){return this.session&&this.inXRSession?(this.inXRSession=!1,this.session.end().catch(()=>{B.Warn("Could not end XR session.")})):Promise.resolve()}trySetViewportForView(e,t){var i;return((i=this._baseLayerRTTProvider)===null||i===void 0?void 0:i.trySetViewportForView(e,t))||!1}getRenderTargetTextureForEye(e){var t;return((t=this._baseLayerRTTProvider)===null||t===void 0?void 0:t.getRenderTargetTextureForEye(e))||null}getRenderTargetTextureForView(e){var t;return((t=this._baseLayerRTTProvider)===null||t===void 0?void 0:t.getRenderTargetTextureForView(e))||null}getWebXRRenderTarget(e){const t=this.scene.getEngine();return this._xrNavigator.xr.native?new LS(this):(e=e||Gc.GetDefaults(t),e.canvasElement=e.canvasElement||t.getRenderingCanvas()||void 0,new wS(this,e))}initializeAsync(){return this._xrNavigator=navigator,this._xrNavigator.xr?Promise.resolve():Promise.reject("WebXR not available")}initializeSessionAsync(e="immersive-vr",t={}){return this._xrNavigator.xr.requestSession(e,t).then(i=>(this.session=i,this._sessionMode=e,this.onXRSessionInit.notifyObservers(i),this.inXRSession=!0,this.session.addEventListener("end",()=>{var s;this.inXRSession=!1,this.onXRSessionEnded.notifyObservers(null),this._engine&&(this._engine.framebufferDimensionsObject=null,this._engine.restoreDefaultFramebuffer(),this._engine.customAnimationFrameRequester=null,this._engine._renderLoop()),this.isNative&&((s=this._baseLayerRTTProvider)===null||s===void 0||s.dispose()),this._baseLayerRTTProvider=null,this._baseLayerWrapper=null},{once:!0}),this.session))}isSessionSupportedAsync(e){return zc.IsSessionSupportedAsync(e)}resetReferenceSpace(){this.referenceSpace=this.baseReferenceSpace}runXRRenderLoop(){var e;!this.inXRSession||!this._engine||(this._engine.customAnimationFrameRequester={requestAnimationFrame:this.session.requestAnimationFrame.bind(this.session),renderFunction:(t,i)=>{var s;!this.inXRSession||!this._engine||(this.currentFrame=i,this.currentTimestamp=t,i&&(this.inXRFrameLoop=!0,this._engine.framebufferDimensionsObject=((s=this._baseLayerRTTProvider)===null||s===void 0?void 0:s.getFramebufferDimensions())||null,this.onXRFrameObservable.notifyObservers(i),this._engine._renderLoop(),this._engine.framebufferDimensionsObject=null,this.inXRFrameLoop=!1))}},this._engine.framebufferDimensionsObject=((e=this._baseLayerRTTProvider)===null||e===void 0?void 0:e.getFramebufferDimensions())||null,typeof window<"u"&&window.cancelAnimationFrame&&window.cancelAnimationFrame(this._engine._frameHandler),this._engine._renderLoop())}setReferenceSpaceTypeAsync(e="local-floor"){return this.session.requestReferenceSpace(e).then(t=>t,t=>(B.Error("XR.requestReferenceSpace failed for the following reason: "),B.Error(t),B.Log('Defaulting to universally-supported "viewer" reference space type.'),this.session.requestReferenceSpace("viewer").then(i=>{const s=new XRRigidTransform({x:0,y:-this.defaultHeightCompensation,z:0});return i.getOffsetReferenceSpace(s)},i=>{throw B.Error(i),'XR initialization failed: required "viewer" reference space type not supported.'}))).then(t=>this.session.requestReferenceSpace("viewer").then(i=>(this.viewerReferenceSpace=i,t))).then(t=>(this.referenceSpace=this.baseReferenceSpace=t,this.referenceSpace))}updateRenderStateAsync(e){return Promise.resolve(this.session.updateRenderState(e))}_setBaseLayerWrapper(e){var t,i;this.isNative&&((t=this._baseLayerRTTProvider)===null||t===void 0||t.dispose()),this._baseLayerWrapper=e,this._baseLayerRTTProvider=((i=this._baseLayerWrapper)===null||i===void 0?void 0:i.createRenderTargetTextureProvider(this))||null}updateRenderState(e){e.baseLayer&&this._setBaseLayerWrapper(this.isNative?new NS(e.baseLayer):new Zd(e.baseLayer)),this.session.updateRenderState(e)}static IsSessionSupportedAsync(e){if(!navigator.xr)return Promise.resolve(!1);const t=navigator.xr.isSessionSupported||navigator.xr.supportsSession;return t?t.call(navigator.xr,e).then(i=>{const s=typeof i>"u"?!0:i;return Promise.resolve(s)}).catch(i=>(B.Warn(i),Promise.resolve(!1))):Promise.resolve(!1)}get isNative(){var e;return(e=this._xrNavigator.xr.native)!==null&&e!==void 0?e:!1}get currentFrameRate(){var e;return(e=this.session)===null||e===void 0?void 0:e.frameRate}get supportedFrameRates(){var e;return(e=this.session)===null||e===void 0?void 0:e.supportedFrameRates}updateTargetFrameRate(e){return this.session.updateTargetFrameRate(e)}runInXRFrame(e,t=!0){this.inXRFrameLoop?e():(this.inXRSession||!t)&&this.onXRFrameObservable.addOnce(e)}get isFixedFoveationSupported(){var e;return((e=this._baseLayerWrapper)===null||e===void 0?void 0:e.isFixedFoveationSupported)||!1}get fixedFoveation(){var e;return((e=this._baseLayerWrapper)===null||e===void 0?void 0:e.fixedFoveation)||null}set fixedFoveation(e){const t=Math.max(0,Math.min(1,e||0));this._baseLayerWrapper&&(this._baseLayerWrapper.fixedFoveation=t)}}var Ti;(function(a){a[a.ENTERING_XR=0]="ENTERING_XR",a[a.EXITING_XR=1]="EXITING_XR",a[a.IN_XR=2]="IN_XR",a[a.NOT_IN_XR=3]="NOT_IN_XR"})(Ti||(Ti={}));var uo;(function(a){a[a.NOT_TRACKING=0]="NOT_TRACKING",a[a.TRACKING_LOST=1]="TRACKING_LOST",a[a.TRACKING=2]="TRACKING"})(uo||(uo={}));function K_(a){const e=a.height||2;let t=a.diameterTop===0?0:a.diameterTop||a.diameter||1,i=a.diameterBottom===0?0:a.diameterBottom||a.diameter||1;t=t||1e-5,i=i||1e-5;const s=a.tessellation||24,r=a.subdivisions||1,n=!!a.hasRings,o=!!a.enclose,l=a.cap===0?0:a.cap||V.CAP_ALL,h=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,c=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,u=a.faceUV||new Array(3),d=a.faceColors,f=h!==1&&o?2:0,p=n?r:1,_=2+(1+f)*p;let m;for(m=0;m<_;m++)d&&d[m]===void 0&&(d[m]=new J(1,1,1,1));for(m=0;m<_;m++)u&&u[m]===void 0&&(u[m]=new Ge(0,0,1,1));const v=new Array,x=new Array,b=new Array,S=new Array,C=new Array,E=Math.PI*2*h/s;let A,M,D;const P=(i-t)/2/e,O=g.Zero(),N=g.Zero(),$=g.Zero(),W=g.Zero(),K=g.Zero(),te=ti.Y;let ve,_e,j,ee=1,F=1,z=0,Z=0;for(ve=0;ve<=r;ve++)for(M=ve/r,D=(M*(t-i)+i)/2,ee=n&&ve!==0&&ve!==r?2:1,j=0;j<ee;j++){for(n&&(F+=j),o&&(F+=2*j),_e=0;_e<=s;_e++)A=_e*E,O.x=Math.cos(-A)*D,O.y=-e/2+M*e,O.z=Math.sin(-A)*D,t===0&&ve===r?(N.x=b[b.length-(s+1)*3],N.y=b[b.length-(s+1)*3+1],N.z=b[b.length-(s+1)*3+2]):(N.x=O.x,N.z=O.z,N.y=Math.sqrt(N.x*N.x+N.z*N.z)*P,N.normalize()),_e===0&&($.copyFrom(O),W.copyFrom(N)),x.push(O.x,O.y,O.z),b.push(N.x,N.y,N.z),n?Z=z!==F?u[F].y:u[F].w:Z=u[F].y+(u[F].w-u[F].y)*M,S.push(u[F].x+(u[F].z-u[F].x)*_e/s,nt.UseOpenGLOrientationForUV?1-Z:Z),d&&C.push(d[F].r,d[F].g,d[F].b,d[F].a);h!==1&&o&&(x.push(O.x,O.y,O.z),x.push(0,O.y,0),x.push(0,O.y,0),x.push($.x,$.y,$.z),g.CrossToRef(te,N,K),K.normalize(),b.push(K.x,K.y,K.z,K.x,K.y,K.z),g.CrossToRef(W,te,K),K.normalize(),b.push(K.x,K.y,K.z,K.x,K.y,K.z),n?Z=z!==F?u[F+1].y:u[F+1].w:Z=u[F+1].y+(u[F+1].w-u[F+1].y)*M,S.push(u[F+1].x,nt.UseOpenGLOrientationForUV?1-Z:Z),S.push(u[F+1].z,nt.UseOpenGLOrientationForUV?1-Z:Z),n?Z=z!==F?u[F+2].y:u[F+2].w:Z=u[F+2].y+(u[F+2].w-u[F+2].y)*M,S.push(u[F+2].x,nt.UseOpenGLOrientationForUV?1-Z:Z),S.push(u[F+2].z,nt.UseOpenGLOrientationForUV?1-Z:Z),d&&(C.push(d[F+1].r,d[F+1].g,d[F+1].b,d[F+1].a),C.push(d[F+1].r,d[F+1].g,d[F+1].b,d[F+1].a),C.push(d[F+2].r,d[F+2].g,d[F+2].b,d[F+2].a),C.push(d[F+2].r,d[F+2].g,d[F+2].b,d[F+2].a))),z!==F&&(z=F)}const Ee=h!==1&&o?s+4:s;for(ve=0,F=0;F<r;F++){let me=0,Se=0,it=0,Zt=0;for(_e=0;_e<s;_e++)me=ve*(Ee+1)+_e,Se=(ve+1)*(Ee+1)+_e,it=ve*(Ee+1)+(_e+1),Zt=(ve+1)*(Ee+1)+(_e+1),v.push(me,Se,it),v.push(Zt,it,Se);h!==1&&o&&(v.push(me+2,Se+2,it+2),v.push(Zt+2,it+2,Se+2),v.push(me+4,Se+4,it+4),v.push(Zt+4,it+4,Se+4)),ve=n?ve+2:ve+1}const He=me=>{const Se=me?t/2:i/2;if(Se===0)return;let it,Zt,Xe;const Re=me?u[_-1]:u[0];let rt=null;d&&(rt=me?d[_-1]:d[0]);const xt=x.length/3,At=me?e/2:-e/2,Ut=new g(0,At,0);x.push(Ut.x,Ut.y,Ut.z),b.push(0,me?1:-1,0);const ms=Re.y+(Re.w-Re.y)*.5;S.push(Re.x+(Re.z-Re.x)*.5,nt.UseOpenGLOrientationForUV?1-ms:ms),rt&&C.push(rt.r,rt.g,rt.b,rt.a);const wi=new le(.5,.5);for(Xe=0;Xe<=s;Xe++){it=Math.PI*2*Xe*h/s;const Tr=Math.cos(-it),jt=Math.sin(-it);Zt=new g(Tr*Se,At,jt*Se);const Rs=new le(Tr*wi.x+.5,jt*wi.y+.5);x.push(Zt.x,Zt.y,Zt.z),b.push(0,me?1:-1,0);const Ls=Re.y+(Re.w-Re.y)*Rs.y;S.push(Re.x+(Re.z-Re.x)*Rs.x,nt.UseOpenGLOrientationForUV?1-Ls:Ls),rt&&C.push(rt.r,rt.g,rt.b,rt.a)}for(Xe=0;Xe<s;Xe++)me?(v.push(xt),v.push(xt+(Xe+2)),v.push(xt+(Xe+1))):(v.push(xt),v.push(xt+(Xe+1)),v.push(xt+(Xe+2)))};(l===V.CAP_START||l===V.CAP_ALL)&&He(!1),(l===V.CAP_END||l===V.CAP_ALL)&&He(!0),de._ComputeSides(c,x,v,b,S,a.frontUVs,a.backUVs);const ut=new de;return ut.indices=v,ut.positions=x,ut.normals=b,ut.uvs=S,d&&(ut.colors=C),ut}function jl(a,e={},t){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,K_(e).applyToMesh(i,e.updatable),i}de.CreateCylinder=K_;V.CreateCylinder=(a,e,t,i,s,r,n,o,l)=>((n===void 0||!(n instanceof ge))&&(n!==void 0&&(l=o||V.DEFAULTSIDE,o=n),n=r,r=1),jl(a,{height:e,diameterTop:t,diameterBottom:i,tessellation:s,subdivisions:r,sideOrientation:l,updatable:o},n));function $_(a){const e=[],t=[],i=[],s=[],r=a.diameter||1,n=a.thickness||.5,o=a.tessellation||16,l=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,h=o+1;for(let u=0;u<=o;u++){const d=u/o,f=u*Math.PI*2/o-Math.PI/2,p=L.Translation(r/2,0,0).multiply(L.RotationY(f));for(let _=0;_<=o;_++){const m=1-_/o,v=_*Math.PI*2/o+Math.PI,x=Math.cos(v),b=Math.sin(v);let S=new g(x,b,0),C=S.scale(n/2);const E=new le(d,m);C=g.TransformCoordinates(C,p),S=g.TransformNormal(S,p),t.push(C.x,C.y,C.z),i.push(S.x,S.y,S.z),s.push(E.x,nt.UseOpenGLOrientationForUV?1-E.y:E.y);const A=(u+1)%h,M=(_+1)%h;e.push(u*h+_),e.push(u*h+M),e.push(A*h+_),e.push(u*h+M),e.push(A*h+M),e.push(A*h+_)}}de._ComputeSides(l,t,e,i,s,a.frontUVs,a.backUVs);const c=new de;return c.indices=e,c.positions=t,c.normals=i,c.uvs=s,c}function La(a,e={},t){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,$_(e).applyToMesh(i,e.updatable),i}de.CreateTorus=$_;V.CreateTorus=(a,e,t,i,s,r,n)=>La(a,{diameter:e,thickness:t,tessellation:i,sideOrientation:n,updatable:r},s);V._GroundMeshParser=(a,e)=>ql.Parse(a,e);class ql extends V{constructor(e,t){super(e,t),this.generateOctree=!1}getClassName(){return"GroundMesh"}get subdivisions(){return Math.min(this._subdivisionsX,this._subdivisionsY)}get subdivisionsX(){return this._subdivisionsX}get subdivisionsY(){return this._subdivisionsY}optimize(e,t=32){this._subdivisionsX=e,this._subdivisionsY=e,this.subdivide(e);const i=this;i.createOrUpdateSubmeshesOctree&&i.createOrUpdateSubmeshesOctree(t)}getHeightAtCoordinates(e,t){const i=this.getWorldMatrix(),s=G.Matrix[5];i.invertToRef(s);const r=G.Vector3[8];if(g.TransformCoordinatesFromFloatsToRef(e,0,t,s,r),e=r.x,t=r.z,e<this._minX||e>=this._maxX||t<=this._minZ||t>this._maxZ)return this.position.y;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const n=this._getFacetAt(e,t),o=-(n.x*e+n.z*t+n.w)/n.y;return g.TransformCoordinatesFromFloatsToRef(0,o,0,i,r),r.y}getNormalAtCoordinates(e,t){const i=new g(0,1,0);return this.getNormalAtCoordinatesToRef(e,t,i),i}getNormalAtCoordinatesToRef(e,t,i){const s=this.getWorldMatrix(),r=G.Matrix[5];s.invertToRef(r);const n=G.Vector3[8];if(g.TransformCoordinatesFromFloatsToRef(e,0,t,r,n),e=n.x,t=n.z,e<this._minX||e>this._maxX||t<this._minZ||t>this._maxZ)return this;(!this._heightQuads||this._heightQuads.length==0)&&(this._initHeightQuads(),this._computeHeightQuads());const o=this._getFacetAt(e,t);return g.TransformNormalFromFloatsToRef(o.x,o.y,o.z,s,i),this}updateCoordinateHeights(){return(!this._heightQuads||this._heightQuads.length==0)&&this._initHeightQuads(),this._computeHeightQuads(),this}_getFacetAt(e,t){const i=Math.floor((e+this._maxX)*this._subdivisionsX/this._width),s=Math.floor(-(t+this._maxZ)*this._subdivisionsY/this._height+this._subdivisionsY),r=this._heightQuads[s*this._subdivisionsX+i];let n;return t<r.slope.x*e+r.slope.y?n=r.facet1:n=r.facet2,n}_initHeightQuads(){const e=this._subdivisionsX,t=this._subdivisionsY;this._heightQuads=new Array;for(let i=0;i<t;i++)for(let s=0;s<e;s++){const r={slope:le.Zero(),facet1:new Ge(0,0,0,0),facet2:new Ge(0,0,0,0)};this._heightQuads[i*e+s]=r}return this}_computeHeightQuads(){const e=this.getVerticesData(y.PositionKind);if(!e)return this;const t=G.Vector3[3],i=G.Vector3[2],s=G.Vector3[1],r=G.Vector3[0],n=G.Vector3[4],o=G.Vector3[5],l=G.Vector3[6],h=G.Vector3[7],c=G.Vector3[8];let u=0,d=0,f=0,p=0,_=0,m=0,v=0;const x=this._subdivisionsX,b=this._subdivisionsY;for(let S=0;S<b;S++)for(let C=0;C<x;C++){u=C*3,d=S*(x+1)*3,f=(S+1)*(x+1)*3,t.x=e[d+u],t.y=e[d+u+1],t.z=e[d+u+2],i.x=e[d+u+3],i.y=e[d+u+4],i.z=e[d+u+5],s.x=e[f+u],s.y=e[f+u+1],s.z=e[f+u+2],r.x=e[f+u+3],r.y=e[f+u+4],r.z=e[f+u+5],p=(r.z-t.z)/(r.x-t.x),_=t.z-p*t.x,i.subtractToRef(t,n),s.subtractToRef(t,o),r.subtractToRef(t,l),g.CrossToRef(l,o,h),g.CrossToRef(n,l,c),h.normalize(),c.normalize(),m=-(h.x*t.x+h.y*t.y+h.z*t.z),v=-(c.x*i.x+c.y*i.y+c.z*i.z);const E=this._heightQuads[S*x+C];E.slope.copyFromFloats(p,_),E.facet1.copyFromFloats(h.x,h.y,h.z,m),E.facet2.copyFromFloats(c.x,c.y,c.z,v)}return this}serialize(e){super.serialize(e),e.subdivisionsX=this._subdivisionsX,e.subdivisionsY=this._subdivisionsY,e.minX=this._minX,e.maxX=this._maxX,e.minZ=this._minZ,e.maxZ=this._maxZ,e.width=this._width,e.height=this._height}static Parse(e,t){const i=new ql(e.name,t);return i._subdivisionsX=e.subdivisionsX||1,i._subdivisionsY=e.subdivisionsY||1,i._minX=e.minX,i._maxX=e.maxX,i._minZ=e.minZ,i._maxZ=e.maxZ,i._width=e.width,i._height=e.height,i}}function j_(a){const e=[],t=[],i=[],s=[];let r,n;const o=a.width||1,l=a.height||1,h=a.subdivisionsX||a.subdivisions||1,c=a.subdivisionsY||a.subdivisions||1;for(r=0;r<=c;r++)for(n=0;n<=h;n++){const d=new g(n*o/h-o/2,0,(c-r)*l/c-l/2),f=new g(0,1,0);t.push(d.x,d.y,d.z),i.push(f.x,f.y,f.z),s.push(n/h,nt.UseOpenGLOrientationForUV?r/c:1-r/c)}for(r=0;r<c;r++)for(n=0;n<h;n++)e.push(n+1+(r+1)*(h+1)),e.push(n+1+r*(h+1)),e.push(n+r*(h+1)),e.push(n+(r+1)*(h+1)),e.push(n+1+(r+1)*(h+1)),e.push(n+r*(h+1));const u=new de;return u.indices=e,u.positions=t,u.normals=i,u.uvs=s,u}function q_(a){const e=a.xmin!==void 0&&a.xmin!==null?a.xmin:-1,t=a.zmin!==void 0&&a.zmin!==null?a.zmin:-1,i=a.xmax!==void 0&&a.xmax!==null?a.xmax:1,s=a.zmax!==void 0&&a.zmax!==null?a.zmax:1,r=a.subdivisions||{w:1,h:1},n=a.precision||{w:1,h:1},o=new Array,l=new Array,h=new Array,c=new Array;let u,d,f,p;r.h=r.h<1?1:r.h,r.w=r.w<1?1:r.w,n.w=n.w<1?1:n.w,n.h=n.h<1?1:n.h;const _={w:(i-e)/r.w,h:(s-t)/r.h};function m(x,b,S,C){const E=l.length/3,A=n.w+1;for(u=0;u<n.h;u++)for(d=0;d<n.w;d++){const P=[E+d+u*A,E+(d+1)+u*A,E+(d+1)+(u+1)*A,E+d+(u+1)*A];o.push(P[1]),o.push(P[2]),o.push(P[3]),o.push(P[0]),o.push(P[1]),o.push(P[3])}const M=g.Zero(),D=new g(0,1,0);for(u=0;u<=n.h;u++)for(M.z=u*(C-b)/n.h+b,d=0;d<=n.w;d++)M.x=d*(S-x)/n.w+x,M.y=0,l.push(M.x,M.y,M.z),h.push(D.x,D.y,D.z),c.push(d/n.w,u/n.h)}for(f=0;f<r.h;f++)for(p=0;p<r.w;p++)m(e+p*_.w,t+f*_.h,e+(p+1)*_.w,t+(f+1)*_.h);const v=new de;return v.indices=o,v.positions=l,v.normals=h,v.uvs=c,v}function Q_(a){const e=[],t=[],i=[],s=[];let r,n;const o=a.colorFilter||new re(.3,.59,.11),l=a.alphaFilter||0;let h=!1;if(a.minHeight>a.maxHeight){h=!0;const u=a.maxHeight;a.maxHeight=a.minHeight,a.minHeight=u}for(r=0;r<=a.subdivisions;r++)for(n=0;n<=a.subdivisions;n++){const u=new g(n*a.width/a.subdivisions-a.width/2,0,(a.subdivisions-r)*a.height/a.subdivisions-a.height/2),d=(u.x+a.width/2)/a.width*(a.bufferWidth-1)|0,f=(1-(u.z+a.height/2)/a.height)*(a.bufferHeight-1)|0,p=(d+f*a.bufferWidth)*4;let _=a.buffer[p]/255,m=a.buffer[p+1]/255,v=a.buffer[p+2]/255;const x=a.buffer[p+3]/255;h&&(_=1-_,m=1-m,v=1-v);const b=_*o.r+m*o.g+v*o.b;x>=l?u.y=a.minHeight+(a.maxHeight-a.minHeight)*b:u.y=a.minHeight-tt,t.push(u.x,u.y,u.z),i.push(0,0,0),s.push(n/a.subdivisions,1-r/a.subdivisions)}for(r=0;r<a.subdivisions;r++)for(n=0;n<a.subdivisions;n++){const u=n+1+(r+1)*(a.subdivisions+1),d=n+1+r*(a.subdivisions+1),f=n+r*(a.subdivisions+1),p=n+(r+1)*(a.subdivisions+1),_=t[u*3+1]>=a.minHeight,m=t[d*3+1]>=a.minHeight,v=t[f*3+1]>=a.minHeight;_&&m&&v&&(e.push(u),e.push(d),e.push(f)),t[p*3+1]>=a.minHeight&&_&&v&&(e.push(p),e.push(u),e.push(f))}de.ComputeNormals(t,e,i);const c=new de;return c.indices=e,c.positions=t,c.normals=i,c.uvs=s,c}function Wc(a,e={},t){const i=new ql(a,t);return i._setReady(!1),i._subdivisionsX=e.subdivisionsX||e.subdivisions||1,i._subdivisionsY=e.subdivisionsY||e.subdivisions||1,i._width=e.width||1,i._height=e.height||1,i._maxX=i._width/2,i._maxZ=i._height/2,i._minX=-i._maxX,i._minZ=-i._maxZ,j_(e).applyToMesh(i,e.updatable),i._setReady(!0),i}function Z_(a,e,t=null){const i=new V(a,t);return q_(e).applyToMesh(i,e.updatable),i}function J_(a,e,t={},i=null){const s=t.width||10,r=t.height||10,n=t.subdivisions||1,o=t.minHeight||0,l=t.maxHeight||1,h=t.colorFilter||new re(.3,.59,.11),c=t.alphaFilter||0,u=t.updatable,d=t.onReady;i=i||ye.LastCreatedScene;const f=new ql(a,i);f._subdivisionsX=n,f._subdivisionsY=n,f._width=s,f._height=r,f._maxX=f._width/2,f._maxZ=f._height/2,f._minX=-f._maxX,f._minZ=-f._maxZ,f._setReady(!1);const p=_=>{const m=_.width,v=_.height;if(i.isDisposed)return;const x=i==null?void 0:i.getEngine().resizeImageBitmap(_,m,v);Q_({width:s,height:r,subdivisions:n,minHeight:o,maxHeight:l,colorFilter:h,buffer:x,bufferWidth:m,bufferHeight:v,alphaFilter:c}).applyToMesh(f,u),d&&d(f),f._setReady(!0)};return q.LoadImage(e,p,()=>{},i.offlineProvider),f}de.CreateGround=j_;de.CreateTiledGround=q_;de.CreateGroundFromHeightMap=Q_;V.CreateGround=(a,e,t,i,s,r)=>Wc(a,{width:e,height:t,subdivisions:i,updatable:r},s);V.CreateTiledGround=(a,e,t,i,s,r,n,o,l)=>Z_(a,{xmin:e,zmin:t,xmax:i,zmax:s,subdivisions:r,precision:n,updatable:l},o);V.CreateGroundFromHeightMap=(a,e,t,i,s,r,n,o,l,h,c)=>J_(a,e,{width:t,height:i,subdivisions:s,minHeight:r,maxHeight:n,updatable:l,onReady:h,alphaFilter:c},o);class Ql{constructor(e,t=null){if(this.scene=e,this._pointerDownOnMeshAsked=!1,this._isActionableMesh=!1,this._teleportationRequestInitiated=!1,this._teleportationBackRequestInitiated=!1,this._rotationRightAsked=!1,this._rotationLeftAsked=!1,this._dpadPressed=!0,this._activePointer=!1,this._id=Ql._IdCounter++,t)this._gazeTracker=t.clone("gazeTracker");else{this._gazeTracker=La("gazeTracker",{diameter:.0035,thickness:.0025,tessellation:20,updatable:!1},e),this._gazeTracker.bakeCurrentTransformIntoVertices(),this._gazeTracker.isPickable=!1,this._gazeTracker.isVisible=!1;const i=new pe("targetMat",e);i.specularColor=re.Black(),i.emissiveColor=new re(.7,.7,.7),i.backFaceCulling=!1,this._gazeTracker.material=i}}_getForwardRay(e){return new $e(g.Zero(),new g(0,0,e))}_selectionPointerDown(){this._pointerDownOnMeshAsked=!0,this._currentHit&&this.scene.simulatePointerDown(this._currentHit,{pointerId:this._id})}_selectionPointerUp(){this._currentHit&&this.scene.simulatePointerUp(this._currentHit,{pointerId:this._id}),this._pointerDownOnMeshAsked=!1}_activatePointer(){this._activePointer=!0}_deactivatePointer(){this._activePointer=!1}_updatePointerDistance(e=100){}dispose(){this._interactionsEnabled=!1,this._teleportationEnabled=!1,this._gazeTracker&&this._gazeTracker.dispose()}}Ql._IdCounter=0;class BS extends Ql{constructor(e,t,i){super(t,i),this.webVRController=e,this._laserPointer=jl("laserPointer",{updatable:!1,height:1,diameterTop:.004,diameterBottom:2e-4,tessellation:20,subdivisions:1},t);const s=new pe("laserPointerMat",t);if(s.emissiveColor=new re(.7,.7,.7),s.alpha=.6,this._laserPointer.material=s,this._laserPointer.rotation.x=Math.PI/2,this._laserPointer.position.z=-.5,this._laserPointer.isVisible=!1,this._laserPointer.isPickable=!1,!e.mesh){const r=new V("preloadControllerMesh",t),n=new V(Ml.POINTING_POSE,t);n.rotation.x=-.7,r.addChild(n),e.attachToMesh(r)}this._setLaserPointerParent(e.mesh),this._meshAttachedObserver=e._meshAttachedObservable.add(r=>{this._setLaserPointerParent(r)})}_getForwardRay(e){return this.webVRController.getForwardRay(e)}_activatePointer(){super._activatePointer(),this._laserPointer.isVisible=!0}_deactivatePointer(){super._deactivatePointer(),this._laserPointer.isVisible=!1}_setLaserPointerColor(e){this._laserPointer.material.emissiveColor=e}_setLaserPointerLightingDisabled(e){this._laserPointer.material.disableLighting=e}_setLaserPointerParent(e){const t=r=>{r.isPickable=!1,r.getChildMeshes().forEach(n=>{t(n)})};t(e);const i=e.getChildren(void 0,!1);let s=e;this.webVRController._pointingPoseNode=null;for(let r=0;r<i.length;r++)if(i[r].name&&i[r].name.indexOf(Ml.POINTING_POSE)>=0){s=i[r],this.webVRController._pointingPoseNode=s;break}this._laserPointer.parent=s}_updatePointerDistance(e=100){this._laserPointer.scaling.y=e,this._laserPointer.position.z=-e/2}dispose(){super.dispose(),this._laserPointer.dispose(),this._meshAttachedObserver&&this.webVRController._meshAttachedObservable.remove(this._meshAttachedObserver)}}class Mf extends Ql{constructor(e,t){super(t),this._getCamera=e}_getForwardRay(e){const t=this._getCamera();return t?t.getForwardRay(e):new $e(g.Zero(),g.Forward())}}class Io{constructor(e,t={}){if(this.webVROptions=t,this._webVRsupported=!1,this._webVRready=!1,this._webVRrequesting=!1,this._webVRpresenting=!1,this._fullscreenVRpresenting=!1,this.enableGazeEvenWhenNoPointerLock=!1,this.exitVROnDoubleTap=!0,this.onEnteringVRObservable=new X,this.onAfterEnteringVRObservable=new X,this.onExitingVRObservable=new X,this.onControllerMeshLoadedObservable=new X,this._useCustomVRButton=!1,this._teleportationRequested=!1,this._teleportActive=!1,this._floorMeshesCollection=[],this._teleportationMode=Io.TELEPORTATIONMODE_CONSTANTTIME,this._teleportationTime=122,this._teleportationSpeed=20,this._rotationAllowed=!0,this._teleportBackwardsVector=new g(0,-1,-1),this._isDefaultTeleportationTarget=!0,this._teleportationFillColor="#444444",this._teleportationBorderColor="#FFFFFF",this._rotationAngle=0,this._haloCenter=new g(0,0,0),this._padSensibilityUp=.65,this._padSensibilityDown=.35,this._leftController=null,this._rightController=null,this._gazeColor=new re(.7,.7,.7),this._laserColor=new re(.7,.7,.7),this._pickedLaserColor=new re(.2,.2,1),this._pickedGazeColor=new re(0,0,1),this.onNewMeshSelected=new X,this.onMeshSelectedWithController=new X,this.onNewMeshPicked=new X,this.onBeforeCameraTeleport=new X,this.onAfterCameraTeleport=new X,this.onSelectedMeshUnselected=new X,this.teleportationEnabled=!0,this._teleportationInitialized=!1,this._interactionsEnabled=!1,this._interactionsRequested=!1,this._displayGaze=!0,this._displayLaserPointer=!0,this.updateGazeTrackerScale=!0,this.updateGazeTrackerColor=!0,this.updateControllerLaserColor=!0,this.requestPointerLockOnFullScreen=!0,this.xrTestDone=!1,this._onResize=()=>{this._moveButtonToBottomRight(),this._fullscreenVRpresenting&&this._webVRready&&this.exitVR()},this._onFullscreenChange=()=>{this._fullscreenVRpresenting=!!document.fullscreenElement,!this._fullscreenVRpresenting&&this._inputElement&&(this.exitVR(),!this._useCustomVRButton&&this._btnVR&&(this._btnVR.style.top=this._inputElement.offsetTop+this._inputElement.offsetHeight-70+"px",this._btnVR.style.left=this._inputElement.offsetLeft+this._inputElement.offsetWidth-100+"px",this._updateButtonVisibility()))},this._cachedAngularSensibility={angularSensibilityX:null,angularSensibilityY:null,angularSensibility:null},this._beforeRender=()=>{this._leftController&&this._leftController._activePointer&&this._castRayAndSelectObject(this._leftController),this._rightController&&this._rightController._activePointer&&this._castRayAndSelectObject(this._rightController),this._noControllerIsActive&&(this._scene.getEngine().isPointerLock||this.enableGazeEvenWhenNoPointerLock)?this._castRayAndSelectObject(this._cameraGazer):this._cameraGazer._gazeTracker.isVisible=!1},this._onNewGamepadConnected=s=>{if(s.type!==oi.POSE_ENABLED)s.leftStick&&s.onleftstickchanged(r=>{this._teleportationInitialized&&this.teleportationEnabled&&(!this._leftController&&!this._rightController||this._leftController&&!this._leftController._activePointer&&this._rightController&&!this._rightController._activePointer)&&(this._checkTeleportWithRay(r,this._cameraGazer),this._checkTeleportBackwards(r,this._cameraGazer))}),s.rightStick&&s.onrightstickchanged(r=>{this._teleportationInitialized&&this._checkRotate(r,this._cameraGazer)}),s.type===oi.XBOX&&(s.onbuttondown(r=>{this._interactionsEnabled&&r===Vs.A&&this._cameraGazer._selectionPointerDown()}),s.onbuttonup(r=>{this._interactionsEnabled&&r===Vs.A&&this._cameraGazer._selectionPointerUp()}));else{const r=s,n=new BS(r,this._scene,this._cameraGazer._gazeTracker);r.hand==="right"||this._leftController&&this._leftController.webVRController!=r?this._rightController=n:this._leftController=n,this._tryEnableInteractionOnController(n)}},this._tryEnableInteractionOnController=s=>{this._interactionsRequested&&!s._interactionsEnabled&&this._enableInteractionOnController(s),this._teleportationRequested&&!s._teleportationEnabled&&this._enableTeleportationOnController(s)},this._onNewGamepadDisconnected=s=>{s instanceof Ya&&(s.hand==="left"&&this._leftController!=null&&(this._leftController.dispose(),this._leftController=null),s.hand==="right"&&this._rightController!=null&&(this._rightController.dispose(),this._rightController=null))},this._workingVector=g.Zero(),this._workingQuaternion=Q.Identity(),this._workingMatrix=L.Identity(),B.Warn("WebVR is deprecated. Please avoid using this experience helper and use the WebXR experience helper instead"),this._scene=e,this._inputElement=e.getEngine().getInputElement(),!("getVRDisplays"in navigator)&&t.useXR===void 0&&(t.useXR=!0),t.createFallbackVRDeviceOrientationFreeCamera===void 0&&(t.createFallbackVRDeviceOrientationFreeCamera=!0),t.createDeviceOrientationCamera===void 0&&(t.createDeviceOrientationCamera=!0),t.laserToggle===void 0&&(t.laserToggle=!0),t.defaultHeight===void 0&&(t.defaultHeight=1.7),t.useCustomVRButton&&(this._useCustomVRButton=!0,t.customVRButton&&(this._btnVR=t.customVRButton)),t.rayLength&&(this._rayLength=t.rayLength),this._defaultHeight=t.defaultHeight,t.positionScale&&(this._rayLength*=t.positionScale,this._defaultHeight*=t.positionScale),this._hasEnteredVR=!1,this._scene.activeCamera?this._position=this._scene.activeCamera.position.clone():this._position=new g(0,this._defaultHeight,0),t.createDeviceOrientationCamera||!this._scene.activeCamera){if(this._deviceOrientationCamera=new Xd("deviceOrientationVRHelper",this._position.clone(),e),this._scene.activeCamera&&(this._deviceOrientationCamera.minZ=this._scene.activeCamera.minZ,this._deviceOrientationCamera.maxZ=this._scene.activeCamera.maxZ,this._scene.activeCamera instanceof ai&&this._scene.activeCamera.rotation)){const s=this._scene.activeCamera;s.rotationQuaternion?this._deviceOrientationCamera.rotationQuaternion.copyFrom(s.rotationQuaternion):this._deviceOrientationCamera.rotationQuaternion.copyFrom(Q.RotationYawPitchRoll(s.rotation.y,s.rotation.x,s.rotation.z)),this._deviceOrientationCamera.rotation=s.rotation.clone()}this._scene.activeCamera=this._deviceOrientationCamera,this._inputElement&&this._scene.activeCamera.attachControl()}else this._existingCamera=this._scene.activeCamera;this.webVROptions.useXR&&navigator.xr?zc.IsSessionSupportedAsync("immersive-vr").then(s=>{s?(B.Log("Using WebXR. It is recommended to use the WebXRDefaultExperience directly"),e.createDefaultXRExperienceAsync({floorMeshes:t.floorMeshes||[]}).then(r=>{this.xr=r,this.xrTestDone=!0,this._cameraGazer=new Mf(()=>this.xr.baseExperience.camera,e),this.xr.baseExperience.onStateChangedObservable.add(n=>{switch(n){case Ti.ENTERING_XR:this.onEnteringVRObservable.notifyObservers(this),this._interactionsEnabled||this.xr.pointerSelection.detach(),this.xr.pointerSelection.displayLaserPointer=this._displayLaserPointer;break;case Ti.EXITING_XR:this.onExitingVRObservable.notifyObservers(this),this._scene.getEngine().resize();break;case Ti.IN_XR:this._hasEnteredVR=!0;break;case Ti.NOT_IN_XR:this._hasEnteredVR=!1;break}})})):this._completeVRInit(e,t)}):this._completeVRInit(e,t)}get onEnteringVR(){return this.onEnteringVRObservable}get onExitingVR(){return this.onExitingVRObservable}get onControllerMeshLoaded(){return this.onControllerMeshLoadedObservable}get teleportationTarget(){return this._teleportationTarget}set teleportationTarget(e){e&&(e.name="teleportationTarget",this._isDefaultTeleportationTarget=!1,this._teleportationTarget=e)}get gazeTrackerMesh(){return this._cameraGazer._gazeTracker}set gazeTrackerMesh(e){e&&(this._cameraGazer._gazeTracker&&this._cameraGazer._gazeTracker.dispose(),this._leftController&&this._leftController._gazeTracker&&this._leftController._gazeTracker.dispose(),this._rightController&&this._rightController._gazeTracker&&this._rightController._gazeTracker.dispose(),this._cameraGazer._gazeTracker=e,this._cameraGazer._gazeTracker.bakeCurrentTransformIntoVertices(),this._cameraGazer._gazeTracker.isPickable=!1,this._cameraGazer._gazeTracker.isVisible=!1,this._cameraGazer._gazeTracker.name="gazeTracker",this._leftController&&(this._leftController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")),this._rightController&&(this._rightController._gazeTracker=this._cameraGazer._gazeTracker.clone("gazeTracker")))}get leftControllerGazeTrackerMesh(){return this._leftController?this._leftController._gazeTracker:null}get rightControllerGazeTrackerMesh(){return this._rightController?this._rightController._gazeTracker:null}get displayGaze(){return this._displayGaze}set displayGaze(e){this._displayGaze=e,e||(this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1))}get displayLaserPointer(){return this._displayLaserPointer}set displayLaserPointer(e){this._displayLaserPointer=e,e?(this._rightController&&this._rightController._activatePointer(),this._leftController&&this._leftController._activatePointer()):(this._rightController&&(this._rightController._deactivatePointer(),this._rightController._gazeTracker.isVisible=!1),this._leftController&&(this._leftController._deactivatePointer(),this._leftController._gazeTracker.isVisible=!1))}get deviceOrientationCamera(){return this._deviceOrientationCamera}get currentVRCamera(){return this._webVRready?this._webVRCamera:this._scene.activeCamera}get webVRCamera(){return this._webVRCamera}get vrDeviceOrientationCamera(){return this._vrDeviceOrientationCamera}get vrButton(){return this._btnVR}get _teleportationRequestInitiated(){return this._cameraGazer._teleportationRequestInitiated||this._leftController!==null&&this._leftController._teleportationRequestInitiated||this._rightController!==null&&this._rightController._teleportationRequestInitiated}_completeVRInit(e,t){if(this.xrTestDone=!0,t.createFallbackVRDeviceOrientationFreeCamera&&(t.useMultiview&&(t.vrDeviceOrientationCameraMetrics||(t.vrDeviceOrientationCameraMetrics=Xa.GetDefault()),t.vrDeviceOrientationCameraMetrics.multiviewEnabled=!0),this._vrDeviceOrientationCamera=new $d("VRDeviceOrientationVRHelper",this._position,this._scene,!0,t.vrDeviceOrientationCameraMetrics),this._vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._webVRCamera=new jd("WebVRHelper",this._position,this._scene,t),this._webVRCamera.useStandingMatrix(),this._cameraGazer=new Mf(()=>this.currentVRCamera,e),!this._useCustomVRButton){this._btnVR=document.createElement("BUTTON"),this._btnVR.className="babylonVRicon",this._btnVR.id="babylonVRiconbtn",this._btnVR.title="Click to switch to VR";const s=window.SVGSVGElement?"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A":"https://cdn.babylonjs.com/Assets/vrButton.png";let r=".babylonVRicon { position: absolute; right: 20px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+s+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";r+=".babylonVRicon.vrdisplaypresenting { display: none; }";const n=document.createElement("style");n.appendChild(document.createTextNode(r)),document.getElementsByTagName("head")[0].appendChild(n),this._moveButtonToBottomRight()}this._btnVR&&this._btnVR.addEventListener("click",()=>{this.isInVRMode?this._scene.getEngine().disableVR():this.enterVR()});const i=this._scene.getEngine().getHostWindow();!i||(i.addEventListener("resize",this._onResize),document.addEventListener("fullscreenchange",this._onFullscreenChange,!1),t.createFallbackVRDeviceOrientationFreeCamera?this._displayVRButton():this._scene.getEngine().onVRDisplayChangedObservable.add(s=>{s.vrDisplay&&this._displayVRButton()}),this._onKeyDown=s=>{s.keyCode===27&&this.isInVRMode&&this.exitVR()},document.addEventListener("keydown",this._onKeyDown),this._scene.onPrePointerObservable.add(()=>{this._hasEnteredVR&&this.exitVROnDoubleTap&&(this.exitVR(),this._fullscreenVRpresenting&&this._scene.getEngine().exitFullscreen())},Ce.POINTERDOUBLETAP,!1),this._onVRDisplayChangedBind=s=>this._onVRDisplayChanged(s),this._onVrDisplayPresentChangeBind=()=>this._onVrDisplayPresentChange(),this._onVRRequestPresentStart=()=>{this._webVRrequesting=!0,this._updateButtonVisibility()},this._onVRRequestPresentComplete=()=>{this._webVRrequesting=!1,this._updateButtonVisibility()},e.getEngine().onVRDisplayChangedObservable.add(this._onVRDisplayChangedBind),e.getEngine().onVRRequestPresentStart.add(this._onVRRequestPresentStart),e.getEngine().onVRRequestPresentComplete.add(this._onVRRequestPresentComplete),i.addEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),e.onDisposeObservable.add(()=>{this.dispose()}),this._webVRCamera.onControllerMeshLoadedObservable.add(s=>this._onDefaultMeshLoaded(s)),this._scene.gamepadManager.onGamepadConnectedObservable.add(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.add(this._onNewGamepadDisconnected),this._updateButtonVisibility(),this._circleEase=new n1,this._circleEase.setEasingMode(cs.EASINGMODE_EASEINOUT),this._teleportationEasing=this._circleEase,e.onPointerObservable.add(s=>{this._interactionsEnabled&&e.activeCamera===this.vrDeviceOrientationCamera&&s.event.pointerType==="mouse"&&(s.type===Ce.POINTERDOWN?this._cameraGazer._selectionPointerDown():s.type===Ce.POINTERUP&&this._cameraGazer._selectionPointerUp())}),this.webVROptions.floorMeshes&&this.enableTeleportation({floorMeshes:this.webVROptions.floorMeshes}))}_onDefaultMeshLoaded(e){this._leftController&&this._leftController.webVRController==e&&e.mesh&&this._leftController._setLaserPointerParent(e.mesh),this._rightController&&this._rightController.webVRController==e&&e.mesh&&this._rightController._setLaserPointerParent(e.mesh);try{this.onControllerMeshLoadedObservable.notifyObservers(e)}catch(t){B.Warn("Error in your custom logic onControllerMeshLoaded: "+t)}}get isInVRMode(){return this.xr&&this.webVROptions.useXR&&this.xr.baseExperience.state===Ti.IN_XR||this._webVRpresenting||this._fullscreenVRpresenting}_onVrDisplayPresentChange(){const e=this._scene.getEngine().getVRDevice();if(e){const t=this._webVRpresenting;this._webVRpresenting=e.isPresenting,t&&!this._webVRpresenting&&this.exitVR()}else B.Warn("Detected VRDisplayPresentChange on an unknown VRDisplay. Did you can enterVR on the vrExperienceHelper?");this._updateButtonVisibility()}_onVRDisplayChanged(e){this._webVRsupported=e.vrSupported,this._webVRready=!!e.vrDisplay,this._webVRpresenting=e.vrDisplay&&e.vrDisplay.isPresenting,this._updateButtonVisibility()}_moveButtonToBottomRight(){if(this._inputElement&&!this._useCustomVRButton&&this._btnVR){const e=this._inputElement.getBoundingClientRect();this._btnVR.style.top=e.top+e.height-70+"px",this._btnVR.style.left=e.left+e.width-100+"px"}}_displayVRButton(){!this._useCustomVRButton&&!this._btnVRDisplayed&&this._btnVR&&(document.body.appendChild(this._btnVR),this._btnVRDisplayed=!0)}_updateButtonVisibility(){!this._btnVR||this._useCustomVRButton||(this._btnVR.className="babylonVRicon",this.isInVRMode?this._btnVR.className+=" vrdisplaypresenting":(this._webVRready&&(this._btnVR.className+=" vrdisplayready"),this._webVRsupported&&(this._btnVR.className+=" vrdisplaysupported"),this._webVRrequesting&&(this._btnVR.className+=" vrdisplayrequesting")))}enterVR(){if(this.xr){this.xr.baseExperience.enterXRAsync("immersive-vr","local-floor",this.xr.renderTarget);return}if(this.onEnteringVRObservable)try{this.onEnteringVRObservable.notifyObservers(this)}catch(e){B.Warn("Error in your custom logic onEnteringVR: "+e)}if(this._scene.activeCamera){if(this._position=this._scene.activeCamera.position.clone(),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.rotation=Q.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles(),this.vrDeviceOrientationCamera.angularSensibility=2e3),this.webVRCamera){const e=this.webVRCamera.deviceRotationQuaternion.toEulerAngles().y,i=Q.FromRotationMatrix(this._scene.activeCamera.getWorldMatrix().getRotationMatrix()).toEulerAngles().y-e,s=this.webVRCamera.rotationQuaternion.toEulerAngles().y;this.webVRCamera.rotationQuaternion=Q.FromEulerAngles(0,s+i,0)}this._existingCamera=this._scene.activeCamera,this._existingCamera.angularSensibilityX&&(this._cachedAngularSensibility.angularSensibilityX=this._existingCamera.angularSensibilityX,this._existingCamera.angularSensibilityX=Number.MAX_VALUE),this._existingCamera.angularSensibilityY&&(this._cachedAngularSensibility.angularSensibilityY=this._existingCamera.angularSensibilityY,this._existingCamera.angularSensibilityY=Number.MAX_VALUE),this._existingCamera.angularSensibility&&(this._cachedAngularSensibility.angularSensibility=this._existingCamera.angularSensibility,this._existingCamera.angularSensibility=Number.MAX_VALUE)}this._webVRrequesting||(this._webVRready?this._webVRpresenting||(this._scene.getEngine().onVRRequestPresentComplete.addOnce(e=>{this.onAfterEnteringVRObservable.notifyObservers({success:e})}),this._webVRCamera.position=this._position,this._scene.activeCamera=this._webVRCamera):this._vrDeviceOrientationCamera&&(this._vrDeviceOrientationCamera.position=this._position,this._scene.activeCamera&&(this._vrDeviceOrientationCamera.minZ=this._scene.activeCamera.minZ),this._scene.activeCamera=this._vrDeviceOrientationCamera,this._scene.getEngine().enterFullscreen(this.requestPointerLockOnFullScreen),this._updateButtonVisibility(),this._vrDeviceOrientationCamera.onViewMatrixChangedObservable.addOnce(()=>{this.onAfterEnteringVRObservable.notifyObservers({success:!0})})),this._scene.activeCamera&&this._inputElement&&this._scene.activeCamera.attachControl(),this._interactionsEnabled&&this._scene.registerBeforeRender(this._beforeRender),this._displayLaserPointer&&[this._leftController,this._rightController].forEach(e=>{e&&e._activatePointer()}),this._hasEnteredVR=!0)}exitVR(){if(this.xr){this.xr.baseExperience.exitXRAsync();return}if(this._hasEnteredVR){if(this.onExitingVRObservable)try{this.onExitingVRObservable.notifyObservers(this)}catch(t){B.Warn("Error in your custom logic onExitingVR: "+t)}this._webVRpresenting&&this._scene.getEngine().disableVR(),this._scene.activeCamera&&(this._position=this._scene.activeCamera.position.clone()),this.vrDeviceOrientationCamera&&(this.vrDeviceOrientationCamera.angularSensibility=Number.MAX_VALUE),this._deviceOrientationCamera?(this._deviceOrientationCamera.position=this._position,this._scene.activeCamera=this._deviceOrientationCamera,this._cachedAngularSensibility.angularSensibilityX&&(this._deviceOrientationCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._deviceOrientationCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._deviceOrientationCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)):this._existingCamera&&(this._existingCamera.position=this._position,this._scene.activeCamera=this._existingCamera,this._inputElement&&this._scene.activeCamera.attachControl(),this._cachedAngularSensibility.angularSensibilityX&&(this._existingCamera.angularSensibilityX=this._cachedAngularSensibility.angularSensibilityX,this._cachedAngularSensibility.angularSensibilityX=null),this._cachedAngularSensibility.angularSensibilityY&&(this._existingCamera.angularSensibilityY=this._cachedAngularSensibility.angularSensibilityY,this._cachedAngularSensibility.angularSensibilityY=null),this._cachedAngularSensibility.angularSensibility&&(this._existingCamera.angularSensibility=this._cachedAngularSensibility.angularSensibility,this._cachedAngularSensibility.angularSensibility=null)),this._updateButtonVisibility(),this._interactionsEnabled&&(this._scene.unregisterBeforeRender(this._beforeRender),this._cameraGazer._gazeTracker.isVisible=!1,this._leftController&&(this._leftController._gazeTracker.isVisible=!1),this._rightController&&(this._rightController._gazeTracker.isVisible=!1)),this._scene.getEngine().resize(),[this._leftController,this._rightController].forEach(t=>{t&&t._deactivatePointer()}),this._hasEnteredVR=!1;const e=this._scene.getEngine();e._onVrDisplayPresentChange&&e._onVrDisplayPresentChange()}}get position(){return this._position}set position(e){this._position=e,this._scene.activeCamera&&(this._scene.activeCamera.position=e)}enableInteractions(){if(!this._interactionsEnabled){if(this._interactionsRequested=!0,this.xr){this.xr.baseExperience.state===Ti.IN_XR&&this.xr.pointerSelection.attach();return}this._leftController&&this._enableInteractionOnController(this._leftController),this._rightController&&this._enableInteractionOnController(this._rightController),this.raySelectionPredicate=e=>e.isVisible&&(e.isPickable||e.name===this._floorMeshName),this.meshSelectionPredicate=()=>!0,this._raySelectionPredicate=e=>this._isTeleportationFloor(e)||e.name.indexOf("gazeTracker")===-1&&e.name.indexOf("teleportationTarget")===-1&&e.name.indexOf("torusTeleportation")===-1?this.raySelectionPredicate(e):!1,this._interactionsEnabled=!0}}get _noControllerIsActive(){return!(this._leftController&&this._leftController._activePointer)&&!(this._rightController&&this._rightController._activePointer)}_isTeleportationFloor(e){for(let t=0;t<this._floorMeshesCollection.length;t++)if(this._floorMeshesCollection[t].id===e.id)return!0;return!!(this._floorMeshName&&e.name===this._floorMeshName)}addFloorMesh(e){!this._floorMeshesCollection||this._floorMeshesCollection.indexOf(e)>-1||this._floorMeshesCollection.push(e)}removeFloorMesh(e){if(!this._floorMeshesCollection)return;const t=this._floorMeshesCollection.indexOf(e);t!==-1&&this._floorMeshesCollection.splice(t,1)}enableTeleportation(e={}){if(!this._teleportationInitialized){if(this._teleportationRequested=!0,this.enableInteractions(),this.webVROptions.useXR&&(e.floorMeshes||e.floorMeshName)){const i=e.floorMeshes||[];if(!i.length){const s=this._scene.getMeshByName(e.floorMeshName);s&&i.push(s)}if(this.xr){i.forEach(s=>{this.xr.teleportation.addFloorMesh(s)}),this.xr.teleportation.attached||this.xr.teleportation.attach();return}else if(!this.xrTestDone){const s=()=>{this.xrTestDone&&(this._scene.unregisterBeforeRender(s),this.xr?this.xr.teleportation.attached||this.xr.teleportation.attach():this.enableTeleportation(e))};this._scene.registerBeforeRender(s);return}}e.floorMeshName&&(this._floorMeshName=e.floorMeshName),e.floorMeshes&&(this._floorMeshesCollection=e.floorMeshes),e.teleportationMode&&(this._teleportationMode=e.teleportationMode),e.teleportationTime&&e.teleportationTime>0&&(this._teleportationTime=e.teleportationTime),e.teleportationSpeed&&e.teleportationSpeed>0&&(this._teleportationSpeed=e.teleportationSpeed),e.easingFunction!==void 0&&(this._teleportationEasing=e.easingFunction),this._leftController!=null&&this._enableTeleportationOnController(this._leftController),this._rightController!=null&&this._enableTeleportationOnController(this._rightController);const t=new qe;t.vignetteColor=new J(0,0,0,0),t.vignetteEnabled=!0,this._postProcessMove=new kc("postProcessMove",1,this._webVRCamera,void 0,void 0,void 0,void 0,t),this._webVRCamera.detachPostProcess(this._postProcessMove),this._teleportationInitialized=!0,this._isDefaultTeleportationTarget&&(this._createTeleportationCircles(),this._teleportationTarget.scaling.scaleInPlace(this._webVRCamera.deviceScaleFactor))}}_enableInteractionOnController(e){e.webVRController.mesh&&(e._interactionsEnabled=!0,this.isInVRMode&&this._displayLaserPointer&&e._activatePointer(),this.webVROptions.laserToggle&&e.webVRController.onMainButtonStateChangedObservable.add(i=>{this._displayLaserPointer&&i.value===1&&(e._activePointer?e._deactivatePointer():e._activatePointer(),this.displayGaze&&(e._gazeTracker.isVisible=e._activePointer))}),e.webVRController.onTriggerStateChangedObservable.add(i=>{let s=e;this._noControllerIsActive&&(s=this._cameraGazer),s._pointerDownOnMeshAsked?i.value<this._padSensibilityDown&&s._selectionPointerUp():i.value>this._padSensibilityUp&&s._selectionPointerDown()}))}_checkTeleportWithRay(e,t){this._teleportationRequestInitiated&&!t._teleportationRequestInitiated||(t._teleportationRequestInitiated?Math.sqrt(e.y*e.y+e.x*e.x)<this._padSensibilityDown&&(this._teleportActive&&this.teleportCamera(this._haloCenter),t._teleportationRequestInitiated=!1):e.y<-this._padSensibilityUp&&t._dpadPressed&&(t._activatePointer(),t._teleportationRequestInitiated=!0))}_checkRotate(e,t){t._teleportationRequestInitiated||(t._rotationLeftAsked?e.x>-this._padSensibilityDown&&(t._rotationLeftAsked=!1):e.x<-this._padSensibilityUp&&t._dpadPressed&&(t._rotationLeftAsked=!0,this._rotationAllowed&&this._rotateCamera(!1)),t._rotationRightAsked?e.x<this._padSensibilityDown&&(t._rotationRightAsked=!1):e.x>this._padSensibilityUp&&t._dpadPressed&&(t._rotationRightAsked=!0,this._rotationAllowed&&this._rotateCamera(!0)))}_checkTeleportBackwards(e,t){if(!t._teleportationRequestInitiated)if(e.y>this._padSensibilityUp&&t._dpadPressed){if(!t._teleportationBackRequestInitiated){if(!this.currentVRCamera)return;let i=Q.FromRotationMatrix(this.currentVRCamera.getWorldMatrix().getRotationMatrix()),s=this.currentVRCamera.position;this.currentVRCamera.devicePosition&&this.currentVRCamera.deviceRotationQuaternion&&(i=this.currentVRCamera.deviceRotationQuaternion,s=this.currentVRCamera.devicePosition),i.toEulerAnglesToRef(this._workingVector),this._workingVector.z=0,this._workingVector.x=0,Q.RotationYawPitchRollToRef(this._workingVector.y,this._workingVector.x,this._workingVector.z,this._workingQuaternion),this._workingQuaternion.toRotationMatrix(this._workingMatrix),g.TransformCoordinatesToRef(this._teleportBackwardsVector,this._workingMatrix,this._workingVector);const r=new $e(s,this._workingVector),n=this._scene.pickWithRay(r,this._raySelectionPredicate);n&&n.pickedPoint&&n.pickedMesh&&this._isTeleportationFloor(n.pickedMesh)&&n.distance<5&&this.teleportCamera(n.pickedPoint),t._teleportationBackRequestInitiated=!0}}else t._teleportationBackRequestInitiated=!1}_enableTeleportationOnController(e){e.webVRController.mesh&&(e._interactionsEnabled||this._enableInteractionOnController(e),e._interactionsEnabled=!0,e._teleportationEnabled=!0,e.webVRController.controllerType===jr.VIVE&&(e._dpadPressed=!1,e.webVRController.onPadStateChangedObservable.add(i=>{e._dpadPressed=i.pressed,e._dpadPressed||(e._rotationLeftAsked=!1,e._rotationRightAsked=!1,e._teleportationBackRequestInitiated=!1)})),e.webVRController.onPadValuesChangedObservable.add(i=>{this.teleportationEnabled&&(this._checkTeleportBackwards(i,e),this._checkTeleportWithRay(i,e)),this._checkRotate(i,e)}))}_createTeleportationCircles(){this._teleportationTarget=Wc("teleportationTarget",{width:2,height:2,subdivisions:2},this._scene),this._teleportationTarget.isPickable=!1;const e=512,t=new ta("DynamicTexture",e,this._scene,!0);t.hasAlpha=!0;const i=t.getContext(),s=e/2,r=e/2,n=200;i.beginPath(),i.arc(s,r,n,0,2*Math.PI,!1),i.fillStyle=this._teleportationFillColor,i.fill(),i.lineWidth=10,i.strokeStyle=this._teleportationBorderColor,i.stroke(),i.closePath(),t.update();const o=new pe("TextPlaneMaterial",this._scene);o.diffuseTexture=t,this._teleportationTarget.material=o;const l=La("torusTeleportation",{diameter:.75,thickness:.1,tessellation:25,updatable:!1},this._scene);l.isPickable=!1,l.parent=this._teleportationTarget;const h=new ae("animationInnerCircle","position.y",30,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CYCLE),c=[];c.push({frame:0,value:0}),c.push({frame:30,value:.4}),c.push({frame:60,value:0}),h.setKeys(c);const u=new C_;u.setEasingMode(cs.EASINGMODE_EASEINOUT),h.setEasingFunction(u),l.animations=[],l.animations.push(h),this._scene.beginAnimation(l,0,60,!0),this._hideTeleportationTarget()}_displayTeleportationTarget(){this._teleportActive=!0,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!0,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!0))}_hideTeleportationTarget(){this._teleportActive=!1,this._teleportationInitialized&&(this._teleportationTarget.isVisible=!1,this._isDefaultTeleportationTarget&&(this._teleportationTarget.getChildren()[0].isVisible=!1))}_rotateCamera(e){if(!(this.currentVRCamera instanceof ws))return;e?this._rotationAngle++:this._rotationAngle--,this.currentVRCamera.animations=[];const t=Q.FromRotationMatrix(L.RotationY(Math.PI/4*this._rotationAngle)),i=new ae("animationRotation","rotationQuaternion",90,ae.ANIMATIONTYPE_QUATERNION,ae.ANIMATIONLOOPMODE_CONSTANT),s=[];s.push({frame:0,value:this.currentVRCamera.rotationQuaternion}),s.push({frame:6,value:t}),i.setKeys(s),i.setEasingFunction(this._circleEase),this.currentVRCamera.animations.push(i),this._postProcessMove.animations=[];const r=new ae("animationPP","vignetteWeight",90,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),n=[];n.push({frame:0,value:0}),n.push({frame:3,value:4}),n.push({frame:6,value:0}),r.setKeys(n),r.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(r);const o=new ae("animationPP2","vignetteStretch",90,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),l=[];l.push({frame:0,value:0}),l.push({frame:3,value:10}),l.push({frame:6,value:0}),o.setKeys(l),o.setEasingFunction(this._circleEase),this._postProcessMove.animations.push(o),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._postProcessMove.samples=4,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,6,!1,1,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,6,!1,1)}_moveTeleportationSelectorTo(e,t,i){if(e.pickedPoint){t._teleportationRequestInitiated&&(this._displayTeleportationTarget(),this._haloCenter.copyFrom(e.pickedPoint),this._teleportationTarget.position.copyFrom(e.pickedPoint));const s=this._convertNormalToDirectionOfRay(e.getNormal(!0,!1),i);if(s){const r=g.Cross(ti.Y,s),n=g.Cross(s,r);g.RotationFromAxisToRef(n,s,r,this._teleportationTarget.rotation)}this._teleportationTarget.position.y+=.1}}teleportCamera(e){if(!(this.currentVRCamera instanceof ws))return;this.webVRCamera.leftCamera?(this._workingVector.copyFrom(this.webVRCamera.leftCamera.globalPosition),this._workingVector.subtractInPlace(this.webVRCamera.position),e.subtractToRef(this._workingVector,this._workingVector)):this._workingVector.copyFrom(e),this.isInVRMode?this._workingVector.y+=this.webVRCamera.deviceDistanceToRoomGround()*this._webVRCamera.deviceScaleFactor:this._workingVector.y+=this._defaultHeight,this.onBeforeCameraTeleport.notifyObservers(this._workingVector);const t=90;let i,s;if(this._teleportationMode==Io.TELEPORTATIONMODE_CONSTANTSPEED){s=t;const d=g.Distance(this.currentVRCamera.position,this._workingVector);i=this._teleportationSpeed/d}else s=Math.round(this._teleportationTime*t/1e3),i=1;this.currentVRCamera.animations=[];const r=new ae("animationCameraTeleportation","position",t,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),n=[{frame:0,value:this.currentVRCamera.position},{frame:s,value:this._workingVector}];r.setKeys(n),r.setEasingFunction(this._teleportationEasing),this.currentVRCamera.animations.push(r),this._postProcessMove.animations=[];const o=Math.round(s/2),l=new ae("animationPP","vignetteWeight",t,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),h=[];h.push({frame:0,value:0}),h.push({frame:o,value:8}),h.push({frame:s,value:0}),l.setKeys(h),this._postProcessMove.animations.push(l);const c=new ae("animationPP2","vignetteStretch",t,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CONSTANT),u=[];u.push({frame:0,value:0}),u.push({frame:o,value:10}),u.push({frame:s,value:0}),c.setKeys(u),this._postProcessMove.animations.push(c),this._postProcessMove.imageProcessingConfiguration.vignetteWeight=0,this._postProcessMove.imageProcessingConfiguration.vignetteStretch=0,this._webVRCamera.attachPostProcess(this._postProcessMove),this._scene.beginAnimation(this._postProcessMove,0,s,!1,i,()=>{this._webVRCamera.detachPostProcess(this._postProcessMove)}),this._scene.beginAnimation(this.currentVRCamera,0,s,!1,i,()=>{this.onAfterCameraTeleport.notifyObservers(this._workingVector)}),this._hideTeleportationTarget()}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(g.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_castRayAndSelectObject(e){if(!(this.currentVRCamera instanceof ws))return;const t=e._getForwardRay(this._rayLength),i=this._scene.pickWithRay(t,this._raySelectionPredicate);if(i&&this._scene.simulatePointerMove(i,{pointerId:e._id}),e._currentHit=i,i&&i.pickedPoint){if(this._displayGaze){let s=1;e._gazeTracker.isVisible=!0,e._isActionableMesh&&(s=3),this.updateGazeTrackerScale&&(e._gazeTracker.scaling.x=i.distance*s,e._gazeTracker.scaling.y=i.distance*s,e._gazeTracker.scaling.z=i.distance*s);const r=this._convertNormalToDirectionOfRay(i.getNormal(),t),n=.002;if(r){const o=g.Cross(ti.Y,r),l=g.Cross(r,o);g.RotationFromAxisToRef(l,r,o,e._gazeTracker.rotation)}e._gazeTracker.position.copyFrom(i.pickedPoint),e._gazeTracker.position.x<0?e._gazeTracker.position.x+=n:e._gazeTracker.position.x-=n,e._gazeTracker.position.y<0?e._gazeTracker.position.y+=n:e._gazeTracker.position.y-=n,e._gazeTracker.position.z<0?e._gazeTracker.position.z+=n:e._gazeTracker.position.z-=n}e._updatePointerDistance(i.distance)}else e._updatePointerDistance(),e._gazeTracker.isVisible=!1;if(i&&i.pickedMesh){if(this._teleportationInitialized&&this._isTeleportationFloor(i.pickedMesh)&&i.pickedPoint){e._currentMeshSelected&&!this._isTeleportationFloor(e._currentMeshSelected)&&this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,e._teleportationRequestInitiated&&this._moveTeleportationSelectorTo(i,e,t);return}if(i.pickedMesh!==e._currentMeshSelected)if(this.meshSelectionPredicate(i.pickedMesh)){this.onNewMeshPicked.notifyObservers(i),e._currentMeshSelected=i.pickedMesh,i.pickedMesh.isPickable&&i.pickedMesh.actionManager?(this.changeGazeColor(this._pickedGazeColor),this.changeLaserColor(this._pickedLaserColor),e._isActionableMesh=!0):(this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor),e._isActionableMesh=!1);try{this.onNewMeshSelected.notifyObservers(i.pickedMesh);const s=e;s.webVRController&&this.onMeshSelectedWithController.notifyObservers({mesh:i.pickedMesh,controller:s.webVRController})}catch(s){B.Warn("Error while raising onNewMeshSelected or onMeshSelectedWithController: "+s)}}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}else this._notifySelectedMeshUnselected(e._currentMeshSelected),e._currentMeshSelected=null,this.changeGazeColor(this._gazeColor),this.changeLaserColor(this._laserColor)}_notifySelectedMeshUnselected(e){e&&this.onSelectedMeshUnselected.notifyObservers(e)}setLaserColor(e,t=this._pickedLaserColor){this._laserColor=e,this._pickedLaserColor=t}setLaserLightingState(e=!0){this._leftController&&this._leftController._setLaserPointerLightingDisabled(!e),this._rightController&&this._rightController._setLaserPointerLightingDisabled(!e)}setGazeColor(e,t=this._pickedGazeColor){this._gazeColor=e,this._pickedGazeColor=t}changeLaserColor(e){!this.updateControllerLaserColor||(this._leftController&&this._leftController._setLaserPointerColor(e),this._rightController&&this._rightController._setLaserPointerColor(e))}changeGazeColor(e){!this.updateGazeTrackerColor||!this._cameraGazer._gazeTracker.material||(this._cameraGazer._gazeTracker.material.emissiveColor=e,this._leftController&&(this._leftController._gazeTracker.material.emissiveColor=e),this._rightController&&(this._rightController._gazeTracker.material.emissiveColor=e))}dispose(){this.isInVRMode&&this.exitVR(),this._postProcessMove&&this._postProcessMove.dispose(),this._webVRCamera&&this._webVRCamera.dispose(),this._vrDeviceOrientationCamera&&this._vrDeviceOrientationCamera.dispose(),!this._useCustomVRButton&&this._btnVR&&this._btnVR.parentNode&&document.body.removeChild(this._btnVR),this._deviceOrientationCamera&&this._scene.activeCamera!=this._deviceOrientationCamera&&this._deviceOrientationCamera.dispose(),this._cameraGazer&&this._cameraGazer.dispose(),this._leftController&&this._leftController.dispose(),this._rightController&&this._rightController.dispose(),this._teleportationTarget&&this._teleportationTarget.dispose(),this.xr&&this.xr.dispose(),this._floorMeshesCollection.length=0,document.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("vrdisplaypresentchange",this._onVrDisplayPresentChangeBind),window.removeEventListener("resize",this._onResize),document.removeEventListener("fullscreenchange",this._onFullscreenChange),this._scene.getEngine().onVRDisplayChangedObservable.removeCallback(this._onVRDisplayChangedBind),this._scene.getEngine().onVRRequestPresentStart.removeCallback(this._onVRRequestPresentStart),this._scene.getEngine().onVRRequestPresentComplete.removeCallback(this._onVRRequestPresentComplete),this._scene.gamepadManager.onGamepadConnectedObservable.removeCallback(this._onNewGamepadConnected),this._scene.gamepadManager.onGamepadDisconnectedObservable.removeCallback(this._onNewGamepadDisconnected),this._scene.unregisterBeforeRender(this._beforeRender)}getClassName(){return"VRExperienceHelper"}}Io.TELEPORTATIONMODE_CONSTANTTIME=0;Io.TELEPORTATIONMODE_CONSTANTSPEED=1;const US=(a,e,t,i)=>!(a.x>t.x+i||t.x-i>e.x||a.y>t.y+i||t.y-i>e.y||a.z>t.z+i||t.z-i>e.z),to=function(){const a={root:0,found:!1};return function(e,t,i,s){a.root=0,a.found=!1;const r=t*t-4*e*i;if(r<0)return a;const n=Math.sqrt(r);let o=(-t-n)/(2*e),l=(-t+n)/(2*e);if(o>l){const h=l;l=o,o=h}return o>0&&o<s?(a.root=o,a.found=!0,a):(l>0&&l<s&&(a.root=l,a.found=!0),a)}}();class Hc{constructor(){this._collisionPoint=g.Zero(),this._planeIntersectionPoint=g.Zero(),this._tempVector=g.Zero(),this._tempVector2=g.Zero(),this._tempVector3=g.Zero(),this._tempVector4=g.Zero(),this._edge=g.Zero(),this._baseToVertex=g.Zero(),this._destinationPoint=g.Zero(),this._slidePlaneNormal=g.Zero(),this._displacementVector=g.Zero(),this._radius=g.One(),this._retry=0,this._basePointWorld=g.Zero(),this._velocityWorld=g.Zero(),this._normalizedVelocity=g.Zero(),this._collisionMask=-1}get collisionMask(){return this._collisionMask}set collisionMask(e){this._collisionMask=isNaN(e)?-1:e}get slidePlaneNormal(){return this._slidePlaneNormal}_initialize(e,t,i){this._velocity=t,this._velocitySquaredLength=this._velocity.lengthSquared();const s=Math.sqrt(this._velocitySquaredLength);s===0||s===1?this._normalizedVelocity.copyFromFloats(t._x,t._y,t._z):t.scaleToRef(1/s,this._normalizedVelocity),this._basePoint=e,e.multiplyToRef(this._radius,this._basePointWorld),t.multiplyToRef(this._radius,this._velocityWorld),this._velocityWorldLength=this._velocityWorld.length(),this._epsilon=i,this.collisionFound=!1}_checkPointInTriangle(e,t,i,s,r){t.subtractToRef(e,this._tempVector),i.subtractToRef(e,this._tempVector2),g.CrossToRef(this._tempVector,this._tempVector2,this._tempVector4);let n=g.Dot(this._tempVector4,r);return n<0||(s.subtractToRef(e,this._tempVector3),g.CrossToRef(this._tempVector2,this._tempVector3,this._tempVector4),n=g.Dot(this._tempVector4,r),n<0)?!1:(g.CrossToRef(this._tempVector3,this._tempVector,this._tempVector4),n=g.Dot(this._tempVector4,r),n>=0)}_canDoCollision(e,t,i,s){const r=g.Distance(this._basePointWorld,e),n=Math.max(this._radius.x,this._radius.y,this._radius.z);return!(r>this._velocityWorldLength+n+t||!US(i,s,this._basePointWorld,this._velocityWorldLength+n))}_testTriangle(e,t,i,s,r,n,o){let l,h=!1;t||(t=[]),t[e]||(t[e]=new Hi(0,0,0,0),t[e].copyFromPoints(i,s,r));const c=t[e];if(!n&&!c.isFrontFacingTo(this._normalizedVelocity,0))return;const u=c.signedDistanceTo(this._basePoint),d=g.Dot(c.normal,this._velocity);if(Hc.DoubleSidedCheck&&d>1e-4)return;if(d==0){if(Math.abs(u)>=1)return;h=!0,l=0}else{l=(-1-u)/d;let _=(1-u)/d;if(l>_){const m=_;_=l,l=m}if(l>1||_<0)return;l<0&&(l=0),l>1&&(l=1)}this._collisionPoint.copyFromFloats(0,0,0);let f=!1,p=1;if(h||(this._basePoint.subtractToRef(c.normal,this._planeIntersectionPoint),this._velocity.scaleToRef(l,this._tempVector),this._planeIntersectionPoint.addInPlace(this._tempVector),this._checkPointInTriangle(this._planeIntersectionPoint,i,s,r,c.normal)&&(f=!0,p=l,this._collisionPoint.copyFrom(this._planeIntersectionPoint))),!f){let _=this._velocitySquaredLength;this._basePoint.subtractToRef(i,this._tempVector);let m=2*g.Dot(this._velocity,this._tempVector),v=this._tempVector.lengthSquared()-1,x=to(_,m,v,p);x.found&&(p=x.root,f=!0,this._collisionPoint.copyFrom(i)),this._basePoint.subtractToRef(s,this._tempVector),m=2*g.Dot(this._velocity,this._tempVector),v=this._tempVector.lengthSquared()-1,x=to(_,m,v,p),x.found&&(p=x.root,f=!0,this._collisionPoint.copyFrom(s)),this._basePoint.subtractToRef(r,this._tempVector),m=2*g.Dot(this._velocity,this._tempVector),v=this._tempVector.lengthSquared()-1,x=to(_,m,v,p),x.found&&(p=x.root,f=!0,this._collisionPoint.copyFrom(r)),s.subtractToRef(i,this._edge),i.subtractToRef(this._basePoint,this._baseToVertex);let b=this._edge.lengthSquared(),S=g.Dot(this._edge,this._velocity),C=g.Dot(this._edge,this._baseToVertex);if(_=b*-this._velocitySquaredLength+S*S,m=2*(b*g.Dot(this._velocity,this._baseToVertex)-S*C),v=b*(1-this._baseToVertex.lengthSquared())+C*C,x=to(_,m,v,p),x.found){const E=(S*x.root-C)/b;E>=0&&E<=1&&(p=x.root,f=!0,this._edge.scaleInPlace(E),i.addToRef(this._edge,this._collisionPoint))}if(r.subtractToRef(s,this._edge),s.subtractToRef(this._basePoint,this._baseToVertex),b=this._edge.lengthSquared(),S=g.Dot(this._edge,this._velocity),C=g.Dot(this._edge,this._baseToVertex),_=b*-this._velocitySquaredLength+S*S,m=2*(b*g.Dot(this._velocity,this._baseToVertex)-S*C),v=b*(1-this._baseToVertex.lengthSquared())+C*C,x=to(_,m,v,p),x.found){const E=(S*x.root-C)/b;E>=0&&E<=1&&(p=x.root,f=!0,this._edge.scaleInPlace(E),s.addToRef(this._edge,this._collisionPoint))}if(i.subtractToRef(r,this._edge),r.subtractToRef(this._basePoint,this._baseToVertex),b=this._edge.lengthSquared(),S=g.Dot(this._edge,this._velocity),C=g.Dot(this._edge,this._baseToVertex),_=b*-this._velocitySquaredLength+S*S,m=2*(b*g.Dot(this._velocity,this._baseToVertex)-S*C),v=b*(1-this._baseToVertex.lengthSquared())+C*C,x=to(_,m,v,p),x.found){const E=(S*x.root-C)/b;E>=0&&E<=1&&(p=x.root,f=!0,this._edge.scaleInPlace(E),r.addToRef(this._edge,this._collisionPoint))}}if(f){const _=p*p*this._velocitySquaredLength;(!this.collisionFound||_<this._nearestDistanceSquared)&&(o.collisionResponse&&(this.intersectionPoint?this.intersectionPoint.copyFrom(this._collisionPoint):this.intersectionPoint=this._collisionPoint.clone(),this._nearestDistanceSquared=_,this._nearestDistance=Math.sqrt(_),this.collisionFound=!0),this.collidedMesh=o)}}_collide(e,t,i,s,r,n,o,l,h,c=!1){if(c)if(!i||i.length===0)for(let u=0;u<t.length-2;u+=1){const d=t[u],f=t[u+1],p=t[u+2];!d||!f||!p||((h?1:0)^u%2?this._testTriangle(u,e,d,f,p,o,l):this._testTriangle(u,e,f,d,p,o,l))}else for(let u=s;u<r-2;u+=1){const d=i[u],f=i[u+1],p=i[u+2];if(p===4294967295){u+=2;continue}const _=t[d],m=t[f],v=t[p];!_||!m||!v||((h?1:0)^u%2?this._testTriangle(u,e,_,m,v,o,l):this._testTriangle(u,e,m,_,v,o,l))}else if(!i||i.length===0)for(let u=0;u<t.length;u+=3){const d=t[u],f=t[u+1],p=t[u+2];h?this._testTriangle(u,e,d,f,p,o,l):this._testTriangle(u,e,p,f,d,o,l)}else for(let u=s;u<r;u+=3){const d=t[i[u]-n],f=t[i[u+1]-n],p=t[i[u+2]-n];h?this._testTriangle(u,e,d,f,p,o,l):this._testTriangle(u,e,p,f,d,o,l)}}_getResponse(e,t){e.addToRef(t,this._destinationPoint),t.scaleInPlace(this._nearestDistance/t.length()),this._basePoint.addToRef(t,e),e.subtractToRef(this.intersectionPoint,this._slidePlaneNormal),this._slidePlaneNormal.normalize(),this._slidePlaneNormal.scaleToRef(this._epsilon,this._displacementVector),e.addInPlace(this._displacementVector),this.intersectionPoint.addInPlace(this._displacementVector),this._slidePlaneNormal.scaleInPlace(Hi.SignedDistanceToPlaneFromPositionAndNormal(this.intersectionPoint,this._slidePlaneNormal,this._destinationPoint)),this._destinationPoint.subtractInPlace(this._slidePlaneNormal),this._destinationPoint.subtractToRef(this.intersectionPoint,t)}}Hc.DoubleSidedCheck=!1;class VS{constructor(){this._scaledPosition=g.Zero(),this._scaledVelocity=g.Zero(),this._finalPosition=g.Zero()}getNewPosition(e,t,i,s,r,n,o){e.divideToRef(i._radius,this._scaledPosition),t.divideToRef(i._radius,this._scaledVelocity),i.collidedMesh=null,i._retry=0,i._initialVelocity=this._scaledVelocity,i._initialPosition=this._scaledPosition,this._collideWithWorld(this._scaledPosition,this._scaledVelocity,i,s,this._finalPosition,r),this._finalPosition.multiplyInPlace(i._radius),n(o,this._finalPosition,i.collidedMesh)}createCollider(){return new Hc}init(e){this._scene=e}_collideWithWorld(e,t,i,s,r,n=null){const o=k.CollisionsEpsilon*10;if(i._retry>=s){r.copyFrom(e);return}const l=n?n.collisionMask:i.collisionMask;i._initialize(e,t,o);const h=n&&n.surroundingMeshes||this._scene.meshes;for(let c=0;c<h.length;c++){const u=h[c];u.isEnabled()&&u.checkCollisions&&u.subMeshes&&u!==n&&(l&u.collisionGroup)!==0&&u._checkCollision(i)}if(!i.collisionFound){e.addToRef(t,r);return}if((t.x!==0||t.y!==0||t.z!==0)&&i._getResponse(e,t),t.length()<=o){r.copyFrom(e);return}i._retry++,this._collideWithWorld(e,t,i,s,r,n)}}ge.CollisionCoordinatorFactory=()=>new VS;class Po{constructor(e,t,i,s=""){var r,n;this.name=null,this.defines="",this.onCompiled=null,this.onError=null,this.uniqueId=0,this.onCompileObservable=new X,this.onErrorObservable=new X,this.onBindObservable=new X,this._wasPreviouslyReady=!1,this._isReady=!1,this._compilationError="",this._key="",this._computeSourceCodeOverride="",this._pipelineContext=null,this._computeSourceCode="",this._rawComputeSourceCode="",this._shaderLanguage=Xt.WGSL,this.name=e,this._key=s,this._engine=i,this.uniqueId=Po._UniqueIdSeed++,this.defines=(r=t.defines)!==null&&r!==void 0?r:"",this.onError=t.onError,this.onCompiled=t.onCompiled,this._entryPoint=(n=t.entryPoint)!==null&&n!==void 0?n:"main",this._shaderStore=Y.GetShadersStore(this._shaderLanguage),this._shaderRepository=Y.GetShadersRepository(this._shaderLanguage),this._includeShaderStore=Y.GetIncludesShadersStore(this._shaderLanguage);let o;const l=Ht()?this._engine.getHostDocument():null;e.computeSource?o="source:"+e.computeSource:e.computeElement?(o=l?l.getElementById(e.computeElement):null,o||(o=e.computeElement)):o=e.compute||e;const h={defines:this.defines.split(`
`),indexParameters:void 0,isFragment:!1,shouldUseHighPrecisionShader:!1,processor:null,supportsUniformBuffers:this._engine.supportsUniformBuffers,shadersRepository:this._shaderRepository,includesShadersStore:this._includeShaderStore,version:(this._engine.version*100).toString(),platformName:this._engine.shaderPlatformName,processingContext:null,isNDCHalfZRange:this._engine.isNDCHalfZRange,useReverseDepthBuffer:this._engine.useReverseDepthBuffer};this._loadShader(o,"Compute","",c=>{kr.Initialize(h),kr.PreProcess(c,h,u=>{this._rawComputeSourceCode=c,t.processFinalCode&&(u=t.processFinalCode(u));const d=kr.Finalize(u,"",h);this._useFinalCode(d.vertexCode,e)},this._engine)})}_useFinalCode(e,t){if(t){const i=t.computeElement||t.compute||t.spectorName||t;this._computeSourceCode="//#define SHADER_NAME compute:"+i+`
`+e}else this._computeSourceCode=e;this._prepareEffect()}get key(){return this._key}isReady(){try{return this._isReadyInternal()}catch{return!1}}_isReadyInternal(){return this._isReady?!0:this._pipelineContext?this._pipelineContext.isReady:!1}getEngine(){return this._engine}getPipelineContext(){return this._pipelineContext}getCompilationError(){return this._compilationError}executeWhenCompiled(e){if(this.isReady()){e(this);return}this.onCompileObservable.add(t=>{e(t)}),(!this._pipelineContext||this._pipelineContext.isAsync)&&setTimeout(()=>{this._checkIsReady(null)},16)}_checkIsReady(e){try{if(this._isReadyInternal())return}catch(t){this._processCompilationErrors(t,e);return}setTimeout(()=>{this._checkIsReady(e)},16)}_loadShader(e,t,i,s){if(typeof HTMLElement<"u"&&e instanceof HTMLElement){const n=_c(e);s(n);return}if(e.substr(0,7)==="source:"){s(e.substr(7));return}if(e.substr(0,7)==="base64:"){const n=window.atob(e.substr(7));s(n);return}if(this._shaderStore[e+t+"Shader"]){s(this._shaderStore[e+t+"Shader"]);return}if(i&&this._shaderStore[e+i+"Shader"]){s(this._shaderStore[e+i+"Shader"]);return}let r;e[0]==="."||e[0]==="/"||e.indexOf("http")>-1?r=e:r=this._shaderRepository+e,this._engine._loadFile(r+"."+t.toLowerCase()+".fx",s)}get computeSourceCode(){var e,t;return this._computeSourceCodeOverride?this._computeSourceCodeOverride:(t=(e=this._pipelineContext)===null||e===void 0?void 0:e._getComputeShaderCode())!==null&&t!==void 0?t:this._computeSourceCode}get rawComputeSourceCode(){return this._rawComputeSourceCode}_prepareEffect(){const e=this.defines,t=this._pipelineContext;this._isReady=!1;try{const i=this._engine;this._pipelineContext=i.createComputePipelineContext(),this._pipelineContext._name=this._key,i._prepareComputePipelineContext(this._pipelineContext,this._computeSourceCodeOverride?this._computeSourceCodeOverride:this._computeSourceCode,this._rawComputeSourceCode,this._computeSourceCodeOverride?null:e,this._entryPoint),i._executeWhenComputeStateIsCompiled(this._pipelineContext,()=>{this._compilationError="",this._isReady=!0,this.onCompiled&&this.onCompiled(this),this.onCompileObservable.notifyObservers(this),this.onCompileObservable.clear(),t&&this.getEngine()._deleteComputePipelineContext(t)}),this._pipelineContext.isAsync&&this._checkIsReady(t)}catch(i){this._processCompilationErrors(i,t)}}_getShaderCodeAndErrorLine(e,t){const i=/COMPUTE SHADER ERROR: 0:(\d+?):/;let s=null;if(t&&e){const r=t.match(i);if(r&&r.length===2){const n=parseInt(r[1]),o=e.split(`
`,-1);o.length>=n&&(s=`Offending line [${n}] in compute code: ${o[n-1]}`)}}return[e,s]}_processCompilationErrors(e,t=null){var i;if(this._compilationError=e.message,B.Error("Unable to compile compute effect:"),B.Error(`Defines:\r
`+this.defines),Po.LogShaderCodeOnCompilationError){let s=null,r=null;!((i=this._pipelineContext)===null||i===void 0)&&i._getComputeShaderCode()&&([r,s]=this._getShaderCodeAndErrorLine(this._pipelineContext._getComputeShaderCode(),this._compilationError),r&&(B.Error("Compute code:"),B.Error(r))),s&&B.Error(s)}B.Error("Error: "+this._compilationError),t&&(this._pipelineContext=t,this._isReady=!0,this.onError&&this.onError(this,this._compilationError),this.onErrorObservable.notifyObservers(this))}dispose(){this._pipelineContext&&this._pipelineContext.dispose(),this._engine._releaseComputeEffect(this)}static RegisterShader(e,t){Y.GetShadersStore(Xt.WGSL)[`${e}ComputeShader`]=t}}Po._UniqueIdSeed=0;Po.LogShaderCodeOnCompilationError=!0;var Jt;(function(a){a[a.Texture=0]="Texture",a[a.StorageTexture=1]="StorageTexture",a[a.UniformBuffer=2]="UniformBuffer",a[a.StorageBuffer=3]="StorageBuffer",a[a.TextureWithoutSampler=4]="TextureWithoutSampler",a[a.Sampler=5]="Sampler"})(Jt||(Jt={}));Te.prototype.createComputeEffect=function(a,e){throw new Error("createComputeEffect: This engine does not support compute shaders!")};Te.prototype.createComputePipelineContext=function(){throw new Error("createComputePipelineContext: This engine does not support compute shaders!")};Te.prototype.createComputeContext=function(){};Te.prototype.computeDispatch=function(a,e,t,i,s,r,n){throw new Error("computeDispatch: This engine does not support compute shaders!")};Te.prototype.areAllComputeEffectsReady=function(){return!0};Te.prototype.releaseComputeEffects=function(){};Te.prototype._prepareComputePipelineContext=function(a,e,t,i,s){};Te.prototype._rebuildComputeEffects=function(){};Te.prototype._executeWhenComputeStateIsCompiled=function(a,e){e()};Te.prototype._releaseComputeEffect=function(a){};Te.prototype._deleteComputePipelineContext=function(a){};class Zl{constructor(e,t,i,s={}){if(this._bindings={},this._samplers={},this._contextIsDirty=!1,this.onCompiled=null,this.onError=null,this.name=e,this._engine=t,this.uniqueId=xc.UniqueId,!this._engine.getCaps().supportComputeShaders){B.Error("This engine does not support compute shaders!");return}if(!s.bindingsMapping){B.Error("You must provide the binding mappings as browsers don't support reflection for wgsl shaders yet!");return}this._context=t.createComputeContext(),this._shaderPath=i,this._options={bindingsMapping:{},defines:[],...s}}get options(){return this._options}get shaderPath(){return this._shaderPath}getClassName(){return"ComputeShader"}setTexture(e,t,i=!0){const s=this._bindings[e];this._bindings[e]={type:i?Jt.Texture:Jt.TextureWithoutSampler,object:t,indexInGroupEntries:s==null?void 0:s.indexInGroupEntries},this._contextIsDirty||(this._contextIsDirty=!s||s.object!==t||s.type!==this._bindings[e].type)}setStorageTexture(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Jt.StorageTexture,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setUniformBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Jt.UniformBuffer,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setStorageBuffer(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||i.object!==t),this._bindings[e]={type:Jt.StorageBuffer,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}setTextureSampler(e,t){const i=this._bindings[e];this._contextIsDirty||(this._contextIsDirty=!i||!t.compareSampler(i.object)),this._bindings[e]={type:Jt.Sampler,object:t,indexInGroupEntries:i==null?void 0:i.indexInGroupEntries}}isReady(){let e=this._effect;for(const r in this._bindings){const n=this._bindings[r],o=n.type,l=n.object;switch(o){case Jt.Texture:case Jt.TextureWithoutSampler:case Jt.StorageTexture:{if(!l.isReady())return!1;break}}}const t=[],i=this._shaderPath;if(this._options.defines)for(let r=0;r<this._options.defines.length;r++)t.push(this._options.defines[r]);const s=t.join(`
`);return this._cachedDefines!==s&&(this._cachedDefines=s,e=this._engine.createComputeEffect(i,{defines:s,entryPoint:this._options.entryPoint,onCompiled:this.onCompiled,onError:this.onError}),this._effect=e),!!e.isReady()}dispatch(e,t,i){var s;if(!this.isReady())return!1;for(const r in this._bindings){const n=this._bindings[r];if(!this._options.bindingsMapping[r])throw new Error("ComputeShader ('"+this.name+"'): No binding mapping has been provided for the property '"+r+"'");if(n.type!==Jt.Texture)continue;const o=this._samplers[r],l=n.object;(!o||!l._texture||!o.compareSampler(l._texture))&&(this._samplers[r]=new Zp().setParameters(l.wrapU,l.wrapV,l.wrapR,l.anisotropicFilteringLevel,l._texture.samplingMode,(s=l._texture)===null||s===void 0?void 0:s._comparisonFunction),this._contextIsDirty=!0)}return this._contextIsDirty&&(this._contextIsDirty=!1,this._context.clear()),this._engine.computeDispatch(this._effect,this._context,this._bindings,e,t,i,this._options.bindingsMapping),!0}dispatchWhenReady(e,t,i,s=10){return new Promise(r=>{const n=()=>{this.dispatch(e,t,i)?r():setTimeout(n,s)};n()})}serialize(){const e=xe.Serialize(this);e.options=this._options,e.shaderPath=this._shaderPath,e.bindings={},e.textures={};for(const t in this._bindings){const i=this._bindings[t],s=i.object;switch(i.type){case Jt.Texture:case Jt.TextureWithoutSampler:case Jt.StorageTexture:{const r=s.serialize();r&&(e.textures[t]=r,e.bindings[t]={type:i.type});break}case Jt.UniformBuffer:break}}return e}static Parse(e,t,i){const s=xe.Parse(()=>new Zl(e.name,t.getEngine(),e.shaderPath,e.options),e,t,i);for(const r in e.textures){const n=e.bindings[r],o=H.Parse(e.textures[r],t,i);n.type===Jt.Texture?s.setTexture(r,o):n.type===Jt.TextureWithoutSampler?s.setTexture(r,o,!1):s.setStorageTexture(r,o)}return s}}T([R()],Zl.prototype,"name",void 0);he("BABYLON.ComputeShader",Zl);class Jh{constructor(e,t,i,s,r,n){this.entries=new Array,this._boundingVectors=new Array,this._capacity=i,this._depth=s,this._maxDepth=r,this._creationFunc=n,this._minPoint=e,this._maxPoint=t,this._boundingVectors.push(e.clone()),this._boundingVectors.push(t.clone()),this._boundingVectors.push(e.clone()),this._boundingVectors[2].x=t.x,this._boundingVectors.push(e.clone()),this._boundingVectors[3].y=t.y,this._boundingVectors.push(e.clone()),this._boundingVectors[4].z=t.z,this._boundingVectors.push(t.clone()),this._boundingVectors[5].z=e.z,this._boundingVectors.push(t.clone()),this._boundingVectors[6].x=e.x,this._boundingVectors.push(t.clone()),this._boundingVectors[7].y=e.y}get capacity(){return this._capacity}get minPoint(){return this._minPoint}get maxPoint(){return this._maxPoint}addEntry(e){if(this.blocks){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e);return}this._creationFunc(e,this),this.entries.length>this.capacity&&this._depth<this._maxDepth&&this.createInnerBlocks()}removeEntry(e){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].removeEntry(e);return}const t=this.entries.indexOf(e);t>-1&&this.entries.splice(t,1)}addEntries(e){for(let t=0;t<e.length;t++){const i=e[t];this.addEntry(i)}}select(e,t,i){if(Ir.IsInFrustum(this._boundingVectors,e)){if(this.blocks){for(let s=0;s<this.blocks.length;s++)this.blocks[s].select(e,t,i);return}i?t.concat(this.entries):t.concatWithNoDuplicate(this.entries)}}intersects(e,t,i,s){if(Ir.IntersectsSphere(this._minPoint,this._maxPoint,e,t)){if(this.blocks){for(let r=0;r<this.blocks.length;r++)this.blocks[r].intersects(e,t,i,s);return}s?i.concat(this.entries):i.concatWithNoDuplicate(this.entries)}}intersectsRay(e,t){if(e.intersectsBoxMinMax(this._minPoint,this._maxPoint)){if(this.blocks){for(let i=0;i<this.blocks.length;i++)this.blocks[i].intersectsRay(e,t);return}t.concatWithNoDuplicate(this.entries)}}createInnerBlocks(){Jh._CreateBlocks(this._minPoint,this._maxPoint,this.entries,this._capacity,this._depth,this._maxDepth,this,this._creationFunc),this.entries.splice(0)}static _CreateBlocks(e,t,i,s,r,n,o,l){o.blocks=new Array;const h=new g((t.x-e.x)/2,(t.y-e.y)/2,(t.z-e.z)/2);for(let c=0;c<2;c++)for(let u=0;u<2;u++)for(let d=0;d<2;d++){const f=e.add(h.multiplyByFloats(c,u,d)),p=e.add(h.multiplyByFloats(c+1,u+1,d+1)),_=new Jh(f,p,s,r+1,n,l);_.addEntries(i),o.blocks.push(_)}}}class Mo{constructor(e,t,i=2){this.maxDepth=i,this.dynamicContent=new Array,this._maxBlockCapacity=t||64,this._selectionContent=new wn(1024),this._creationFunc=e}update(e,t,i){Jh._CreateBlocks(e,t,i,this._maxBlockCapacity,0,this.maxDepth,this,this._creationFunc)}addMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].addEntry(e)}removeMesh(e){for(let t=0;t<this.blocks.length;t++)this.blocks[t].removeEntry(e)}select(e,t){this._selectionContent.reset();for(let i=0;i<this.blocks.length;i++)this.blocks[i].select(e,this._selectionContent,t);return t?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersects(e,t,i){this._selectionContent.reset();for(let s=0;s<this.blocks.length;s++)this.blocks[s].intersects(e,t,this._selectionContent,i);return i?this._selectionContent.concat(this.dynamicContent):this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}intersectsRay(e){this._selectionContent.reset();for(let t=0;t<this.blocks.length;t++)this.blocks[t].intersectsRay(e,this._selectionContent);return this._selectionContent.concatWithNoDuplicate(this.dynamicContent),this._selectionContent}}Mo.CreationFuncForMeshes=(a,e)=>{const t=a.getBoundingInfo();!a.isBlocked&&t.boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(a)};Mo.CreationFuncForSubMeshes=(a,e)=>{a.getBoundingInfo().boundingBox.intersectsMinMax(e.minPoint,e.maxPoint)&&e.entries.push(a)};ge.prototype.createOrUpdateSelectionOctree=function(a=64,e=2){let t=this._getComponent(ue.NAME_OCTREE);t||(t=new em(this),this._addComponent(t)),this._selectionOctree||(this._selectionOctree=new Mo(Mo.CreationFuncForMeshes,a,e));const i=this.getWorldExtends();return this._selectionOctree.update(i.min,i.max,this.meshes),this._selectionOctree};Object.defineProperty(ge.prototype,"selectionOctree",{get:function(){return this._selectionOctree},enumerable:!0,configurable:!0});ct.prototype.createOrUpdateSubmeshesOctree=function(a=64,e=2){const t=this.getScene();let i=t._getComponent(ue.NAME_OCTREE);i||(i=new em(t),t._addComponent(i)),this._submeshesOctree||(this._submeshesOctree=new Mo(Mo.CreationFuncForSubMeshes,a,e)),this.computeWorldMatrix(!0);const r=this.getBoundingInfo().boundingBox;return this._submeshesOctree.update(r.minimumWorld,r.maximumWorld,this.subMeshes),this._submeshesOctree};class em{constructor(e){this.name=ue.NAME_OCTREE,this.checksIsEnabled=!0,this._tempRay=new $e(g.Zero(),new g(1,1,1)),e=e||ye.LastCreatedScene,e&&(this.scene=e,this.scene.getActiveMeshCandidates=this.getActiveMeshCandidates.bind(this),this.scene.getActiveSubMeshCandidates=this.getActiveSubMeshCandidates.bind(this),this.scene.getCollidingSubMeshCandidates=this.getCollidingSubMeshCandidates.bind(this),this.scene.getIntersectingSubMeshCandidates=this.getIntersectingSubMeshCandidates.bind(this))}register(){this.scene.onMeshRemovedObservable.add(e=>{const t=this.scene.selectionOctree;if(t!=null){const i=t.dynamicContent.indexOf(e);i!==-1&&t.dynamicContent.splice(i,1)}}),this.scene.onMeshImportedObservable.add(e=>{const t=this.scene.selectionOctree;t!=null&&t.addMesh(e)})}getActiveMeshCandidates(){var e;return((e=this.scene._selectionOctree)===null||e===void 0?void 0:e.select(this.scene.frustumPlanes))||this.scene._getDefaultMeshCandidates()}getActiveSubMeshCandidates(e){return e._submeshesOctree&&e.useOctreeForRenderingSelection?e._submeshesOctree.select(this.scene.frustumPlanes):this.scene._getDefaultSubMeshCandidates(e)}getIntersectingSubMeshCandidates(e,t){return e._submeshesOctree&&e.useOctreeForPicking?($e.TransformToRef(t,e.getWorldMatrix(),this._tempRay),e._submeshesOctree.intersectsRay(this._tempRay)):this.scene._getDefaultSubMeshCandidates(e)}getCollidingSubMeshCandidates(e,t){if(e._submeshesOctree&&e.useOctreeForCollisions){const i=t._velocityWorldLength+Math.max(t._radius.x,t._radius.y,t._radius.z);return e._submeshesOctree.intersects(t._basePointWorld,i)}return this.scene._getDefaultSubMeshCandidates(e)}rebuild(){}dispose(){}}class ci{constructor(e,t=!0){this.originalScene=e,this._pointerCaptures={},this._lastPointerEvents={},this._sharedGizmoLight=null,this._renderCamera=null,this.pickUtilitySceneFirst=!0,this.shouldRender=!0,this.onlyCheckPointerDownEvents=!0,this.processAllEvents=!1,this.pickingEnabled=!0,this.onPointerOutObservable=new X,this.utilityLayerScene=new ge(e.getEngine(),{virtual:!0}),this.utilityLayerScene.useRightHandedSystem=e.useRightHandedSystem,this.utilityLayerScene._allowPostProcessClearColor=!1,this.utilityLayerScene.postProcessesEnabled=!1,this.utilityLayerScene.detachControl(),t&&(this._originalPointerObserver=e.onPrePointerObservable.add(i=>{if(!this.utilityLayerScene.activeCamera||!this.pickingEnabled||!this.processAllEvents&&i.type!==Ce.POINTERMOVE&&i.type!==Ce.POINTERUP&&i.type!==Ce.POINTERDOWN&&i.type!==Ce.POINTERDOUBLETAP)return;this.utilityLayerScene.pointerX=e.pointerX,this.utilityLayerScene.pointerY=e.pointerY;const s=i.event;if(e.isPointerCaptured(s.pointerId)){this._pointerCaptures[s.pointerId]=!1;return}const r=o=>{let l=null;if(i.nearInteractionPickingInfo)i.nearInteractionPickingInfo.pickedMesh.getScene()==o?l=i.nearInteractionPickingInfo:l=new ki;else if(o!==this.utilityLayerScene&&i.originalPickingInfo)l=i.originalPickingInfo;else{let h=null;this._renderCamera&&(h=o._activeCamera,o._activeCamera=this._renderCamera,i.ray=null),l=i.ray?o.pickWithRay(i.ray):o.pick(e.pointerX,e.pointerY),h&&(o._activeCamera=h)}return l},n=r(this.utilityLayerScene);if(!i.ray&&n&&(i.ray=n.ray),this.utilityLayerScene.onPrePointerObservable.notifyObservers(i),this.onlyCheckPointerDownEvents&&i.type!=Ce.POINTERDOWN){i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Bn(i.type,i.event,n),i.type),i.type===Ce.POINTERUP&&this._pointerCaptures[s.pointerId]&&(this._pointerCaptures[s.pointerId]=!1);return}if(this.utilityLayerScene.autoClearDepthAndStencil||this.pickUtilitySceneFirst)n&&n.hit&&(i.skipOnPointerObservable||this.utilityLayerScene.onPointerObservable.notifyObservers(new Bn(i.type,i.event,n),i.type),i.skipOnPointerObservable=!0);else{const o=r(e),l=i.event;o&&n&&(n.distance===0&&o.pickedMesh?this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(o.pickedMesh)?(this._notifyObservers(i,o,l),i.skipOnPointerObservable=!0):i.type===Ce.POINTERDOWN?this._pointerCaptures[l.pointerId]=!0:(i.type===Ce.POINTERMOVE||i.type===Ce.POINTERUP)&&(this._lastPointerEvents[l.pointerId]&&(this.onPointerOutObservable.notifyObservers(l.pointerId),delete this._lastPointerEvents[l.pointerId]),this._notifyObservers(i,o,l)):!this._pointerCaptures[l.pointerId]&&(n.distance<o.distance||o.distance===0)?(this._notifyObservers(i,n,l),i.skipOnPointerObservable||(i.skipOnPointerObservable=n.distance>0)):!this._pointerCaptures[l.pointerId]&&n.distance>=o.distance&&(this.mainSceneTrackerPredicate&&this.mainSceneTrackerPredicate(o.pickedMesh)?(this._notifyObservers(i,o,l),i.skipOnPointerObservable=!0):((i.type===Ce.POINTERMOVE||i.type===Ce.POINTERUP)&&this._lastPointerEvents[l.pointerId]&&(this.onPointerOutObservable.notifyObservers(l.pointerId),delete this._lastPointerEvents[l.pointerId]),this._notifyObservers(i,n,l))),i.type===Ce.POINTERUP&&this._pointerCaptures[l.pointerId]&&(this._pointerCaptures[l.pointerId]=!1))}}),this._originalPointerObserver&&e.onPrePointerObservable.makeObserverTopPriority(this._originalPointerObserver)),this.utilityLayerScene.autoClear=!1,this._afterRenderObserver=this.originalScene.onAfterRenderCameraObservable.add(i=>{this.shouldRender&&i==this.getRenderCamera()&&this.render()}),this._sceneDisposeObserver=this.originalScene.onDisposeObservable.add(()=>{this.dispose()}),this._updateCamera()}getRenderCamera(e){if(this._renderCamera)return this._renderCamera;{let t;return this.originalScene.activeCameras&&this.originalScene.activeCameras.length>1?t=this.originalScene.activeCameras[this.originalScene.activeCameras.length-1]:t=this.originalScene.activeCamera,e&&t&&t.isRigCamera?t.rigParent:t}}setRenderCamera(e){this._renderCamera=e}_getSharedGizmoLight(){return this._sharedGizmoLight||(this._sharedGizmoLight=new ea("shared gizmo light",new g(0,1,0),this.utilityLayerScene),this._sharedGizmoLight.intensity=2,this._sharedGizmoLight.groundColor=re.Gray()),this._sharedGizmoLight}static get DefaultUtilityLayer(){return ci._DefaultUtilityLayer==null?ci._CreateDefaultUtilityLayerFromScene(ye.LastCreatedScene):ci._DefaultUtilityLayer}static _CreateDefaultUtilityLayerFromScene(e){return ci._DefaultUtilityLayer=new ci(e),ci._DefaultUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{ci._DefaultUtilityLayer=null}),ci._DefaultUtilityLayer}static get DefaultKeepDepthUtilityLayer(){return ci._DefaultKeepDepthUtilityLayer==null&&(ci._DefaultKeepDepthUtilityLayer=new ci(ye.LastCreatedScene),ci._DefaultKeepDepthUtilityLayer.utilityLayerScene.autoClearDepthAndStencil=!1,ci._DefaultKeepDepthUtilityLayer.originalScene.onDisposeObservable.addOnce(()=>{ci._DefaultKeepDepthUtilityLayer=null})),ci._DefaultKeepDepthUtilityLayer}_notifyObservers(e,t,i){e.skipOnPointerObservable||(this.utilityLayerScene.onPointerObservable.notifyObservers(new Bn(e.type,e.event,t),e.type),this._lastPointerEvents[i.pointerId]=!0)}render(){if(this._updateCamera(),this.utilityLayerScene.activeCamera){const e=this.utilityLayerScene.activeCamera.getScene(),t=this.utilityLayerScene.activeCamera;t._scene=this.utilityLayerScene,t.leftCamera&&(t.leftCamera._scene=this.utilityLayerScene),t.rightCamera&&(t.rightCamera._scene=this.utilityLayerScene),this.utilityLayerScene.render(!1),t._scene=e,t.leftCamera&&(t.leftCamera._scene=e),t.rightCamera&&(t.rightCamera._scene=e)}}dispose(){this.onPointerOutObservable.clear(),this._afterRenderObserver&&this.originalScene.onAfterCameraRenderObservable.remove(this._afterRenderObserver),this._sceneDisposeObserver&&this.originalScene.onDisposeObservable.remove(this._sceneDisposeObserver),this._originalPointerObserver&&this.originalScene.onPrePointerObservable.remove(this._originalPointerObserver),this.utilityLayerScene.dispose()}_updateCamera(){this.utilityLayerScene.cameraToUseForPointers=this.getRenderCamera(),this.utilityLayerScene.activeCamera=this.getRenderCamera()}}ci._DefaultUtilityLayer=null;ci._DefaultKeepDepthUtilityLayer=null;Object.defineProperty(ge.prototype,"debugLayer",{get:function(){return this._debugLayer||(this._debugLayer=new Xc(this)),this._debugLayer},enumerable:!0,configurable:!0});var Df;(function(a){a[a.Properties=0]="Properties",a[a.Debug=1]="Debug",a[a.Statistics=2]="Statistics",a[a.Tools=3]="Tools",a[a.Settings=4]="Settings"})(Df||(Df={}));class Xc{constructor(e){this.BJSINSPECTOR=this._getGlobalInspector(),this._scene=e||ye.LastCreatedScene,this._scene&&this._scene.onDisposeObservable.add(()=>{this._scene._debugLayer&&this._scene._debugLayer.hide()})}get onPropertyChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable:(this._onPropertyChangedObservable||(this._onPropertyChangedObservable=new X),this._onPropertyChangedObservable)}get onSelectionChangedObservable(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector?this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable:(this._onSelectionChangedObservable||(this._onSelectionChangedObservable=new X),this._onSelectionChangedObservable)}_createInspector(e){if(this.isVisible())return;if(this._onPropertyChangedObservable){for(const i of this._onPropertyChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnPropertyChangedObservable.add(i);this._onPropertyChangedObservable.clear(),this._onPropertyChangedObservable=void 0}if(this._onSelectionChangedObservable){for(const i of this._onSelectionChangedObservable.observers)this.BJSINSPECTOR.Inspector.OnSelectionChangedObservable.add(i);this._onSelectionChangedObservable.clear(),this._onSelectionChangedObservable=void 0}const t={overlay:!1,showExplorer:!0,showInspector:!0,embedMode:!1,handleResize:!0,enablePopup:!0,...e};this.BJSINSPECTOR=this.BJSINSPECTOR||this._getGlobalInspector(),this.BJSINSPECTOR.Inspector.Show(this._scene,t)}select(e,t){this.BJSINSPECTOR&&(t&&(Object.prototype.toString.call(t)=="[object String]"?this.BJSINSPECTOR.Inspector.MarkLineContainerTitleForHighlighting(t):this.BJSINSPECTOR.Inspector.MarkMultipleLineContainerTitlesForHighlighting(t)),this.BJSINSPECTOR.Inspector.OnSelectionChangeObservable.notifyObservers(e))}_getGlobalInspector(){if(typeof INSPECTOR<"u")return INSPECTOR;if(typeof BABYLON<"u"&&typeof BABYLON.Inspector<"u")return BABYLON}isVisible(){return this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.IsVisible}hide(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector.Hide()}setAsActiveScene(){this.BJSINSPECTOR&&this.BJSINSPECTOR.Inspector._SetNewScene(this._scene)}show(e){return new Promise(t=>{if(typeof this.BJSINSPECTOR>"u"){const i=e&&e.inspectorURL?e.inspectorURL:Xc.InspectorURL;q.LoadScript(i,()=>{this._createInspector(e),t(this)})}else this._createInspector(e),t(this)})}}Xc.InspectorURL=`https://unpkg.com/babylonjs-inspector@${k.Version}/babylon.inspector.bundle.js`;function Jd(a){let t=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23];const i=[0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0],s=[];let r=[];const n=a.width||a.size||1,o=a.height||a.size||1,l=a.depth||a.size||1,h=a.wrap||!1;let c=a.topBaseAt===void 0?1:a.topBaseAt,u=a.bottomBaseAt===void 0?0:a.bottomBaseAt;c=(c+4)%4,u=(u+4)%4;const d=[2,0,3,1],f=[2,0,1,3];let p=d[c],_=f[u],m=[1,-1,1,-1,-1,1,-1,1,1,1,1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,-1,1,-1,1,1,-1,1,1,1,1,-1,1,1,-1,-1,-1,-1,-1,-1,-1,1];if(h){t=[2,3,0,2,0,1,4,5,6,4,6,7,9,10,11,9,11,8,12,14,15,12,13,14],m=[-1,1,1,1,1,1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1];let A=[[1,1,1],[-1,1,1],[-1,1,-1],[1,1,-1]],M=[[-1,-1,1],[1,-1,1],[1,-1,-1],[-1,-1,-1]];const D=[17,18,19,16],P=[22,23,20,21];for(;p>0;)A.unshift(A.pop()),D.unshift(D.pop()),p--;for(;_>0;)M.unshift(M.pop()),P.unshift(P.pop()),_--;A=A.flat(),M=M.flat(),m=m.concat(A).concat(M),t.push(D[0],D[2],D[3],D[0],D[1],D[2]),t.push(P[0],P[2],P[3],P[0],P[1],P[2])}const v=[n/2,o/2,l/2];r=m.reduce((A,M,D)=>A.concat(M*v[D%3]),[]);const x=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,b=a.faceUV||new Array(6),S=a.faceColors,C=[];for(let A=0;A<6;A++)b[A]===void 0&&(b[A]=new Ge(0,0,1,1)),S&&S[A]===void 0&&(S[A]=new J(1,1,1,1));for(let A=0;A<6;A++)if(s.push(b[A].z,nt.UseOpenGLOrientationForUV?1-b[A].w:b[A].w),s.push(b[A].x,nt.UseOpenGLOrientationForUV?1-b[A].w:b[A].w),s.push(b[A].x,nt.UseOpenGLOrientationForUV?1-b[A].y:b[A].y),s.push(b[A].z,nt.UseOpenGLOrientationForUV?1-b[A].y:b[A].y),S)for(let M=0;M<4;M++)C.push(S[A].r,S[A].g,S[A].b,S[A].a);de._ComputeSides(x,r,t,i,s,a.frontUVs,a.backUVs);const E=new de;if(E.indices=t,E.positions=r,E.normals=i,E.uvs=s,S){const A=x===de.DOUBLESIDE?C.concat(C):C;E.colors=A}return E}function Yc(a,e={},t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Jd(e).applyToMesh(i,e.updatable),i}de.CreateBox=Jd;V.CreateBox=(a,e,t=null,i,s)=>Yc(a,{size:e,sideOrientation:s,updatable:i},t);function tm(a){const e=a.segments||32,t=a.diameterX||a.diameter||1,i=a.diameterY||a.diameter||1,s=a.diameterZ||a.diameter||1,r=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,n=a.slice&&a.slice<=0?1:a.slice||1,o=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,l=!!a.dedupTopBottomIndices,h=new g(t/2,i/2,s/2),c=2+e,u=2*c,d=[],f=[],p=[],_=[];for(let v=0;v<=c;v++){const x=v/c,b=x*Math.PI*n;for(let S=0;S<=u;S++){const C=S/u,E=C*Math.PI*2*r,A=L.RotationZ(-b),M=L.RotationY(E),D=g.TransformCoordinates(g.Up(),A),P=g.TransformCoordinates(D,M),O=P.multiply(h),N=P.divide(h).normalize();f.push(O.x,O.y,O.z),p.push(N.x,N.y,N.z),_.push(C,nt.UseOpenGLOrientationForUV?1-x:x)}if(v>0){const S=f.length/3;for(let C=S-2*(u+1);C+u+2<S;C++)l?(v>1&&(d.push(C),d.push(C+1),d.push(C+u+1)),(v<c||n<1)&&(d.push(C+u+1),d.push(C+1),d.push(C+u+2))):(d.push(C),d.push(C+1),d.push(C+u+1),d.push(C+u+1),d.push(C+1),d.push(C+u+2))}}de._ComputeSides(o,f,d,p,_,a.frontUVs,a.backUVs);const m=new de;return m.indices=d,m.positions=f,m.normals=p,m.uvs=_,m}function qr(a,e={},t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,tm(e).applyToMesh(i,e.updatable),i}de.CreateSphere=tm;V.CreateSphere=(a,e,t,i,s,r)=>qr(a,{segments:e,diameterX:t,diameterY:t,diameterZ:t,sideOrientation:r,updatable:s},i);function im(a={subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6}){const e=Math.max(a.subdivisions?a.subdivisions:2,1),t=Math.max(a.tessellation?a.tessellation:16,3),i=Math.max(a.height?a.height:1,0),s=Math.max(a.radius?a.radius:.25,0),r=Math.max(a.capSubdivisions?a.capSubdivisions:6,1),n=t,o=e,l=Math.max(a.radiusTop?a.radiusTop:s,0),h=Math.max(a.radiusBottom?a.radiusBottom:s,0),c=i-(l+h),u=0,d=2*Math.PI,f=Math.max(a.topCapSubdivisions?a.topCapSubdivisions:r,1),p=Math.max(a.bottomCapSubdivisions?a.bottomCapSubdivisions:r,1),_=Math.acos((h-l)/i);let m=[];const v=[],x=[],b=[];let S=0;const C=[],E=c*.5,A=Math.PI*.5;let M,D;const P=g.Zero(),O=g.Zero(),N=Math.cos(_),$=Math.sin(_),W=new le(l*$,E+l*N).subtract(new le(h*$,-E+h*N)).length(),K=l*_+W+h*(A-_);let te=0;for(D=0;D<=f;D++){const ee=[],F=A-_*(D/f);te+=l*_/f;const z=Math.cos(F),Z=Math.sin(F),Ee=z*l;for(M=0;M<=n;M++){const He=M/n,ut=He*d+u,me=Math.sin(ut),Se=Math.cos(ut);O.x=Ee*me,O.y=E+Z*l,O.z=Ee*Se,v.push(O.x,O.y,O.z),P.set(z*me,Z,z*Se),x.push(P.x,P.y,P.z),b.push(He,nt.UseOpenGLOrientationForUV?te/K:1-te/K),ee.push(S),S++}C.push(ee)}const ve=i-l-h+N*l-N*h,_e=$*(h-l)/ve;for(D=1;D<=o;D++){const ee=[];te+=W/o;const F=$*(D*(h-l)/o+l);for(M=0;M<=n;M++){const z=M/n,Z=z*d+u,Ee=Math.sin(Z),He=Math.cos(Z);O.x=F*Ee,O.y=E+N*l-D*ve/o,O.z=F*He,v.push(O.x,O.y,O.z),P.set(Ee,_e,He).normalize(),x.push(P.x,P.y,P.z),b.push(z,nt.UseOpenGLOrientationForUV?te/K:1-te/K),ee.push(S),S++}C.push(ee)}for(D=1;D<=p;D++){const ee=[],F=A-_-(Math.PI-_)*(D/p);te+=h*_/p;const z=Math.cos(F),Z=Math.sin(F),Ee=z*h;for(M=0;M<=n;M++){const He=M/n,ut=He*d+u,me=Math.sin(ut),Se=Math.cos(ut);O.x=Ee*me,O.y=-E+Z*h,O.z=Ee*Se,v.push(O.x,O.y,O.z),P.set(z*me,Z,z*Se),x.push(P.x,P.y,P.z),b.push(He,nt.UseOpenGLOrientationForUV?te/K:1-te/K),ee.push(S),S++}C.push(ee)}for(M=0;M<n;M++)for(D=0;D<f+o+p;D++){const ee=C[D][M],F=C[D+1][M],z=C[D+1][M+1],Z=C[D][M+1];m.push(ee),m.push(F),m.push(Z),m.push(F),m.push(z),m.push(Z)}if(m=m.reverse(),a.orientation&&!a.orientation.equals(g.Up())){const ee=new L;a.orientation.clone().scale(Math.PI*.5).cross(g.Up()).toQuaternion().toRotationMatrix(ee);const F=g.Zero();for(let z=0;z<v.length;z+=3)F.set(v[z],v[z+1],v[z+2]),g.TransformCoordinatesToRef(F.clone(),ee,F),v[z]=F.x,v[z+1]=F.y,v[z+2]=F.z}const j=new de;return j.positions=v,j.normals=x,j.uvs=b,j.indices=m,j}function sm(a,e={orientation:g.Up(),subdivisions:2,tessellation:16,height:1,radius:.25,capSubdivisions:6,updatable:!1},t=null){const i=new V(a,t);return im(e).applyToMesh(i,e.updatable),i}V.CreateCapsule=(a,e,t)=>sm(a,e,t);de.CreateCapsule=im;V._instancedMeshFactory=(a,e)=>{const t=new rm(a,e);if(e.instancedBuffers){t.instancedBuffers={};for(const i in e.instancedBuffers)t.instancedBuffers[i]=e.instancedBuffers[i]}return t};class rm extends ct{constructor(e,t){super(e,t.getScene()),this._indexInSourceMeshInstanceArray=-1,this._distanceToCamera=0,t.addInstance(this),this._sourceMesh=t,this._unIndexed=t._unIndexed,this.position.copyFrom(t.position),this.rotation.copyFrom(t.rotation),this.scaling.copyFrom(t.scaling),t.rotationQuaternion&&(this.rotationQuaternion=t.rotationQuaternion.clone()),this.animations=t.animations.slice();for(const i of t.getAnimationRanges())i!=null&&this.createAnimationRange(i.name,i.from,i.to);this.infiniteDistance=t.infiniteDistance,this.setPivotMatrix(t.getPivotMatrix()),this.refreshBoundingInfo(!0,!0),this._syncSubMeshes()}getClassName(){return"InstancedMesh"}get lightSources(){return this._sourceMesh._lightSources}_resyncLightSources(){}_resyncLightSource(){}_removeLightSource(){}get receiveShadows(){return this._sourceMesh.receiveShadows}get material(){return this._sourceMesh.material}get visibility(){return this._sourceMesh.visibility}get skeleton(){return this._sourceMesh.skeleton}get renderingGroupId(){return this._sourceMesh.renderingGroupId}set renderingGroupId(e){!this._sourceMesh||e===this._sourceMesh.renderingGroupId||B.Warn("Note - setting renderingGroupId of an instanced mesh has no effect on the scene")}getTotalVertices(){return this._sourceMesh?this._sourceMesh.getTotalVertices():0}getTotalIndices(){return this._sourceMesh.getTotalIndices()}get sourceMesh(){return this._sourceMesh}createInstance(e){return this._sourceMesh.createInstance(e)}isReady(e=!1){return this._sourceMesh.isReady(e,!0)}getVerticesData(e,t){return this._sourceMesh.getVerticesData(e,t)}setVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.setVerticesData(e,t,i,s),this.sourceMesh}updateVerticesData(e,t,i,s){return this.sourceMesh&&this.sourceMesh.updateVerticesData(e,t,i,s),this.sourceMesh}setIndices(e,t=null){return this.sourceMesh&&this.sourceMesh.setIndices(e,t),this.sourceMesh}isVerticesDataPresent(e){return this._sourceMesh.isVerticesDataPresent(e)}getIndices(){return this._sourceMesh.getIndices()}get _positions(){return this._sourceMesh._positions}refreshBoundingInfo(e=!1,t=!1){if(this.hasBoundingInfo&&this.getBoundingInfo().isLocked)return this;const i=this._sourceMesh.geometry?this._sourceMesh.geometry.boundingBias:null;return this._refreshBoundingInfo(this._sourceMesh._getPositionData(e,t),i),this}_preActivate(){return this._currentLOD&&this._currentLOD._preActivate(),this}_activate(e,t){if(super._activate(e,t),this._sourceMesh.subMeshes||B.Warn("Instances should only be created for meshes with geometry."),this._currentLOD){if(this._currentLOD._getWorldMatrixDeterminant()>=0!=this._getWorldMatrixDeterminant()>=0)return this._internalAbstractMeshDataInfo._actAsRegularMesh=!0,!0;if(this._internalAbstractMeshDataInfo._actAsRegularMesh=!1,this._currentLOD._registerInstanceForRenderId(this,e),t){if(!this._currentLOD._internalAbstractMeshDataInfo._isActiveIntermediate)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstancesIntermediate=!0,!0}else if(!this._currentLOD._internalAbstractMeshDataInfo._isActive)return this._currentLOD._internalAbstractMeshDataInfo._onlyForInstances=!0,!0}return!1}_postActivate(){this._sourceMesh.edgesShareWithInstances&&this._sourceMesh._edgesRenderer&&this._sourceMesh._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup?(this._sourceMesh._renderingGroup._edgesRenderers.pushNoDuplicate(this._sourceMesh._edgesRenderer),this._sourceMesh._edgesRenderer.customInstances.push(this.getWorldMatrix())):this._edgesRenderer&&this._edgesRenderer.isEnabled&&this._sourceMesh._renderingGroup&&this._sourceMesh._renderingGroup._edgesRenderers.push(this._edgesRenderer)}getWorldMatrix(){if(this._currentLOD&&this._currentLOD.billboardMode!==ke.BILLBOARDMODE_NONE&&this._currentLOD._masterMesh!==this){this._billboardWorldMatrix||(this._billboardWorldMatrix=new L);const e=this._currentLOD._masterMesh;return this._currentLOD._masterMesh=this,G.Vector3[7].copyFrom(this._currentLOD.position),this._currentLOD.position.set(0,0,0),this._billboardWorldMatrix.copyFrom(this._currentLOD.computeWorldMatrix(!0)),this._currentLOD.position.copyFrom(G.Vector3[7]),this._currentLOD._masterMesh=e,this._billboardWorldMatrix}return super.getWorldMatrix()}get isAnInstance(){return!0}getLOD(e){if(!e)return this;const t=this.sourceMesh.getLODLevels();if(!t||t.length===0)this._currentLOD=this.sourceMesh;else{const i=this.getBoundingInfo();this._currentLOD=this.sourceMesh.getLOD(e,i.boundingSphere)}return this._currentLOD}_preActivateForIntermediateRendering(e){return this.sourceMesh._preActivateForIntermediateRendering(e)}_syncSubMeshes(){if(this.releaseSubMeshes(),this._sourceMesh.subMeshes)for(let e=0;e<this._sourceMesh.subMeshes.length;e++)this._sourceMesh.subMeshes[e].clone(this,this._sourceMesh);return this}_generatePointsArray(){return this._sourceMesh._generatePointsArray()}_updateBoundingInfo(){return this.hasBoundingInfo?this.getBoundingInfo().update(this.worldMatrixFromCache):this.buildBoundingInfo(this.absolutePosition,this.absolutePosition,this.worldMatrixFromCache),this._updateSubMeshesBoundingInfo(this.worldMatrixFromCache),this}clone(e,t=null,i,s){const r=(s||this._sourceMesh).createInstance(e);if(ys.DeepCopy(this,r,["name","subMeshes","uniqueId","parent","lightSources","receiveShadows","material","visibility","skeleton","sourceMesh","isAnInstance","facetNb","isFacetDataEnabled","isBlocked","useBones","hasInstances","collider","edgesRenderer","forward","up","right","absolutePosition","absoluteScaling","absoluteRotationQuaternion","isWorldMatrixFrozen","nonUniformScaling","behaviors","worldMatrixFromCache","hasThinInstances","hasBoundingInfo"],[]),this.refreshBoundingInfo(),t&&(r.parent=t),!i)for(let n=0;n<this.getScene().meshes.length;n++){const o=this.getScene().meshes[n];o.parent===this&&o.clone(o.name,r)}return r.computeWorldMatrix(!0),this.onClonedObservable.notifyObservers(r),r}dispose(e,t=!1){this._sourceMesh.removeInstance(this),super.dispose(e,t)}_serializeAsParent(e){super._serializeAsParent(e),e.parentId=this._sourceMesh.uniqueId,e.parentInstanceIndex=this._indexInSourceMeshInstanceArray}instantiateHierarchy(e=null,t,i){const s=this.clone("Clone of "+(this.name||this.id),e||this.parent,!0,t&&t.newSourcedMesh);s&&i&&i(this,s);for(const r of this.getChildTransformNodes(!0))r.instantiateHierarchy(s,t,i);return s}}V.prototype.registerInstancedBuffer=function(a,e){var t,i;if((i=(t=this._userInstancedBuffersStorage)===null||t===void 0?void 0:t.vertexBuffers[a])===null||i===void 0||i.dispose(),!this.instancedBuffers){this.instancedBuffers={};for(const s of this.instances)s.instancedBuffers={};this._userInstancedBuffersStorage||(this._userInstancedBuffersStorage={data:{},vertexBuffers:{},strides:{},sizes:{},vertexArrayObjects:this.getEngine().getCaps().vertexArrayObject?{}:void 0})}this.instancedBuffers[a]=null,this._userInstancedBuffersStorage.strides[a]=e,this._userInstancedBuffersStorage.sizes[a]=e*32,this._userInstancedBuffersStorage.data[a]=new Float32Array(this._userInstancedBuffersStorage.sizes[a]),this._userInstancedBuffersStorage.vertexBuffers[a]=new y(this.getEngine(),this._userInstancedBuffersStorage.data[a],a,!0,!1,e,!0);for(const s of this.instances)s.instancedBuffers[a]=null;this._invalidateInstanceVertexArrayObject(),this._markSubMeshesAsAttributesDirty()};V.prototype._processInstancedBuffers=function(a,e){const t=a?a.length:0;for(const i in this.instancedBuffers){let s=this._userInstancedBuffersStorage.sizes[i];const r=this._userInstancedBuffersStorage.strides[i],n=(t+1)*r;for(;s<n;)s*=2;this._userInstancedBuffersStorage.data[i].length!=s&&(this._userInstancedBuffersStorage.data[i]=new Float32Array(s),this._userInstancedBuffersStorage.sizes[i]=s,this._userInstancedBuffersStorage.vertexBuffers[i]&&(this._userInstancedBuffersStorage.vertexBuffers[i].dispose(),this._userInstancedBuffersStorage.vertexBuffers[i]=null));const o=this._userInstancedBuffersStorage.data[i];let l=0;if(e){const h=this.instancedBuffers[i];h.toArray?h.toArray(o,l):h.copyToArray?h.copyToArray(o,l):o[l]=h,l+=r}for(let h=0;h<t;h++){const u=a[h].instancedBuffers[i];u.toArray?u.toArray(o,l):u.copyToArray?u.copyToArray(o,l):o[l]=u,l+=r}this._userInstancedBuffersStorage.vertexBuffers[i]?this._userInstancedBuffersStorage.vertexBuffers[i].updateDirectly(o,0):(this._userInstancedBuffersStorage.vertexBuffers[i]=new y(this.getEngine(),this._userInstancedBuffersStorage.data[i],i,!0,!1,r,!0),this._invalidateInstanceVertexArrayObject())}};V.prototype._invalidateInstanceVertexArrayObject=function(){if(!(!this._userInstancedBuffersStorage||this._userInstancedBuffersStorage.vertexArrayObjects===void 0)){for(const a in this._userInstancedBuffersStorage.vertexArrayObjects)this.getEngine().releaseVertexArrayObject(this._userInstancedBuffersStorage.vertexArrayObjects[a]);this._userInstancedBuffersStorage.vertexArrayObjects={}}};V.prototype._disposeInstanceSpecificData=function(){for(this._instanceDataStorage.instancesBuffer&&(this._instanceDataStorage.instancesBuffer.dispose(),this._instanceDataStorage.instancesBuffer=null);this.instances.length;)this.instances[0].dispose();for(const a in this.instancedBuffers)this._userInstancedBuffersStorage.vertexBuffers[a]&&this._userInstancedBuffersStorage.vertexBuffers[a].dispose();this._invalidateInstanceVertexArrayObject(),this.instancedBuffers={}};const Pu={effect:null,subMesh:null};class Or extends zo{constructor(e,t,i,s={},r=!0){super(e,t,r),this._textures={},this._textureArrays={},this._externalTextures={},this._floats={},this._ints={},this._floatsArrays={},this._colors3={},this._colors3Arrays={},this._colors4={},this._colors4Arrays={},this._vectors2={},this._vectors3={},this._vectors4={},this._quaternions={},this._quaternionsArrays={},this._matrices={},this._matrixArrays={},this._matrices3x3={},this._matrices2x2={},this._vectors2Arrays={},this._vectors3Arrays={},this._vectors4Arrays={},this._uniformBuffers={},this._textureSamplers={},this._storageBuffers={},this._cachedWorldViewMatrix=new L,this._cachedWorldViewProjectionMatrix=new L,this._multiview=!1,this._shaderPath=i,this._options={needAlphaBlending:!1,needAlphaTesting:!1,attributes:["position","normal","uv"],uniforms:["worldViewProjection"],uniformBuffers:[],samplers:[],externalTextures:[],samplerObjects:[],storageBuffers:[],defines:[],useClipPlane:!1,...s}}get shaderPath(){return this._shaderPath}set shaderPath(e){this._shaderPath=e}get options(){return this._options}getClassName(){return"ShaderMaterial"}needAlphaBlending(){return this.alpha<1||this._options.needAlphaBlending}needAlphaTesting(){return this._options.needAlphaTesting}_checkUniform(e){this._options.uniforms.indexOf(e)===-1&&this._options.uniforms.push(e)}setTexture(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._textures[e]=t,this}setTextureArray(e,t){return this._options.samplers.indexOf(e)===-1&&this._options.samplers.push(e),this._checkUniform(e),this._textureArrays[e]=t,this}setExternalTexture(e,t){return this._options.externalTextures.indexOf(e)===-1&&this._options.externalTextures.push(e),this._externalTextures[e]=t,this}setFloat(e,t){return this._checkUniform(e),this._floats[e]=t,this}setInt(e,t){return this._checkUniform(e),this._ints[e]=t,this}setFloats(e,t){return this._checkUniform(e),this._floatsArrays[e]=t,this}setColor3(e,t){return this._checkUniform(e),this._colors3[e]=t,this}setColor3Array(e,t){return this._checkUniform(e),this._colors3Arrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setColor4(e,t){return this._checkUniform(e),this._colors4[e]=t,this}setColor4Array(e,t){return this._checkUniform(e),this._colors4Arrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setVector2(e,t){return this._checkUniform(e),this._vectors2[e]=t,this}setVector3(e,t){return this._checkUniform(e),this._vectors3[e]=t,this}setVector4(e,t){return this._checkUniform(e),this._vectors4[e]=t,this}setQuaternion(e,t){return this._checkUniform(e),this._quaternions[e]=t,this}setQuaternionArray(e,t){return this._checkUniform(e),this._quaternionsArrays[e]=t.reduce((i,s)=>(s.toArray(i,i.length),i),[]),this}setMatrix(e,t){return this._checkUniform(e),this._matrices[e]=t,this}setMatrices(e,t){this._checkUniform(e);const i=new Float32Array(t.length*16);for(let s=0;s<t.length;s++)t[s].copyToArray(i,s*16);return this._matrixArrays[e]=i,this}setMatrix3x3(e,t){return this._checkUniform(e),this._matrices3x3[e]=t,this}setMatrix2x2(e,t){return this._checkUniform(e),this._matrices2x2[e]=t,this}setArray2(e,t){return this._checkUniform(e),this._vectors2Arrays[e]=t,this}setArray3(e,t){return this._checkUniform(e),this._vectors3Arrays[e]=t,this}setArray4(e,t){return this._checkUniform(e),this._vectors4Arrays[e]=t,this}setUniformBuffer(e,t){return this._options.uniformBuffers.indexOf(e)===-1&&this._options.uniformBuffers.push(e),this._uniformBuffers[e]=t,this}setTextureSampler(e,t){return this._options.samplerObjects.indexOf(e)===-1&&this._options.samplerObjects.push(e),this._textureSamplers[e]=t,this}setStorageBuffer(e,t){return this._options.storageBuffers.indexOf(e)===-1&&this._options.storageBuffers.push(e),this._storageBuffers[e]=t,this}isReadyForSubMesh(e,t,i){return this.isReady(e,i,t)}isReady(e,t,i){var s,r,n,o;const l=i&&this._storeEffectOnSubMeshes;if(this.isFrozen)if(l){if(i.effect&&i.effect._wasPreviouslyReady)return!0}else{const D=this._drawWrapper.effect;if(D&&D._wasPreviouslyReady&&D._wasPreviouslyUsingInstances===t)return!0}const h=this.getScene(),c=h.getEngine(),u=[],d=[],f=new Wa;let p=this._shaderPath,_=this._options.uniforms,m=this._options.uniformBuffers,v=this._options.samplers;c.getCaps().multiview&&h.activeCamera&&h.activeCamera.outputRenderTarget&&h.activeCamera.outputRenderTarget.getViewCount()>1&&(this._multiview=!0,u.push("#define MULTIVIEW"),this._options.uniforms.indexOf("viewProjection")!==-1&&this._options.uniforms.indexOf("viewProjectionR")===-1&&this._options.uniforms.push("viewProjectionR"));for(let D=0;D<this._options.defines.length;D++){const P=this._options.defines[D].indexOf("#define")===0?this._options.defines[D]:`#define ${this._options.defines[D]}`;u.push(P)}for(let D=0;D<this._options.attributes.length;D++)d.push(this._options.attributes[D]);if(e&&e.isVerticesDataPresent(y.ColorKind)&&(d.push(y.ColorKind),u.push("#define VERTEXCOLOR")),t&&(u.push("#define INSTANCES"),se.PushAttributesForInstances(d),e!=null&&e.hasThinInstances&&(u.push("#define THIN_INSTANCES"),e&&e.isVerticesDataPresent(y.ColorInstanceKind)&&(d.push(y.ColorInstanceKind),u.push("#define INSTANCESCOLOR")))),e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton){d.push(y.MatricesIndicesKind),d.push(y.MatricesWeightsKind),e.numBoneInfluencers>4&&(d.push(y.MatricesIndicesExtraKind),d.push(y.MatricesWeightsExtraKind));const D=e.skeleton;u.push("#define NUM_BONE_INFLUENCERS "+e.numBoneInfluencers),f.addCPUSkinningFallback(0,e),D.isUsingTextureForMatrices?(u.push("#define BONETEXTURE"),this._options.uniforms.indexOf("boneTextureWidth")===-1&&this._options.uniforms.push("boneTextureWidth"),this._options.samplers.indexOf("boneSampler")===-1&&this._options.samplers.push("boneSampler")):(u.push("#define BonesPerMesh "+(D.bones.length+1)),this._options.uniforms.indexOf("mBones")===-1&&this._options.uniforms.push("mBones"))}else u.push("#define NUM_BONE_INFLUENCERS 0");let x=0;const b=e?e.morphTargetManager:null;if(b){const D=b.supportsUVs&&u.indexOf("#define UV1")!==-1,P=b.supportsTangents&&u.indexOf("#define TANGENT")!==-1,O=b.supportsNormals&&u.indexOf("#define NORMAL")!==-1;x=b.numInfluencers,D&&u.push("#define MORPHTARGETS_UV"),P&&u.push("#define MORPHTARGETS_TANGENT"),O&&u.push("#define MORPHTARGETS_NORMAL"),x>0&&u.push("#define MORPHTARGETS"),b.isUsingTextureForTargets&&(u.push("#define MORPHTARGETS_TEXTURE"),this._options.uniforms.indexOf("morphTargetTextureIndices")===-1&&this._options.uniforms.push("morphTargetTextureIndices"),this._options.samplers.indexOf("morphTargets")===-1&&this._options.samplers.push("morphTargets")),u.push("#define NUM_MORPH_INFLUENCERS "+x);for(let N=0;N<x;N++)d.push(y.PositionKind+N),O&&d.push(y.NormalKind+N),P&&d.push(y.TangentKind+N),D&&d.push(y.UVKind+"_"+N);x>0&&(_=_.slice(),_.push("morphTargetInfluences"),_.push("morphTargetTextureInfo"),_.push("morphTargetTextureIndices"))}else u.push("#define NUM_MORPH_INFLUENCERS 0");if(e){const D=e.bakedVertexAnimationManager;D&&D.isEnabled&&(u.push("#define BAKED_VERTEX_ANIMATION_TEXTURE"),this._options.uniforms.indexOf("bakedVertexAnimationSettings")===-1&&this._options.uniforms.push("bakedVertexAnimationSettings"),this._options.uniforms.indexOf("bakedVertexAnimationTextureSizeInverted")===-1&&this._options.uniforms.push("bakedVertexAnimationTextureSizeInverted"),this._options.uniforms.indexOf("bakedVertexAnimationTime")===-1&&this._options.uniforms.push("bakedVertexAnimationTime"),this._options.samplers.indexOf("bakedVertexAnimationTexture")===-1&&this._options.samplers.push("bakedVertexAnimationTexture")),se.PrepareAttributesForBakedVertexAnimation(d,e,u)}for(const D in this._textures)if(!this._textures[D].isReady())return!1;e&&this._shouldTurnAlphaTestOn(e)&&u.push("#define ALPHATEST"),(this._options.useClipPlane===null&&!!h.clipPlane||this._options.useClipPlane)&&(u.push("#define CLIPPLANE"),_.indexOf("vClipPlane")===-1&&_.push("vClipPlane")),(this._options.useClipPlane===null&&!!h.clipPlane2||this._options.useClipPlane)&&(u.push("#define CLIPPLANE2"),_.indexOf("vClipPlane2")===-1&&_.push("vClipPlane2")),(this._options.useClipPlane===null&&!!h.clipPlane3||this._options.useClipPlane)&&(u.push("#define CLIPPLANE3"),_.indexOf("vClipPlane3")===-1&&_.push("vClipPlane3")),(this._options.useClipPlane===null&&!!h.clipPlane4||this._options.useClipPlane)&&(u.push("#define CLIPPLANE4"),_.indexOf("vClipPlane4")===-1&&_.push("vClipPlane4")),(this._options.useClipPlane===null&&!!h.clipPlane5||this._options.useClipPlane)&&(u.push("#define CLIPPLANE5"),_.indexOf("vClipPlane5")===-1&&_.push("vClipPlane5")),(this._options.useClipPlane===null&&!!h.clipPlane6||this._options.useClipPlane)&&(u.push("#define CLIPPLANE6"),_.indexOf("vClipPlane6")===-1&&_.push("vClipPlane6")),this.customShaderNameResolve&&(_=_.slice(),m=m.slice(),v=v.slice(),p=this.customShaderNameResolve(p,_,m,v,u,d));const S=l?i._getDrawWrapper():this._drawWrapper,C=(s=S==null?void 0:S.effect)!==null&&s!==void 0?s:null,E=(r=S==null?void 0:S.defines)!==null&&r!==void 0?r:null,A=u.join(`
`);let M=C;return E!==A&&(M=c.createEffect(p,{attributes:d,uniformsNames:_,uniformBuffersNames:m,samplers:v,defines:A,fallbacks:f,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousMorphTargets:x},shaderLanguage:this._options.shaderLanguage},c),l?i.setEffect(M,A,this._materialContext):S&&S.setEffect(M,A),this._onEffectCreatedObservable&&(Pu.effect=M,Pu.subMesh=(n=i!=null?i:e==null?void 0:e.subMeshes[0])!==null&&n!==void 0?n:null,this._onEffectCreatedObservable.notifyObservers(Pu))),M._wasPreviouslyUsingInstances=!!t,!((o=!(M!=null&&M.isReady()))!==null&&o!==void 0)||o?!1:(C!==M&&h.resetCachedMaterial(),M._wasPreviouslyReady=!0,!0)}bindOnlyWorldMatrix(e,t){const i=this.getScene(),s=t!=null?t:this.getEffect();!s||(this._options.uniforms.indexOf("world")!==-1&&s.setMatrix("world",e),this._options.uniforms.indexOf("worldView")!==-1&&(e.multiplyToRef(i.getViewMatrix(),this._cachedWorldViewMatrix),s.setMatrix("worldView",this._cachedWorldViewMatrix)),this._options.uniforms.indexOf("worldViewProjection")!==-1&&(e.multiplyToRef(i.getTransformMatrix(),this._cachedWorldViewProjectionMatrix),s.setMatrix("worldViewProjection",this._cachedWorldViewProjectionMatrix)))}bindForSubMesh(e,t,i){var s;this.bind(e,t,(s=i._drawWrapperOverride)===null||s===void 0?void 0:s.effect,i)}bind(e,t,i,s){var r;const n=s&&this._storeEffectOnSubMeshes,o=i!=null?i:n?s.effect:this.getEffect();if(!o)return;this._activeEffect=o,this.bindOnlyWorldMatrix(e,i);const l=this._options.uniformBuffers;let h=!1;if(o&&l&&l.length>0&&this.getScene().getEngine().supportsUniformBuffers)for(let u=0;u<l.length;++u)switch(l[u]){case"Mesh":t&&(t.getMeshUniformBuffer().bindToEffect(o,"Mesh"),t.transferToEffect(e));break;case"Scene":se.BindSceneUniformBuffer(o,this.getScene().getSceneUniformBuffer()),this.getScene().finalizeSceneUbo(),h=!0;break}const c=t&&n?this._mustRebind(this.getScene(),o,t.visibility):this.getScene().getCachedMaterial()!==this;if(o&&c){!h&&this._options.uniforms.indexOf("view")!==-1&&o.setMatrix("view",this.getScene().getViewMatrix()),!h&&this._options.uniforms.indexOf("projection")!==-1&&o.setMatrix("projection",this.getScene().getProjectionMatrix()),!h&&this._options.uniforms.indexOf("viewProjection")!==-1&&(o.setMatrix("viewProjection",this.getScene().getTransformMatrix()),this._multiview&&o.setMatrix("viewProjectionR",this.getScene()._transformMatrixR)),this.getScene().activeCamera&&this._options.uniforms.indexOf("cameraPosition")!==-1&&o.setVector3("cameraPosition",this.getScene().activeCamera.globalPosition),se.BindBonesParameters(t,o),se.BindClipPlane(o,this.getScene());let u;for(u in this._textures)o.setTexture(u,this._textures[u]);for(u in this._textureArrays)o.setTextureArray(u,this._textureArrays[u]);for(u in this._externalTextures)o.setExternalTexture(u,this._externalTextures[u]);for(u in this._ints)o.setInt(u,this._ints[u]);for(u in this._floats)o.setFloat(u,this._floats[u]);for(u in this._floatsArrays)o.setArray(u,this._floatsArrays[u]);for(u in this._colors3)o.setColor3(u,this._colors3[u]);for(u in this._colors3Arrays)o.setArray3(u,this._colors3Arrays[u]);for(u in this._colors4){const d=this._colors4[u];o.setFloat4(u,d.r,d.g,d.b,d.a)}for(u in this._colors4Arrays)o.setArray4(u,this._colors4Arrays[u]);for(u in this._vectors2)o.setVector2(u,this._vectors2[u]);for(u in this._vectors3)o.setVector3(u,this._vectors3[u]);for(u in this._vectors4)o.setVector4(u,this._vectors4[u]);for(u in this._quaternions)o.setQuaternion(u,this._quaternions[u]);for(u in this._matrices)o.setMatrix(u,this._matrices[u]);for(u in this._matrixArrays)o.setMatrices(u,this._matrixArrays[u]);for(u in this._matrices3x3)o.setMatrix3x3(u,this._matrices3x3[u]);for(u in this._matrices2x2)o.setMatrix2x2(u,this._matrices2x2[u]);for(u in this._vectors2Arrays)o.setArray2(u,this._vectors2Arrays[u]);for(u in this._vectors3Arrays)o.setArray3(u,this._vectors3Arrays[u]);for(u in this._vectors4Arrays)o.setArray4(u,this._vectors4Arrays[u]);for(u in this._quaternionsArrays)o.setArray4(u,this._quaternionsArrays[u]);for(u in this._uniformBuffers){const d=this._uniformBuffers[u].getBuffer();d&&o.bindUniformBuffer(d,u)}for(u in this._textureSamplers)o.setTextureSampler(u,this._textureSamplers[u]);for(u in this._storageBuffers)o.setStorageBuffer(u,this._storageBuffers[u])}if(o&&t&&(c||!this.isFrozen)){const u=t.morphTargetManager;u&&u.numInfluencers>0&&se.BindMorphTargetParameters(t,o);const d=t.bakedVertexAnimationManager;d&&d.isEnabled&&((r=t.bakedVertexAnimationManager)===null||r===void 0||r.bind(o,!!o._wasPreviouslyUsingInstances))}this._afterBind(t,o)}getActiveTextures(){const e=super.getActiveTextures();for(const t in this._textures)e.push(this._textures[t]);for(const t in this._textureArrays){const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.push(i[s])}return e}hasTexture(e){if(super.hasTexture(e))return!0;for(const t in this._textures)if(this._textures[t]===e)return!0;for(const t in this._textureArrays){const i=this._textureArrays[t];for(let s=0;s<i.length;s++)if(i[s]===e)return!0}return!1}clone(e){const t=xe.Clone(()=>new Or(e,this.getScene(),this._shaderPath,this._options,this._storeEffectOnSubMeshes),this);t.name=e,t.id=e,typeof t._shaderPath=="object"&&(t._shaderPath={...t._shaderPath}),this._options={...this._options},Object.keys(this._options).forEach(i=>{const s=this._options[i];Array.isArray(s)&&(this._options[i]=s.slice(0))}),this.stencil.copyTo(t.stencil);for(const i in this._textures)t.setTexture(i,this._textures[i]);for(const i in this._textureArrays)t.setTextureArray(i,this._textureArrays[i]);for(const i in this._externalTextures)t.setExternalTexture(i,this._externalTextures[i]);for(const i in this._ints)t.setInt(i,this._ints[i]);for(const i in this._floats)t.setFloat(i,this._floats[i]);for(const i in this._floatsArrays)t.setFloats(i,this._floatsArrays[i]);for(const i in this._colors3)t.setColor3(i,this._colors3[i]);for(const i in this._colors3Arrays)t._colors3Arrays[i]=this._colors3Arrays[i];for(const i in this._colors4)t.setColor4(i,this._colors4[i]);for(const i in this._colors4Arrays)t._colors4Arrays[i]=this._colors4Arrays[i];for(const i in this._vectors2)t.setVector2(i,this._vectors2[i]);for(const i in this._vectors3)t.setVector3(i,this._vectors3[i]);for(const i in this._vectors4)t.setVector4(i,this._vectors4[i]);for(const i in this._quaternions)t.setQuaternion(i,this._quaternions[i]);for(const i in this._quaternionsArrays)t._quaternionsArrays[i]=this._quaternionsArrays[i];for(const i in this._matrices)t.setMatrix(i,this._matrices[i]);for(const i in this._matrixArrays)t._matrixArrays[i]=this._matrixArrays[i].slice();for(const i in this._matrices3x3)t.setMatrix3x3(i,this._matrices3x3[i]);for(const i in this._matrices2x2)t.setMatrix2x2(i,this._matrices2x2[i]);for(const i in this._vectors2Arrays)t.setArray2(i,this._vectors2Arrays[i]);for(const i in this._vectors3Arrays)t.setArray3(i,this._vectors3Arrays[i]);for(const i in this._vectors4Arrays)t.setArray4(i,this._vectors4Arrays[i]);for(const i in this._uniformBuffers)t.setUniformBuffer(i,this._uniformBuffers[i]);for(const i in this._textureSamplers)t.setTextureSampler(i,this._textureSamplers[i]);for(const i in this._storageBuffers)t.setStorageBuffer(i,this._storageBuffers[i]);return t}dispose(e,t,i){if(t){let s;for(s in this._textures)this._textures[s].dispose();for(s in this._textureArrays){const r=this._textureArrays[s];for(let n=0;n<r.length;n++)r[n].dispose()}}this._textures={},super.dispose(e,t,i)}serialize(){const e=xe.Serialize(this);e.customType="BABYLON.ShaderMaterial",e.uniqueId=this.uniqueId,e.options=this._options,e.shaderPath=this._shaderPath,e.storeEffectOnSubMeshes=this._storeEffectOnSubMeshes;let t;e.stencil=this.stencil.serialize(),e.textures={};for(t in this._textures)e.textures[t]=this._textures[t].serialize();e.textureArrays={};for(t in this._textureArrays){e.textureArrays[t]=[];const i=this._textureArrays[t];for(let s=0;s<i.length;s++)e.textureArrays[t].push(i[s].serialize())}e.ints={};for(t in this._ints)e.ints[t]=this._ints[t];e.floats={};for(t in this._floats)e.floats[t]=this._floats[t];e.FloatArrays={};for(t in this._floatsArrays)e.FloatArrays[t]=this._floatsArrays[t];e.colors3={};for(t in this._colors3)e.colors3[t]=this._colors3[t].asArray();e.colors3Arrays={};for(t in this._colors3Arrays)e.colors3Arrays[t]=this._colors3Arrays[t];e.colors4={};for(t in this._colors4)e.colors4[t]=this._colors4[t].asArray();e.colors4Arrays={};for(t in this._colors4Arrays)e.colors4Arrays[t]=this._colors4Arrays[t];e.vectors2={};for(t in this._vectors2)e.vectors2[t]=this._vectors2[t].asArray();e.vectors3={};for(t in this._vectors3)e.vectors3[t]=this._vectors3[t].asArray();e.vectors4={};for(t in this._vectors4)e.vectors4[t]=this._vectors4[t].asArray();e.quaternions={};for(t in this._quaternions)e.quaternions[t]=this._quaternions[t].asArray();e.matrices={};for(t in this._matrices)e.matrices[t]=this._matrices[t].asArray();e.matrixArray={};for(t in this._matrixArrays)e.matrixArray[t]=this._matrixArrays[t];e.matrices3x3={};for(t in this._matrices3x3)e.matrices3x3[t]=this._matrices3x3[t];e.matrices2x2={};for(t in this._matrices2x2)e.matrices2x2[t]=this._matrices2x2[t];e.vectors2Arrays={};for(t in this._vectors2Arrays)e.vectors2Arrays[t]=this._vectors2Arrays[t];e.vectors3Arrays={};for(t in this._vectors3Arrays)e.vectors3Arrays[t]=this._vectors3Arrays[t];e.vectors4Arrays={};for(t in this._vectors4Arrays)e.vectors4Arrays[t]=this._vectors4Arrays[t];e.quaternionsArrays={};for(t in this._quaternionsArrays)e.quaternionsArrays[t]=this._quaternionsArrays[t];return e}static Parse(e,t,i){const s=xe.Parse(()=>new Or(e.name,t,e.shaderPath,e.options,e.storeEffectOnSubMeshes),e,t,i);let r;e.stencil&&s.stencil.parse(e.stencil,t,i);for(r in e.textures)s.setTexture(r,H.Parse(e.textures[r],t,i));for(r in e.textureArrays){const n=e.textureArrays[r],o=new Array;for(let l=0;l<n.length;l++)o.push(H.Parse(n[l],t,i));s.setTextureArray(r,o)}for(r in e.ints)s.setInt(r,e.ints[r]);for(r in e.floats)s.setFloat(r,e.floats[r]);for(r in e.floatsArrays)s.setFloats(r,e.floatsArrays[r]);for(r in e.colors3)s.setColor3(r,re.FromArray(e.colors3[r]));for(r in e.colors3Arrays){const n=e.colors3Arrays[r].reduce((o,l,h)=>(h%3===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>re.FromArray(o));s.setColor3Array(r,n)}for(r in e.colors4)s.setColor4(r,J.FromArray(e.colors4[r]));for(r in e.colors4Arrays){const n=e.colors4Arrays[r].reduce((o,l,h)=>(h%4===0?o.push([l]):o[o.length-1].push(l),o),[]).map(o=>J.FromArray(o));s.setColor4Array(r,n)}for(r in e.vectors2)s.setVector2(r,le.FromArray(e.vectors2[r]));for(r in e.vectors3)s.setVector3(r,g.FromArray(e.vectors3[r]));for(r in e.vectors4)s.setVector4(r,Ge.FromArray(e.vectors4[r]));for(r in e.quaternions)s.setQuaternion(r,Q.FromArray(e.quaternions[r]));for(r in e.matrices)s.setMatrix(r,L.FromArray(e.matrices[r]));for(r in e.matrixArray)s._matrixArrays[r]=new Float32Array(e.matrixArray[r]);for(r in e.matrices3x3)s.setMatrix3x3(r,e.matrices3x3[r]);for(r in e.matrices2x2)s.setMatrix2x2(r,e.matrices2x2[r]);for(r in e.vectors2Arrays)s.setArray2(r,e.vectors2Arrays[r]);for(r in e.vectors3Arrays)s.setArray3(r,e.vectors3Arrays[r]);for(r in e.vectors4Arrays)s.setArray4(r,e.vectors4Arrays[r]);for(r in e.quaternionsArrays)s.setArray4(r,e.quaternionsArrays[r]);return s}static ParseFromFileAsync(e,t,i,s=""){return new Promise((r,n)=>{const o=new Ui;o.addEventListener("readystatechange",()=>{if(o.readyState==4)if(o.status==200){const l=JSON.parse(o.responseText),h=this.Parse(l,i||ye.LastCreatedScene,s);e&&(h.name=e),r(h)}else n("Unable to load the ShaderMaterial")}),o.open("GET",t),o.send()})}static ParseFromSnippetAsync(e,t,i=""){return new Promise((s,r)=>{const n=new Ui;n.addEventListener("readystatechange",()=>{if(n.readyState==4)if(n.status==200){const o=JSON.parse(JSON.parse(n.responseText).jsonPayload),l=JSON.parse(o.shaderMaterial),h=this.Parse(l,t||ye.LastCreatedScene,i);h.snippetId=e,s(h)}else r("Unable to load the snippet "+e)}),n.open("GET",this.SnippetUrl+"/"+e.replace(/#/g,"/")),n.send()})}}Or.SnippetUrl="https://snippet.babylonjs.com";Or.CreateFromSnippetAsync=Or.ParseFromSnippetAsync;he("BABYLON.ShaderMaterial",Or);const kS="colorPixelShader",GS=`#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
#define VERTEXCOLOR
varying vec4 vColor;
#else
uniform vec4 color;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
gl_FragColor=vColor;
#else
gl_FragColor=color;
#endif
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[kS]=GS;const zS="colorVertexShader",WS=`attribute vec3 position;
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#include<clipPlaneVertex>
#include<vertexColorMixing>
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[zS]=WS;V._LinesMeshParser=(a,e)=>ia.Parse(a,e);class ia extends V{constructor(e,t=null,i=null,s=null,r,n,o,l){super(e,t,i,s,r),this.useVertexColor=n,this.useVertexAlpha=o,this.color=new re(1,1,1),this.alpha=1,s&&(this.color=s.color.clone(),this.alpha=s.alpha,this.useVertexColor=s.useVertexColor,this.useVertexAlpha=s.useVertexAlpha),this.intersectionThreshold=.1;const h=[],c={attributes:[y.PositionKind],uniforms:["vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","world","viewProjection"],needAlphaBlending:!0,defines:h,useClipPlane:null};o===!1?c.needAlphaBlending=!1:c.defines.push("#define VERTEXALPHA"),n?(c.defines.push("#define VERTEXCOLOR"),c.attributes.push(y.ColorKind)):(c.uniforms.push("color"),this._color4=new J),l?this.material=l:this.material=new Or("colorShader",this.getScene(),"color",c,!1)}_isShaderMaterial(e){return e.getClassName()==="ShaderMaterial"}isReady(){return this._lineMaterial.isReady(this,!!this._userInstancedBuffersStorage)?super.isReady():!1}getClassName(){return"LinesMesh"}get material(){return this._lineMaterial}set material(e){this._lineMaterial=e,this._lineMaterial.fillMode=ne.LineListDrawMode}get checkCollisions(){return!1}set checkCollisions(e){}_bind(){if(!this._geometry)return this;const e=this._lineMaterial.getEffect(),t=this.isUnIndexed?null:this._geometry.getIndexBuffer();if(this._userInstancedBuffersStorage?this._geometry._bind(e,t,this._userInstancedBuffersStorage.vertexBuffers,this._userInstancedBuffersStorage.vertexArrayObjects):this._geometry._bind(e,t),!this.useVertexColor&&this._isShaderMaterial(this._lineMaterial)){const{r:i,g:s,b:r}=this.color;this._color4.set(i,s,r,this.alpha),this._lineMaterial.setColor4("color",this._color4)}return this}_draw(e,t,i){if(!this._geometry||!this._geometry.getVertexBuffers()||!this._unIndexed&&!this._geometry.getIndexBuffer())return this;const s=this.getScene().getEngine();return this._unIndexed?s.drawArraysType(ne.LineListDrawMode,e.verticesStart,e.verticesCount,i):s.drawElementsType(ne.LineListDrawMode,e.indexStart,e.indexCount,i),this}dispose(e){this._lineMaterial.dispose(!1,!1,!0),super.dispose(e)}clone(e,t=null,i){return new ia(e,this.getScene(),t,this,i)}createInstance(e){const t=new nm(e,this);if(this.instancedBuffers){t.instancedBuffers={};for(const i in this.instancedBuffers)t.instancedBuffers[i]=this.instancedBuffers[i]}return t}serialize(e){super.serialize(e),e.color=this.color.asArray(),e.alpha=this.alpha}static Parse(e,t){const i=new ia(e.name,t);return i.color=re.FromArray(e.color),i.alpha=e.alpha,i}}class nm extends rm{constructor(e,t){super(e,t),this.intersectionThreshold=t.intersectionThreshold}getClassName(){return"InstancedLinesMesh"}}function am(a){const e=[],t=[],i=a.lines,s=a.colors,r=[];let n=0;for(let l=0;l<i.length;l++){const h=i[l];for(let c=0;c<h.length;c++){if(t.push(h[c].x,h[c].y,h[c].z),s){const u=s[l];r.push(u[c].r,u[c].g,u[c].b,u[c].a)}c>0&&(e.push(n-1),e.push(n)),n++}}const o=new de;return o.indices=e,o.positions=t,s&&(o.colors=r),o}function om(a){const e=a.dashSize||3,t=a.gapSize||1,i=a.dashNb||200,s=a.points,r=new Array,n=new Array,o=g.Zero();let l=0,h=0,c=0,u=0,d=0,f=0,p=0;for(p=0;p<s.length-1;p++)s[p+1].subtractToRef(s[p],o),l+=o.length();for(c=l/i,u=e*c/(e+t),p=0;p<s.length-1;p++){s[p+1].subtractToRef(s[p],o),h=Math.floor(o.length()/c),o.normalize();for(let m=0;m<h;m++)d=c*m,r.push(s[p].x+d*o.x,s[p].y+d*o.y,s[p].z+d*o.z),r.push(s[p].x+(d+u)*o.x,s[p].y+(d+u)*o.y,s[p].z+(d+u)*o.z),n.push(f,f+1),f+=2}const _=new de;return _.positions=r,_.indices=n,_}function lm(a,e,t){const i=e.instance,s=e.lines,r=e.colors;if(i){const h=i.getVerticesData(y.PositionKind);let c,u;r&&(c=i.getVerticesData(y.ColorKind));let d=0,f=0;for(let p=0;p<s.length;p++){const _=s[p];for(let m=0;m<_.length;m++)h[d]=_[m].x,h[d+1]=_[m].y,h[d+2]=_[m].z,r&&c&&(u=r[p],c[f]=u[m].r,c[f+1]=u[m].g,c[f+2]=u[m].b,c[f+3]=u[m].a,f+=4),d+=3}return i.updateVerticesData(y.PositionKind,h,!1,!1),r&&c&&i.updateVerticesData(y.ColorKind,c,!1,!1),i}const n=!!r,o=new ia(a,t,null,void 0,void 0,n,e.useVertexAlpha,e.material);return am(e).applyToMesh(o,e.updatable),o}function Kc(a,e,t=null){const i=e.colors?[e.colors]:null;return lm(a,{lines:[e.points],updatable:e.updatable,instance:e.instance,colors:i,useVertexAlpha:e.useVertexAlpha,material:e.material},t)}function hm(a,e,t=null){const i=e.points,s=e.instance,r=e.gapSize||1,n=e.dashSize||3;if(s){const h=c=>{const u=g.Zero(),d=c.length/6;let f=0,p=0,_=0,m=0,v=0,x=0,b=0,S=0;for(b=0;b<i.length-1;b++)i[b+1].subtractToRef(i[b],u),f+=u.length();_=f/d;const C=s._creationDataStorage.dashSize,E=s._creationDataStorage.gapSize;for(m=C*_/(C+E),b=0;b<i.length-1;b++)for(i[b+1].subtractToRef(i[b],u),p=Math.floor(u.length()/_),u.normalize(),S=0;S<p&&x<c.length;)v=_*S,c[x]=i[b].x+v*u.x,c[x+1]=i[b].y+v*u.y,c[x+2]=i[b].z+v*u.z,c[x+3]=i[b].x+(v+m)*u.x,c[x+4]=i[b].y+(v+m)*u.y,c[x+5]=i[b].z+(v+m)*u.z,x+=6,S++;for(;x<c.length;)c[x]=i[b].x,c[x+1]=i[b].y,c[x+2]=i[b].z,x+=3};return(e.dashNb||e.dashSize||e.gapSize||e.useVertexAlpha||e.material)&&B.Warn("You have used an option other than points with the instance option. Please be aware that these other options will be ignored."),s.updateMeshPositions(h,!1),s}const o=new ia(a,t,null,void 0,void 0,void 0,e.useVertexAlpha,e.material);return om(e).applyToMesh(o,e.updatable),o._creationDataStorage=new E_,o._creationDataStorage.dashSize=n,o._creationDataStorage.gapSize=r,o}de.CreateLineSystem=am;de.CreateDashedLines=om;V.CreateLines=(a,e,t=null,i=!1,s=null)=>Kc(a,{points:e,updatable:i,instance:s},t);V.CreateDashedLines=(a,e,t,i,s,r=null,n,o)=>hm(a,{points:e,dashSize:t,gapSize:i,dashNb:s,updatable:n,instance:o},r);function cm(a){let e=a.pathArray;const t=a.closeArray||!1,i=a.closePath||!1,s=a.invertUV||!1,r=Math.floor(e[0].length/2);let n=a.offset||r;n=n>r?r:Math.floor(n);const o=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,l=a.uvs,h=a.colors,c=[],u=[],d=[],f=[],p=[],_=[],m=[],v=[];let x;const b=[],S=[];let C,E,A;if(e.length<2){const Xe=[],Re=[];for(E=0;E<e[0].length-n;E++)Xe.push(e[0][E]),Re.push(e[0][E+n]);e=[Xe,Re]}let M=0;const D=i?1:0;let P,O;x=e[0].length;let N,$;for(C=0;C<e.length;C++){for(m[C]=0,p[C]=[0],P=e[C],O=P.length,x=x<O?x:O,A=0;A<O;)c.push(P[A].x,P[A].y,P[A].z),A>0&&(N=P[A].subtract(P[A-1]).length(),$=N+m[C],p[C].push($),m[C]=$),A++;i&&(A--,c.push(P[0].x,P[0].y,P[0].z),N=P[A].subtract(P[0]).length(),$=N+m[C],p[C].push($),m[C]=$),b[C]=O+D,S[C]=M,M+=O+D}let W,K,te=null,ve=null;for(E=0;E<x+D;E++){for(v[E]=0,_[E]=[0],C=0;C<e.length-1;C++)W=e[C],K=e[C+1],E===x?(te=W[0],ve=K[0]):(te=W[E],ve=K[E]),N=ve.subtract(te).length(),$=N+v[E],_[E].push($),v[E]=$;t&&ve&&te&&(W=e[C],K=e[0],E===x&&(ve=K[0]),N=ve.subtract(te).length(),$=N+v[E],v[E]=$)}let _e,j;if(l)for(C=0;C<l.length;C++)f.push(l[C].x,nt.UseOpenGLOrientationForUV?1-l[C].y:l[C].y);else for(C=0;C<e.length;C++)for(E=0;E<x+D;E++)_e=m[C]!=0?p[C][E]/m[C]:0,j=v[E]!=0?_[E][C]/v[E]:0,s?f.push(j,_e):f.push(_e,nt.UseOpenGLOrientationForUV?1-j:j);C=0;let ee=0,F=b[C]-1,z=b[C+1]-1,Z=F<z?F:z,Ee=S[1]-S[0];const He=t?b.length:b.length-1;for(;ee<=Z&&C<He;)u.push(ee,ee+Ee,ee+1),u.push(ee+Ee+1,ee+1,ee+Ee),ee+=1,ee===Z&&(C++,C===b.length-1?(Ee=S[0]-S[C],F=b[C]-1,z=b[0]-1):(Ee=S[C+1]-S[C],F=b[C]-1,z=b[C+1]-1),ee=S[C],Z=F<z?F+ee:z+ee);if(de.ComputeNormals(c,u,d),i){let Xe=0,Re=0;for(C=0;C<e.length;C++)Xe=S[C]*3,C+1<e.length?Re=(S[C+1]-1)*3:Re=d.length-3,d[Xe]=(d[Xe]+d[Re])*.5,d[Xe+1]=(d[Xe+1]+d[Re+1])*.5,d[Xe+2]=(d[Xe+2]+d[Re+2])*.5,d[Re]=d[Xe],d[Re+1]=d[Xe+1],d[Re+2]=d[Xe+2]}de._ComputeSides(o,c,u,d,f,a.frontUVs,a.backUVs);let ut=null;if(h){ut=new Float32Array(h.length*4);for(let Xe=0;Xe<h.length;Xe++)ut[Xe*4]=h[Xe].r,ut[Xe*4+1]=h[Xe].g,ut[Xe*4+2]=h[Xe].b,ut[Xe*4+3]=h[Xe].a}const me=new de,Se=new Float32Array(c),it=new Float32Array(d),Zt=new Float32Array(f);return me.indices=u,me.positions=Se,me.normals=it,me.uvs=Zt,ut&&me.set(ut,y.ColorKind),i&&(me._idx=S),me}function Ba(a,e,t=null){const i=e.pathArray,s=e.closeArray,r=e.closePath,n=V._GetDefaultSideOrientation(e.sideOrientation),o=e.instance,l=e.updatable;if(o){const h=G.Vector3[0].setAll(Number.MAX_VALUE),c=G.Vector3[1].setAll(-Number.MAX_VALUE),u=f=>{let p=i[0].length;const _=o;let m=0;const v=_._originalBuilderSideOrientation===V.DOUBLESIDE?2:1;for(let x=1;x<=v;++x)for(let b=0;b<i.length;++b){const S=i[b],C=S.length;p=p<C?p:C;for(let E=0;E<p;++E){const A=S[E];f[m]=A.x,f[m+1]=A.y,f[m+2]=A.z,h.minimizeInPlaceFromFloats(A.x,A.y,A.z),c.maximizeInPlaceFromFloats(A.x,A.y,A.z),m+=3}if(_._creationDataStorage&&_._creationDataStorage.closePath){const E=S[0];f[m]=E.x,f[m+1]=E.y,f[m+2]=E.z,m+=3}}},d=o.getVerticesData(y.PositionKind);if(u(d),o.hasBoundingInfo?o.getBoundingInfo().reConstruct(h,c,o._worldMatrix):o.buildBoundingInfo(h,c,o._worldMatrix),o.updateVerticesData(y.PositionKind,d,!1,!1),e.colors){const f=o.getVerticesData(y.ColorKind);for(let p=0,_=0;p<e.colors.length;p++,_+=4){const m=e.colors[p];f[_]=m.r,f[_+1]=m.g,f[_+2]=m.b,f[_+3]=m.a}o.updateVerticesData(y.ColorKind,f,!1,!1)}if(e.uvs){const f=o.getVerticesData(y.UVKind);for(let p=0;p<e.uvs.length;p++)f[p*2]=e.uvs[p].x,f[p*2+1]=nt.UseOpenGLOrientationForUV?1-e.uvs[p].y:e.uvs[p].y;o.updateVerticesData(y.UVKind,f,!1,!1)}if(!o.areNormalsFrozen||o.isFacetDataEnabled){const f=o.getIndices(),p=o.getVerticesData(y.NormalKind),_=o.isFacetDataEnabled?o.getFacetDataParameters():null;if(de.ComputeNormals(d,f,p,_),o._creationDataStorage&&o._creationDataStorage.closePath){let m=0,v=0;for(let x=0;x<i.length;x++)m=o._creationDataStorage.idx[x]*3,x+1<i.length?v=(o._creationDataStorage.idx[x+1]-1)*3:v=p.length-3,p[m]=(p[m]+p[v])*.5,p[m+1]=(p[m+1]+p[v+1])*.5,p[m+2]=(p[m+2]+p[v+2])*.5,p[v]=p[m],p[v+1]=p[m+1],p[v+2]=p[m+2]}o.areNormalsFrozen||o.updateVerticesData(y.NormalKind,p,!1,!1)}return o}else{const h=new V(a,t);h._originalBuilderSideOrientation=n,h._creationDataStorage=new E_;const c=cm(e);return r&&(h._creationDataStorage.idx=c._idx),h._creationDataStorage.closePath=r,h._creationDataStorage.closeArray=s,c.applyToMesh(h,l),h}}de.CreateRibbon=cm;V.CreateRibbon=(a,e,t=!1,i,s,r,n=!1,o,l)=>Ba(a,{pathArray:e,closeArray:t,closePath:i,offset:s,updatable:n,sideOrientation:o,instance:l},r);function e0(a,e,t=null){const i=e.path,s=e.shape,r=e.scale||1,n=e.rotation||0,o=e.cap===0?0:e.cap||V.NO_CAP,l=e.updatable,h=V._GetDefaultSideOrientation(e.sideOrientation),c=e.instance||null,u=e.invertUV||!1,d=e.closeShape||!1,f=e.closePath||!1;return dm(a,s,i,r,n,null,null,f,d,o,!1,t,!!l,h,c,u,e.frontUVs||null,e.backUVs||null,e.firstNormal||null,!!e.adjustFrame)}function um(a,e,t=null){const i=e.path,s=e.shape,r=e.scaleFunction||(()=>1),n=e.rotationFunction||(()=>0),o=e.closePath||e.ribbonCloseArray||!1,l=e.closeShape||e.ribbonClosePath||!1,h=e.cap===0?0:e.cap||V.NO_CAP,c=e.updatable,u=e.firstNormal||null,d=e.adjustFrame||!1,f=V._GetDefaultSideOrientation(e.sideOrientation),p=e.instance,_=e.invertUV||!1;return dm(a,s,i,null,null,r,n,o,l,h,!0,t,!!c,f,p||null,_,e.frontUVs||null,e.backUVs||null,u,d)}function dm(a,e,t,i,s,r,n,o,l,h,c,u,d,f,p,_,m,v,x,b){const S=(D,P,O,N,$,W,K,te,ve,_e,j)=>{const ee=O.getTangents(),F=O.getNormals(),z=O.getBinormals(),Z=O.getDistances();if(j){for(let Re=0;Re<ee.length;Re++)if(ee[Re].x==0&&ee[Re].y==0&&ee[Re].z==0&&ee[Re].copyFrom(ee[Re-1]),F[Re].x==0&&F[Re].y==0&&F[Re].z==0&&F[Re].copyFrom(F[Re-1]),z[Re].x==0&&z[Re].y==0&&z[Re].z==0&&z[Re].copyFrom(z[Re-1]),Re>0){let rt=ee[Re-1];g.Dot(rt,ee[Re])<0&&ee[Re].scaleInPlace(-1),rt=F[Re-1],g.Dot(rt,F[Re])<0&&F[Re].scaleInPlace(-1),rt=z[Re-1],g.Dot(rt,z[Re])<0&&z[Re].scaleInPlace(-1)}}let Ee=0;const He=()=>$!==null?$:1,me=_e&&te?te:()=>W!==null?W:0,Se=_e&&K?K:He;let it=ve===V.NO_CAP||ve===V.CAP_END?0:2;const Zt=G.Matrix[0];for(let Re=0;Re<P.length;Re++){const rt=new Array,xt=me(Re,Z[Re]),At=Se(Re,Z[Re]);L.RotationAxisToRef(ee[Re],Ee,Zt);for(let Ut=0;Ut<D.length;Ut++){const ms=ee[Re].scale(D[Ut].z).add(F[Re].scale(D[Ut].x)).add(z[Re].scale(D[Ut].y)),wi=g.Zero();g.TransformCoordinatesToRef(ms,Zt,wi),wi.scaleInPlace(At).addInPlace(P[Re]),rt[Ut]=wi}N[it]=rt,Ee+=xt,it++}const Xe=Re=>{const rt=Array(),xt=g.Zero();let At;for(At=0;At<Re.length;At++)xt.addInPlace(Re[At]);for(xt.scaleInPlace(1/Re.length),At=0;At<Re.length;At++)rt.push(xt);return rt};switch(ve){case V.NO_CAP:break;case V.CAP_START:N[0]=Xe(N[2]),N[1]=N[2];break;case V.CAP_END:N[it]=N[it-1],N[it+1]=Xe(N[it-1]);break;case V.CAP_ALL:N[0]=Xe(N[2]),N[1]=N[2],N[it]=N[it-1],N[it+1]=Xe(N[it-1]);break}return N};let C,E;if(p){const D=p._creationDataStorage;return C=x?D.path3D.update(t,x):D.path3D.update(t),E=S(e,t,D.path3D,D.pathArray,i,s,r,n,D.cap,c,b),p=Ba("",{pathArray:E,closeArray:!1,closePath:!1,offset:0,updatable:!1,sideOrientation:0,instance:p},u||void 0),p}C=x?new Al(t,x):new Al(t);const A=new Array;h=h<0||h>3?0:h,E=S(e,t,C,A,i,s,r,n,h,c,b);const M=Ba(a,{pathArray:E,closeArray:o,closePath:l,updatable:d,sideOrientation:f,invertUV:_,frontUVs:m||void 0,backUVs:v||void 0},u);return M._creationDataStorage.pathArray=E,M._creationDataStorage.path3D=C,M._creationDataStorage.cap=h,M}V.ExtrudeShape=(a,e,t,i,s,r,n=null,o,l,h)=>{const c={shape:e,path:t,scale:i,rotation:s,cap:r===0?0:r||V.NO_CAP,sideOrientation:l,instance:h,updatable:o};return e0(a,c,n)};V.ExtrudeShapeCustom=(a,e,t,i,s,r,n,o,l,h,c,u)=>{const d={shape:e,path:t,scaleFunction:i,rotationFunction:s,ribbonCloseArray:r,ribbonClosePath:n,cap:o===0?0:o||V.NO_CAP,sideOrientation:c,instance:u,updatable:h};return um(a,d,l)};Te.prototype._debugPushGroup=function(a,e){};Te.prototype._debugPopGroup=function(a){};Te.prototype._debugInsertMarker=function(a,e){};Te.prototype._debugFlushPendingCommands=function(){};class HS{constructor(){this._timeElapsedQueryEnded=!1}}class XS{constructor(){this.occlusionInternalRetryCounter=0,this.isOcclusionQueryInProgress=!1,this.isOccluded=!1,this.occlusionRetryCount=-1,this.occlusionType=ct.OCCLUSION_TYPE_NONE,this.occlusionQueryAlgorithmType=ct.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE,this.forceRenderingWhenOccluded=!1}}k.prototype.createQuery=function(){const a=this._gl.createQuery();if(!a)throw new Error("Unable to create Occlusion Query");return a};k.prototype.deleteQuery=function(a){return this._gl.deleteQuery(a),this};k.prototype.isQueryResultAvailable=function(a){return this._gl.getQueryParameter(a,this._gl.QUERY_RESULT_AVAILABLE)};k.prototype.getQueryResult=function(a){return this._gl.getQueryParameter(a,this._gl.QUERY_RESULT)};k.prototype.beginOcclusionQuery=function(a,e){const t=this._getGlAlgorithmType(a);return this._gl.beginQuery(t,e),!0};k.prototype.endOcclusionQuery=function(a){const e=this._getGlAlgorithmType(a);return this._gl.endQuery(e),this};k.prototype._createTimeQuery=function(){const a=this.getCaps().timerQuery;return a.createQueryEXT?a.createQueryEXT():this.createQuery()};k.prototype._deleteTimeQuery=function(a){const e=this.getCaps().timerQuery;if(e.deleteQueryEXT){e.deleteQueryEXT(a);return}this.deleteQuery(a)};k.prototype._getTimeQueryResult=function(a){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(a,e.QUERY_RESULT_EXT):this.getQueryResult(a)};k.prototype._getTimeQueryAvailability=function(a){const e=this.getCaps().timerQuery;return e.getQueryObjectEXT?e.getQueryObjectEXT(a,e.QUERY_RESULT_AVAILABLE_EXT):this.isQueryResultAvailable(a)};k.prototype.startTimeQuery=function(){const a=this.getCaps(),e=a.timerQuery;if(!e)return null;const t=new HS;if(this._gl.getParameter(e.GPU_DISJOINT_EXT),a.canUseTimestampForTimerQuery)t._startTimeQuery=this._createTimeQuery(),e.queryCounterEXT(t._startTimeQuery,e.TIMESTAMP_EXT);else{if(this._currentNonTimestampToken)return this._currentNonTimestampToken;t._timeElapsedQuery=this._createTimeQuery(),e.beginQueryEXT?e.beginQueryEXT(e.TIME_ELAPSED_EXT,t._timeElapsedQuery):this._gl.beginQuery(e.TIME_ELAPSED_EXT,t._timeElapsedQuery),this._currentNonTimestampToken=t}return t};k.prototype.endTimeQuery=function(a){const e=this.getCaps(),t=e.timerQuery;if(!t||!a)return-1;if(e.canUseTimestampForTimerQuery){if(!a._startTimeQuery)return-1;a._endTimeQuery||(a._endTimeQuery=this._createTimeQuery(),t.queryCounterEXT(a._endTimeQuery,t.TIMESTAMP_EXT))}else if(!a._timeElapsedQueryEnded){if(!a._timeElapsedQuery)return-1;t.endQueryEXT?t.endQueryEXT(t.TIME_ELAPSED_EXT):(this._gl.endQuery(t.TIME_ELAPSED_EXT),this._currentNonTimestampToken=null),a._timeElapsedQueryEnded=!0}const i=this._gl.getParameter(t.GPU_DISJOINT_EXT);let s=!1;if(a._endTimeQuery?s=this._getTimeQueryAvailability(a._endTimeQuery):a._timeElapsedQuery&&(s=this._getTimeQueryAvailability(a._timeElapsedQuery)),s&&!i){let r=0;if(e.canUseTimestampForTimerQuery){if(!a._startTimeQuery||!a._endTimeQuery)return-1;const n=this._getTimeQueryResult(a._startTimeQuery);r=this._getTimeQueryResult(a._endTimeQuery)-n,this._deleteTimeQuery(a._startTimeQuery),this._deleteTimeQuery(a._endTimeQuery),a._startTimeQuery=null,a._endTimeQuery=null}else{if(!a._timeElapsedQuery)return-1;r=this._getTimeQueryResult(a._timeElapsedQuery),this._deleteTimeQuery(a._timeElapsedQuery),a._timeElapsedQuery=null,a._timeElapsedQueryEnded=!1}return r}return-1};k.prototype._captureGPUFrameTime=!1;k.prototype._gpuFrameTime=new _r;k.prototype.getGPUFrameTimeCounter=function(){return this._gpuFrameTime};k.prototype.captureGPUFrameTime=function(a){a!==this._captureGPUFrameTime&&(this._captureGPUFrameTime=a,a?(this._onBeginFrameObserver=this.onBeginFrameObservable.add(()=>{this._gpuFrameTimeToken||(this._gpuFrameTimeToken=this.startTimeQuery())}),this._onEndFrameObserver=this.onEndFrameObservable.add(()=>{if(!this._gpuFrameTimeToken)return;const e=this.endTimeQuery(this._gpuFrameTimeToken);e>-1&&(this._gpuFrameTimeToken=null,this._gpuFrameTime.fetchNewFrame(),this._gpuFrameTime.addCount(e,!0))})):(this.onBeginFrameObservable.remove(this._onBeginFrameObserver),this._onBeginFrameObserver=null,this.onEndFrameObservable.remove(this._onEndFrameObserver),this._onEndFrameObserver=null))};k.prototype._getGlAlgorithmType=function(a){return a===ct.OCCLUSION_ALGORITHM_TYPE_CONSERVATIVE?this._gl.ANY_SAMPLES_PASSED_CONSERVATIVE:this._gl.ANY_SAMPLES_PASSED};Object.defineProperty(ct.prototype,"isOcclusionQueryInProgress",{get:function(){return this._occlusionDataStorage.isOcclusionQueryInProgress},set:function(a){this._occlusionDataStorage.isOcclusionQueryInProgress=a},enumerable:!1,configurable:!0});Object.defineProperty(ct.prototype,"_occlusionDataStorage",{get:function(){return this.__occlusionDataStorage||(this.__occlusionDataStorage=new XS),this.__occlusionDataStorage},enumerable:!1,configurable:!0});Object.defineProperty(ct.prototype,"isOccluded",{get:function(){return this._occlusionDataStorage.isOccluded},set:function(a){this._occlusionDataStorage.isOccluded=a},enumerable:!0,configurable:!0});Object.defineProperty(ct.prototype,"occlusionQueryAlgorithmType",{get:function(){return this._occlusionDataStorage.occlusionQueryAlgorithmType},set:function(a){this._occlusionDataStorage.occlusionQueryAlgorithmType=a},enumerable:!0,configurable:!0});Object.defineProperty(ct.prototype,"occlusionType",{get:function(){return this._occlusionDataStorage.occlusionType},set:function(a){this._occlusionDataStorage.occlusionType=a},enumerable:!0,configurable:!0});Object.defineProperty(ct.prototype,"occlusionRetryCount",{get:function(){return this._occlusionDataStorage.occlusionRetryCount},set:function(a){this._occlusionDataStorage.occlusionRetryCount=a},enumerable:!0,configurable:!0});Object.defineProperty(ct.prototype,"forceRenderingWhenOccluded",{get:function(){return this._occlusionDataStorage.forceRenderingWhenOccluded},set:function(a){this._occlusionDataStorage.forceRenderingWhenOccluded=a},enumerable:!0,configurable:!0});ct.prototype._checkOcclusionQuery=function(){const a=this._occlusionDataStorage;if(a.occlusionType===ct.OCCLUSION_TYPE_NONE)return a.isOccluded=!1,!1;const e=this.getEngine();if(!e.getCaps().supportOcclusionQuery||!e.isQueryResultAvailable)return a.isOccluded=!1,!1;if(this.isOcclusionQueryInProgress&&this._occlusionQuery)if(e.isQueryResultAvailable(this._occlusionQuery)){const s=e.getQueryResult(this._occlusionQuery);a.isOcclusionQueryInProgress=!1,a.occlusionInternalRetryCounter=0,a.isOccluded=!(s>0)}else if(a.occlusionInternalRetryCounter++,a.occlusionRetryCount!==-1&&a.occlusionInternalRetryCounter>a.occlusionRetryCount)a.isOcclusionQueryInProgress=!1,a.occlusionInternalRetryCounter=0,a.isOccluded=a.occlusionType===ct.OCCLUSION_TYPE_OPTIMISTIC?!1:a.isOccluded;else return a.occlusionType===ct.OCCLUSION_TYPE_OPTIMISTIC?!1:a.isOccluded;const t=this.getScene();if(t.getBoundingBoxRenderer){const i=t.getBoundingBoxRenderer();this._occlusionQuery===null&&(this._occlusionQuery=e.createQuery()),e.beginOcclusionQuery(a.occlusionQueryAlgorithmType,this._occlusionQuery)&&(i.renderOcclusionBoundingBox(this),e.endOcclusionQuery(a.occlusionQueryAlgorithmType),this._occlusionDataStorage.isOcclusionQueryInProgress=!0)}return a.isOccluded};k.prototype.createTransformFeedback=function(){const a=this._gl.createTransformFeedback();if(!a)throw new Error("Unable to create Transform Feedback");return a};k.prototype.deleteTransformFeedback=function(a){this._gl.deleteTransformFeedback(a)};k.prototype.bindTransformFeedback=function(a){this._gl.bindTransformFeedback(this._gl.TRANSFORM_FEEDBACK,a)};k.prototype.beginTransformFeedback=function(a=!0){this._gl.beginTransformFeedback(a?this._gl.POINTS:this._gl.TRIANGLES)};k.prototype.endTransformFeedback=function(){this._gl.endTransformFeedback()};k.prototype.setTranformFeedbackVaryings=function(a,e){this._gl.transformFeedbackVaryings(a,e,this._gl.INTERLEAVED_ATTRIBS)};k.prototype.bindTransformFeedbackBuffer=function(a){this._gl.bindBufferBase(this._gl.TRANSFORM_FEEDBACK_BUFFER,0,a?a.underlyingResource:null)};Te.prototype.createExternalTexture=function(a){return null};Te.prototype.setExternalTexture=function(a,e){throw new Error("setExternalTexture: This engine does not support external textures!")};Te.prototype.updateVideoTexture=function(a,e,t){if(!a||a._isDisabled)return;const i=this._bindTextureDirectly(this._gl.TEXTURE_2D,a,!0);this._unpackFlipY(!t);try{if(this._videoTextureSupported===void 0&&(this._gl.getError(),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e),this._gl.getError()!==0?this._videoTextureSupported=!1:this._videoTextureSupported=!0),this._videoTextureSupported)this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,e);else{if(!a._workingCanvas){a._workingCanvas=this.createCanvas(a.width,a.height);const s=a._workingCanvas.getContext("2d");if(!s)throw new Error("Unable to get 2d context");a._workingContext=s,a._workingCanvas.width=a.width,a._workingCanvas.height=a.height}a._workingContext.clearRect(0,0,a.width,a.height),a._workingContext.drawImage(e,0,0,e.videoWidth,e.videoHeight,0,0,a.width,a.height),this._gl.texImage2D(this._gl.TEXTURE_2D,0,this._gl.RGBA,this._gl.RGBA,this._gl.UNSIGNED_BYTE,a._workingCanvas)}a.generateMipMaps&&this._gl.generateMipmap(this._gl.TEXTURE_2D),i||this._bindTextureDirectly(this._gl.TEXTURE_2D,null),a.isReady=!0}catch{a._isDisabled=!0}};Te.prototype.restoreSingleAttachment=function(){const a=this._gl;this.bindAttachments([a.BACK])};Te.prototype.restoreSingleAttachmentForRenderTarget=function(){const a=this._gl;this.bindAttachments([a.COLOR_ATTACHMENT0])};Te.prototype.buildTextureLayout=function(a){const e=this._gl,t=[];for(let i=0;i<a.length;i++)a[i]?t.push(e["COLOR_ATTACHMENT"+i]):t.push(e.NONE);return t};Te.prototype.bindAttachments=function(a){this._gl.drawBuffers(a)};Te.prototype.unBindMultiColorAttachmentFramebuffer=function(a,e=!1,t){this._currentRenderTarget=null;const i=this._gl,s=a._attachments,r=s.length;if(a._MSAAFramebuffer){i.bindFramebuffer(i.READ_FRAMEBUFFER,a._MSAAFramebuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,a._framebuffer);for(let n=0;n<r;n++){const o=a.textures[n];for(let l=0;l<r;l++)s[l]=i.NONE;s[n]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+n:"COLOR_ATTACHMENT"+n+"_WEBGL"],i.readBuffer(s[n]),i.drawBuffers(s),i.blitFramebuffer(0,0,o.width,o.height,0,0,o.width,o.height,i.COLOR_BUFFER_BIT,i.NEAREST)}for(let n=0;n<r;n++)s[n]=i[this.webGLVersion>1?"COLOR_ATTACHMENT"+n:"COLOR_ATTACHMENT"+n+"_WEBGL"];i.drawBuffers(s)}for(let n=0;n<r;n++){const o=a.textures[n];o.generateMipMaps&&!e&&!o.isCube&&(this._bindTextureDirectly(i.TEXTURE_2D,o,!0),i.generateMipmap(i.TEXTURE_2D),this._bindTextureDirectly(i.TEXTURE_2D,null))}t&&(a._MSAAFramebuffer&&this._bindUnboundFramebuffer(a._framebuffer),t()),this._bindUnboundFramebuffer(null)};Te.prototype.createMultipleRenderTarget=function(a,e,t=!0){let i=!1,s=!0,r=!1,n=!1,o=15,l=1;const h=0,c=3,u=!1;let d=new Array,f=new Array,p=new Array;const _=this._createHardwareRenderTargetWrapper(!0,!1,a);e!==void 0&&(i=e.generateMipMaps===void 0?!1:e.generateMipMaps,s=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,r=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,n=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,l=e.textureCount||1,e.types&&(d=e.types),e.samplingModes&&(f=e.samplingModes),e.useSRGBBuffers&&(p=e.useSRGBBuffers),this.webGLVersion>1&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===16||e.depthTextureFormat===14||e.depthTextureFormat===18)&&(o=e.depthTextureFormat));const m=this._gl,v=m.createFramebuffer();this._bindUnboundFramebuffer(v);const x=a.width||a,b=a.height||a,S=[],C=[],E=this.webGLVersion>1&&n&&(e.depthTextureFormat===13||e.depthTextureFormat===17||e.depthTextureFormat===18),A=this._setupFramebufferDepthAttachments(!E&&r,!n&&s,x,b);_._framebuffer=v,_._depthStencilBuffer=A,_._generateDepthBuffer=!n&&s,_._generateStencilBuffer=!E&&r,_._attachments=C;for(let M=0;M<l;M++){let D=f[M]||c,P=d[M]||h,O=p[M]||u;(P===1&&!this._caps.textureFloatLinearFiltering||P===2&&!this._caps.textureHalfFloatLinearFiltering)&&(D=1);const N=this._getSamplingParameters(D,i);P===1&&!this._caps.textureFloat&&(P=0,B.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type")),O=O&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU);const $=new gt(this,We.MultiRenderTarget),W=m[this.webGLVersion>1?"COLOR_ATTACHMENT"+M:"COLOR_ATTACHMENT"+M+"_WEBGL"];S.push($),C.push(W),m.activeTexture(m["TEXTURE"+M]),m.bindTexture(m.TEXTURE_2D,$._hardwareTexture.underlyingResource),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,N.mag),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,N.min),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE);const K=this._getRGBABufferInternalSizedFormat(P,5,O);m.texImage2D(m.TEXTURE_2D,0,K,x,b,0,m.RGBA,this._getWebGLTextureType(P),null),m.framebufferTexture2D(m.DRAW_FRAMEBUFFER,W,m.TEXTURE_2D,$._hardwareTexture.underlyingResource,0),i&&this._gl.generateMipmap(this._gl.TEXTURE_2D),this._bindTextureDirectly(m.TEXTURE_2D,null),$.baseWidth=x,$.baseHeight=b,$.width=x,$.height=b,$.isReady=!0,$.samples=1,$.generateMipMaps=i,$.samplingMode=D,$.type=P,$._useSRGBBuffer=O,this._internalTexturesCache.push($)}if(n&&this._caps.depthTextureExtension){const M=new gt(this,We.Depth);let D=5,P=m.DEPTH_COMPONENT16,O=m.DEPTH_COMPONENT,N=m.UNSIGNED_SHORT,$=m.DEPTH_ATTACHMENT;this.webGLVersion<2?P=m.DEPTH_COMPONENT:o===14?(D=1,N=m.FLOAT,P=m.DEPTH_COMPONENT32F):o===18?(D=0,N=m.FLOAT_32_UNSIGNED_INT_24_8_REV,P=m.DEPTH32F_STENCIL8,O=m.DEPTH_STENCIL,$=m.DEPTH_STENCIL_ATTACHMENT):o===16?(D=0,N=m.UNSIGNED_INT,P=m.DEPTH_COMPONENT24,$=m.DEPTH_ATTACHMENT):(o===13||o===17)&&(D=12,N=m.UNSIGNED_INT_24_8,P=m.DEPTH24_STENCIL8,O=m.DEPTH_STENCIL,$=m.DEPTH_STENCIL_ATTACHMENT),m.activeTexture(m.TEXTURE0),m.bindTexture(m.TEXTURE_2D,M._hardwareTexture.underlyingResource),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MAG_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_MIN_FILTER,m.NEAREST),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_S,m.CLAMP_TO_EDGE),m.texParameteri(m.TEXTURE_2D,m.TEXTURE_WRAP_T,m.CLAMP_TO_EDGE),m.texImage2D(m.TEXTURE_2D,0,P,x,b,0,O,N,null),m.framebufferTexture2D(m.FRAMEBUFFER,$,m.TEXTURE_2D,M._hardwareTexture.underlyingResource,0),M.baseWidth=x,M.baseHeight=b,M.width=x,M.height=b,M.isReady=!0,M.samples=1,M.generateMipMaps=i,M.samplingMode=1,M.format=o,M.type=D,S.push(M),this._internalTexturesCache.push(M)}return _.setTextures(S),t&&m.drawBuffers(C),this._bindUnboundFramebuffer(null),this.resetTextureCache(),_};Te.prototype.updateMultipleRenderTargetTextureSampleCount=function(a,e,t=!0){if(this.webGLVersion<2||!a||!a.texture)return 1;if(a.samples===e)return e;const i=a._attachments.length;if(i===0)return 1;const s=this._gl;e=Math.min(e,this.getCaps().maxMSAASamples);const r=!!a._depthStencilBuffer;if(r&&(s.deleteRenderbuffer(a._depthStencilBuffer),a._depthStencilBuffer=null),a._MSAAFramebuffer&&(s.deleteFramebuffer(a._MSAAFramebuffer),a._MSAAFramebuffer=null),e>1&&s.renderbufferStorageMultisample){const n=s.createFramebuffer();if(!n)throw new Error("Unable to create multi sampled framebuffer");a._MSAAFramebuffer=n,this._bindUnboundFramebuffer(n);const o=[];for(let l=0;l<i;l++){const h=a.textures[l],c=h._hardwareTexture,u=s[this.webGLVersion>1?"COLOR_ATTACHMENT"+l:"COLOR_ATTACHMENT"+l+"_WEBGL"],d=c._MSAARenderBuffer?this._updateRenderBuffer(c._MSAARenderBuffer,h.width,h.height,e,-1,this._getRGBAMultiSampleBufferFormat(h.type),u):this._createRenderBuffer(h.width,h.height,e,-1,this._getRGBAMultiSampleBufferFormat(h.type),u);if(!d)throw new Error("Unable to create multi sampled framebuffer");c._MSAARenderBuffer=d,h.samples=e,o.push(u)}t&&s.drawBuffers(o)}else this._bindUnboundFramebuffer(a._framebuffer);return r&&(a._depthStencilBuffer=this._setupFramebufferDepthAttachments(a._generateStencilBuffer,a._generateDepthBuffer,a.texture.width,a.texture.height,e)),this._bindUnboundFramebuffer(null),e};Te.prototype._createDepthStencilCubeTexture=function(a,e,t){const i=new gt(this,We.DepthStencil);if(i.isCube=!0,this.webGLVersion===1)return B.Error("Depth cube texture is not supported by WebGL 1."),i;const s={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,...e},r=this._gl;this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,i,!0),this._setupDepthStencilTexture(i,a,s.generateStencil,s.bilinearFiltering,s.comparisonFunction),t._depthStencilTexture=i,t._depthStencilTextureWithStencil=s.generateStencil;for(let n=0;n<6;n++)s.generateStencil?r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH24_STENCIL8,a,a,0,r.DEPTH_STENCIL,r.UNSIGNED_INT_24_8,null):r.texImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+n,0,r.DEPTH_COMPONENT24,a,a,0,r.DEPTH_COMPONENT,r.UNSIGNED_INT,null);return this._bindTextureDirectly(r.TEXTURE_CUBE_MAP,null),this._internalTexturesCache.push(i),i};Te.prototype._partialLoadFile=function(a,e,t,i,s=null){const r=o=>{t[e]=o,t._internalCount++,t._internalCount===6&&i(t)},n=(o,l)=>{s&&o&&s(o.status+" "+o.statusText,l)};this._loadFile(a,r,void 0,void 0,!0,n)};Te.prototype._cascadeLoadFiles=function(a,e,t,i=null){const s=[];s._internalCount=0;for(let r=0;r<6;r++)this._partialLoadFile(t[r],r,s,e,i)};Te.prototype._cascadeLoadImgs=function(a,e,t,i,s=null,r){const n=[];n._internalCount=0;for(let o=0;o<6;o++)this._partialLoadImg(i[o],o,n,a,e,t,s,r)};Te.prototype._partialLoadImg=function(a,e,t,i,s,r,n=null,o){const l=Md();Wl(a,u=>{t[e]=u,t._internalCount++,i&&i.removePendingData(l),t._internalCount===6&&r&&r(s,t)},(u,d)=>{i&&i.removePendingData(l),n&&n(u,d)},i?i.offlineProvider:null,o),i&&i.addPendingData(l)};Te.prototype._setCubeMapTextureParams=function(a,e,t){const i=this._gl;i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MIN_FILTER,e?i.LINEAR_MIPMAP_LINEAR:i.LINEAR),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),a.samplingMode=e?3:2,e&&this.getCaps().textureMaxLevel&&t!==void 0&&t>0&&(i.texParameteri(i.TEXTURE_CUBE_MAP,i.TEXTURE_MAX_LEVEL,t),a._maxLodLevel=t),this._bindTextureDirectly(i.TEXTURE_CUBE_MAP,null)};Te.prototype.createCubeTextureBase=function(a,e,t,i,s=null,r=null,n,o=null,l=!1,h=0,c=0,u=null,d=null,f=null,p=!1){const _=u||new gt(this,We.Cube);_.isCube=!0,_.url=a,_.generateMipMaps=!i,_._lodGenerationScale=h,_._lodGenerationOffset=c,_._useSRGBBuffer=!!p&&this._caps.supportSRGBBuffers&&(this.webGLVersion>1||this.isWebGPU||!!i),this._doNotHandleContextLost||(_._extension=o,_._files=t);const m=a;this._transformTextureUrl&&!u&&(a=this._transformTextureUrl(a));const v=a.split("?")[0],x=v.lastIndexOf("."),b=o||(x>-1?v.substring(x).toLowerCase():"");let S=null;for(const E of Te._TextureLoaders)if(E.canLoad(b)){S=E;break}const C=(E,A)=>{a===m?r&&E&&r(E.status+" "+E.statusText,A):(B.Warn(`Failed to load ${a}, falling back to the ${m}`),this.createCubeTextureBase(m,e,t,!!i,s,r,n,o,l,h,c,_,d,f,p))};if(S){const E=A=>{d&&d(_,A),S.loadCubeData(A,_,l,s,r)};t&&t.length===6?S.supportCascades?this._cascadeLoadFiles(e,A=>E(A.map(M=>new Uint8Array(M))),t,r):r?r("Textures type does not support cascades."):B.Warn("Texture loader does not support cascades."):this._loadFile(a,A=>E(new Uint8Array(A)),void 0,void 0,!0,C)}else{if(!t)throw new Error("Cannot load cubemap because files were not defined");this._cascadeLoadImgs(e,_,(E,A)=>{f&&f(E,A)},t,r)}return this._internalTexturesCache.push(_),_};Te.prototype.createCubeTexture=function(a,e,t,i,s=null,r=null,n,o=null,l=!1,h=0,c=0,u=null,d,f=!1){const p=this._gl;return this.createCubeTextureBase(a,e,t,!!i,s,r,n,o,l,h,c,u,_=>this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),(_,m)=>{const v=this.needPOTTextures?Te.GetExponentOfTwo(m[0].width,this._caps.maxCubemapTextureSize):m[0].width,x=v,b=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];this._bindTextureDirectly(p.TEXTURE_CUBE_MAP,_,!0),this._unpackFlipY(!1);const S=n?this._getInternalFormat(n,_._useSRGBBuffer):_._useSRGBBuffer?p.SRGB8_ALPHA8:p.RGBA;let C=n?this._getInternalFormat(n):p.RGBA;_._useSRGBBuffer&&this.webGLVersion===1&&(C=S);for(let E=0;E<b.length;E++)if(m[E].width!==v||m[E].height!==x){if(this._prepareWorkingCanvas(),!this._workingCanvas||!this._workingContext){B.Warn("Cannot create canvas to resize texture.");return}this._workingCanvas.width=v,this._workingCanvas.height=x,this._workingContext.drawImage(m[E],0,0,m[E].width,m[E].height,0,0,v,x),p.texImage2D(b[E],0,S,C,p.UNSIGNED_BYTE,this._workingCanvas)}else p.texImage2D(b[E],0,S,C,p.UNSIGNED_BYTE,m[E]);i||p.generateMipmap(p.TEXTURE_CUBE_MAP),this._setCubeMapTextureParams(_,!i),_.width=v,_.height=x,_.isReady=!0,n&&(_.format=n),_.onLoadedObservable.notifyObservers(_),_.onLoadedObservable.clear(),s&&s()},!!f)};Te.prototype.setTextureSampler=function(a,e){throw new Error("setTextureSampler: This engine does not support separate texture sampler objects!")};const fm=new X,pm=new X;Object.defineProperty(k.prototype,"onBeforeViewRenderObservable",{get:function(){return fm}});Object.defineProperty(k.prototype,"onAfterViewRenderObservable",{get:function(){return pm}});Object.defineProperty(k.prototype,"inputElement",{get:function(){return this._inputElement},set:function(a){var e;this._inputElement!==a&&(this._inputElement=a,(e=this._onEngineViewChanged)===null||e===void 0||e.call(this))}});k.prototype.getInputElement=function(){return this.inputElement||this.getRenderingCanvas()};k.prototype.registerView=function(a,e,t){this.views||(this.views=[]);for(const r of this.views)if(r.target===a)return r;const i=this.getRenderingCanvas();i&&(a.width=i.width,a.height=i.height);const s={target:a,camera:e,clearBeforeCopy:t,enabled:!0,id:(Math.random()*1e5).toFixed()};return this.views.push(s),e&&e.onDisposeObservable.add(()=>{this.unRegisterView(a)}),s};k.prototype.unRegisterView=function(a){if(!this.views)return this;for(const e of this.views)if(e.target===a){const t=this.views.indexOf(e);t!==-1&&this.views.splice(t,1);break}return this};k.prototype._renderViews=function(){if(!this.views)return!1;const a=this.getRenderingCanvas();if(!a)return!1;for(const e of this.views){if(!e.enabled)continue;const t=e.target,i=t.getContext("2d");if(!i)continue;fm.notifyObservers(e);const s=e.camera;let r=null,n=null;if(s){if(n=s.getScene(),n.activeCameras&&n.activeCameras.length)continue;this.activeView=e,r=n.activeCamera,n.activeCamera=s}if(e.customResize)e.customResize(t);else{const o=Math.floor(t.clientWidth/this._hardwareScalingLevel),l=Math.floor(t.clientHeight/this._hardwareScalingLevel),h=o!==t.width||a.width!==t.width||l!==t.height||a.height!==t.height;t.clientWidth&&t.clientHeight&&h&&(t.width=o,t.height=l,this.setSize(o,l))}if(!a.width||!a.height)return!1;this._renderFrame(),this.flushFramebuffer(),e.clearBeforeCopy&&i.clearRect(0,0,a.width,a.height),i.drawImage(a,0,0),r&&n&&(n.activeCamera=r),pm.notifyObservers(e)}return this.activeView=null,!0};Te.prototype.createStorageBuffer=function(a,e){throw new Error("createStorageBuffer: Unsupported method in this engine!")};Te.prototype.updateStorageBuffer=function(a,e,t,i){};Te.prototype.readFromStorageBuffer=function(a,e,t,i){throw new Error("readFromStorageBuffer: Unsupported method in this engine!")};Te.prototype.setStorageBuffer=function(a,e){throw new Error("setStorageBuffer: Unsupported method in this engine!")};function YS(a){const e=r=>{const n="\\b"+r+"\\b";return a&&(a===r||a.match(new RegExp(n,"g")))};if(this._excludedCompressedTextures&&this._excludedCompressedTextures.some(e))return a;const t=a.lastIndexOf("."),i=a.lastIndexOf("?"),s=i>-1?a.substring(i,a.length):"";return(t>-1?a.substring(0,t):a)+this._textureFormatInUse+s}Object.defineProperty(k.prototype,"texturesSupported",{get:function(){const a=new Array;return this._caps.astc&&a.push("-astc.ktx"),this._caps.s3tc&&a.push("-dxt.ktx"),this._caps.pvrtc&&a.push("-pvrtc.ktx"),this._caps.etc2&&a.push("-etc2.ktx"),this._caps.etc1&&a.push("-etc1.ktx"),a},enumerable:!0,configurable:!0});Object.defineProperty(k.prototype,"textureFormatInUse",{get:function(){return this._textureFormatInUse||null},enumerable:!0,configurable:!0});k.prototype.setCompressedTextureExclusions=function(a){this._excludedCompressedTextures=a};k.prototype.setTextureFormatToUse=function(a){const e=this.texturesSupported;for(let t=0,i=e.length;t<i;t++)for(let s=0,r=a.length;s<r;s++)if(e[t]===a[s].toLowerCase())return this._transformTextureUrl=YS.bind(this),this._textureFormatInUse=e[t];return this._textureFormatInUse="",this._transformTextureUrl=null,null};class Ua{constructor(){const e=new ArrayBuffer(Ua.DEFAULT_BUFFER_SIZE);this._uint32s=new Uint32Array(e),this._int32s=new Int32Array(e),this._float32s=new Float32Array(e),this._length=Ua.DEFAULT_BUFFER_SIZE/4,this._position=0,this._nativeDataStream=new _native.NativeDataStream(()=>{this._flush()})}writeUint32(e){this._flushIfNecessary(1),this._uint32s[this._position++]=e}writeInt32(e){this._flushIfNecessary(1),this._int32s[this._position++]=e}writeFloat32(e){this._flushIfNecessary(1),this._float32s[this._position++]=e}writeUint32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._uint32s.set(e,this._position),this._position+=e.length}writeInt32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._int32s.set(e,this._position),this._position+=e.length}writeFloat32Array(e){this._flushIfNecessary(1+e.length),this._uint32s[this._position++]=e.length,this._float32s.set(e,this._position),this._position+=e.length}writeNativeData(e){this._flushIfNecessary(e.length),this._uint32s.set(e,this._position),this._position+=e.length}writeBoolean(e){this.writeUint32(e?1:0)}_flushIfNecessary(e){this._position+e>this._length&&this._flush()}_flush(){this._nativeDataStream.writeBuffer(this._uint32s.buffer,this._position),this._position=0}}Ua.DEFAULT_BUFFER_SIZE=65536;const Br=[Math.sqrt(1/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(3/(4*Math.PI)),-Math.sqrt(3/(4*Math.PI)),Math.sqrt(15/(4*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(5/(16*Math.PI)),-Math.sqrt(15/(4*Math.PI)),Math.sqrt(15/(16*Math.PI))],KS=[()=>1,a=>a.y,a=>a.z,a=>a.x,a=>a.x*a.y,a=>a.y*a.z,a=>3*a.z*a.z-1,a=>a.x*a.z,a=>a.x*a.x-a.y*a.y],nn=(a,e)=>Br[a]*KS[a](e),an=[Math.PI,2*Math.PI/3,2*Math.PI/3,2*Math.PI/3,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4,Math.PI/4];class Do{constructor(){this.preScaled=!1,this.l00=g.Zero(),this.l1_1=g.Zero(),this.l10=g.Zero(),this.l11=g.Zero(),this.l2_2=g.Zero(),this.l2_1=g.Zero(),this.l20=g.Zero(),this.l21=g.Zero(),this.l22=g.Zero()}addLight(e,t,i){G.Vector3[0].set(t.r,t.g,t.b);const s=G.Vector3[0],r=G.Vector3[1];s.scaleToRef(i,r),r.scaleToRef(nn(0,e),G.Vector3[2]),this.l00.addInPlace(G.Vector3[2]),r.scaleToRef(nn(1,e),G.Vector3[2]),this.l1_1.addInPlace(G.Vector3[2]),r.scaleToRef(nn(2,e),G.Vector3[2]),this.l10.addInPlace(G.Vector3[2]),r.scaleToRef(nn(3,e),G.Vector3[2]),this.l11.addInPlace(G.Vector3[2]),r.scaleToRef(nn(4,e),G.Vector3[2]),this.l2_2.addInPlace(G.Vector3[2]),r.scaleToRef(nn(5,e),G.Vector3[2]),this.l2_1.addInPlace(G.Vector3[2]),r.scaleToRef(nn(6,e),G.Vector3[2]),this.l20.addInPlace(G.Vector3[2]),r.scaleToRef(nn(7,e),G.Vector3[2]),this.l21.addInPlace(G.Vector3[2]),r.scaleToRef(nn(8,e),G.Vector3[2]),this.l22.addInPlace(G.Vector3[2])}scaleInPlace(e){this.l00.scaleInPlace(e),this.l1_1.scaleInPlace(e),this.l10.scaleInPlace(e),this.l11.scaleInPlace(e),this.l2_2.scaleInPlace(e),this.l2_1.scaleInPlace(e),this.l20.scaleInPlace(e),this.l21.scaleInPlace(e),this.l22.scaleInPlace(e)}convertIncidentRadianceToIrradiance(){this.l00.scaleInPlace(an[0]),this.l1_1.scaleInPlace(an[1]),this.l10.scaleInPlace(an[2]),this.l11.scaleInPlace(an[3]),this.l2_2.scaleInPlace(an[4]),this.l2_1.scaleInPlace(an[5]),this.l20.scaleInPlace(an[6]),this.l21.scaleInPlace(an[7]),this.l22.scaleInPlace(an[8])}convertIrradianceToLambertianRadiance(){this.scaleInPlace(1/Math.PI)}preScaleForRendering(){this.preScaled=!0,this.l00.scaleInPlace(Br[0]),this.l1_1.scaleInPlace(Br[1]),this.l10.scaleInPlace(Br[2]),this.l11.scaleInPlace(Br[3]),this.l2_2.scaleInPlace(Br[4]),this.l2_1.scaleInPlace(Br[5]),this.l20.scaleInPlace(Br[6]),this.l21.scaleInPlace(Br[7]),this.l22.scaleInPlace(Br[8])}updateFromArray(e){return g.FromArrayToRef(e[0],0,this.l00),g.FromArrayToRef(e[1],0,this.l1_1),g.FromArrayToRef(e[2],0,this.l10),g.FromArrayToRef(e[3],0,this.l11),g.FromArrayToRef(e[4],0,this.l2_2),g.FromArrayToRef(e[5],0,this.l2_1),g.FromArrayToRef(e[6],0,this.l20),g.FromArrayToRef(e[7],0,this.l21),g.FromArrayToRef(e[8],0,this.l22),this}updateFromFloatsArray(e){return g.FromFloatsToRef(e[0],e[1],e[2],this.l00),g.FromFloatsToRef(e[3],e[4],e[5],this.l1_1),g.FromFloatsToRef(e[6],e[7],e[8],this.l10),g.FromFloatsToRef(e[9],e[10],e[11],this.l11),g.FromFloatsToRef(e[12],e[13],e[14],this.l2_2),g.FromFloatsToRef(e[15],e[16],e[17],this.l2_1),g.FromFloatsToRef(e[18],e[19],e[20],this.l20),g.FromFloatsToRef(e[21],e[22],e[23],this.l21),g.FromFloatsToRef(e[24],e[25],e[26],this.l22),this}static FromArray(e){return new Do().updateFromArray(e)}static FromPolynomial(e){const t=new Do;return t.l00=e.xx.scale(.376127).add(e.yy.scale(.376127)).add(e.zz.scale(.376126)),t.l1_1=e.y.scale(.977204),t.l10=e.z.scale(.977204),t.l11=e.x.scale(.977204),t.l2_2=e.xy.scale(1.16538),t.l2_1=e.yz.scale(1.16538),t.l20=e.zz.scale(1.34567).subtract(e.xx.scale(.672834)).subtract(e.yy.scale(.672834)),t.l21=e.zx.scale(1.16538),t.l22=e.xx.scale(1.16538).subtract(e.yy.scale(1.16538)),t.l1_1.scaleInPlace(-1),t.l11.scaleInPlace(-1),t.l2_1.scaleInPlace(-1),t.l21.scaleInPlace(-1),t.scaleInPlace(Math.PI),t}}class sa{constructor(){this.x=g.Zero(),this.y=g.Zero(),this.z=g.Zero(),this.xx=g.Zero(),this.yy=g.Zero(),this.zz=g.Zero(),this.xy=g.Zero(),this.yz=g.Zero(),this.zx=g.Zero()}get preScaledHarmonics(){return this._harmonics||(this._harmonics=Do.FromPolynomial(this)),this._harmonics.preScaled||this._harmonics.preScaleForRendering(),this._harmonics}addAmbient(e){G.Vector3[0].copyFromFloats(e.r,e.g,e.b);const t=G.Vector3[0];this.xx.addInPlace(t),this.yy.addInPlace(t),this.zz.addInPlace(t)}scaleInPlace(e){this.x.scaleInPlace(e),this.y.scaleInPlace(e),this.z.scaleInPlace(e),this.xx.scaleInPlace(e),this.yy.scaleInPlace(e),this.zz.scaleInPlace(e),this.yz.scaleInPlace(e),this.zx.scaleInPlace(e),this.xy.scaleInPlace(e)}updateFromHarmonics(e){return this._harmonics=e,this.x.copyFrom(e.l11),this.x.scaleInPlace(1.02333).scaleInPlace(-1),this.y.copyFrom(e.l1_1),this.y.scaleInPlace(1.02333).scaleInPlace(-1),this.z.copyFrom(e.l10),this.z.scaleInPlace(1.02333),this.xx.copyFrom(e.l00),G.Vector3[0].copyFrom(e.l20).scaleInPlace(.247708),G.Vector3[1].copyFrom(e.l22).scaleInPlace(.429043),this.xx.scaleInPlace(.886277).subtractInPlace(G.Vector3[0]).addInPlace(G.Vector3[1]),this.yy.copyFrom(e.l00),this.yy.scaleInPlace(.886277).subtractInPlace(G.Vector3[0]).subtractInPlace(G.Vector3[1]),this.zz.copyFrom(e.l00),G.Vector3[0].copyFrom(e.l20).scaleInPlace(.495417),this.zz.scaleInPlace(.886277).addInPlace(G.Vector3[0]),this.yz.copyFrom(e.l2_1),this.yz.scaleInPlace(.858086).scaleInPlace(-1),this.zx.copyFrom(e.l21),this.zx.scaleInPlace(.858086).scaleInPlace(-1),this.xy.copyFrom(e.l2_2),this.xy.scaleInPlace(.858086),this.scaleInPlace(1/Math.PI),this}static FromHarmonics(e){return new sa().updateFromHarmonics(e)}static FromArray(e){const t=new sa;return g.FromArrayToRef(e[0],0,t.x),g.FromArrayToRef(e[1],0,t.y),g.FromArrayToRef(e[2],0,t.z),g.FromArrayToRef(e[3],0,t.xx),g.FromArrayToRef(e[4],0,t.yy),g.FromArrayToRef(e[5],0,t.zz),g.FromArrayToRef(e[6],0,t.yz),g.FromArrayToRef(e[7],0,t.zx),g.FromArrayToRef(e[8],0,t.xy),t}}const $S="rgbdDecodePixelShader",jS=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=vec4(fromRGBD(texture2D(textureSampler,vUV)),1.0);
}`;Y.ShadersStore[$S]=jS;class Of{static ExpandRGBDTexture(e){const t=e._texture;if(!t||!e.isRGBD)return;const i=t.getEngine(),s=i.getCaps(),r=t.isReady;let n=!1;s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?(n=!0,t.type=2):s.textureFloatRender&&s.textureFloatLinearFiltering&&(n=!0,t.type=1),n&&(t.isReady=!1,t._isRGBD=!1,t.invertY=!1);const o=()=>{if(n){const l=new Fe("rgbdDecode","rgbdDecode",null,null,1,null,3,i,!1,void 0,t.type,void 0,null,!1);l.externalTextureSamplerBinding=!0;const h=i.createRenderTargetTexture(t.width,{generateDepthBuffer:!1,generateMipMaps:!1,generateStencilBuffer:!1,samplingMode:t.samplingMode,type:t.type,format:5});l.getEffect().executeWhenCompiled(()=>{l.onApply=c=>{c._bindTexture("textureSampler",t),c.setFloat2("scale",1,1)},e.getScene().postProcessManager.directRender([l],h,!0),i.restoreDefaultFramebuffer(),i._releaseTexture(t),l&&l.dispose(),h._swapAndDie(t),t.isReady=!0})}};r?o():e.onLoadObservable.addOnce(o)}static EncodeTextureToRGBD(e,t,i=0){return Ax("rgbdEncode",e,t,i,1,5)}}class io{constructor(e,t,i,s){this.name=e,this.worldAxisForNormal=t,this.worldAxisForFileX=i,this.worldAxisForFileY=s}}class $c{static ConvertCubeMapTextureToSphericalPolynomial(e){var t;if(!e.isCube)return null;(t=e.getScene())===null||t===void 0||t.getEngine().flushFramebuffer();const i=e.getSize().width,s=e.readPixels(0,void 0,void 0,!1),r=e.readPixels(1,void 0,void 0,!1);let n,o;e.isRenderTarget?(n=e.readPixels(3,void 0,void 0,!1),o=e.readPixels(2,void 0,void 0,!1)):(n=e.readPixels(2,void 0,void 0,!1),o=e.readPixels(3,void 0,void 0,!1));const l=e.readPixels(4,void 0,void 0,!1),h=e.readPixels(5,void 0,void 0,!1),c=e.gammaSpace,u=5;let d=0;return(e.textureType==1||e.textureType==2)&&(d=1),new Promise(f=>{Promise.all([r,s,n,o,l,h]).then(([p,_,m,v,x,b])=>{const S={size:i,right:_,left:p,up:m,down:v,front:x,back:b,format:u,type:d,gammaSpace:c};f(this.ConvertCubeMapToSphericalPolynomial(S))})})}static _AreaElement(e,t){return Math.atan2(e*t,Math.sqrt(e*e+t*t+1))}static ConvertCubeMapToSphericalPolynomial(e){const t=new Do;let i=0;const s=2/e.size,r=s,n=.5*s,o=n-1;for(let d=0;d<6;d++){const f=this._FileFaces[d],p=e[f.name];let _=o;const m=e.format===5?4:3;for(let v=0;v<e.size;v++){let x=o;for(let b=0;b<e.size;b++){const S=f.worldAxisForFileX.scale(x).add(f.worldAxisForFileY.scale(_)).add(f.worldAxisForNormal);S.normalize();const C=this._AreaElement(x-n,_-n)-this._AreaElement(x-n,_+n)-this._AreaElement(x+n,_-n)+this._AreaElement(x+n,_+n);let E=p[v*e.size*m+b*m+0],A=p[v*e.size*m+b*m+1],M=p[v*e.size*m+b*m+2];isNaN(E)&&(E=0),isNaN(A)&&(A=0),isNaN(M)&&(M=0),e.type===0&&(E/=255,A/=255,M/=255),e.gammaSpace&&(E=Math.pow(oe.Clamp(E),gn),A=Math.pow(oe.Clamp(A),gn),M=Math.pow(oe.Clamp(M),gn));const D=4096;E=oe.Clamp(E,0,D),A=oe.Clamp(A,0,D),M=oe.Clamp(M,0,D);const P=new re(E,A,M);t.addLight(S,P,C),i+=C,x+=s}_+=r}}const u=4*Math.PI*6/6/i;return t.scaleInPlace(u),t.convertIncidentRadianceToIrradiance(),t.convertIrradianceToLambertianRadiance(),sa.FromHarmonics(t)}}$c._FileFaces=[new io("right",new g(1,0,0),new g(0,0,-1),new g(0,-1,0)),new io("left",new g(-1,0,0),new g(0,0,1),new g(0,-1,0)),new io("up",new g(0,1,0),new g(1,0,0),new g(0,0,1)),new io("down",new g(0,-1,0),new g(1,0,0),new g(0,0,-1)),new io("front",new g(0,0,1),new g(1,0,0),new g(0,-1,0)),new io("back",new g(0,0,-1),new g(-1,0,0),new g(0,-1,0))];dt.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(dt.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=$c.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(a=>{this._texture._sphericalPolynomial=a,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(a){this._texture&&(this._texture._sphericalPolynomial=a)},enumerable:!0,configurable:!0});const qS="rgbdEncodePixelShader",QS=`varying vec2 vUV;
uniform sampler2D textureSampler;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=toRGBD(texture2D(textureSampler,vUV).rgb);
}`;Y.ShadersStore[qS]=QS;const _m="image/png",wf=2,Nf=[134,22,135,150,246,214,150,54];function mm(a){const e=new DataView(a.buffer,a.byteOffset,a.byteLength);let t=0;for(let n=0;n<Nf.length;n++)if(e.getUint8(t++)!==Nf[n])return B.Error("Not a babylon environment map"),null;let i="",s=0;for(;s=e.getUint8(t++);)i+=String.fromCharCode(s);let r=JSON.parse(i);return r=jc(r),r.specular&&(r.specular.specularDataPosition=t,r.specular.lodGenerationScale=r.specular.lodGenerationScale||.8),r}function jc(a){if(a.version>wf)throw new Error(`Unsupported babylon environment map version "${a.version}". Latest supported version is "${wf}".`);return a.version===2||(a={...a,version:2,imageType:_m}),a}function gm(a,e){e=jc(e);const t=e.specular;let i=oe.Log2(e.width);if(i=Math.round(i)+1,t.mipmaps.length!==6*i)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const s=new Array(i);for(let r=0;r<i;r++){s[r]=new Array(6);for(let n=0;n<6;n++){const o=t.mipmaps[r*6+n];s[r][n]=new Uint8Array(a.buffer,a.byteOffset+t.specularDataPosition+o.position,o.length)}}return s}function ZS(a,e,t){t=jc(t);const i=t.specular;if(!i)return Promise.resolve();a._lodGenerationScale=i.lodGenerationScale;const s=gm(e,t);return JS(a,s,t.imageType)}function Ff(a,e,t,i,s,r,n,o,l,h,c){return new Promise((u,d)=>{if(t){const f=e.createTexture(null,!0,!0,null,1,null,p=>{d(p)},a);i.getEffect().executeWhenCompiled(()=>{i.externalTextureSamplerBinding=!0,i.onApply=p=>{p._bindTexture("textureSampler",f),p.setFloat2("scale",1,e._features.needsInvertingBitmap&&a instanceof ImageBitmap?-1:1)},e.scenes.length&&(e.scenes[0].postProcessManager.directRender([i],h,!0,r,n),e.restoreDefaultFramebuffer(),f.dispose(),URL.revokeObjectURL(s),u())})}else{if(e._uploadImageToTexture(c,a,r,n),o){const f=l[n];f&&e._uploadImageToTexture(f._texture,a,r,0)}u()}})}function JS(a,e,t=_m){if(!q.IsExponentOfTwo(a.width))throw new Error("Texture size must be a power of two");const i=oe.ILog2(a.width)+1,s=a.getEngine();let r=!1,n=!1,o=null,l=null,h=null;const c=s.getCaps();if(a.format=5,a.type=0,a.generateMipMaps=!0,a._cachedAnisotropicFilteringLevel=null,s.updateTextureSamplingMode(3,a),c.textureLOD?s._features.supportRenderAndCopyToLodForFloatTextures?c.textureHalfFloatRender&&c.textureHalfFloatLinearFiltering?(r=!0,a.type=2):c.textureFloatRender&&c.textureFloatLinearFiltering&&(r=!0,a.type=1):r=!1:(r=!1,n=!0,h={}),r)o=new Fe("rgbdDecode","rgbdDecode",null,null,1,null,3,s,!1,void 0,a.type,void 0,null,!1),a._isRGBD=!1,a.invertY=!1,l=s.createRenderTargetCubeTexture(a.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:a.type,format:5});else if(a._isRGBD=!0,a.invertY=!0,n){const f=a._lodGenerationScale,p=a._lodGenerationOffset;for(let _=0;_<3;_++){const m=_/2,v=1-m,x=p,b=(i-1)*f+p,S=x+(b-x)*v,C=Math.round(Math.min(Math.max(S,0),b)),E=new gt(s,We.Temp);E.isCube=!0,E.invertY=!0,E.generateMipMaps=!1,s.updateTextureSamplingMode(2,E);const A=new dt(null);switch(A._isCube=!0,A._texture=E,h[C]=A,_){case 0:a._lodTextureLow=A;break;case 1:a._lodTextureMid=A;break;case 2:a._lodTextureHigh=A;break}}}const u=[];for(let d=0;d<e.length;d++)for(let f=0;f<6;f++){const p=e[d][f],_=new Blob([p],{type:t}),m=URL.createObjectURL(_);let v;if(typeof Image>"u"||s._features.forceBitmapOverHTMLImageElement)v=s.createImageBitmap(_,{premultiplyAlpha:"none"}).then(x=>Ff(x,s,r,o,m,f,d,n,h,l,a));else{const x=new Image;x.src=m,v=new Promise((b,S)=>{x.onload=()=>{Ff(x,s,r,o,m,f,d,n,h,l,a).then(()=>b()).catch(C=>{S(C)})},x.onerror=C=>{S(C)}})}u.push(v)}if(e.length<i){let d;const f=Math.pow(2,i-1-e.length),p=f*f*4;switch(a.type){case 0:{d=new Uint8Array(p);break}case 2:{d=new Uint16Array(p);break}case 1:{d=new Float32Array(p);break}}for(let _=e.length;_<i;_++)for(let m=0;m<6;m++)s._uploadArrayBufferViewToTexture(a,d,m,_)}return Promise.all(u).then(()=>{l&&(s._releaseTexture(a),l._swapAndDie(a)),o&&o.dispose(),n&&(a._lodTextureHigh&&a._lodTextureHigh._texture&&(a._lodTextureHigh._texture.isReady=!0),a._lodTextureMid&&a._lodTextureMid._texture&&(a._lodTextureMid._texture.isReady=!0),a._lodTextureLow&&a._lodTextureLow._texture&&(a._lodTextureLow._texture.isReady=!0))})}function vm(a,e){e=jc(e);const t=e.irradiance;if(!t)return;const i=new sa;g.FromArrayToRef(t.x,0,i.x),g.FromArrayToRef(t.y,0,i.y),g.FromArrayToRef(t.z,0,i.z),g.FromArrayToRef(t.xx,0,i.xx),g.FromArrayToRef(t.yy,0,i.yy),g.FromArrayToRef(t.zz,0,i.zz),g.FromArrayToRef(t.yz,0,i.yz),g.FromArrayToRef(t.zx,0,i.zx),g.FromArrayToRef(t.xy,0,i.xy),a._sphericalPolynomial=i}const xm=new X;if(typeof self<"u"&&!Object.prototype.hasOwnProperty.call(self,"_native")){let a;Object.defineProperty(self,"_native",{get:()=>a,set:e=>{a=e,a&&xm.notifyObservers(a)}})}function eE(){return new Promise(a=>{typeof _native>"u"?xm.addOnce(e=>a(e)):a(_native)})}async function tE(a,e){(await eE())[a]=e}class iE{constructor(e){this.isAsync=!1,this.isReady=!1,this._valueCache={},this.engine=e}_getVertexShaderCode(){return null}_getFragmentShaderCode(){return null}_handlesSpectorRebuildCallback(e){throw new Error("Not implemented")}_fillEffectInformation(e,t,i,s,r,n,o,l){const h=this.engine;if(h.supportsUniformBuffers)for(const d in t)e.bindUniformBlock(d,t[d]);this.engine.getUniforms(this,i).forEach((d,f)=>{s[i[f]]=d}),this._uniforms=s;let u;for(u=0;u<r.length;u++)e.getUniform(r[u])==null&&(r.splice(u,1),u--);r.forEach((d,f)=>{n[d]=f}),l.push(...h.getAttributes(this,o))}dispose(){this._uniforms={}}_cacheMatrix(e,t){const i=this._valueCache[e],s=t.updateFlag;return i!==void 0&&i===s?!1:(this._valueCache[e]=s,!0)}_cacheFloat2(e,t,i){let s=this._valueCache[e];if(!s)return s=[t,i],this._valueCache[e]=s,!0;let r=!1;return s[0]!==t&&(s[0]=t,r=!0),s[1]!==i&&(s[1]=i,r=!0),r}_cacheFloat3(e,t,i,s){let r=this._valueCache[e];if(!r)return r=[t,i,s],this._valueCache[e]=r,!0;let n=!1;return r[0]!==t&&(r[0]=t,n=!0),r[1]!==i&&(r[1]=i,n=!0),r[2]!==s&&(r[2]=s,n=!0),n}_cacheFloat4(e,t,i,s,r){let n=this._valueCache[e];if(!n)return n=[t,i,s,r],this._valueCache[e]=n,!0;let o=!1;return n[0]!==t&&(n[0]=t,o=!0),n[1]!==i&&(n[1]=i,o=!0),n[2]!==s&&(n[2]=s,o=!0),n[3]!==r&&(n[3]=r,o=!0),o}setInt(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t)&&(this._valueCache[e]=t)}setInt2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setInt2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setInt3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setInt3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setInt4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setInt4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setIntArray(e,t){this._valueCache[e]=null,this.engine.setIntArray(this._uniforms[e],t)}setIntArray2(e,t){this._valueCache[e]=null,this.engine.setIntArray2(this._uniforms[e],t)}setIntArray3(e,t){this._valueCache[e]=null,this.engine.setIntArray3(this._uniforms[e],t)}setIntArray4(e,t){this._valueCache[e]=null,this.engine.setIntArray4(this._uniforms[e],t)}setFloatArray(e,t){this._valueCache[e]=null,this.engine.setFloatArray(this._uniforms[e],t)}setFloatArray2(e,t){this._valueCache[e]=null,this.engine.setFloatArray2(this._uniforms[e],t)}setFloatArray3(e,t){this._valueCache[e]=null,this.engine.setFloatArray3(this._uniforms[e],t)}setFloatArray4(e,t){this._valueCache[e]=null,this.engine.setFloatArray4(this._uniforms[e],t)}setArray(e,t){this._valueCache[e]=null,this.engine.setArray(this._uniforms[e],t)}setArray2(e,t){this._valueCache[e]=null,this.engine.setArray2(this._uniforms[e],t)}setArray3(e,t){this._valueCache[e]=null,this.engine.setArray3(this._uniforms[e],t)}setArray4(e,t){this._valueCache[e]=null,this.engine.setArray4(this._uniforms[e],t)}setMatrices(e,t){!t||(this._valueCache[e]=null,this.engine.setMatrices(this._uniforms[e],t))}setMatrix(e,t){this._cacheMatrix(e,t)&&(this.engine.setMatrices(this._uniforms[e],t.toArray())||(this._valueCache[e]=null))}setMatrix3x3(e,t){this._valueCache[e]=null,this.engine.setMatrix3x3(this._uniforms[e],t)}setMatrix2x2(e,t){this._valueCache[e]=null,this.engine.setMatrix2x2(this._uniforms[e],t)}setFloat(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setFloat(this._uniforms[e],t)&&(this._valueCache[e]=t)}setBool(e,t){const i=this._valueCache[e];i!==void 0&&i===t||this.engine.setInt(this._uniforms[e],t?1:0)&&(this._valueCache[e]=t?1:0)}setVector2(e,t){this._cacheFloat2(e,t.x,t.y)&&(this.engine.setFloat2(this._uniforms[e],t.x,t.y)||(this._valueCache[e]=null))}setFloat2(e,t,i){this._cacheFloat2(e,t,i)&&(this.engine.setFloat2(this._uniforms[e],t,i)||(this._valueCache[e]=null))}setVector3(e,t){this._cacheFloat3(e,t.x,t.y,t.z)&&(this.engine.setFloat3(this._uniforms[e],t.x,t.y,t.z)||(this._valueCache[e]=null))}setFloat3(e,t,i,s){this._cacheFloat3(e,t,i,s)&&(this.engine.setFloat3(this._uniforms[e],t,i,s)||(this._valueCache[e]=null))}setVector4(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setQuaternion(e,t){this._cacheFloat4(e,t.x,t.y,t.z,t.w)&&(this.engine.setFloat4(this._uniforms[e],t.x,t.y,t.z,t.w)||(this._valueCache[e]=null))}setFloat4(e,t,i,s,r){this._cacheFloat4(e,t,i,s,r)&&(this.engine.setFloat4(this._uniforms[e],t,i,s,r)||(this._valueCache[e]=null))}setColor3(e,t){this._cacheFloat3(e,t.r,t.g,t.b)&&(this.engine.setFloat3(this._uniforms[e],t.r,t.g,t.b)||(this._valueCache[e]=null))}setColor4(e,t,i){this._cacheFloat4(e,t.r,t.g,t.b,i)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,i)||(this._valueCache[e]=null))}setDirectColor4(e,t){this._cacheFloat4(e,t.r,t.g,t.b,t.a)&&(this.engine.setFloat4(this._uniforms[e],t.r,t.g,t.b,t.a)||(this._valueCache[e]=null))}}class sE extends wd{constructor(e,t,i,s){super(e,t,i,s),this.__framebuffer=null,this.__framebufferDepthStencil=null,this._engine=s}get _framebuffer(){return this.__framebuffer}set _framebuffer(e){this.__framebuffer&&this._engine._releaseFramebufferObjects(this.__framebuffer),this.__framebuffer=e}get _framebufferDepthStencil(){return this.__framebufferDepthStencil}set _framebufferDepthStencil(e){this.__framebufferDepthStencil&&this._engine._releaseFramebufferObjects(this.__framebufferDepthStencil),this.__framebufferDepthStencil=e}dispose(e=!1){this._framebuffer=null,this._framebufferDepthStencil=null,super.dispose(e)}}class Lf extends Ga{}class rE{constructor(e){this._engine=e,this._pending=new Array,this._isCommandBufferScopeActive=!1,this._commandStream=Oo._createNativeDataStream(),this._engine.setCommandDataStream(this._commandStream)}beginCommandScope(){if(this._isCommandBufferScopeActive)throw new Error("Command scope already active.");this._isCommandBufferScopeActive=!0}endCommandScope(){if(!this._isCommandBufferScopeActive)throw new Error("Command scope is not active.");this._isCommandBufferScopeActive=!1,this._submit()}startEncodingCommand(e){this._commandStream.writeNativeData(e)}encodeCommandArgAsUInt32(e){this._commandStream.writeUint32(e)}encodeCommandArgAsUInt32s(e){this._commandStream.writeUint32Array(e)}encodeCommandArgAsInt32(e){this._commandStream.writeInt32(e)}encodeCommandArgAsInt32s(e){this._commandStream.writeInt32Array(e)}encodeCommandArgAsFloat32(e){this._commandStream.writeFloat32(e)}encodeCommandArgAsFloat32s(e){this._commandStream.writeFloat32Array(e)}encodeCommandArgAsNativeData(e){this._commandStream.writeNativeData(e),this._pending.push(e)}finishEncodingCommand(){this._isCommandBufferScopeActive||this._submit()}_submit(){this._engine.submitCommands(),this._pending.length=0}}class Oo extends k{constructor(e={}){if(super(null,!1,void 0,e.adaptToDeviceRatio),this._engine=new _native.Engine,this._camera=_native.Camera?new _native.Camera:null,this._commandBufferEncoder=new rE(this._engine),this._boundBuffersVertexArray=null,this._currentDepthTest=_native.Engine.DEPTH_TEST_LEQUAL,this._stencilTest=!1,this._stencilMask=255,this._stencilFunc=519,this._stencilFuncRef=0,this._stencilFuncMask=255,this._stencilOpStencilFail=7680,this._stencilOpDepthFail=7680,this._stencilOpStencilDepthPass=7681,this._zOffset=0,this._zOffsetUnits=0,this._depthWrite=!0,_native.Engine.PROTOCOL_VERSION!==Oo.PROTOCOL_VERSION)throw new Error(`Protocol version mismatch: ${_native.Engine.PROTOCOL_VERSION} (Native) !== ${Oo.PROTOCOL_VERSION} (JS)`);this._webGLVersion=2,this.disableUniformBuffers=!0,this._caps={maxTexturesImageUnits:16,maxVertexTextureImageUnits:16,maxCombinedTexturesImageUnits:32,maxTextureSize:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_SIZE,maxCubemapTextureSize:512,maxRenderTextureSize:512,maxVertexAttribs:16,maxVaryingVectors:16,maxFragmentUniformVectors:16,maxVertexUniformVectors:16,standardDerivatives:!0,astc:null,pvrtc:null,etc1:null,etc2:null,bptc:null,maxAnisotropy:16,uintIndices:!0,fragmentDepthSupported:!1,highPrecisionShaderSupported:!0,colorBufferFloat:!1,textureFloat:!0,textureFloatLinearFiltering:!1,textureFloatRender:!1,textureHalfFloat:!1,textureHalfFloatLinearFiltering:!1,textureHalfFloatRender:!1,textureLOD:!0,drawBuffersExtension:!1,depthTextureExtension:!1,vertexArrayObject:!0,instancedArrays:!0,supportOcclusionQuery:!1,canUseTimestampForTimerQuery:!1,blendMinMax:!1,maxMSAASamples:1,canUseGLInstanceID:!0,canUseGLVertexID:!0,supportComputeShaders:!1,supportSRGBBuffers:!0,supportTransformFeedbacks:!1,textureMaxLevel:!1,texture2DArrayMaxLayerCount:_native.Engine.CAPS_LIMITS_MAX_TEXTURE_LAYERS},this._features={forceBitmapOverHTMLImageElement:!1,supportRenderAndCopyToLodForFloatTextures:!1,supportDepthStencilTexture:!1,supportShadowSamplers:!1,uniformBufferHardCheckMatrix:!1,allowTexturePrefiltering:!1,trackUbosInFrame:!1,checkUbosContentBeforeUpload:!1,supportCSM:!1,basisNeedsPOT:!1,support3DTextures:!1,needTypeSuffixInShaderConstants:!1,supportMSAA:!1,supportSSAO2:!1,supportExtendedTextureFormats:!1,supportSwitchCaseInShader:!1,supportSyncTextureRead:!1,needsInvertingBitmap:!0,useUBOBindingCache:!0,needShaderCodeInlining:!0,needToAlwaysBindUniformBuffers:!1,supportRenderPasses:!0,supportSpriteInstancing:!1,_collectUbosUpdatedInFrame:!1},q.Log("Babylon Native (v"+k.Version+") launched"),q.LoadScript=function(s,r,n,o){q.LoadFile(s,l=>{Function(l).apply(null),r&&r()},void 0,void 0,!1,(l,h)=>{n&&n("LoadScript Error",h)})},typeof URL>"u"&&(window.URL={createObjectURL:function(){},revokeObjectURL:function(){}}),typeof Blob>"u"&&(window.Blob=function(s){return s});const t=window&&window.devicePixelRatio||1;this._hardwareScalingLevel=e.adaptToDeviceRatio?t:1,this.resize();const i=this.getDepthFunction();i&&this.setDepthFunction(i),this._shaderProcessor=new t_,this.onNewSceneAddedObservable.add(s=>{const r=s.render;s.render=(...n)=>{this._commandBufferEncoder.beginCommandScope(),r.apply(s,n),this._commandBufferEncoder.endCommandScope()}})}getHardwareScalingLevel(){return this._engine.getHardwareScalingLevel()}setHardwareScalingLevel(e){this._engine.setHardwareScalingLevel(e)}dispose(){super.dispose(),this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._engine.dispose()}static _createNativeDataStream(){return new Ua}_queueNewFrame(e,t){return t.requestAnimationFrame&&t!==window?t.requestAnimationFrame(e):this._engine.requestAnimationFrame(e),0}_bindUnboundFramebuffer(e){this._currentFramebuffer!==e&&(this._currentFramebuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_UNBINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(this._currentFramebuffer),this._commandBufferEncoder.finishEncodingCommand()),e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()),this._currentFramebuffer=e)}getHostDocument(){return null}clear(e,t,i,s=!1){if(this.useReverseDepthBuffer)throw new Error("reverse depth buffer is not currently implemented");this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_CLEAR),this._commandBufferEncoder.encodeCommandArgAsUInt32(t&&e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.r:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.g:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.b:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(e?e.a:1),this._commandBufferEncoder.encodeCommandArgAsUInt32(i?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(1),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(0),this._commandBufferEncoder.finishEncodingCommand()}createIndexBuffer(e,t){const i=this._normalizeIndexData(e),s=new Lf;return s.references=1,s.is32Bits=i.BYTES_PER_ELEMENT===4,i.byteLength&&(s.nativeIndexBuffer=this._engine.createIndexBuffer(i.buffer,i.byteOffset,i.byteLength,s.is32Bits,t!=null?t:!1)),s}createVertexBuffer(e,t){const i=ArrayBuffer.isView(e)?e:new Float32Array(e),s=new Lf;return s.references=1,i.byteLength&&(s.nativeVertexBuffer=this._engine.createVertexBuffer(i.buffer,i.byteOffset,i.byteLength,t!=null?t:!1)),s}_recordVertexArrayObject(e,t,i,s,r){i&&this._engine.recordIndexBuffer(e,i.nativeIndexBuffer);const n=s.getAttributesNames();for(let o=0;o<n.length;o++){const l=s.getAttributeLocation(o);if(l>=0){const h=n[o];let c=null;if(r&&(c=r[h]),c||(c=t[h]),c){const u=c.getBuffer();u&&u.nativeVertexBuffer&&this._engine.recordVertexBuffer(e,u.nativeVertexBuffer,l,c.byteOffset,c.byteStride,c.getSize(),this._getNativeAttribType(c.type),c.normalized,c.getInstanceDivisor())}}}}bindBuffers(e,t,i){this._boundBuffersVertexArray&&this._deleteVertexArray(this._boundBuffersVertexArray),this._boundBuffersVertexArray=this._engine.createVertexArray(),this._recordVertexArrayObject(this._boundBuffersVertexArray,e,t,i),this.bindVertexArrayObject(this._boundBuffersVertexArray)}recordVertexArrayObject(e,t,i,s){const r=this._engine.createVertexArray();return this._recordVertexArrayObject(r,e,t,i,s),r}_deleteVertexArray(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}bindVertexArrayObject(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_BINDVERTEXARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand()}releaseVertexArrayObject(e){this._deleteVertexArray(e)}getAttributes(e,t){const i=e;return this._engine.getAttributes(i.nativeProgram,t)}drawElementsType(e,t,i,s){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAWINDEXED),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}drawArraysType(e,t,i,s){this._drawCalls.addCount(1,!1),this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DRAW),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand()}createPipelineContext(){return new iE(this)}createMaterialContext(){}createDrawContext(){}_preparePipelineContext(e,t,i,s,r,n,o,l,h){const c=e;s?c.nativeProgram=this.createRawShaderProgram(e,t,i,void 0,h):c.nativeProgram=this.createShaderProgram(e,t,i,l,void 0,h)}_isRenderingStateCompiled(e){return!0}_executeWhenRenderingStateIsCompiled(e,t){t()}createRawShaderProgram(e,t,i,s,r=null){throw new Error("Not Supported")}createShaderProgram(e,t,i,s,r,n=null){this.onBeforeShaderCompilationObservable.notifyObservers(this);const o=new Ra(t);o.processCode(),t=o.code;const l=new Ra(i);l.processCode(),i=l.code,t=Te._ConcatenateShader(t,s),i=Te._ConcatenateShader(i,s);const h=this._engine.createProgram(t,i);return this.onAfterShaderCompilationObservable.notifyObservers(this),h}inlineShaderCode(e){const t=new Ra(e);return t.debug=!1,t.processCode(),t.code}_setProgram(e){this._currentProgram!==e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand(),this._currentProgram=e)}_deletePipelineContext(e){const t=e;t&&t.nativeProgram&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEPROGRAM),this._commandBufferEncoder.encodeCommandArgAsNativeData(t.nativeProgram),this._commandBufferEncoder.finishEncodingCommand())}getUniforms(e,t){const i=e;return this._engine.getUniforms(i.nativeProgram,t)}bindUniformBlock(e,t,i){throw new Error("Not Implemented")}bindSamplers(e){const t=e.getPipelineContext();this._setProgram(t.nativeProgram);const i=e.getSamplers();for(let s=0;s<i.length;s++){const r=e.getUniform(i[s]);r&&(this._boundUniforms[s]=r)}this._currentEffect=null}setMatrix(e,t){if(!e)return;const i=t.toArray();this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(i),this._commandBufferEncoder.finishEncodingCommand()}getRenderWidth(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.width:this._engine.getRenderWidth()}getRenderHeight(e=!1){return!e&&this._currentRenderTarget?this._currentRenderTarget.height:this._engine.getRenderHeight()}setViewport(e,t,i){this._cachedViewport=e,this._engine.setViewPort(e.x,e.y,e.width,e.height)}setState(e,t=0,i,s=!1,r,n,o=0){var l,h;this._zOffset=t,this._zOffsetUnits=o,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTATE),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?1:0),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(o),this._commandBufferEncoder.encodeCommandArgAsUInt32(!((h=(l=this.cullBackFaces)!==null&&l!==void 0?l:r)!==null&&h!==void 0)||h?1:0),this._commandBufferEncoder.encodeCommandArgAsUInt32(s?1:0),this._commandBufferEncoder.finishEncodingCommand()}getInputElementClientRect(){return{bottom:this.getRenderHeight(),height:this.getRenderHeight(),left:0,right:this.getRenderWidth(),top:0,width:this.getRenderWidth(),x:0,y:0,toJSON:()=>{}}}setZOffset(e){e!==this._zOffset&&(this._zOffset=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSET),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffset(){return this._zOffset}setZOffsetUnits(e){e!==this._zOffsetUnits&&(this._zOffsetUnits=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETZOFFSETUNITS),this._commandBufferEncoder.encodeCommandArgAsFloat32(this.useReverseDepthBuffer?-e:e),this._commandBufferEncoder.finishEncodingCommand())}getZOffsetUnits(){return this._zOffsetUnits}setDepthBuffer(e){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(e?this._currentDepthTest:_native.Engine.DEPTH_TEST_ALWAYS),this._commandBufferEncoder.finishEncodingCommand()}getDepthWrite(){return this._depthWrite}getDepthFunction(){switch(this._currentDepthTest){case _native.Engine.DEPTH_TEST_NEVER:return 512;case _native.Engine.DEPTH_TEST_ALWAYS:return 519;case _native.Engine.DEPTH_TEST_GREATER:return 516;case _native.Engine.DEPTH_TEST_GEQUAL:return 518;case _native.Engine.DEPTH_TEST_NOTEQUAL:return 517;case _native.Engine.DEPTH_TEST_EQUAL:return 514;case _native.Engine.DEPTH_TEST_LESS:return 513;case _native.Engine.DEPTH_TEST_LEQUAL:return 515}return null}setDepthFunction(e){let t=0;switch(e){case 512:t=_native.Engine.DEPTH_TEST_NEVER;break;case 519:t=_native.Engine.DEPTH_TEST_ALWAYS;break;case 516:t=_native.Engine.DEPTH_TEST_GREATER;break;case 518:t=_native.Engine.DEPTH_TEST_GEQUAL;break;case 517:t=_native.Engine.DEPTH_TEST_NOTEQUAL;break;case 514:t=_native.Engine.DEPTH_TEST_EQUAL;break;case 513:t=_native.Engine.DEPTH_TEST_LESS;break;case 515:t=_native.Engine.DEPTH_TEST_LEQUAL;break}this._currentDepthTest=t,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHTEST),this._commandBufferEncoder.encodeCommandArgAsUInt32(this._currentDepthTest),this._commandBufferEncoder.finishEncodingCommand()}setDepthWrite(e){this._depthWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETDEPTHWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}setColorWrite(e){this._colorWrite=e,this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETCOLORWRITE),this._commandBufferEncoder.encodeCommandArgAsUInt32(Number(e)),this._commandBufferEncoder.finishEncodingCommand()}getColorWrite(){return this._colorWrite}applyStencil(){this._setStencil(this._stencilMask,this._getStencilOpFail(this._stencilOpStencilFail),this._getStencilDepthFail(this._stencilOpDepthFail),this._getStencilDepthPass(this._stencilOpStencilDepthPass),this._getStencilFunc(this._stencilFunc),this._stencilFuncRef)}_setStencil(e,t,i,s,r,n){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETSTENCIL),this._commandBufferEncoder.encodeCommandArgAsUInt32(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.encodeCommandArgAsUInt32(r),this._commandBufferEncoder.encodeCommandArgAsUInt32(n),this._commandBufferEncoder.finishEncodingCommand()}setStencilBuffer(e){this._stencilTest=e,e?this.applyStencil():this._setStencil(255,_native.Engine.STENCIL_OP_FAIL_S_KEEP,_native.Engine.STENCIL_OP_FAIL_Z_KEEP,_native.Engine.STENCIL_OP_PASS_Z_KEEP,_native.Engine.STENCIL_TEST_ALWAYS,0)}getStencilBuffer(){return this._stencilTest}getStencilOperationPass(){return this._stencilOpStencilDepthPass}setStencilOperationPass(e){this._stencilOpStencilDepthPass=e,this.applyStencil()}setStencilMask(e){this._stencilMask=e,this.applyStencil()}setStencilFunction(e){this._stencilFunc=e,this.applyStencil()}setStencilFunctionReference(e){this._stencilFuncRef=e,this.applyStencil()}setStencilFunctionMask(e){this._stencilFuncMask=e}setStencilOperationFail(e){this._stencilOpStencilFail=e,this.applyStencil()}setStencilOperationDepthFail(e){this._stencilOpDepthFail=e,this.applyStencil()}getStencilMask(){return this._stencilMask}getStencilFunction(){return this._stencilFunc}getStencilFunctionReference(){return this._stencilFuncRef}getStencilFunctionMask(){return this._stencilFuncMask}getStencilOperationFail(){return this._stencilOpStencilFail}getStencilOperationDepthFail(){return this._stencilOpDepthFail}setAlphaConstants(e,t,i,s){throw new Error("Setting alpha blend constant color not yet implemented.")}setAlphaMode(e,t=!1){if(this._alphaMode===e)return;const i=this._getNativeAlphaMode(e);this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETBLENDMODE),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t||this.setDepthWrite(e===0),this._alphaMode=e}getAlphaMode(){return this._alphaMode}setInt(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setIntArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETINTARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsInt32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloatArray4(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOATARRAY4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setArray(e,t){return e?this.setFloatArray(e,new Float32Array(t)):!1}setArray2(e,t){return e?this.setFloatArray2(e,new Float32Array(t)):!1}setArray3(e,t){return e?this.setFloatArray3(e,new Float32Array(t)):!1}setArray4(e,t){return e?this.setFloatArray4(e,new Float32Array(t)):!1}setMatrices(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRICES),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix3x3(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX3X3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setMatrix2x2(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETMATRIX2X2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32s(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat(e,t){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat2(e,t,i){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT2),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat3(e,t,i,s){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT3),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setFloat4(e,t,i,s,r){return e?(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETFLOAT4),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsFloat32(t),this._commandBufferEncoder.encodeCommandArgAsFloat32(i),this._commandBufferEncoder.encodeCommandArgAsFloat32(s),this._commandBufferEncoder.encodeCommandArgAsFloat32(r),this._commandBufferEncoder.finishEncodingCommand(),!0):!1}setColor3(e,t){return e?(this.setFloat3(e,t.r,t.g,t.b),!0):!1}setColor4(e,t,i){return e?(this.setFloat4(e,t.r,t.g,t.b,i),!0):!1}wipeCaches(e){this.preventCacheWipeBetweenFrames||(this.resetTextureCache(),this._currentEffect=null,e&&(this._currentProgram=null,this._stencilStateComposer.reset(),this._depthCullingState.reset(),this._alphaState.reset()),this._cachedVertexBuffers=null,this._cachedIndexBuffer=null,this._cachedEffectForVertexBuffers=null)}_createTexture(){return this._engine.createTexture()}_deleteTexture(e){e&&this._engine.deleteTexture(e)}updateDynamicTexture(e,t,i,s=!1,r){if(s===void 0&&(s=!1),!!e&&!!e._hardwareTexture){const n=t.getCanvasTexture(),o=e._hardwareTexture.underlyingResource;this._engine.copyTexture(o,n),e.isReady=!0}}createDynamicTexture(e,t,i,s){return e=Math.max(e,1),t=Math.max(t,1),this.createRawTexture(new Uint8Array(e*t*4),e,t,5,!1,!1,s)}createVideoElement(e){return this._camera?this._camera.createVideo(e):null}updateVideoTexture(e,t,i){if(e&&e._hardwareTexture&&this._camera){const s=e._hardwareTexture.underlyingResource;this._camera.updateVideoTexture(s,t,i)}}createRawTexture(e,t,i,s,r,n,o,l=null,h=0,c=0,u=!1){const d=new gt(this,We.Raw);if(d.format=s,d.generateMipMaps=r,d.samplingMode=o,d.invertY=n,d.baseWidth=t,d.baseHeight=i,d.width=d.baseWidth,d.height=d.baseHeight,d._compression=l,d.type=h,d._useSRGBBuffer=this._getUseSRGBBuffer(u,!r),this.updateRawTexture(d,e,s,n,l,h,d._useSRGBBuffer),d._hardwareTexture){const f=d._hardwareTexture.underlyingResource,p=this._getNativeSamplingMode(o);this._setTextureSampling(f,p)}return this._internalTexturesCache.push(d),d}createRawTexture2DArray(e,t,i,s,r,n,o,l,h=null,c=0){const u=new gt(this,We.Raw2DArray);if(u.baseWidth=t,u.baseHeight=i,u.baseDepth=s,u.width=t,u.height=i,u.depth=s,u.format=r,u.type=c,u.generateMipMaps=n,u.samplingMode=l,u.is2DArray=!0,u._hardwareTexture){const d=u._hardwareTexture.underlyingResource;this._engine.loadRawTexture2DArray(d,e,t,i,s,this._getNativeTextureFormat(r,c),n,o);const f=this._getNativeSamplingMode(l);this._setTextureSampling(d,f)}return u.isReady=!0,this._internalTexturesCache.push(u),u}updateRawTexture(e,t,i,s,r=null,n=0,o=!1){if(!!e){if(t&&e._hardwareTexture){const l=e._hardwareTexture.underlyingResource;this._engine.loadRawTexture(l,t,e.width,e.height,this._getNativeTextureFormat(i,n),e.generateMipMaps,e.invertY)}e.isReady=!0}}createTexture(e,t,i,s,r=3,n=null,o=null,l=null,h=null,c=null,u=null,d,f,p,_=!1){e=e||"";const m=e.substr(0,5)==="data:",v=m&&e.indexOf(";base64,")!==-1,x=h||new gt(this,We.Url),b=e;this._transformTextureUrl&&!v&&!h&&!l&&(e=this._transformTextureUrl(e));const S=e.lastIndexOf("."),C=u||(S>-1?e.substring(S).toLowerCase():"");let E=null;for(const D of k._TextureLoaders)if(D.canLoad(C)){E=D;break}s&&s.addPendingData(x),x.url=e,x.generateMipMaps=!t,x.samplingMode=r,x.invertY=i,x._useSRGBBuffer=this._getUseSRGBBuffer(_,t),this.doNotHandleContextLost||(x._buffer=l);let A=null;n&&!h&&(A=x.onLoadedObservable.add(n)),h||this._internalTexturesCache.push(x);const M=(D,P)=>{s&&s.removePendingData(x),e===b?(A&&x.onLoadedObservable.remove(A),ye.UseFallbackTexture&&this.createTexture(ye.FallbackTexture,t,x.invertY,s,r,null,o,l,x),o&&o((D||"Unknown error")+(ye.UseFallbackTexture?" - Fallback texture was used":""),P)):(B.Warn(`Failed to load ${e}, falling back to ${b}`),this.createTexture(b,t,x.invertY,s,r,n,o,l,x,c,u,d,f))};if(E)throw new Error("Loading textures from IInternalTextureLoader not yet implemented.");{const D=P=>{if(!x._hardwareTexture){s&&s.removePendingData(x);return}const O=x._hardwareTexture.underlyingResource;this._engine.loadTexture(O,P,!t,i,_,()=>{x.baseWidth=this._engine.getTextureWidth(O),x.baseHeight=this._engine.getTextureHeight(O),x.width=x.baseWidth,x.height=x.baseHeight,x.isReady=!0;const N=this._getNativeSamplingMode(r);this._setTextureSampling(O,N),s&&s.removePendingData(x),x.onLoadedObservable.notifyObservers(x),x.onLoadedObservable.clear()},()=>{throw new Error("Could not load a native texture.")})};if(m&&l)if(l instanceof ArrayBuffer)D(new Uint8Array(l));else if(ArrayBuffer.isView(l))D(l);else if(typeof l=="string")D(new Uint8Array(q.DecodeBase64(l)));else throw new Error("Unsupported buffer type");else v?D(new Uint8Array(q.DecodeBase64(e))):this._loadFile(e,P=>D(new Uint8Array(P)),void 0,void 0,!0,(P,O)=>{M("Unable to load "+(P&&P.responseURL,O))})}return x}wrapNativeTexture(e){const t=new zl(e,this._gl),i=new gt(this,We.Unknown,!0);return i._hardwareTexture=t,i.isReady=!0,i}wrapWebGLTexture(){throw new Error("wrapWebGLTexture is not supported, use wrapNativeTexture instead.")}_createDepthStencilTexture(e,t,i){const s=i,r=new gt(this,We.DepthStencil),n=e.width||e,o=e.height||e,l=this._engine.createFrameBuffer(r._hardwareTexture.underlyingResource,n,o,_native.Engine.TEXTURE_FORMAT_RGBA8,!1,!0,!1);return s._framebufferDepthStencil=l,r}_releaseFramebufferObjects(e){e&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEFRAMEBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.finishEncodingCommand())}_createImageBitmapFromSource(e,t){return new Promise((s,r)=>{const n=this.createCanvasImage();n.onload=()=>{try{const o=this._engine.createImageBitmap(n);s(o)}catch(o){r(`Error loading image ${n.src} with exception: ${o}`)}},n.onerror=o=>{r(`Error loading image ${n.src} with exception: ${o}`)},n.src=e})}createImageBitmap(e,t){return new Promise((i,s)=>{if(Array.isArray(e)){const r=e;if(r.length){const n=this._engine.createImageBitmap(r[0]);if(n){i(n);return}}}s("Unsupported data for createImageBitmap.")})}resizeImageBitmap(e,t,i){return this._engine.resizeImageBitmap(e,t,i)}createCubeTexture(e,t,i,s,r=null,n=null,o,l=null,h=!1,c=0,u=0,d=null,f,p=!1){const _=d||new gt(this,We.Cube);_.isCube=!0,_.url=e,_.generateMipMaps=!s,_._lodGenerationScale=c,_._lodGenerationOffset=u,this._doNotHandleContextLost||(_._extension=l,_._files=i);const m=e.lastIndexOf(".");if((l||(m>-1?e.substring(m).toLowerCase():""))===".env"){const x=b=>{const S=mm(b);_.width=S.width,_.height=S.width,vm(_,S);const C=S.specular;if(!C)throw new Error("Nothing else parsed so far");_._lodGenerationScale=C.lodGenerationScale;const E=gm(b,S);_.format=5,_.type=0,_.generateMipMaps=!0,_.getEngine().updateTextureSamplingMode(H.TRILINEAR_SAMPLINGMODE,_),_._isRGBD=!0,_.invertY=!0,this._engine.loadCubeTextureWithMips(_._hardwareTexture.underlyingResource,E,!1,p,()=>{_.isReady=!0,r&&r()},()=>{throw new Error("Could not load a native cube texture.")})};if(i&&i.length===6)throw new Error("Multi-file loading not allowed on env files.");{const b=(S,C)=>{n&&S&&n(S.status+" "+S.statusText,C)};this._loadFile(e,S=>x(new Uint8Array(S)),void 0,void 0,!0,b)}}else{if(!i||i.length!==6)throw new Error("Cannot load cubemap because 6 files were not defined");const x=[i[0],i[3],i[1],i[4],i[2],i[5]];Promise.all(x.map(b=>q.LoadFileAsync(b).then(S=>new Uint8Array(S)))).then(b=>new Promise((S,C)=>{this._engine.loadCubeTexture(_._hardwareTexture.underlyingResource,b,!s,!0,p,S,C)})).then(()=>{_.isReady=!0,r&&r()},b=>{n&&n(`Failed to load cubemap: ${b.message}`,b)})}return this._internalTexturesCache.push(_),_}_createHardwareRenderTargetWrapper(e,t,i){const s=new sE(e,t,i,this);return this._renderTargetWrapperCache.push(s),s}createRenderTargetTexture(e,t){const i=this._createHardwareRenderTargetWrapper(!1,!1,e),s={};t!==void 0&&typeof t=="object"?(s.generateMipMaps=t.generateMipMaps,s.generateDepthBuffer=t.generateDepthBuffer===void 0?!0:t.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&t.generateStencilBuffer,s.type=t.type===void 0?0:t.type,s.samplingMode=t.samplingMode===void 0?3:t.samplingMode,s.format=t.format===void 0?5:t.format):(s.generateMipMaps=t,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.type=0,s.samplingMode=3,s.format=5),(s.type===1&&!this._caps.textureFloatLinearFiltering||s.type===2&&!this._caps.textureHalfFloatLinearFiltering)&&(s.samplingMode=1);const r=new gt(this,We.RenderTarget),n=e.width||e,o=e.height||e;s.type===1&&!this._caps.textureFloat&&(s.type=0,B.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const l=this._engine.createFrameBuffer(r._hardwareTexture.underlyingResource,n,o,this._getNativeTextureFormat(s.format,s.type),!!s.generateStencilBuffer,s.generateDepthBuffer,!!s.generateMipMaps);return i._framebuffer=l,i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=!!s.generateStencilBuffer,r.baseWidth=n,r.baseHeight=o,r.width=n,r.height=o,r.isReady=!0,r.samples=1,r.generateMipMaps=!!s.generateMipMaps,r.samplingMode=s.samplingMode,r.type=s.type,r.format=s.format,this._internalTexturesCache.push(r),i.setTextures(r),i}updateTextureSamplingMode(e,t){if(t._hardwareTexture){const i=this._getNativeSamplingMode(e);this._setTextureSampling(t._hardwareTexture.underlyingResource,i)}t.samplingMode=e}bindFramebuffer(e,t,i,s,r){const n=e;if(t)throw new Error("Cuboid frame buffers are not yet supported in NativeEngine.");if(i||s)throw new Error("Required width/height for frame buffers not yet supported in NativeEngine.");n._framebufferDepthStencil?this._bindUnboundFramebuffer(n._framebufferDepthStencil):this._bindUnboundFramebuffer(n._framebuffer)}unBindFramebuffer(e,t=!1,i){i&&i(),this._bindUnboundFramebuffer(null)}createDynamicVertexBuffer(e){return this.createVertexBuffer(e,!0)}updateDynamicIndexBuffer(e,t,i=0){const s=e,r=this._normalizeIndexData(t);s.is32Bits=r.BYTES_PER_ELEMENT===4,this._engine.updateDynamicIndexBuffer(s.nativeIndexBuffer,r.buffer,r.byteOffset,r.byteLength,i)}updateDynamicVertexBuffer(e,t,i,s){const r=e,n=ArrayBuffer.isView(t)?t:new Float32Array(t);this._engine.updateDynamicVertexBuffer(r.nativeVertexBuffer,n.buffer,n.byteOffset+(i!=null?i:0),s!=null?s:n.byteLength)}_setTexture(e,t,i=!1,s=!1){const r=this._boundUniforms[e];if(!r)return!1;if(!t)return this._boundTexturesCache[e]!=null&&(this._activeChannel=e,this._setTextureCore(r,null)),!1;if(t.video)this._activeChannel=e,t.update();else if(t.delayLoadState===4)return t.delayLoad(),!1;let n;return s?n=t.depthStencilTexture:t.isReady()?n=t.getInternalTexture():t.isCube?n=this.emptyCubeTexture:t.is3D?n=this.emptyTexture3D:t.is2DArray?n=this.emptyTexture2DArray:n=this.emptyTexture,this._activeChannel=e,!n||!n._hardwareTexture?!1:(this._setTextureWrapMode(n._hardwareTexture.underlyingResource,this._getAddressMode(t.wrapU),this._getAddressMode(t.wrapV),this._getAddressMode(t.wrapR)),this._updateAnisotropicLevel(t),this._setTextureCore(r,n._hardwareTexture.underlyingResource),!0)}_setTextureSampling(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURESAMPLING),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.finishEncodingCommand()}_setTextureWrapMode(e,t,i,s){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREWRAPMODE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsUInt32(t),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.encodeCommandArgAsUInt32(s),this._commandBufferEncoder.finishEncodingCommand()}_setTextureCore(e,t){this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTURE),this._commandBufferEncoder.encodeCommandArgAsNativeData(e),this._commandBufferEncoder.encodeCommandArgAsNativeData(t),this._commandBufferEncoder.finishEncodingCommand()}_updateAnisotropicLevel(e){const t=e.getInternalTexture(),i=e.anisotropicFilteringLevel;!t||!t._hardwareTexture||t._cachedAnisotropicFilteringLevel!==i&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_SETTEXTUREANISOTROPICLEVEL),this._commandBufferEncoder.encodeCommandArgAsNativeData(t._hardwareTexture.underlyingResource),this._commandBufferEncoder.encodeCommandArgAsUInt32(i),this._commandBufferEncoder.finishEncodingCommand(),t._cachedAnisotropicFilteringLevel=i)}_getAddressMode(e){switch(e){case 1:return _native.Engine.ADDRESS_MODE_WRAP;case 0:return _native.Engine.ADDRESS_MODE_CLAMP;case 2:return _native.Engine.ADDRESS_MODE_MIRROR;default:throw new Error("Unexpected wrap mode: "+e+".")}}_bindTexture(e,t){const i=this._boundUniforms[e];if(!!i&&t&&t._hardwareTexture){const s=t._hardwareTexture.underlyingResource;this._setTextureCore(i,s)}}_deleteBuffer(e){e.nativeIndexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEINDEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeIndexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeIndexBuffer),e.nativeVertexBuffer&&(this._commandBufferEncoder.startEncodingCommand(_native.Engine.COMMAND_DELETEVERTEXBUFFER),this._commandBufferEncoder.encodeCommandArgAsNativeData(e.nativeVertexBuffer),this._commandBufferEncoder.finishEncodingCommand(),delete e.nativeVertexBuffer)}createCanvas(e,t){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");const i=new _native.Canvas;return i.width=e,i.height=t,i}createCanvasImage(){if(!_native.Canvas)throw new Error("Native Canvas plugin not available.");return new _native.Image}updateTextureData(e,t,i,s,r,n,o=0,l=0,h=!1){throw new Error("updateTextureData not implemented.")}_uploadCompressedDataToTextureDirectly(e,t,i,s,r,n=0,o=0){throw new Error("_uploadCompressedDataToTextureDirectly not implemented.")}_uploadDataToTextureDirectly(e,t,i=0,s=0){throw new Error("_uploadDataToTextureDirectly not implemented.")}_uploadArrayBufferViewToTexture(e,t,i=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_uploadImageToTexture(e,t,i=0,s=0){throw new Error("_uploadArrayBufferViewToTexture not implemented.")}_getNativeSamplingMode(e){switch(e){case 1:return _native.Engine.TEXTURE_NEAREST_NEAREST;case 2:return _native.Engine.TEXTURE_LINEAR_LINEAR;case 3:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPLINEAR;case 4:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPNEAREST;case 5:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPNEAREST;case 6:return _native.Engine.TEXTURE_NEAREST_LINEAR_MIPLINEAR;case 7:return _native.Engine.TEXTURE_NEAREST_LINEAR;case 8:return _native.Engine.TEXTURE_NEAREST_NEAREST_MIPLINEAR;case 9:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPNEAREST;case 10:return _native.Engine.TEXTURE_LINEAR_NEAREST_MIPLINEAR;case 11:return _native.Engine.TEXTURE_LINEAR_LINEAR_MIPNEAREST;case 12:return _native.Engine.TEXTURE_LINEAR_NEAREST;default:throw new Error(`Unsupported sampling mode: ${e}.`)}}_getStencilFunc(e){switch(e){case 513:return _native.Engine.STENCIL_TEST_LESS;case 515:return _native.Engine.STENCIL_TEST_LEQUAL;case 514:return _native.Engine.STENCIL_TEST_EQUAL;case 518:return _native.Engine.STENCIL_TEST_GEQUAL;case 516:return _native.Engine.STENCIL_TEST_GREATER;case 517:return _native.Engine.STENCIL_TEST_NOTEQUAL;case 512:return _native.Engine.STENCIL_TEST_NEVER;case 519:return _native.Engine.STENCIL_TEST_ALWAYS;default:throw new Error(`Unsupported stencil func mode: ${e}.`)}}_getStencilOpFail(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_S_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_S_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_S_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_S_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_S_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_S_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_S_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_S_DECRSAT;default:throw new Error(`Unsupported stencil OpFail mode: ${e}.`)}}_getStencilDepthFail(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_FAIL_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_FAIL_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_FAIL_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_FAIL_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_FAIL_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_FAIL_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_FAIL_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_FAIL_Z_DECRSAT;default:throw new Error(`Unsupported stencil depthFail mode: ${e}.`)}}_getStencilDepthPass(e){switch(e){case 7680:return _native.Engine.STENCIL_OP_PASS_Z_KEEP;case 0:return _native.Engine.STENCIL_OP_PASS_Z_ZERO;case 7681:return _native.Engine.STENCIL_OP_PASS_Z_REPLACE;case 7682:return _native.Engine.STENCIL_OP_PASS_Z_INCR;case 7683:return _native.Engine.STENCIL_OP_PASS_Z_DECR;case 5386:return _native.Engine.STENCIL_OP_PASS_Z_INVERT;case 34055:return _native.Engine.STENCIL_OP_PASS_Z_INCRSAT;case 34056:return _native.Engine.STENCIL_OP_PASS_Z_DECRSAT;default:throw new Error(`Unsupported stencil opPass mode: ${e}.`)}}_getNativeTextureFormat(e,t){if(e==4&&t==0)return _native.Engine.TEXTURE_FORMAT_RGB8;if(e==5&&t==0)return _native.Engine.TEXTURE_FORMAT_RGBA8;if(e==5&&t==1)return _native.Engine.TEXTURE_FORMAT_RGBA32F;throw new Xr(`Unsupported texture format or type: format ${e}, type ${t}.`,Hn.UnsupportedTextureError)}_getNativeAlphaMode(e){switch(e){case 0:return _native.Engine.ALPHA_DISABLE;case 1:return _native.Engine.ALPHA_ADD;case 2:return _native.Engine.ALPHA_COMBINE;case 3:return _native.Engine.ALPHA_SUBTRACT;case 4:return _native.Engine.ALPHA_MULTIPLY;case 5:return _native.Engine.ALPHA_MAXIMIZED;case 6:return _native.Engine.ALPHA_ONEONE;case 7:return _native.Engine.ALPHA_PREMULTIPLIED;case 8:return _native.Engine.ALPHA_PREMULTIPLIED_PORTERDUFF;case 9:return _native.Engine.ALPHA_INTERPOLATE;case 10:return _native.Engine.ALPHA_SCREENMODE;default:throw new Error(`Unsupported alpha mode: ${e}.`)}}_getNativeAttribType(e){switch(e){case y.BYTE:return _native.Engine.ATTRIB_TYPE_INT8;case y.UNSIGNED_BYTE:return _native.Engine.ATTRIB_TYPE_UINT8;case y.SHORT:return _native.Engine.ATTRIB_TYPE_INT16;case y.UNSIGNED_SHORT:return _native.Engine.ATTRIB_TYPE_UINT16;case y.FLOAT:return _native.Engine.ATTRIB_TYPE_FLOAT;default:throw new Error(`Unsupported attribute type: ${e}.`)}}getFontOffset(e){return{ascent:0,height:0,descent:0}}_readTexturePixels(e,t,i,s,r,n,o,l,h,c){var u,d,f,p;if(s!==void 0&&s!==-1)throw new Error(`Reading cubemap faces is not supported, but faceIndex is ${s}.`);return this._engine.readTexture((u=e._hardwareTexture)===null||u===void 0?void 0:u.underlyingResource,r!=null?r:0,h!=null?h:0,c!=null?c:0,t,i,(d=n==null?void 0:n.buffer)!==null&&d!==void 0?d:null,(f=n==null?void 0:n.byteOffset)!==null&&f!==void 0?f:0,(p=n==null?void 0:n.byteLength)!==null&&p!==void 0?p:0).then(_=>(n||(n=new Uint8Array(_)),n))}}Oo.PROTOCOL_VERSION=6;Oo._createNativeDataStream=function(){return _native.NativeDataStream.VALIDATION_ENABLED?new nE:new Ua};class nE extends Ua{constructor(){super()}writeUint32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32),super.writeUint32(e)}writeInt32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32),super.writeInt32(e)}writeFloat32(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32),super.writeFloat32(e)}writeUint32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_UINT_32_ARRAY),super.writeUint32Array(e)}writeInt32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_INT_32_ARRAY),super.writeInt32Array(e)}writeFloat32Array(e){super.writeUint32(_native.NativeDataStream.VALIDATION_FLOAT_32_ARRAY),super.writeFloat32Array(e)}writeNativeData(e){super.writeUint32(_native.NativeDataStream.VALIDATION_NATIVE_DATA),super.writeNativeData(e)}writeBoolean(e){super.writeUint32(_native.NativeDataStream.VALIDATION_BOOLEAN),super.writeBoolean(e)}}Le.prototype.setAlphaMode=function(a,e=!1){if(!(this._alphaMode===a&&(a===0&&!this._alphaState.alphaBlend||a!==0&&this._alphaState.alphaBlend))){switch(a){case 0:this._alphaState.alphaBlend=!1;break;case 7:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,1),this._alphaState.alphaBlend=!0;break;case 8:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 2:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,1),this._alphaState.alphaBlend=!0;break;case 6:this._alphaState.setAlphaBlendFunctionParameters(1,1,0,1),this._alphaState.alphaBlend=!0;break;case 1:this._alphaState.setAlphaBlendFunctionParameters(770,1,0,1),this._alphaState.alphaBlend=!0;break;case 3:this._alphaState.setAlphaBlendFunctionParameters(0,769,1,1),this._alphaState.alphaBlend=!0;break;case 4:this._alphaState.setAlphaBlendFunctionParameters(774,0,1,1),this._alphaState.alphaBlend=!0;break;case 5:this._alphaState.setAlphaBlendFunctionParameters(770,769,1,1),this._alphaState.alphaBlend=!0;break;case 9:this._alphaState.setAlphaBlendFunctionParameters(32769,32770,32771,32772),this._alphaState.alphaBlend=!0;break;case 10:this._alphaState.setAlphaBlendFunctionParameters(1,769,1,771),this._alphaState.alphaBlend=!0;break;case 11:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,1),this._alphaState.alphaBlend=!0;break;case 12:this._alphaState.setAlphaBlendFunctionParameters(772,1,0,0),this._alphaState.alphaBlend=!0;break;case 13:this._alphaState.setAlphaBlendFunctionParameters(775,769,773,771),this._alphaState.alphaBlend=!0;break;case 14:this._alphaState.setAlphaBlendFunctionParameters(1,771,1,771),this._alphaState.alphaBlend=!0;break;case 15:this._alphaState.setAlphaBlendFunctionParameters(1,1,1,0),this._alphaState.alphaBlend=!0;break;case 16:this._alphaState.setAlphaBlendFunctionParameters(775,769,0,1),this._alphaState.alphaBlend=!0;break;case 17:this._alphaState.setAlphaBlendFunctionParameters(770,771,1,771),this._alphaState.alphaBlend=!0;break}e||(this.setDepthWrite(a===k.ALPHA_DISABLE),this._cacheRenderPipeline.setDepthWriteEnabled(a===k.ALPHA_DISABLE)),this._alphaMode=a,this._cacheRenderPipeline.setAlphaBlendEnabled(this._alphaState.alphaBlend),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)}};Le.prototype.setAlphaEquation=function(a){k.prototype.setAlphaEquation.call(this,a),this._cacheRenderPipeline.setAlphaBlendFactors(this._alphaState._blendFunctionParameters,this._alphaState._blendEquationParameters)};class qc{constructor(e,t){this._device=e,this._cacheSampler=t,this.uniqueId=qc._Counter++,this._bindGroupEntries=[],this.clear()}getBindGroups(e,t,i){if(!i)throw new Error("WebGPUComputeContext.getBindGroups: bindingsMapping is required until browsers support reflection for wgsl shaders!");if(this._bindGroups.length===0){const s=this._bindGroupEntries.length>0;for(const r in e){const n=e[r],o=i[r],l=o.group,h=o.binding,c=n.type,u=n.object;let d=n.indexInGroupEntries,f=this._bindGroupEntries[l];switch(f||(f=this._bindGroupEntries[l]=[]),c){case Jt.Sampler:{const p=u;d!==void 0&&s?f[d].resource=this._cacheSampler.getSampler(p):(n.indexInGroupEntries=f.length,f.push({binding:h,resource:this._cacheSampler.getSampler(p)}));break}case Jt.Texture:case Jt.TextureWithoutSampler:{const p=u,_=p._texture._hardwareTexture;d!==void 0&&s?(c===Jt.Texture&&(f[d++].resource=this._cacheSampler.getSampler(p._texture)),f[d].resource=_.view):(n.indexInGroupEntries=f.length,c===Jt.Texture&&f.push({binding:h-1,resource:this._cacheSampler.getSampler(p._texture)}),f.push({binding:h,resource:_.view}));break}case Jt.StorageTexture:{const p=u,_=p._texture._hardwareTexture;(_.textureAdditionalUsages&Ft.StorageBinding)===0&&B.Error(`computeDispatch: The texture (name=${p.name}, uniqueId=${p.uniqueId}) is not a storage texture!`,50),d!==void 0&&s?f[d].resource=_.viewForWriting:(n.indexInGroupEntries=f.length,f.push({binding:h,resource:_.viewForWriting}));break}case Jt.UniformBuffer:case Jt.StorageBuffer:{const _=(c===Jt.UniformBuffer,u).getBuffer(),m=_.underlyingResource;d!==void 0&&s?(f[d].resource.buffer=m,f[d].resource.size=_.capacity):(n.indexInGroupEntries=f.length,f.push({binding:h,resource:{buffer:m,offset:0,size:_.capacity}}));break}}}for(let r=0;r<this._bindGroupEntries.length;++r){const n=this._bindGroupEntries[r];if(!n){this._bindGroups[r]=void 0;continue}this._bindGroups[r]=this._device.createBindGroup({layout:t.getBindGroupLayout(r),entries:n})}this._bindGroups.length=this._bindGroupEntries.length}return this._bindGroups}clear(){this._bindGroups=[]}}qc._Counter=0;class aE{constructor(e){this._name="unnamed",this.engine=e}get isAsync(){return!1}get isReady(){return!!this.stage}_getComputeShaderCode(){var e;return(e=this.sources)===null||e===void 0?void 0:e.compute}dispose(){}}Le.prototype.createComputeContext=function(){return new qc(this._device,this._cacheSampler)};Le.prototype.createComputeEffect=function(a,e){const i=(a.computeElement||a.compute||a.computeToken||a.computeSource||a)+"@"+e.defines;if(this._compiledComputeEffects[i]){const r=this._compiledComputeEffects[i];return e.onCompiled&&r.isReady()&&e.onCompiled(r),r}const s=new Po(a,e,this,i);return this._compiledComputeEffects[i]=s,s};Le.prototype.createComputePipelineContext=function(){return new aE(this)};Le.prototype.areAllComputeEffectsReady=function(){for(const a in this._compiledComputeEffects)if(!this._compiledComputeEffects[a].isReady())return!1;return!0};Le.prototype.computeDispatch=function(a,e,t,i,s,r,n){if(this._currentRenderTarget){this._onAfterUnbindFrameBufferObservable.addOnce(()=>{this.computeDispatch(a,e,t,i,s,r,n)});return}const o=a._pipelineContext,l=e;o.computePipeline||(o.computePipeline=this._device.createComputePipeline({layout:Vh.Auto,compute:o.stage}));const c=this._renderTargetEncoder.beginComputePass();c.setPipeline(o.computePipeline);const u=l.getBindGroups(t,o.computePipeline,n);for(let d=0;d<u.length;++d){const f=u[d];!f||c.setBindGroup(d,f)}c.dispatchWorkgroups(i,s,r),c.end()};Le.prototype.releaseComputeEffects=function(){for(const a in this._compiledComputeEffects){const e=this._compiledComputeEffects[a].getPipelineContext();this._deleteComputePipelineContext(e)}this._compiledComputeEffects={}};Le.prototype._prepareComputePipelineContext=function(a,e,t,i,s){const r=a;this.dbgShowShaderCode&&(console.log(i),console.log(e)),r.sources={compute:e,rawCompute:t},r.stage=this._createComputePipelineStageDescriptor(e,i,s)};Le.prototype._releaseComputeEffect=function(a){this._compiledComputeEffects[a._key]&&(delete this._compiledComputeEffects[a._key],this._deleteComputePipelineContext(a.getPipelineContext()))};Le.prototype._rebuildComputeEffects=function(){for(const a in this._compiledComputeEffects){const e=this._compiledComputeEffects[a];e._pipelineContext=null,e._wasPreviouslyReady=!1,e._prepareEffect()}};Le.prototype._deleteComputePipelineContext=function(a){a&&a.dispose()};Le.prototype._createComputePipelineStageDescriptor=function(a,e,t){return e?e="//"+e.split(`
`).join(`
//`)+`
`:e="",{module:this._device.createShaderModule({code:e+a}),entryPoint:t}};Le.prototype._createDepthStencilCubeTexture=function(a,e){const t=new gt(this,We.DepthStencil);t.isCube=!0;const i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,...e};return t.format=i.generateStencil?13:14,this._setupDepthStencilTexture(t,a,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t};Le.prototype.createCubeTexture=function(a,e,t,i,s=null,r=null,n,o=null,l=!1,h=0,c=0,u=null,d=!1){return this.createCubeTextureBase(a,e,t,!!i,s,r,n,o,l,h,c,u,null,(f,p)=>{const _=p,m=_[0].width,v=m;this._setCubeMapTextureParams(f,!i),f.format=n!=null?n:-1;const x=this._textureHelper.createGPUTextureForInternalTexture(f,m,v);this._textureHelper.updateCubeTextures(_,x.underlyingResource,m,v,x.format,!1,!1,0,0),i||this._generateMipmaps(f,this._uploadEncoder),f.isReady=!0,f.onLoadedObservable.notifyObservers(f),f.onLoadedObservable.clear(),s&&s()},!!d)};Le.prototype._setCubeMapTextureParams=function(a,e,t){a.samplingMode=e?3:2,a._cachedWrapU=0,a._cachedWrapV=0,t&&(a._maxLodLevel=t)};Le.prototype._debugPushGroup=function(a,e){!this._options.enableGPUDebugMarkers||(e===0||e===1?(e===0?this._renderEncoder:this._renderTargetEncoder).pushDebugGroup(a):this._currentRenderPass?this._currentRenderPass.pushDebugGroup(a):this._pendingDebugCommands.push(["push",a]))};Le.prototype._debugPopGroup=function(a){!this._options.enableGPUDebugMarkers||(a===0||a===1?(a===0?this._renderEncoder:this._renderTargetEncoder).popDebugGroup():this._currentRenderPass?this._currentRenderPass.popDebugGroup():this._pendingDebugCommands.push(["pop",null]))};Le.prototype._debugInsertMarker=function(a,e){!this._options.enableGPUDebugMarkers||(e===0||e===1?(e===0?this._renderEncoder:this._renderTargetEncoder).insertDebugMarker(a):this._currentRenderPass?this._currentRenderPass.insertDebugMarker(a):this._pendingDebugCommands.push(["insert",a]))};Le.prototype._debugFlushPendingCommands=function(){for(let a=0;a<this._pendingDebugCommands.length;++a){const[e,t]=this._pendingDebugCommands[a];switch(e){case"push":this._debugPushGroup(t);break;case"pop":this._debugPopGroup();break;case"insert":this._debugInsertMarker(t);break}}this._pendingDebugCommands.length=0};Le.prototype.updateDynamicIndexBuffer=function(a,e,t=0){const i=a;let s;a.is32Bits?s=e instanceof Uint32Array?e:new Uint32Array(e):s=e instanceof Uint16Array?e:new Uint16Array(e),this._bufferManager.setSubData(i,t,s)};Le.prototype.updateDynamicVertexBuffer=function(a,e,t,i){const s=a;t===void 0&&(t=0);let r;i===void 0?(e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,i=r.byteLength):e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.setSubData(s,t,r,0,i)};Le.prototype.updateDynamicTexture=function(a,e,t,i=!1,s,r,n){var o;if(!a)return;const l=e.width,h=e.height;let c=a._hardwareTexture;!((o=a._hardwareTexture)===null||o===void 0)&&o.underlyingResource||(c=this._textureHelper.createGPUTextureForInternalTexture(a,l,h)),this._textureHelper.updateTexture(e,a,l,h,a.depth,c.format,0,0,t,i,0,0,n),a.generateMipMaps&&this._generateMipmaps(a,this._uploadEncoder),a.isReady=!0};class oE extends m_{constructor(e){super(e)}}Rt.prototype.setExternalTexture=function(a,e){this._engine.setExternalTexture(a,e)};Le.prototype.createExternalTexture=function(a){return new oE(a)};Le.prototype.setExternalTexture=function(a,e){if(!e){this._currentMaterialContext.setTexture(a,null);return}this._setInternalTexture(a,e)};Le.prototype.unBindMultiColorAttachmentFramebuffer=function(a,e=!1,t){t&&t();const s=a._attachments.length;this._currentRenderPass&&this._currentRenderPass!==this._mainRenderPassWrapper.renderPass&&this._endRenderTargetRenderPass();for(let r=0;r<s;r++){const n=a.textures[r];n.generateMipMaps&&!e&&!n.isCube&&this._generateMipmaps(n)}this._currentRenderTarget=null,this._mrtAttachments=[],this._cacheRenderPipeline.setMRT([]),this._cacheRenderPipeline.setMRTAttachments(this._mrtAttachments),this._currentRenderPass=this._mainRenderPassWrapper.renderPass,this._setDepthTextureFormat(this._mainRenderPassWrapper),this._setColorFormat(this._mainRenderPassWrapper)};Le.prototype.createMultipleRenderTarget=function(a,e,t){var i;let s=!1,r=!0,n=!1,o=!1,l=15,h=1;const c=0,u=3,d=!1;let f=new Array,p=new Array,_=new Array;const m=this._createHardwareRenderTargetWrapper(!0,!1,a);e!==void 0&&(s=e.generateMipMaps===void 0?!1:e.generateMipMaps,r=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,n=e.generateStencilBuffer===void 0?!1:e.generateStencilBuffer,o=e.generateDepthTexture===void 0?!1:e.generateDepthTexture,h=e.textureCount||1,l=(i=e.depthTextureFormat)!==null&&i!==void 0?i:15,e.types&&(f=e.types),e.samplingModes&&(p=e.samplingModes),e.useSRGBBuffers&&(_=e.useSRGBBuffers));const v=a.width||a,x=a.height||a;let b=null;(r||n||o)&&(b=m.createDepthStencilTexture(0,!1,n,1,l));const S=[],C=[],E=[];m._generateDepthBuffer=r,m._generateStencilBuffer=n,m._attachments=C,m._defaultAttachments=E;for(let A=0;A<h;A++){let M=p[A]||u,D=f[A]||c;const P=_[A]||d;(D===1&&!this._caps.textureFloatLinearFiltering||D===2&&!this._caps.textureHalfFloatLinearFiltering)&&(M=1),D===1&&!this._caps.textureFloat&&(D=0,B.Warn("Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type"));const O=new gt(this,We.MultiRenderTarget);S.push(O),C.push(A+1),E.push(t?A+1:A===0?1:0),O.baseWidth=v,O.baseHeight=x,O.width=v,O.height=x,O.isReady=!0,O.samples=1,O.generateMipMaps=s,O.samplingMode=M,O.type=D,O._cachedWrapU=0,O._cachedWrapV=0,O._useSRGBBuffer=P,this._internalTexturesCache.push(O),this._textureHelper.createGPUTextureForInternalTexture(O)}return b&&(b.incrementReferences(),S.push(b),this._internalTexturesCache.push(b)),m.setTextures(S),m};Le.prototype.updateMultipleRenderTargetTextureSampleCount=function(a,e){if(!a||!a.textures||a.textures[0].samples===e)return e;const t=a.textures.length;if(t===0)return 1;e=Math.min(e,this.getCaps().maxMSAASamples);for(let i=0;i<t;++i){const s=a.textures[i];this._textureHelper.createMSAATexture(s,e),s.samples=e}return a._depthStencilTexture&&a._depthStencilTexture!==a.textures[a.textures.length-1]&&(this._textureHelper.createMSAATexture(a._depthStencilTexture,e),a._depthStencilTexture.samples=e),e};Le.prototype.bindAttachments=function(a){a.length===0||!this._currentRenderTarget||(this._mrtAttachments=a,this._currentRenderPass&&this._cacheRenderPipeline.setMRTAttachments(a))};Le.prototype.buildTextureLayout=function(a){const e=[];for(let t=0;t<a.length;t++)a[t]?e.push(t+1):e.push(0);return e};Le.prototype.restoreSingleAttachment=function(){};Le.prototype.restoreSingleAttachmentForRenderTarget=function(){};Le.prototype.getGPUFrameTimeCounter=function(){return this._timestampQuery.gpuFrameTimeCounter};Le.prototype.captureGPUFrameTime=function(a){this._timestampQuery.enable=a&&!!this._caps.timerQuery};Le.prototype.createQuery=function(){return this._occlusionQuery.createQuery()};Le.prototype.deleteQuery=function(a){return this._occlusionQuery.deleteQuery(a),this};Le.prototype.isQueryResultAvailable=function(a){return this._occlusionQuery.isQueryResultAvailable(a)};Le.prototype.getQueryResult=function(a){return this._occlusionQuery.getQueryResult(a)};Le.prototype.beginOcclusionQuery=function(a,e){var t;if(this.compatibilityMode){if(this._occlusionQuery.canBeginQuery)return(t=this._currentRenderPass)===null||t===void 0||t.beginOcclusionQuery(e),!0}else return(this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget).addItem(new Bd(e)),!0;return!1};Le.prototype.endOcclusionQuery=function(){var a;return this.compatibilityMode?(a=this._currentRenderPass)===null||a===void 0||a.endOcclusionQuery():(this._getCurrentRenderPassIndex()===0?this._bundleList:this._bundleListRenderTarget).addItem(new Ud),this};Le.prototype.createRawTexture=function(a,e,t,i,s,r,n,o=null,l=0,h=0,c=!1){const u=new gt(this,We.Raw);return u.baseWidth=e,u.baseHeight=t,u.width=e,u.height=t,u.format=i,u.generateMipMaps=s,u.samplingMode=n,u.invertY=r,u._compression=o,u.type=l,u._useSRGBBuffer=c,this._doNotHandleContextLost||(u._bufferView=a),this._textureHelper.createGPUTextureForInternalTexture(u,e,t,void 0,h),this.updateRawTexture(u,a,i,r,o,l,c),this._internalTexturesCache.push(u),u};Le.prototype.updateRawTexture=function(a,e,t,i,s=null,r=0,n=!1){if(!!a){if(this._doNotHandleContextLost||(a._bufferView=e,a.invertY=i,a._compression=s,a._useSRGBBuffer=n),e){const o=a._hardwareTexture;t===4&&(e=Jl(e,a.width,a.height,r));const h=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(h,a,a.width,a.height,a.depth,o.format,0,0,i,!1,0,0),a.generateMipMaps&&this._generateMipmaps(a,this._uploadEncoder)}a.isReady=!0}};Le.prototype.createRawCubeTexture=function(a,e,t,i,s,r,n,o=null){const l=new gt(this,We.CubeRaw);return i===1&&!this._caps.textureFloatLinearFiltering?(s=!1,n=1,B.Warn("Float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===2&&!this._caps.textureHalfFloatLinearFiltering?(s=!1,n=1,B.Warn("Half float texture filtering is not supported. Mipmap generation and sampling mode are forced to false and TEXTURE_NEAREST_SAMPLINGMODE, respectively.")):i===1&&!this._caps.textureFloatRender?(s=!1,B.Warn("Render to float textures is not supported. Mipmap generation forced to false.")):i===2&&!this._caps.colorBufferFloat&&(s=!1,B.Warn("Render to half float textures is not supported. Mipmap generation forced to false.")),l.isCube=!0,l.format=t===4?5:t,l.type=i,l.generateMipMaps=s,l.width=e,l.height=e,l.samplingMode=n,this._doNotHandleContextLost||(l._bufferViewArray=a),l._cachedWrapU=0,l._cachedWrapV=0,this._textureHelper.createGPUTextureForInternalTexture(l),a&&this.updateRawCubeTexture(l,a,t,i,r,o),l};Le.prototype.updateRawCubeTexture=function(a,e,t,i,s,r=null){a._bufferViewArray=e,a.invertY=s,a._compression=r;const n=a._hardwareTexture,o=t===4,l=[];for(let h=0;h<e.length;++h){let c=e[h];o&&(c=Jl(e[h],a.width,a.height,i)),l.push(new Uint8Array(c.buffer,c.byteOffset,c.byteLength))}this._textureHelper.updateCubeTextures(l,n.underlyingResource,a.width,a.height,n.format,s,!1,0,0),a.generateMipMaps&&this._generateMipmaps(a,this._uploadEncoder),a.isReady=!0};Le.prototype.createRawCubeTextureFromUrl=function(a,e,t,i,s,r,n,o,l=null,h=null,c=3,u=!1){const d=this.createRawCubeTexture(null,t,i,s,!r,u,c,null);e==null||e.addPendingData(d),d.url=a,this._internalTexturesCache.push(d);const f=(_,m)=>{e==null||e.removePendingData(d),h&&_&&h(_.status+" "+_.statusText,m)},p=_=>{const m=d.width,v=n(_);if(!v)return;const x=[0,2,4,1,3,5];if(o){const b=i===4,S=o(v),C=d._hardwareTexture,E=[0,1,2,3,4,5];for(let A=0;A<S.length;A++){const M=m>>A,D=[];for(let P=0;P<6;P++){let O=S[A][E[P]];b&&(O=Jl(O,M,M,s)),D.push(new Uint8Array(O.buffer,O.byteOffset,O.byteLength))}this._textureHelper.updateCubeTextures(D,C.underlyingResource,M,M,C.format,u,!1,0,0)}}else{const b=[];for(let S=0;S<6;S++)b.push(v[x[S]]);this.updateRawCubeTexture(d,b,i,s,u)}d.isReady=!0,e==null||e.removePendingData(d),l&&l()};return this._loadFile(a,_=>{p(_)},void 0,e==null?void 0:e.offlineProvider,!0,f),d};Le.prototype.createRawTexture3D=function(a,e,t,i,s,r,n,o,l=null,h=0,c=0){const u=We.Raw3D,d=new gt(this,u);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=s,d.type=h,d.generateMipMaps=r,d.samplingMode=o,d.is3D=!0,this._doNotHandleContextLost||(d._bufferView=a),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,void 0,c),this.updateRawTexture3D(d,a,s,n,l,h),this._internalTexturesCache.push(d),d};Le.prototype.updateRawTexture3D=function(a,e,t,i,s=null,r=0){if(this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.invertY=i,a._compression=s),e){const n=a._hardwareTexture;t===4&&(e=Jl(e,a.width,a.height,r));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,a,a.width,a.height,a.depth,n.format,0,0,i,!1,0,0),a.generateMipMaps&&this._generateMipmaps(a,this._uploadEncoder)}a.isReady=!0};Le.prototype.createRawTexture2DArray=function(a,e,t,i,s,r,n,o,l=null,h=0,c=0){const u=We.Raw2DArray,d=new gt(this,u);return d.baseWidth=e,d.baseHeight=t,d.baseDepth=i,d.width=e,d.height=t,d.depth=i,d.format=s,d.type=h,d.generateMipMaps=r,d.samplingMode=o,d.is2DArray=!0,this._doNotHandleContextLost||(d._bufferView=a),this._textureHelper.createGPUTextureForInternalTexture(d,e,t,i,c),this.updateRawTexture2DArray(d,a,s,n,l,h),this._internalTexturesCache.push(d),d};Le.prototype.updateRawTexture2DArray=function(a,e,t,i,s=null,r=0){if(this._doNotHandleContextLost||(a._bufferView=e,a.format=t,a.invertY=i,a._compression=s),e){const n=a._hardwareTexture;t===4&&(e=Jl(e,a.width,a.height,r));const l=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);this._textureHelper.updateTexture(l,a,a.width,a.height,a.depth,n.format,0,0,i,!1,0,0),a.generateMipMaps&&this._generateMipmaps(a,this._uploadEncoder)}a.isReady=!0};function Jl(a,e,t,i){let s,r=1;i===1?s=new Float32Array(e*t*4):i===2?(s=new Uint16Array(e*t*4),r=15360):i===7?s=new Uint32Array(e*t*4):s=new Uint8Array(e*t*4);for(let n=0;n<e;n++)for(let o=0;o<t;o++){const l=(o*e+n)*3,h=(o*e+n)*4;s[h+0]=a[l+0],s[h+1]=a[l+1],s[h+2]=a[l+2],s[h+3]=r}return s}Le.prototype._readTexturePixels=function(a,e,t,i=-1,s=0,r=null,n=!0,o=!1,l=0,h=0){const c=a._hardwareTexture;return n&&this.flushFramebuffer(),this._textureHelper.readPixels(c.underlyingResource,l,h,e,t,c.format,i,s,r,o)};Le.prototype._readTexturePixelsSync=function(){throw"_readTexturePixelsSync is unsupported in WebGPU!"};class lE extends wd{}Le.prototype._createHardwareRenderTargetWrapper=function(a,e,t){const i=new lE(a,e,t,this);return this._renderTargetWrapperCache.push(i),i};Le.prototype.createRenderTargetTexture=function(a,e){var t;const i=this._createHardwareRenderTargetWrapper(!1,!1,a),s={};e!==void 0&&typeof e=="object"?(s.generateMipMaps=e.generateMipMaps,s.generateDepthBuffer=e.generateDepthBuffer===void 0?!0:e.generateDepthBuffer,s.generateStencilBuffer=s.generateDepthBuffer&&e.generateStencilBuffer,s.samplingMode=e.samplingMode===void 0?3:e.samplingMode,s.creationFlags=(t=e.creationFlags)!==null&&t!==void 0?t:0,s.noColorTarget=!!e.noColorTarget):(s.generateMipMaps=e,s.generateDepthBuffer=!0,s.generateStencilBuffer=!1,s.samplingMode=3,s.creationFlags=0,s.noColorTarget=!1);const r=s.noColorTarget?null:this._createInternalTexture(a,e,!0,We.RenderTarget);return i._generateDepthBuffer=s.generateDepthBuffer,i._generateStencilBuffer=!!s.generateStencilBuffer,i.setTextures(r),(i._generateDepthBuffer||i._generateStencilBuffer)&&i.createDepthStencilTexture(0,s.samplingMode===void 0||s.samplingMode===2||s.samplingMode===2||s.samplingMode===3||s.samplingMode===3||s.samplingMode===5||s.samplingMode===6||s.samplingMode===7||s.samplingMode===11,i._generateStencilBuffer,i.samples),r&&(e!==void 0&&typeof e=="object"&&e.createMipMaps&&!s.generateMipMaps&&(r.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(r,void 0,void 0,void 0,s.creationFlags),e!==void 0&&typeof e=="object"&&e.createMipMaps&&!s.generateMipMaps&&(r.generateMipMaps=!1)),i};Le.prototype._createDepthStencilTexture=function(a,e){const t=new gt(this,We.DepthStencil),i={bilinearFiltering:!1,comparisonFunction:0,generateStencil:!1,samples:1,depthTextureFormat:e.generateStencil?13:14,...e};return t.format=i.depthTextureFormat,this._setupDepthStencilTexture(t,a,i.generateStencil,i.bilinearFiltering,i.comparisonFunction,i.samples),this._textureHelper.createGPUTextureForInternalTexture(t),this._internalTexturesCache.push(t),t};Le.prototype._setupDepthStencilTexture=function(a,e,t,i,s,r=1){const n=e.width||e,o=e.height||e,l=e.layers||0;a.baseWidth=n,a.baseHeight=o,a.width=n,a.height=o,a.is2DArray=l>0,a.depth=l,a.isReady=!0,a.samples=r,a.generateMipMaps=!1,a.samplingMode=i?2:1,a.type=1,a._comparisonFunction=s,a._cachedWrapU=0,a._cachedWrapV=0};Le.prototype.updateRenderTargetTextureSampleCount=function(a,e){return!a||!a.texture||a.samples===e||(e=Math.min(e,this.getCaps().maxMSAASamples),this._textureHelper.createMSAATexture(a.texture,e),a._depthStencilTexture&&(this._textureHelper.createMSAATexture(a._depthStencilTexture,e),a._depthStencilTexture.samples=e),a.texture.samples=e),e};Le.prototype.createRenderTargetCubeTexture=function(a,e){const t=this._createHardwareRenderTargetWrapper(!1,!0,a),i={generateMipMaps:!0,generateDepthBuffer:!0,generateStencilBuffer:!1,type:0,samplingMode:3,format:5,samples:1,...e};i.generateStencilBuffer=i.generateDepthBuffer&&i.generateStencilBuffer,t._generateDepthBuffer=i.generateDepthBuffer,t._generateStencilBuffer=i.generateStencilBuffer;const s=new gt(this,We.RenderTarget);return s.width=a,s.height=a,s.depth=0,s.isReady=!0,s.isCube=!0,s.samples=i.samples,s.generateMipMaps=i.generateMipMaps,s.samplingMode=i.samplingMode,s.type=i.type,s.format=i.format,this._internalTexturesCache.push(s),t.setTextures(s),(t._generateDepthBuffer||t._generateStencilBuffer)&&t.createDepthStencilTexture(0,i.samplingMode===void 0||i.samplingMode===2||i.samplingMode===2||i.samplingMode===3||i.samplingMode===3||i.samplingMode===5||i.samplingMode===6||i.samplingMode===7||i.samplingMode===11,t._generateStencilBuffer,t.samples),e&&e.createMipMaps&&!i.generateMipMaps&&(s.generateMipMaps=!0),this._textureHelper.createGPUTextureForInternalTexture(s),e&&e.createMipMaps&&!i.generateMipMaps&&(s.generateMipMaps=!1),t};Rt.prototype.setTextureSampler=function(a,e){this._engine.setTextureSampler(a,e)};Le.prototype.setTextureSampler=function(a,e){var t;(t=this._currentMaterialContext)===null||t===void 0||t.setSampler(a,e)};Rt.prototype.setStorageBuffer=function(a,e){this._engine.setStorageBuffer(a,e)};Le.prototype.createStorageBuffer=function(a,e){return this._createBuffer(a,e|32)};Le.prototype.updateStorageBuffer=function(a,e,t,i){const s=a;t===void 0&&(t=0);let r;i===void 0?(e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,i=r.byteLength):e instanceof Array?r=new Float32Array(e):e instanceof ArrayBuffer?r=new Uint8Array(e):r=e,this._bufferManager.setSubData(s,t,r,0,i)};Le.prototype.readFromStorageBuffer=function(a,e,t,i){t=t||a.capacity;const s=this._bufferManager.createRawBuffer(t,Dt.MapRead|Dt.CopyDst);return this._renderTargetEncoder.copyBufferToBuffer(a.underlyingResource,e!=null?e:0,s,0,t),new Promise((r,n)=>{this.onEndFrameObservable.addOnce(()=>{s.mapAsync(Aa.Read,0,t).then(()=>{const o=s.getMappedRange(0,t);let l=i;if(l===void 0)l=new Uint8Array(t),l.set(new Uint8Array(o));else{const h=l.constructor;l=new h(l.buffer),l.set(new h(o))}s.unmap(),this._bufferManager.releaseBuffer(s),r(l)},o=>n(o))})})};Le.prototype.setStorageBuffer=function(a,e){var t,i;(t=this._currentDrawContext)===null||t===void 0||t.setBuffer(a,(i=e==null?void 0:e.getBuffer())!==null&&i!==void 0?i:null)};Le.prototype.createUniformBuffer=function(a){let e;return a instanceof Array?e=new Float32Array(a):e=a,this._bufferManager.createBuffer(e,Dt.Uniform|Dt.CopyDst)};Le.prototype.createDynamicUniformBuffer=function(a){return this.createUniformBuffer(a)};Le.prototype.updateUniformBuffer=function(a,e,t,i){t===void 0&&(t=0);const s=a;let r;i===void 0?(e instanceof Float32Array?r=e:r=new Float32Array(e),i=r.byteLength):e instanceof Float32Array?r=e:r=new Float32Array(e),this._bufferManager.setSubData(s,t,r,0,i)};Le.prototype.bindUniformBufferBase=function(a,e,t){this._currentDrawContext.setBuffer(t,a)};Le.prototype.bindUniformBlock=function(){};Le.prototype.updateVideoTexture=function(a,e,t){var i;if(!a||a._isDisabled)return;this._videoTextureSupported===void 0&&(this._videoTextureSupported=!0);let s=a._hardwareTexture;!((i=a._hardwareTexture)===null||i===void 0)&&i.underlyingResource||(s=this._textureHelper.createGPUTextureForInternalTexture(a)),this.createImageBitmap(e).then(r=>{this._textureHelper.updateTexture(r,a,a.width,a.height,a.depth,s.format,0,0,!t,!1,0,0),a.generateMipMaps&&this._generateMipmaps(a,this._uploadEncoder),a.isReady=!0}).catch(()=>{a.isReady=!0})};class ra extends Ya{constructor(e){super(e),this.controllerType=jr.DAYDREAM}initControllerMesh(e,t){Be.ImportMesh("",ra.MODEL_BASE_URL,ra.MODEL_FILENAME,e,i=>{this._defaultModel=i[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}_handleButtonChange(e,t){if(e===0){const i=this.onTriggerStateChangedObservable;i&&i.notifyObservers(t)}else B.Warn(`Unrecognized Daydream button index: ${e}`)}}ra.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";ra.MODEL_FILENAME="generic.babylon";ra.GAMEPAD_ID_PREFIX="Daydream";Cn._ControllerFactories.push({canCreate:a=>a.id.indexOf(ra.GAMEPAD_ID_PREFIX)===0,create:a=>new ra(a)});class na extends Ya{constructor(e){super(e),this._buttonIndexToObservableNameMap=["onPadStateChangedObservable","onTriggerStateChangedObservable"],this.controllerType=jr.GEAR_VR,this._calculatedPosition=new g(this.hand=="left"?-.15:.15,-.5,.25),this._disableTrackPosition(this._calculatedPosition)}initControllerMesh(e,t){Be.ImportMesh("",na.MODEL_BASE_URL,na.MODEL_FILENAME,e,i=>{const s=new V("",e);i[1].parent=s,i[1].position.z=-.15,this._defaultModel=s,this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}_handleButtonChange(e,t){if(e<this._buttonIndexToObservableNameMap.length){const i=this._buttonIndexToObservableNameMap[e],s=this[i];s&&s.notifyObservers(t)}}}na.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";na.MODEL_FILENAME="generic.babylon";na.GAMEPAD_ID_PREFIX="Gear VR";Cn._ControllerFactories.push({canCreate:a=>a.id.indexOf(na.GAMEPAD_ID_PREFIX)===0||a.id.indexOf("Oculus Go")!==-1||a.id.indexOf("Vive Focus")!==-1,create:a=>new na(a)});class aa extends Ya{constructor(e){super(e)}initControllerMesh(e,t){Be.ImportMesh("",aa.MODEL_BASE_URL,aa.MODEL_FILENAME,e,i=>{this._defaultModel=i[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}_handleButtonChange(e,t){console.log("Button id: "+e+"state: "),console.dir(t)}}aa.MODEL_BASE_URL="https://controllers.babylonjs.com/generic/";aa.MODEL_FILENAME="generic.babylon";Cn._DefaultControllerFactory=a=>new aa(a);class as extends Ya{constructor(e){super(e),this.onSecondaryTriggerStateChangedObservable=new X,this.onThumbRestChangedObservable=new X,this.controllerType=jr.OCULUS}initControllerMesh(e,t){let i;this.hand==="left"?i=as.MODEL_LEFT_FILENAME:i=as.MODEL_RIGHT_FILENAME,Be.ImportMesh("",as._IsQuest?as.QUEST_MODEL_BASE_URL:as.MODEL_BASE_URL,i,e,s=>{this._defaultModel=as._IsQuest?s[0]:s[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}get onAButtonStateChangedObservable(){if(this.hand==="right")return this.onMainButtonStateChangedObservable;throw new Error("No A button on left hand")}get onBButtonStateChangedObservable(){if(this.hand==="right")return this.onSecondaryButtonStateChangedObservable;throw new Error("No B button on left hand")}get onXButtonStateChangedObservable(){if(this.hand==="left")return this.onMainButtonStateChangedObservable;throw new Error("No X button on right hand")}get onYButtonStateChangedObservable(){if(this.hand==="left")return this.onSecondaryButtonStateChangedObservable;throw new Error("No Y button on right hand")}_handleButtonChange(e,t){const i=t,s=this.hand==="right"?-1:1;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(i);return;case 1:!as._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[3].rotation.x=-i.value*.2,this._defaultModel.getChildren()[3].position.y=-i.value*.005,this._defaultModel.getChildren()[3].position.z=-i.value*.005),this.onTriggerStateChangedObservable.notifyObservers(i);return;case 2:!as._IsQuest&&this._defaultModel&&(this._defaultModel.getChildren()[4].position.x=s*i.value*.0035),this.onSecondaryTriggerStateChangedObservable.notifyObservers(i);return;case 3:!as._IsQuest&&this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[1].position.y=-.001:this._defaultModel.getChildren()[1].position.y=0),this.onMainButtonStateChangedObservable.notifyObservers(i);return;case 4:!as._IsQuest&&this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(i);return;case 5:this.onThumbRestChangedObservable.notifyObservers(i);return}}}as.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";as.MODEL_LEFT_FILENAME="left.babylon";as.MODEL_RIGHT_FILENAME="right.babylon";as.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/";as._IsQuest=!1;Cn._ControllerFactories.push({canCreate:a=>(ye.LastCreatedEngine&&ye.LastCreatedEngine._vrDisplay&&ye.LastCreatedEngine._vrDisplay.displayName==="Oculus Quest"&&(as._IsQuest=!0),a.id.indexOf("Oculus Touch")!==-1),create:a=>new as(a)});class wo extends Ya{constructor(e){super(e),this.controllerType=jr.VIVE,this._invertLeftStickY=!0}initControllerMesh(e,t){Be.ImportMesh("",wo.MODEL_BASE_URL,wo.MODEL_FILENAME,e,i=>{this._defaultModel=i[1],this.attachToMesh(this._defaultModel),t&&t(this._defaultModel)})}get onLeftButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onRightButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}_handleButtonChange(e,t){const i=t;switch(e){case 0:this.onPadStateChangedObservable.notifyObservers(i);return;case 1:this._defaultModel&&(this._defaultModel.getChildren()[6].rotation.x=-i.value*.15),this.onTriggerStateChangedObservable.notifyObservers(i);return;case 2:this.onMainButtonStateChangedObservable.notifyObservers(i);return;case 3:this._defaultModel&&(i.pressed?this._defaultModel.getChildren()[2].position.y=-.001:this._defaultModel.getChildren()[2].position.y=0),this.onSecondaryButtonStateChangedObservable.notifyObservers(i);return}}}wo.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";wo.MODEL_FILENAME="wand.babylon";Cn._ControllerFactories.push({canCreate:a=>a.id.toLowerCase().indexOf("openvr")!==-1,create:a=>new wo(a)});class hE{constructor(){this.buttonMeshes={},this.axisMeshes={}}}class mr extends Ya{constructor(e){super(e),this._mapping={buttons:["thumbstick","trigger","grip","menu","trackpad"],buttonMeshNames:{trigger:"SELECT",menu:"MENU",grip:"GRASP",thumbstick:"THUMBSTICK_PRESS",trackpad:"TOUCHPAD_PRESS"},buttonObservableNames:{trigger:"onTriggerStateChangedObservable",menu:"onSecondaryButtonStateChangedObservable",grip:"onMainButtonStateChangedObservable",thumbstick:"onPadStateChangedObservable",trackpad:"onTrackpadChangedObservable"},axisMeshNames:["THUMBSTICK_X","THUMBSTICK_Y","TOUCHPAD_TOUCH_X","TOUCHPAD_TOUCH_Y"],pointingPoseMeshName:Ml.POINTING_POSE},this.onTrackpadChangedObservable=new X,this.onTrackpadValuesChangedObservable=new X,this.trackpad={x:0,y:0},this.controllerType=jr.WINDOWS,this._loadedMeshInfo=null}get onTriggerButtonStateChangedObservable(){return this.onTriggerStateChangedObservable}get onMenuButtonStateChangedObservable(){return this.onSecondaryButtonStateChangedObservable}get onGripButtonStateChangedObservable(){return this.onMainButtonStateChangedObservable}get onThumbstickButtonStateChangedObservable(){return this.onPadStateChangedObservable}get onTouchpadButtonStateChangedObservable(){return this.onTrackpadChangedObservable}get onTouchpadValuesChangedObservable(){return this.onTrackpadValuesChangedObservable}_updateTrackpad(){this.browserGamepad.axes&&(this.browserGamepad.axes[2]!=this.trackpad.x||this.browserGamepad.axes[3]!=this.trackpad.y)&&(this.trackpad.x=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_X")],this.trackpad.y=this.browserGamepad.axes[this._mapping.axisMeshNames.indexOf("TOUCHPAD_TOUCH_Y")],this.onTrackpadValuesChangedObservable.notifyObservers(this.trackpad))}update(){if(super.update(),this.browserGamepad.axes&&(this._updateTrackpad(),this._loadedMeshInfo))for(let e=0;e<this._mapping.axisMeshNames.length;e++)this._lerpAxisTransform(e,this.browserGamepad.axes[e])}_handleButtonChange(e,t){const i=this._mapping.buttons[e];if(!i)return;this._updateTrackpad();const s=this[this._mapping.buttonObservableNames[i]];s&&s.notifyObservers(t),this._lerpButtonTransform(i,t.value)}_lerpButtonTransform(e,t){if(!this._loadedMeshInfo)return;const i=this._loadedMeshInfo.buttonMeshes[e];!i||!i.unpressed.rotationQuaternion||!i.pressed.rotationQuaternion||!i.value.rotationQuaternion||(Q.SlerpToRef(i.unpressed.rotationQuaternion,i.pressed.rotationQuaternion,t,i.value.rotationQuaternion),g.LerpToRef(i.unpressed.position,i.pressed.position,t,i.value.position))}_lerpAxisTransform(e,t){if(!this._loadedMeshInfo)return;const i=this._loadedMeshInfo.axisMeshes[e];if(!i||!i.min.rotationQuaternion||!i.max.rotationQuaternion||!i.value.rotationQuaternion)return;const s=t*.5+.5;Q.SlerpToRef(i.min.rotationQuaternion,i.max.rotationQuaternion,s,i.value.rotationQuaternion),g.LerpToRef(i.min.position,i.max.position,s,i.value.position)}initControllerMesh(e,t,i=!1){let s,r;if(Be.IsPluginForExtensionAvailable(".glb")){let n="default";if(this.id&&!i){const o=this.id.match(mr.GAMEPAD_ID_PATTERN);n=o&&o[0]||n}this.hand==="left"?r=mr.MODEL_LEFT_FILENAME:r=mr.MODEL_RIGHT_FILENAME,s=mr.MODEL_BASE_URL+n+"/"}else B.Warn("You need to reference GLTF loader to load Windows Motion Controllers model. Falling back to generic models"),s=aa.MODEL_BASE_URL,r=aa.MODEL_FILENAME;Be.ImportMesh("",s,r,e,n=>{this._loadedMeshInfo=this._processModel(e,n),this._loadedMeshInfo&&(this._defaultModel=this._loadedMeshInfo.rootNode,this.attachToMesh(this._defaultModel),t&&t(this._defaultModel))},null,(n,o)=>{B.Log(o),B.Warn("Failed to retrieve controller model from the remote server: "+s+r),i||this.initControllerMesh(n,t,!0)})}_processModel(e,t){let i=null;const s=new V(this.id+" "+this.hand,e);let r=null;for(let n=0;n<t.length;n++){const o=t[n];if(!o.parent){o.isPickable=!1,r=o;break}}return r?(r.setParent(s),i=this._createMeshInfo(s)):B.Warn("Could not find root node in model file."),i}_createMeshInfo(e){const t=new hE;let i;for(t.rootNode=e,t.buttonMeshes={},t.axisMeshes={},i=0;i<this._mapping.buttons.length;i++){const n=this._mapping.buttonMeshNames[this._mapping.buttons[i]];if(!n){B.Log("Skipping unknown button at index: "+i+" with mapped name: "+this._mapping.buttons[i]);continue}const o=s(e,n);if(!o){B.Warn("Missing button mesh with name: "+n);continue}const l={index:i,value:r(o,"VALUE"),pressed:r(o,"PRESSED"),unpressed:r(o,"UNPRESSED")};l.value&&l.pressed&&l.unpressed?t.buttonMeshes[this._mapping.buttons[i]]=l:B.Warn("Missing button submesh under mesh with name: "+n+"(VALUE: "+!!l.value+", PRESSED: "+!!l.pressed+", UNPRESSED:"+!!l.unpressed+")")}for(i=0;i<this._mapping.axisMeshNames.length;i++){const n=this._mapping.axisMeshNames[i];if(!n){B.Log("Skipping unknown axis at index: "+i);continue}const o=s(e,n);if(!o){B.Warn("Missing axis mesh with name: "+n);continue}const l={index:i,value:r(o,"VALUE"),min:r(o,"MIN"),max:r(o,"MAX")};l.value&&l.min&&l.max?t.axisMeshes[i]=l:B.Warn("Missing axis submesh under mesh with name: "+n+"(VALUE: "+!!l.value+", MIN: "+!!l.min+", MAX:"+!!l.max+")")}return t.pointingPoseNode=s(e,this._mapping.pointingPoseMeshName),t.pointingPoseNode?this._pointingPoseNode=t.pointingPoseNode:B.Warn("Missing pointing pose mesh with name: "+this._mapping.pointingPoseMeshName),t;function s(n,o){return n.getChildren(l=>l.name===o,!1)[0]}function r(n,o){return n.getChildren(l=>l.name==o,!0)[0]}}getForwardRay(e=100){if(!(this._loadedMeshInfo&&this._loadedMeshInfo.pointingPoseNode))return super.getForwardRay(e);const t=this._loadedMeshInfo.pointingPoseNode.getWorldMatrix(),i=t.getTranslation(),s=new g(0,0,-1),r=g.TransformNormal(s,t),n=g.Normalize(r);return new $e(i,n,e)}dispose(){super.dispose(),this.onTrackpadChangedObservable.clear(),this.onTrackpadValuesChangedObservable.clear()}}mr.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";mr.MODEL_LEFT_FILENAME="left.glb";mr.MODEL_RIGHT_FILENAME="right.glb";mr.GAMEPAD_ID_PREFIX="Spatial Controller (Spatial Interaction Source) ";mr.GAMEPAD_ID_PATTERN=/([0-9a-zA-Z]+-[0-9a-zA-Z]+)$/;Cn._ControllerFactories.push({canCreate:a=>a.id.indexOf(mr.GAMEPAD_ID_PREFIX)===0,create:a=>new mr(a)});function Tm(a){const e=[];e[0]={vertex:[[0,0,1.732051],[1.632993,0,-.5773503],[-.8164966,1.414214,-.5773503],[-.8164966,-1.414214,-.5773503]],face:[[0,1,2],[0,2,3],[0,3,1],[1,3,2]]},e[1]={vertex:[[0,0,1.414214],[1.414214,0,0],[0,1.414214,0],[-1.414214,0,0],[0,-1.414214,0],[0,0,-1.414214]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,1],[1,4,5],[1,5,2],[2,5,3],[3,5,4]]},e[2]={vertex:[[0,0,1.070466],[.7136442,0,.7978784],[-.3568221,.618034,.7978784],[-.3568221,-.618034,.7978784],[.7978784,.618034,.3568221],[.7978784,-.618034,.3568221],[-.9341724,.381966,.3568221],[.1362939,1,.3568221],[.1362939,-1,.3568221],[-.9341724,-.381966,.3568221],[.9341724,.381966,-.3568221],[.9341724,-.381966,-.3568221],[-.7978784,.618034,-.3568221],[-.1362939,1,-.3568221],[-.1362939,-1,-.3568221],[-.7978784,-.618034,-.3568221],[.3568221,.618034,-.7978784],[.3568221,-.618034,-.7978784],[-.7136442,0,-.7978784],[0,0,-1.070466]],face:[[0,1,4,7,2],[0,2,6,9,3],[0,3,8,5,1],[1,5,11,10,4],[2,7,13,12,6],[3,9,15,14,8],[4,10,16,13,7],[5,8,14,17,11],[6,12,18,15,9],[10,11,17,19,16],[12,13,16,19,18],[14,15,18,19,17]]},e[3]={vertex:[[0,0,1.175571],[1.051462,0,.5257311],[.3249197,1,.5257311],[-.8506508,.618034,.5257311],[-.8506508,-.618034,.5257311],[.3249197,-1,.5257311],[.8506508,.618034,-.5257311],[.8506508,-.618034,-.5257311],[-.3249197,1,-.5257311],[-1.051462,0,-.5257311],[-.3249197,-1,-.5257311],[0,0,-1.175571]],face:[[0,1,2],[0,2,3],[0,3,4],[0,4,5],[0,5,1],[1,5,7],[1,7,6],[1,6,2],[2,6,8],[2,8,3],[3,8,9],[3,9,4],[4,9,10],[4,10,5],[5,10,7],[6,7,11],[6,11,8],[7,10,11],[8,11,9],[9,11,10]]},e[4]={vertex:[[0,0,1.070722],[.7148135,0,.7971752],[-.104682,.7071068,.7971752],[-.6841528,.2071068,.7971752],[-.104682,-.7071068,.7971752],[.6101315,.7071068,.5236279],[1.04156,.2071068,.1367736],[.6101315,-.7071068,.5236279],[-.3574067,1,.1367736],[-.7888348,-.5,.5236279],[-.9368776,.5,.1367736],[-.3574067,-1,.1367736],[.3574067,1,-.1367736],[.9368776,-.5,-.1367736],[.7888348,.5,-.5236279],[.3574067,-1,-.1367736],[-.6101315,.7071068,-.5236279],[-1.04156,-.2071068,-.1367736],[-.6101315,-.7071068,-.5236279],[.104682,.7071068,-.7971752],[.6841528,-.2071068,-.7971752],[.104682,-.7071068,-.7971752],[-.7148135,0,-.7971752],[0,0,-1.070722]],face:[[0,2,3],[1,6,5],[4,9,11],[7,15,13],[8,16,10],[12,14,19],[17,22,18],[20,21,23],[0,1,5,2],[0,3,9,4],[0,4,7,1],[1,7,13,6],[2,5,12,8],[2,8,10,3],[3,10,17,9],[4,11,15,7],[5,6,14,12],[6,13,20,14],[8,12,19,16],[9,17,18,11],[10,16,22,17],[11,18,21,15],[13,15,21,20],[14,20,23,19],[16,19,23,22],[18,22,23,21]]},e[5]={vertex:[[0,0,1.322876],[1.309307,0,.1889822],[-.9819805,.8660254,.1889822],[.1636634,-1.299038,.1889822],[.3273268,.8660254,-.9449112],[-.8183171,-.4330127,-.9449112]],face:[[0,3,1],[2,4,5],[0,1,4,2],[0,2,5,3],[1,3,5,4]]},e[6]={vertex:[[0,0,1.159953],[1.013464,0,.5642542],[-.3501431,.9510565,.5642542],[-.7715208,-.6571639,.5642542],[.6633206,.9510565,-.03144481],[.8682979,-.6571639,-.3996071],[-1.121664,.2938926,-.03144481],[-.2348831,-1.063314,-.3996071],[.5181548,.2938926,-.9953061],[-.5850262,-.112257,-.9953061]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,9,7],[5,7,9,8],[0,3,7,5,1],[2,4,8,9,6]]},e[7]={vertex:[[0,0,1.118034],[.8944272,0,.6708204],[-.2236068,.8660254,.6708204],[-.7826238,-.4330127,.6708204],[.6708204,.8660254,.2236068],[1.006231,-.4330127,-.2236068],[-1.006231,.4330127,.2236068],[-.6708204,-.8660254,-.2236068],[.7826238,.4330127,-.6708204],[.2236068,-.8660254,-.6708204],[-.8944272,0,-.6708204],[0,0,-1.118034]],face:[[0,1,4,2],[0,2,6,3],[1,5,8,4],[3,6,10,7],[5,9,11,8],[7,10,11,9],[0,3,7,9,5,1],[2,4,8,11,10,6]]},e[8]={vertex:[[-.729665,.670121,.319155],[-.655235,-.29213,-.754096],[-.093922,-.607123,.537818],[.702196,.595691,.485187],[.776626,-.36656,-.588064]],face:[[1,4,2],[0,1,2],[3,0,2],[4,3,2],[4,1,0,3]]},e[9]={vertex:[[-.868849,-.100041,.61257],[-.329458,.976099,.28078],[-.26629,-.013796,-.477654],[-.13392,-1.034115,.229829],[.738834,.707117,-.307018],[.859683,-.535264,-.338508]],face:[[3,0,2],[5,3,2],[4,5,2],[1,4,2],[0,1,2],[0,3,5,4,1]]},e[10]={vertex:[[-.610389,.243975,.531213],[-.187812,-.48795,-.664016],[-.187812,.9759,-.664016],[.187812,-.9759,.664016],[.798201,.243975,.132803]],face:[[1,3,0],[3,4,0],[3,1,4],[0,2,1],[0,4,2],[2,4,1]]},e[11]={vertex:[[-1.028778,.392027,-.048786],[-.640503,-.646161,.621837],[-.125162,-.395663,-.540059],[.004683,.888447,-.651988],[.125161,.395663,.540059],[.632925,-.791376,.433102],[1.031672,.157063,-.354165]],face:[[3,2,0],[2,1,0],[2,5,1],[0,4,3],[0,1,4],[4,1,5],[2,3,6],[3,4,6],[5,2,6],[4,5,6]]},e[12]={vertex:[[-.669867,.334933,-.529576],[-.669867,.334933,.529577],[-.4043,1.212901,0],[-.334933,-.669867,-.529576],[-.334933,-.669867,.529577],[.334933,.669867,-.529576],[.334933,.669867,.529577],[.4043,-1.212901,0],[.669867,-.334933,-.529576],[.669867,-.334933,.529577]],face:[[8,9,7],[6,5,2],[3,8,7],[5,0,2],[4,3,7],[0,1,2],[9,4,7],[1,6,2],[9,8,5,6],[8,3,0,5],[3,4,1,0],[4,9,6,1]]},e[13]={vertex:[[-.931836,.219976,-.264632],[-.636706,.318353,.692816],[-.613483,-.735083,-.264632],[-.326545,.979634,0],[-.318353,-.636706,.692816],[-.159176,.477529,-.856368],[.159176,-.477529,-.856368],[.318353,.636706,.692816],[.326545,-.979634,0],[.613482,.735082,-.264632],[.636706,-.318353,.692816],[.931835,-.219977,-.264632]],face:[[11,10,8],[7,9,3],[6,11,8],[9,5,3],[2,6,8],[5,0,3],[4,2,8],[0,1,3],[10,4,8],[1,7,3],[10,11,9,7],[11,6,5,9],[6,2,0,5],[2,4,1,0],[4,10,7,1]]},e[14]={vertex:[[-.93465,.300459,-.271185],[-.838689,-.260219,-.516017],[-.711319,.717591,.128359],[-.710334,-.156922,.080946],[-.599799,.556003,-.725148],[-.503838,-.004675,-.969981],[-.487004,.26021,.48049],[-.460089,-.750282,-.512622],[-.376468,.973135,-.325605],[-.331735,-.646985,.084342],[-.254001,.831847,.530001],[-.125239,-.494738,-.966586],[.029622,.027949,.730817],[.056536,-.982543,-.262295],[.08085,1.087391,.076037],[.125583,-.532729,.485984],[.262625,.599586,.780328],[.391387,-.726999,-.716259],[.513854,-.868287,.139347],[.597475,.85513,.326364],[.641224,.109523,.783723],[.737185,-.451155,.538891],[.848705,-.612742,-.314616],[.976075,.365067,.32976],[1.072036,-.19561,.084927]],face:[[15,18,21],[12,20,16],[6,10,2],[3,0,1],[9,7,13],[2,8,4,0],[0,4,5,1],[1,5,11,7],[7,11,17,13],[13,17,22,18],[18,22,24,21],[21,24,23,20],[20,23,19,16],[16,19,14,10],[10,14,8,2],[15,9,13,18],[12,15,21,20],[6,12,16,10],[3,6,2,0],[9,3,1,7],[9,15,12,6,3],[22,17,11,5,4,8,14,19,23,24]]};const t=a.type&&(a.type<0||a.type>=e.length)?0:a.type||0,i=a.size,s=a.sizeX||i||1,r=a.sizeY||i||1,n=a.sizeZ||i||1,o=a.custom||e[t],l=o.face.length,h=a.faceUV||new Array(l),c=a.faceColors,u=a.flat===void 0?!0:a.flat,d=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,f=new Array,p=new Array,_=new Array,m=new Array,v=new Array;let x=0,b=0;const S=new Array;let C=0,E=0,A,M,D,P,O,N;if(u)for(E=0;E<l;E++)c&&c[E]===void 0&&(c[E]=new J(1,1,1,1)),h&&h[E]===void 0&&(h[E]=new Ge(0,0,1,1));if(u)for(E=0;E<l;E++){const W=o.face[E].length;for(D=2*Math.PI/W,P=.5*Math.tan(D/2),O=.5,C=0;C<W;C++)f.push(o.vertex[o.face[E][C]][0]*s,o.vertex[o.face[E][C]][1]*r,o.vertex[o.face[E][C]][2]*n),S.push(x),x++,A=h[E].x+(h[E].z-h[E].x)*(.5+P),M=h[E].y+(h[E].w-h[E].y)*(O-.5),m.push(A,nt.UseOpenGLOrientationForUV?1-M:M),N=P*Math.cos(D)-O*Math.sin(D),O=P*Math.sin(D)+O*Math.cos(D),P=N,c&&v.push(c[E].r,c[E].g,c[E].b,c[E].a);for(C=0;C<W-2;C++)p.push(S[0+b],S[C+2+b],S[C+1+b]);b+=W}else{for(C=0;C<o.vertex.length;C++)f.push(o.vertex[C][0]*s,o.vertex[C][1]*r,o.vertex[C][2]*n),m.push(0,nt.UseOpenGLOrientationForUV?1:0);for(E=0;E<l;E++)for(C=0;C<o.face[E].length-2;C++)p.push(o.face[E][0],o.face[E][C+2],o.face[E][C+1])}de.ComputeNormals(f,p,_),de._ComputeSides(d,f,p,_,m,a.frontUVs,a.backUVs);const $=new de;return $.positions=f,$.indices=p,$.normals=_,$.uvs=m,c&&u&&($.colors=v),$}function t0(a,e={},t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Tm(e).applyToMesh(i,e.updatable),i}de.CreatePolyhedron=Tm;V.CreatePolyhedron=(a,e,t)=>t0(a,e,t);lt.AddNodeConstructor("Light_Type_1",(a,e)=>()=>new Jr(a,g.Zero(),e));class Jr extends za{constructor(e,t,i){super(e,i),this._shadowFrustumSize=0,this._shadowOrthoScale=.1,this.autoUpdateExtends=!0,this.autoCalcShadowZBounds=!1,this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE,this.position=t.scale(-1),this.direction=t}get shadowFrustumSize(){return this._shadowFrustumSize}set shadowFrustumSize(e){this._shadowFrustumSize=e,this.forceProjectionMatrixCompute()}get shadowOrthoScale(){return this._shadowOrthoScale}set shadowOrthoScale(e){this._shadowOrthoScale=e,this.forceProjectionMatrixCompute()}get orthoLeft(){return this._orthoLeft}set orthoLeft(e){this._orthoLeft=e}get orthoRight(){return this._orthoRight}set orthoRight(e){this._orthoRight=e}get orthoTop(){return this._orthoTop}set orthoTop(e){this._orthoTop=e}get orthoBottom(){return this._orthoBottom}set orthoBottom(e){this._orthoBottom=e}getClassName(){return"DirectionalLight"}getTypeID(){return je.LIGHTTYPEID_DIRECTIONALLIGHT}_setDefaultShadowProjectionMatrix(e,t,i){this.shadowFrustumSize>0?this._setDefaultFixedFrustumShadowProjectionMatrix(e):this._setDefaultAutoExtendShadowProjectionMatrix(e,t,i)}_setDefaultFixedFrustumShadowProjectionMatrix(e){const t=this.getScene().activeCamera;!t||L.OrthoLHToRef(this.shadowFrustumSize,this.shadowFrustumSize,this.shadowMinZ!==void 0?this.shadowMinZ:t.minZ,this.shadowMaxZ!==void 0?this.shadowMaxZ:t.maxZ,e,this.getScene().getEngine().isNDCHalfZRange)}_setDefaultAutoExtendShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;if(this.autoUpdateExtends||this._orthoLeft===Number.MAX_VALUE){const c=g.Zero();this._orthoLeft=Number.MAX_VALUE,this._orthoRight=Number.MIN_VALUE,this._orthoTop=Number.MIN_VALUE,this._orthoBottom=Number.MAX_VALUE;let u=Number.MAX_VALUE,d=Number.MIN_VALUE;for(let f=0;f<i.length;f++){const p=i[f];if(!p)continue;const m=p.getBoundingInfo().boundingBox;for(let v=0;v<m.vectorsWorld.length;v++)g.TransformCoordinatesToRef(m.vectorsWorld[v],t,c),c.x<this._orthoLeft&&(this._orthoLeft=c.x),c.y<this._orthoBottom&&(this._orthoBottom=c.y),c.x>this._orthoRight&&(this._orthoRight=c.x),c.y>this._orthoTop&&(this._orthoTop=c.y),this.autoCalcShadowZBounds&&(c.z<u&&(u=c.z),c.z>d&&(d=c.z))}this.autoCalcShadowZBounds&&(this._shadowMinZ=u,this._shadowMaxZ=d)}const r=this._orthoRight-this._orthoLeft,n=this._orthoTop-this._orthoBottom,o=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,l=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,h=this.getScene().getEngine().useReverseDepthBuffer;L.OrthoOffCenterLHToRef(this._orthoLeft-r*this.shadowOrthoScale,this._orthoRight+r*this.shadowOrthoScale,this._orthoBottom-n*this.shadowOrthoScale,this._orthoTop+n*this.shadowOrthoScale,h?l:o,h?o:l,e,this.getScene().getEngine().isNDCHalfZRange)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}transferToEffect(e,t){return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z,1,t),this):(this._uniformBuffer.updateFloat4("vLightData",this.direction.x,this.direction.y,this.direction.z,1,t),this)}transferToNodeMaterialEffect(e,t){return this.computeTransformedInformation()?(e.setFloat3(t,this.transformedDirection.x,this.transformedDirection.y,this.transformedDirection.z),this):(e.setFloat3(t,this.direction.x,this.direction.y,this.direction.z),this)}getDepthMinZ(e){const t=this._scene.getEngine();return!t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}getDepthMaxZ(e){const t=this._scene.getEngine();return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:1}prepareLightSpecificDefines(e,t){e["DIRLIGHT"+t]=!0}}T([R()],Jr.prototype,"shadowFrustumSize",null);T([R()],Jr.prototype,"shadowOrthoScale",null);T([R()],Jr.prototype,"autoUpdateExtends",void 0);T([R()],Jr.prototype,"autoCalcShadowZBounds",void 0);T([R("orthoLeft")],Jr.prototype,"_orthoLeft",void 0);T([R("orthoRight")],Jr.prototype,"_orthoRight",void 0);T([R("orthoTop")],Jr.prototype,"_orthoTop",void 0);T([R("orthoBottom")],Jr.prototype,"_orthoBottom",void 0);function bm(a){const e=new Array,t=new Array,i=new Array,s=new Array,r=a.radius||.5,n=a.tessellation||64,o=a.arc&&(a.arc<=0||a.arc>1)?1:a.arc||1,l=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE;e.push(0,0,0),s.push(.5,.5);const h=Math.PI*2*o,c=o===1?h/n:h/(n-1);let u=0;for(let p=0;p<n;p++){const _=Math.cos(u),m=Math.sin(u),v=(_+1)/2,x=(1-m)/2;e.push(r*_,r*m,0),s.push(v,nt.UseOpenGLOrientationForUV?1-x:x),u+=c}o===1&&(e.push(e[3],e[4],e[5]),s.push(s[2],nt.UseOpenGLOrientationForUV?1-s[3]:s[3]));const d=e.length/3;for(let p=1;p<d-1;p++)t.push(p+1,0,p);de.ComputeNormals(e,t,i),de._ComputeSides(l,e,t,i,s,a.frontUVs,a.backUVs);const f=new de;return f.indices=t,f.positions=e,f.normals=i,f.uvs=s,f}function i0(a,e={},t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,bm(e).applyToMesh(i,e.updatable),i}de.CreateDisc=bm;V.CreateDisc=(a,e,t,i=null,s,r)=>i0(a,{radius:e,tessellation:t,sideOrientation:r,updatable:s},i);function cE(a,e={},t){e.diameter||(e.diameter=1),e.segments||(e.segments=16);const i=qr("",{slice:.5,diameter:e.diameter,segments:e.segments},t),s=i0("",{radius:e.diameter/2,tessellation:e.segments*3+(4-e.segments)},t);s.rotation.x=-Math.PI/2,s.parent=i;const r=V.MergeMeshes([s,i],!0);return r.name=a,r}V.CreateHemisphere=(a,e,t,i)=>cE(a,{segments:e,diameter:t},i);lt.AddNodeConstructor("Light_Type_2",(a,e)=>()=>new gr(a,g.Zero(),g.Zero(),0,0,e));class gr extends za{constructor(e,t,i,s,r,n){super(e,n),this._innerAngle=0,this._projectionTextureMatrix=L.Zero(),this._projectionTextureLightNear=1e-6,this._projectionTextureLightFar=1e3,this._projectionTextureUpDirection=g.Up(),this._projectionTextureViewLightDirty=!0,this._projectionTextureProjectionLightDirty=!0,this._projectionTextureDirty=!0,this._projectionTextureViewTargetVector=g.Zero(),this._projectionTextureViewLightMatrix=L.Zero(),this._projectionTextureProjectionLightMatrix=L.Zero(),this._projectionTextureScalingMatrix=L.FromValues(.5,0,0,0,0,.5,0,0,0,0,.5,0,.5,.5,.5,1),this.position=t,this.direction=i,this.angle=s,this.exponent=r}get angle(){return this._angle}set angle(e){this._angle=e,this._cosHalfAngle=Math.cos(e*.5),this._projectionTextureProjectionLightDirty=!0,this.forceProjectionMatrixCompute(),this._computeAngleValues()}get innerAngle(){return this._innerAngle}set innerAngle(e){this._innerAngle=e,this._computeAngleValues()}get shadowAngleScale(){return this._shadowAngleScale}set shadowAngleScale(e){this._shadowAngleScale=e,this.forceProjectionMatrixCompute()}get projectionTextureMatrix(){return this._projectionTextureMatrix}get projectionTextureLightNear(){return this._projectionTextureLightNear}set projectionTextureLightNear(e){this._projectionTextureLightNear=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureLightFar(){return this._projectionTextureLightFar}set projectionTextureLightFar(e){this._projectionTextureLightFar=e,this._projectionTextureProjectionLightDirty=!0}get projectionTextureUpDirection(){return this._projectionTextureUpDirection}set projectionTextureUpDirection(e){this._projectionTextureUpDirection=e,this._projectionTextureProjectionLightDirty=!0}get projectionTexture(){return this._projectionTexture}set projectionTexture(e){this._projectionTexture!==e&&(this._projectionTexture=e,this._projectionTextureDirty=!0,this._projectionTexture&&!this._projectionTexture.isReady()&&(gr._IsProceduralTexture(this._projectionTexture)?this._projectionTexture.getEffect().executeWhenCompiled(()=>{this._markMeshesAsLightDirty()}):gr._IsTexture(this._projectionTexture)&&this._projectionTexture.onLoadObservable.addOnce(()=>{this._markMeshesAsLightDirty()})))}static _IsProceduralTexture(e){return e.onGeneratedObservable!==void 0}static _IsTexture(e){return e.onLoadObservable!==void 0}get projectionTextureProjectionLightMatrix(){return this._projectionTextureProjectionLightMatrix}set projectionTextureProjectionLightMatrix(e){this._projectionTextureProjectionLightMatrix=e,this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0}getClassName(){return"SpotLight"}getTypeID(){return je.LIGHTTYPEID_SPOTLIGHT}_setDirection(e){super._setDirection(e),this._projectionTextureViewLightDirty=!0}_setPosition(e){super._setPosition(e),this._projectionTextureViewLightDirty=!0}_setDefaultShadowProjectionMatrix(e,t,i){const s=this.getScene().activeCamera;if(!s)return;this._shadowAngleScale=this._shadowAngleScale||1;const r=this._shadowAngleScale*this._angle,n=this.shadowMinZ!==void 0?this.shadowMinZ:s.minZ,o=this.shadowMaxZ!==void 0?this.shadowMaxZ:s.maxZ,l=this.getScene().getEngine().useReverseDepthBuffer;L.PerspectiveFovLHToRef(r,1,l?o:n,l?n:o,e,!0,this._scene.getEngine().isNDCHalfZRange,void 0,l)}_computeProjectionTextureViewLightMatrix(){this._projectionTextureViewLightDirty=!1,this._projectionTextureDirty=!0,this.position.addToRef(this.direction,this._projectionTextureViewTargetVector),L.LookAtLHToRef(this.position,this._projectionTextureViewTargetVector,this._projectionTextureUpDirection,this._projectionTextureViewLightMatrix)}_computeProjectionTextureProjectionLightMatrix(){this._projectionTextureProjectionLightDirty=!1,this._projectionTextureDirty=!0;const e=this.projectionTextureLightFar,t=this.projectionTextureLightNear,i=e/(e-t),s=-i*t,r=1/Math.tan(this._angle/2),n=1;L.FromValuesToRef(r/n,0,0,0,0,r,0,0,0,0,i,1,0,0,s,0,this._projectionTextureProjectionLightMatrix)}_computeProjectionTextureMatrix(){if(this._projectionTextureDirty=!1,this._projectionTextureViewLightMatrix.multiplyToRef(this._projectionTextureProjectionLightMatrix,this._projectionTextureMatrix),this._projectionTexture instanceof H){const e=this._projectionTexture.uScale/2,t=this._projectionTexture.vScale/2;L.FromValuesToRef(e,0,0,0,0,t,0,0,0,0,.5,0,.5,.5,.5,1,this._projectionTextureScalingMatrix)}this._projectionTextureMatrix.multiplyToRef(this._projectionTextureScalingMatrix,this._projectionTextureMatrix)}_buildUniformLayout(){this._uniformBuffer.addUniform("vLightData",4),this._uniformBuffer.addUniform("vLightDiffuse",4),this._uniformBuffer.addUniform("vLightSpecular",4),this._uniformBuffer.addUniform("vLightDirection",3),this._uniformBuffer.addUniform("vLightFalloff",4),this._uniformBuffer.addUniform("shadowsInfo",3),this._uniformBuffer.addUniform("depthValues",2),this._uniformBuffer.create()}_computeAngleValues(){this._lightAngleScale=1/Math.max(.001,Math.cos(this._innerAngle*.5)-this._cosHalfAngle),this._lightAngleOffset=-this._cosHalfAngle*this._lightAngleScale}transferTexturesToEffect(e,t){return this.projectionTexture&&this.projectionTexture.isReady()&&(this._projectionTextureViewLightDirty&&this._computeProjectionTextureViewLightMatrix(),this._projectionTextureProjectionLightDirty&&this._computeProjectionTextureProjectionLightMatrix(),this._projectionTextureDirty&&this._computeProjectionTextureMatrix(),e.setMatrix("textureProjectionMatrix"+t,this._projectionTextureMatrix),e.setTexture("projectionLightSampler"+t,this.projectionTexture)),this}transferToEffect(e,t){let i;return this.computeTransformedInformation()?(this._uniformBuffer.updateFloat4("vLightData",this.transformedPosition.x,this.transformedPosition.y,this.transformedPosition.z,this.exponent,t),i=g.Normalize(this.transformedDirection)):(this._uniformBuffer.updateFloat4("vLightData",this.position.x,this.position.y,this.position.z,this.exponent,t),i=g.Normalize(this.direction)),this._uniformBuffer.updateFloat4("vLightDirection",i.x,i.y,i.z,this._cosHalfAngle,t),this._uniformBuffer.updateFloat4("vLightFalloff",this.range,this._inverseSquaredRange,this._lightAngleScale,this._lightAngleOffset,t),this}transferToNodeMaterialEffect(e,t){let i;return this.computeTransformedInformation()?i=g.Normalize(this.transformedDirection):i=g.Normalize(this.direction),this.getScene().useRightHandedSystem?e.setFloat3(t,-i.x,-i.y,-i.z):e.setFloat3(t,i.x,i.y,i.z),this}dispose(){super.dispose(),this._projectionTexture&&this._projectionTexture.dispose()}getDepthMinZ(e){const t=this._scene.getEngine(),i=this.shadowMinZ!==void 0?this.shadowMinZ:e.minZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?i:this._scene.getEngine().isNDCHalfZRange?0:i}getDepthMaxZ(e){const t=this._scene.getEngine(),i=this.shadowMaxZ!==void 0?this.shadowMaxZ:e.maxZ;return t.useReverseDepthBuffer&&t.isNDCHalfZRange?0:i}prepareLightSpecificDefines(e,t){e["SPOTLIGHT"+t]=!0,e["PROJECTEDLIGHTTEXTURE"+t]=!!(this.projectionTexture&&this.projectionTexture.isReady())}}T([R()],gr.prototype,"angle",null);T([R()],gr.prototype,"innerAngle",null);T([R()],gr.prototype,"shadowAngleScale",null);T([R()],gr.prototype,"exponent",void 0);T([R()],gr.prototype,"projectionTextureLightNear",null);T([R()],gr.prototype,"projectionTextureLightFar",null);T([R()],gr.prototype,"projectionTextureUpDirection",null);T([Qe("projectedLightTexture")],gr.prototype,"_projectionTexture",void 0);const uE="kernelBlurVaryingDeclaration",dE="varying vec2 sampleCoord{X};";Y.IncludesShadersStore[uE]=dE;const fE="packingFunctions",pE=`vec4 pack(float depth)
{
const vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);
const vec4 bit_mask=vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);
vec4 res=fract(depth*bit_shift);
res-=res.xxyz*bit_mask;
return res;
}
float unpack(vec4 color)
{
const vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);
return dot(color,bit_shift);
}`;Y.IncludesShadersStore[fE]=pE;const _E="kernelBlurFragment",mE=`#ifdef DOF
factor=sampleCoC(sampleCoord{X}); 
computedWeight=KERNEL_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCoord{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCoord{X})*computedWeight;
#endif
`;Y.IncludesShadersStore[_E]=mE;const gE="kernelBlurFragment2",vE=`#ifdef DOF
factor=sampleCoC(sampleCenter+delta*KERNEL_DEP_OFFSET{X});
computedWeight=KERNEL_DEP_WEIGHT{X}*factor;
sumOfWeights+=computedWeight;
#else
computedWeight=KERNEL_DEP_WEIGHT{X};
#endif
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X}))*computedWeight;
#else
blend+=texture2D(textureSampler,sampleCenter+delta*KERNEL_DEP_OFFSET{X})*computedWeight;
#endif
`;Y.IncludesShadersStore[gE]=vE;const xE="kernelBlurPixelShader",TE=`uniform sampler2D textureSampler;
uniform vec2 delta;
varying vec2 sampleCenter;
#ifdef DOF
uniform sampler2D circleOfConfusionSampler;
uniform vec2 cameraMinMaxZ;
float sampleDistance(in vec2 offset) {
float depth=texture2D(circleOfConfusionSampler,offset).g; 
return cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth; 
}
float sampleCoC(in vec2 offset) {
float coc=texture2D(circleOfConfusionSampler,offset).r; 
return coc; 
}
#endif
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
#ifdef PACKEDFLOAT
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float computedWeight=0.0;
#ifdef PACKEDFLOAT 
float blend=0.;
#else
vec4 blend=vec4(0.);
#endif
#ifdef DOF
float sumOfWeights=CENTER_WEIGHT; 
float factor=0.0;
#ifdef PACKEDFLOAT
blend+=unpack(texture2D(textureSampler,sampleCenter))*CENTER_WEIGHT;
#else
blend+=texture2D(textureSampler,sampleCenter)*CENTER_WEIGHT;
#endif
#endif
#include<kernelBlurFragment>[0..varyingCount]
#include<kernelBlurFragment2>[0..depCount]
#ifdef PACKEDFLOAT
gl_FragColor=pack(blend);
#else
gl_FragColor=blend;
#endif
#ifdef DOF
gl_FragColor/=sumOfWeights;
#endif
}`;Y.ShadersStore[xE]=TE;const bE="kernelBlurVertex",SE="sampleCoord{X}=sampleCenter+delta*KERNEL_OFFSET{X};";Y.IncludesShadersStore[bE]=SE;const EE="kernelBlurVertexShader",CE=`attribute vec2 position;
uniform vec2 delta;
varying vec2 sampleCenter;
#include<kernelBlurVaryingDeclaration>[0..varyingCount]
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
sampleCenter=(position*madd+madd);
#include<kernelBlurVertex>[0..varyingCount]
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[EE]=CE;class Ei extends Fe{constructor(e,t,i,s,r,n=H.BILINEAR_SAMPLINGMODE,o,l,h=0,c="",u=!1){super(e,"kernelBlur",["delta","direction","cameraMinMaxZ"],["circleOfConfusionSampler"],s,r,n,o,l,null,h,"kernelBlur",{varyingCount:0,depCount:0},!0),this._blockCompilation=u,this._packedFloat=!1,this._staticDefines="",this._staticDefines=c,this.direction=t,this.onApplyObservable.add(d=>{this._outputTexture?d.setFloat2("delta",1/this._outputTexture.width*this.direction.x,1/this._outputTexture.height*this.direction.y):d.setFloat2("delta",1/this.width*this.direction.x,1/this.height*this.direction.y)}),this.kernel=i}set kernel(e){this._idealKernel!==e&&(e=Math.max(e,1),this._idealKernel=e,this._kernel=this._nearestBestKernel(e),this._blockCompilation||this._updateParameters())}get kernel(){return this._idealKernel}set packedFloat(e){this._packedFloat!==e&&(this._packedFloat=e,this._blockCompilation||this._updateParameters())}get packedFloat(){return this._packedFloat}getClassName(){return"BlurPostProcess"}updateEffect(e=null,t=null,i=null,s,r,n){this._updateParameters(r,n)}_updateParameters(e,t){const i=this._kernel,s=(i-1)/2;let r=[],n=[],o=0;for(let m=0;m<i;m++){const v=m/(i-1),x=this._gaussianWeight(v*2-1);r[m]=m-s,n[m]=x,o+=x}for(let m=0;m<n.length;m++)n[m]/=o;const l=[],h=[],c=[];for(let m=0;m<=s;m+=2){const v=Math.min(m+1,Math.floor(s));if(m===v)c.push({o:r[m],w:n[m]});else{const b=v===s,S=n[m]+n[v]*(b?.5:1),C=r[m]+1/(1+n[m]/n[v]);C===0?(c.push({o:r[m],w:n[m]}),c.push({o:r[m+1],w:n[m+1]})):(c.push({o:C,w:S}),c.push({o:-C,w:S}))}}for(let m=0;m<c.length;m++)h[m]=c[m].o,l[m]=c[m].w;r=h,n=l;const u=this.getEngine().getCaps().maxVaryingVectors,d=Math.max(u,0)-1;let f=Math.min(r.length,d),p="";p+=this._staticDefines,this._staticDefines.indexOf("DOF")!=-1&&(p+=`#define CENTER_WEIGHT ${this._glslFloat(n[f-1])}\r
`,f--);for(let m=0;m<f;m++)p+=`#define KERNEL_OFFSET${m} ${this._glslFloat(r[m])}\r
`,p+=`#define KERNEL_WEIGHT${m} ${this._glslFloat(n[m])}\r
`;let _=0;for(let m=d;m<r.length;m++)p+=`#define KERNEL_DEP_OFFSET${_} ${this._glslFloat(r[m])}\r
`,p+=`#define KERNEL_DEP_WEIGHT${_} ${this._glslFloat(n[m])}\r
`,_++;this.packedFloat&&(p+="#define PACKEDFLOAT 1"),this._blockCompilation=!1,super.updateEffect(p,null,null,{varyingCount:f,depCount:_},e,t)}_nearestBestKernel(e){const t=Math.round(e);for(const i of[t,t-1,t+1,t-2,t+2])if(i%2!==0&&Math.floor(i/2)%2===0&&i>0)return Math.max(i,3);return Math.max(t,3)}_gaussianWeight(e){const t=.3333333333333333,i=Math.sqrt(2*Math.PI)*t,s=-(e*e/(2*t*t));return 1/i*Math.exp(s)}_glslFloat(e,t=8){return e.toFixed(t).replace(/0+$/,"")}static _Parse(e,t,i,s){return xe.Parse(()=>new Ei(e.name,e.direction,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,void 0,!1),e,i,s)}}T([R("kernel")],Ei.prototype,"_kernel",void 0);T([R("packedFloat")],Ei.prototype,"_packedFloat",void 0);T([Dd()],Ei.prototype,"direction",void 0);he("BABYLON.BlurPostProcess",Ei);class Qc extends si{constructor(e,t,i,s,r=0,n=H.BILINEAR_SAMPLINGMODE,o=!0){if(super(e,t,i,s,!0,r,!1,n,o),this.mirrorPlane=new Hi(0,1,0,1),this._transformMatrix=L.Zero(),this._mirrorMatrix=L.Zero(),this._adaptiveBlurKernel=0,this._blurKernelX=0,this._blurKernelY=0,this._blurRatio=1,i=this.getScene(),!i)return this;this.ignoreCameraViewport=!0,this._updateGammaSpace(),this._imageProcessingConfigChangeObserver=i.imageProcessingConfiguration.onUpdateParameters.add(()=>{this._updateGammaSpace()});const l=i.getEngine();l.supportsUniformBuffers&&(this._sceneUBO=i.createSceneUniformBuffer(`Scene for Mirror Texture (name "${e}")`)),this.onBeforeBindObservable.add(()=>{var c;(c=l._debugPushGroup)===null||c===void 0||c.call(l,`mirror generation for ${e}`,1)}),this.onAfterUnbindObservable.add(()=>{var c;(c=l._debugPopGroup)===null||c===void 0||c.call(l,1)});let h;this.onBeforeRenderObservable.add(()=>{this._sceneUBO&&(this._currentSceneUBO=i.getSceneUniformBuffer(),i.setSceneUniformBuffer(this._sceneUBO),i.getSceneUniformBuffer().unbindEffect()),L.ReflectionToRef(this.mirrorPlane,this._mirrorMatrix),this._mirrorMatrix.multiplyToRef(i.getViewMatrix(),this._transformMatrix),i.setTransformMatrix(this._transformMatrix,i.getProjectionMatrix()),h=i.clipPlane,i.clipPlane=this.mirrorPlane,i.getEngine().cullBackFaces=!1,i._mirroredCameraPosition=g.TransformCoordinates(i.activeCamera.globalPosition,this._mirrorMatrix)}),this.onAfterRenderObservable.add(()=>{this._sceneUBO&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(),i.getEngine().cullBackFaces=null,i._mirroredCameraPosition=null,i.clipPlane=h})}set blurRatio(e){this._blurRatio!==e&&(this._blurRatio=e,this._preparePostProcesses())}get blurRatio(){return this._blurRatio}set adaptiveBlurKernel(e){this._adaptiveBlurKernel=e,this._autoComputeBlurKernel()}set blurKernel(e){this.blurKernelX=e,this.blurKernelY=e}set blurKernelX(e){this._blurKernelX!==e&&(this._blurKernelX=e,this._preparePostProcesses())}get blurKernelX(){return this._blurKernelX}set blurKernelY(e){this._blurKernelY!==e&&(this._blurKernelY=e,this._preparePostProcesses())}get blurKernelY(){return this._blurKernelY}_autoComputeBlurKernel(){const e=this.getScene().getEngine(),t=this.getRenderWidth()/e.getRenderWidth(),i=this.getRenderHeight()/e.getRenderHeight();this.blurKernelX=this._adaptiveBlurKernel*t,this.blurKernelY=this._adaptiveBlurKernel*i}_onRatioRescale(){this._sizeRatio&&(this.resize(this._initialSizeParameter),this._adaptiveBlurKernel||this._preparePostProcesses()),this._adaptiveBlurKernel&&this._autoComputeBlurKernel()}_updateGammaSpace(){const e=this.getScene();!e||(this.gammaSpace=!e.imageProcessingConfiguration.isEnabled||!e.imageProcessingConfiguration.applyByPostProcess)}_preparePostProcesses(){if(this.clearPostProcesses(!0),this._blurKernelX&&this._blurKernelY){const e=this.getScene().getEngine(),t=e.getCaps().textureFloatRender&&e.getCaps().textureFloatLinearFiltering?1:2;this._blurX=new Ei("horizontal blur",new le(1,0),this._blurKernelX,this._blurRatio,null,H.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurX.autoClear=!1,this._blurRatio===1&&this.samples<2&&this._texture?this._blurX.inputTexture=this._renderTarget:this._blurX.alwaysForcePOT=!0,this._blurY=new Ei("vertical blur",new le(0,1),this._blurKernelY,this._blurRatio,null,H.BILINEAR_SAMPLINGMODE,e,!1,t),this._blurY.autoClear=!1,this._blurY.alwaysForcePOT=this._blurRatio!==1,this.addPostProcess(this._blurX),this.addPostProcess(this._blurY)}else this._blurY&&(this.removePostProcess(this._blurY),this._blurY.dispose(),this._blurY=null),this._blurX&&(this.removePostProcess(this._blurX),this._blurX.dispose(),this._blurX=null)}clone(){const e=this.getScene();if(!e)return this;const t=this.getSize(),i=new Qc(this.name,t.width,e,this._renderTargetOptions.generateMipMaps,this._renderTargetOptions.type,this._renderTargetOptions.samplingMode,this._renderTargetOptions.generateDepthBuffer);return i.hasAlpha=this.hasAlpha,i.level=this.level,i.mirrorPlane=this.mirrorPlane.clone(),this.renderList&&(i.renderList=this.renderList.slice(0)),i}serialize(){if(!this.name)return null;const e=super.serialize();return e.mirrorPlane=this.mirrorPlane.asArray(),e}dispose(){var e;super.dispose();const t=this.getScene();t&&t.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigChangeObserver),(e=this._sceneUBO)===null||e===void 0||e.dispose()}}H._CreateMirror=(a,e,t,i)=>new Qc(a,e,t,i);class Xi extends dt{constructor(e,t,i=null,s=!1,r=null,n=null,o=null,l=5,h=!1,c=null,u=!1,d=.8,f=0,p,_){var m;super(t),this._lodScale=.8,this._lodOffset=0,this.onLoadObservable=new X,this.boundingBoxPosition=g.Zero(),this._rotationY=0,this._files=null,this._forcedExtension=null,this._extensions=null,this.name=e,this.url=e,this._noMipmap=s,this.hasAlpha=!1,this._format=l,this.isCube=!0,this._textureMatrix=L.Identity(),this._createPolynomials=u,this.coordinatesMode=H.CUBIC_MODE,this._extensions=i,this._files=r,this._forcedExtension=c,this._loaderOptions=p,this._useSRGBBuffer=_,this._lodScale=d,this._lodOffset=f,!(!e&&!r)&&this.updateURL(e,c,n,h,o,i,(m=this.getScene())===null||m===void 0?void 0:m.useDelayedTextureLoading,r)}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(L.RotationY(this._rotationY))}get rotationY(){return this._rotationY}get noMipmap(){return this._noMipmap}get forcedExtension(){return this._forcedExtension}static CreateFromImages(e,t,i){let s="";return e.forEach(r=>s+=r),new Xi(s,t,null,i,e)}static CreateFromPrefilteredData(e,t,i=null,s=!0){const r=t.useDelayedTextureLoading;t.useDelayedTextureLoading=!1;const n=new Xi(e,t,null,!1,null,null,null,void 0,!0,i,s);return t.useDelayedTextureLoading=r,n}getClassName(){return"CubeTexture"}updateURL(e,t,i=null,s=!1,r=null,n=null,o=!1,l=null){(!this.name||this.name.startsWith("data:"))&&(this.name=e),this.url=e,t&&(this._forcedExtension=t);const h=e.lastIndexOf("."),c=t||(h>-1?e.substring(h).toLowerCase():""),u=c.indexOf(".dds")===0,d=c.indexOf(".env")===0,f=c.indexOf(".basis")===0;if(d?(this.gammaSpace=!1,this._prefiltered=!1,this.anisotropicFilteringLevel=1):(this._prefiltered=s,s&&(this.gammaSpace=!1,this.anisotropicFilteringLevel=1)),l)this._files=l;else if(!f&&!d&&!u&&!n&&(n=["_px.jpg","_py.jpg","_pz.jpg","_nx.jpg","_ny.jpg","_nz.jpg"]),this._files=this._files||[],this._files.length=0,n){for(let p=0;p<n.length;p++)this._files.push(e+n[p]);this._extensions=n}o?(this.delayLoadState=4,this._delayedOnLoad=i,this._delayedOnError=r):this._loadTexture(i,r)}delayLoad(e){this.delayLoadState===4&&(e&&(this._forcedExtension=e),this.delayLoadState=1,this._loadTexture(this._delayedOnLoad,this._delayedOnError))}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;e.updateFlag!==this._textureMatrix.updateFlag&&(e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1)),this._textureMatrix=e)}_loadTexture(e=null,t=null){var i;const s=this.getScene(),r=this._texture;this._texture=this._getFromCache(this.url,this._noMipmap,void 0,void 0,this._useSRGBBuffer,this.isCube);const n=()=>{var l;this.onLoadObservable.notifyObservers(this),r&&(r.dispose(),(l=this.getScene())===null||l===void 0||l.markAllMaterialsAsDirty(1)),e&&e()},o=(l,h)=>{this._loadingError=!0,this._errorObject={message:l,exception:h},t&&t(l,h),H.OnTextureLoadErrorObservable.notifyObservers(this)};this._texture?this._texture.isReady?q.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(()=>n()):(this._prefiltered?this._texture=this._getEngine().createPrefilteredCubeTexture(this.url,s,this._lodScale,this._lodOffset,e,o,this._format,this._forcedExtension,this._createPolynomials):this._texture=this._getEngine().createCubeTexture(this.url,s,this._files,this._noMipmap,e,o,this._format,this._forcedExtension,!1,this._lodScale,this._lodOffset,null,this._loaderOptions,!!this._useSRGBBuffer),(i=this._texture)===null||i===void 0||i.onLoadedObservable.add(()=>this.onLoadObservable.notifyObservers(this)))}static Parse(e,t,i){const s=xe.Parse(()=>{let r=!1;return e.prefiltered&&(r=e.prefiltered),new Xi(i+e.name,t,e.extensions,!1,e.files||null,null,null,void 0,r,e.forcedExtension)},e,t);if(e.boundingBoxPosition&&(s.boundingBoxPosition=g.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=g.FromArray(e.boundingBoxSize)),e.animations)for(let r=0;r<e.animations.length;r++){const n=e.animations[r],o=Si("BABYLON.Animation");o&&s.animations.push(o.Parse(n))}return s}clone(){let e=0;const t=xe.Clone(()=>{const i=new Xi(this.url,this.getScene()||this._getEngine(),this._extensions,this._noMipmap,this._files);return e=i.uniqueId,i},this);return t.uniqueId=e,t}}T([R()],Xi.prototype,"url",void 0);T([R("rotationY")],Xi.prototype,"rotationY",null);T([R("files")],Xi.prototype,"_files",void 0);T([R("forcedExtension")],Xi.prototype,"_forcedExtension",void 0);T([R("extensions")],Xi.prototype,"_extensions",void 0);T([f_("textureMatrix")],Xi.prototype,"_textureMatrix",void 0);H._CubeTextureParser=Xi.Parse;he("BABYLON.CubeTexture",Xi);const yE="backgroundFragmentDeclaration",AE=`uniform vec4 vEyePosition;
uniform vec4 vPrimaryColor;
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
uniform vec4 vPrimaryColorShadow;
#endif
uniform float shadowLevel;
uniform float alpha;
#ifdef DIFFUSE
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#endif
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(REFRACTION)
uniform mat4 view;
#endif
`;Y.IncludesShadersStore[yE]=AE;const RE="backgroundUboDeclaration",IE=`layout(std140,column_major) uniform;
uniform Material
{
uniform vec4 vPrimaryColor;
uniform vec4 vPrimaryColorShadow;
uniform vec2 vDiffuseInfos;
uniform vec2 vReflectionInfos;
uniform mat4 diffuseMatrix;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
uniform float pointSize;
uniform float shadowLevel;
uniform float alpha;
#if defined(REFLECTIONFRESNEL) || defined(OPACITYFRESNEL)
uniform vec3 vBackgroundCenter;
#endif
#ifdef REFLECTIONFRESNEL
uniform vec4 vReflectionControl;
#endif
};
#include<sceneUboDeclaration>
`;Y.IncludesShadersStore[RE]=IE;const PE="backgroundPixelShader",ME=`#ifdef TEXTURELODSUPPORT
#extension GL_EXT_shader_texture_lod : enable
#endif
precision highp float;
#include<__decl__backgroundFragment>
#include<helperFunctions>
#define RECIPROCAL_PI2 0.15915494
varying vec3 vPositionW;
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif 
#ifdef MAINUV2 
varying vec2 vMainUV2; 
#endif 
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef DIFFUSE
#if DIFFUSEDIRECTUV==1
#define vDiffuseUV vMainUV1
#elif DIFFUSEDIRECTUV==2
#define vDiffuseUV vMainUV2
#else
varying vec2 vDiffuseUV;
#endif
uniform sampler2D diffuseSampler;
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef TEXTURELODSUPPORT
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#include<reflectionFunction>
#endif
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE;
#endif
#ifndef SHADOWONLY
#define SHADOWONLY;
#endif
#include<imageProcessingDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<lightsFragmentFunctions>
#include<shadowsFragmentFunctions>
#include<imageProcessingFunctions>
#include<clipPlaneFragmentDeclaration>
#include<fogFragmentDeclaration>
#ifdef REFLECTIONFRESNEL
#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
vec3 fresnelSchlickEnvironmentGGX(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=vec3(0.0,1.0,0.0);
#endif
float shadow=1.;
float globalShadow=0.;
float shadowLightCount=0.;
#include<lightFragment>[0..maxSimultaneousLights]
#ifdef SHADOWINUSE
globalShadow/=shadowLightCount;
#else
globalShadow=1.0;
#endif
#ifndef BACKMAT_SHADOWONLY
vec4 reflectionColor=vec4(1.,1.,1.,1.);
#ifdef REFLECTION
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=reflectionVector;
#else
vec2 reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
#ifdef REFLECTIONBLUR
float reflectionLOD=vReflectionInfos.y;
#ifdef TEXTURELODSUPPORT
reflectionLOD=reflectionLOD*log2(vReflectionMicrosurfaceInfos.x)*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
reflectionColor=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#else
float lodReflectionNormalized=saturate(reflectionLOD);
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 reflectionSpecularMid=sampleReflection(reflectionSampler,reflectionCoords);
if(lodReflectionNormalizedDoubled<1.0){
reflectionColor=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
reflectionSpecularMid,
lodReflectionNormalizedDoubled
);
} else {
reflectionColor=mix(
reflectionSpecularMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#else
vec4 reflectionSample=sampleReflection(reflectionSampler,reflectionCoords);
reflectionColor=reflectionSample;
#endif
#ifdef RGBDREFLECTION
reflectionColor.rgb=fromRGBD(reflectionColor);
#endif
#ifdef GAMMAREFLECTION
reflectionColor.rgb=toLinearSpace(reflectionColor.rgb);
#endif
#ifdef REFLECTIONBGR
reflectionColor.rgb=reflectionColor.bgr;
#endif
reflectionColor.rgb*=vReflectionInfos.x;
#endif
vec3 diffuseColor=vec3(1.,1.,1.);
float finalAlpha=alpha;
#ifdef DIFFUSE
vec4 diffuseMap=texture2D(diffuseSampler,vDiffuseUV);
#ifdef GAMMADIFFUSE
diffuseMap.rgb=toLinearSpace(diffuseMap.rgb);
#endif
diffuseMap.rgb*=vDiffuseInfos.y;
#ifdef DIFFUSEHASALPHA
finalAlpha*=diffuseMap.a;
#endif
diffuseColor=diffuseMap.rgb;
#endif
#ifdef REFLECTIONFRESNEL
vec3 colorBase=diffuseColor;
#else
vec3 colorBase=reflectionColor.rgb*diffuseColor;
#endif
colorBase=max(colorBase,0.0);
#ifdef USERGBCOLOR
vec3 finalColor=colorBase;
#else
#ifdef USEHIGHLIGHTANDSHADOWCOLORS
vec3 mainColor=mix(vPrimaryColorShadow.rgb,vPrimaryColor.rgb,colorBase);
#else
vec3 mainColor=vPrimaryColor.rgb;
#endif
vec3 finalColor=colorBase*mainColor;
#endif
#ifdef REFLECTIONFRESNEL
vec3 reflectionAmount=vReflectionControl.xxx;
vec3 reflectionReflectance0=vReflectionControl.yyy;
vec3 reflectionReflectance90=vReflectionControl.zzz;
float VdotN=dot(normalize(vEyePosition.xyz),normalW);
vec3 planarReflectionFresnel=fresnelSchlickEnvironmentGGX(saturate(VdotN),reflectionReflectance0,reflectionReflectance90,1.0);
reflectionAmount*=planarReflectionFresnel;
#ifdef REFLECTIONFALLOFF
float reflectionDistanceFalloff=1.0-saturate(length(vPositionW.xyz-vBackgroundCenter)*vReflectionControl.w);
reflectionDistanceFalloff*=reflectionDistanceFalloff;
reflectionAmount*=reflectionDistanceFalloff;
#endif
finalColor=mix(finalColor,reflectionColor.rgb,saturate(reflectionAmount));
#endif
#ifdef OPACITYFRESNEL
float viewAngleToFloor=dot(normalW,normalize(vEyePosition.xyz-vBackgroundCenter));
const float startAngle=0.1;
float fadeFactor=saturate(viewAngleToFloor/startAngle);
finalAlpha*=fadeFactor*fadeFactor;
#endif
#ifdef SHADOWINUSE
finalColor=mix(finalColor*shadowLevel,finalColor,globalShadow);
#endif
vec4 color=vec4(finalColor,finalAlpha);
#else
vec4 color=vec4(vPrimaryColor.rgb,(1.0-clamp(globalShadow,0.,1.))*alpha);
#endif
#include<fogFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
#if !defined(SKIPFINALCOLORCLAMP)
color.rgb=clamp(color.rgb,0.,30.0);
#endif
#else
color=applyImageProcessing(color);
#endif
#ifdef PREMULTIPLYALPHA
color.rgb*=color.a;
#endif
#ifdef NOISE
color.rgb+=dither(vPositionW.xy,0.5);
color=max(color,0.0);
#endif
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Y.ShadersStore[PE]=ME;const DE="backgroundVertexDeclaration",OE=`uniform mat4 view;
uniform mat4 viewProjection;
uniform float shadowLevel;
#ifdef DIFFUSE
uniform mat4 diffuseMatrix;
uniform vec2 vDiffuseInfos;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
uniform float fFovMultiplier;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
`;Y.IncludesShadersStore[DE]=OE;const wE="backgroundVertexShader",NE=`precision highp float;
#include<__decl__backgroundVertex>
#include<helperFunctions>
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
varying vec3 vPositionW;
#ifdef NORMAL
varying vec3 vNormalW;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef MAINUV1
varying vec2 vMainUV1;
#endif
#ifdef MAINUV2
varying vec2 vMainUV2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
varying vec2 vDiffuseUV;
#endif
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=position;
#endif
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
} else {
gl_Position=viewProjectionR*finalWorld*vec4(position,1.0);
}
#else
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#endif
vec4 worldPos=finalWorld*vec4(position,1.0);
vPositionW=vec3(worldPos);
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normal);
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(position,0.0)));
#ifdef EQUIRECTANGULAR_RELFECTION_FOV
mat3 screenToWorld=inverseMat3(mat3(finalWorld*viewProjection));
vec3 segment=mix(vDirectionW,screenToWorld*vec3(0.0,0.0,1.0),abs(fFovMultiplier-1.0));
if (fFovMultiplier<=1.0) {
vDirectionW=normalize(segment);
} else {
vDirectionW=normalize(vDirectionW+(vDirectionW-segment));
}
#endif
#endif
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uv;
#endif
#ifdef MAINUV2
vMainUV2=uv2;
#endif
#if defined(DIFFUSE) && DIFFUSEDIRECTUV==0
if (vDiffuseInfos.x==0.)
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv,1.0,0.0));
}
else
{
vDiffuseUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
}
#endif
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#ifdef VERTEXCOLOR
vColor=color;
#endif
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;Y.ShadersStore[wE]=NE;class FE extends rr{constructor(){super(),this.DIFFUSE=!1,this.DIFFUSEDIRECTUV=0,this.GAMMADIFFUSE=!1,this.DIFFUSEHASALPHA=!1,this.OPACITYFRESNEL=!1,this.REFLECTIONBLUR=!1,this.REFLECTIONFRESNEL=!1,this.REFLECTIONFALLOFF=!1,this.TEXTURELODSUPPORT=!1,this.PREMULTIPLYALPHA=!1,this.USERGBCOLOR=!1,this.USEHIGHLIGHTANDSHADOWCOLORS=!1,this.BACKMAT_SHADOWONLY=!1,this.NOISE=!1,this.REFLECTIONBGR=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.EQUIRECTANGULAR_RELFECTION_FOV=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.UV1=!1,this.UV2=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.NORMAL=!1,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.INSTANCES=!1,this.SHADOWFLOAT=!1,this.LOGARITHMICDEPTH=!1,this.NONUNIFORMSCALING=!1,this.ALPHATEST=!1,this.rebuild()}}class Je extends zo{constructor(e,t){super(e,t),this.primaryColor=re.White(),this._primaryColorShadowLevel=0,this._primaryColorHighlightLevel=0,this.reflectionTexture=null,this.reflectionBlur=0,this.diffuseTexture=null,this._shadowLights=null,this.shadowLights=null,this.shadowLevel=0,this.sceneCenter=g.Zero(),this.opacityFresnel=!0,this.reflectionFresnel=!1,this.reflectionFalloffDistance=0,this.reflectionAmount=1,this.reflectionReflectance0=.05,this.reflectionReflectance90=.5,this.useRGBColor=!0,this.enableNoise=!1,this._fovMultiplier=1,this.useEquirectangularFOV=!1,this._maxSimultaneousLights=4,this.maxSimultaneousLights=4,this._shadowOnly=!1,this.shadowOnly=!1,this._imageProcessingObserver=null,this.switchToBGR=!1,this._renderTargets=new mi(16),this._reflectionControls=Ge.Zero(),this._white=re.White(),this._primaryShadowColor=re.Black(),this._primaryHighlightColor=re.Black(),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._renderTargets.push(this._diffuseTexture),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._renderTargets)}get _perceptualColor(){return this.__perceptualColor}set _perceptualColor(e){this.__perceptualColor=e,this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsLightsDirty()}get primaryColorShadowLevel(){return this._primaryColorShadowLevel}set primaryColorShadowLevel(e){this._primaryColorShadowLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}get primaryColorHighlightLevel(){return this._primaryColorHighlightLevel}set primaryColorHighlightLevel(e){this._primaryColorHighlightLevel=e,this._computePrimaryColors(),this._markAllSubMeshesAsLightsDirty()}set reflectionStandardFresnelWeight(e){let t=e;t<.5?(t=t*2,this.reflectionReflectance0=Je.StandardReflectance0*t,this.reflectionReflectance90=Je.StandardReflectance90*t):(t=t*2-1,this.reflectionReflectance0=Je.StandardReflectance0+(1-Je.StandardReflectance0)*t,this.reflectionReflectance90=Je.StandardReflectance90+(1-Je.StandardReflectance90)*t)}get fovMultiplier(){return this._fovMultiplier}set fovMultiplier(e){isNaN(e)&&(e=1),this._fovMultiplier=Math.max(0,Math.min(2,e))}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._computePrimaryColorFromPerceptualColor(),this._markAllSubMeshesAsImageProcessingDirty()})))}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this.imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this.imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this.imageProcessingConfiguration.colorCurves=e}get hasRenderTargetTextures(){return!!(this._diffuseTexture&&this._diffuseTexture.isRenderTarget||this._reflectionTexture&&this._reflectionTexture.isRenderTarget)}needAlphaTesting(){return!0}needAlphaBlending(){return this.alpha<1||this._diffuseTexture!=null&&this._diffuseTexture.hasAlpha||this._shadowOnly}isReadyForSubMesh(e,t,i=!1){if(t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new FE);const s=this.getScene(),r=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const n=s.getEngine();if(se.PrepareDefinesForLights(s,e,r,!1,this._maxSimultaneousLights),r._needNormals=!0,se.PrepareDefinesForMultiview(s,r),r._areTexturesDirty){if(r._needUVs=!1,s.texturesEnabled){if(s.getEngine().getCaps().textureLOD&&(r.TEXTURELODSUPPORT=!0),this._diffuseTexture&&ce.DiffuseTextureEnabled){if(!this._diffuseTexture.isReadyOrNotBlocking())return!1;se.PrepareDefinesForMergedUV(this._diffuseTexture,r,"DIFFUSE"),r.DIFFUSEHASALPHA=this._diffuseTexture.hasAlpha,r.GAMMADIFFUSE=this._diffuseTexture.gammaSpace,r.OPACITYFRESNEL=this._opacityFresnel}else r.DIFFUSE=!1,r.DIFFUSEDIRECTUV=0,r.DIFFUSEHASALPHA=!1,r.GAMMADIFFUSE=!1,r.OPACITYFRESNEL=!1;const o=this._reflectionTexture;if(o&&ce.ReflectionTextureEnabled){if(!o.isReadyOrNotBlocking())return!1;switch(r.REFLECTION=!0,r.GAMMAREFLECTION=o.gammaSpace,r.RGBDREFLECTION=o.isRGBD,r.REFLECTIONBLUR=this._reflectionBlur>0,r.LODINREFLECTIONALPHA=o.lodLevelInAlpha,r.EQUIRECTANGULAR_RELFECTION_FOV=this.useEquirectangularFOV,r.REFLECTIONBGR=this.switchToBGR,o.coordinatesMode===H.INVCUBIC_MODE&&(r.INVERTCUBICMAP=!0),r.REFLECTIONMAP_3D=o.isCube,r.REFLECTIONMAP_OPPOSITEZ=r.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!o.invertZ:o.invertZ,o.coordinatesMode){case H.EXPLICIT_MODE:r.REFLECTIONMAP_EXPLICIT=!0;break;case H.PLANAR_MODE:r.REFLECTIONMAP_PLANAR=!0;break;case H.PROJECTION_MODE:r.REFLECTIONMAP_PROJECTION=!0;break;case H.SKYBOX_MODE:r.REFLECTIONMAP_SKYBOX=!0;break;case H.SPHERICAL_MODE:r.REFLECTIONMAP_SPHERICAL=!0;break;case H.EQUIRECTANGULAR_MODE:r.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case H.FIXED_EQUIRECTANGULAR_MODE:r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:r.REFLECTIONMAP_CUBIC=!0;break}this.reflectionFresnel?(r.REFLECTIONFRESNEL=!0,r.REFLECTIONFALLOFF=this.reflectionFalloffDistance>0,this._reflectionControls.x=this.reflectionAmount,this._reflectionControls.y=this.reflectionReflectance0,this._reflectionControls.z=this.reflectionReflectance90,this._reflectionControls.w=1/this.reflectionFalloffDistance):(r.REFLECTIONFRESNEL=!1,r.REFLECTIONFALLOFF=!1)}else r.REFLECTION=!1,r.REFLECTIONFRESNEL=!1,r.REFLECTIONFALLOFF=!1,r.REFLECTIONBLUR=!1,r.REFLECTIONMAP_3D=!1,r.REFLECTIONMAP_SPHERICAL=!1,r.REFLECTIONMAP_PLANAR=!1,r.REFLECTIONMAP_CUBIC=!1,r.REFLECTIONMAP_PROJECTION=!1,r.REFLECTIONMAP_SKYBOX=!1,r.REFLECTIONMAP_EXPLICIT=!1,r.REFLECTIONMAP_EQUIRECTANGULAR=!1,r.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,r.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,r.INVERTCUBICMAP=!1,r.REFLECTIONMAP_OPPOSITEZ=!1,r.LODINREFLECTIONALPHA=!1,r.GAMMAREFLECTION=!1,r.RGBDREFLECTION=!1}r.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,r.USERGBCOLOR=this._useRGBColor,r.NOISE=this._enableNoise}if(r._areLightsDirty&&(r.USEHIGHLIGHTANDSHADOWCOLORS=!this._useRGBColor&&(this._primaryColorShadowLevel!==0||this._primaryColorHighlightLevel!==0),r.BACKMAT_SHADOWONLY=this._shadowOnly),r._areImageProcessingDirty&&this._imageProcessingConfiguration){if(!this._imageProcessingConfiguration.isReady())return!1;this._imageProcessingConfiguration.prepareDefines(r)}if(se.PrepareDefinesForMisc(e,s,!1,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e),r),se.PrepareDefinesForFrameBoundValues(s,n,r,i,null,t.getRenderingMesh().hasThinInstances),se.PrepareDefinesForAttributes(e,r,!1,!0,!1)&&e&&!s.getEngine().getCaps().standardDerivatives&&!e.isVerticesDataPresent(y.NormalKind)&&(e.createNormals(!0),B.Warn("BackgroundMaterial: Normals have been created for the mesh: "+e.name)),r.isDirty){r.markAsProcessed(),s.resetCachedMaterial();const o=new Wa;r.FOG&&o.addFallback(0,"FOG"),r.POINTSIZE&&o.addFallback(1,"POINTSIZE"),r.MULTIVIEW&&o.addFallback(0,"MULTIVIEW"),se.HandleFallbacksForShadows(r,o,this._maxSimultaneousLights);const l=[y.PositionKind];r.NORMAL&&l.push(y.NormalKind),r.UV1&&l.push(y.UVKind),r.UV2&&l.push(y.UV2Kind),se.PrepareAttributesForBones(l,e,r,o),se.PrepareAttributesForInstances(l,r);const h=["world","view","viewProjection","vEyePosition","vLightsType","vFogInfos","vFogColor","pointSize","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","mBones","vPrimaryColor","vPrimaryColorShadow","vReflectionInfos","reflectionMatrix","vReflectionMicrosurfaceInfos","fFovMultiplier","shadowLevel","alpha","vBackgroundCenter","vReflectionControl","vDiffuseInfos","diffuseMatrix"],c=["diffuseSampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh"],u=["Material","Scene"];qe&&(qe.PrepareUniforms(h,r),qe.PrepareSamplers(c,r)),se.PrepareUniformsAndSamplersList({uniformsNames:h,uniformBuffersNames:u,samplers:c,defines:r,maxSimultaneousLights:this._maxSimultaneousLights});const d=r.toString(),f=s.getEngine().createEffect("background",{attributes:l,uniformsNames:h,uniformBuffersNames:u,samplers:c,defines:d,fallbacks:o,onCompiled:this.onCompiled,onError:this.onError,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights}},n);t.setEffect(f,r,this._materialContext),this.buildUniformLayout()}return!t.effect||!t.effect.isReady()?!1:(r._renderId=s.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=i,s.performancePriority!==Qs.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}_computePrimaryColorFromPerceptualColor(){!this.__perceptualColor||(this._primaryColor.copyFrom(this.__perceptualColor),this._primaryColor.toLinearSpaceToRef(this._primaryColor),this._imageProcessingConfiguration&&this._primaryColor.scaleToRef(1/this._imageProcessingConfiguration.exposure,this._primaryColor),this._computePrimaryColors())}_computePrimaryColors(){this._primaryColorShadowLevel===0&&this._primaryColorHighlightLevel===0||(this._primaryColor.scaleToRef(this._primaryColorShadowLevel,this._primaryShadowColor),this._primaryColor.subtractToRef(this._primaryShadowColor,this._primaryShadowColor),this._white.subtractToRef(this._primaryColor,this._primaryHighlightColor),this._primaryHighlightColor.scaleToRef(this._primaryColorHighlightLevel,this._primaryHighlightColor),this._primaryColor.addToRef(this._primaryHighlightColor,this._primaryHighlightColor))}buildUniformLayout(){this._uniformBuffer.addUniform("vPrimaryColor",4),this._uniformBuffer.addUniform("vPrimaryColorShadow",4),this._uniformBuffer.addUniform("vDiffuseInfos",2),this._uniformBuffer.addUniform("vReflectionInfos",2),this._uniformBuffer.addUniform("diffuseMatrix",16),this._uniformBuffer.addUniform("reflectionMatrix",16),this._uniformBuffer.addUniform("vReflectionMicrosurfaceInfos",3),this._uniformBuffer.addUniform("fFovMultiplier",1),this._uniformBuffer.addUniform("pointSize",1),this._uniformBuffer.addUniform("shadowLevel",1),this._uniformBuffer.addUniform("alpha",1),this._uniformBuffer.addUniform("vBackgroundCenter",3),this._uniformBuffer.addUniform("vReflectionControl",4),this._uniformBuffer.create()}unbind(){this._diffuseTexture&&this._diffuseTexture.isRenderTarget&&this._uniformBuffer.setTexture("diffuseSampler",null),this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._uniformBuffer.setTexture("reflectionSampler",null),super.unbind()}bindOnlyWorldMatrix(e){this._activeEffect.setMatrix("world",e)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;if(!n)return;this._activeEffect=n,this.bindOnlyWorldMatrix(e),se.BindBonesParameters(t,this._activeEffect);const o=this._mustRebind(s,n,t.visibility);if(o){this._uniformBuffer.bindToEffect(n,"Material"),this.bindViewProjection(n);const l=this._reflectionTexture;(!this._uniformBuffer.useUbo||!this.isFrozen||!this._uniformBuffer.isSync)&&(s.texturesEnabled&&(this._diffuseTexture&&ce.DiffuseTextureEnabled&&(this._uniformBuffer.updateFloat2("vDiffuseInfos",this._diffuseTexture.coordinatesIndex,this._diffuseTexture.level),se.BindTextureMatrix(this._diffuseTexture,this._uniformBuffer,"diffuse")),l&&ce.ReflectionTextureEnabled&&(this._uniformBuffer.updateMatrix("reflectionMatrix",l.getReflectionTextureMatrix()),this._uniformBuffer.updateFloat2("vReflectionInfos",l.level,this._reflectionBlur),this._uniformBuffer.updateFloat3("vReflectionMicrosurfaceInfos",l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset))),this.shadowLevel>0&&this._uniformBuffer.updateFloat("shadowLevel",this.shadowLevel),this._uniformBuffer.updateFloat("alpha",this.alpha),this.pointsCloud&&this._uniformBuffer.updateFloat("pointSize",this.pointSize),r.USEHIGHLIGHTANDSHADOWCOLORS?(this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryHighlightColor,1),this._uniformBuffer.updateColor4("vPrimaryColorShadow",this._primaryShadowColor,1)):this._uniformBuffer.updateColor4("vPrimaryColor",this._primaryColor,1)),this._uniformBuffer.updateFloat("fFovMultiplier",this._fovMultiplier),s.texturesEnabled&&(this._diffuseTexture&&ce.DiffuseTextureEnabled&&this._uniformBuffer.setTexture("diffuseSampler",this._diffuseTexture),l&&ce.ReflectionTextureEnabled&&(r.REFLECTIONBLUR&&r.TEXTURELODSUPPORT?this._uniformBuffer.setTexture("reflectionSampler",l):r.REFLECTIONBLUR?(this._uniformBuffer.setTexture("reflectionSampler",l._lodTextureMid||l),this._uniformBuffer.setTexture("reflectionSamplerLow",l._lodTextureLow||l),this._uniformBuffer.setTexture("reflectionSamplerHigh",l._lodTextureHigh||l)):this._uniformBuffer.setTexture("reflectionSampler",l),r.REFLECTIONFRESNEL&&(this._uniformBuffer.updateFloat3("vBackgroundCenter",this.sceneCenter.x,this.sceneCenter.y,this.sceneCenter.z),this._uniformBuffer.updateFloat4("vReflectionControl",this._reflectionControls.x,this._reflectionControls.y,this._reflectionControls.z,this._reflectionControls.w)))),se.BindClipPlane(this._activeEffect,s),s.bindEyePosition(n)}else s.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._uniformBuffer.bindToEffect(n,"Material"),this._needToBindSceneUbo=!0);(o||!this.isFrozen)&&(s.lightsEnabled&&se.BindLights(s,t,this._activeEffect,r,this._maxSimultaneousLights),this.bindView(n),se.BindFogParameters(s,t,this._activeEffect,!0),this._imageProcessingConfiguration&&this._imageProcessingConfiguration.bind(this._activeEffect)),this._afterBind(t,this._activeEffect),this._uniformBuffer.update()}hasTexture(e){return!!(super.hasTexture(e)||this._reflectionTexture===e||this._diffuseTexture===e)}dispose(e=!1,t=!1){t&&(this.diffuseTexture&&this.diffuseTexture.dispose(),this.reflectionTexture&&this.reflectionTexture.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e)}clone(e){return xe.Clone(()=>new Je(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.BackgroundMaterial",e}getClassName(){return"BackgroundMaterial"}static Parse(e,t,i){return xe.Parse(()=>new Je(e.name,t),e,t,i)}}Je.StandardReflectance0=.05;Je.StandardReflectance90=.5;T([pi()],Je.prototype,"_primaryColor",void 0);T([ie("_markAllSubMeshesAsLightsDirty")],Je.prototype,"primaryColor",void 0);T([pi()],Je.prototype,"__perceptualColor",void 0);T([R()],Je.prototype,"_primaryColorShadowLevel",void 0);T([R()],Je.prototype,"_primaryColorHighlightLevel",void 0);T([ie("_markAllSubMeshesAsLightsDirty")],Je.prototype,"primaryColorHighlightLevel",null);T([Qe()],Je.prototype,"_reflectionTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionTexture",void 0);T([R()],Je.prototype,"_reflectionBlur",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionBlur",void 0);T([Qe()],Je.prototype,"_diffuseTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"diffuseTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"shadowLights",void 0);T([R()],Je.prototype,"_shadowLevel",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"shadowLevel",void 0);T([Zi()],Je.prototype,"_sceneCenter",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"sceneCenter",void 0);T([R()],Je.prototype,"_opacityFresnel",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"opacityFresnel",void 0);T([R()],Je.prototype,"_reflectionFresnel",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionFresnel",void 0);T([R()],Je.prototype,"_reflectionFalloffDistance",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionFalloffDistance",void 0);T([R()],Je.prototype,"_reflectionAmount",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionAmount",void 0);T([R()],Je.prototype,"_reflectionReflectance0",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionReflectance0",void 0);T([R()],Je.prototype,"_reflectionReflectance90",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"reflectionReflectance90",void 0);T([R()],Je.prototype,"_useRGBColor",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"useRGBColor",void 0);T([R()],Je.prototype,"_enableNoise",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"enableNoise",void 0);T([R()],Je.prototype,"_maxSimultaneousLights",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Je.prototype,"maxSimultaneousLights",void 0);T([R()],Je.prototype,"_shadowOnly",void 0);T([ie("_markAllSubMeshesAsLightsDirty")],Je.prototype,"shadowOnly",void 0);T([d_()],Je.prototype,"_imageProcessingConfiguration",void 0);he("BABYLON.BackgroundMaterial",Je);class Va{constructor(e,t){this._errorHandler=(i,s)=>{this.onErrorObservable.notifyObservers({message:i,exception:s})},this._options={...Va._GetDefaultOptions(),...e},this._scene=t,this.onErrorObservable=new X,this._setupBackground(),this._setupImageProcessing()}static _GetDefaultOptions(){return{createGround:!0,groundSize:15,groundTexture:this._GroundTextureCDNUrl,groundColor:new re(.2,.2,.3).toLinearSpace().scale(3),groundOpacity:.9,enableGroundShadow:!0,groundShadowLevel:.5,enableGroundMirror:!1,groundMirrorSizeRatio:.3,groundMirrorBlurKernel:64,groundMirrorAmount:1,groundMirrorFresnelWeight:1,groundMirrorFallOffDistance:0,groundMirrorTextureType:0,groundYBias:1e-5,createSkybox:!0,skyboxSize:20,skyboxTexture:this._SkyboxTextureCDNUrl,skyboxColor:new re(.2,.2,.3).toLinearSpace().scale(3),backgroundYRotation:0,sizeAuto:!0,rootPosition:g.Zero(),setupImageProcessing:!0,environmentTexture:this._EnvironmentTextureCDNUrl,cameraExposure:.8,cameraContrast:1.2,toneMappingEnabled:!0}}get rootMesh(){return this._rootMesh}get skybox(){return this._skybox}get skyboxTexture(){return this._skyboxTexture}get skyboxMaterial(){return this._skyboxMaterial}get ground(){return this._ground}get groundTexture(){return this._groundTexture}get groundMirror(){return this._groundMirror}get groundMirrorRenderList(){return this._groundMirror?this._groundMirror.renderList:null}get groundMaterial(){return this._groundMaterial}updateOptions(e){const t={...this._options,...e};this._ground&&!t.createGround&&(this._ground.dispose(),this._ground=null),this._groundMaterial&&!t.createGround&&(this._groundMaterial.dispose(),this._groundMaterial=null),this._groundTexture&&this._options.groundTexture!=t.groundTexture&&(this._groundTexture.dispose(),this._groundTexture=null),this._skybox&&!t.createSkybox&&(this._skybox.dispose(),this._skybox=null),this._skyboxMaterial&&!t.createSkybox&&(this._skyboxMaterial.dispose(),this._skyboxMaterial=null),this._skyboxTexture&&this._options.skyboxTexture!=t.skyboxTexture&&(this._skyboxTexture.dispose(),this._skyboxTexture=null),this._groundMirror&&!t.enableGroundMirror&&(this._groundMirror.dispose(),this._groundMirror=null),this._scene.environmentTexture&&this._options.environmentTexture!=t.environmentTexture&&this._scene.environmentTexture.dispose(),this._options=t,this._setupBackground(),this._setupImageProcessing()}setMainColor(e){this.groundMaterial&&(this.groundMaterial.primaryColor=e),this.skyboxMaterial&&(this.skyboxMaterial.primaryColor=e),this.groundMirror&&(this.groundMirror.clearColor=new J(e.r,e.g,e.b,1))}_setupImageProcessing(){this._options.setupImageProcessing&&(this._scene.imageProcessingConfiguration.contrast=this._options.cameraContrast,this._scene.imageProcessingConfiguration.exposure=this._options.cameraExposure,this._scene.imageProcessingConfiguration.toneMappingEnabled=this._options.toneMappingEnabled,this._setupEnvironmentTexture())}_setupEnvironmentTexture(){if(this._scene.environmentTexture)return;if(this._options.environmentTexture instanceof dt){this._scene.environmentTexture=this._options.environmentTexture;return}const e=Xi.CreateFromPrefilteredData(this._options.environmentTexture,this._scene);this._scene.environmentTexture=e}_setupBackground(){this._rootMesh||(this._rootMesh=new V("BackgroundHelper",this._scene)),this._rootMesh.rotation.y=this._options.backgroundYRotation;const e=this._getSceneSize();this._options.createGround&&(this._setupGround(e),this._setupGroundMaterial(),this._setupGroundDiffuseTexture(),this._options.enableGroundMirror&&this._setupGroundMirrorTexture(e),this._setupMirrorInGroundMaterial()),this._options.createSkybox&&(this._setupSkybox(e),this._setupSkyboxMaterial(),this._setupSkyboxReflectionTexture()),this._rootMesh.position.x=e.rootPosition.x,this._rootMesh.position.z=e.rootPosition.z,this._rootMesh.position.y=e.rootPosition.y}_getSceneSize(){let e=this._options.groundSize,t=this._options.skyboxSize,i=this._options.rootPosition;if(!this._scene.meshes||this._scene.meshes.length===1)return{groundSize:e,skyboxSize:t,rootPosition:i};const s=this._scene.getWorldExtends(n=>n!==this._ground&&n!==this._rootMesh&&n!==this._skybox),r=s.max.subtract(s.min);if(this._options.sizeAuto){this._scene.activeCamera instanceof yt&&this._scene.activeCamera.upperRadiusLimit&&(e=this._scene.activeCamera.upperRadiusLimit*2,t=e);const n=r.length();n>e&&(e=n*2,t=e),e*=1.1,t*=1.5,i=s.min.add(r.scale(.5)),i.y=s.min.y-this._options.groundYBias}return{groundSize:e,skyboxSize:t,rootPosition:i}}_setupGround(e){(!this._ground||this._ground.isDisposed())&&(this._ground=Ec("BackgroundPlane",{size:e.groundSize},this._scene),this._ground.rotation.x=Math.PI/2,this._ground.parent=this._rootMesh,this._ground.onDisposeObservable.add(()=>{this._ground=null})),this._ground.receiveShadows=this._options.enableGroundShadow}_setupGroundMaterial(){this._groundMaterial||(this._groundMaterial=new Je("BackgroundPlaneMaterial",this._scene)),this._groundMaterial.alpha=this._options.groundOpacity,this._groundMaterial.alphaMode=8,this._groundMaterial.shadowLevel=this._options.groundShadowLevel,this._groundMaterial.primaryColor=this._options.groundColor,this._groundMaterial.useRGBColor=!1,this._groundMaterial.enableNoise=!0,this._ground&&(this._ground.material=this._groundMaterial)}_setupGroundDiffuseTexture(){if(!!this._groundMaterial&&!this._groundTexture){if(this._options.groundTexture instanceof dt){this._groundMaterial.diffuseTexture=this._options.groundTexture;return}this._groundTexture=new H(this._options.groundTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._groundTexture.gammaSpace=!1,this._groundTexture.hasAlpha=!0,this._groundMaterial.diffuseTexture=this._groundTexture}}_setupGroundMirrorTexture(e){const t=H.CLAMP_ADDRESSMODE;if(!this._groundMirror&&(this._groundMirror=new Qc("BackgroundPlaneMirrorTexture",{ratio:this._options.groundMirrorSizeRatio},this._scene,!1,this._options.groundMirrorTextureType,H.BILINEAR_SAMPLINGMODE,!0),this._groundMirror.mirrorPlane=new Hi(0,-1,0,e.rootPosition.y),this._groundMirror.anisotropicFilteringLevel=1,this._groundMirror.wrapU=t,this._groundMirror.wrapV=t,this._groundMirror.renderList))for(let s=0;s<this._scene.meshes.length;s++){const r=this._scene.meshes[s];r!==this._ground&&r!==this._skybox&&r!==this._rootMesh&&this._groundMirror.renderList.push(r)}const i=this._options.groundColor.toGammaSpace();this._groundMirror.clearColor=new J(i.r,i.g,i.b,1),this._groundMirror.adaptiveBlurKernel=this._options.groundMirrorBlurKernel}_setupMirrorInGroundMaterial(){this._groundMaterial&&(this._groundMaterial.reflectionTexture=this._groundMirror,this._groundMaterial.reflectionFresnel=!0,this._groundMaterial.reflectionAmount=this._options.groundMirrorAmount,this._groundMaterial.reflectionStandardFresnelWeight=this._options.groundMirrorFresnelWeight,this._groundMaterial.reflectionFalloffDistance=this._options.groundMirrorFallOffDistance)}_setupSkybox(e){(!this._skybox||this._skybox.isDisposed())&&(this._skybox=Yc("BackgroundSkybox",{size:e.skyboxSize,sideOrientation:V.BACKSIDE},this._scene),this._skybox.onDisposeObservable.add(()=>{this._skybox=null})),this._skybox.parent=this._rootMesh}_setupSkyboxMaterial(){!this._skybox||(this._skyboxMaterial||(this._skyboxMaterial=new Je("BackgroundSkyboxMaterial",this._scene)),this._skyboxMaterial.useRGBColor=!1,this._skyboxMaterial.primaryColor=this._options.skyboxColor,this._skyboxMaterial.enableNoise=!0,this._skybox.material=this._skyboxMaterial)}_setupSkyboxReflectionTexture(){if(!!this._skyboxMaterial&&!this._skyboxTexture){if(this._options.skyboxTexture instanceof dt){this._skyboxMaterial.reflectionTexture=this._options.skyboxTexture;return}this._skyboxTexture=new Xi(this._options.skyboxTexture,this._scene,void 0,void 0,void 0,void 0,this._errorHandler),this._skyboxTexture.coordinatesMode=H.SKYBOX_MODE,this._skyboxTexture.gammaSpace=!1,this._skyboxMaterial.reflectionTexture=this._skyboxTexture}}dispose(){this._groundMaterial&&this._groundMaterial.dispose(!0,!0),this._skyboxMaterial&&this._skyboxMaterial.dispose(!0,!0),this._rootMesh.dispose(!1)}}Va._GroundTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundGround.png";Va._SkyboxTextureCDNUrl="https://assets.babylonjs.com/environments/backgroundSkybox.dds";Va._EnvironmentTextureCDNUrl="https://assets.babylonjs.com/environments/environmentSpecular.env";class bs extends ke{constructor(e,t,i,s,r=null){super(e,s),this.onError=r,this._halfDome=!1,this._crossEye=!1,this._useDirectMapping=!1,this._textureMode=bs.MODE_MONOSCOPIC,this._onBeforeCameraRenderObserver=null,this.onLoadErrorObservable=new X,this.onLoadObservable=new X,s=this.getScene(),e=e||"textureDome",i.resolution=Math.abs(i.resolution)|0||32,i.clickToPlay=Boolean(i.clickToPlay),i.autoPlay=i.autoPlay===void 0?!0:Boolean(i.autoPlay),i.loop=i.loop===void 0?!0:Boolean(i.loop),i.size=Math.abs(i.size)||(s.activeCamera?s.activeCamera.maxZ*.48:1e3),i.useDirectMapping===void 0?this._useDirectMapping=!0:this._useDirectMapping=i.useDirectMapping,i.faceForward===void 0&&(i.faceForward=!0),this._setReady(!1),i.mesh?this._mesh=i.mesh:this._mesh=qr(e+"_mesh",{segments:i.resolution,diameter:i.size,updatable:!1,sideOrientation:V.BACKSIDE},s);const n=this._material=new Je(e+"_material",s);n.useEquirectangularFOV=!0,n.fovMultiplier=1,n.opacityFresnel=!1;const o=this._initTexture(t,s,i);if(this.texture=o,this._mesh.material=n,this._mesh.parent=this,this._halfDomeMask=qr("",{slice:.5,diameter:i.size*.98,segments:i.resolution*2,sideOrientation:V.BACKSIDE},s),this._halfDomeMask.rotate(ti.X,-Math.PI/2),this._halfDomeMask.parent=this._mesh,this._halfDome=!!i.halfDomeMode,this._halfDomeMask.setEnabled(this._halfDome),this._crossEye=!!i.crossEyeMode,this._texture.anisotropicFilteringLevel=1,this._texture.onLoadObservable.addOnce(()=>{this._setReady(!0)}),i.faceForward&&s.activeCamera){const l=s.activeCamera,h=g.Forward(),c=g.TransformNormal(h,l.getViewMatrix());c.normalize(),this.rotation.y=Math.acos(g.Dot(h,c))}this._changeTextureMode(this._textureMode)}get texture(){return this._texture}set texture(e){this._texture!==e&&(this._texture=e,this._useDirectMapping?(this._texture.wrapU=H.CLAMP_ADDRESSMODE,this._texture.wrapV=H.CLAMP_ADDRESSMODE,this._material.diffuseTexture=this._texture):(this._texture.coordinatesMode=H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE,this._texture.wrapV=H.CLAMP_ADDRESSMODE,this._material.reflectionTexture=this._texture),this._changeTextureMode(this._textureMode))}get mesh(){return this._mesh}get fovMultiplier(){return this._material.fovMultiplier}set fovMultiplier(e){this._material.fovMultiplier=e}get textureMode(){return this._textureMode}set textureMode(e){this._textureMode!==e&&this._changeTextureMode(e)}get halfDome(){return this._halfDome}set halfDome(e){this._halfDome=e,this._halfDomeMask.setEnabled(e),this._changeTextureMode(this._textureMode)}set crossEye(e){this._crossEye=e,this._changeTextureMode(this._textureMode)}get crossEye(){return this._crossEye}get material(){return this._material}_changeTextureMode(e){switch(this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this._textureMode=e,this._texture.uScale=1,this._texture.vScale=1,this._texture.uOffset=0,this._texture.vOffset=0,this._texture.vAng=0,e){case bs.MODE_MONOSCOPIC:this._halfDome&&(this._texture.uScale=2,this._texture.uOffset=-1);break;case bs.MODE_SIDEBYSIDE:{this._texture.uScale=this._halfDome?.99999:.5;const t=this._halfDome?0:.5,i=this._halfDome?-.5:0;this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(s=>{let r=s.isRightCamera;this._crossEye&&(r=!r),r?this._texture.uOffset=t:this._texture.uOffset=i});break}case bs.MODE_TOPBOTTOM:this._texture.vScale=this._halfDome?.99999:.5,this._onBeforeCameraRenderObserver=this._scene.onBeforeCameraRenderObservable.add(t=>{let i=t.isRightCamera;this._crossEye&&(i=!i),this._texture.vOffset=i?.5:0});break}}dispose(e,t=!1){this._texture.dispose(),this._mesh.dispose(),this._material.dispose(),this._scene.onBeforeCameraRenderObservable.remove(this._onBeforeCameraRenderObserver),this.onLoadErrorObservable.clear(),this.onLoadObservable.clear(),super.dispose(e,t)}}bs.MODE_MONOSCOPIC=0;bs.MODE_TOPBOTTOM=1;bs.MODE_SIDEBYSIDE=2;class s0 extends bs{get photoTexture(){return this.texture}set photoTexture(e){this.texture=e}get imageMode(){return this.textureMode}set imageMode(e){this.textureMode=e}_initTexture(e,t,i){return new H(e,t,!i.generateMipMaps,!this._useDirectMapping,void 0,()=>{this.onLoadObservable.notifyObservers()},(s,r)=>{this.onLoadErrorObservable.notifyObservers(s||"Unknown error occured"),this.onError&&this.onError(s,r)})}}s0.MODE_MONOSCOPIC=bs.MODE_MONOSCOPIC;s0.MODE_TOPBOTTOM=bs.MODE_TOPBOTTOM;s0.MODE_SIDEBYSIDE=bs.MODE_SIDEBYSIDE;const LE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAgAElEQVR42u29yY5tWXIlZnbuiSaTbZFUkZRKrCKhElASQA0EoQABgn6hJvoXzfUP+gP9hWb6Bg00IgRoQJaKqUxmZmTEe8/v0uB2u7Fm2T7HIyIrnz88uPvt3f2a2WrMbOvf/u3PvvzP/sUf/N6//i8vf/lv/3v5H//d//Sb//Uq/5u8yf8hV/m/5Cp/L1f5hVzlG7nKJ7mKyJuIXN/hPwqXI/g++zq6rPI5u8z+WqfLre+zy7PrVv9L8brsMiGvk8XLmM/sdfHXal4e3ad6GXPdyu2ij8u/+uv/5cuf/OSLfdtEfvUr+dnf/d0X//t3H/7bf/hP//N/928h/0Yg/4VA/kogfyGQP5Wr/IFAvhbIlwK5CGQTPP+9z5uPeePJSW+yo2+s/GtN30Rnv1E+f5zxof9R/lSXv/nr//mrr3+i+5dfyX7ZZQP07Tffys//8R/l/9TtX7790T/7r/8G8pdy+/8XAvnnAvkzgfwzgfyxQP5AIL8vkJ8K5KsmMVzu1U7p5PA5AXxOAJ8TwPf7sX/51ZeXfcemqnp9w/W77/S7X/6T/vzf/7383RWCX3/z05/9i3/13/0PX//eX/2FyP8tIv+PiPy9iPy/IvIzEfm5iPxCRH4lIt/c/393//9BRD6KyKf7f488fP74/PH544dJAF9cLl98IZfLBZtuqterXr/7Dt9982v95S9+Lv+gF/3i7Spv/8lf/vnf/vGf/dF/JfKnIvLnIvLvReQ/NEngn0TklyLy6/v/34jIt00iGJOBlxAsdvv54/PH5493SQCXy9t2ueh2ueimKorrFbjq9eNH+fDtb+TXv/ol/vHyhX4Fxfbx7euPf/Lnf/PfiPyeiPyhiPxxkwB+fk8AvxzQgJcIrGTwFsiAEXH4/PH54/PHUgLY7whgu2C7bLqpQgHB2xvePn6SDx8+6G9+84384vKF/IPu8iVU9Y/+7C/+jWxffiHytYj8VER+X0T+oEEBvxqQwCMJeIngo5EI3goIwVMIPn98/vj8ESaAbbtu2ybbvl8u2ybbdtluSECA65u8ffqIDx8+6G++/VZ/efkV/sO261dQXP7wT/7kX8vl8qXIFyLylbySwe/dE0CLAr65B/9vGn0gQwRMMqgmhM/J4fPH548eAezbZd/lsm3YtssNAYiqiogAAkCvb5/k46cP8u2HD/rrb7+R/2/b9Wu9yJe//8d/9Ney6S5yEZFdRL68/38khG/uKOCnAwoYkcCoEXwkEgGDDq7CeQfyOTl8/vhd1QCum26ybZtu2yabbrKpQvXue1yvuF6v+vbpTT5+/CDffviAX1++1V9sO77WXb/66R/+4V/dgkbllQi+aBLBV/dE8LWRALwkYCWCNyMZXElkwLTMeMkga/P4/PH547ccAVwuctkvdxSw6bbdtYDbTfSZBN7e8PHTR/3u4wf55vKd/nL7DX6mu3791U9//5+/gkNFZGuSgZUQvnKowKgLWLTAQgRtEniTuEfwaELw0MJvf3LQzynud+53uG+X6y3gN9kul+2y6XVT1U27JCDAFVc8ksAn/e7jR/nN5YP+avtWfq6Xy9f7Vz/9w1dgRYngiyYhfNkkgzYBWHTg44AEMmqQUYQKOmDaiCIa8TmsfmzB+DnZDQjgcpGLbti2y3bZHjRAdRMVvb/dcYU8kcDbPQlsH/CrbddfbF98+RPZfvLFnAQeieCRDC5DMvju/vmD4JkEvjRQgKULeGggowdHkAHTYxihg89vu88I5UeGAPSOAFTlrgPopiqbKPSmCKreUoAAkCcSePukHz590m8vH+WbD9/JP335k6/+tA86KxFchv8jMvhiogE4JQm8XhfKqOAqx5qRPyeGzx8/cgSwbXcUoLJtim27C4Oi93+4v6VxQwKAvl2v+Hj9pB8+fZJvt4/yzfbF9lPdv/wJnsE2BogmyeCRED40tGFvksIXiSbgiYSRRpDNDZ6BDI6ghM+J4fPHeyKAO+zX7cb9t4tedMMNAQju5V+f1uAtBSiu1zsduMrHy5t8ePsk3376KN98sX/xE5FPAnm7/782o0DiUINXMkCXCB7/P94/e87AWUmARQWVvgMuKej9t1RLBp+Tw+ePgwngsutFFdu26WXbbl+rSvdfbnqAiuA23QcBgCugV1zl7e1NPm5v+LC96XfbJ/1W9y++fgXjA3bDYXV+MuhRwSPwL3JLMFYC+HS/LU8HYrGwIhwyNOF12SvgM4SgztdifP85MXz+KGsA2C6X7aJ6bXSAOwrY5OYIqGy3d5uq4P5GhABXuV6veLvRAf10fZMPb2/y3b7vX7+g+9v98/WOBq7GG7RNAlYy+Dgkhhb+Xxp0sE8IAC4SGAP/TbgVJK/PoJPBnAiwPKxsXfbbnRg+i3s/JAK4Q/4b9NfLtomBAqCickMBjy7BuywAUVyv8na94tMjCVzf9KNcLl/0SeA6oAEYb1i9g+FtSALb/bKL8/+t+wxXFMyswqiHoK4ToIgKqslgpg1qUC0QoYbvJZg/B/q5v4szHmPX7YEAsD0CX25OwEUVm9xag1+agKg+nxQArnKjAtDr9U0+Xd/k4/UqH7bL5YsewrcBBiMJZPRAp6TwQgWfjM9vgRbgUYGL8AvLWH2gqhesCokeUmCSwPsnhs8fP2YNYMO2XeSmAWxy2VQaXeDmDIhApf33rD4PTUCuV+DtCn27XuXT5ir8VmCJ2G5BpBM8/r/dEcJb8/0lEQMtJHA5TAlqNuLRhJChhEpSqFabH3di+G1AGj+W1/dyAR4IYJNNnuLf6+tWC9CHHiAtFhAIFLjK2/Uqn65X+SS67aK+3QeTDoy/IG2ogQ7fb/dAtz5vBgrYGqrwNtCHsVfgIvwK07OTQBURVNCBFpKCOjqCHn5L/67TgTN+fpySAC56nwSUi256kXsSuFGAVyLoUIDo8/Pz7fdoErr/v17lk162HbgHvFpIYDfoAJJfW4sGPjkU4VNAF8ZEcLmLhdc7kljdY1y1Dq9yLiI4IiRqcLujb138KIPn80ejATwRwIbtBvn1cqv+2J78/5EI5N4cJA8qIPcmwRsKAHDF9WYP6mV7VmrgLuTpxYTcMEW0LAmoQxFsuvAI8tv/a/C5fV2ZMMiKg++FCM7RDPRu8ebWY7VG6VJi+Bzk35MI2LsAckMAgwvQ0gC5DQjd3ABg2HQLAPpEAlZ1Bu7VV7MGHDFRAbo3VKsTbAY9sPWC/uvx86gBbDK3D1eEQS8pbAeSgSwmhepnJb6uBv/o/PzHLzxWA/X7TH77De5j6AGQi6o0CUGfCOD2X7cXAlCFQABtEsGLDtxuOyQB2UTQBKZe5GUPXgkUYCUAbZJRhBDeuq8xBf+bgwbehDm+BFQi2IJksOocvA8ysIMfxluVcRsY/eB3JzH8GFDAXQO48X/dcIf9jyDHptIigDsFkEe066tBSETQUYF7ElDdYEBytN4+rk9UcBPfrKaZqFHWcw3i4J8/X4ev2//bSXqAhwTay6OEIPLD2Ipt8OtAGzxkwLw9WVFRjTc/qC6H3+YK/b1oAA0KuOizHfieCLaHHiAb5NYTIC9EMEbZrVEQt1xwhVy1UfBh8PUOquMizwaap3tQXfY5B//tea/NZdfhsvbz+PURQTDSGWB87VX/7WSd4KxjUqrIgE0IUkoKGnhIvwvawpGf6eECXJ7tv4qbA7DJgwpsKthEmmYgfaAAffYF3HLxo0vwNjJ0SwRWMG4db4eh1gPNm18vQ+us/0eGmxDemu/fnM/X4evq/8342ksGHgLY5LyT/zg0wM8lcMjgGFXwqIOVFJBQw99eCvF9oZL9Mfl3QwAvIXDsBRC9R+fz8x0FPBLB0xJEpwUobrfAkARgIAF41h3wQgP6QAmX5E/7eI43IxGwwf/moIkRyWRJQIPgt9CA9b39nzt4bYUWjAlCjWDPgv8IEjgLJfzuaAsrv9VdVG4OwOXW/fdoA35qAdL0BDwvf6AAUVHd8LIEu94A3K+Q+2YxaB84MOH62P//qoo38fCRDERE2zf0JfmDa+MieElAjcDPKz+mRKCOtdgGtXaBjgNJ4H2owSpNeAW/rRH4CaHSpMwnBYYycjgSJwfie9CR6mPu20Uv8kABF206AvXlBMiIBPSlB9wjBW1fwEuSb94296VCqgMaGCt/G1BbExi3IG+r3a3J6P48Gv/J0YmEYoiGY7V/SxwFCwGoE/xa0AJ0CEiV9QPCJb1OJ5F1VTjEY2/MO9AEJvj1BJTQpqLfTlGwjABuzT962e4IoKnyrdh3+/6mzDVJ4PHOxj0JqGKoy20+wBMN6D1gLWi9NQHfVP5MEEPzjGYy8BMAOnTAJgEr8HUIejRo5xrA5xkR5AngmiSHs+zDDAmMgWzTg55GSJEmHE8IvWPAoYTfhWak/Wn/bQ0CGLSAjv83SUEfKp5q24LXuQICpzrjrgWoza8xVE00CQCORdhMJuTUT/rjuls0gO4Iby8BIEgK6gS7BsGuTtDrScH/fR68biUHNVGBnxjeNyHEvQe/ve3LZQqgG3rof6cEclsNflG9J4KtaQ8WHcVBHS1BtHE4QP9OBMS98mpbKTeDW7dJwRsnHpMBTFJpV4I+b0kY/NqInVFSyBLANbnMSgBM8F+Fqfxq/h657/Up+GaBnwV9hRqc9bZ/vA6vu+T9E8KPJWns94UfTeCj2QXwCHS9dNL8Xf3Ho/rfewSeFODGDV69AU0y6NFAE1DP3qK++rdB7/1HRxf86gT376zOr99T/h/ioBiXWQkgQgVeIrCC/WomhDmQK+hASI2ARQZKooHMLdCJwGEBBXC3+uERwg+VOHZ9ioAt9H80AI06wGgJ3nQA3BoCut6AhxYwgcPOFnxuFnrphk+NIKIGrWPQtgz3b0i7Y6D5rs1GKqTop0nQX52vmQC4BkjA+r4a7Kx9WLENGeegkhSETBCrNXIMdi/444Rw1n6E96ry7OPuj8UfLxtQ78NA2iSBbg7gIiIbdDLsb5agPhLC3RkYKv8NDbS2YGsatNRAG2oQwf9ZIOydgy1MAzBkAw8UwEEIDzSAqdPQ6za0PkeJAMH3Z0wXniUSZoHvBXU2mcjQgv56TedIKglCpIoQfgwCIjOytd8WgN0bfxoR8Fn9Gx0Aj5Zgq0lIZbsH/ibSJoFnS+C98g9ooHEELI3gliy25yONIiE6pb0NfBlyNEYyENoodkKwgl6I6s8kARgJ4ZoEfuYWHLEJa0LhSBXm7kImGeSfVdoJ1DO2G7WXsehAptupSOoyrCSF904k+6vt98X/ZcM98Hsd4JYIXhQAIg3/f9AAUYhsLQKAtkHVBnzjCKhOoYl2ym+iBtvzDzQ2DLXJ4PUmbJHAVnBQX4jkxfvHhNDqAdHXGQJgv0aSDGItgOseHIU+K9hXnIJzkoGlEKzNHagTdJ6VWEUH4iCKH4fd2AwDPaYBm4Wgng4gQ9V/CoGiuNmD04AQtNGMGzSAAQ2I2pzfogY9LRh7BrbOh4+D30sAencljFu2CUFrwY8UAWRfWwGvVOVfbx2uIILM0pwDv082dUTw8hYs8L+uIWiHGpWgClnAa1lMPJogovvvbePPs/q3Xr++kgCsfgB5oQF9WYKPJqEn6G+OE3i5AqouF59FQOmahQC8rlPLj38kg1c2f30vw+XaoIX24/pMGIgSBoZqoH3wo0sIIGlA9PWcCPrAtpPB8eBf6x1o6cHra+2+tpIFP4PgBfxZtZUJfo4qxELT948D9ucK8Mt9+ccjIQw6QJcEbrD/1g340ATuDgDkFfx6twSf1f9xvuBECYxq/7ythQQGm+5JDx6Brw4CkMGT3wgscCUoQ4sU2t6DR2ciBjTgtcpenQoZVX9NuL4Owc+dVaDursYVkVALX+shjSBKBuvCYDUZjE5BdNkxdHAUBexyHwB6NP7Iyw7sxUDViwge1t+mz8B/LAvVx/c3PeBBCToB8IUGOgqA3iV4yUg6UAOxaUFHDx6CYS8SorMOue0CCJGAf5YfRhoAI+A1CvwxqNkAY5yAIx2EQmkFfeWOXi+nEdSQQA0ZHMEItiagJArQxDXIrj8nCfQi4HZPAttrIahso9oPQ/2/JwV5JQU8zw+7I4D7/sBn4EO6rjw0FR+i3Z9fHtahzsFvJgM0X+tmVH5vaYiNDGAigewAz+gyNLThnjCURQFR1b9d3lZvnVqmj9mEPDKIUIC4KCCjBXywS4N+otp/Hk3QVthOkwEKlV9PQwXjT7s/zwF4Qf9toAAzFdjuaEB6S7D1//U5FIQu2MevO0rQQH8ZmoXE6B/IkgE60XCjVoq8gt2iCG0S8L5GdxkM1cGsfsCMArSCAnrr7dzAZxCEEpepvB8tqHJ/q+bmJGGts/AcAXFOMMeTwC7Pw0B6CtCtA2vWgonqBQJFSwH0JQK29OB2kvgj2HHXAoyeAIsCQO0kMNECAhFMqCBf8mElAkyBbX1tJQP2RJ/ha0gpAfS9l+/5n00CkrQpq0MZbOdAuxmMvHswog62jZj7BnYQe19b14kxNq2D/ehX/p68HEcF+x3yP7z/V/A/q/5DA3i5A/dzA5pdgbKp3v3/wQF4Bb70WkCTHGRAA6+KL0bFl6FJaFw0ImZwm6igSwbbwPn9RMBWf3sN2JgA/BVh/Rg0kQBgePf6HglAHLFQwqQQOwDjbdVxNZjR4iM6Qa3WxwvNxh0JFb3g/WzFQQS8b/ttKcDWoABtUMAd8j9hf0MB2uDXhzX4CHj03L9DBU3Qjz0C0l4mLSLQPicOOwZoVCB6P6dA7nDbGkVuxcNr8PU2JQO4wX5trEqmccZaHU4q8oCDFOpzAnOwqyMIMktNNNAHouDGxO37DgArQZzlmp/14W1QlqHTMaIIx7SCx0+5yza7AKJ3IXBrNAHVDcMZAU/BT/vgv/ULPOA+XiLggAREDF2g0ci6xNDRglegd7P7TWWH5oJfayliEg7bScQRBVgI4Ookg/F6rvpLWP29swREqA3CaG8/FpKqS8DTAV4TiBqIqtxfzaQRLys5I0XEFIFrPbZRQb+16Fgi2LvJv8EFUPW1gGfQv1T/F/d/HBnccP7rAwnIIyHI4ArgWeGbU4eHy6Tx/EeTZIb5bo/BsMBjmjBE08f/RB0PHYBd9eVRAGY7cHRwiBf8WeCPHY1bgBTa9xKTELzEkQX9CPtl0gJiqsAmCT7I8xbjivh3JGFI+D2nBcSJQJ8agDX+O9iBL7UfG4bzAkcaICrbtYHz1ycSmGmAjJfL3CMgT3tQpmrfB7gxSzC1DnvdhQMieG47u75+kTouKNkM8c/+vq/Q7ZYjO/hhVvRq8F/9gGfhP8aqE9EIdR6LTwJ1h0BItyDqB8iFwuNqASscRnYioxOg9ApvnYA35f8e9Ohbfe8J4rknoFkO0lmA2gmAG0YK0DkB4ieEjiLoMD8wBzom27ANZkzIoU8EMHk/uo1mzeVoEoRWKn8L/62EYAX/lsB7D/LXg74uAMr9oGivJ0CNJCGD6i9DhZdQF+gtOp4S+NODRzsDVbhdgv4BqTMNyIL9SCKwL9/FGPp5oQKxIf8A/UX6r231H7YIqLML0Ae2GtrADOvRQH5b/MPE9dt9BGLNG8jVTAQvIaK5TtvvvWQgDvyXIClUA78S9Nfg7VtIBlO7cbsEYkQDMot+ygQ7QwmOawTHnAM2XUSnJvPIYRYMmYPS+sv3J+cfP3d04JYIXsF/EwMbBKB9Q9AY+BiSwFj9mzrSXmcJhFPVHySTbgHJCPvRQ/z7G/SVUETsg0ZF+i3CRoCjhf7y1A9mOiDD7TwdwEoEXjLwAv+avLE2B7Jnb+OqDpBoAchoQJskxKnss0vu7Q2YhcDv4ySeLOg9GsCKiUIihP7yfW7zbTsBh0TQfN0iAWn9f72Z56/Ax9P7j5OAH/Qvv3/QxKfk0DgDuP+R3USg3bzBC7bO/QT9Eeh9QvDPG7glBQzJwK740lAFFgFk8P88CqDGAa223YckWYhr+c0BPdwetl2ocnsfzePAWcVnnAIp6gDVhDLyfV4nqFEDPxHsbWD3k4BDkN+pARqKMLYBPzYEvxp9xmCHQQdgWH/9EtH2TIFpu3AH/cdGydv1j0TQbRrq+D/mLcX3ZACZ15bF378CG0My6Kq/zoGOQwhASDFwFbxyNGBuSxbCEhQ/uEPe/6gAERWQObCVVfjPpQX+rexxYhYFxIkgpgX7Y/vPs+Pvxf9vwt8kAs7i32t3QCP+3SPaTwIytQXP38u0PESm+YER+o9B3vr8mETAUfDrEkPI80ck0FZ0dXh9U+HRbhey0cAc2H7A4y4egoD6y8JfkBiigLdFP8v2W00E8deT2IeAKujZ/QAVKpAtKI20gLWksHedfgPcb+0+NEHefd9vB9rayi8h7J91gBbaw20MsnWAF5xHkyDUCOoXp+yrOwwxcKj0aL6fFppaaKDv6OpHR5sgx5BAlK/+fYhuP1D196o8e7lFBaKqv5YIMnFQpd0FGVR35RJCnCDaABaXBtgbiSwtICMtalKC+1JQ6bx/PLcDPQL91QFodQNKpwOgF/9eqcBxBBqRcKAAVk+ArQOMx1RYGgB6naDhlK+uQQwJYx4meQbxtNnYQwMjt/d4f3M9ZE4UOld1LAh99fbfzOxiEkKFCkTJIUIMUeVnJ/9sDt8/e1NEJOi9oVHDGYhgnSLss9DX2IAqw1zALUncKcDr0FB5NP+0cBQNrEezDiyiADPkt9qGpwoPdL0AGPx/NOKeyf3b9WJNdfcFv6bKd2cLMJVfJ6Y3B6wB9WFUfWWEwKMfGiQL+3bz9XGQz2EHKhF41GCtZyDi/gUCsNhYoAr3UNJ58YidHKqnMb/6AB5J4N73/4L+t7mAkeeP3P+1LNSB/l0SkMEd8DcEuUlguEw6t2AU/PCE/q++Akw6QFf1u6SBrj1ZnnhG50AfkoGIdf7gJv1KcSfgzWWkQ9U33Z3tHXYASKJ9e/YhU90rvD+q9Ej69/wxYJVs506Eg/r3DkMDzEdDBRGgcZay49XihLA30P+l8N+hf1f57/0AoxbQbwYaan/rBMirE9Dk+sBzTkC8JNDEUlv5McB8PP19Y01Gayep+hC/2zvQ/2HGLAurowsNGlA1cnqGGzeH5weiYLZm7h3QQC4O2tXdhvMMk1ZS5ebpgI8eMrPvPGkwaxayk8Yc6PMOBPEdC1XZ+2UfbfOPtxLMQQAG9BcZFoF0gp/RKjxe7+oAw9T7ZPWhgedodgz0gf5KBtrtIZhQAZpAV1Bi36w6t98qVfH7hqGI318lLCjLCUFlxRHwqYEH9a2qb4XjWvDT7kBwfbZA5P0+PNuRuW1yf4yNQH3zzwv6b70QOJ0G9OT/dhoYRUGT15uQH/71MjQLtQlxfDuiCXrtM+SkA+icQdH6sU/xz7Ze7FlubV4TpoTQ2osdpaEjtqADmEU7OkBEFoLeC3IWFFeswJXKXzkboNL+wzcFHU8hTGKIboO7CLi1/P+5F+gydQhuvRbwEgxvtACmANikhLTbj0gCYk8KdlYgmj+4Ymaod7TwahwadICuX0Cm2fE5iNHPK0x/CDV66Kyg1MnqjNFBnhBoLQCgUULfaVe5nq/6EQWY67bXCszUb+7232fVPz51iGB12owK9peyP1T4raMFF/OEYJP792mgXYfZ04GHMAhBkCSmSj+dKqRPgVFGHbpLEGMiGFeQWfSgrY52VxaeDUPSNJI0P7NoisG729HHl78z6hxfs9rV3m4JjgM/lsui2qmThjCfDFSb+I9vwUqG5wwL55U7C+6ot8B+7N2o6r3q37T9trfpjgmTvv7PSQATLLeRAOZhIJHBQfDQQJPBdUwEbVW3+L08EcEE/9G4ANrCeWcnPKRHDupbNynMx5AA9IRYLmrc/YLSiD5EaEBS/s/TgnU9ILcH19n+CpHwegLejx7Mn/d25fdN+e9U/1vgb7bqf08MOtf8EXxaoh+GY8L6gDfhvs4i6HQ7seYI2sv1GchdMsBIG3xlvxcCRzdgCPTn+6q/TW00VE8Q9FaFv+R2VlOM1vm/hhjhDCdgNflVKME5B47I9xT8z0YgPAJ8myb/LqHy36j/Mwqw9AALxuO1JVjiuQAYLcFzIhiEPe05fk8tRjGw7yWQbsfuLAT2VqOId1osnr0F49VM8INACPHDoBz4B5mqqSnUgyh3ArjXxfQH5BbgUS8gP7aU+w0zHD9GGD0CGHf+P1p/DeivlhU4BbxR9a2kYFR58YaDZCUR2P0DMmgED2eg77puegy6PgDphEB0CwlG/i9d+/Hs34pBEQrBn0W51mqGnJAk3ACCHeiqkQ1XFQA5AlKH7Lk8yJKWY3/nym14h2C3JvxeMwD9ZVMz0BPMi1n1RbKl1cYhIVblF3G0ATsRiCMUvoK9//OgcwYMoe+ZKOLlC6/Xk50br9NFz9fanqA8UIYSpCwlBO4kHc4WLLBfBHVaKwKgLQjmP4Un61Vq+3s7Bsyi0WztmLjJwJwFeE0I2vD/1Q6MVwefxfUf32skCPbCnxQqf+QMPEUDHZ7vGeyj020JgkPXXwsldA7SYR1RE3h94NvNtugswcgxXEkIcBPCGZ1rmrgDC0A4K88nm2fn/eTnpQtWyZfybRoK8Dro4zYDIMGsf7saTBzvX0SMbkAD6o9CYbsfMK38cJKD9l2FJt9/VGs0h5Gib33pxMKWNsigFUh3G2un+/N1WUglI/EEx8fq27vUNnwsiOoKecL7kQS8VnWAGCFUgn6dBtQhv40CmIYggwK0uwDHRGAuBXVdfwzHUjZzATLMAoyJ4FmBhzaWBlrHld9CCWpPHRqofBqMReMGTJ78q9rDes1Tv7/0m0v0AFHXNR6P6g30SHivin7V1BOhh3iWPwvps/yE836L2XiwnUT8x2iHgfqhnwn667QHEE8oLQjEvtEW7GYBZDrDVkwNIO4G5GiBDf9fGoFM6n+vbEtzXwP6u9AduaWnGYSLAlVdl/AU+ikrSeEIKgwdaZ4AACAASURBVKj4/wtgHcHtdO2nWKcBkPfxcvnNQvsj2Me9f02r76T8q0IBn9OLKfz1HX8yVXQYGoAB/2UeBQ5/5kCL6+H/OGGoRnLSwdd3oH8r7KkGTbgIxEwVWvnF8KOpHnyzfF9Jod5Px+IF1h8owyitDw/XEgRb5bPqbt1uvn7qBIQ16vtS/u+DP3cR7CH0WWJgd5mTJKYgNzoGjQrfvu99NDBC+bnyW1x/qhTatv2OaMKgJWPvv5kwnMgxHYGFRtJW8VMl3uP+MgoqSZyWFKr7+KIDw1d6+IiOgZI4+d5iYL3imzbgyO+tph9t2oSBxOM3ugHtPoFZ1LM0hF4kXNEBssvVgPdjdXZWK7uKvyS3q1Xb1WQwtVDqSUggq+Vw3t56JA2cz7PXOwGNW1ecwxPhfe3QEUsDsFaAz8jg0nf+iZMAHNg/XSazDuC18Iq1HBRrOsAQ8NLB+16g614jmuSgs3bROxE55D+WDDQNA4ivdMJ9M1b309UqknaDU8ObV9/PwmMPATvTMAxpABLBzugUtV9bLdhNDQA+7B9tQJ06/7QNDHGSwtgZOCIA47InIoDdROQGtt0U1HI3GaoUnCnC/rzBMQJteN17+VaAzYNA7e+PFqHQUyXPUYB7iQYa5ZFjq1Zqpx8Uqu/XT7+6BWC1Xaj0GlBIwMoHu7UzcI/6/Acb8KIq+hzmGWmAYnADrIpvKP7TZeLaf0LAeQkGgebbq9FToI44p654F47tekKkI0L5PQNZPsDwPBpy/ni+wKMN76Vav4+2cFZFf8+JwAraMt0DFB7beA/u4Zz/a+RXx0M/ct4/jwaNAS8G17eSwmta0Fhx0VRxJkHMivso+onMXr+YwdWKbgioy1jp4x4AzIKg5lEA7wvHEYCRmdx11TAuT6lDLVl4KvXkAET9P4RT8H2u+lg9EPQIpw+/NpJ7RwE8HaDv/Mu4f3OdNkq/EfAiEiOANjEALvcWL9gfFV4NZbgbQc6qPky4Pm35QZxtH1f4j+P/jXuaYPcWwIEH/fmEPBoAO4m4LGxV3txOQqDU+dXgey+UwSzuqP++uImO/u/6ogCb7wTc1n61sL+vZi87rxnrNas+giTg6QLzaUCjIp6JfhwtGI7AjBBB9JjDY4ePYVR6ZPgN4owVv6Q2N5hhVHwNeYrM+w6dN6K1sMHZm/Ce7bHe3dzKr1xw1w4JrSQMZtgnoQHlr18fzunAszD4qurNUg/TDqzx/lfCaO6t4tACMUQ6P6htWjDPC1hCoZ8kpODzJ70MUR9AODcgwyqyPhmE+wfHYB/hvSqt6qeXUShhXH+d9SR8DzrDaZZdpSp/HxqLMQuATgDU/qDPRgOIeT8cvz/h/XC6BtE7ACLOWPE0KIS4UUjmZaJ2grBphiWgT41BUVWZfP3AnEIT6OrfoF122l2rMycBoU5i/OXoUZ4/aglsXwLzHNU++FVF3qikOj5HXm2PBitT1WuvJRAB+6O//W0/PY8vQH5IrAsMs/WuVmAdHBrQgrbOxJShXwRSsu08h8JMBpo0+aDTALwV4tbswgzHrftG/dJKIAQb5h9KCssWIMeto+GYqG12/HWGjx8kzqNJaa0noMWOr2KwW01AMwJoNvhMQda2/RKQP/3ecABM3g9uD6BY68Ntz9+nDOMb5iV+hIE+dP/Zs/wwJhJ9mgBnohBuStABUXjugF3hkXF9ZZJAjefKdHZCc389LoStKvIl7QIEb1d9RyciQgFDI9Cjyccc/23Aam7/PZJBhgDgin5CtQvbCzX8ip9YgIFtOAt+w0owp/hOiCWgEGbVHuYjRigPGR/YOnEoqPDoV5z5YqB3mRq2ox5ICmSSgAP1Ne+XV2NE+/vuFbCTRADxtS70VRBCjgBk2OyDUQiUgfl77b7DwaHm2rAZ7osRSOOUoHgKfNBSLI767+oDYrfwZvqChSpGfj3pFwZFsCJg2jeIQQBUiyI4WgD68ww4qO8khuWkkIuDrxWv2nv+UTBpJYiPd0KemTA8qqFiuUF1jWS3BoG6pADJq751JqBI0wvAVPyMQvjcX1zbELltKK+zBiXRFiRxG+b7q3M9xuLdzR8g0gCGNzSM5gNYfqGO9CBT8OHct6oB3KsSDBisUnwsFuISQaRHxDSv0vptt2oeLHMERfRn/FG/Cx01EpgIQG8LP+/i37PKw53xn6sYCM4/JwSRrCnIeB1ZkLsawDhaPKv/njU3wnZ/dBdGE8+YTHSG8+ofGgIjsC19YnwdM/KAnTSsqj6ig7uGgIPw3nYFzhhIIvriAxFP9CQd4HSlnzgxONIdrE7A8ZDPx9fjib8ifgegNIliRgdx95+E1T7+3nQVNNhEzDgGA3T2rEDLduwtPpuuouPcs8swwXFjdTaMKt+jA5gUAQPcf95KJQxYU0cYxEDvsBSmYuukp7AwnqniC9Afa5z8vboI68ImT0t26CvwBzSggkj447r9IojvCn7U92J/Hw0QSdwZKNNjxPCfSxRqnATkdwpOwh88oc4J8KTSm/wdbZjrc+4iFP8YO0/5JJDCfaijK5xVXevqfg6zGRrQf83chvX4aRfAE//6vv5+6490U4ADdO7QgM/5bcHP/n4OtCQhBEFeDWSvos8DPq8/IwzLzjpa8/U6MMSkBklDm8e0mn3QIY7XG1Om8wzN48y7HwhOK3P0/ZwUQHHv4psbdoVeb9VlAjChBCdtDDpOKTh9ZfcagOYq31RFjN4/gwBYzp8lAwYNwBELhZoxECeZxMlAzWGdCRV0fQWGHo8+8Kx+AAxnCIzowAxy9KvNepWfsfp4RR9kUrD88CPVTuXRybhqqTHcnxEGndsgub1Gdug8yz9fHt3Hpl57x/mfCOC29FOSQ7/noAZR5W3Ob24UMpuPYAYiQrQgk1gnFoUIKr4vKFpV15pHUJO3Y5rfH3UFHU4bGkU+NKJ9f2hJyOMxDBDpjAgwiYqvk5TqNl9EH2Arb6fA3yaA4cBtPWewhkEcIQJBlGzYp6zRmr1v+e3Fv27xpzvyI44NGDkCIi7CGNV9Dw0M8NtHC2vUwHINumCGNG8erxOwtQINsW88Tlwdoc+F85nI559ngEDpt2F/Uu3hiXYrkN/pBFS26hYDAkFgErMK67y9mGBA3L5ore5izf8b3n805MOq/t7XU4WHv1DUF/5gugCSOAIW/59uMwl6CHWAib8bvfxWl9/rBGEMTTwDfG+ezEYG4yk6FvRPuPwE+wvc39IRjENWM+/cm5b0W4Pf4WuKUnw/vD6eDbB1ETs5vl77Dhnm/51g6wPWwQAqxnivgQaeS3gy/u/1H4hpTPrIgHAN0mSgXUX13YP5PMIuQAfBr/f70cdeE+QoCX3i8nFMLcAjInBoAIYqt1LhC1WdtvmSab28AYffaeivCB+ohdYQgfUa/WS4ToMsNLHLc9nnvPZLwn1/EefPVf+U/xvnCVSEQEkEQEnEQJO7S7RvYDxNeNYKrG7DKMhtsQ8cMmhgPKKKj+F7CiHYFR5KIIPxOmg5IVAtu3ACQSPh7CzUQOgAej5CWEkIe3vgxz0ROGO//qYfz/dnLT+ZxDr4QW0eNCJBorCFOVC312Ec2TiY5Bk0cAaQmiA1VH1MOwDHQ0kHdEDDf+2UTWhS4Z8diQMicLx8MLBfverLcP/jQzF0P8EJj5+NGK9RCz755S6F/f1+X/gxeP+Wsedv+vF8/54aSPJYFjIQd624MDz/UDLQnr8HU3ztKHRf8Qeno1vyAQJBaLcMtTV3cvgP56COCqd/QP9xLgBkH4BxO13n4hNUDtACC6G1S3zqooZ6Ba4lp/zcAFb7iERKQwQcF39IFJjdXECGADw0IE4gg674pYAnk4HoHPx54tD5daO5vxrugSkMjgiiqc7TVKAT6AT8R4ckbHEQCYR/IZBxJgA+XZjsR7vaoRpIxWqeqfXuGC2CxwudicwePEB1kNkaZCuwyF0DuKv/4sz9mzP/Qxdg3BDkBTMC8Q+loD6UGBzx0Kz6eAX/KArOQTlPHFoI4vVtf4rNuLrca9edRn4xBP7k8w+9AgZCgBfEUZWfEs8iFNZ3UO7TqmkjCO/rWdgco/yIqHcQWaC2EGTzgz5y/iXQAvyx3riyxxV/JeBriaGB9OrTA5g9/eokM+37GszqfA/UZk9iW5UnCtBqBl3XoNN6Ag/+zy6A5evPAp+TIFDn15gQw9rjrOzFX0s2JBVAxa/nP1a6AsNWYGjPNGPLTQgBsNUFvOA3Ht9o/rGDN0tWOCcxJGp+f7++kkP7PxcGv1+GjkaLt/fawpwwerQxBJNW4b+PJsYEgiAYYdEAGIlDNaAbRkIgK3ut0jKByp+8yz23X6GttmBmjwDvChgiYLP5V/zhH6/110sGcKo5CkggCngxnIPoPja0j2B+1BRkiYJiviaLJqghDI63G2nAgAxMCuDdnoD0wIQm+urMB3VuAwbBrFGgGgnhAFqg9+ujKsLxB3qGCQNEEtPinIQlAj4WgIw7/iXc9V/x/yUWFs2KH504bAh4aYWf4TrTLGTy9YbftyLeVOWNfYNyt/ji29mQnqMAltU3ioTtbX343yv/1u0YPUBz6zB702tQucnX0gWaFh6DgPdmhXaapGotw0SFz1qDiTMdd8h45HfcqCPRUhA3+NmKz1l9teCPaMd4urGaewRitNBDdahR5c3AfQmDCFT9vmtQEwqAYXX4XI2n23Z9B/Yb1FL+LWox6wHGbZSo6FR1LzyG+3hriSZvWT6jfXhl2cmQZJDrAbuYAqAHo1GA/EOgD8eGcU7A8eDvH4fQBuAhBL/Zp/vamPTrRENDGLTV/7E1WEPLDlP/PwzU4YhusIMUgfIPAr6Dhv5R4y2r8ldFwiFoYHnmr8TAHbhRQSZOctH598ZYhqt6wP7q/ouqe77RJxvzFYaji/z4vna4v5cUMDXqDAJ5ytktqtBDckyjvJg04hl16LB0xFfyMfD77PZjErGQRRjYIfSvoAXntks0ok8MsUC4KARWnYPlJBeIgLeFrUgDOHYCag0/XNAbWgRwQuLAsaQwIhC1g7+jCNKuT38JfnYSyTi+QQEwwHeT4/dWHYxJPxfOj5oAnRQqgU3YgGZSOaDyK3n/qkDYBKptzR3oD6B4fyRKjp2AzSl80YR/3P+/1vBjX18Jbu+YsrMRgbqPP8zrDLTAaupphfeZtyPs9BPztpLSBZjowF3woYRwBwOWaqbev15b7X4RWsiqYiY6ZkFEIoUwUA2OrkeEQE8HYNyD/rl3m88jCGgO/nPW3xy8x4Q/HBcM1dYg5q8N+B/SBSYhtD0EY1PRGLDoKIBHF3yLz4H/gSYQJRETgqeB2d4vC8L2NVnQn4PoVJJAcP0inahAfdXVI8CFszjRagCTtRdV7Sr895NBpRKXIT64RMFw/iw5eChhEvmmyUIH+k+Qu3cLzOAN6ILlFvgWnx3YWFDz0f38ze9GlfP6UQ3ojEY0gtqRIEbA5/WgQFhsEuIeL75uTzvqHktAWfj/OD6sQXssROcGiRgFn0QVkld7OznMDT7CJKzhMIqxW9B+LCOQdH4uyxIcE49VTSeLj0wKjzcp2oDXQA8YoDEGBLMW0BJw+eAxXejPV/IXd59/tp5rVyYXDw5BlRetSpQAcvgfOwVM8ObzBq/AQ2wX4lwkQV3vNhYFfn2LFgaoDU1ogqsfqGkJYmrj9Tr22KQwBLzbLuzDeA9yzyJjVRfwegWq0H+FThDPA6ZhZwX2M2Kh4waovCzAWJTzD/qY00c+6PM8coz08VNqglzx54LfHuTJK7z2rwX35ABLg1DzsZ7Qv7l/f2yXDlbf4C/irg0MJ0aCuD0wP74MrxfdFlX7tq+vtRdCpvt599EG9Yz3V+P+Oj/n4zLruZHcJ7oMt/MNp9eD6HEeFb6/TMfbWo85Pb79HJo8t3371/PuIAZqMvjPC34nVV6ZB4hEuA7AzA5cfU0y2n6ux89D/35/n2/vWY5Bf0qwf3tPLISO1Tap9qzFB6eap/beqI94NCCbGwgqOItY3CGl446CaQ8i2Q9g0AvmgJOnBoAA0gu17tsKtKS7D4udgCYERy2QIceCX/P7mBW+g/7D9S6Mn50CS0eAoQPDcBjopIA5+EcxEjLweRjXq0UbLIjcBxsGx2IZvlf0ATjz/6qypAmY7bhrk4ahsIis6ccXKHdueAfUgk+RWPCLh42c6zEeKyJpRTdRAOqBbl/Wq/uT+q+Fx3FoTIuCzc6+hN8j4veGjuAnhSE5gKnco3A3XwYlq2sq+lmP4yEOpqEoG0M+mGDYuYT0pKCFHgLHKt3T7T9p8GcWH+n1UwGa8X6kQt2x4CeqPexegT6o/Z4Cr313PHdgrsS2ZReLfpKIf+IMFnmVmwxQ9AhithYT73+p2s+JIVfrjwiHnpAZrSsr9CMstQXP1+1+510N/q8E/YoekMN9OMFvi5LvkRDsy9rgFCOoPdpgaQIWBZjf5KCSQszZJ1ivTvLokpen6tsJAVND0NFqb6GUGg2Im4Dyx9Pn7/0dm4pADAslJzTv+dKNrAPQ0wyySm7bj1RQgbAXsRa4R+mBJzpaQmHLmy0BLoL+Nh2ZRca8uUc6P37k97n451fvTieAE8BdZ2ItqFEK6oOJIYPsiU4woo140Oh+H/UC++gatHYcOFT+2y3AYvD1rM/fpxdUcsAi70c0OxAEP45X/hymE9XeoC0zfYhbcqfbhs09HpwnKMDR6g0mmYyKth/UcLl9ITGQ8N1S6s+gA1HvQCc2pluPvN2Br8SyZyfyxPP/VhCi1L1HWX2CQCuAE8TIq/sBYdANZmTIwqq0sb0HIzhhugBeUpBZLFyA8y+EErsBUYDZHYN9QAAooQwOws+uQlhdESSSqk5Qsh8LSYI6LDS1AbmOvLlRBqQIeITvM36+TP63VfE5hFClCTr9zEyVFwS3STQBy66DMHB+PJWIrfgGnYBx2dTboPa2X49GaBVlePA7CFx4iaGi4ns0aLVjMGvtPTDtmO4XEE8E5Kb/8qYai+NHl60LgAICcUCoJPVeiYG6Pxw/X9VFNVbFn9FNPzXoIRDTyzcpREYB5Fm1EQQn3KRi9wKApR8Tz48SwxnV3qM0q7ZhpdKvr0zfY+gO4oQf+EGPFYW/Xf5hwWsUgxiBbShGoGIx+D2eH1h2EeR3UQMH4zMaUKr4033nzkSkfQADelFbLOQCalxdxvN8mInhPas9bxtGJw29Fx3Y8429MAS0fL33Oeo7qFZeiToCC3B/VSNYuU0fgDnkhxGgMFdxiYEY7MYel+OHPH30IMeVFK1C79l+QdXVpFqHlMAXEf3EYDyfkkGdNvJ8f3RAXU0jpgM7jMNA5yCrtfzOicKG/M9bgEkEjqqPPDEcDfqVwGZv6zcO9avDfOhf4OmLFd9OLBHHdxp51HvOBlnAoQksYjASA1xnIhPsapTCPjbsGB2YevpPpgM73EYeSYIftgPgte6CWesVBB9QEgfnWYMgoeC8ql69bWoRIqYHvSIv/u26bj/jdqZ9KSGk74JRo6QS9PuTiSHm6Z62kLUGH0UO4rwWrhtRETkR4iKRdI8giJ2D2nUCMjsA0TXiVDb98NAf/rCMlajA9wesWHZrAe1dlwRyVI2jx4KkyUHSx7YDe6YD4tOC6XW01puEdAJwaEJzf1uATHi6ZlSCpBQscsh6C1xRcWEG4bCFeKcAVhVlDu54JQIkTT21hptIT/Afk0kMcS9BKfjBJozcDXCrtgbWXxbMAw3INQIxtQJPAGwXmYaBbYh4SCsuKwLOAQ5awKskCMmRg8P3xwlBfbosQaDqyZqBkyQe1CLQACoTgN4qbyHsPwkTiF2pYaj6MAXBmUosQHnUEYCsBL3MW39SNKMJ5PfoBsT33DVJCEbFnBCMOkHfvj6Xq8uw+dgRIhGgAiUqf5QgKDFyhe8nnYrlqn9sG1GoAfirubygX4H+8IM1CmQrMFAJ5ExzKIp54nPoVU2Auh6eBShDlTV4u5c4HE/fVvjFrsII0Ik6QX+Iq68jB19ziLoKC27FYe0gC+j1RSS+BgB7AvAM3m8HLdy5fV60C8RMVuhD1ieQB32MCCq0QPJuvuw5IHF/geMKwOPdpmsxBwVEfGEOgeincJqNmuSFIPhPq/xM81CWIIi+gCFBqDX3QPYd2OcCRo6GZBoA3AM+00aesAOQ7/2Pe/vBCXoguD4OBD1WfPwClzcui12AuH+gC0gEwW72KfjBCQRBr05D0IQc7N8PzOCMehPWK384MPVDJQim7yDdoiRTItzzFV/ZOX9sYFetP0fsQzb6O7wOoFjxk89YoQXv+BmSN+yYHYO+BsDRAXHhuJXsEFbdIEGZQWUkNVNzGA9NZUVBIQL7jASR0AclE4Pb7JN3BO72mG92+o8UG3nybj+mASh0FsLKn9GPxDrEcS2Au35BzHO1BksriIJdpqWjKR1wlpR4fN977rZqI+XbYjYDgVDpcYQalOYKMiuQbB3G6Pu/HlMbi9a0EMkksXtjvvXTfgMKAEZRN/i/O7yD8Da2S2Bdh3ICWfp8yuMkYl5a4df4vVWt4UF0yyqEnaT6swYyWB8/j111Y1ERS9oB0SLMtBGDEBD1PEHwtdjUEAHnqmoHU4wCDAoAS+lHwtu9eQLUAgmxVvAuMB9cELMV3m8EUtcBYYI9nkNIEEJYrQeUHfnzzRyC39j8CgSkir/E0P2odnAmAqDnDIhqrtV9BDNS2POjv/0pwKr6z1h/PMz3uf9ykFYq9TtoAXSwpz0HljdvBCVAPY6t7osv6gFhMpkX13rcfXQMIpuTsfTibkfOPRAC2meLRipI4mDPwMD5x+v3+Ey+qEfACwoUEkKQSMZxYJDz9R68PyP43yvo2aYf881rNQbZgRU/jp80QnW/hdXqJxMvCFxXQSNHpE8QiF4XI+wFfQcw7VL2Md7RRajsKgh2D+6SLAKPF356+/7yXYBTUgFy/38StUjFHweD+iiHh8/LV/i/TSvGk4L5x7F6AsIKbgb4C0YjgdGRIToGUx7cgS3JKP8pRcgak95BJGQbjaJdBYQ1qHYnYHL8F45QgHx2gLMQ2cDxBD/4SeR0LSDi5XzPQNjM4ySE/HGG6g+ugltLNSARn281BPtNO72eJLjdX4ITSEgpQvJYFEUg24f1qAYQNQdxx6Q/RcB85j9f+03zf2QV33IDPHegNgPABTfqFR8cZK9TA7/ll0EQbUUHW8Gr1d+MSadia+LRHwhunv87yWoJ3h/pRDwJAbDNQQFd2P2mH4kP/wDT/ZeN3CK3+ZjvgVpw4r20AMafb58j4N1UMknuj6iCx883PU9g2VHVH5JX2eEcPghSgRBCKPzK0Q3fknwPN0Hk0CyC0zBkz//7duEetgFjVtypASDI4CsknYJgYDhqsBxxy29+eyxrAZX75EEf8f+CkOcijMDDHx4ASYGGu8WHgPwpHJc0qOG8FgFTuVk0cRZVePFwHEIUEu8xSHoL5qWg4I7/HgOKXe2dcnu2SSdCGIDTA+AcxY1zYL6Q6AAFu+/1GvjKPSeEoJV3NiM4Dz9C6oWkEav+NWjPWXNOIkKgNTi2I8LeBgaZHJxqrC4oNXoB9pzzMws/OW3ghSyQJgjbygOVEDhoj4nHLld8HPD6UUMFVLIgKrTL7cFoBRLQgEdXIseZ2/HhFPKbk4d5tYWwwR0nIFQSD2P5gQhs6meVfB+Bkyz2fOIvX/zxqsSODuAGIOLtPNnmIPCrv6Kqvgz3q4tCwNl9lWYfnsdHj2HTgQw5IBHwULmfSu1jEV3gDFSxTBmqSEVqiYK2IkWcRiAkwV/cyW9YhqHXDw9dkNQAcO6HFNJT7oChfrPUYc3KY17zAd+evAwF2w5SCKLV4EuCEKsKfjBVWHu9Q9Arh4CoBqEMWYBsNX7YgKP/69uC3M7/mOOz232QT+ox4iCyJGEFP4oBHd+GVvXBwX35nqp7qeIbV6L6tdZub3ueJ+gBIKgC6S5gOQFxDoGr+Bv2nzqbknd7ph/EmXzO0o+kZdc/wqvQkAOUffVMzKtYgx5Vob1/+HAfCdzHSiXHenX35/2JTr3KZ9Ruj2lYiMhLIFoNyMq9hFroeYMTE0bSLbhb4l3YlFPa6hMd2jk8dmrDgdQCnC4/+ANFlYTB6ATlx2GDGXP1rvL+SnWHw+cJes5/rRWt4H2pw9GklD4uSMpwasIQiaYR92gIyFX5S8dtRZt/nCAH48VXW3hRE/HKOsGquj8EM85Q9cfeAV4XwNGAlmIFIwPYrfLKuxV476RRetzcdeAsRSZhiHizCKEIOHn3EMOWy5X4uIJnXX6sFiBFLaBm/THOQAkVJK9j6TKwiSDTBWpwHkSPQJX7U959uAkoaTUuug6oQCBz1Zlxm0OJSIoIw04M+7zCGuYiznCfHww9AN6Ir+HXA7lfn2oBSJ2FOOh8SzINfmcAyITq8JX/sOMPx6A9LeYtVfwgCBZhdu25OB9/XmWWNPUEPD5dUuJ68wd1AqD2+w1PI9KxE9BW5t3z/igdYGWiL7L+wPv9jgVY8f0ZcbCKCuLAHN+c5wa69Zpr0J9t2KnpAGzyiAIPiFalJ8/xXrrA6Y+/8NoDnWCPNwFJzf5DpVkHte8hx76P+HU1+HEytEeSEIzAsu5r6wPJGu6oLz8VrKofXLce+ywIHhNa/Dmw8LrptWXZ4NKZm4pr/QQ7Qk8ehMrPtAF7PQCD309QgRgRZMKgAbFREAfBBXNalbHA9cEHMo4IgIUuPjjBWEUFEQpYTkhVO43eRiynJw9Jjj8TOUIlJExK+0wA4gWgQvcFBHAc7P4/u78/Ff4CC5ATB3P3oUwFClYgcALcxzp/B9Ez4DUV8RjBbsCBrMH4dLNwIDaCGhA6o3pXksdBvYBsktrXDgNJKAFy1Z+ZGIy5NXgXoBT8a3ZgVSPIUAMV6DjLxhsV8wX4n4ibbONObHNyCr8Z4FinNFjg8ziiF5zSV8A99u7Zdf5OisvVaAAAG3VJREFU/kIPAJLWX3hUIFD6o7MD4WkHIMXBk4IftSrPNBJVk0OoC7ice8HGS8XBKDoz/YFBLaQi392lGpCMJfhD9xVkx5Xbj73P9V4m1j0v73x9FjDDPlYvATkgFAVWcdNvJBamliOjAwRV0EpeRymAe717kMYRyy/j5FwFBX0fP7Dyx8gq8wn2ZXi8GfGYR+lFcGJSxa3Y84WgzBHetlU4cvKY44Ps4iP9fsgsPGEhQTAcHqwwGCj61SoPexKwasXFqtxq8qhD9SixoBBYcJEDNzmIoi3J7QkoJActVHocTVpPBCDhElAvMDK1PT/Sq3DwB/ygmyB9GNhYDH4so4Foy48kkPtZfZEv1PQTxYpyX0EI3Bu+/5krcN8fgwVdwWu2JNVNWAk+PcOOPMNdGFyAZ5Aj6gicgzNfwuHZg0HrLxBWfjSRl88fVCo/apX/IBrIvf65ZxtEoK9Bec4KZIPLe76osQns46NwW0pUPCPAyMc4A/KXOwZzFLGbAqD5xhhbgBcWfoJBAlarcCSQgdQJ+Movnih4gjZQTw51rz588y/ZgxVUEAQ8soCfX8OR26JwujCLGFAMsOjnwGrlPuQw9D/PPv8BYVR7pG/eeFtQpsLzR2KFI8SwKj9KlX++HeLOPuSBKrKeHBi7L4b+Kx184+ptAp4Trcscv69oARVYzWgaK01H1X0K3zNSmARKtxXYHvwJuT+8gLGGWgpHcWOmBeljFB2Ckg6wiAYOqfxEK3GMCAj6kIiTWdCBCXhkjUKMgJcLk271N9uLSbtvvK0S69OXAvoA5z94VsFubbmZvx4QAnXgBnJxENyQjy38wef81uPhxMpPJIQzr5ckuUTKe0wZyN57iFTWga8GvCwlh5UqvYgmaNV9XSxEVWs40kkosFwA70RgNOu8mLZfR6wDiwRa35y7j08NksqPQhcfkRBK/J8R75Iz+9C8gJpqzwiIeZII3QnYOkJWbVEI5jNuA+o2BwK82ifwnpSgHwaC+GNAdmW2VXfC+vPu6wR6lBj84C9WfvivZyUhZMJlJhjSukDlFJ3g4AvGJfC1iEpQJ/CaEd7G9wds7p71+odruKrHip/C7RdsxeVjzIxhoNkFGOW/+sk/YVAGtltfzZAIfzix8gcHhZCXpcGN2u69qWqD9OlRFAy7x2fQBhHUiETB+DocqvArYt98f+AEAXApsEmEcNLC0t2uPHCqPQIXwHYDfI4/9+8LMpchqr5HK39MJSrBXwnutNqjovjHFdq+fcHLp7YLR4mGgduW5hFpAXUoL4cTTuW5HJSkB5PC0S7A+8c+837DyoM1J9iv/po/o3BunlDqPjOSO/YbLFd+FGy9sxKFeT8b+nLNPrkAyD53FtT27yUS32yqUaEGTMBiASGcZ0FmK8nWxbvjC1q6WQC4VdWdAcBY8eFoAzIrC0b7Wt8wlPcIdE1FhUWeKU1Igv8Q/0dl4k/NnYSxdlDon8diUDeuQB4c8XVzcahRgyyZmNC+LAgeCfSVALde8/t1DCYawNoePGT83wlOpFUdOZKwxn89OsMEf0X8CxJCBN/dwKbFwkSMgx0ACJJDJD4iC1JEYh6XcEqVHpx4+J4I4UiAl26r5x64sttvSlAn3LBuQCz6edU8C+J5epBrC4YP52EFDgHrCw1B0eU9bOaTgh3wmYvQV3Oqqcf53XnVNXUBELX1xtSgFrirlII5d3HFulxBCNEfZx0h7K2f34XwdHpuYQcguN189Ow/nPXclaUcqMH5leCXjKOjbv3F0a7i2ZaRHmBe5zwnhA9S736ZC8AH8LHkg/T5znYgmES1dtuzGo92qwHIquiWX+4KgVLd8utv9Ml1BQNhEJW/FOgweiTguCUoQHkEwYhjfQIgm8eAzPKzHqAG5xGiiPyxeGRRaYetUpDVpHVC1T9bHGyaknb/TQTnuG7rDYwYCUT7/cMjtILzA+Go/FPw581F/mWeTkDuBsBCAK8ki+A29nMzPn4Rzjv6QV7xWW4fzQFUxb9jQQ1qc28kMi4mDl1NBr4usIsz5ltZqNm7AeJXfuTHd7nioLEyPBISU+8/tP1AC4Il/n+YGmjg2NiBRdl6yCw//zG5ph7bqaBuz8B4VMU/TqSsNPbwCeZA1cdxyG9SgKzRZPL+GXFOiH1/SFZ9wX8M3zUgvH8a4rMBjZj/h1W9MrwTiN6MlsCKiI4gycBzgV/xUaQGjGDHwHiYi0VIzeEAasCpNuL76AC7BIEl7i4AIxnAfoMxk35eJbZ68wWEUChs8IPz/EEE9BkUoNA4RCWSLJkY1h0Y/dG9bVCtUVPe7QRhtStXG4nOECDfUxc4Uw/Ik8JkA9o9+a83IrfHH11EdFUWc4phNgVFWkPsIHBnCvCCYBSgqEN9qtoXuwHhByYoJJA7BxIkkRwpDGgAHo+vQ3ZGOwCFJCJKUAx4MBpFZWvReeLgtBBkDDQu2OJxXa7SE/P4ZiUPHABjY1DsFIhPAaygWewiXK72hHjow/k8gCL6gKES8qcDZ7A+EhYlWCPGCX1wXIwzkQEKt8cP6iqkC0FEhFj/ZYtvXCtwuBLcDT5wXN+9H6ZEIkTwV/x/s78fXFX3siWHEKrC3tw7EFZ31Ll7ttknQyEMGgAqCaVe1bGk8r8nFWCQQR0h7CY0dsU/mIeIuA1AGCo02Q0YVXxub36sG1Qgfo0CBBUXxap+ECFEycQVyViBEBFPt14TK9rZHB9EwMG7DPXOv0OVHkdtx7OSCXfb3av4CFZGTwQBwT7/hKPHE4PzpJ4L4+FM9r1n8B+B+9R9I4Fu9brYUZgCunZWNxdQgIs8mASBQ4F8hJpEiaf4GPihk8FdAxin/kybjZjTj+mAQy6ihZ9whDvHAWB6BKrBXQr+5SBfqPaINwiz12UIwoTmbPACZY/fshBBBKNlW8ZCHwH/cVKSOZMm4Mxk4OwE9JeB+EFkn1IzcPQoiSB4vGgNeJSoik1A7m0TCmE/HrggB+/1M12C1Z18ACGoIeH1pH2IhAqFWgBq+kDFEWAvA3X8tpW0cnSD5WAOriOHhnYraF1eLTkS8P/QsHUBdtMPnOrMaANJE9AZiaKWII5Ue/8PTHn/UcCSTgIF2xN4zdmAQYIAKeBFl6FiO0aKfq5jcImHfPwTxcEdRmD3LcFoAva1Hdjm9UgGggI9YOoPkOBYLsT8HlG3nucMDGkOOJ8CkNOELdSO7D5qqAeJYBb2GpABgRi2gxLITgrOQ9C937HgB+0i7MeRx3gfPWCXLtgbLJAu/gCFBPzRX8eADJqCvA3FViC/BlOQC4LZyrBq8BdQAOUKoKjqR7v7EFfVFMojPgEoSlJesNIePyLHwW9NRgq7E6HvUN8A0yj0wyWDHRZ3J2A1jHdMyu3hCGwSDwdRir7h9VP7AKLgPoMCgKziOFLtrUm8aIFHlgxYfz8WBYUU55iAXauo+evJaIK/NTgRJM9sUcZRzcCnMdNKMJc7usnAyrpxHYkTRHK+n1HxS01LheAHqRWwKIDqLvQC0+PupHZgBawfVGsiniTVHwZHRqbUI/D4Cd+ftgyLAR1ehkIiqaKFw7MJEwUIuK5zsu4svoFYCFKgBJZACBuppOId2RDkPZas8H9kULcA9a0KTCQDGtpnzT+RMJiOGseHl4BQ1C29AWUXIIf/OIwwqoNEK3SCuA7FRiBrE9B4/PcrGJ1OQNj83F4Xbol/TgVHfMiIZLAdcaVkgh8sLrd+liNQH/FqsNTfj15m1J0X+ffZuq/gTY7QnvIfJz6UzBJLs83ItQpt3RfZz5iuGfNPajpngUm0R8DoA5jDlzsOTAwZjzsC3Jjxg7H914PjlcskGdghgx9HG4OOQH34uwQyzz61/0qiYNQjXxECuWYbGM/DrjtPH/Mw/K+gBLLSA+cEfPr4MroArzcDuybbr8Zc72i2UnzeHnTgzD4Ug78SzIvCoARVOQxaFFR3TzWnkkHUVFShEuqKxZnKz4p4YYcf8ZhYhuu8wFgSHcuuwCJagI4bgchJQK/qe9c/RT6nGcg6KGREJpb+MI0EY/b0jcsni3AJBeCQNsBOFVYoApcM2Aom4VFgIRdHpeIG8D3YaxBD+qCiQ+rBOSVnci8hzkAG1t/pgHA4uwDzmu8xFKkkkIqCfkIRs204r/hiDgutoAAcowBMZ9+KS0CcXVBOHCvJw2jMQSJyeoeExF2DuTuRcuWAo9sefyUQ6/oBaIjPtiRH1KvQKvygAHb171d+vc4GRMDPoxN/kL5pwlVh1mBQ1quQJAJ5j0TgOAis+h8d3mnC8xTKE34+8sDNjyVXE6nFMN+H39TQDmocHScENvN74LoGScGU4f7g6IG3n3C3qnG6JBS+Z5tHOOzRYQx+u7MZmAl0OSsRLAS/VIKfRAWU92+12aaVPksGDBWQuCMvgNy2M2Mt8EwqbjosZAec5xLEAmXmcFTHiOWARWglpNpjdEtBQRxJJU5VL5/7F1X86XntXgUK4q+KggsUoIIK8oA+kgy4+zLaACqQGTVOX6MBWdehL6BxHn+tlyBMDGAqufd7WOX5WTJwKYDfXJJP2GXDPk7Tj5Ed7BOG7DMFaBRAJgI/+H2Ngeb2SKb0zkoGlQBHkefDr7xMA5HZeJPtKIzyApI9gmnPgf1c3mulfhe0gFekDCdNFnrOwi4Gs6eTACNjB+Uegcgojog4V25P8bctRYY6RL8AJklE9ACFAGZdBEahd4d4CmghFhbzcwaXYH5qTlS6DY+KfNH5Avzjo2JJ0poDkSCMxLn73H/eB+ifvgvyIFCWAji7BWC8hd0qj0FziMdrS70BlVbgamIgcmotGZDNPwm0L9l5iHv7WRoAFx57ScFS2r2iwot8oKu8l+TOCOg2mZ2nFdjTgOFQENzKkJ8OjEnsE8f6AzyXwT6MNF3RDRnuj0Lwo6wTlBMDIyqaz6G+RiLJMg/KUrQV/rh9uH0tWduwoxmky0kSMQ+rnXxZsGadgnxfgk1pCnsIsGYltvfdzTOBIclIsN8MLAGcz5gBwj94AE8DuC9Molip/JGwB57nRyJiyD3pyk6q5ij+3TzRLohcqyqCEQBTepF15+WVmW8SEr5jMUUkx3oMIsrH3ndwAQganKzyMpOJNxMQooGBYwcByw7axIhgPRGEr6GSGJhkAELoQ1YRg+dPeD5IIRDIqq5PA2Jh0Rq0YcS8XBi0ghGRFpCtWTdum5+yLOsQf2EuYY8AfnbQZDgCjHxBSKwTGpt8QCIDVH3/4H5OwEvldhliINwAFLsEyyIfGKV+vm3eEehVqKTdNxtDiPoLHCRiuwTJxCECxMDqDjTvZ63KaPKvRgV2i/F3ohm88V8LN8hgJcXD5pVGIPPNn9EBqSQC0I4AMxBUcQNCkarkFgSn/oCs9GCVep4eUG5BRAOcQOCWlGSc3If0IFqRfURQGRrKewPKEJ9sLnIowKCcw+f48N6UHjqYtgInaCCkBbPSj8VEkCr2g8U43wY1xX/BNkwreQrzg+oaJghOCGTU8RBxuIp6VFOGoEXgEsBLIgV6gBgxoLSI5CgiYNT+GBHsU01GthrceiMUtv9KgAYktgVNeGrBbtiOQVi9x8WjiAW7UNUnm4Vet7WtsFgDCDYEwQ/EVL1PnQf/xCDLTowTh4c4HPRDoQaiwhKIAae4B7xgCBydI/CDPOrevK0FR4p6w3VfoXgQiB3T1N8Y1PCD0X19JqcHGfzB5WkQE4p/kdeXBcEVUXEIFqSij82lMyrWq/7c+LFHA7z5/dwOHHg8s/Y8C2CmhbmALtare+4UWLfb25BmXABKABTniC8gRAP2yvDAiUAsElnrxFzITQa/sAFecAOY7zPV/8jMQHSbWAiUPGkQNABhw85xrSCv+mMSzFR8+7mjw01A8f4F8S/td4jnDHYxpT8/OEyV3gz2+GTfdAeAszswfJNGlQhEIjB0Bls0BKn4Iw7WKu9f1gmSagmvqleEwJwnZwjO7npz1HdCJ1hS/mlBcRXyF3i/M7NxqJFoeH27z7nnJaBmpUZKHsTbGUc1ALEoIGsGYl9ixS50gjAT/VhB8IzvGTrBVfWEz1MzAkRFTtecW731VdjNQPukVdhdn0Y8d/a7WYH6i/TBPBzUFwAlHwtGHOQISrgb1AMUgDETTA3+THAdeRJhg59V/Ektofa9I8wxVICkC7QQSAd2O3cftzPzdMK6aA4iZI4ILfYRbb9RgqICt2AxVnYZ4kkBvHOBxT/zN9ybHx/f5Ql2fkGCX6ANm6F8WCfqAS+Eq5AGcHJd2IFHagTMHAAj+mWBnDXuc81CjhsAi5dL2K8QCYI1aJ/PJtSSxEFXASv7C2I3ZB9/a0j/7nDn/j1pHsz9Jr8fNpxPBUAUUYD4wz5GBlmyAiORjtAIGDFwzSUwqiNZ1d1tPiB7/Q9VeI9KeJU16/knkEeQJEALjY4rkp74fCZiMDSA/PgvT/aT2gYgp5E/P29AKBQAo6TRth5T4VesQFb0i4K7RA2MZpgyFXCEQHCOixuYMPgy2L7+45ezSSKt2oUkURlpXkEMOLSiXPuDQZjk63N5bmzOSxQdLHX7AhwUEA0BAeQPJIQzkAuFlOK/GtyLdiGDKEBdllQ7YouxV2Xdwza9So4Kp5Z0yAgUhTlJgFzSFrznIHYIwKcCu2/L3LsCg6UI1b1/CA+ApIV5/32HqOIjdQusE4azip5Wc1b0q/QGIAlaWEJbXP3r/L+AEipw/+BtkQVY9fIM2i/ZhgVEgJO6DZ1ksVtlYdoQAPhVO0oKmYBmnAYco4DRCRB3TwCziptaE0auER9/VzRqKNOEYINOQg2m1l9GpGNQAhh1v6UmxNQh2M4+LmlUzll0OTjYQOaGlZAEMCrdhmBphaMBwBADrSQQc3//He8KgFETT7p6BHnjj2X9EXsDjrgBS6ihoAmcSQVYmE4JgYWFpp1waAQRoqDzxDhU+HxSnZHz/9JEY6Y5MJA+cwoWrt99+U3Mc/9g/NQTFaigAEtwB1yBzwzucZSX7RZEILhR1d5GDCsBLVUdIQvsldZfEJt5i/MHx2hGJZFkVVyK242iFeh58oBUFqIQbkfp2DV2X0CkAYgv1sU+P+I/HmBu8nErugdRnUWhfp+A/ddlbEH3uQlBsNobUEMHasK1HOYn8BEEvCUaiuigXRIKj+sGOPA4KAWz9/s7WxcgB4+a6/fI2osEwv4yOENAiPf+wQhbc/5f0gGisWuQaRFmGoIqguARWsBQgTTocDLMT5OJUQnhqdCEig+/EShKSEgTVV0MBMnz04BcshPnLk/+OaV0/dwKzB4QUt1NB6uTDfGOP+cNm9mEsBAFiM7AQh9AKVEU75vy68jeOxrUC4mDEuYO0oLqoSdHaEF2eXYYSm0V+oEOwpLmYFOF3Z4CmAeBTIGueiIw2xoKPzDBJVBXQ5g5O8/twwA+QguIjJt3+g0NQEcDfUXgO5gsqlTBLkQLdl86K3CWneitQ8sg/5oWAUJP2C3V3RoEyji5n4b9lB4t9pz2CA+cAFn1Z9I/uzYsU/ELtEBOCHYQQqGcFejV+yeuRJX31zsKV5IGjway9z6PLDxKwNEPsBuOEiqw57jGgOtZ1Y++T50AuMFl7hPIbhskiOwsATtRoc7rS7dXrpcgrMCGJca6ELJo+Y0be0BW5ZKGcFz4y8W9BduwcDnK9iO5fagsKpp9ANnvDPxeP8THNyIVFo1AMas8Qk5v2Ytm0LCCYAXqn+wQsPTBh/5Bcnne14Os3uCQt28vsK1WUESJFviBgAW//3u9PLxusXchcCR2WsNzv/ImvgZzzkUByDUAIrjTvmSHAowpJBQE4SUlxMxnARlQbIqkArVAJ6pBBvELCCKlkyCDAP45BYfEPfcUpfMch3Vn4bheYK4E66BxAxHSVd5INgEPgU/NBCDfNQ8Ho1CoINAPQAW/QT8OCIZlNFCB84XhoDChFByHGjx35v9BLgyhmojqHYb5QYXnuAecvua0hZe6BV9f7v4ibvgvamrmAc1TmaEir0LQ9h97eYAYVoM/nWA60i8Q3Ifezha9BqaaL3zvqd6IAuwwLSCCuCLuJWch4h30giPtyiAphKEBcCu9BV5wwzkMxID8rhMwdwMhcSFgrBT3RUTQboAUg3+p+Qe1IGarOioVnazmefV3lHpwA0AcLWCahUiXwePHWJsP+GH1gnp/we5KfOhJAbsj0H/BIEb04TbrTPsAyb2LLu93KwfCvn5PLAwrOXAa72eEQRo1CNdw5IprsAZ3hApy9zlcITG2vpCihsRSYxNS+J4vdBZ6B52eqRcQ/QXmSjAWSfa/5GA5qEg4iJFtm624AqXLrSA2gx8p1Mdqcghv41S0lSp/xAYs9gakQc4Ie2RTUYwYgt748mV+FU1Xgp14eW3XYZ6cdqGTNHwHICTwEeTPl0jEZwIgP9gDEaogeg5IHWCF+1eoAhvEKPB/EAeTRsM/pSAP5wjWEUMM1/NJRhwJbpJSgK7S7zF3EOsI5jBQBK9DV80Z8Y0COzvmWzJXgDl40KEC6cqvqgi4OB5cpgLFYK/1CvDiItXqC6/S87wfAUfPtxqfGNzlYaOjlf1IsHPPvffHgDAoEeEST4ZLZUd/RSo91/BjXY5ggWgQ4In3fyj4mUqPrInHOCLKO3wUwRsfyXpt1nEIRLrqcWeTuk7bigsbid1zD4iDRQtnIdQsyIXnFCn1I9D7ADgxEhOvR5AJosoUbu1FkJyYCi9OhQERoIx+4AX/YqUXQhtYEwKN4Cy1HntLMmtaAQpqfrT/UCoLSxeswjA5UWPPi0mjajUWxMTdVusNvt/ChMdmILK5IRMFu90BMEzFYHdg2GAgeYVHMMJIBTA7EFTx/5fpgTFXz9w/en0ZjD8kCDoKPNGwlB01BmoWQbh+AxR689mBponGJOr9OwmMu3dtJ/ylW1Tik4ElUPmR9RqII+pVhD9ychABMQ51gOIZg+/G+5mGIzLB1JJC5WhzYjhJ7IWmLDpA8jzsAafUPkB2WnFBF4iSxkq1ty7f25rv/+EQLOxs2oUdTSA9HIR9swdBlCcFe9owPC3XWDDC0ISVzsEVbSCF/sWdA5Fu4HJqankp2SeQCYYrImNalfmhpVxYrGkUS4LeSUjg8dD7+D7w/ybIfy7vlB9/HJ978zr7/45Qgajzj+4EjIK/ULHPRAOlKr/aG0AFcqCyu0GcW45Igh6JMJmhA49/U+cEssHNJhtXDC1MOya3j/sAiAGcrEtqtgjBD6wEzSDc7D8o6C8rIqAZyPk+NQoNLAZ1hR64Yl1FBY648smUYKnSg1Xwk/0DyRyArByMUobyByhCcPnOaPyoegREFS4jNfYAw+IHCjdC1J2WDZBke/OyN85J24WiXwDYPoJyYuCD238ulvuzwt6KgHf0shWKsqCFFGjB/w8HU8eeTED9wAAAAABJRU5ErkJggg==";let BE=0;const r0=a=>{if(!a.environmentBRDFTexture){const e=a.useDelayedTextureLoading;a.useDelayedTextureLoading=!1;const t=a._blockEntityCollection;a._blockEntityCollection=!1;const i=H.CreateFromBase64String(LE,"EnvironmentBRDFTexture"+BE++,a,!0,!1,H.BILINEAR_SAMPLINGMODE);a._blockEntityCollection=t;const s=a.getEngine().getLoadedTexturesCache(),r=s.indexOf(i.getInternalTexture());r!==-1&&s.splice(r,1),i.isRGBD=!0,i.wrapU=H.CLAMP_ADDRESSMODE,i.wrapV=H.CLAMP_ADDRESSMODE,a.environmentBRDFTexture=i,a.useDelayedTextureLoading=e,Of.ExpandRGBDTexture(i);const n=a.getEngine().onContextRestoredObservable.add(()=>{i.isRGBD=!0;const o=()=>{i.isReady()?Of.ExpandRGBDTexture(i):q.SetImmediate(o)};o()});a.onDisposeObservable.add(()=>{a.getEngine().onContextRestoredObservable.remove(n)})}return a.environmentBRDFTexture};class UE extends rr{constructor(){super(...arguments),this.BRDF_V_HEIGHT_CORRELATED=!1,this.MS_BRDF_ENERGY_CONSERVATION=!1,this.SPHERICAL_HARMONICS=!1,this.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=!1}}class ls extends Zr{constructor(e,t=!0){super(e,"PBRBRDF",90,new UE,t),this._useEnergyConservation=ls.DEFAULT_USE_ENERGY_CONSERVATION,this.useEnergyConservation=ls.DEFAULT_USE_ENERGY_CONSERVATION,this._useSmithVisibilityHeightCorrelated=ls.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this.useSmithVisibilityHeightCorrelated=ls.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED,this._useSphericalHarmonics=ls.DEFAULT_USE_SPHERICAL_HARMONICS,this.useSphericalHarmonics=ls.DEFAULT_USE_SPHERICAL_HARMONICS,this._useSpecularGlossinessInputEnergyConservation=ls.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this.useSpecularGlossinessInputEnergyConservation=ls.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION,this._internalMarkAllSubMeshesAsMiscDirty=e._dirtyCallbacks[16],this._enable(!0)}_markAllSubMeshesAsMiscDirty(){this._internalMarkAllSubMeshesAsMiscDirty()}prepareDefines(e){e.BRDF_V_HEIGHT_CORRELATED=this._useSmithVisibilityHeightCorrelated,e.MS_BRDF_ENERGY_CONSERVATION=this._useEnergyConservation&&this._useSmithVisibilityHeightCorrelated,e.SPHERICAL_HARMONICS=this._useSphericalHarmonics,e.SPECULAR_GLOSSINESS_ENERGY_CONSERVATION=this._useSpecularGlossinessInputEnergyConservation}getClassName(){return"PBRBRDFConfiguration"}}ls.DEFAULT_USE_ENERGY_CONSERVATION=!0;ls.DEFAULT_USE_SMITH_VISIBILITY_HEIGHT_CORRELATED=!0;ls.DEFAULT_USE_SPHERICAL_HARMONICS=!0;ls.DEFAULT_USE_SPECULAR_GLOSSINESS_INPUT_ENERGY_CONSERVATION=!0;T([R(),ie("_markAllSubMeshesAsMiscDirty")],ls.prototype,"useEnergyConservation",void 0);T([R(),ie("_markAllSubMeshesAsMiscDirty")],ls.prototype,"useSmithVisibilityHeightCorrelated",void 0);T([R(),ie("_markAllSubMeshesAsMiscDirty")],ls.prototype,"useSphericalHarmonics",void 0);T([R(),ie("_markAllSubMeshesAsMiscDirty")],ls.prototype,"useSpecularGlossinessInputEnergyConservation",void 0);const VE="pbrFragmentDeclaration",kE=`uniform vec4 vEyePosition;
uniform vec3 vReflectionColor;
uniform vec4 vAlbedoColor;
uniform vec4 vLightingIntensity;
uniform vec4 vReflectivityColor;
uniform vec4 vMetallicReflectanceFactors;
uniform vec3 vEmissiveColor;
uniform float visibility;
uniform vec3 vAmbientColor;
#ifdef ALBEDO
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform vec4 vAmbientInfos;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#ifdef OPACITY
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
#endif
#ifdef REFLECTIVITY
uniform vec3 vReflectivityInfos;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
#endif
#if defined(REFLECTIONMAP_SPHERICAL) || defined(REFLECTIONMAP_PROJECTION) || defined(SS_REFRACTION) || defined(PREPASS)
uniform mat4 view;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
#ifdef REALTIME_FILTERING
uniform vec2 vReflectionFilteringInfo;
#endif
uniform mat4 reflectionMatrix;
uniform vec3 vReflectionMicrosurfaceInfos;
#if defined(USE_LOCAL_REFLECTIONMAP_CUBIC) && defined(REFLECTIONMAP_CUBIC)
uniform vec3 vReflectionPosition;
uniform vec3 vReflectionSize; 
#endif
#endif
#if defined(SS_REFRACTION) && defined(SS_USE_LOCAL_REFRACTIONMAP_CUBIC)
uniform vec3 vRefractionPosition;
uniform vec3 vRefractionSize; 
#endif
#ifdef CLEARCOAT
uniform vec2 vClearCoatParams;
uniform vec4 vClearCoatRefractionParams;
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform vec2 vClearCoatTangentSpaceParams;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT
uniform vec4 vClearCoatTintParams;
uniform float clearCoatColorAtDistance;
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#endif
#ifdef IRIDESCENCE
uniform vec4 vIridescenceParams;
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
uniform vec3 vAnisotropy;
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
uniform vec4 vSheenColor;
#ifdef SHEEN_ROUGHNESS
uniform float vSheenRoughness;
#endif
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionMicrosurfaceInfos;
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#ifdef REALTIME_FILTERING
uniform vec2 vRefractionFilteringInfo;
#endif
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
uniform vec2 vThicknessParam;
uniform vec3 vDiffusionDistance;
uniform vec4 vTintColor;
uniform vec3 vSubSurfaceIntensity;
#endif
#ifdef PREPASS
#ifdef SS_SCATTERING
uniform float scatteringDiffusionProfile;
#endif
#endif
#if DEBUGMODE>0
uniform vec2 vDebugMode;
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#define ADDITIONAL_FRAGMENT_DECLARATION
`;Y.IncludesShadersStore[VE]=kE;const GE="pbrUboDeclaration",zE=`layout(std140,column_major) uniform;
uniform Material {
vec2 vAlbedoInfos;
vec4 vAmbientInfos;
vec2 vOpacityInfos;
vec2 vEmissiveInfos;
vec2 vLightmapInfos;
vec3 vReflectivityInfos;
vec2 vMicroSurfaceSamplerInfos;
vec2 vReflectionInfos;
vec2 vReflectionFilteringInfo;
vec3 vReflectionPosition;
vec3 vReflectionSize;
vec3 vBumpInfos;
mat4 albedoMatrix;
mat4 ambientMatrix;
mat4 opacityMatrix;
mat4 emissiveMatrix;
mat4 lightmapMatrix;
mat4 reflectivityMatrix;
mat4 microSurfaceSamplerMatrix;
mat4 bumpMatrix;
vec2 vTangentSpaceParams;
mat4 reflectionMatrix;
vec3 vReflectionColor;
vec4 vAlbedoColor;
vec4 vLightingIntensity;
vec3 vReflectionMicrosurfaceInfos;
float pointSize;
vec4 vReflectivityColor;
vec3 vEmissiveColor;
vec3 vAmbientColor;
vec2 vDebugMode;
vec4 vMetallicReflectanceFactors;
vec2 vMetallicReflectanceInfos;
mat4 metallicReflectanceMatrix;
vec2 vReflectanceInfos;
mat4 reflectanceMatrix;
vec3 vSphericalL00;
vec3 vSphericalL1_1;
vec3 vSphericalL10;
vec3 vSphericalL11;
vec3 vSphericalL2_2;
vec3 vSphericalL2_1;
vec3 vSphericalL20;
vec3 vSphericalL21;
vec3 vSphericalL22;
vec3 vSphericalX;
vec3 vSphericalY;
vec3 vSphericalZ;
vec3 vSphericalXX_ZZ;
vec3 vSphericalYY_ZZ;
vec3 vSphericalZZ;
vec3 vSphericalXY;
vec3 vSphericalYZ;
vec3 vSphericalZX;
#define ADDITIONAL_UBO_DECLARATION
};
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Y.IncludesShadersStore[GE]=zE;const WE="pbrFragmentExtraDeclaration",HE=`varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#include<mainUVVaryingDeclaration>[1..7]
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
`;Y.IncludesShadersStore[WE]=HE;const XE="samplerFragmentAlternateDeclaration",YE=`#ifdef _DEFINENAME_
#if _DEFINENAME_DIRECTUV==1
#define v_VARYINGNAME_UV vMainUV1
#elif _DEFINENAME_DIRECTUV==2
#define v_VARYINGNAME_UV vMainUV2
#elif _DEFINENAME_DIRECTUV==3
#define v_VARYINGNAME_UV vMainUV3
#elif _DEFINENAME_DIRECTUV==4
#define v_VARYINGNAME_UV vMainUV4
#elif _DEFINENAME_DIRECTUV==5
#define v_VARYINGNAME_UV vMainUV5
#elif _DEFINENAME_DIRECTUV==6
#define v_VARYINGNAME_UV vMainUV6
#else
varying vec2 v_VARYINGNAME_UV;
#endif
#endif
`;Y.IncludesShadersStore[XE]=YE;const KE="pbrFragmentSamplersDeclaration",$E=`#include<samplerFragmentDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_SAMPLERNAME_,albedo)
#include<samplerFragmentDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_SAMPLERNAME_,ambient)
#include<samplerFragmentDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_SAMPLERNAME_,opacity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_SAMPLERNAME_,emissive)
#include<samplerFragmentDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_SAMPLERNAME_,lightmap)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_SAMPLERNAME_,reflectivity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_SAMPLERNAME_,microSurface)
#include<samplerFragmentDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_SAMPLERNAME_,metallicReflectance)
#include<samplerFragmentDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_SAMPLERNAME_,reflectance)
#ifdef CLEARCOAT
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_SAMPLERNAME_,clearCoat)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D clearCoatRoughnessSampler;
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_SAMPLERNAME_,clearCoatBump)
#include<samplerFragmentDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_SAMPLERNAME_,clearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_SAMPLERNAME_,iridescence)
#include<samplerFragmentDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_SAMPLERNAME_,iridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerFragmentDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_SAMPLERNAME_,sheen)
#include<samplerFragmentAlternateDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL)
uniform sampler2D sheenRoughnessSampler;
#endif
#endif
#ifdef ANISOTROPIC
#include<samplerFragmentDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_SAMPLERNAME_,anisotropy)
#endif
#ifdef REFLECTION
#ifdef REFLECTIONMAP_3D
#define sampleReflection(s,c) textureCube(s,c)
uniform samplerCube reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube reflectionSamplerLow;
uniform samplerCube reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform samplerCube irradianceSampler;
#endif
#else
#define sampleReflection(s,c) texture2D(s,c)
uniform sampler2D reflectionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleReflectionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D reflectionSamplerLow;
uniform sampler2D reflectionSamplerHigh;
#endif
#ifdef USEIRRADIANCEMAP
uniform sampler2D irradianceSampler;
#endif
#endif
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#else
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#endif
#endif
#ifdef ENVIRONMENTBRDF
uniform sampler2D environmentBrdfSampler;
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
#ifdef SS_REFRACTIONMAP_3D
#define sampleRefraction(s,c) textureCube(s,c)
uniform samplerCube refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) textureCubeLodEXT(s,c,l)
#else
uniform samplerCube refractionSamplerLow;
uniform samplerCube refractionSamplerHigh;
#endif
#else
#define sampleRefraction(s,c) texture2D(s,c)
uniform sampler2D refractionSampler;
#ifdef LODBASEDMICROSFURACE
#define sampleRefractionLod(s,c,l) texture2DLodEXT(s,c,l)
#else
uniform sampler2D refractionSamplerLow;
uniform sampler2D refractionSamplerHigh;
#endif
#endif
#endif
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_SAMPLERNAME_,thickness)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_SAMPLERNAME_,refractionIntensity)
#include<samplerFragmentDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_SAMPLERNAME_,translucencyIntensity)
#endif
`;Y.IncludesShadersStore[KE]=$E;const jE="subSurfaceScatteringFunctions",qE=`bool testLightingForSSS(float diffusionProfile)
{
return diffusionProfile<1.;
}`;Y.IncludesShadersStore[jE]=qE;const QE="importanceSampling",ZE=`vec3 hemisphereCosSample(vec2 u) {
float phi=2.*PI*u.x;
float cosTheta2=1.-u.y;
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDggx(vec2 u,float a) {
float phi=2.*PI*u.x;
float cosTheta2=(1.-u.y)/(1.+(a+1.)*((a-1.)*u.y));
float cosTheta=sqrt(cosTheta2);
float sinTheta=sqrt(1.-cosTheta2);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}
vec3 hemisphereImportanceSampleDCharlie(vec2 u,float a) { 
float phi=2.*PI*u.x;
float sinTheta=pow(u.y,a/(2.*a+1.));
float cosTheta=sqrt(1.-sinTheta*sinTheta);
return vec3(sinTheta*cos(phi),sinTheta*sin(phi),cosTheta);
}`;Y.IncludesShadersStore[QE]=ZE;const JE="pbrHelperFunctions",eC=`#define RECIPROCAL_PI2 0.15915494
#define RECIPROCAL_PI 0.31830988618
#define MINIMUMVARIANCE 0.0005
float convertRoughnessToAverageSlope(float roughness)
{
return square(roughness)+MINIMUMVARIANCE;
}
float fresnelGrazingReflectance(float reflectance0) {
float reflectance90=saturate(reflectance0*25.0);
return reflectance90;
}
vec2 getAARoughnessFactors(vec3 normalVector) {
#ifdef SPECULARAA
vec3 nDfdx=dFdx(normalVector.xyz);
vec3 nDfdy=dFdy(normalVector.xyz);
float slopeSquare=max(dot(nDfdx,nDfdx),dot(nDfdy,nDfdy));
float geometricRoughnessFactor=pow(saturate(slopeSquare),0.333);
float geometricAlphaGFactor=sqrt(slopeSquare);
geometricAlphaGFactor*=0.75;
return vec2(geometricRoughnessFactor,geometricAlphaGFactor);
#else
return vec2(0.);
#endif
}
#ifdef ANISOTROPIC
vec2 getAnisotropicRoughness(float alphaG,float anisotropy) {
float alphaT=max(alphaG*(1.0+anisotropy),MINIMUMVARIANCE);
float alphaB=max(alphaG*(1.0-anisotropy),MINIMUMVARIANCE);
return vec2(alphaT,alphaB);
}
vec3 getAnisotropicBentNormals(const vec3 T,const vec3 B,const vec3 N,const vec3 V,float anisotropy) {
vec3 anisotropicFrameDirection=anisotropy>=0.0 ? B : T;
vec3 anisotropicFrameTangent=cross(normalize(anisotropicFrameDirection),V);
vec3 anisotropicFrameNormal=cross(anisotropicFrameTangent,anisotropicFrameDirection);
vec3 anisotropicNormal=normalize(mix(N,anisotropicFrameNormal,abs(anisotropy)));
return anisotropicNormal;
}
#endif
#if defined(CLEARCOAT) || defined(SS_REFRACTION)
vec3 cocaLambert(vec3 alpha,float distance) {
return exp(-alpha*distance);
}
vec3 cocaLambert(float NdotVRefract,float NdotLRefract,vec3 alpha,float thickness) {
return cocaLambert(alpha,(thickness*((NdotLRefract+NdotVRefract)/(NdotLRefract*NdotVRefract))));
}
vec3 computeColorAtDistanceInMedia(vec3 color,float distance) {
return -log(color)/distance;
}
vec3 computeClearCoatAbsorption(float NdotVRefract,float NdotLRefract,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 clearCoatAbsorption=mix(vec3(1.0),
cocaLambert(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness),
clearCoatIntensity);
return clearCoatAbsorption;
}
#endif
#ifdef MICROSURFACEAUTOMATIC
float computeDefaultMicroSurface(float microSurface,vec3 reflectivityColor)
{
const float kReflectivityNoAlphaWorkflow_SmoothnessMax=0.95;
float reflectivityLuminance=getLuminance(reflectivityColor);
float reflectivityLuma=sqrt(reflectivityLuminance);
microSurface=reflectivityLuma*kReflectivityNoAlphaWorkflow_SmoothnessMax;
return microSurface;
}
#endif
`;Y.IncludesShadersStore[JE]=eC;const tC="harmonicsFunctions",iC=`#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
vec3 computeEnvironmentIrradiance(vec3 normal) {
return vSphericalL00
+ vSphericalL1_1*(normal.y)
+ vSphericalL10*(normal.z)
+ vSphericalL11*(normal.x)
+ vSphericalL2_2*(normal.y*normal.x)
+ vSphericalL2_1*(normal.y*normal.z)
+ vSphericalL20*((3.0*normal.z*normal.z)-1.0)
+ vSphericalL21*(normal.z*normal.x)
+ vSphericalL22*(normal.x*normal.x-(normal.y*normal.y));
}
#else
vec3 computeEnvironmentIrradiance(vec3 normal) {
float Nx=normal.x;
float Ny=normal.y;
float Nz=normal.z;
vec3 C1=vSphericalZZ.rgb;
vec3 Cx=vSphericalX.rgb;
vec3 Cy=vSphericalY.rgb;
vec3 Cz=vSphericalZ.rgb;
vec3 Cxx_zz=vSphericalXX_ZZ.rgb;
vec3 Cyy_zz=vSphericalYY_ZZ.rgb;
vec3 Cxy=vSphericalXY.rgb;
vec3 Cyz=vSphericalYZ.rgb;
vec3 Czx=vSphericalZX.rgb;
vec3 a1=Cyy_zz*Ny+Cy;
vec3 a2=Cyz*Nz+a1;
vec3 b1=Czx*Nz+Cx;
vec3 b2=Cxy*Ny+b1;
vec3 b3=Cxx_zz*Nx+b2;
vec3 t1=Cz *Nz+C1;
vec3 t2=a2 *Ny+t1;
vec3 t3=b3 *Nx+t2;
return t3;
}
#endif
#endif
`;Y.IncludesShadersStore[tC]=iC;const sC="pbrDirectLightingSetupFunctions",rC=`struct preLightingInfo
{
vec3 lightOffset;
float lightDistanceSquared;
float lightDistance;
float attenuation;
vec3 L;
vec3 H;
float NdotV;
float NdotLUnclamped;
float NdotL;
float VdotH;
float roughness;
#ifdef IRIDESCENCE
float iridescenceIntensity;
#endif
};
preLightingInfo computePointAndSpotPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightOffset=lightData.xyz-vPositionW;
result.lightDistanceSquared=dot(result.lightOffset,result.lightOffset);
result.lightDistance=sqrt(result.lightDistanceSquared);
result.L=normalize(result.lightOffset);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeDirectionalPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.lightDistance=length(-lightData.xyz);
result.L=normalize(-lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
result.NdotLUnclamped=dot(N,result.L);
result.NdotL=saturateEps(result.NdotLUnclamped);
return result;
}
preLightingInfo computeHemisphericPreLightingInfo(vec4 lightData,vec3 V,vec3 N) {
preLightingInfo result;
result.NdotL=dot(N,lightData.xyz)*0.5+0.5;
result.NdotL=saturateEps(result.NdotL);
result.NdotLUnclamped=result.NdotL;
#ifdef SPECULARTERM
result.L=normalize(lightData.xyz);
result.H=normalize(V+result.L);
result.VdotH=saturate(dot(V,result.H));
#endif
return result;
}`;Y.IncludesShadersStore[sC]=rC;const nC="pbrDirectLightingFalloffFunctions",aC=`float computeDistanceLightFalloff_Standard(vec3 lightOffset,float range)
{
return max(0.,1.0-length(lightOffset)/range);
}
float computeDistanceLightFalloff_Physical(float lightDistanceSquared)
{
return 1.0/maxEps(lightDistanceSquared);
}
float computeDistanceLightFalloff_GLTF(float lightDistanceSquared,float inverseSquaredRange)
{
float lightDistanceFalloff=1.0/maxEps(lightDistanceSquared);
float factor=lightDistanceSquared*inverseSquaredRange;
float attenuation=saturate(1.0-factor*factor);
attenuation*=attenuation;
lightDistanceFalloff*=attenuation;
return lightDistanceFalloff;
}
float computeDistanceLightFalloff(vec3 lightOffset,float lightDistanceSquared,float range,float inverseSquaredRange)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDistanceLightFalloff_Physical(lightDistanceSquared);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDistanceLightFalloff_GLTF(lightDistanceSquared,inverseSquaredRange);
#else
return computeDistanceLightFalloff_Standard(lightOffset,range);
#endif
}
float computeDirectionalLightFalloff_Standard(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent)
{
float falloff=0.0;
float cosAngle=maxEps(dot(-lightDirection,directionToLightCenterW));
if (cosAngle>=cosHalfAngle)
{
falloff=max(0.,pow(cosAngle,exponent));
}
return falloff;
}
float computeDirectionalLightFalloff_Physical(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle)
{
const float kMinusLog2ConeAngleIntensityRatio=6.64385618977; 
float concentrationKappa=kMinusLog2ConeAngleIntensityRatio/(1.0-cosHalfAngle);
vec4 lightDirectionSpreadSG=vec4(-lightDirection*concentrationKappa,-concentrationKappa);
float falloff=exp2(dot(vec4(directionToLightCenterW,1.0),lightDirectionSpreadSG));
return falloff;
}
float computeDirectionalLightFalloff_GLTF(vec3 lightDirection,vec3 directionToLightCenterW,float lightAngleScale,float lightAngleOffset)
{
float cd=dot(-lightDirection,directionToLightCenterW);
float falloff=saturate(cd*lightAngleScale+lightAngleOffset);
falloff*=falloff;
return falloff;
}
float computeDirectionalLightFalloff(vec3 lightDirection,vec3 directionToLightCenterW,float cosHalfAngle,float exponent,float lightAngleScale,float lightAngleOffset)
{
#ifdef USEPHYSICALLIGHTFALLOFF
return computeDirectionalLightFalloff_Physical(lightDirection,directionToLightCenterW,cosHalfAngle);
#elif defined(USEGLTFLIGHTFALLOFF)
return computeDirectionalLightFalloff_GLTF(lightDirection,directionToLightCenterW,lightAngleScale,lightAngleOffset);
#else
return computeDirectionalLightFalloff_Standard(lightDirection,directionToLightCenterW,cosHalfAngle,exponent);
#endif
}`;Y.IncludesShadersStore[nC]=aC;const oC="pbrBRDFFunctions",lC=`#define FRESNEL_MAXIMUM_ON_ROUGH 0.25
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 getEnergyConservationFactor(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
return 1.0+specularEnvironmentR0*(1.0/environmentBrdf.y-1.0);
}
#endif
#ifdef ENVIRONMENTBRDF
vec3 getBRDFLookup(float NdotV,float perceptualRoughness) {
vec2 UV=vec2(NdotV,perceptualRoughness);
vec4 brdfLookup=texture2D(environmentBrdfSampler,UV);
#ifdef ENVIRONMENTBRDF_RGBD
brdfLookup.rgb=fromRGBD(brdfLookup.rgba);
#endif
return brdfLookup.rgb;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 specularEnvironmentR90,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=(specularEnvironmentR90-specularEnvironmentR0)*environmentBrdf.x+specularEnvironmentR0*environmentBrdf.y;
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+specularEnvironmentR90*environmentBrdf.y;
#endif
return reflectance;
}
vec3 getReflectanceFromBRDFLookup(const vec3 specularEnvironmentR0,const vec3 environmentBrdf) {
#ifdef BRDF_V_HEIGHT_CORRELATED
vec3 reflectance=mix(environmentBrdf.xxx,environmentBrdf.yyy,specularEnvironmentR0);
#else
vec3 reflectance=specularEnvironmentR0*environmentBrdf.x+environmentBrdf.y;
#endif
return reflectance;
}
#endif
/* NOT USED
#if defined(SHEEN) && defined(SHEEN_SOFTER)
float getBRDFLookupCharlieSheen(float NdotV,float perceptualRoughness)
{
float c=1.0-NdotV;
float c3=c*c*c;
return 0.65584461*c3+1.0/(4.16526551+exp(-7.97291361*perceptualRoughness+6.33516894));
}
#endif
*/
#if !defined(ENVIRONMENTBRDF) || defined(REFLECTIONMAP_SKYBOX) || defined(ALPHAFRESNEL)
vec3 getReflectanceFromAnalyticalBRDFLookup_Jones(float VdotN,vec3 reflectance0,vec3 reflectance90,float smoothness)
{
float weight=mix(FRESNEL_MAXIMUM_ON_ROUGH,1.0,smoothness);
return reflectance0+weight*(reflectance90-reflectance0)*pow5(saturate(1.0-VdotN));
}
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
/**
* The sheen BRDF not containing F can be easily stored in the blue channel of the BRDF texture.
* The blue channel contains DCharlie*VAshikhmin*NdotL as a lokkup table
*/
vec3 getSheenReflectanceFromBRDFLookup(const vec3 reflectance0,const vec3 environmentBrdf) {
vec3 sheenEnvironmentReflectance=reflectance0*environmentBrdf.b;
return sheenEnvironmentReflectance;
}
#endif
vec3 fresnelSchlickGGX(float VdotH,vec3 reflectance0,vec3 reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
float fresnelSchlickGGX(float VdotH,float reflectance0,float reflectance90)
{
return reflectance0+(reflectance90-reflectance0)*pow5(1.0-VdotH);
}
#ifdef CLEARCOAT
vec3 getR0RemappedForClearCoat(vec3 f0) {
#ifdef CLEARCOAT_DEFAULTIOR
#ifdef MOBILE
return saturate(f0*(f0*0.526868+0.529324)-0.0482256);
#else
return saturate(f0*(f0*(0.941892-0.263008*f0)+0.346479)-0.0285998);
#endif
#else
vec3 s=sqrt(f0);
vec3 t=(vClearCoatRefractionParams.z+vClearCoatRefractionParams.w*s)/(vClearCoatRefractionParams.w+vClearCoatRefractionParams.z*s);
return square(t);
#endif
}
#endif
#ifdef IRIDESCENCE
const mat3 XYZ_TO_REC709=mat3(
3.2404542,-0.9692660, 0.0556434,
-1.5371385, 1.8760108,-0.2040259,
-0.4985314, 0.0415560, 1.0572252
);
vec3 getIORTfromAirToSurfaceR0(vec3 f0) {
vec3 sqrtF0=sqrt(f0);
return (1.+sqrtF0)/(1.-sqrtF0);
}
vec3 getR0fromIORs(vec3 iorT,float iorI) {
return square((iorT-vec3(iorI))/(iorT+vec3(iorI)));
}
float getR0fromIORs(float iorT,float iorI) {
return square((iorT-iorI)/(iorT+iorI));
}
vec3 evalSensitivity(float opd,vec3 shift) {
float phase=2.0*PI*opd*1.0e-9;
const vec3 val=vec3(5.4856e-13,4.4201e-13,5.2481e-13);
const vec3 pos=vec3(1.6810e+06,1.7953e+06,2.2084e+06);
const vec3 var=vec3(4.3278e+09,9.3046e+09,6.6121e+09);
vec3 xyz=val*sqrt(2.0*PI*var)*cos(pos*phase+shift)*exp(-square(phase)*var);
xyz.x+=9.7470e-14*sqrt(2.0*PI*4.5282e+09)*cos(2.2399e+06*phase+shift[0])*exp(-4.5282e+09*square(phase));
xyz/=1.0685e-7;
vec3 srgb=XYZ_TO_REC709*xyz;
return srgb;
}
vec3 evalIridescence(float outsideIOR,float eta2,float cosTheta1,float thinFilmThickness,vec3 baseF0) {
vec3 I=vec3(1.0);
float iridescenceIOR=mix(outsideIOR,eta2,smoothstep(0.0,0.03,thinFilmThickness));
float sinTheta2Sq=square(outsideIOR/iridescenceIOR)*(1.0-square(cosTheta1));
float cosTheta2Sq=1.0-sinTheta2Sq;
if (cosTheta2Sq<0.0) {
return I;
}
float cosTheta2=sqrt(cosTheta2Sq);
float R0=getR0fromIORs(iridescenceIOR,outsideIOR);
float R12=fresnelSchlickGGX(cosTheta1,R0,1.);
float R21=R12;
float T121=1.0-R12;
float phi12=0.0;
if (iridescenceIOR<outsideIOR) phi12=PI;
float phi21=PI-phi12;
vec3 baseIOR=getIORTfromAirToSurfaceR0(clamp(baseF0,0.0,0.9999)); 
vec3 R1=getR0fromIORs(baseIOR,iridescenceIOR);
vec3 R23=fresnelSchlickGGX(cosTheta2,R1,vec3(1.));
vec3 phi23=vec3(0.0);
if (baseIOR[0]<iridescenceIOR) phi23[0]=PI;
if (baseIOR[1]<iridescenceIOR) phi23[1]=PI;
if (baseIOR[2]<iridescenceIOR) phi23[2]=PI;
float opd=2.0*iridescenceIOR*thinFilmThickness*cosTheta2;
vec3 phi=vec3(phi21)+phi23;
vec3 R123=clamp(R12*R23,1e-5,0.9999);
vec3 r123=sqrt(R123);
vec3 Rs=square(T121)*R23/(vec3(1.0)-R123);
vec3 C0=R12+Rs;
I=C0;
vec3 Cm=Rs-T121;
for (int m=1; m<=2; ++m)
{
Cm*=r123;
vec3 Sm=2.0*evalSensitivity(float(m)*opd,float(m)*phi);
I+=Cm*Sm;
}
return max(I,vec3(0.0));
}
#endif
float normalDistributionFunction_TrowbridgeReitzGGX(float NdotH,float alphaG)
{
float a2=square(alphaG);
float d=NdotH*NdotH*(a2-1.0)+1.0;
return a2/(PI*d*d);
}
#ifdef SHEEN
float normalDistributionFunction_CharlieSheen(float NdotH,float alphaG)
{
float invR=1./alphaG;
float cos2h=NdotH*NdotH;
float sin2h=1.-cos2h;
return (2.+invR)*pow(sin2h,invR*.5)/(2.*PI);
}
#endif
#ifdef ANISOTROPIC
float normalDistributionFunction_BurleyGGX_Anisotropic(float NdotH,float TdotH,float BdotH,const vec2 alphaTB) {
float a2=alphaTB.x*alphaTB.y;
vec3 v=vec3(alphaTB.y*TdotH,alphaTB.x *BdotH,a2*NdotH);
float v2=dot(v,v);
float w2=a2/v2;
return a2*w2*w2*RECIPROCAL_PI;
}
#endif
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility_GGXCorrelated(float NdotL,float NdotV,float alphaG) {
#ifdef MOBILE
float GGXV=NdotL*(NdotV*(1.0-alphaG)+alphaG);
float GGXL=NdotV*(NdotL*(1.0-alphaG)+alphaG);
return 0.5/(GGXV+GGXL);
#else
float a2=alphaG*alphaG;
float GGXV=NdotL*sqrt(NdotV*(NdotV-a2*NdotV)+a2);
float GGXL=NdotV*sqrt(NdotL*(NdotL-a2*NdotL)+a2);
return 0.5/(GGXV+GGXL);
#endif
}
#else
float smithVisibilityG1_TrowbridgeReitzGGXFast(float dot,float alphaG)
{
#ifdef MOBILE
return 1.0/(dot+alphaG+(1.0-alphaG)*dot ));
#else
float alphaSquared=alphaG*alphaG;
return 1.0/(dot+sqrt(alphaSquared+(1.0-alphaSquared)*dot*dot));
#endif
}
float smithVisibility_TrowbridgeReitzGGXFast(float NdotL,float NdotV,float alphaG)
{
float visibility=smithVisibilityG1_TrowbridgeReitzGGXFast(NdotL,alphaG)*smithVisibilityG1_TrowbridgeReitzGGXFast(NdotV,alphaG);
return visibility;
}
#endif
#ifdef ANISOTROPIC
float smithVisibility_GGXCorrelated_Anisotropic(float NdotL,float NdotV,float TdotV,float BdotV,float TdotL,float BdotL,const vec2 alphaTB) {
float lambdaV=NdotL*length(vec3(alphaTB.x*TdotV,alphaTB.y*BdotV,NdotV));
float lambdaL=NdotV*length(vec3(alphaTB.x*TdotL,alphaTB.y*BdotL,NdotL));
float v=0.5/(lambdaV+lambdaL);
return v;
}
#endif
#ifdef CLEARCOAT
float visibility_Kelemen(float VdotH) {
return 0.25/(VdotH*VdotH); 
}
#endif
#ifdef SHEEN
float visibility_Ashikhmin(float NdotL,float NdotV)
{
return 1./(4.*(NdotL+NdotV-NdotL*NdotV));
}
/* NOT USED
#ifdef SHEEN_SOFTER
float l(float x,float alphaG)
{
float oneMinusAlphaSq=(1.0-alphaG)*(1.0-alphaG);
float a=mix(21.5473,25.3245,oneMinusAlphaSq);
float b=mix(3.82987,3.32435,oneMinusAlphaSq);
float c=mix(0.19823,0.16801,oneMinusAlphaSq);
float d=mix(-1.97760,-1.27393,oneMinusAlphaSq);
float e=mix(-4.32054,-4.85967,oneMinusAlphaSq);
return a/(1.0+b*pow(x,c))+d*x+e;
}
float lambdaSheen(float cosTheta,float alphaG)
{
return abs(cosTheta)<0.5 ? exp(l(cosTheta,alphaG)) : exp(2.0*l(0.5,alphaG)-l(1.0-cosTheta,alphaG));
}
float visibility_CharlieSheen(float NdotL,float NdotV,float alphaG)
{
float G=1.0/(1.0+lambdaSheen(NdotV,alphaG)+lambdaSheen(NdotL,alphaG));
return G/(4.0*NdotV*NdotL);
}
#endif
*/
#endif
float diffuseBRDF_Burley(float NdotL,float NdotV,float VdotH,float roughness) {
float diffuseFresnelNV=pow5(saturateEps(1.0-NdotL));
float diffuseFresnelNL=pow5(saturateEps(1.0-NdotV));
float diffuseFresnel90=0.5+2.0*VdotH*VdotH*roughness;
float fresnel =
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNL) *
(1.0+(diffuseFresnel90-1.0)*diffuseFresnelNV);
return fresnel/PI;
}
#ifdef SS_TRANSLUCENCY
vec3 transmittanceBRDF_Burley(const vec3 tintColor,const vec3 diffusionDistance,float thickness) {
vec3 S=1./maxEps(diffusionDistance);
vec3 temp=exp((-0.333333333*thickness)*S);
return tintColor.rgb*0.25*(temp*temp*temp+3.0*temp);
}
float computeWrappedDiffuseNdotL(float NdotL,float w) {
float t=1.0+w;
float invt2=1.0/square(t);
return saturate((NdotL+w)*invt2);
}
#endif
`;Y.IncludesShadersStore[oC]=lC;const hC="hdrFilteringFunctions",cC=`#ifdef NUM_SAMPLES
#if NUM_SAMPLES>0
#if defined(WEBGL2) || defined(WEBGPU)
float radicalInverse_VdC(uint bits) 
{
bits=(bits<<16u) | (bits>>16u);
bits=((bits & 0x55555555u)<<1u) | ((bits & 0xAAAAAAAAu)>>1u);
bits=((bits & 0x33333333u)<<2u) | ((bits & 0xCCCCCCCCu)>>2u);
bits=((bits & 0x0F0F0F0Fu)<<4u) | ((bits & 0xF0F0F0F0u)>>4u);
bits=((bits & 0x00FF00FFu)<<8u) | ((bits & 0xFF00FF00u)>>8u);
return float(bits)*2.3283064365386963e-10; 
}
vec2 hammersley(uint i,uint N)
{
return vec2(float(i)/float(N),radicalInverse_VdC(i));
}
#else
float vanDerCorpus(int n,int base)
{
float invBase=1.0/float(base);
float denom =1.0;
float result =0.0;
for(int i=0; i<32; ++i)
{
if(n>0)
{
denom =mod(float(n),2.0);
result+=denom*invBase;
invBase=invBase/2.0;
n =int(float(n)/2.0);
}
}
return result;
}
vec2 hammersley(int i,int N)
{
return vec2(float(i)/float(N),vanDerCorpus(i,2));
}
#endif
float log4(float x) {
return log2(x)/2.;
}
const float NUM_SAMPLES_FLOAT=float(NUM_SAMPLES);
const float NUM_SAMPLES_FLOAT_INVERSED=1./NUM_SAMPLES_FLOAT;
const float K=4.;
#define inline
vec3 irradiance(samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
vec3 result=vec3(0.0);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 Ls=hemisphereCosSample(Xi);
Ls=normalize(Ls);
vec3 Ns=vec3(0.,0.,1.);
float NoL=dot(Ns,Ls);
if (NoL>0.) {
float pdf_inversed=PI/NoL;
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(l,0.0,maxLevel);
vec3 c=textureCubeLodEXT(inputTexture,tbn*Ls,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c;
}
}
result=result*NUM_SAMPLES_FLOAT_INVERSED;
return result;
}
#define inline
vec3 radiance(float alphaG,samplerCube inputTexture,vec3 inputN,vec2 filteringInfo)
{
vec3 n=normalize(inputN);
if (alphaG==0.) {
vec3 c=textureCube(inputTexture,n).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
return c;
} else {
vec3 result=vec3(0.);
vec3 tangent=abs(n.z)<0.999 ? vec3(0.,0.,1.) : vec3(1.,0.,0.);
tangent=normalize(cross(tangent,n));
vec3 bitangent=cross(n,tangent);
mat3 tbn=mat3(tangent,bitangent,n);
float maxLevel=filteringInfo.y;
float dim0=filteringInfo.x;
float omegaP=(4.*PI)/(6.*dim0*dim0);
float weight=0.;
#if defined(WEBGL2) || defined(WEBGPU)
for(uint i=0u; i<NUM_SAMPLES; ++i)
#else
for(int i=0; i<NUM_SAMPLES; ++i)
#endif
{
vec2 Xi=hammersley(i,NUM_SAMPLES);
vec3 H=hemisphereImportanceSampleDggx(Xi,alphaG);
float NoV=1.;
float NoH=H.z;
float NoH2=H.z*H.z;
float NoL=2.*NoH2-1.;
vec3 L=vec3(2.*NoH*H.x,2.*NoH*H.y,NoL);
L=normalize(L);
if (NoL>0.) {
float pdf_inversed=4./normalDistributionFunction_TrowbridgeReitzGGX(NoH,alphaG);
float omegaS=NUM_SAMPLES_FLOAT_INVERSED*pdf_inversed;
float l=log4(omegaS)-log4(omegaP)+log4(K);
float mipLevel=clamp(float(l),0.0,maxLevel);
weight+=NoL;
vec3 c=textureCubeLodEXT(inputTexture,tbn*L,mipLevel).rgb;
#ifdef GAMMA_INPUT
c=toLinearSpace(c);
#endif
result+=c*NoL;
}
}
result=result/weight;
return result;
}
}
#endif
#endif
`;Y.IncludesShadersStore[hC]=cC;const uC="pbrDirectLightingFunctions",dC=`#define CLEARCOATREFLECTANCE90 1.0
struct lightingInfo
{
vec3 diffuse;
#ifdef SPECULARTERM
vec3 specular;
#endif
#ifdef CLEARCOAT
vec4 clearCoat;
#endif
#ifdef SHEEN
vec3 sheen;
#endif
};
float adjustRoughnessFromLightProperties(float roughness,float lightRadius,float lightDistance) {
#if defined(USEPHYSICALLIGHTFALLOFF) || defined(USEGLTFLIGHTFALLOFF)
float lightRoughness=lightRadius/lightDistance;
float totalRoughness=saturate(lightRoughness+roughness);
return totalRoughness;
#else
return roughness;
#endif
}
vec3 computeHemisphericDiffuseLighting(preLightingInfo info,vec3 lightColor,vec3 groundColor) {
return mix(groundColor,lightColor,info.NdotL);
}
vec3 computeDiffuseLighting(preLightingInfo info,vec3 lightColor) {
float diffuseTerm=diffuseBRDF_Burley(info.NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*info.attenuation*info.NdotL*lightColor;
}
#define inline
vec3 computeProjectionTextureDiffuseLighting(sampler2D projectionLightSampler,mat4 textureProjectionMatrix){
vec4 strq=textureProjectionMatrix*vec4(vPositionW,1.0);
strq/=strq.w;
vec3 textureColor=texture2D(projectionLightSampler,strq.xy).rgb;
return toLinearSpace(textureColor);
}
#ifdef SS_TRANSLUCENCY
vec3 computeDiffuseAndTransmittedLighting(preLightingInfo info,vec3 lightColor,vec3 transmittance) {
float NdotL=absEps(info.NdotLUnclamped);
float wrapNdotL=computeWrappedDiffuseNdotL(NdotL,0.02);
float trAdapt=step(0.,info.NdotLUnclamped);
vec3 transmittanceNdotL=mix(transmittance*wrapNdotL,vec3(wrapNdotL),trAdapt);
float diffuseTerm=diffuseBRDF_Burley(NdotL,info.NdotV,info.VdotH,info.roughness);
return diffuseTerm*transmittanceNdotL*info.attenuation*lightColor;
}
#endif
#ifdef SPECULARTERM
vec3 computeSpecularLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NdotH,alphaG);
#ifdef BRDF_V_HEIGHT_CORRELATED
float smithVisibility=smithVisibility_GGXCorrelated(info.NdotL,info.NdotV,alphaG);
#else
float smithVisibility=smithVisibility_TrowbridgeReitzGGXFast(info.NdotL,info.NdotV,alphaG);
#endif
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef ANISOTROPIC
vec3 computeAnisotropicSpecularLighting(preLightingInfo info,vec3 V,vec3 N,vec3 T,vec3 B,float anisotropy,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float TdotH=dot(T,info.H);
float BdotH=dot(B,info.H);
float TdotV=dot(T,V);
float BdotV=dot(B,V);
float TdotL=dot(T,info.L);
float BdotL=dot(B,info.L);
float alphaG=convertRoughnessToAverageSlope(info.roughness);
vec2 alphaTB=getAnisotropicRoughness(alphaG,anisotropy);
alphaTB=max(alphaTB,square(geometricRoughnessFactor));
vec3 fresnel=fresnelSchlickGGX(info.VdotH,reflectance0,reflectance90);
#ifdef IRIDESCENCE
fresnel=mix(fresnel,reflectance0,info.iridescenceIntensity);
#endif
float distribution=normalDistributionFunction_BurleyGGX_Anisotropic(NdotH,TdotH,BdotH,alphaTB);
float smithVisibility=smithVisibility_GGXCorrelated_Anisotropic(info.NdotL,info.NdotV,TdotV,BdotV,TdotL,BdotL,alphaTB);
vec3 specTerm=fresnel*distribution*smithVisibility;
return specTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
#ifdef CLEARCOAT
vec4 computeClearCoatLighting(preLightingInfo info,vec3 Ncc,float geometricRoughnessFactor,float clearCoatIntensity,vec3 lightColor) {
float NccdotL=saturateEps(dot(Ncc,info.L));
float NccdotH=saturateEps(dot(Ncc,info.H));
float clearCoatRoughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
float fresnel=fresnelSchlickGGX(info.VdotH,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnel*=clearCoatIntensity;
float distribution=normalDistributionFunction_TrowbridgeReitzGGX(NccdotH,alphaG);
float kelemenVisibility=visibility_Kelemen(info.VdotH);
float clearCoatTerm=fresnel*distribution*kelemenVisibility;
return vec4(
clearCoatTerm*info.attenuation*NccdotL*lightColor,
1.0-fresnel
);
}
vec3 computeClearCoatLightingAbsorption(float NdotVRefract,vec3 L,vec3 Ncc,vec3 clearCoatColor,float clearCoatThickness,float clearCoatIntensity) {
vec3 LRefract=-refract(L,Ncc,vClearCoatRefractionParams.y);
float NdotLRefract=saturateEps(dot(Ncc,LRefract));
vec3 absorption=computeClearCoatAbsorption(NdotVRefract,NdotLRefract,clearCoatColor,clearCoatThickness,clearCoatIntensity);
return absorption;
}
#endif
#ifdef SHEEN
vec3 computeSheenLighting(preLightingInfo info,vec3 N,vec3 reflectance0,vec3 reflectance90,float geometricRoughnessFactor,vec3 lightColor) {
float NdotH=saturateEps(dot(N,info.H));
float roughness=max(info.roughness,geometricRoughnessFactor);
float alphaG=convertRoughnessToAverageSlope(roughness);
float fresnel=1.;
float distribution=normalDistributionFunction_CharlieSheen(NdotH,alphaG);
/*#ifdef SHEEN_SOFTER
float visibility=visibility_CharlieSheen(info.NdotL,info.NdotV,alphaG);
#else */
float visibility=visibility_Ashikhmin(info.NdotL,info.NdotV);
/* #endif */
float sheenTerm=fresnel*distribution*visibility;
return sheenTerm*info.attenuation*info.NdotL*lightColor;
}
#endif
`;Y.IncludesShadersStore[uC]=dC;const fC="pbrIBLFunctions",pC=`#if defined(REFLECTION) || defined(SS_REFRACTION)
float getLodFromAlphaG(float cubeMapDimensionPixels,float microsurfaceAverageSlope) {
float microsurfaceAverageSlopeTexels=cubeMapDimensionPixels*microsurfaceAverageSlope;
float lod=log2(microsurfaceAverageSlopeTexels);
return lod;
}
float getLinearLodFromRoughness(float cubeMapDimensionPixels,float roughness) {
float lod=log2(cubeMapDimensionPixels)*roughness;
return lod;
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(RADIANCEOCCLUSION)
float environmentRadianceOcclusion(float ambientOcclusion,float NdotVUnclamped) {
float temp=NdotVUnclamped+ambientOcclusion;
return saturate(square(temp)-1.0+ambientOcclusion);
}
#endif
#if defined(ENVIRONMENTBRDF) && defined(HORIZONOCCLUSION)
float environmentHorizonOcclusion(vec3 view,vec3 normal,vec3 geometricNormal) {
vec3 reflection=reflect(view,normal);
float temp=saturate(1.0+1.1*dot(reflection,geometricNormal));
return square(temp);
}
#endif
#if defined(LODINREFLECTIONALPHA) || defined(SS_LODINREFRACTIONALPHA)
#define UNPACK_LOD(x) (1.0-x)*255.0
float getLodFromAlphaG(float cubeMapDimensionPixels,float alphaG,float NdotV) {
float microsurfaceAverageSlope=alphaG;
microsurfaceAverageSlope*=sqrt(abs(NdotV));
return getLodFromAlphaG(cubeMapDimensionPixels,microsurfaceAverageSlope);
}
#endif
`;Y.IncludesShadersStore[fC]=pC;const _C="pbrBlockAlbedoOpacity",mC=`struct albedoOpacityOutParams
{
vec3 surfaceAlbedo;
float alpha;
};
#define pbr_inline
void albedoOpacityBlock(
in vec4 vAlbedoColor,
#ifdef ALBEDO
in vec4 albedoTexture,
in vec2 albedoInfos,
#endif
#ifdef OPACITY
in vec4 opacityMap,
in vec2 vOpacityInfos,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out albedoOpacityOutParams outParams
)
{
vec3 surfaceAlbedo=vAlbedoColor.rgb;
float alpha=vAlbedoColor.a;
#ifdef ALBEDO
#if defined(ALPHAFROMALBEDO) || defined(ALPHATEST)
alpha*=albedoTexture.a;
#endif
#ifdef GAMMAALBEDO
surfaceAlbedo*=toLinearSpace(albedoTexture.rgb);
#else
surfaceAlbedo*=albedoTexture.rgb;
#endif
surfaceAlbedo*=albedoInfos.y;
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
surfaceAlbedo*=vColor.rgb;
#endif
#ifdef DETAIL
float detailAlbedo=2.0*mix(0.5,detailColor.r,vDetailInfos.y);
surfaceAlbedo.rgb=surfaceAlbedo.rgb*detailAlbedo*detailAlbedo; 
#endif
#define CUSTOM_FRAGMENT_UPDATE_ALBEDO
#ifdef OPACITY
#ifdef OPACITYRGB
alpha=getLuminance(opacityMap.rgb);
#else
alpha*=opacityMap.a;
#endif
alpha*=vOpacityInfos.y;
#endif
#if defined(VERTEXALPHA) || defined(INSTANCESCOLOR) && defined(INSTANCES)
alpha*=vColor.a;
#endif
#if !defined(SS_LINKREFRACTIONTOTRANSPARENCY) && !defined(ALPHAFRESNEL)
#ifdef ALPHATEST
if (alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
alpha=1.0;
#endif
#endif
#endif
outParams.surfaceAlbedo=surfaceAlbedo;
outParams.alpha=alpha;
}
`;Y.IncludesShadersStore[_C]=mC;const gC="pbrBlockReflectivity",vC=`struct reflectivityOutParams
{
float microSurface;
float roughness;
vec3 surfaceReflectivityColor;
#ifdef METALLICWORKFLOW
vec3 surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
vec3 ambientOcclusionColor;
#endif
#if DEBUGMODE>0
vec4 surfaceMetallicColorMap;
vec4 surfaceReflectivityColorMap;
vec2 metallicRoughness;
vec3 metallicF0;
#endif
};
#define pbr_inline
void reflectivityBlock(
in vec4 vReflectivityColor,
#ifdef METALLICWORKFLOW
in vec3 surfaceAlbedo,
in vec4 metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
in vec3 reflectivityInfos,
in vec4 surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
in vec3 ambientOcclusionColorIn,
#endif
#ifdef MICROSURFACEMAP
in vec4 microSurfaceTexel,
#endif
#ifdef DETAIL
in vec4 detailColor,
in vec4 vDetailInfos,
#endif
out reflectivityOutParams outParams
)
{
float microSurface=vReflectivityColor.a;
vec3 surfaceReflectivityColor=vReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec2 metallicRoughness=surfaceReflectivityColor.rg;
#ifdef REFLECTIVITY
#if DEBUGMODE>0
outParams.surfaceMetallicColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef AOSTOREINMETALMAPRED
vec3 aoStoreInMetalMap=vec3(surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r,surfaceMetallicOrReflectivityColorMap.r);
outParams.ambientOcclusionColor=mix(ambientOcclusionColorIn,aoStoreInMetalMap,reflectivityInfos.z);
#endif
#ifdef METALLNESSSTOREINMETALMAPBLUE
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.b;
#else
metallicRoughness.r*=surfaceMetallicOrReflectivityColorMap.r;
#endif
#ifdef ROUGHNESSSTOREINMETALMAPALPHA
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.a;
#else
#ifdef ROUGHNESSSTOREINMETALMAPGREEN
metallicRoughness.g*=surfaceMetallicOrReflectivityColorMap.g;
#endif
#endif
#endif
#ifdef DETAIL
float detailRoughness=mix(0.5,detailColor.b,vDetailInfos.w);
float loLerp=mix(0.,metallicRoughness.g,detailRoughness*2.);
float hiLerp=mix(metallicRoughness.g,1.,(detailRoughness-0.5)*2.);
metallicRoughness.g=mix(loLerp,hiLerp,step(detailRoughness,0.5));
#endif
#ifdef MICROSURFACEMAP
metallicRoughness.g*=microSurfaceTexel.r;
#endif
#if DEBUGMODE>0
outParams.metallicRoughness=metallicRoughness;
#endif
#define CUSTOM_FRAGMENT_UPDATE_METALLICROUGHNESS
microSurface=1.0-metallicRoughness.g;
vec3 baseColor=surfaceAlbedo;
#ifdef FROSTBITE_REFLECTANCE
outParams.surfaceAlbedo=baseColor.rgb*(1.0-metallicRoughness.r);
surfaceReflectivityColor=mix(0.16*reflectance*reflectance,baseColor,metallicRoughness.r);
#else
vec3 metallicF0=metallicReflectanceFactors.rgb;
#if DEBUGMODE>0
outParams.metallicF0=metallicF0;
#endif
outParams.surfaceAlbedo=mix(baseColor.rgb*(1.0-metallicF0),vec3(0.,0.,0.),metallicRoughness.r);
surfaceReflectivityColor=mix(metallicF0,baseColor,metallicRoughness.r);
#endif
#else
#ifdef REFLECTIVITY
surfaceReflectivityColor*=surfaceMetallicOrReflectivityColorMap.rgb;
#if DEBUGMODE>0
outParams.surfaceReflectivityColorMap=surfaceMetallicOrReflectivityColorMap;
#endif
#ifdef MICROSURFACEFROMREFLECTIVITYMAP
microSurface*=surfaceMetallicOrReflectivityColorMap.a;
microSurface*=reflectivityInfos.z;
#else
#ifdef MICROSURFACEAUTOMATIC
microSurface*=computeDefaultMicroSurface(microSurface,surfaceReflectivityColor);
#endif
#ifdef MICROSURFACEMAP
microSurface*=microSurfaceTexel.r;
#endif
#define CUSTOM_FRAGMENT_UPDATE_MICROSURFACE
#endif
#endif
#endif
microSurface=saturate(microSurface);
float roughness=1.-microSurface;
outParams.microSurface=microSurface;
outParams.roughness=roughness;
outParams.surfaceReflectivityColor=surfaceReflectivityColor;
}
`;Y.IncludesShadersStore[gC]=vC;const xC="pbrBlockAmbientOcclusion",TC=`struct ambientOcclusionOutParams
{
vec3 ambientOcclusionColor;
#if DEBUGMODE>0
vec3 ambientOcclusionColorMap;
#endif
};
#define pbr_inline
void ambientOcclusionBlock(
#ifdef AMBIENT
in vec3 ambientOcclusionColorMap_,
in vec4 vAmbientInfos,
#endif
out ambientOcclusionOutParams outParams
)
{
vec3 ambientOcclusionColor=vec3(1.,1.,1.);
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=ambientOcclusionColorMap_*vAmbientInfos.y;
#ifdef AMBIENTINGRAYSCALE
ambientOcclusionColorMap=vec3(ambientOcclusionColorMap.r,ambientOcclusionColorMap.r,ambientOcclusionColorMap.r);
#endif
ambientOcclusionColor=mix(ambientOcclusionColor,ambientOcclusionColorMap,vAmbientInfos.z);
#if DEBUGMODE>0
outParams.ambientOcclusionColorMap=ambientOcclusionColorMap;
#endif
#endif
outParams.ambientOcclusionColor=ambientOcclusionColor;
}
`;Y.IncludesShadersStore[xC]=TC;const bC="pbrBlockAlphaFresnel",SC=`#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
struct alphaFresnelOutParams
{
float alpha;
};
#define pbr_inline
void alphaFresnelBlock(
in vec3 normalW,
in vec3 viewDirectionW,
in float alpha,
in float microSurface,
out alphaFresnelOutParams outParams
)
{
float opacityPerceptual=alpha;
#ifdef LINEARALPHAFRESNEL
float opacity0=opacityPerceptual;
#else
float opacity0=opacityPerceptual*opacityPerceptual;
#endif
float opacity90=fresnelGrazingReflectance(opacity0);
vec3 normalForward=faceforward(normalW,-viewDirectionW,normalW);
outParams.alpha=getReflectanceFromAnalyticalBRDFLookup_Jones(saturate(dot(viewDirectionW,normalForward)),vec3(opacity0),vec3(opacity90),sqrt(microSurface)).x;
#ifdef ALPHATEST
if (outParams.alpha<ALPHATESTVALUE)
discard;
#ifndef ALPHABLEND
outParams.alpha=1.0;
#endif
#endif
}
#endif
#endif
`;Y.IncludesShadersStore[bC]=SC;const EC="pbrBlockAnisotropic",CC=`#ifdef ANISOTROPIC
struct anisotropicOutParams
{
float anisotropy;
vec3 anisotropicTangent;
vec3 anisotropicBitangent;
vec3 anisotropicNormal;
#if DEBUGMODE>0
vec3 anisotropyMapData;
#endif
};
#define pbr_inline
void anisotropicBlock(
in vec3 vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
in vec3 anisotropyMapData,
#endif
in mat3 TBN,
in vec3 normalW,
in vec3 viewDirectionW,
out anisotropicOutParams outParams
)
{
float anisotropy=vAnisotropy.b;
vec3 anisotropyDirection=vec3(vAnisotropy.xy,0.);
#ifdef ANISOTROPIC_TEXTURE
anisotropy*=anisotropyMapData.b;
anisotropyDirection.rg*=anisotropyMapData.rg*2.0-1.0;
#if DEBUGMODE>0
outParams.anisotropyMapData=anisotropyMapData;
#endif
#endif
mat3 anisoTBN=mat3(normalize(TBN[0]),normalize(TBN[1]),normalize(TBN[2]));
vec3 anisotropicTangent=normalize(anisoTBN*anisotropyDirection);
vec3 anisotropicBitangent=normalize(cross(anisoTBN[2],anisotropicTangent));
outParams.anisotropy=anisotropy;
outParams.anisotropicTangent=anisotropicTangent;
outParams.anisotropicBitangent=anisotropicBitangent;
outParams.anisotropicNormal=getAnisotropicBentNormals(anisotropicTangent,anisotropicBitangent,normalW,viewDirectionW,anisotropy);
}
#endif
`;Y.IncludesShadersStore[EC]=CC;const yC="pbrBlockReflection",AC=`#ifdef REFLECTION
struct reflectionOutParams
{
vec4 environmentRadiance;
vec3 environmentIrradiance;
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords;
#else
vec2 reflectionCoords;
#endif
#ifdef SS_TRANSLUCENCY
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
vec3 irradianceVector;
#endif
#endif
#endif
};
#define pbr_inline
void createReflectionCoords(
in vec3 vPositionW,
in vec3 normalW,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REFLECTIONMAP_3D
out vec3 reflectionCoords
#else
out vec2 reflectionCoords
#endif
)
{
#ifdef ANISOTROPIC
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),anisotropicOut.anisotropicNormal);
#else
vec3 reflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),normalW);
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
reflectionCoords=reflectionVector;
#else
reflectionCoords=reflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
reflectionCoords/=reflectionVector.z;
#endif
reflectionCoords.y=1.0-reflectionCoords.y;
#endif
}
#define pbr_inline
#define inline
void sampleReflectionTexture(
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
const vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
const vec2 reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out vec4 environmentRadiance
)
{
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG,NdotVUnclamped);
#elif defined(LINEARSPECULARREFLECTION)
float reflectionLOD=getLinearLodFromRoughness(vReflectionMicrosurfaceInfos.x,roughness);
#else
float reflectionLOD=getLodFromAlphaG(vReflectionMicrosurfaceInfos.x,alphaG);
#endif
#ifdef LODBASEDMICROSFURACE
reflectionLOD=reflectionLOD*vReflectionMicrosurfaceInfos.y+vReflectionMicrosurfaceInfos.z;
#ifdef LODINREFLECTIONALPHA
float automaticReflectionLOD=UNPACK_LOD(sampleReflection(reflectionSampler,reflectionCoords).a);
float requestedReflectionLOD=max(automaticReflectionLOD,reflectionLOD);
#else
float requestedReflectionLOD=reflectionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRadiance=vec4(radiance(alphaG,reflectionSampler,reflectionCoords,vReflectionFilteringInfo),1.0);
#else
environmentRadiance=sampleReflectionLod(reflectionSampler,reflectionCoords,reflectionLOD);
#endif
#else
float lodReflectionNormalized=saturate(reflectionLOD/log2(vReflectionMicrosurfaceInfos.x));
float lodReflectionNormalizedDoubled=lodReflectionNormalized*2.0;
vec4 environmentMid=sampleReflection(reflectionSampler,reflectionCoords);
if (lodReflectionNormalizedDoubled<1.0){
environmentRadiance=mix(
sampleReflection(reflectionSamplerHigh,reflectionCoords),
environmentMid,
lodReflectionNormalizedDoubled
);
} else {
environmentRadiance=mix(
environmentMid,
sampleReflection(reflectionSamplerLow,reflectionCoords),
lodReflectionNormalizedDoubled-1.0
);
}
#endif
#ifdef RGBDREFLECTION
environmentRadiance.rgb=fromRGBD(environmentRadiance);
#endif
#ifdef GAMMAREFLECTION
environmentRadiance.rgb=toLinearSpace(environmentRadiance.rgb);
#endif
environmentRadiance.rgb*=vReflectionInfos.x;
environmentRadiance.rgb*=vReflectionColor.rgb;
}
#define pbr_inline
#define inline
void reflectionBlock(
in vec3 vPositionW,
in vec3 normalW,
in float alphaG,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
in float NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
in float roughness,
#endif
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
in vec3 vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in mat4 reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
out reflectionOutParams outParams
)
{
vec4 environmentRadiance=vec4(0.,0.,0.,0.);
#ifdef REFLECTIONMAP_3D
vec3 reflectionCoords=vec3(0.);
#else
vec2 reflectionCoords=vec2(0.);
#endif
createReflectionCoords(
vPositionW,
normalW,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
reflectionCoords
);
sampleReflectionTexture(
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
#ifdef REFLECTIONMAP_3D
reflectionSampler,
reflectionCoords,
#else
reflectionSampler,
reflectionCoords,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentRadiance
);
vec3 environmentIrradiance=vec3(0.,0.,0.);
#ifdef USESPHERICALFROMREFLECTIONMAP
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
environmentIrradiance=vEnvironmentIrradiance;
#else
#ifdef ANISOTROPIC
vec3 irradianceVector=vec3(reflectionMatrix*vec4(anisotropicOut.anisotropicNormal,0)).xyz;
#else
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#endif
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#if defined(REALTIME_FILTERING)
environmentIrradiance=irradiance(reflectionSampler,irradianceVector,vReflectionFilteringInfo);
#else
environmentIrradiance=computeEnvironmentIrradiance(irradianceVector);
#endif
#ifdef SS_TRANSLUCENCY
outParams.irradianceVector=irradianceVector;
#endif
#endif
#elif defined(USEIRRADIANCEMAP)
vec4 environmentIrradiance4=sampleReflection(irradianceSampler,reflectionCoords);
environmentIrradiance=environmentIrradiance4.rgb;
#ifdef RGBDREFLECTION
environmentIrradiance.rgb=fromRGBD(environmentIrradiance4);
#endif
#ifdef GAMMAREFLECTION
environmentIrradiance.rgb=toLinearSpace(environmentIrradiance.rgb);
#endif
#endif
environmentIrradiance*=vReflectionColor.rgb;
outParams.environmentRadiance=environmentRadiance;
outParams.environmentIrradiance=environmentIrradiance;
outParams.reflectionCoords=reflectionCoords;
}
#endif
`;Y.IncludesShadersStore[yC]=AC;const RC="pbrBlockSheen",IC=`#ifdef SHEEN
struct sheenOutParams
{
float sheenIntensity;
vec3 sheenColor;
float sheenRoughness;
#ifdef SHEEN_LINKWITHALBEDO
vec3 surfaceAlbedo;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
float sheenAlbedoScaling;
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
vec3 finalSheenRadianceScaled;
#endif
#if DEBUGMODE>0
vec4 sheenMapData;
vec3 sheenEnvironmentReflectance;
#endif
};
#define pbr_inline
#define inline
void sheenBlock(
in vec4 vSheenColor,
#ifdef SHEEN_ROUGHNESS
in float vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 sheenMapRoughnessData,
#endif
#endif
in float roughness,
#ifdef SHEEN_TEXTURE
in vec4 sheenMapData,
in float sheenMapLevel,
#endif
in float reflectance,
#ifdef SHEEN_LINKWITHALBEDO
in vec3 baseColor,
in vec3 surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
in float NdotV,
in vec3 environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
in vec2 AARoughnessFactors,
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
in vec3 reflectionCoords,
#else
in sampler2D reflectionSampler,
in vec2 reflectionCoords,
#endif
in float NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
in float seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
in float eho,
#endif
#endif
out sheenOutParams outParams
)
{
float sheenIntensity=vSheenColor.a;
#ifdef SHEEN_TEXTURE
#if DEBUGMODE>0
outParams.sheenMapData=sheenMapData;
#endif
#endif
#ifdef SHEEN_LINKWITHALBEDO
float sheenFactor=pow5(1.0-sheenIntensity);
vec3 sheenColor=baseColor.rgb*(1.0-sheenFactor);
float sheenRoughness=sheenIntensity;
outParams.surfaceAlbedo=surfaceAlbedo*sheenFactor;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#else
vec3 sheenColor=vSheenColor.rgb;
#ifdef SHEEN_TEXTURE
#ifdef SHEEN_GAMMATEXTURE
sheenColor.rgb*=toLinearSpace(sheenMapData.rgb);
#else
sheenColor.rgb*=sheenMapData.rgb;
#endif
sheenColor.rgb*=sheenMapLevel;
#endif
#ifdef SHEEN_ROUGHNESS
float sheenRoughness=vSheenRoughness;
#ifdef SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE
#if defined(SHEEN_TEXTURE)
sheenRoughness*=sheenMapData.a;
#endif
#elif defined(SHEEN_TEXTURE_ROUGHNESS)
#ifdef SHEEN_TEXTURE_ROUGHNESS_IDENTICAL
sheenRoughness*=sheenMapData.a;
#else
sheenRoughness*=sheenMapRoughnessData.a;
#endif
#endif
#else
float sheenRoughness=roughness;
#ifdef SHEEN_TEXTURE
sheenIntensity*=sheenMapData.a;
#endif
#endif
#if !defined(SHEEN_ALBEDOSCALING)
sheenIntensity*=(1.-reflectance);
#endif
sheenColor*=sheenIntensity;
#endif
#ifdef ENVIRONMENTBRDF
/*#ifdef SHEEN_SOFTER
vec3 environmentSheenBrdf=vec3(0.,0.,getBRDFLookupCharlieSheen(NdotV,sheenRoughness));
#else*/
#ifdef SHEEN_ROUGHNESS
vec3 environmentSheenBrdf=getBRDFLookup(NdotV,sheenRoughness);
#else
vec3 environmentSheenBrdf=environmentBrdf;
#endif
/*#endif*/
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
float sheenAlphaG=convertRoughnessToAverageSlope(sheenRoughness);
#ifdef SPECULARAA
sheenAlphaG+=AARoughnessFactors.y;
#endif
vec4 environmentSheenRadiance=vec4(0.,0.,0.,0.);
sampleReflectionTexture(
sheenAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
sheenRoughness,
#endif
reflectionSampler,
reflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentSheenRadiance
);
vec3 sheenEnvironmentReflectance=getSheenReflectanceFromBRDFLookup(sheenColor,environmentSheenBrdf);
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
sheenEnvironmentReflectance*=seo;
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
sheenEnvironmentReflectance*=eho;
#endif
#if DEBUGMODE>0
outParams.sheenEnvironmentReflectance=sheenEnvironmentReflectance;
#endif
outParams.finalSheenRadianceScaled=
environmentSheenRadiance.rgb *
sheenEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
outParams.sheenAlbedoScaling=1.0-sheenIntensity*max(max(sheenColor.r,sheenColor.g),sheenColor.b)*environmentSheenBrdf.b;
#endif
outParams.sheenIntensity=sheenIntensity;
outParams.sheenColor=sheenColor;
outParams.sheenRoughness=sheenRoughness;
}
#endif
`;Y.IncludesShadersStore[RC]=IC;const PC="pbrBlockClearcoat",MC=`struct clearcoatOutParams
{
vec3 specularEnvironmentR0;
float conservationFactor;
vec3 clearCoatNormalW;
vec2 clearCoatAARoughnessFactors;
float clearCoatIntensity;
float clearCoatRoughness;
#ifdef REFLECTION
vec3 finalClearCoatRadianceScaled;
#endif
#ifdef CLEARCOAT_TINT
vec3 absorption;
float clearCoatNdotVRefract;
vec3 clearCoatColor;
float clearCoatThickness;
#endif
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
vec3 energyConservationFactorClearCoat;
#endif
#if DEBUGMODE>0
mat3 TBNClearCoat;
vec2 clearCoatMapData;
vec4 clearCoatTintMapData;
vec4 environmentClearCoatRadiance;
float clearCoatNdotV;
vec3 clearCoatEnvironmentReflectance;
#endif
};
#ifdef CLEARCOAT
#define pbr_inline
#define inline
void clearcoatBlock(
in vec3 vPositionW,
in vec3 geometricNormalW,
in vec3 viewDirectionW,
in vec2 vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
in vec4 clearCoatMapRoughnessData,
#endif
in vec3 specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
in vec4 vClearCoatTintParams,
in float clearCoatColorAtDistance,
in vec4 vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
in vec4 clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
in vec2 vClearCoatBumpInfos,
in vec4 clearCoatBumpMapData,
in vec2 vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
in mat3 vTBN,
#else
in vec2 vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
in mat4 normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
in vec3 faceNormal,
#endif
#ifdef REFLECTION
in vec3 vReflectionMicrosurfaceInfos,
in vec2 vReflectionInfos,
in vec3 vReflectionColor,
in vec4 vLightingIntensity,
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSampler,
#else
in sampler2D reflectionSampler,
#endif
#ifndef LODBASEDMICROSFURACE
#ifdef REFLECTIONMAP_3D
in samplerCube reflectionSamplerLow,
in samplerCube reflectionSamplerHigh,
#else
in sampler2D reflectionSamplerLow,
in sampler2D reflectionSamplerHigh,
#endif
#endif
#ifdef REALTIME_FILTERING
in vec2 vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
in float ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
in float frontFacingMultiplier,
#endif
out clearcoatOutParams outParams
)
{
float clearCoatIntensity=vClearCoatParams.x;
float clearCoatRoughness=vClearCoatParams.y;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#ifdef CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE
clearCoatRoughness*=clearCoatMapData.y;
#endif
#if DEBUGMODE>0
outParams.clearCoatMapData=clearCoatMapData;
#endif
#endif
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL
clearCoatRoughness*=clearCoatMapData.y;
#else
clearCoatRoughness*=clearCoatMapRoughnessData.y;
#endif
#endif
outParams.clearCoatIntensity=clearCoatIntensity;
outParams.clearCoatRoughness=clearCoatRoughness;
#ifdef CLEARCOAT_TINT
vec3 clearCoatColor=vClearCoatTintParams.rgb;
float clearCoatThickness=vClearCoatTintParams.a;
#ifdef CLEARCOAT_TINT_TEXTURE
#ifdef CLEARCOAT_TINT_GAMMATEXTURE
clearCoatColor*=toLinearSpace(clearCoatTintMapData.rgb);
#else
clearCoatColor*=clearCoatTintMapData.rgb;
#endif
clearCoatThickness*=clearCoatTintMapData.a;
#if DEBUGMODE>0
outParams.clearCoatTintMapData=clearCoatTintMapData;
#endif
#endif
outParams.clearCoatColor=computeColorAtDistanceInMedia(clearCoatColor,clearCoatColorAtDistance);
outParams.clearCoatThickness=clearCoatThickness;
#endif
#ifdef CLEARCOAT_REMAP_F0
vec3 specularEnvironmentR0Updated=getR0RemappedForClearCoat(specularEnvironmentR0);
#else
vec3 specularEnvironmentR0Updated=specularEnvironmentR0;
#endif
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,specularEnvironmentR0Updated,clearCoatIntensity);
vec3 clearCoatNormalW=geometricNormalW;
#ifdef CLEARCOAT_BUMP
#ifdef NORMALXYSCALE
float clearCoatNormalScale=1.0;
#else
float clearCoatNormalScale=vClearCoatBumpInfos.y;
#endif
#if defined(TANGENT) && defined(NORMAL)
mat3 TBNClearCoat=vTBN;
#else
vec2 TBNClearCoatUV=vClearCoatBumpUV*frontFacingMultiplier;
mat3 TBNClearCoat=cotangent_frame(clearCoatNormalW*clearCoatNormalScale,vPositionW,TBNClearCoatUV,vClearCoatTangentSpaceParams);
#endif
#if DEBUGMODE>0
outParams.TBNClearCoat=TBNClearCoat;
#endif
#ifdef OBJECTSPACE_NORMALMAP
clearCoatNormalW=normalize(clearCoatBumpMapData.xyz *2.0-1.0);
clearCoatNormalW=normalize(mat3(normalMatrix)*clearCoatNormalW);
#else
clearCoatNormalW=perturbNormal(TBNClearCoat,clearCoatBumpMapData.xyz,vClearCoatBumpInfos.y);
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
clearCoatNormalW*=sign(dot(clearCoatNormalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
clearCoatNormalW=clearCoatNormalW*frontFacingMultiplier;
#endif
outParams.clearCoatNormalW=clearCoatNormalW;
outParams.clearCoatAARoughnessFactors=getAARoughnessFactors(clearCoatNormalW.xyz);
float clearCoatNdotVUnclamped=dot(clearCoatNormalW,viewDirectionW);
float clearCoatNdotV=absEps(clearCoatNdotVUnclamped);
#if DEBUGMODE>0
outParams.clearCoatNdotV=clearCoatNdotV;
#endif
#ifdef CLEARCOAT_TINT
vec3 clearCoatVRefract=refract(-viewDirectionW,clearCoatNormalW,vClearCoatRefractionParams.y);
outParams.clearCoatNdotVRefract=absEps(dot(clearCoatNormalW,clearCoatVRefract));
#endif
#if defined(ENVIRONMENTBRDF) && (!defined(REFLECTIONMAP_SKYBOX) || defined(MS_BRDF_ENERGY_CONSERVATION))
vec3 environmentClearCoatBrdf=getBRDFLookup(clearCoatNdotV,clearCoatRoughness);
#endif
#if defined(REFLECTION)
float clearCoatAlphaG=convertRoughnessToAverageSlope(clearCoatRoughness);
#ifdef SPECULARAA
clearCoatAlphaG+=outParams.clearCoatAARoughnessFactors.y;
#endif
vec4 environmentClearCoatRadiance=vec4(0.,0.,0.,0.);
vec3 clearCoatReflectionVector=computeReflectionCoords(vec4(vPositionW,1.0),clearCoatNormalW);
#ifdef REFLECTIONMAP_OPPOSITEZ
clearCoatReflectionVector.z*=-1.0;
#endif
#ifdef REFLECTIONMAP_3D
vec3 clearCoatReflectionCoords=clearCoatReflectionVector;
#else
vec2 clearCoatReflectionCoords=clearCoatReflectionVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
clearCoatReflectionCoords/=clearCoatReflectionVector.z;
#endif
clearCoatReflectionCoords.y=1.0-clearCoatReflectionCoords.y;
#endif
sampleReflectionTexture(
clearCoatAlphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
clearCoatNdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
clearCoatRoughness,
#endif
reflectionSampler,
clearCoatReflectionCoords,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
environmentClearCoatRadiance
);
#if DEBUGMODE>0
outParams.environmentClearCoatRadiance=environmentClearCoatRadiance;
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 clearCoatEnvironmentReflectance=getReflectanceFromBRDFLookup(vec3(vClearCoatRefractionParams.x),environmentClearCoatBrdf);
#ifdef RADIANCEOCCLUSION
float clearCoatSeo=environmentRadianceOcclusion(ambientMonochrome,clearCoatNdotVUnclamped);
clearCoatEnvironmentReflectance*=clearCoatSeo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float clearCoatEho=environmentHorizonOcclusion(-viewDirectionW,clearCoatNormalW,geometricNormalW);
clearCoatEnvironmentReflectance*=clearCoatEho;
#endif
#endif
#endif
#else
vec3 clearCoatEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(clearCoatNdotV,vec3(1.),vec3(1.),sqrt(1.-clearCoatRoughness));
#endif
clearCoatEnvironmentReflectance*=clearCoatIntensity;
#if DEBUGMODE>0
outParams.clearCoatEnvironmentReflectance=clearCoatEnvironmentReflectance;
#endif
outParams.finalClearCoatRadianceScaled=
environmentClearCoatRadiance.rgb *
clearCoatEnvironmentReflectance *
vLightingIntensity.z;
#endif
#if defined(CLEARCOAT_TINT)
outParams.absorption=computeClearCoatAbsorption(outParams.clearCoatNdotVRefract,outParams.clearCoatNdotVRefract,outParams.clearCoatColor,clearCoatThickness,clearCoatIntensity);
#endif
float fresnelIBLClearCoat=fresnelSchlickGGX(clearCoatNdotV,vClearCoatRefractionParams.x,CLEARCOATREFLECTANCE90);
fresnelIBLClearCoat*=clearCoatIntensity;
outParams.conservationFactor=(1.-fresnelIBLClearCoat);
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
outParams.energyConservationFactorClearCoat=getEnergyConservationFactor(outParams.specularEnvironmentR0,environmentClearCoatBrdf);
#endif
}
#endif
`;Y.IncludesShadersStore[PC]=MC;const DC="pbrBlockIridescence",OC=`struct iridescenceOutParams
{
float iridescenceIntensity;
float iridescenceIOR;
float iridescenceThickness;
vec3 specularEnvironmentR0;
};
#ifdef IRIDESCENCE
#define pbr_inline
#define inline
void iridescenceBlock(
in vec4 vIridescenceParams,
in float viewAngle,
in vec3 specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
in vec2 iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
in vec2 iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
in float NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
in vec2 clearCoatMapData,
#endif
#endif
out iridescenceOutParams outParams
)
{
float iridescenceIntensity=vIridescenceParams.x;
float iridescenceIOR=vIridescenceParams.y;
float iridescenceThicknessMin=vIridescenceParams.z;
float iridescenceThicknessMax=vIridescenceParams.w;
float iridescenceThicknessWeight=1.;
#ifdef IRIDESCENCE_TEXTURE
iridescenceIntensity*=iridescenceMapData.x;
#ifdef IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE
iridescenceThicknessWeight=iridescenceMapData.g;
#endif
#endif
#if defined(IRIDESCENCE_THICKNESS_TEXTURE)
iridescenceThicknessWeight=iridescenceThicknessMapData.g;
#endif
float iridescenceThickness=mix(iridescenceThicknessMin,iridescenceThicknessMax,iridescenceThicknessWeight);
float topIor=1.; 
#ifdef CLEARCOAT
float clearCoatIntensity=vClearCoatParams.x;
#ifdef CLEARCOAT_TEXTURE
clearCoatIntensity*=clearCoatMapData.x;
#endif
topIor=mix(1.0,vClearCoatRefractionParams.w-1.,clearCoatIntensity);
viewAngle=sqrt(1.0+square(1.0/topIor)*(square(NdotVUnclamped)-1.0));
#endif
vec3 iridescenceFresnel=evalIridescence(topIor,iridescenceIOR,viewAngle,iridescenceThickness,specularEnvironmentR0);
outParams.specularEnvironmentR0=mix(specularEnvironmentR0,iridescenceFresnel,iridescenceIntensity);
outParams.iridescenceIntensity=iridescenceIntensity;
outParams.iridescenceThickness=iridescenceThickness;
outParams.iridescenceIOR=iridescenceIOR;
}
#endif
`;Y.IncludesShadersStore[DC]=OC;const wC="pbrBlockSubSurface",NC=`struct subSurfaceOutParams
{
vec3 specularEnvironmentReflectance;
#ifdef SS_REFRACTION
vec3 finalRefraction;
vec3 surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
float alpha;
#endif
#ifdef REFLECTION
float refractionFactorForIrradiance;
#endif
#endif
#ifdef SS_TRANSLUCENCY
vec3 transmittance;
float translucencyIntensity;
#ifdef REFLECTION
vec3 refractionIrradiance;
#endif
#endif
#if DEBUGMODE>0
vec4 thicknessMap;
vec4 environmentRefraction;
vec3 refractionTransmittance;
#endif
};
#ifdef SUBSURFACE
#define pbr_inline
#define inline
void subSurfaceBlock(
in vec3 vSubSurfaceIntensity,
in vec2 vThicknessParam,
in vec4 vTintColor,
in vec3 normalW,
in vec3 specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
in vec4 thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
in vec4 refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
in vec4 translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
in mat4 reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
in vec3 irradianceVector_,
#endif
#if defined(REALTIME_FILTERING)
in samplerCube reflectionSampler,
in vec2 vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
#ifdef REFLECTIONMAP_3D
in samplerCube irradianceSampler,
#else
in sampler2D irradianceSampler,
#endif
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
in vec3 surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
in vec3 vPositionW,
in vec3 viewDirectionW,
in mat4 view,
in vec4 vRefractionInfos,
in mat4 refractionMatrix,
in vec4 vRefractionMicrosurfaceInfos,
in vec4 vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
in float alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
in float NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
in float roughness,
#endif
in float alphaG,
#ifdef SS_REFRACTIONMAP_3D
in samplerCube refractionSampler,
#ifndef LODBASEDMICROSFURACE
in samplerCube refractionSamplerLow,
in samplerCube refractionSamplerHigh,
#endif
#else
in sampler2D refractionSampler,
#ifndef LODBASEDMICROSFURACE
in sampler2D refractionSamplerLow,
in sampler2D refractionSamplerHigh,
#endif
#endif
#ifdef ANISOTROPIC
in anisotropicOutParams anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
in vec2 vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
in vec3 refractionPosition,
in vec3 refractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
in vec3 vDiffusionDistance,
#endif
out subSurfaceOutParams outParams
)
{
outParams.specularEnvironmentReflectance=specularEnvironmentReflectance;
#ifdef SS_REFRACTION
float refractionIntensity=vSubSurfaceIntensity.x;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
refractionIntensity*=(1.0-alpha);
outParams.alpha=1.0;
#endif
#endif
#ifdef SS_TRANSLUCENCY
float translucencyIntensity=vSubSurfaceIntensity.y;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
#if defined(SS_USE_GLTF_TEXTURES)
float thickness=thicknessMap.g*vThicknessParam.y+vThicknessParam.x;
#else
float thickness=thicknessMap.r*vThicknessParam.y+vThicknessParam.x;
#endif
#if DEBUGMODE>0
outParams.thicknessMap=thicknessMap;
#endif
#ifdef SS_MASK_FROM_THICKNESS_TEXTURE
#if defined(SS_REFRACTION) && defined(SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE)
#if defined(SS_USE_GLTF_TEXTURES)
refractionIntensity*=thicknessMap.r;
#else
refractionIntensity*=thicknessMap.g;
#endif
#endif
#if defined(SS_TRANSLUCENCY) && defined(SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE)
translucencyIntensity*=thicknessMap.b;
#endif
#endif
#else
float thickness=vThicknessParam.y;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
#ifdef SS_USE_GLTF_TEXTURES
refractionIntensity*=refractionIntensityMap.r;
#else
refractionIntensity*=refractionIntensityMap.g;
#endif
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensity*=translucencyIntensityMap.b;
#endif
#ifdef SS_TRANSLUCENCY
thickness=maxEps(thickness);
vec3 transmittance=transmittanceBRDF_Burley(vTintColor.rgb,vDiffusionDistance,thickness);
transmittance*=translucencyIntensity;
outParams.transmittance=transmittance;
outParams.translucencyIntensity=translucencyIntensity;
#endif
#ifdef SS_REFRACTION
vec4 environmentRefraction=vec4(0.,0.,0.,0.);
#ifdef ANISOTROPIC
vec3 refractionVector=refract(-viewDirectionW,anisotropicOut.anisotropicNormal,vRefractionInfos.y);
#else
vec3 refractionVector=refract(-viewDirectionW,normalW,vRefractionInfos.y);
#endif
#ifdef SS_REFRACTIONMAP_OPPOSITEZ
refractionVector.z*=-1.0;
#endif
#ifdef SS_REFRACTIONMAP_3D
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
refractionVector=parallaxCorrectNormal(vPositionW,refractionVector,refractionSize,refractionPosition);
#endif
refractionVector.y=refractionVector.y*vRefractionInfos.w;
vec3 refractionCoords=refractionVector;
refractionCoords=vec3(refractionMatrix*vec4(refractionCoords,0));
#else
#ifdef SS_USE_THICKNESS_AS_DEPTH
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*thickness,1.0)));
#else
vec3 vRefractionUVW=vec3(refractionMatrix*(view*vec4(vPositionW+refractionVector*vRefractionInfos.z,1.0)));
#endif
vec2 refractionCoords=vRefractionUVW.xy/vRefractionUVW.z;
refractionCoords.y=1.0-refractionCoords.y;
#endif
#ifdef SS_HAS_THICKNESS
float ior=vRefractionInfos.y;
#else
float ior=vRefractionMicrosurfaceInfos.w;
#endif
#ifdef SS_LODINREFRACTIONALPHA
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG,NdotVUnclamped);
#elif defined(SS_LINEARSPECULARREFRACTION)
float refractionRoughness=alphaG;
refractionRoughness=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLinearLodFromRoughness(vRefractionMicrosurfaceInfos.x,refractionRoughness);
#else
float refractionAlphaG=alphaG;
refractionAlphaG=mix(alphaG,0.0,clamp(ior*3.0-2.0,0.0,1.0));
float refractionLOD=getLodFromAlphaG(vRefractionMicrosurfaceInfos.x,refractionAlphaG);
#endif
#ifdef LODBASEDMICROSFURACE
refractionLOD=refractionLOD*vRefractionMicrosurfaceInfos.y+vRefractionMicrosurfaceInfos.z;
#ifdef SS_LODINREFRACTIONALPHA
float automaticRefractionLOD=UNPACK_LOD(sampleRefraction(refractionSampler,refractionCoords).a);
float requestedRefractionLOD=max(automaticRefractionLOD,refractionLOD);
#else
float requestedRefractionLOD=refractionLOD;
#endif
#ifdef REALTIME_FILTERING
environmentRefraction=vec4(radiance(alphaG,refractionSampler,refractionCoords,vRefractionFilteringInfo),1.0);
#else
environmentRefraction=sampleRefractionLod(refractionSampler,refractionCoords,requestedRefractionLOD);
#endif
#else
float lodRefractionNormalized=saturate(refractionLOD/log2(vRefractionMicrosurfaceInfos.x));
float lodRefractionNormalizedDoubled=lodRefractionNormalized*2.0;
vec4 environmentRefractionMid=sampleRefraction(refractionSampler,refractionCoords);
if (lodRefractionNormalizedDoubled<1.0){
environmentRefraction=mix(
sampleRefraction(refractionSamplerHigh,refractionCoords),
environmentRefractionMid,
lodRefractionNormalizedDoubled
);
} else {
environmentRefraction=mix(
environmentRefractionMid,
sampleRefraction(refractionSamplerLow,refractionCoords),
lodRefractionNormalizedDoubled-1.0
);
}
#endif
#ifdef SS_RGBDREFRACTION
environmentRefraction.rgb=fromRGBD(environmentRefraction);
#endif
#ifdef SS_GAMMAREFRACTION
environmentRefraction.rgb=toLinearSpace(environmentRefraction.rgb);
#endif
environmentRefraction.rgb*=vRefractionInfos.x;
#endif
#ifdef SS_REFRACTION
vec3 refractionTransmittance=vec3(refractionIntensity);
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,thickness);
#elif defined(SS_LINKREFRACTIONTOTRANSPARENCY)
float maxChannel=max(max(surfaceAlbedo.r,surfaceAlbedo.g),surfaceAlbedo.b);
vec3 volumeAlbedo=saturate(maxChannel*surfaceAlbedo);
environmentRefraction.rgb*=volumeAlbedo;
#else
vec3 volumeAlbedo=computeColorAtDistanceInMedia(vTintColor.rgb,vTintColor.w);
refractionTransmittance*=cocaLambert(volumeAlbedo,vThicknessParam.y);
#endif
#ifdef SS_ALBEDOFORREFRACTIONTINT
environmentRefraction.rgb*=surfaceAlbedo.rgb;
#endif
outParams.surfaceAlbedo=surfaceAlbedo*(1.-refractionIntensity);
#ifdef REFLECTION
outParams.refractionFactorForIrradiance=(1.-refractionIntensity);
#endif
#ifdef UNUSED_MULTIPLEBOUNCES
vec3 bounceSpecularEnvironmentReflectance=(2.0*specularEnvironmentReflectance)/(1.0+specularEnvironmentReflectance);
outParams.specularEnvironmentReflectance=mix(bounceSpecularEnvironmentReflectance,specularEnvironmentReflectance,refractionIntensity);
#endif
refractionTransmittance*=1.0-outParams.specularEnvironmentReflectance;
#if DEBUGMODE>0
outParams.refractionTransmittance=refractionTransmittance;
#endif
outParams.finalRefraction=environmentRefraction.rgb*refractionTransmittance*vLightingIntensity.z;
#if DEBUGMODE>0
outParams.environmentRefraction=environmentRefraction;
#endif
#endif
#if defined(REFLECTION) && defined(SS_TRANSLUCENCY)
#if defined(NORMAL) && defined(USESPHERICALINVERTEX) || !defined(USESPHERICALFROMREFLECTIONMAP)
vec3 irradianceVector=vec3(reflectionMatrix*vec4(normalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
irradianceVector.z*=-1.0;
#endif
#ifdef INVERTCUBICMAP
irradianceVector.y*=-1.0;
#endif
#else
vec3 irradianceVector=irradianceVector_;
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP)
#if defined(REALTIME_FILTERING)
vec3 refractionIrradiance=irradiance(reflectionSampler,-irradianceVector,vReflectionFilteringInfo);
#else
vec3 refractionIrradiance=computeEnvironmentIrradiance(-irradianceVector);
#endif
#elif defined(USEIRRADIANCEMAP)
#ifdef REFLECTIONMAP_3D
vec3 irradianceCoords=irradianceVector;
#else
vec2 irradianceCoords=irradianceVector.xy;
#ifdef REFLECTIONMAP_PROJECTION
irradianceCoords/=irradianceVector.z;
#endif
irradianceCoords.y=1.0-irradianceCoords.y;
#endif
vec4 refractionIrradiance=sampleReflection(irradianceSampler,-irradianceCoords);
#ifdef RGBDREFLECTION
refractionIrradiance.rgb=fromRGBD(refractionIrradiance);
#endif
#ifdef GAMMAREFLECTION
refractionIrradiance.rgb=toLinearSpace(refractionIrradiance.rgb);
#endif
#else
vec4 refractionIrradiance=vec4(0.);
#endif
refractionIrradiance.rgb*=transmittance;
#ifdef SS_ALBEDOFORTRANSLUCENCYTINT
refractionIrradiance.rgb*=surfaceAlbedo.rgb;
#endif
outParams.refractionIrradiance=refractionIrradiance.rgb;
#endif
}
#endif
`;Y.IncludesShadersStore[wC]=NC;const FC="pbrBlockNormalGeometric",LC=`vec3 viewDirectionW=normalize(vEyePosition.xyz-vPositionW);
#ifdef NORMAL
vec3 normalW=normalize(vNormalW);
#else
vec3 normalW=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#endif
vec3 geometricNormalW=normalW;
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
geometricNormalW=gl_FrontFacing ? geometricNormalW : -geometricNormalW;
#endif
`;Y.IncludesShadersStore[FC]=LC;const BC="pbrBlockNormalFinal",UC=`#if defined(FORCENORMALFORWARD) && defined(NORMAL)
vec3 faceNormal=normalize(cross(dFdx(vPositionW),dFdy(vPositionW)))*vEyePosition.w;
#if defined(TWOSIDEDLIGHTING)
faceNormal=gl_FrontFacing ? faceNormal : -faceNormal;
#endif
normalW*=sign(dot(normalW,faceNormal));
#endif
#if defined(TWOSIDEDLIGHTING) && defined(NORMAL)
normalW=gl_FrontFacing ? normalW : -normalW;
#endif
`;Y.IncludesShadersStore[BC]=UC;const VC="pbrBlockLightmapInit",kC=`#ifdef LIGHTMAP
vec4 lightmapColor=texture2D(lightmapSampler,vLightmapUV+uvOffset);
#ifdef RGBDLIGHTMAP
lightmapColor.rgb=fromRGBD(lightmapColor);
#endif
#ifdef GAMMALIGHTMAP
lightmapColor.rgb=toLinearSpace(lightmapColor.rgb);
#endif
lightmapColor.rgb*=vLightmapInfos.y;
#endif
`;Y.IncludesShadersStore[VC]=kC;const GC="pbrBlockGeometryInfo",zC=`float NdotVUnclamped=dot(normalW,viewDirectionW);
float NdotV=absEps(NdotVUnclamped);
float alphaG=convertRoughnessToAverageSlope(roughness);
vec2 AARoughnessFactors=getAARoughnessFactors(normalW.xyz);
#ifdef SPECULARAA
alphaG+=AARoughnessFactors.y;
#endif
#if defined(ENVIRONMENTBRDF)
vec3 environmentBrdf=getBRDFLookup(NdotV,roughness);
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
#ifdef AMBIENTINGRAYSCALE
float ambientMonochrome=aoOut.ambientOcclusionColor.r;
#else
float ambientMonochrome=getLuminance(aoOut.ambientOcclusionColor);
#endif
float seo=environmentRadianceOcclusion(ambientMonochrome,NdotVUnclamped);
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
float eho=environmentHorizonOcclusion(-viewDirectionW,normalW,geometricNormalW);
#endif
#endif
#endif
#endif
`;Y.IncludesShadersStore[GC]=zC;const WC="pbrBlockReflectance0",HC=`float reflectance=max(max(reflectivityOut.surfaceReflectivityColor.r,reflectivityOut.surfaceReflectivityColor.g),reflectivityOut.surfaceReflectivityColor.b);
vec3 specularEnvironmentR0=reflectivityOut.surfaceReflectivityColor.rgb;
#ifdef METALLICWORKFLOW
vec3 specularEnvironmentR90=vec3(metallicReflectanceFactors.a);
#else 
vec3 specularEnvironmentR90=vec3(1.0,1.0,1.0);
#endif
#ifdef ALPHAFRESNEL
float reflectance90=fresnelGrazingReflectance(reflectance);
specularEnvironmentR90=specularEnvironmentR90*reflectance90;
#endif
`;Y.IncludesShadersStore[WC]=HC;const XC="pbrBlockReflectance",YC=`#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
vec3 specularEnvironmentReflectance=getReflectanceFromBRDFLookup(clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,environmentBrdf);
#ifdef RADIANCEOCCLUSION
specularEnvironmentReflectance*=seo;
#endif
#ifdef HORIZONOCCLUSION
#ifdef BUMP
#ifdef REFLECTIONMAP_3D
specularEnvironmentReflectance*=eho;
#endif
#endif
#endif
#else
vec3 specularEnvironmentReflectance=getReflectanceFromAnalyticalBRDFLookup_Jones(NdotV,clearcoatOut.specularEnvironmentR0,specularEnvironmentR90,sqrt(microSurface));
#endif
#ifdef CLEARCOAT
specularEnvironmentReflectance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
specularEnvironmentReflectance*=clearcoatOut.absorption;
#endif
#endif
`;Y.IncludesShadersStore[XC]=YC;const KC="pbrBlockDirectLighting",$C=`vec3 diffuseBase=vec3(0.,0.,0.);
#ifdef SPECULARTERM
vec3 specularBase=vec3(0.,0.,0.);
#endif
#ifdef CLEARCOAT
vec3 clearCoatBase=vec3(0.,0.,0.);
#endif
#ifdef SHEEN
vec3 sheenBase=vec3(0.,0.,0.);
#endif
preLightingInfo preInfo;
lightingInfo info;
float shadow=1.; 
#if defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
vec3 absorption=vec3(0.);
#endif
`;Y.IncludesShadersStore[KC]=$C;const jC="pbrBlockFinalLitComponents",qC=`#if defined(ENVIRONMENTBRDF)
#ifdef MS_BRDF_ENERGY_CONSERVATION
vec3 energyConservationFactor=getEnergyConservationFactor(clearcoatOut.specularEnvironmentR0,environmentBrdf);
#endif
#endif
#ifndef METALLICWORKFLOW
#ifdef SPECULAR_GLOSSINESS_ENERGY_CONSERVATION
surfaceAlbedo.rgb=(1.-reflectance)*surfaceAlbedo.rgb;
#endif
#endif
#if defined(SHEEN) && defined(SHEEN_ALBEDOSCALING) && defined(ENVIRONMENTBRDF)
surfaceAlbedo.rgb=sheenOut.sheenAlbedoScaling*surfaceAlbedo.rgb;
#endif
#ifdef REFLECTION
vec3 finalIrradiance=reflectionOut.environmentIrradiance;
#if defined(CLEARCOAT)
finalIrradiance*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
finalIrradiance*=clearcoatOut.absorption;
#endif
#endif
#if defined(SS_REFRACTION)
finalIrradiance*=subSurfaceOut.refractionFactorForIrradiance;
#endif
#if defined(SS_TRANSLUCENCY)
finalIrradiance*=(1.0-subSurfaceOut.translucencyIntensity);
finalIrradiance+=subSurfaceOut.refractionIrradiance;
#endif
finalIrradiance*=surfaceAlbedo.rgb;
finalIrradiance*=vLightingIntensity.z;
finalIrradiance*=aoOut.ambientOcclusionColor;
#endif
#ifdef SPECULARTERM
vec3 finalSpecular=specularBase;
finalSpecular=max(finalSpecular,0.0);
vec3 finalSpecularScaled=finalSpecular*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalSpecularScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalSpecularScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef REFLECTION
vec3 finalRadiance=reflectionOut.environmentRadiance.rgb;
finalRadiance*=subSurfaceOut.specularEnvironmentReflectance;
vec3 finalRadianceScaled=finalRadiance*vLightingIntensity.z;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalRadianceScaled*=energyConservationFactor;
#endif
#if defined(SHEEN) && defined(ENVIRONMENTBRDF) && defined(SHEEN_ALBEDOSCALING)
finalRadianceScaled*=sheenOut.sheenAlbedoScaling;
#endif
#endif
#ifdef SHEEN
vec3 finalSheen=sheenBase*sheenOut.sheenColor;
finalSheen=max(finalSheen,0.0);
vec3 finalSheenScaled=finalSheen*vLightingIntensity.x*vLightingIntensity.w;
#if defined(CLEARCOAT) && defined(REFLECTION) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.conservationFactor;
#if defined(CLEARCOAT_TINT)
sheenOut.finalSheenRadianceScaled*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef CLEARCOAT
vec3 finalClearCoat=clearCoatBase;
finalClearCoat=max(finalClearCoat,0.0);
vec3 finalClearCoatScaled=finalClearCoat*vLightingIntensity.x*vLightingIntensity.w;
#if defined(ENVIRONMENTBRDF) && defined(MS_BRDF_ENERGY_CONSERVATION)
finalClearCoatScaled*=clearcoatOut.energyConservationFactorClearCoat;
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction*=clearcoatOut.conservationFactor;
#ifdef CLEARCOAT_TINT
subSurfaceOut.finalRefraction*=clearcoatOut.absorption;
#endif
#endif
#endif
#ifdef ALPHABLEND
float luminanceOverAlpha=0.0;
#if defined(REFLECTION) && defined(RADIANCEOVERALPHA)
luminanceOverAlpha+=getLuminance(finalRadianceScaled);
#if defined(CLEARCOAT)
luminanceOverAlpha+=getLuminance(clearcoatOut.finalClearCoatRadianceScaled);
#endif
#endif
#if defined(SPECULARTERM) && defined(SPECULAROVERALPHA)
luminanceOverAlpha+=getLuminance(finalSpecularScaled);
#endif
#if defined(CLEARCOAT) && defined(CLEARCOATOVERALPHA)
luminanceOverAlpha+=getLuminance(finalClearCoatScaled);
#endif
#if defined(RADIANCEOVERALPHA) || defined(SPECULAROVERALPHA) || defined(CLEARCOATOVERALPHA)
alpha=saturate(alpha+luminanceOverAlpha*luminanceOverAlpha);
#endif
#endif
`;Y.IncludesShadersStore[jC]=qC;const QC="pbrBlockFinalUnlitComponents",ZC=`vec3 finalDiffuse=diffuseBase;
finalDiffuse*=surfaceAlbedo.rgb;
finalDiffuse=max(finalDiffuse,0.0);
finalDiffuse*=vLightingIntensity.x;
vec3 finalAmbient=vAmbientColor;
finalAmbient*=surfaceAlbedo.rgb;
vec3 finalEmissive=vEmissiveColor;
#ifdef EMISSIVE
vec3 emissiveColorTex=texture2D(emissiveSampler,vEmissiveUV+uvOffset).rgb;
#ifdef GAMMAEMISSIVE
finalEmissive*=toLinearSpace(emissiveColorTex.rgb);
#else
finalEmissive*=emissiveColorTex.rgb;
#endif
finalEmissive*= vEmissiveInfos.y;
#endif
finalEmissive*=vLightingIntensity.y;
#ifdef AMBIENT
vec3 ambientOcclusionForDirectDiffuse=mix(vec3(1.),aoOut.ambientOcclusionColor,vAmbientInfos.w);
#else
vec3 ambientOcclusionForDirectDiffuse=aoOut.ambientOcclusionColor;
#endif
finalAmbient*=aoOut.ambientOcclusionColor;
finalDiffuse*=ambientOcclusionForDirectDiffuse;
`;Y.IncludesShadersStore[QC]=ZC;const JC="pbrBlockFinalColorComposition",ey=`vec4 finalColor=vec4(
finalAmbient +
finalDiffuse +
#ifndef UNLIT
#ifdef REFLECTION
finalIrradiance +
#endif
#ifdef SPECULARTERM
finalSpecularScaled +
#endif
#ifdef SHEEN
finalSheenScaled +
#endif
#ifdef CLEARCOAT
finalClearCoatScaled +
#endif
#ifdef REFLECTION
finalRadianceScaled +
#if defined(SHEEN) && defined(ENVIRONMENTBRDF)
sheenOut.finalSheenRadianceScaled +
#endif
#ifdef CLEARCOAT
clearcoatOut.finalClearCoatRadianceScaled +
#endif
#endif
#ifdef SS_REFRACTION
subSurfaceOut.finalRefraction +
#endif
#endif
finalEmissive,
alpha);
#ifdef LIGHTMAP
#ifndef LIGHTMAPEXCLUDED
#ifdef USELIGHTMAPASSHADOWMAP
finalColor.rgb*=lightmapColor.rgb;
#else
finalColor.rgb+=lightmapColor.rgb;
#endif
#endif
#endif
#define CUSTOM_FRAGMENT_BEFORE_FOG
finalColor=max(finalColor,0.0);
`;Y.IncludesShadersStore[JC]=ey;const ty="pbrBlockImageProcessing",iy=`#if defined(IMAGEPROCESSINGPOSTPROCESS) || defined(SS_SCATTERING)
#if !defined(SKIPFINALCOLORCLAMP)
finalColor.rgb=clamp(finalColor.rgb,0.,30.0);
#endif
#else
finalColor=applyImageProcessing(finalColor);
#endif
finalColor.a*=visibility;
#ifdef PREMULTIPLYALPHA
finalColor.rgb*=finalColor.a;
#endif
`;Y.IncludesShadersStore[ty]=iy;const sy="pbrDebug",ry=`#if DEBUGMODE>0
if (vClipSpacePosition.x/vClipSpacePosition.w>=vDebugMode.x) {
#if DEBUGMODE==1
gl_FragColor.rgb=vPositionW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==2 && defined(NORMAL)
gl_FragColor.rgb=vNormalW.rgb;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==3 && defined(BUMP) || DEBUGMODE==3 && defined(PARALLAX) || DEBUGMODE==3 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==4 && defined(BUMP) || DEBUGMODE==4 && defined(PARALLAX) || DEBUGMODE==4 && defined(ANISOTROPIC)
gl_FragColor.rgb=TBN[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==5
gl_FragColor.rgb=normalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==6 && defined(MAINUV1)
gl_FragColor.rgb=vec3(vMainUV1,0.0);
#elif DEBUGMODE==7 && defined(MAINUV2)
gl_FragColor.rgb=vec3(vMainUV2,0.0);
#elif DEBUGMODE==8 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[0];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==9 && defined(CLEARCOAT) && defined(CLEARCOAT_BUMP)
gl_FragColor.rgb=clearcoatOut.TBNClearCoat[1];
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==10 && defined(CLEARCOAT)
gl_FragColor.rgb=clearcoatOut.clearCoatNormalW;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==11 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicNormal;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==12 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicTangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==13 && defined(ANISOTROPIC)
gl_FragColor.rgb=anisotropicOut.anisotropicBitangent;
#define DEBUGMODE_NORMALIZE
#elif DEBUGMODE==20 && defined(ALBEDO)
gl_FragColor.rgb=albedoTexture.rgb;
#elif DEBUGMODE==21 && defined(AMBIENT)
gl_FragColor.rgb=aoOut.ambientOcclusionColorMap.rgb;
#elif DEBUGMODE==22 && defined(OPACITY)
gl_FragColor.rgb=opacityMap.rgb;
#elif DEBUGMODE==23 && defined(EMISSIVE)
gl_FragColor.rgb=emissiveColorTex.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==24 && defined(LIGHTMAP)
gl_FragColor.rgb=lightmapColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==25 && defined(REFLECTIVITY) && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceMetallicColorMap.rgb;
#elif DEBUGMODE==26 && defined(REFLECTIVITY) && !defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.surfaceReflectivityColorMap.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==27 && defined(CLEARCOAT) && defined(CLEARCOAT_TEXTURE)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatMapData.rg,0.0);
#elif DEBUGMODE==28 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
gl_FragColor.rgb=clearcoatOut.clearCoatTintMapData.rgb;
#elif DEBUGMODE==29 && defined(SHEEN) && defined(SHEEN_TEXTURE)
gl_FragColor.rgb=sheenOut.sheenMapData.rgb;
#elif DEBUGMODE==30 && defined(ANISOTROPIC) && defined(ANISOTROPIC_TEXTURE)
gl_FragColor.rgb=anisotropicOut.anisotropyMapData.rgb;
#elif DEBUGMODE==31 && defined(SUBSURFACE) && defined(SS_THICKNESSANDMASK_TEXTURE)
gl_FragColor.rgb=subSurfaceOut.thicknessMap.rgb;
#elif DEBUGMODE==40 && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.environmentRefraction.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==41 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==42 && defined(CLEARCOAT) && defined(REFLECTION)
gl_FragColor.rgb=clearcoatOut.environmentClearCoatRadiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==50
gl_FragColor.rgb=diffuseBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==51 && defined(SPECULARTERM)
gl_FragColor.rgb=specularBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==52 && defined(CLEARCOAT)
gl_FragColor.rgb=clearCoatBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==53 && defined(SHEEN)
gl_FragColor.rgb=sheenBase.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==54 && defined(REFLECTION)
gl_FragColor.rgb=reflectionOut.environmentIrradiance.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==60
gl_FragColor.rgb=surfaceAlbedo.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==61
gl_FragColor.rgb=clearcoatOut.specularEnvironmentR0;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==62 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=vec3(reflectivityOut.metallicRoughness.r);
#elif DEBUGMODE==71 && defined(METALLICWORKFLOW)
gl_FragColor.rgb=reflectivityOut.metallicF0;
#elif DEBUGMODE==63
gl_FragColor.rgb=vec3(roughness);
#elif DEBUGMODE==64
gl_FragColor.rgb=vec3(alphaG);
#elif DEBUGMODE==65
gl_FragColor.rgb=vec3(NdotV);
#elif DEBUGMODE==66 && defined(CLEARCOAT) && defined(CLEARCOAT_TINT)
gl_FragColor.rgb=clearcoatOut.clearCoatColor.rgb;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==67 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatRoughness);
#elif DEBUGMODE==68 && defined(CLEARCOAT)
gl_FragColor.rgb=vec3(clearcoatOut.clearCoatNdotV);
#elif DEBUGMODE==69 && defined(SUBSURFACE) && defined(SS_TRANSLUCENCY)
gl_FragColor.rgb=subSurfaceOut.transmittance;
#elif DEBUGMODE==70 && defined(SUBSURFACE) && defined(SS_REFRACTION)
gl_FragColor.rgb=subSurfaceOut.refractionTransmittance;
#elif DEBUGMODE==80 && defined(RADIANCEOCCLUSION)
gl_FragColor.rgb=vec3(seo);
#elif DEBUGMODE==81 && defined(HORIZONOCCLUSION)
gl_FragColor.rgb=vec3(eho);
#elif DEBUGMODE==82 && defined(MS_BRDF_ENERGY_CONSERVATION)
gl_FragColor.rgb=vec3(energyConservationFactor);
#elif DEBUGMODE==83 && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=specularEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==84 && defined(CLEARCOAT) && defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
gl_FragColor.rgb=clearcoatOut.clearCoatEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==85 && defined(SHEEN) && defined(REFLECTION)
gl_FragColor.rgb=sheenOut.sheenEnvironmentReflectance;
#define DEBUGMODE_GAMMA
#elif DEBUGMODE==86 && defined(ALPHABLEND)
gl_FragColor.rgb=vec3(luminanceOverAlpha);
#elif DEBUGMODE==87
gl_FragColor.rgb=vec3(alpha);
#endif
gl_FragColor.rgb*=vDebugMode.y;
#ifdef DEBUGMODE_NORMALIZE
gl_FragColor.rgb=normalize(gl_FragColor.rgb)*0.5+0.5;
#endif
#ifdef DEBUGMODE_GAMMA
gl_FragColor.rgb=toGammaSpace(gl_FragColor.rgb);
#endif
gl_FragColor.a=1.0;
#ifdef PREPASS
gl_FragData[0]=toLinearSpace(gl_FragColor); 
gl_FragData[1]=vec4(0.,0.,0.,0.); 
#endif
return;
}
#endif
`;Y.IncludesShadersStore[sy]=ry;const ny="pbrPixelShader",ay=`#if defined(BUMP) || !defined(NORMAL) || defined(FORCENORMALFORWARD) || defined(SPECULARAA) || defined(CLEARCOAT_BUMP) || defined(ANISOTROPIC)
#extension GL_OES_standard_derivatives : enable
#endif
#ifdef LODBASEDMICROSFURACE
#extension GL_EXT_shader_texture_lod : enable
#endif
#define CUSTOM_FRAGMENT_BEGIN
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
#include<prePassDeclaration>[SCENE_MRT_COUNT]
precision highp float;
#include<oitDeclaration>
#ifndef FROMLINEARSPACE
#define FROMLINEARSPACE
#endif
#include<__decl__pbrFragment>
#include<pbrFragmentExtraDeclaration>
#include<__decl__lightFragment>[0..maxSimultaneousLights]
#include<pbrFragmentSamplersDeclaration>
#include<imageProcessingDeclaration>
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#include<fogFragmentDeclaration>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<importanceSampling>
#include<pbrHelperFunctions>
#include<imageProcessingFunctions>
#include<shadowsFragmentFunctions>
#include<harmonicsFunctions>
#include<pbrDirectLightingSetupFunctions>
#include<pbrDirectLightingFalloffFunctions>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
#include<pbrDirectLightingFunctions>
#include<pbrIBLFunctions>
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#ifdef REFLECTION
#include<reflectionFunction>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
#include<pbrBlockAlbedoOpacity>
#include<pbrBlockReflectivity>
#include<pbrBlockAmbientOcclusion>
#include<pbrBlockAlphaFresnel>
#include<pbrBlockAnisotropic>
#include<pbrBlockReflection>
#include<pbrBlockSheen>
#include<pbrBlockClearcoat>
#include<pbrBlockIridescence>
#include<pbrBlockSubSurface>
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#include<pbrBlockNormalGeometric>
#include<bumpFragment>
#include<pbrBlockNormalFinal>
albedoOpacityOutParams albedoOpacityOut;
#ifdef ALBEDO
vec4 albedoTexture=texture2D(albedoSampler,vAlbedoUV+uvOffset);
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vOpacityUV+uvOffset);
#endif
albedoOpacityBlock(
vAlbedoColor,
#ifdef ALBEDO
albedoTexture,
vAlbedoInfos,
#endif
#ifdef OPACITY
opacityMap,
vOpacityInfos,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
albedoOpacityOut
);
vec3 surfaceAlbedo=albedoOpacityOut.surfaceAlbedo;
float alpha=albedoOpacityOut.alpha;
#define CUSTOM_FRAGMENT_UPDATE_ALPHA
#include<depthPrePass>
#define CUSTOM_FRAGMENT_BEFORE_LIGHTS
ambientOcclusionOutParams aoOut;
#ifdef AMBIENT
vec3 ambientOcclusionColorMap=texture2D(ambientSampler,vAmbientUV+uvOffset).rgb;
#endif
ambientOcclusionBlock(
#ifdef AMBIENT
ambientOcclusionColorMap,
vAmbientInfos,
#endif
aoOut
);
#include<pbrBlockLightmapInit>
#ifdef UNLIT
vec3 diffuseBase=vec3(1.,1.,1.);
#else
vec3 baseColor=surfaceAlbedo;
reflectivityOutParams reflectivityOut;
#if defined(REFLECTIVITY)
vec4 surfaceMetallicOrReflectivityColorMap=texture2D(reflectivitySampler,vReflectivityUV+uvOffset);
vec4 baseReflectivity=surfaceMetallicOrReflectivityColorMap;
#ifndef METALLICWORKFLOW
#ifdef REFLECTIVITY_GAMMA
surfaceMetallicOrReflectivityColorMap=toLinearSpace(surfaceMetallicOrReflectivityColorMap);
#endif
surfaceMetallicOrReflectivityColorMap.rgb*=vReflectivityInfos.y;
#endif
#endif
#if defined(MICROSURFACEMAP)
vec4 microSurfaceTexel=texture2D(microSurfaceSampler,vMicroSurfaceSamplerUV+uvOffset)*vMicroSurfaceSamplerInfos.y;
#endif
#ifdef METALLICWORKFLOW
vec4 metallicReflectanceFactors=vMetallicReflectanceFactors;
#ifdef REFLECTANCE
vec4 reflectanceFactorsMap=texture2D(reflectanceSampler,vReflectanceUV+uvOffset);
#ifdef REFLECTANCE_GAMMA
reflectanceFactorsMap=toLinearSpace(reflectanceFactorsMap);
#endif
metallicReflectanceFactors.rgb*=reflectanceFactorsMap.rgb;
#endif
#ifdef METALLIC_REFLECTANCE
vec4 metallicReflectanceFactorsMap=texture2D(metallicReflectanceSampler,vMetallicReflectanceUV+uvOffset);
#ifdef METALLIC_REFLECTANCE_GAMMA
metallicReflectanceFactorsMap=toLinearSpace(metallicReflectanceFactorsMap);
#endif
#ifndef METALLIC_REFLECTANCE_USE_ALPHA_ONLY
metallicReflectanceFactors.rgb*=metallicReflectanceFactorsMap.rgb;
#endif
metallicReflectanceFactors*=metallicReflectanceFactorsMap.a;
#endif
#endif
reflectivityBlock(
vReflectivityColor,
#ifdef METALLICWORKFLOW
surfaceAlbedo,
metallicReflectanceFactors,
#endif
#ifdef REFLECTIVITY
vReflectivityInfos,
surfaceMetallicOrReflectivityColorMap,
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor,
#endif
#ifdef MICROSURFACEMAP
microSurfaceTexel,
#endif
#ifdef DETAIL
detailColor,
vDetailInfos,
#endif
reflectivityOut
);
float microSurface=reflectivityOut.microSurface;
float roughness=reflectivityOut.roughness;
#ifdef METALLICWORKFLOW
surfaceAlbedo=reflectivityOut.surfaceAlbedo;
#endif
#if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
aoOut.ambientOcclusionColor=reflectivityOut.ambientOcclusionColor;
#endif
#ifdef ALPHAFRESNEL
#if defined(ALPHATEST) || defined(ALPHABLEND)
alphaFresnelOutParams alphaFresnelOut;
alphaFresnelBlock(
normalW,
viewDirectionW,
alpha,
microSurface,
alphaFresnelOut
);
alpha=alphaFresnelOut.alpha;
#endif
#endif
#include<pbrBlockGeometryInfo>
#ifdef ANISOTROPIC
anisotropicOutParams anisotropicOut;
#ifdef ANISOTROPIC_TEXTURE
vec3 anisotropyMapData=texture2D(anisotropySampler,vAnisotropyUV+uvOffset).rgb*vAnisotropyInfos.y;
#endif
anisotropicBlock(
vAnisotropy,
#ifdef ANISOTROPIC_TEXTURE
anisotropyMapData,
#endif
TBN,
normalW,
viewDirectionW,
anisotropicOut
);
#endif
#ifdef REFLECTION
reflectionOutParams reflectionOut;
#ifndef USE_CUSTOM_REFLECTION
reflectionBlock(
vPositionW,
normalW,
alphaG,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#if defined(LODINREFLECTIONALPHA) && !defined(REFLECTIONMAP_SKYBOX)
NdotVUnclamped,
#endif
#ifdef LINEARSPECULARREFLECTION
roughness,
#endif
reflectionSampler,
#if defined(NORMAL) && defined(USESPHERICALINVERTEX)
vEnvironmentIrradiance,
#endif
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionMatrix,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
reflectionOut
);
#else
#define CUSTOM_REFLECTION
#endif
#endif
#include<pbrBlockReflectance0>
#ifdef SHEEN
sheenOutParams sheenOut;
#ifdef SHEEN_TEXTURE
vec4 sheenMapData=texture2D(sheenSampler,vSheenUV+uvOffset);
#endif
#if defined(SHEEN_ROUGHNESS) && defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 sheenMapRoughnessData=texture2D(sheenRoughnessSampler,vSheenRoughnessUV+uvOffset)*vSheenInfos.w;
#endif
sheenBlock(
vSheenColor,
#ifdef SHEEN_ROUGHNESS
vSheenRoughness,
#if defined(SHEEN_TEXTURE_ROUGHNESS) && !defined(SHEEN_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE)
sheenMapRoughnessData,
#endif
#endif
roughness,
#ifdef SHEEN_TEXTURE
sheenMapData,
vSheenInfos.y,
#endif
reflectance,
#ifdef SHEEN_LINKWITHALBEDO
baseColor,
surfaceAlbedo,
#endif
#ifdef ENVIRONMENTBRDF
NdotV,
environmentBrdf,
#endif
#if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
AARoughnessFactors,
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
reflectionOut.reflectionCoords,
NdotVUnclamped,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(RADIANCEOCCLUSION)
seo,
#endif
#if !defined(REFLECTIONMAP_SKYBOX) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(REFLECTIONMAP_3D)
eho,
#endif
#endif
sheenOut
);
#ifdef SHEEN_LINKWITHALBEDO
surfaceAlbedo=sheenOut.surfaceAlbedo;
#endif
#endif
#ifdef CLEARCOAT
#ifdef CLEARCOAT_TEXTURE
vec2 clearCoatMapData=texture2D(clearCoatSampler,vClearCoatUV+uvOffset).rg*vClearCoatInfos.y;
#endif
#endif
#ifdef IRIDESCENCE
iridescenceOutParams iridescenceOut;
#ifdef IRIDESCENCE_TEXTURE
vec2 iridescenceMapData=texture2D(iridescenceSampler,vIridescenceUV+uvOffset).rg*vIridescenceInfos.y;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
vec2 iridescenceThicknessMapData=texture2D(iridescenceThicknessSampler,vIridescenceThicknessUV+uvOffset).rg*vIridescenceInfos.w;
#endif
iridescenceBlock(
vIridescenceParams,
NdotV,
specularEnvironmentR0,
#ifdef IRIDESCENCE_TEXTURE
iridescenceMapData,
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
iridescenceThicknessMapData,
#endif
#ifdef CLEARCOAT
NdotVUnclamped,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#endif
iridescenceOut
);
float iridescenceIntensity=iridescenceOut.iridescenceIntensity;
specularEnvironmentR0=iridescenceOut.specularEnvironmentR0;
#endif
clearcoatOutParams clearcoatOut;
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
vec4 clearCoatMapRoughnessData=texture2D(clearCoatRoughnessSampler,vClearCoatRoughnessUV+uvOffset)*vClearCoatInfos.w;
#endif
#if defined(CLEARCOAT_TINT) && defined(CLEARCOAT_TINT_TEXTURE)
vec4 clearCoatTintMapData=texture2D(clearCoatTintSampler,vClearCoatTintUV+uvOffset);
#endif
#ifdef CLEARCOAT_BUMP
vec4 clearCoatBumpMapData=texture2D(clearCoatBumpSampler,vClearCoatBumpUV+uvOffset);
#endif
clearcoatBlock(
vPositionW,
geometricNormalW,
viewDirectionW,
vClearCoatParams,
#if defined(CLEARCOAT_TEXTURE_ROUGHNESS) && !defined(CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL) && !defined(CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE)
clearCoatMapRoughnessData,
#endif
specularEnvironmentR0,
#ifdef CLEARCOAT_TEXTURE
clearCoatMapData,
#endif
#ifdef CLEARCOAT_TINT
vClearCoatTintParams,
clearCoatColorAtDistance,
vClearCoatRefractionParams,
#ifdef CLEARCOAT_TINT_TEXTURE
clearCoatTintMapData,
#endif
#endif
#ifdef CLEARCOAT_BUMP
vClearCoatBumpInfos,
clearCoatBumpMapData,
vClearCoatBumpUV,
#if defined(TANGENT) && defined(NORMAL)
vTBN,
#else
vClearCoatTangentSpaceParams,
#endif
#ifdef OBJECTSPACE_NORMALMAP
normalMatrix,
#endif
#endif
#if defined(FORCENORMALFORWARD) && defined(NORMAL)
faceNormal,
#endif
#ifdef REFLECTION
vReflectionMicrosurfaceInfos,
vReflectionInfos,
vReflectionColor,
vLightingIntensity,
reflectionSampler,
#ifndef LODBASEDMICROSFURACE
reflectionSamplerLow,
reflectionSamplerHigh,
#endif
#ifdef REALTIME_FILTERING
vReflectionFilteringInfo,
#endif
#endif
#if defined(ENVIRONMENTBRDF) && !defined(REFLECTIONMAP_SKYBOX)
#ifdef RADIANCEOCCLUSION
ambientMonochrome,
#endif
#endif
#if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
(gl_FrontFacing ? 1. : -1.),
#endif
clearcoatOut
);
#else
clearcoatOut.specularEnvironmentR0=specularEnvironmentR0;
#endif
#include<pbrBlockReflectance>
subSurfaceOutParams subSurfaceOut;
#ifdef SUBSURFACE
#ifdef SS_THICKNESSANDMASK_TEXTURE
vec4 thicknessMap=texture2D(thicknessSampler,vThicknessUV+uvOffset);
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
vec4 refractionIntensityMap=texture2D(refractionIntensitySampler,vRefractionIntensityUV+uvOffset);
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
vec4 translucencyIntensityMap=texture2D(translucencyIntensitySampler,vTranslucencyIntensityUV+uvOffset);
#endif
subSurfaceBlock(
vSubSurfaceIntensity,
vThicknessParam,
vTintColor,
normalW,
specularEnvironmentReflectance,
#ifdef SS_THICKNESSANDMASK_TEXTURE
thicknessMap,
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
refractionIntensityMap,
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
translucencyIntensityMap,
#endif
#ifdef REFLECTION
#ifdef SS_TRANSLUCENCY
reflectionMatrix,
#ifdef USESPHERICALFROMREFLECTIONMAP
#if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
reflectionOut.irradianceVector,
#endif
#if defined(REALTIME_FILTERING)
reflectionSampler,
vReflectionFilteringInfo,
#endif
#endif
#ifdef USEIRRADIANCEMAP
irradianceSampler,
#endif
#endif
#endif
#if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
surfaceAlbedo,
#endif
#ifdef SS_REFRACTION
vPositionW,
viewDirectionW,
view,
vRefractionInfos,
refractionMatrix,
vRefractionMicrosurfaceInfos,
vLightingIntensity,
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha,
#endif
#ifdef SS_LODINREFRACTIONALPHA
NdotVUnclamped,
#endif
#ifdef SS_LINEARSPECULARREFRACTION
roughness,
#endif
alphaG,
refractionSampler,
#ifndef LODBASEDMICROSFURACE
refractionSamplerLow,
refractionSamplerHigh,
#endif
#ifdef ANISOTROPIC
anisotropicOut,
#endif
#ifdef REALTIME_FILTERING
vRefractionFilteringInfo,
#endif
#ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
vRefractionPosition,
vRefractionSize,
#endif
#endif
#ifdef SS_TRANSLUCENCY
vDiffusionDistance,
#endif
subSurfaceOut
);
#ifdef SS_REFRACTION
surfaceAlbedo=subSurfaceOut.surfaceAlbedo;
#ifdef SS_LINKREFRACTIONTOTRANSPARENCY
alpha=subSurfaceOut.alpha;
#endif
#endif
#else
subSurfaceOut.specularEnvironmentReflectance=specularEnvironmentReflectance;
#endif
#include<pbrBlockDirectLighting>
#include<lightFragment>[0..maxSimultaneousLights]
#include<pbrBlockFinalLitComponents>
#endif 
#include<pbrBlockFinalUnlitComponents>
#define CUSTOM_FRAGMENT_BEFORE_FINALCOLORCOMPOSITION
#include<pbrBlockFinalColorComposition>
#include<logDepthFragment>
#include<fogFragment>(color,finalColor)
#include<pbrBlockImageProcessing>
#define CUSTOM_FRAGMENT_BEFORE_FRAGCOLOR
#ifdef PREPASS
float writeGeometryInfo=finalColor.a>0.4 ? 1.0 : 0.0;
#ifdef PREPASS_POSITION
gl_FragData[PREPASS_POSITION_INDEX]=vec4(vPositionW,writeGeometryInfo);
#endif
#ifdef PREPASS_VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[PREPASS_VELOCITY_INDEX]=vec4(velocity,0.0,writeGeometryInfo);
#endif
#ifdef PREPASS_ALBEDO_SQRT
vec3 sqAlbedo=sqrt(surfaceAlbedo); 
#endif
#ifdef PREPASS_IRRADIANCE
vec3 irradiance=finalDiffuse;
#ifndef UNLIT
#ifdef REFLECTION
irradiance+=finalIrradiance;
#endif
#endif
#ifdef SS_SCATTERING
gl_FragData[0]=vec4(finalColor.rgb-irradiance,finalColor.a); 
irradiance/=sqAlbedo;
#else
gl_FragData[0]=finalColor; 
float scatteringDiffusionProfile=255.;
#endif
gl_FragData[PREPASS_IRRADIANCE_INDEX]=vec4(clamp(irradiance,vec3(0.),vec3(1.)),writeGeometryInfo*scatteringDiffusionProfile/255.); 
#else
gl_FragData[0]=vec4(finalColor.rgb,finalColor.a);
#endif
#ifdef PREPASS_DEPTH
gl_FragData[PREPASS_DEPTH_INDEX]=vec4(vViewPos.z,0.0,0.0,writeGeometryInfo); 
#endif
#ifdef PREPASS_NORMAL
gl_FragData[PREPASS_NORMAL_INDEX]=vec4((view*vec4(normalW,0.0)).rgb,writeGeometryInfo); 
#endif
#ifdef PREPASS_ALBEDO_SQRT
gl_FragData[PREPASS_ALBEDO_SQRT_INDEX]=vec4(sqAlbedo,writeGeometryInfo); 
#endif
#ifdef PREPASS_REFLECTIVITY
#ifndef UNLIT
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4(toGammaSpace(specularEnvironmentR0),microSurface)*writeGeometryInfo;
#else
gl_FragData[PREPASS_REFLECTIVITY_INDEX]=vec4( 0.0,0.0,0.0,1.0 )*writeGeometryInfo;
#endif
#endif
#endif
#if !defined(PREPASS) || defined(WEBGL2)
gl_FragColor=finalColor;
#endif
#include<oitFragment>
#if ORDER_INDEPENDENT_TRANSPARENCY
if (fragDepth==nearestDepth) {
frontColor.rgb+=finalColor.rgb*finalColor.a*alphaMultiplier;
frontColor.a=1.0-alphaMultiplier*(1.0-finalColor.a);
} else {
backColor+=finalColor;
}
#endif
#include<pbrDebug>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Y.ShadersStore[ny]=ay;const oy="pbrVertexDeclaration",ly=`uniform mat4 view;
uniform mat4 viewProjection;
#ifdef ALBEDO
uniform mat4 albedoMatrix;
uniform vec2 vAlbedoInfos;
#endif
#ifdef AMBIENT
uniform mat4 ambientMatrix;
uniform vec4 vAmbientInfos;
#endif
#ifdef OPACITY
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#ifdef EMISSIVE
uniform vec2 vEmissiveInfos;
uniform mat4 emissiveMatrix;
#endif
#ifdef LIGHTMAP
uniform vec2 vLightmapInfos;
uniform mat4 lightmapMatrix;
#endif
#ifdef REFLECTIVITY 
uniform vec3 vReflectivityInfos;
uniform mat4 reflectivityMatrix;
#endif
#ifdef METALLIC_REFLECTANCE
uniform vec2 vMetallicReflectanceInfos;
uniform mat4 metallicReflectanceMatrix;
#endif
#ifdef REFLECTANCE
uniform vec2 vReflectanceInfos;
uniform mat4 reflectanceMatrix;
#endif
#ifdef MICROSURFACEMAP
uniform vec2 vMicroSurfaceSamplerInfos;
uniform mat4 microSurfaceSamplerMatrix;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform mat4 bumpMatrix;
#endif
#ifdef POINTSIZE
uniform float pointSize;
#endif
#ifdef REFLECTION
uniform vec2 vReflectionInfos;
uniform mat4 reflectionMatrix;
#endif
#ifdef CLEARCOAT
#if defined(CLEARCOAT_TEXTURE) || defined(CLEARCOAT_TEXTURE_ROUGHNESS)
uniform vec4 vClearCoatInfos;
#endif
#ifdef CLEARCOAT_TEXTURE
uniform mat4 clearCoatMatrix;
#endif
#ifdef CLEARCOAT_TEXTURE_ROUGHNESS
uniform mat4 clearCoatRoughnessMatrix;
#endif
#ifdef CLEARCOAT_BUMP
uniform vec2 vClearCoatBumpInfos;
uniform mat4 clearCoatBumpMatrix;
#endif
#ifdef CLEARCOAT_TINT_TEXTURE
uniform vec2 vClearCoatTintInfos;
uniform mat4 clearCoatTintMatrix;
#endif
#endif
#ifdef IRIDESCENCE
#if defined(IRIDESCENCE_TEXTURE) || defined(IRIDESCENCE_THICKNESS_TEXTURE)
uniform vec4 vIridescenceInfos;
#endif
#ifdef IRIDESCENCE_TEXTURE
uniform mat4 iridescenceMatrix;
#endif
#ifdef IRIDESCENCE_THICKNESS_TEXTURE
uniform mat4 iridescenceThicknessMatrix;
#endif
#endif
#ifdef ANISOTROPIC
#ifdef ANISOTROPIC_TEXTURE
uniform vec2 vAnisotropyInfos;
uniform mat4 anisotropyMatrix;
#endif
#endif
#ifdef SHEEN
#if defined(SHEEN_TEXTURE) || defined(SHEEN_TEXTURE_ROUGHNESS)
uniform vec4 vSheenInfos;
#endif
#ifdef SHEEN_TEXTURE
uniform mat4 sheenMatrix;
#endif
#ifdef SHEEN_TEXTURE_ROUGHNESS
uniform mat4 sheenRoughnessMatrix;
#endif
#endif
#ifdef SUBSURFACE
#ifdef SS_REFRACTION
uniform vec4 vRefractionInfos;
uniform mat4 refractionMatrix;
#endif
#ifdef SS_THICKNESSANDMASK_TEXTURE
uniform vec2 vThicknessInfos;
uniform mat4 thicknessMatrix;
#endif
#ifdef SS_REFRACTIONINTENSITY_TEXTURE
uniform vec2 vRefractionIntensityInfos;
uniform mat4 refractionIntensityMatrix;
#endif
#ifdef SS_TRANSLUCENCYINTENSITY_TEXTURE
uniform vec2 vTranslucencyIntensityInfos;
uniform mat4 translucencyIntensityMatrix;
#endif
#endif
#ifdef NORMAL
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
#ifdef USESPHERICALFROMREFLECTIONMAP
#ifdef SPHERICAL_HARMONICS
uniform vec3 vSphericalL00;
uniform vec3 vSphericalL1_1;
uniform vec3 vSphericalL10;
uniform vec3 vSphericalL11;
uniform vec3 vSphericalL2_2;
uniform vec3 vSphericalL2_1;
uniform vec3 vSphericalL20;
uniform vec3 vSphericalL21;
uniform vec3 vSphericalL22;
#else
uniform vec3 vSphericalX;
uniform vec3 vSphericalY;
uniform vec3 vSphericalZ;
uniform vec3 vSphericalXX_ZZ;
uniform vec3 vSphericalYY_ZZ;
uniform vec3 vSphericalZZ;
uniform vec3 vSphericalXY;
uniform vec3 vSphericalYZ;
uniform vec3 vSphericalZX;
#endif
#endif
#endif
#endif
#ifdef DETAIL
uniform vec4 vDetailInfos;
uniform mat4 detailMatrix;
#endif
#define ADDITIONAL_VERTEX_DECLARATION
`;Y.IncludesShadersStore[oy]=ly;const hy="pbrVertexShader",cy=`precision highp float;
#include<__decl__pbrVertex>
#define CUSTOM_VERTEX_BEGIN
attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#ifdef TANGENT
attribute vec4 tangent;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#include<uvAttributeDeclaration>[2..7]
#include<mainUVVaryingDeclaration>[1..7]
#ifdef VERTEXCOLOR
attribute vec4 color;
#endif
#include<helperFunctions>
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<instancesDeclaration>
#include<prePassVertexDeclaration>
#include<samplerVertexDeclaration>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo)
#include<samplerVertexDeclaration>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail)
#include<samplerVertexDeclaration>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient)
#include<samplerVertexDeclaration>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity)
#include<samplerVertexDeclaration>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive)
#include<samplerVertexDeclaration>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity)
#include<samplerVertexDeclaration>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler)
#include<samplerVertexDeclaration>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance)
#include<samplerVertexDeclaration>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump)
#ifdef CLEARCOAT
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump)
#include<samplerVertexDeclaration>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence)
#include<samplerVertexDeclaration>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness)
#endif
#ifdef SHEEN
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen)
#include<samplerVertexDeclaration>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexDeclaration>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy)
#endif
#ifdef SUBSURFACE
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity)
#include<samplerVertexDeclaration>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity)
#endif
varying vec3 vPositionW;
#if DEBUGMODE>0
varying vec4 vClipSpacePosition;
#endif
#ifdef NORMAL
varying vec3 vNormalW;
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
varying vec3 vEnvironmentIrradiance;
#include<harmonicsFunctions>
#endif
#endif
#if defined(VERTEXCOLOR) || defined(INSTANCESCOLOR) && defined(INSTANCES)
varying vec4 vColor;
#endif
#include<bumpVertexDeclaration>
#include<clipPlaneVertexDeclaration>
#include<fogVertexDeclaration>
#include<__decl__lightVxFragment>[0..maxSimultaneousLights]
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
varying vec3 vPositionUVW;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
varying vec3 vDirectionW;
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 positionUpdated=position;
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#ifdef TANGENT
vec4 tangentUpdated=tangent;
#endif
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#ifdef REFLECTIONMAP_SKYBOX
vPositionUVW=positionUpdated;
#endif
#define CUSTOM_VERTEX_UPDATE_POSITION
#define CUSTOM_VERTEX_UPDATE_NORMAL
#include<instancesVertex>
#if defined(PREPASS) && defined(PREPASS_VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
vPositionW=vec3(worldPos);
#include<prePassVertex>
#ifdef NORMAL
mat3 normalWorld=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vNormalW=normalUpdated/vec3(dot(normalWorld[0],normalWorld[0]),dot(normalWorld[1],normalWorld[1]),dot(normalWorld[2],normalWorld[2]));
vNormalW=normalize(normalWorld*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normalWorld=transposeMat3(inverseMat3(normalWorld));
#endif
vNormalW=normalize(normalWorld*normalUpdated);
#endif
#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
vec3 reflectionVector=vec3(reflectionMatrix*vec4(vNormalW,0)).xyz;
#ifdef REFLECTIONMAP_OPPOSITEZ
reflectionVector.z*=-1.0;
#endif
vEnvironmentIrradiance=computeEnvironmentIrradiance(reflectionVector);
#endif
#endif
#define CUSTOM_VERTEX_UPDATE_WORLDPOS
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#if DEBUGMODE>0
vClipSpacePosition=gl_Position;
#endif
#if defined(REFLECTIONMAP_EQUIRECTANGULAR_FIXED) || defined(REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED)
vDirectionW=normalize(vec3(finalWorld*vec4(positionUpdated,0.0)));
#endif
#ifndef UV1
vec2 uvUpdated=vec2(0.,0.);
#endif
#ifdef MAINUV1
vMainUV1=uvUpdated;
#endif
#include<uvVariableDeclaration>[2..7]
#include<samplerVertexImplementation>(_DEFINENAME_,ALBEDO,_VARYINGNAME_,Albedo,_MATRIXNAME_,albedo,_INFONAME_,AlbedoInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,DETAIL,_VARYINGNAME_,Detail,_MATRIXNAME_,detail,_INFONAME_,DetailInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,AMBIENT,_VARYINGNAME_,Ambient,_MATRIXNAME_,ambient,_INFONAME_,AmbientInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,OPACITY,_VARYINGNAME_,Opacity,_MATRIXNAME_,opacity,_INFONAME_,OpacityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,EMISSIVE,_VARYINGNAME_,Emissive,_MATRIXNAME_,emissive,_INFONAME_,EmissiveInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,LIGHTMAP,_VARYINGNAME_,Lightmap,_MATRIXNAME_,lightmap,_INFONAME_,LightmapInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTIVITY,_VARYINGNAME_,Reflectivity,_MATRIXNAME_,reflectivity,_INFONAME_,ReflectivityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,MICROSURFACEMAP,_VARYINGNAME_,MicroSurfaceSampler,_MATRIXNAME_,microSurfaceSampler,_INFONAME_,MicroSurfaceSamplerInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,METALLIC_REFLECTANCE,_VARYINGNAME_,MetallicReflectance,_MATRIXNAME_,metallicReflectance,_INFONAME_,MetallicReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,REFLECTANCE,_VARYINGNAME_,Reflectance,_MATRIXNAME_,reflectance,_INFONAME_,ReflectanceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_MATRIXNAME_,bump,_INFONAME_,BumpInfos.x)
#ifdef CLEARCOAT
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE,_VARYINGNAME_,ClearCoat,_MATRIXNAME_,clearCoat,_INFONAME_,ClearCoatInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TEXTURE_ROUGHNESS,_VARYINGNAME_,ClearCoatRoughness,_MATRIXNAME_,clearCoatRoughness,_INFONAME_,ClearCoatInfos.z)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_BUMP,_VARYINGNAME_,ClearCoatBump,_MATRIXNAME_,clearCoatBump,_INFONAME_,ClearCoatBumpInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,CLEARCOAT_TINT_TEXTURE,_VARYINGNAME_,ClearCoatTint,_MATRIXNAME_,clearCoatTint,_INFONAME_,ClearCoatTintInfos.x)
#endif
#ifdef IRIDESCENCE
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_TEXTURE,_VARYINGNAME_,Iridescence,_MATRIXNAME_,iridescence,_INFONAME_,IridescenceInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,IRIDESCENCE_THICKNESS_TEXTURE,_VARYINGNAME_,IridescenceThickness,_MATRIXNAME_,iridescenceThickness,_INFONAME_,IridescenceInfos.z)
#endif
#ifdef SHEEN
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE,_VARYINGNAME_,Sheen,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SHEEN_TEXTURE_ROUGHNESS,_VARYINGNAME_,SheenRoughness,_MATRIXNAME_,sheen,_INFONAME_,SheenInfos.z)
#endif
#ifdef ANISOTROPIC
#include<samplerVertexImplementation>(_DEFINENAME_,ANISOTROPIC_TEXTURE,_VARYINGNAME_,Anisotropy,_MATRIXNAME_,anisotropy,_INFONAME_,AnisotropyInfos.x)
#endif
#ifdef SUBSURFACE
#include<samplerVertexImplementation>(_DEFINENAME_,SS_THICKNESSANDMASK_TEXTURE,_VARYINGNAME_,Thickness,_MATRIXNAME_,thickness,_INFONAME_,ThicknessInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_REFRACTIONINTENSITY_TEXTURE,_VARYINGNAME_,RefractionIntensity,_MATRIXNAME_,refractionIntensity,_INFONAME_,RefractionIntensityInfos.x)
#include<samplerVertexImplementation>(_DEFINENAME_,SS_TRANSLUCENCYINTENSITY_TEXTURE,_VARYINGNAME_,TranslucencyIntensity,_MATRIXNAME_,translucencyIntensity,_INFONAME_,TranslucencyIntensityInfos.x)
#endif
#include<bumpVertex>
#include<clipPlaneVertex>
#include<fogVertex>
#include<shadowsVertex>[0..maxSimultaneousLights]
#include<vertexColorMixing>
#if defined(POINTSIZE) && !defined(WEBGPU)
gl_PointSize=pointSize;
#endif
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[hy]=cy;class uy extends rr{constructor(){super(...arguments),this.CLEARCOAT=!1,this.CLEARCOAT_DEFAULTIOR=!1,this.CLEARCOAT_TEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this.CLEARCOAT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,this.CLEARCOAT_BUMP=!1,this.CLEARCOAT_BUMPDIRECTUV=0,this.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,this.CLEARCOAT_REMAP_F0=!1,this.CLEARCOAT_TINT=!1,this.CLEARCOAT_TINT_TEXTURE=!1,this.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,this.CLEARCOAT_TINT_GAMMATEXTURE=!1}}class Oi extends Zr{constructor(e,t=!0){super(e,"PBRClearCoat",100,new uy,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.roughness=0,this._indexOfRefraction=Oi._DefaultIndexOfRefraction,this.indexOfRefraction=Oi._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._textureRoughness=null,this.textureRoughness=null,this._remapF0OnInterfaceChange=!0,this.remapF0OnInterfaceChange=!0,this._bumpTexture=null,this.bumpTexture=null,this._isTintEnabled=!1,this.isTintEnabled=!1,this.tintColor=re.White(),this.tintColorAtDistance=1,this.tintThickness=1,this._tintTexture=null,this.tintTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isReadyForSubMesh(e,t,i){if(!this._isEnabled)return!0;const s=this._material._disableBumpMap;return!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.ClearCoatTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&ce.ClearCoatTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking()||i.getCaps().standardDerivatives&&this._bumpTexture&&ce.ClearCoatBumpTextureEnabled&&!s&&!this._bumpTexture.isReady()||this._isTintEnabled&&this._tintTexture&&ce.ClearCoatTintTextureEnabled&&!this._tintTexture.isReadyOrNotBlocking()))}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.CLEARCOAT=!0,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e.CLEARCOAT_REMAP_F0=this._remapF0OnInterfaceChange,e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.ClearCoatTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"CLEARCOAT_TEXTURE"):e.CLEARCOAT_TEXTURE=!1,this._textureRoughness&&ce.ClearCoatTextureEnabled?se.PrepareDefinesForMergedUV(this._textureRoughness,e,"CLEARCOAT_TEXTURE_ROUGHNESS"):e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,this._bumpTexture&&ce.ClearCoatBumpTextureEnabled?se.PrepareDefinesForMergedUV(this._bumpTexture,e,"CLEARCOAT_BUMP"):e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_DEFAULTIOR=this._indexOfRefraction===Oi._DefaultIndexOfRefraction,this._isTintEnabled?(e.CLEARCOAT_TINT=!0,this._tintTexture&&ce.ClearCoatTintTextureEnabled?(se.PrepareDefinesForMergedUV(this._tintTexture,e,"CLEARCOAT_TINT_TEXTURE"),e.CLEARCOAT_TINT_GAMMATEXTURE=this._tintTexture.gammaSpace):e.CLEARCOAT_TINT_TEXTURE=!1):(e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1))):(e.CLEARCOAT=!1,e.CLEARCOAT_TEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS=!1,e.CLEARCOAT_BUMP=!1,e.CLEARCOAT_TINT=!1,e.CLEARCOAT_TINT_TEXTURE=!1,e.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.CLEARCOAT_DEFAULTIOR=!1,e.CLEARCOAT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TEXTURE_ROUGHNESSDIRECTUV=0,e.CLEARCOAT_BUMPDIRECTUV=0,e.CLEARCOAT_REMAP_F0=!1,e.CLEARCOAT_TINT_TEXTUREDIRECTUV=0,e.CLEARCOAT_TINT_GAMMATEXTURE=!1)}bindForSubMesh(e,t,i,s){var r,n,o,l,h,c,u,d;if(!this._isEnabled)return;const f=s.materialDefines,p=this._material.isFrozen,_=this._material._disableBumpMap,m=this._material._invertNormalMapX,v=this._material._invertNormalMapY,x=f.CLEARCOAT_TEXTURE_ROUGHNESS_IDENTICAL;if(!e.useUbo||!p||!e.isSync){x&&ce.ClearCoatTextureEnabled?(e.updateFloat4("vClearCoatInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"clearCoat")):(this._texture||this._textureRoughness)&&ce.ClearCoatTextureEnabled&&(e.updateFloat4("vClearCoatInfos",(n=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(o=this._texture)===null||o===void 0?void 0:o.level)!==null&&l!==void 0?l:0,(c=(h=this._textureRoughness)===null||h===void 0?void 0:h.coordinatesIndex)!==null&&c!==void 0?c:0,(d=(u=this._textureRoughness)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"clearCoat"),this._textureRoughness&&!x&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._textureRoughness,e,"clearCoatRoughness")),this._bumpTexture&&i.getCaps().standardDerivatives&&ce.ClearCoatTextureEnabled&&!_&&(e.updateFloat2("vClearCoatBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level),se.BindTextureMatrix(this._bumpTexture,e,"clearCoatBump"),t._mirroredCameraPosition?e.updateFloat2("vClearCoatTangentSpaceParams",m?1:-1,v?1:-1):e.updateFloat2("vClearCoatTangentSpaceParams",m?-1:1,v?-1:1)),this._tintTexture&&ce.ClearCoatTintTextureEnabled&&(e.updateFloat2("vClearCoatTintInfos",this._tintTexture.coordinatesIndex,this._tintTexture.level),se.BindTextureMatrix(this._tintTexture,e,"clearCoatTint")),e.updateFloat2("vClearCoatParams",this.intensity,this.roughness);const b=1-this._indexOfRefraction,S=1+this._indexOfRefraction,C=Math.pow(-b/S,2),E=1/this._indexOfRefraction;e.updateFloat4("vClearCoatRefractionParams",C,E,b,S),this._isTintEnabled&&(e.updateFloat4("vClearCoatTintParams",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintThickness)),e.updateFloat("clearCoatColorAtDistance",Math.max(1e-5,this.tintColorAtDistance)))}t.texturesEnabled&&(this._texture&&ce.ClearCoatTextureEnabled&&e.setTexture("clearCoatSampler",this._texture),this._textureRoughness&&!x&&!f.CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE&&ce.ClearCoatTextureEnabled&&e.setTexture("clearCoatRoughnessSampler",this._textureRoughness),this._bumpTexture&&i.getCaps().standardDerivatives&&ce.ClearCoatBumpTextureEnabled&&!_&&e.setTexture("clearCoatBumpSampler",this._bumpTexture),this._isTintEnabled&&this._tintTexture&&ce.ClearCoatTintTextureEnabled&&e.setTexture("clearCoatTintSampler",this._tintTexture))}hasTexture(e){return this._texture===e||this._textureRoughness===e||this._bumpTexture===e||this._tintTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness),this._bumpTexture&&e.push(this._bumpTexture),this._tintTexture&&e.push(this._tintTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._tintTexture&&this._tintTexture.animations&&this._tintTexture.animations.length>0&&e.push(this._tintTexture)}dispose(e){var t,i,s,r;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose(),(s=this._bumpTexture)===null||s===void 0||s.dispose(),(r=this._tintTexture)===null||r===void 0||r.dispose())}getClassName(){return"PBRClearCoatConfiguration"}addFallbacks(e,t,i){return e.CLEARCOAT_BUMP&&t.addFallback(i++,"CLEARCOAT_BUMP"),e.CLEARCOAT_TINT&&t.addFallback(i++,"CLEARCOAT_TINT"),e.CLEARCOAT&&t.addFallback(i++,"CLEARCOAT"),i}getSamplers(e){e.push("clearCoatSampler","clearCoatRoughnessSampler","clearCoatBumpSampler","clearCoatTintSampler")}getUniforms(){return{ubo:[{name:"vClearCoatParams",size:2,type:"vec2"},{name:"vClearCoatRefractionParams",size:4,type:"vec4"},{name:"vClearCoatInfos",size:4,type:"vec4"},{name:"clearCoatMatrix",size:16,type:"mat4"},{name:"clearCoatRoughnessMatrix",size:16,type:"mat4"},{name:"vClearCoatBumpInfos",size:2,type:"vec2"},{name:"vClearCoatTangentSpaceParams",size:2,type:"vec2"},{name:"clearCoatBumpMatrix",size:16,type:"mat4"},{name:"vClearCoatTintParams",size:4,type:"vec4"},{name:"clearCoatColorAtDistance",size:1,type:"float"},{name:"vClearCoatTintInfos",size:2,type:"vec2"},{name:"clearCoatTintMatrix",size:16,type:"mat4"}]}}}Oi._DefaultIndexOfRefraction=1.5;T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"isEnabled",void 0);T([R()],Oi.prototype,"intensity",void 0);T([R()],Oi.prototype,"roughness",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"indexOfRefraction",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"texture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"useRoughnessFromMainTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"textureRoughness",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"remapF0OnInterfaceChange",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"bumpTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"isTintEnabled",void 0);T([pi()],Oi.prototype,"tintColor",void 0);T([R()],Oi.prototype,"tintColorAtDistance",void 0);T([R()],Oi.prototype,"tintThickness",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Oi.prototype,"tintTexture",void 0);class dy extends rr{constructor(){super(...arguments),this.IRIDESCENCE=!1,this.IRIDESCENCE_TEXTURE=!1,this.IRIDESCENCE_TEXTUREDIRECTUV=0,this.IRIDESCENCE_THICKNESS_TEXTURE=!1,this.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0,this.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1}}class _s extends Zr{constructor(e,t=!0){super(e,"PBRIridescence",110,new dy,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.minimumThickness=_s._DefaultMinimumThickness,this.maximumThickness=_s._DefaultMaximumThickness,this.indexOfRefraction=_s._DefaultIndexOfRefraction,this._texture=null,this.texture=null,this._thicknessTexture=null,this.thicknessTexture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.IridescenceTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._thicknessTexture&&ce.IridescenceTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.IRIDESCENCE=!0,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=this._texture!==null&&this._texture._texture===((i=this._thicknessTexture)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._thicknessTexture),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.IridescenceTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"IRIDESCENCE_TEXTURE"):e.IRIDESCENCE_TEXTURE=!1,!e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&this._thicknessTexture&&ce.IridescenceTextureEnabled?se.PrepareDefinesForMergedUV(this._thicknessTexture,e,"IRIDESCENCE_THICKNESS_TEXTURE"):e.IRIDESCENCE_THICKNESS_TEXTURE=!1)):(e.IRIDESCENCE=!1,e.IRIDESCENCE_TEXTURE=!1,e.IRIDESCENCE_THICKNESS_TEXTURE=!1,e.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE=!1,e.IRIDESCENCE_TEXTUREDIRECTUV=0,e.IRIDESCENCE_THICKNESS_TEXTUREDIRECTUV=0)}bindForSubMesh(e,t,i,s){var r,n,o,l,h,c,u,d;if(!this._isEnabled)return;const f=s.materialDefines,p=this._material.isFrozen,_=f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE;(!e.useUbo||!p||!e.isSync)&&(_&&ce.IridescenceTextureEnabled?(e.updateFloat4("vIridescenceInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"iridescence")):(this._texture||this._thicknessTexture)&&ce.IridescenceTextureEnabled&&(e.updateFloat4("vIridescenceInfos",(n=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(o=this._texture)===null||o===void 0?void 0:o.level)!==null&&l!==void 0?l:0,(c=(h=this._thicknessTexture)===null||h===void 0?void 0:h.coordinatesIndex)!==null&&c!==void 0?c:0,(d=(u=this._thicknessTexture)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"iridescence"),this._thicknessTexture&&!_&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._thicknessTexture,e,"iridescenceThickness")),e.updateFloat4("vIridescenceParams",this.intensity,this.indexOfRefraction,this.minimumThickness,this.maximumThickness)),t.texturesEnabled&&(this._texture&&ce.IridescenceTextureEnabled&&e.setTexture("iridescenceSampler",this._texture),this._thicknessTexture&&!_&&!f.IRIDESCENCE_USE_THICKNESS_FROM_MAINTEXTURE&&ce.IridescenceTextureEnabled&&e.setTexture("iridescenceThicknessSampler",this._thicknessTexture))}hasTexture(e){return this._texture===e||this._thicknessTexture===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._thicknessTexture&&e.push(this._thicknessTexture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._thicknessTexture)===null||i===void 0||i.dispose())}getClassName(){return"PBRIridescenceConfiguration"}addFallbacks(e,t,i){return e.IRIDESCENCE&&t.addFallback(i++,"IRIDESCENCE"),i}getSamplers(e){e.push("iridescenceSampler","iridescenceThicknessSampler")}getUniforms(){return{ubo:[{name:"vIridescenceParams",size:4,type:"vec4"},{name:"vIridescenceInfos",size:4,type:"vec4"},{name:"iridescenceMatrix",size:16,type:"mat4"},{name:"iridescenceThicknessMatrix",size:16,type:"mat4"}]}}}_s._DefaultMinimumThickness=100;_s._DefaultMaximumThickness=400;_s._DefaultIndexOfRefraction=1.3;T([R(),ie("_markAllSubMeshesAsTexturesDirty")],_s.prototype,"isEnabled",void 0);T([R()],_s.prototype,"intensity",void 0);T([R()],_s.prototype,"minimumThickness",void 0);T([R()],_s.prototype,"maximumThickness",void 0);T([R()],_s.prototype,"indexOfRefraction",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],_s.prototype,"texture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],_s.prototype,"thicknessTexture",void 0);class fy extends rr{constructor(){super(...arguments),this.ANISOTROPIC=!1,this.ANISOTROPIC_TEXTURE=!1,this.ANISOTROPIC_TEXTUREDIRECTUV=0,this.MAINUV1=!1}}class eh extends Zr{constructor(e,t=!0){super(e,"PBRAnisotropic",110,new fy,t),this._isEnabled=!1,this.isEnabled=!1,this.intensity=1,this.direction=new le(1,0),this._texture=null,this.texture=null,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&this._texture&&ce.AnisotropicTextureEnabled&&!this._texture.isReadyOrNotBlocking()):!0}prepareDefinesBeforeAttributes(e,t,i){this._isEnabled?(e.ANISOTROPIC=this._isEnabled,this._isEnabled&&!i.isVerticesDataPresent(y.TangentKind)&&(e._needUVs=!0,e.MAINUV1=!0),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.AnisotropicTextureEnabled?se.PrepareDefinesForMergedUV(this._texture,e,"ANISOTROPIC_TEXTURE"):e.ANISOTROPIC_TEXTURE=!1)):(e.ANISOTROPIC=!1,e.ANISOTROPIC_TEXTURE=!1,e.ANISOTROPIC_TEXTUREDIRECTUV=0,e.MAINUV1=!1)}bindForSubMesh(e,t){if(!this._isEnabled)return;const i=this._material.isFrozen;(!e.useUbo||!i||!e.isSync)&&(this._texture&&ce.AnisotropicTextureEnabled&&(e.updateFloat2("vAnisotropyInfos",this._texture.coordinatesIndex,this._texture.level),se.BindTextureMatrix(this._texture,e,"anisotropy")),e.updateFloat3("vAnisotropy",this.direction.x,this.direction.y,this.intensity)),t.texturesEnabled&&this._texture&&ce.AnisotropicTextureEnabled&&e.setTexture("anisotropySampler",this._texture)}hasTexture(e){return this._texture===e}getActiveTextures(e){this._texture&&e.push(this._texture)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture)}dispose(e){e&&this._texture&&this._texture.dispose()}getClassName(){return"PBRAnisotropicConfiguration"}addFallbacks(e,t,i){return e.ANISOTROPIC&&t.addFallback(i++,"ANISOTROPIC"),i}getSamplers(e){e.push("anisotropySampler")}getUniforms(){return{ubo:[{name:"vAnisotropy",size:3,type:"vec3"},{name:"vAnisotropyInfos",size:2,type:"vec2"},{name:"anisotropyMatrix",size:16,type:"mat4"}]}}}T([R(),ie("_markAllSubMeshesAsTexturesDirty")],eh.prototype,"isEnabled",void 0);T([R()],eh.prototype,"intensity",void 0);T([Dd()],eh.prototype,"direction",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],eh.prototype,"texture",void 0);class py extends rr{constructor(){super(...arguments),this.SHEEN=!1,this.SHEEN_TEXTURE=!1,this.SHEEN_GAMMATEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS=!1,this.SHEEN_TEXTUREDIRECTUV=0,this.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0,this.SHEEN_LINKWITHALBEDO=!1,this.SHEEN_ROUGHNESS=!1,this.SHEEN_ALBEDOSCALING=!1,this.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,this.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1}}class en extends Zr{constructor(e,t=!0){super(e,"Sheen",120,new py,t),this._isEnabled=!1,this.isEnabled=!1,this._linkSheenWithAlbedo=!1,this.linkSheenWithAlbedo=!1,this.intensity=1,this.color=re.White(),this._texture=null,this.texture=null,this._useRoughnessFromMainTexture=!0,this.useRoughnessFromMainTexture=!0,this._roughness=null,this.roughness=null,this._textureRoughness=null,this.textureRoughness=null,this._albedoScaling=!1,this.albedoScaling=!1,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1]}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}isReadyForSubMesh(e,t){return this._isEnabled?!(e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.SheenTextureEnabled&&!this._texture.isReadyOrNotBlocking()||this._textureRoughness&&ce.SheenTextureEnabled&&!this._textureRoughness.isReadyOrNotBlocking())):!0}prepareDefinesBeforeAttributes(e,t){var i;this._isEnabled?(e.SHEEN=!0,e.SHEEN_LINKWITHALBEDO=this._linkSheenWithAlbedo,e.SHEEN_ROUGHNESS=this._roughness!==null,e.SHEEN_ALBEDOSCALING=this._albedoScaling,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=this._useRoughnessFromMainTexture,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=this._texture!==null&&this._texture._texture===((i=this._textureRoughness)===null||i===void 0?void 0:i._texture)&&this._texture.checkTransformsAreIdentical(this._textureRoughness),e._areTexturesDirty&&t.texturesEnabled&&(this._texture&&ce.SheenTextureEnabled?(se.PrepareDefinesForMergedUV(this._texture,e,"SHEEN_TEXTURE"),e.SHEEN_GAMMATEXTURE=this._texture.gammaSpace):e.SHEEN_TEXTURE=!1,this._textureRoughness&&ce.SheenTextureEnabled?se.PrepareDefinesForMergedUV(this._textureRoughness,e,"SHEEN_TEXTURE_ROUGHNESS"):e.SHEEN_TEXTURE_ROUGHNESS=!1)):(e.SHEEN=!1,e.SHEEN_TEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS=!1,e.SHEEN_LINKWITHALBEDO=!1,e.SHEEN_ROUGHNESS=!1,e.SHEEN_ALBEDOSCALING=!1,e.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE=!1,e.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL=!1,e.SHEEN_GAMMATEXTURE=!1,e.SHEEN_TEXTUREDIRECTUV=0,e.SHEEN_TEXTURE_ROUGHNESSDIRECTUV=0)}bindForSubMesh(e,t,i,s){var r,n,o,l,h,c,u,d;if(!this._isEnabled)return;const f=s.materialDefines,p=this._material.isFrozen,_=f.SHEEN_TEXTURE_ROUGHNESS_IDENTICAL;(!e.useUbo||!p||!e.isSync)&&(_&&ce.SheenTextureEnabled?(e.updateFloat4("vSheenInfos",this._texture.coordinatesIndex,this._texture.level,-1,-1),se.BindTextureMatrix(this._texture,e,"sheen")):(this._texture||this._textureRoughness)&&ce.SheenTextureEnabled&&(e.updateFloat4("vSheenInfos",(n=(r=this._texture)===null||r===void 0?void 0:r.coordinatesIndex)!==null&&n!==void 0?n:0,(l=(o=this._texture)===null||o===void 0?void 0:o.level)!==null&&l!==void 0?l:0,(c=(h=this._textureRoughness)===null||h===void 0?void 0:h.coordinatesIndex)!==null&&c!==void 0?c:0,(d=(u=this._textureRoughness)===null||u===void 0?void 0:u.level)!==null&&d!==void 0?d:0),this._texture&&se.BindTextureMatrix(this._texture,e,"sheen"),this._textureRoughness&&!_&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&se.BindTextureMatrix(this._textureRoughness,e,"sheenRoughness")),e.updateFloat4("vSheenColor",this.color.r,this.color.g,this.color.b,this.intensity),this._roughness!==null&&e.updateFloat("vSheenRoughness",this._roughness)),t.texturesEnabled&&(this._texture&&ce.SheenTextureEnabled&&e.setTexture("sheenSampler",this._texture),this._textureRoughness&&!_&&!f.SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE&&ce.SheenTextureEnabled&&e.setTexture("sheenRoughnessSampler",this._textureRoughness))}hasTexture(e){return this._texture===e||this._textureRoughness===e}getActiveTextures(e){this._texture&&e.push(this._texture),this._textureRoughness&&e.push(this._textureRoughness)}getAnimatables(e){this._texture&&this._texture.animations&&this._texture.animations.length>0&&e.push(this._texture),this._textureRoughness&&this._textureRoughness.animations&&this._textureRoughness.animations.length>0&&e.push(this._textureRoughness)}dispose(e){var t,i;e&&((t=this._texture)===null||t===void 0||t.dispose(),(i=this._textureRoughness)===null||i===void 0||i.dispose())}getClassName(){return"PBRSheenConfiguration"}addFallbacks(e,t,i){return e.SHEEN&&t.addFallback(i++,"SHEEN"),i}getSamplers(e){e.push("sheenSampler","sheenRoughnessSampler")}getUniforms(){return{ubo:[{name:"vSheenColor",size:4,type:"vec4"},{name:"vSheenRoughness",size:1,type:"float"},{name:"vSheenInfos",size:4,type:"vec4"},{name:"sheenMatrix",size:16,type:"mat4"},{name:"sheenRoughnessMatrix",size:16,type:"mat4"}]}}}T([R(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"isEnabled",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"linkSheenWithAlbedo",void 0);T([R()],en.prototype,"intensity",void 0);T([pi()],en.prototype,"color",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"texture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"useRoughnessFromMainTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"roughness",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"textureRoughness",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],en.prototype,"albedoScaling",void 0);class _y extends rr{constructor(){super(...arguments),this.SUBSURFACE=!1,this.SS_REFRACTION=!1,this.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_TRANSLUCENCY=!1,this.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,this.SS_SCATTERING=!1,this.SS_THICKNESSANDMASK_TEXTURE=!1,this.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,this.SS_HAS_THICKNESS=!1,this.SS_REFRACTIONINTENSITY_TEXTURE=!1,this.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,this.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,this.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,this.SS_REFRACTIONMAP_3D=!1,this.SS_REFRACTIONMAP_OPPOSITEZ=!1,this.SS_LODINREFRACTIONALPHA=!1,this.SS_GAMMAREFRACTION=!1,this.SS_RGBDREFRACTION=!1,this.SS_LINEARSPECULARREFRACTION=!1,this.SS_LINKREFRACTIONTOTRANSPARENCY=!1,this.SS_ALBEDOFORREFRACTIONTINT=!1,this.SS_ALBEDOFORTRANSLUCENCYTINT=!1,this.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,this.SS_USE_THICKNESS_AS_DEPTH=!1,this.SS_MASK_FROM_THICKNESS_TEXTURE=!1,this.SS_USE_GLTF_TEXTURES=!1}}class hi extends Zr{constructor(e,t=!0){super(e,"PBRSubSurface",130,new _y,t),this._isRefractionEnabled=!1,this.isRefractionEnabled=!1,this._isTranslucencyEnabled=!1,this.isTranslucencyEnabled=!1,this._isScatteringEnabled=!1,this.isScatteringEnabled=!1,this._scatteringDiffusionProfileIndex=0,this.refractionIntensity=1,this.translucencyIntensity=1,this.useAlbedoToTintRefraction=!1,this.useAlbedoToTintTranslucency=!1,this._thicknessTexture=null,this.thicknessTexture=null,this._refractionTexture=null,this.refractionTexture=null,this._indexOfRefraction=1.5,this.indexOfRefraction=1.5,this._volumeIndexOfRefraction=-1,this._invertRefractionY=!1,this.invertRefractionY=!1,this._linkRefractionWithTransparency=!1,this.linkRefractionWithTransparency=!1,this.minimumThickness=0,this.maximumThickness=1,this.useThicknessAsDepth=!1,this.tintColor=re.White(),this.tintColorAtDistance=1,this.diffusionDistance=re.White(),this._useMaskFromThicknessTexture=!1,this.useMaskFromThicknessTexture=!1,this._refractionIntensityTexture=null,this.refractionIntensityTexture=null,this._translucencyIntensityTexture=null,this.translucencyIntensityTexture=null,this._useGltfStyleTextures=!1,this.useGltfStyleTextures=!1,this._scene=e.getScene(),this.registerForExtraEvents=!0,this._internalMarkAllSubMeshesAsTexturesDirty=e._dirtyCallbacks[1],this._internalMarkScenePrePassDirty=e._dirtyCallbacks[32]}get scatteringDiffusionProfile(){return this._scene.subSurfaceConfiguration?this._scene.subSurfaceConfiguration.ssDiffusionProfileColors[this._scatteringDiffusionProfileIndex]:null}set scatteringDiffusionProfile(e){!this._scene.enableSubSurfaceForPrePass()||e&&(this._scatteringDiffusionProfileIndex=this._scene.subSurfaceConfiguration.addDiffusionProfile(e))}get volumeIndexOfRefraction(){return this._volumeIndexOfRefraction>=1?this._volumeIndexOfRefraction:this._indexOfRefraction}set volumeIndexOfRefraction(e){e>=1?this._volumeIndexOfRefraction=e:this._volumeIndexOfRefraction=-1}_markAllSubMeshesAsTexturesDirty(){this._enable(this._isRefractionEnabled||this._isTranslucencyEnabled||this._isScatteringEnabled),this._internalMarkAllSubMeshesAsTexturesDirty()}_markScenePrePassDirty(){this._internalMarkAllSubMeshesAsTexturesDirty(),this._internalMarkScenePrePassDirty()}isReadyForSubMesh(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return!0;if(e._areTexturesDirty&&t.texturesEnabled){if(this._thicknessTexture&&ce.ThicknessTextureEnabled&&!this._thicknessTexture.isReadyOrNotBlocking())return!1;const i=this._getRefractionTexture(t);if(i&&ce.RefractionTextureEnabled&&!i.isReadyOrNotBlocking())return!1}return!0}prepareDefinesBeforeAttributes(e,t){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled){e.SUBSURFACE=!1,e.SS_TRANSLUCENCY=!1,e.SS_SCATTERING=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_THICKNESSANDMASK_TEXTUREDIRECTUV=0,e.SS_HAS_THICKNESS=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTUREDIRECTUV=0,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTUREDIRECTUV=0,e.SS_REFRACTIONMAP_3D=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1;return}if(e._areTexturesDirty){e.SUBSURFACE=!0,e.SS_TRANSLUCENCY=this._isTranslucencyEnabled,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_SCATTERING=this._isScatteringEnabled,e.SS_THICKNESSANDMASK_TEXTURE=!1,e.SS_REFRACTIONINTENSITY_TEXTURE=!1,e.SS_TRANSLUCENCYINTENSITY_TEXTURE=!1,e.SS_HAS_THICKNESS=!1,e.SS_MASK_FROM_THICKNESS_TEXTURE=!1,e.SS_USE_GLTF_TEXTURES=!1,e.SS_REFRACTION=!1,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=!1,e.SS_REFRACTIONMAP_3D=!1,e.SS_GAMMAREFRACTION=!1,e.SS_RGBDREFRACTION=!1,e.SS_LINEARSPECULARREFRACTION=!1,e.SS_REFRACTIONMAP_OPPOSITEZ=!1,e.SS_LODINREFRACTIONALPHA=!1,e.SS_LINKREFRACTIONTOTRANSPARENCY=!1,e.SS_ALBEDOFORREFRACTIONTINT=!1,e.SS_ALBEDOFORTRANSLUCENCYTINT=!1,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=!1,e.SS_USE_THICKNESS_AS_DEPTH=!1;const i=!!this._thicknessTexture&&!!this._refractionIntensityTexture&&this._refractionIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._refractionIntensityTexture._texture===this._thicknessTexture._texture,s=!!this._thicknessTexture&&!!this._translucencyIntensityTexture&&this._translucencyIntensityTexture.checkTransformsAreIdentical(this._thicknessTexture)&&this._translucencyIntensityTexture._texture===this._thicknessTexture._texture,r=(i||!this._refractionIntensityTexture)&&(s||!this._translucencyIntensityTexture);if(e._areTexturesDirty&&t.texturesEnabled&&(this._thicknessTexture&&ce.ThicknessTextureEnabled&&se.PrepareDefinesForMergedUV(this._thicknessTexture,e,"SS_THICKNESSANDMASK_TEXTURE"),this._refractionIntensityTexture&&ce.RefractionIntensityTextureEnabled&&!r&&se.PrepareDefinesForMergedUV(this._refractionIntensityTexture,e,"SS_REFRACTIONINTENSITY_TEXTURE"),this._translucencyIntensityTexture&&ce.TranslucencyIntensityTextureEnabled&&!r&&se.PrepareDefinesForMergedUV(this._translucencyIntensityTexture,e,"SS_TRANSLUCENCYINTENSITY_TEXTURE")),e.SS_HAS_THICKNESS=this.maximumThickness-this.minimumThickness!==0,e.SS_MASK_FROM_THICKNESS_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture||!!this._translucencyIntensityTexture)&&r,e.SS_USE_GLTF_TEXTURES=this._useGltfStyleTextures,e.SS_REFRACTION_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._refractionIntensityTexture)&&r,e.SS_TRANSLUCENCY_USE_INTENSITY_FROM_TEXTURE=(this._useMaskFromThicknessTexture||!!this._translucencyIntensityTexture)&&r,this._isRefractionEnabled&&t.texturesEnabled){const n=this._getRefractionTexture(t);n&&ce.RefractionTextureEnabled&&(e.SS_REFRACTION=!0,e.SS_REFRACTIONMAP_3D=n.isCube,e.SS_GAMMAREFRACTION=n.gammaSpace,e.SS_RGBDREFRACTION=n.isRGBD,e.SS_LINEARSPECULARREFRACTION=n.linearSpecularLOD,e.SS_REFRACTIONMAP_OPPOSITEZ=n.invertZ,e.SS_LODINREFRACTIONALPHA=n.lodLevelInAlpha,e.SS_LINKREFRACTIONTOTRANSPARENCY=this._linkRefractionWithTransparency,e.SS_ALBEDOFORREFRACTIONTINT=this.useAlbedoToTintRefraction,e.SS_USE_LOCAL_REFRACTIONMAP_CUBIC=n.isCube&&n.boundingBoxSize,e.SS_USE_THICKNESS_AS_DEPTH=this.useThicknessAsDepth)}this._isTranslucencyEnabled&&(e.SS_ALBEDOFORTRANSLUCENCYTINT=this.useAlbedoToTintTranslucency)}}hardBindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;s.getRenderingMesh().getWorldMatrix().decompose(G.Vector3[0]);const r=Math.max(Math.abs(G.Vector3[0].x),Math.abs(G.Vector3[0].y),Math.abs(G.Vector3[0].z));e.updateFloat2("vThicknessParam",this.minimumThickness*r,(this.maximumThickness-this.minimumThickness)*r)}bindForSubMesh(e,t,i,s){if(!this._isRefractionEnabled&&!this._isTranslucencyEnabled&&!this._isScatteringEnabled)return;const r=s.materialDefines,n=this._material.isFrozen,o=this._material.realTimeFiltering,l=r.LODBASEDMICROSFURACE,h=this._getRefractionTexture(t);if(!e.useUbo||!n||!e.isSync){if(this._thicknessTexture&&ce.ThicknessTextureEnabled&&(e.updateFloat2("vThicknessInfos",this._thicknessTexture.coordinatesIndex,this._thicknessTexture.level),se.BindTextureMatrix(this._thicknessTexture,e,"thickness")),this._refractionIntensityTexture&&ce.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&(e.updateFloat2("vRefractionIntensityInfos",this._refractionIntensityTexture.coordinatesIndex,this._refractionIntensityTexture.level),se.BindTextureMatrix(this._refractionIntensityTexture,e,"refractionIntensity")),this._translucencyIntensityTexture&&ce.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&(e.updateFloat2("vTranslucencyIntensityInfos",this._translucencyIntensityTexture.coordinatesIndex,this._translucencyIntensityTexture.level),se.BindTextureMatrix(this._translucencyIntensityTexture,e,"translucencyIntensity")),h&&ce.RefractionTextureEnabled){e.updateMatrix("refractionMatrix",h.getReflectionTextureMatrix());let c=1;h.isCube||h.depth&&(c=h.depth);const u=h.getSize().width,d=this.volumeIndexOfRefraction;if(e.updateFloat4("vRefractionInfos",h.level,1/d,c,this._invertRefractionY?-1:1),e.updateFloat4("vRefractionMicrosurfaceInfos",u,h.lodGenerationScale,h.lodGenerationOffset,1/this.indexOfRefraction),o&&e.updateFloat2("vRefractionFilteringInfo",u,oe.Log2(u)),h.boundingBoxSize){const f=h;e.updateVector3("vRefractionPosition",f.boundingBoxPosition),e.updateVector3("vRefractionSize",f.boundingBoxSize)}}this._isScatteringEnabled&&e.updateFloat("scatteringDiffusionProfile",this._scatteringDiffusionProfileIndex),e.updateColor3("vDiffusionDistance",this.diffusionDistance),e.updateFloat4("vTintColor",this.tintColor.r,this.tintColor.g,this.tintColor.b,Math.max(1e-5,this.tintColorAtDistance)),e.updateFloat3("vSubSurfaceIntensity",this.refractionIntensity,this.translucencyIntensity,0)}t.texturesEnabled&&(this._thicknessTexture&&ce.ThicknessTextureEnabled&&e.setTexture("thicknessSampler",this._thicknessTexture),this._refractionIntensityTexture&&ce.RefractionIntensityTextureEnabled&&r.SS_REFRACTIONINTENSITY_TEXTURE&&e.setTexture("refractionIntensitySampler",this._refractionIntensityTexture),this._translucencyIntensityTexture&&ce.TranslucencyIntensityTextureEnabled&&r.SS_TRANSLUCENCYINTENSITY_TEXTURE&&e.setTexture("translucencyIntensitySampler",this._translucencyIntensityTexture),h&&ce.RefractionTextureEnabled&&(l?e.setTexture("refractionSampler",h):(e.setTexture("refractionSampler",h._lodTextureMid||h),e.setTexture("refractionSamplerLow",h._lodTextureLow||h),e.setTexture("refractionSamplerHigh",h._lodTextureHigh||h))))}_getRefractionTexture(e){return this._refractionTexture?this._refractionTexture:this._isRefractionEnabled?e.environmentTexture:null}get disableAlphaBlending(){return this._isRefractionEnabled&&this._linkRefractionWithTransparency}fillRenderTargetTextures(e){ce.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget&&e.push(this._refractionTexture)}hasTexture(e){return this._thicknessTexture===e||this._refractionTexture===e}hasRenderTargetTextures(){return!!(ce.RefractionTextureEnabled&&this._refractionTexture&&this._refractionTexture.isRenderTarget)}getActiveTextures(e){this._thicknessTexture&&e.push(this._thicknessTexture),this._refractionTexture&&e.push(this._refractionTexture)}getAnimatables(e){this._thicknessTexture&&this._thicknessTexture.animations&&this._thicknessTexture.animations.length>0&&e.push(this._thicknessTexture),this._refractionTexture&&this._refractionTexture.animations&&this._refractionTexture.animations.length>0&&e.push(this._refractionTexture)}dispose(e){e&&(this._thicknessTexture&&this._thicknessTexture.dispose(),this._refractionTexture&&this._refractionTexture.dispose())}getClassName(){return"PBRSubSurfaceConfiguration"}addFallbacks(e,t,i){return e.SS_SCATTERING&&t.addFallback(i++,"SS_SCATTERING"),e.SS_TRANSLUCENCY&&t.addFallback(i++,"SS_TRANSLUCENCY"),i}getSamplers(e){e.push("thicknessSampler","refractionIntensitySampler","translucencyIntensitySampler","refractionSampler","refractionSamplerLow","refractionSamplerHigh")}getUniforms(){return{ubo:[{name:"vRefractionMicrosurfaceInfos",size:4,type:"vec4"},{name:"vRefractionFilteringInfo",size:2,type:"vec2"},{name:"vTranslucencyIntensityInfos",size:2,type:"vec2"},{name:"vRefractionInfos",size:4,type:"vec4"},{name:"refractionMatrix",size:16,type:"mat4"},{name:"vThicknessInfos",size:2,type:"vec2"},{name:"vRefractionIntensityInfos",size:2,type:"vec2"},{name:"thicknessMatrix",size:16,type:"mat4"},{name:"refractionIntensityMatrix",size:16,type:"mat4"},{name:"translucencyIntensityMatrix",size:16,type:"mat4"},{name:"vThicknessParam",size:2,type:"vec2"},{name:"vDiffusionDistance",size:3,type:"vec3"},{name:"vTintColor",size:4,type:"vec4"},{name:"vSubSurfaceIntensity",size:3,type:"vec3"},{name:"vRefractionPosition",size:3,type:"vec3"},{name:"vRefractionSize",size:3,type:"vec3"},{name:"scatteringDiffusionProfile",size:1,type:"float"}]}}}T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"isRefractionEnabled",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"isTranslucencyEnabled",void 0);T([R(),ie("_markScenePrePassDirty")],hi.prototype,"isScatteringEnabled",void 0);T([R()],hi.prototype,"_scatteringDiffusionProfileIndex",void 0);T([R()],hi.prototype,"refractionIntensity",void 0);T([R()],hi.prototype,"translucencyIntensity",void 0);T([R()],hi.prototype,"useAlbedoToTintRefraction",void 0);T([R()],hi.prototype,"useAlbedoToTintTranslucency",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"thicknessTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"refractionTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"indexOfRefraction",void 0);T([R()],hi.prototype,"_volumeIndexOfRefraction",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"volumeIndexOfRefraction",null);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"invertRefractionY",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"linkRefractionWithTransparency",void 0);T([R()],hi.prototype,"minimumThickness",void 0);T([R()],hi.prototype,"maximumThickness",void 0);T([R()],hi.prototype,"useThicknessAsDepth",void 0);T([pi()],hi.prototype,"tintColor",void 0);T([R()],hi.prototype,"tintColorAtDistance",void 0);T([pi()],hi.prototype,"diffusionDistance",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"useMaskFromThicknessTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"refractionIntensityTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"translucencyIntensityTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],hi.prototype,"useGltfStyleTextures",void 0);const so={effect:null,subMesh:null};class Bf extends rr{constructor(e){super(e),this.PBR=!0,this.NUM_SAMPLES="0",this.REALTIME_FILTERING=!1,this.MAINUV1=!1,this.MAINUV2=!1,this.MAINUV3=!1,this.MAINUV4=!1,this.MAINUV5=!1,this.MAINUV6=!1,this.UV1=!1,this.UV2=!1,this.UV3=!1,this.UV4=!1,this.UV5=!1,this.UV6=!1,this.ALBEDO=!1,this.GAMMAALBEDO=!1,this.ALBEDODIRECTUV=0,this.VERTEXCOLOR=!1,this.BAKED_VERTEX_ANIMATION_TEXTURE=!1,this.AMBIENT=!1,this.AMBIENTDIRECTUV=0,this.AMBIENTINGRAYSCALE=!1,this.OPACITY=!1,this.VERTEXALPHA=!1,this.OPACITYDIRECTUV=0,this.OPACITYRGB=!1,this.ALPHATEST=!1,this.DEPTHPREPASS=!1,this.ALPHABLEND=!1,this.ALPHAFROMALBEDO=!1,this.ALPHATESTVALUE="0.5",this.SPECULAROVERALPHA=!1,this.RADIANCEOVERALPHA=!1,this.ALPHAFRESNEL=!1,this.LINEARALPHAFRESNEL=!1,this.PREMULTIPLYALPHA=!1,this.EMISSIVE=!1,this.EMISSIVEDIRECTUV=0,this.GAMMAEMISSIVE=!1,this.REFLECTIVITY=!1,this.REFLECTIVITY_GAMMA=!1,this.REFLECTIVITYDIRECTUV=0,this.SPECULARTERM=!1,this.MICROSURFACEFROMREFLECTIVITYMAP=!1,this.MICROSURFACEAUTOMATIC=!1,this.LODBASEDMICROSFURACE=!1,this.MICROSURFACEMAP=!1,this.MICROSURFACEMAPDIRECTUV=0,this.METALLICWORKFLOW=!1,this.ROUGHNESSSTOREINMETALMAPALPHA=!1,this.ROUGHNESSSTOREINMETALMAPGREEN=!1,this.METALLNESSSTOREINMETALMAPBLUE=!1,this.AOSTOREINMETALMAPRED=!1,this.METALLIC_REFLECTANCE=!1,this.METALLIC_REFLECTANCE_GAMMA=!1,this.METALLIC_REFLECTANCEDIRECTUV=0,this.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=!1,this.REFLECTANCE=!1,this.REFLECTANCE_GAMMA=!1,this.REFLECTANCEDIRECTUV=0,this.ENVIRONMENTBRDF=!1,this.ENVIRONMENTBRDF_RGBD=!1,this.NORMAL=!1,this.TANGENT=!1,this.BUMP=!1,this.BUMPDIRECTUV=0,this.OBJECTSPACE_NORMALMAP=!1,this.PARALLAX=!1,this.PARALLAXOCCLUSION=!1,this.NORMALXYSCALE=!0,this.LIGHTMAP=!1,this.LIGHTMAPDIRECTUV=0,this.USELIGHTMAPASSHADOWMAP=!1,this.GAMMALIGHTMAP=!1,this.RGBDLIGHTMAP=!1,this.REFLECTION=!1,this.REFLECTIONMAP_3D=!1,this.REFLECTIONMAP_SPHERICAL=!1,this.REFLECTIONMAP_PLANAR=!1,this.REFLECTIONMAP_CUBIC=!1,this.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,this.REFLECTIONMAP_PROJECTION=!1,this.REFLECTIONMAP_SKYBOX=!1,this.REFLECTIONMAP_EXPLICIT=!1,this.REFLECTIONMAP_EQUIRECTANGULAR=!1,this.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,this.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,this.INVERTCUBICMAP=!1,this.USESPHERICALFROMREFLECTIONMAP=!1,this.USEIRRADIANCEMAP=!1,this.USESPHERICALINVERTEX=!1,this.REFLECTIONMAP_OPPOSITEZ=!1,this.LODINREFLECTIONALPHA=!1,this.GAMMAREFLECTION=!1,this.RGBDREFLECTION=!1,this.LINEARSPECULARREFLECTION=!1,this.RADIANCEOCCLUSION=!1,this.HORIZONOCCLUSION=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.INSTANCESCOLOR=!1,this.PREPASS=!1,this.PREPASS_IRRADIANCE=!1,this.PREPASS_IRRADIANCE_INDEX=-1,this.PREPASS_ALBEDO_SQRT=!1,this.PREPASS_ALBEDO_SQRT_INDEX=-1,this.PREPASS_DEPTH=!1,this.PREPASS_DEPTH_INDEX=-1,this.PREPASS_NORMAL=!1,this.PREPASS_NORMAL_INDEX=-1,this.PREPASS_POSITION=!1,this.PREPASS_POSITION_INDEX=-1,this.PREPASS_VELOCITY=!1,this.PREPASS_VELOCITY_INDEX=-1,this.PREPASS_REFLECTIVITY=!1,this.PREPASS_REFLECTIVITY_INDEX=-1,this.SCENE_MRT_COUNT=0,this.NUM_BONE_INFLUENCERS=0,this.BonesPerMesh=0,this.BONETEXTURE=!1,this.BONES_VELOCITY_ENABLED=!1,this.NONUNIFORMSCALING=!1,this.MORPHTARGETS=!1,this.MORPHTARGETS_NORMAL=!1,this.MORPHTARGETS_TANGENT=!1,this.MORPHTARGETS_UV=!1,this.NUM_MORPH_INFLUENCERS=0,this.MORPHTARGETS_TEXTURE=!1,this.IMAGEPROCESSING=!1,this.VIGNETTE=!1,this.VIGNETTEBLENDMODEMULTIPLY=!1,this.VIGNETTEBLENDMODEOPAQUE=!1,this.TONEMAPPING=!1,this.TONEMAPPING_ACES=!1,this.CONTRAST=!1,this.COLORCURVES=!1,this.COLORGRADING=!1,this.COLORGRADING3D=!1,this.SAMPLER3DGREENDEPTH=!1,this.SAMPLER3DBGRMAP=!1,this.DITHER=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.EXPOSURE=!1,this.MULTIVIEW=!1,this.ORDER_INDEPENDENT_TRANSPARENCY=!1,this.ORDER_INDEPENDENT_TRANSPARENCY_16BITS=!1,this.USEPHYSICALLIGHTFALLOFF=!1,this.USEGLTFLIGHTFALLOFF=!1,this.TWOSIDEDLIGHTING=!1,this.SHADOWFLOAT=!1,this.CLIPPLANE=!1,this.CLIPPLANE2=!1,this.CLIPPLANE3=!1,this.CLIPPLANE4=!1,this.CLIPPLANE5=!1,this.CLIPPLANE6=!1,this.POINTSIZE=!1,this.FOG=!1,this.LOGARITHMICDEPTH=!1,this.FORCENORMALFORWARD=!1,this.SPECULARAA=!1,this.UNLIT=!1,this.DEBUGMODE=0,this.rebuild()}reset(){super.reset(),this.ALPHATESTVALUE="0.5",this.PBR=!0,this.NORMALXYSCALE=!0}}class vt extends zo{constructor(e,t){super(e,t),this._directIntensity=1,this._emissiveIntensity=1,this._environmentIntensity=1,this._specularIntensity=1,this._lightingInfos=new Ge(this._directIntensity,this._emissiveIntensity,this._environmentIntensity,this._specularIntensity),this._disableBumpMap=!1,this._albedoTexture=null,this._ambientTexture=null,this._ambientTextureStrength=1,this._ambientTextureImpactOnAnalyticalLights=vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this._opacityTexture=null,this._reflectionTexture=null,this._emissiveTexture=null,this._reflectivityTexture=null,this._metallicTexture=null,this._metallic=null,this._roughness=null,this._metallicF0Factor=1,this._metallicReflectanceColor=re.White(),this._useOnlyMetallicFromMetallicReflectanceTexture=!1,this._metallicReflectanceTexture=null,this._reflectanceTexture=null,this._microSurfaceTexture=null,this._bumpTexture=null,this._lightmapTexture=null,this._ambientColor=new re(0,0,0),this._albedoColor=new re(1,1,1),this._reflectivityColor=new re(1,1,1),this._reflectionColor=new re(1,1,1),this._emissiveColor=new re(0,0,0),this._microSurface=.9,this._useLightmapAsShadowmap=!1,this._useHorizonOcclusion=!0,this._useRadianceOcclusion=!0,this._useAlphaFromAlbedoTexture=!1,this._useSpecularOverAlpha=!0,this._useMicroSurfaceFromReflectivityMapAlpha=!1,this._useRoughnessFromMetallicTextureAlpha=!0,this._useRoughnessFromMetallicTextureGreen=!1,this._useMetallnessFromMetallicTextureBlue=!1,this._useAmbientOcclusionFromMetallicTextureRed=!1,this._useAmbientInGrayScale=!1,this._useAutoMicroSurfaceFromReflectivityMap=!1,this._lightFalloff=vt.LIGHTFALLOFF_PHYSICAL,this._useRadianceOverAlpha=!0,this._useObjectSpaceNormalMap=!1,this._useParallax=!1,this._useParallaxOcclusion=!1,this._parallaxScaleBias=.05,this._disableLighting=!1,this._maxSimultaneousLights=4,this._invertNormalMapX=!1,this._invertNormalMapY=!1,this._twoSidedLighting=!1,this._alphaCutOff=.4,this._forceAlphaTest=!1,this._useAlphaFresnel=!1,this._useLinearAlphaFresnel=!1,this._environmentBRDFTexture=null,this._forceIrradianceInFragment=!1,this._realTimeFiltering=!1,this._realTimeFilteringQuality=8,this._forceNormalForward=!1,this._enableSpecularAntiAliasing=!1,this._imageProcessingObserver=null,this._renderTargets=new mi(16),this._globalAmbientColor=new re(0,0,0),this._useLogarithmicDepth=!1,this._unlit=!1,this._debugMode=0,this.debugMode=0,this._debugLimit=-1,this._debugFactor=1,this._cacheHasRenderTargetTextures=!1,this.brdf=new ls(this),this.clearCoat=new Oi(this),this.iridescence=new _s(this),this.anisotropy=new eh(this),this.sheen=new en(this),this.subSurface=new hi(this),this.detailMap=new ca(this),this._attachImageProcessingConfiguration(null),this.getRenderTargetTextures=()=>(this._renderTargets.reset(),ce.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget&&this._renderTargets.push(this._reflectionTexture),this._eventInfo.renderTargets=this._renderTargets,this._callbackPluginEventFillRenderTargetTextures(this._eventInfo),this._renderTargets),this._environmentBRDFTexture=r0(this.getScene()),this.prePassConfiguration=new Zh}get realTimeFiltering(){return this._realTimeFiltering}set realTimeFiltering(e){this._realTimeFiltering=e,this.markAsDirty(1)}get realTimeFilteringQuality(){return this._realTimeFilteringQuality}set realTimeFilteringQuality(e){this._realTimeFilteringQuality=e,this.markAsDirty(1)}get canRenderToMRT(){return!0}_attachImageProcessingConfiguration(e){e!==this._imageProcessingConfiguration&&(this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),e?this._imageProcessingConfiguration=e:this._imageProcessingConfiguration=this.getScene().imageProcessingConfiguration,this._imageProcessingConfiguration&&(this._imageProcessingObserver=this._imageProcessingConfiguration.onUpdateParameters.add(()=>{this._markAllSubMeshesAsImageProcessingDirty()})))}get hasRenderTargetTextures(){return ce.ReflectionTextureEnabled&&this._reflectionTexture&&this._reflectionTexture.isRenderTarget?!0:this._cacheHasRenderTargetTextures}get isPrePassCapable(){return!this.disableDepthWrite}getClassName(){return"PBRBaseMaterial"}get useLogarithmicDepth(){return this._useLogarithmicDepth}set useLogarithmicDepth(e){this._useLogarithmicDepth=e&&this.getScene().getEngine().getCaps().fragmentDepthSupported}get _disableAlphaBlending(){var e;return this._transparencyMode===vt.PBRMATERIAL_OPAQUE||this._transparencyMode===vt.PBRMATERIAL_ALPHATEST||((e=this.subSurface)===null||e===void 0?void 0:e.disableAlphaBlending)}needAlphaBlending(){return this._disableAlphaBlending?!1:this.alpha<1||this._opacityTexture!=null||this._shouldUseAlphaFromAlbedoTexture()}needAlphaTesting(){var e;return this._forceAlphaTest?!0:!((e=this.subSurface)===null||e===void 0)&&e.disableAlphaBlending?!1:this._hasAlphaChannel()&&(this._transparencyMode==null||this._transparencyMode===vt.PBRMATERIAL_ALPHATEST)}_shouldUseAlphaFromAlbedoTexture(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha&&this._useAlphaFromAlbedoTexture&&this._transparencyMode!==vt.PBRMATERIAL_OPAQUE}_hasAlphaChannel(){return this._albedoTexture!=null&&this._albedoTexture.hasAlpha||this._opacityTexture!=null}getAlphaTestTexture(){return this._albedoTexture}isReadyForSubMesh(e,t,i){if(this._uniformBufferLayoutBuilt||this.buildUniformLayout(),t.effect&&this.isFrozen&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(this._callbackPluginEventGeneric(Wi.GetDefineNames,this._eventInfo),t.materialDefines=new Bf(this._eventInfo.defineNames));const s=t.materialDefines;if(this._isReadyForSubMesh(t))return!0;const r=this.getScene(),n=r.getEngine();if(s._areTexturesDirty&&(this._eventInfo.hasRenderTargetTextures=!1,this._callbackPluginEventHasRenderTargetTextures(this._eventInfo),this._cacheHasRenderTargetTextures=this._eventInfo.hasRenderTargetTextures,r.texturesEnabled)){if(this._albedoTexture&&ce.DiffuseTextureEnabled&&!this._albedoTexture.isReadyOrNotBlocking()||this._ambientTexture&&ce.AmbientTextureEnabled&&!this._ambientTexture.isReadyOrNotBlocking()||this._opacityTexture&&ce.OpacityTextureEnabled&&!this._opacityTexture.isReadyOrNotBlocking())return!1;const c=this._getReflectionTexture();if(c&&ce.ReflectionTextureEnabled&&(!c.isReadyOrNotBlocking()||c.irradianceTexture&&!c.irradianceTexture.isReadyOrNotBlocking())||this._lightmapTexture&&ce.LightmapTextureEnabled&&!this._lightmapTexture.isReadyOrNotBlocking()||this._emissiveTexture&&ce.EmissiveTextureEnabled&&!this._emissiveTexture.isReadyOrNotBlocking())return!1;if(ce.SpecularTextureEnabled){if(this._metallicTexture){if(!this._metallicTexture.isReadyOrNotBlocking())return!1}else if(this._reflectivityTexture&&!this._reflectivityTexture.isReadyOrNotBlocking())return!1;if(this._metallicReflectanceTexture&&!this._metallicReflectanceTexture.isReadyOrNotBlocking()||this._reflectanceTexture&&!this._reflectanceTexture.isReadyOrNotBlocking()||this._microSurfaceTexture&&!this._microSurfaceTexture.isReadyOrNotBlocking())return!1}if(n.getCaps().standardDerivatives&&this._bumpTexture&&ce.BumpTextureEnabled&&!this._disableBumpMap&&!this._bumpTexture.isReady()||this._environmentBRDFTexture&&ce.ReflectionTextureEnabled&&!this._environmentBRDFTexture.isReady())return!1}if(this._eventInfo.isReadyForSubMesh=!0,this._eventInfo.defines=s,this._callbackPluginEventIsReadyForSubMesh(this._eventInfo),!this._eventInfo.isReadyForSubMesh||s._areImageProcessingDirty&&this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady())return!1;!n.getCaps().standardDerivatives&&!e.isVerticesDataPresent(y.NormalKind)&&(e.createNormals(!0),B.Warn("PBRMaterial: Normals have been created for the mesh: "+e.name));const o=t.effect,l=s._areLightsDisposed;let h=this._prepareEffect(e,s,this.onCompiled,this.onError,i,null,t.getRenderingMesh().hasThinInstances);if(h)if(this._onEffectCreatedObservable&&(so.effect=h,so.subMesh=t,this._onEffectCreatedObservable.notifyObservers(so)),this.allowShaderHotSwapping&&o&&!h.isReady()){if(h=o,s.markAsUnprocessed(),l)return s._areLightsDisposed=!0,!1}else r.resetCachedMaterial(),t.setEffect(h,s,this._materialContext);return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,r.performancePriority!==Qs.BackwardCompatible&&(this.checkReadyOnlyOnce=!0),!0)}isMetallicWorkflow(){return!!(this._metallic!=null||this._roughness!=null||this._metallicTexture)}_prepareEffect(e,t,i=null,s=null,r=null,n=null,o){if(this._prepareDefines(e,t,r,n,o),!t.isDirty)return null;t.markAsProcessed();const h=this.getScene().getEngine(),c=new Wa;let u=0;t.USESPHERICALINVERTEX&&c.addFallback(u++,"USESPHERICALINVERTEX"),t.FOG&&c.addFallback(u,"FOG"),t.SPECULARAA&&c.addFallback(u,"SPECULARAA"),t.POINTSIZE&&c.addFallback(u,"POINTSIZE"),t.LOGARITHMICDEPTH&&c.addFallback(u,"LOGARITHMICDEPTH"),t.PARALLAX&&c.addFallback(u,"PARALLAX"),t.PARALLAXOCCLUSION&&c.addFallback(u++,"PARALLAXOCCLUSION"),t.ENVIRONMENTBRDF&&c.addFallback(u++,"ENVIRONMENTBRDF"),t.TANGENT&&c.addFallback(u++,"TANGENT"),t.BUMP&&c.addFallback(u++,"BUMP"),u=se.HandleFallbacksForShadows(t,c,this._maxSimultaneousLights,u++),t.SPECULARTERM&&c.addFallback(u++,"SPECULARTERM"),t.USESPHERICALFROMREFLECTIONMAP&&c.addFallback(u++,"USESPHERICALFROMREFLECTIONMAP"),t.USEIRRADIANCEMAP&&c.addFallback(u++,"USEIRRADIANCEMAP"),t.LIGHTMAP&&c.addFallback(u++,"LIGHTMAP"),t.NORMAL&&c.addFallback(u++,"NORMAL"),t.AMBIENT&&c.addFallback(u++,"AMBIENT"),t.EMISSIVE&&c.addFallback(u++,"EMISSIVE"),t.VERTEXCOLOR&&c.addFallback(u++,"VERTEXCOLOR"),t.MORPHTARGETS&&c.addFallback(u++,"MORPHTARGETS"),t.MULTIVIEW&&c.addFallback(0,"MULTIVIEW");const d=[y.PositionKind];t.NORMAL&&d.push(y.NormalKind),t.TANGENT&&d.push(y.TangentKind);for(let b=1;b<=6;++b)t["UV"+b]&&d.push(`uv${b===1?"":b}`);t.VERTEXCOLOR&&d.push(y.ColorKind),t.INSTANCESCOLOR&&d.push(y.ColorInstanceKind),se.PrepareAttributesForBones(d,e,t,c),se.PrepareAttributesForInstances(d,t),se.PrepareAttributesForMorphTargets(d,e,t),se.PrepareAttributesForBakedVertexAnimation(d,e,t);let f="pbr";const p=["world","view","viewProjection","vEyePosition","vLightsType","vAmbientColor","vAlbedoColor","vReflectivityColor","vMetallicReflectanceFactors","vEmissiveColor","visibility","vReflectionColor","vFogInfos","vFogColor","pointSize","vAlbedoInfos","vAmbientInfos","vOpacityInfos","vReflectionInfos","vReflectionPosition","vReflectionSize","vEmissiveInfos","vReflectivityInfos","vReflectionFilteringInfo","vMetallicReflectanceInfos","vReflectanceInfos","vMicroSurfaceSamplerInfos","vBumpInfos","vLightmapInfos","mBones","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","albedoMatrix","ambientMatrix","opacityMatrix","reflectionMatrix","emissiveMatrix","reflectivityMatrix","normalMatrix","microSurfaceSamplerMatrix","bumpMatrix","lightmapMatrix","metallicReflectanceMatrix","reflectanceMatrix","vLightingIntensity","logarithmicDepthConstant","vSphericalX","vSphericalY","vSphericalZ","vSphericalXX_ZZ","vSphericalYY_ZZ","vSphericalZZ","vSphericalXY","vSphericalYZ","vSphericalZX","vSphericalL00","vSphericalL1_1","vSphericalL10","vSphericalL11","vSphericalL2_2","vSphericalL2_1","vSphericalL20","vSphericalL21","vSphericalL22","vReflectionMicrosurfaceInfos","vTangentSpaceParams","boneTextureWidth","vDebugMode","morphTargetTextureInfo","morphTargetTextureIndices"],_=["albedoSampler","reflectivitySampler","ambientSampler","emissiveSampler","bumpSampler","lightmapSampler","opacitySampler","reflectionSampler","reflectionSamplerLow","reflectionSamplerHigh","irradianceSampler","microSurfaceSampler","environmentBrdfSampler","boneSampler","metallicReflectanceSampler","reflectanceSampler","morphTargets","oitDepthSampler","oitFrontColorSampler"],m=["Material","Scene","Mesh"];this._eventInfo.fallbacks=c,this._eventInfo.fallbackRank=u,this._eventInfo.defines=t,this._eventInfo.uniforms=p,this._eventInfo.attributes=d,this._eventInfo.samplers=_,this._eventInfo.uniformBuffersNames=m,this._eventInfo.customCode=void 0,this._eventInfo.mesh=e,this._callbackPluginEventGeneric(Wi.PrepareEffect,this._eventInfo),Zh.AddUniforms(p),qe&&(qe.PrepareUniforms(p,t),qe.PrepareSamplers(_,t)),se.PrepareUniformsAndSamplersList({uniformsNames:p,uniformBuffersNames:m,samplers:_,defines:t,maxSimultaneousLights:this._maxSimultaneousLights});const v={};this.customShaderNameResolve&&(f=this.customShaderNameResolve(f,p,m,_,t,d,v));const x=t.toString();return h.createEffect(f,{attributes:d,uniformsNames:p,uniformBuffersNames:m,samplers:_,defines:x,fallbacks:c,onCompiled:i,onError:s,indexParameters:{maxSimultaneousLights:this._maxSimultaneousLights,maxSimultaneousMorphTargets:t.NUM_MORPH_INFLUENCERS},processFinalCode:v.processFinalCode,processCodeAfterIncludes:this._eventInfo.customCode,multiTarget:t.PREPASS},h)}_prepareDefines(e,t,i=null,s=null,r=!1){var n;const o=this.getScene(),l=o.getEngine();se.PrepareDefinesForLights(o,e,t,!0,this._maxSimultaneousLights,this._disableLighting),t._needNormals=!0,se.PrepareDefinesForMultiview(o,t);const h=this.needAlphaBlendingForMesh(e)&&this.getScene().useOrderIndependentTransparency;if(se.PrepareDefinesForPrePass(o,t,this.canRenderToMRT&&!h),se.PrepareDefinesForOIT(o,t,h),t.METALLICWORKFLOW=this.isMetallicWorkflow(),t._areTexturesDirty){if(t._needUVs=!1,o.texturesEnabled){t.ALBEDODIRECTUV=0,t.AMBIENTDIRECTUV=0,t.OPACITYDIRECTUV=0,t.EMISSIVEDIRECTUV=0,t.REFLECTIVITYDIRECTUV=0,t.MICROSURFACEMAPDIRECTUV=0,t.METALLIC_REFLECTANCEDIRECTUV=0,t.REFLECTANCEDIRECTUV=0,t.BUMPDIRECTUV=0,t.LIGHTMAPDIRECTUV=0,l.getCaps().textureLOD&&(t.LODBASEDMICROSFURACE=!0),this._albedoTexture&&ce.DiffuseTextureEnabled?(se.PrepareDefinesForMergedUV(this._albedoTexture,t,"ALBEDO"),t.GAMMAALBEDO=this._albedoTexture.gammaSpace):t.ALBEDO=!1,this._ambientTexture&&ce.AmbientTextureEnabled?(se.PrepareDefinesForMergedUV(this._ambientTexture,t,"AMBIENT"),t.AMBIENTINGRAYSCALE=this._useAmbientInGrayScale):t.AMBIENT=!1,this._opacityTexture&&ce.OpacityTextureEnabled?(se.PrepareDefinesForMergedUV(this._opacityTexture,t,"OPACITY"),t.OPACITYRGB=this._opacityTexture.getAlphaFromRGB):t.OPACITY=!1;const c=this._getReflectionTexture();if(c&&ce.ReflectionTextureEnabled){switch(t.REFLECTION=!0,t.GAMMAREFLECTION=c.gammaSpace,t.RGBDREFLECTION=c.isRGBD,t.LODINREFLECTIONALPHA=c.lodLevelInAlpha,t.LINEARSPECULARREFLECTION=c.linearSpecularLOD,this.realTimeFiltering&&this.realTimeFilteringQuality>0?(t.NUM_SAMPLES=""+this.realTimeFilteringQuality,l._features.needTypeSuffixInShaderConstants&&(t.NUM_SAMPLES=t.NUM_SAMPLES+"u"),t.REALTIME_FILTERING=!0):t.REALTIME_FILTERING=!1,c.coordinatesMode===H.INVCUBIC_MODE&&(t.INVERTCUBICMAP=!0),t.REFLECTIONMAP_3D=c.isCube,t.REFLECTIONMAP_OPPOSITEZ=t.REFLECTIONMAP_3D&&this.getScene().useRightHandedSystem?!c.invertZ:c.invertZ,t.REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,c.coordinatesMode){case H.EXPLICIT_MODE:t.REFLECTIONMAP_EXPLICIT=!0;break;case H.PLANAR_MODE:t.REFLECTIONMAP_PLANAR=!0;break;case H.PROJECTION_MODE:t.REFLECTIONMAP_PROJECTION=!0;break;case H.SKYBOX_MODE:t.REFLECTIONMAP_SKYBOX=!0;break;case H.SPHERICAL_MODE:t.REFLECTIONMAP_SPHERICAL=!0;break;case H.EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR=!0;break;case H.FIXED_EQUIRECTANGULAR_MODE:t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!0;break;case H.FIXED_EQUIRECTANGULAR_MIRRORED_MODE:t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!0;break;case H.CUBIC_MODE:case H.INVCUBIC_MODE:default:t.REFLECTIONMAP_CUBIC=!0,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!!c.boundingBoxSize;break}c.coordinatesMode!==H.SKYBOX_MODE&&(c.irradianceTexture?(t.USEIRRADIANCEMAP=!0,t.USESPHERICALFROMREFLECTIONMAP=!1):c.isCube&&(t.USESPHERICALFROMREFLECTIONMAP=!0,t.USEIRRADIANCEMAP=!1,this._forceIrradianceInFragment||this.realTimeFiltering||l.getCaps().maxVaryingVectors<=8?t.USESPHERICALINVERTEX=!1:t.USESPHERICALINVERTEX=!0))}else t.REFLECTION=!1,t.REFLECTIONMAP_3D=!1,t.REFLECTIONMAP_SPHERICAL=!1,t.REFLECTIONMAP_PLANAR=!1,t.REFLECTIONMAP_CUBIC=!1,t.USE_LOCAL_REFLECTIONMAP_CUBIC=!1,t.REFLECTIONMAP_PROJECTION=!1,t.REFLECTIONMAP_SKYBOX=!1,t.REFLECTIONMAP_EXPLICIT=!1,t.REFLECTIONMAP_EQUIRECTANGULAR=!1,t.REFLECTIONMAP_EQUIRECTANGULAR_FIXED=!1,t.REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED=!1,t.INVERTCUBICMAP=!1,t.USESPHERICALFROMREFLECTIONMAP=!1,t.USEIRRADIANCEMAP=!1,t.USESPHERICALINVERTEX=!1,t.REFLECTIONMAP_OPPOSITEZ=!1,t.LODINREFLECTIONALPHA=!1,t.GAMMAREFLECTION=!1,t.RGBDREFLECTION=!1,t.LINEARSPECULARREFLECTION=!1;if(this._lightmapTexture&&ce.LightmapTextureEnabled?(se.PrepareDefinesForMergedUV(this._lightmapTexture,t,"LIGHTMAP"),t.USELIGHTMAPASSHADOWMAP=this._useLightmapAsShadowmap,t.GAMMALIGHTMAP=this._lightmapTexture.gammaSpace,t.RGBDLIGHTMAP=this._lightmapTexture.isRGBD):t.LIGHTMAP=!1,this._emissiveTexture&&ce.EmissiveTextureEnabled?(se.PrepareDefinesForMergedUV(this._emissiveTexture,t,"EMISSIVE"),t.GAMMAEMISSIVE=this._emissiveTexture.gammaSpace):t.EMISSIVE=!1,ce.SpecularTextureEnabled){if(this._metallicTexture?(se.PrepareDefinesForMergedUV(this._metallicTexture,t,"REFLECTIVITY"),t.ROUGHNESSSTOREINMETALMAPALPHA=this._useRoughnessFromMetallicTextureAlpha,t.ROUGHNESSSTOREINMETALMAPGREEN=!this._useRoughnessFromMetallicTextureAlpha&&this._useRoughnessFromMetallicTextureGreen,t.METALLNESSSTOREINMETALMAPBLUE=this._useMetallnessFromMetallicTextureBlue,t.AOSTOREINMETALMAPRED=this._useAmbientOcclusionFromMetallicTextureRed,t.REFLECTIVITY_GAMMA=!1):this._reflectivityTexture?(se.PrepareDefinesForMergedUV(this._reflectivityTexture,t,"REFLECTIVITY"),t.MICROSURFACEFROMREFLECTIVITYMAP=this._useMicroSurfaceFromReflectivityMapAlpha,t.MICROSURFACEAUTOMATIC=this._useAutoMicroSurfaceFromReflectivityMap,t.REFLECTIVITY_GAMMA=this._reflectivityTexture.gammaSpace):t.REFLECTIVITY=!1,this._metallicReflectanceTexture||this._reflectanceTexture){const u=this._metallicReflectanceTexture!==null&&this._metallicReflectanceTexture._texture===((n=this._reflectanceTexture)===null||n===void 0?void 0:n._texture)&&this._metallicReflectanceTexture.checkTransformsAreIdentical(this._reflectanceTexture);t.METALLIC_REFLECTANCE_USE_ALPHA_ONLY=this._useOnlyMetallicFromMetallicReflectanceTexture&&!u,this._metallicReflectanceTexture?(se.PrepareDefinesForMergedUV(this._metallicReflectanceTexture,t,"METALLIC_REFLECTANCE"),t.METALLIC_REFLECTANCE_GAMMA=this._metallicReflectanceTexture.gammaSpace):t.METALLIC_REFLECTANCE=!1,this._reflectanceTexture&&!u&&(!this._metallicReflectanceTexture||this._metallicReflectanceTexture&&this._useOnlyMetallicFromMetallicReflectanceTexture)?(se.PrepareDefinesForMergedUV(this._reflectanceTexture,t,"REFLECTANCE"),t.REFLECTANCE_GAMMA=this._reflectanceTexture.gammaSpace):t.REFLECTANCE=!1}else t.METALLIC_REFLECTANCE=!1,t.REFLECTANCE=!1;this._microSurfaceTexture?se.PrepareDefinesForMergedUV(this._microSurfaceTexture,t,"MICROSURFACEMAP"):t.MICROSURFACEMAP=!1}else t.REFLECTIVITY=!1,t.MICROSURFACEMAP=!1;l.getCaps().standardDerivatives&&this._bumpTexture&&ce.BumpTextureEnabled&&!this._disableBumpMap?(se.PrepareDefinesForMergedUV(this._bumpTexture,t,"BUMP"),this._useParallax&&this._albedoTexture&&ce.DiffuseTextureEnabled?(t.PARALLAX=!0,t.PARALLAXOCCLUSION=!!this._useParallaxOcclusion):t.PARALLAX=!1,t.OBJECTSPACE_NORMALMAP=this._useObjectSpaceNormalMap):(t.BUMP=!1,t.PARALLAX=!1,t.PARALLAXOCCLUSION=!1,t.PARALLAOBJECTSPACE_NORMALMAP=!1),this._environmentBRDFTexture&&ce.ReflectionTextureEnabled?(t.ENVIRONMENTBRDF=!0,t.ENVIRONMENTBRDF_RGBD=this._environmentBRDFTexture.isRGBD):(t.ENVIRONMENTBRDF=!1,t.ENVIRONMENTBRDF_RGBD=!1),this._shouldUseAlphaFromAlbedoTexture()?t.ALPHAFROMALBEDO=!0:t.ALPHAFROMALBEDO=!1}t.SPECULAROVERALPHA=this._useSpecularOverAlpha,this._lightFalloff===vt.LIGHTFALLOFF_STANDARD?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!1):this._lightFalloff===vt.LIGHTFALLOFF_GLTF?(t.USEPHYSICALLIGHTFALLOFF=!1,t.USEGLTFLIGHTFALLOFF=!0):(t.USEPHYSICALLIGHTFALLOFF=!0,t.USEGLTFLIGHTFALLOFF=!1),t.RADIANCEOVERALPHA=this._useRadianceOverAlpha,!this.backFaceCulling&&this._twoSidedLighting?t.TWOSIDEDLIGHTING=!0:t.TWOSIDEDLIGHTING=!1,t.SPECULARAA=l.getCaps().standardDerivatives&&this._enableSpecularAntiAliasing}(t._areTexturesDirty||t._areMiscDirty)&&(t.ALPHATESTVALUE=`${this._alphaCutOff}${this._alphaCutOff%1===0?".":""}`,t.PREMULTIPLYALPHA=this.alphaMode===7||this.alphaMode===8,t.ALPHABLEND=this.needAlphaBlendingForMesh(e),t.ALPHAFRESNEL=this._useAlphaFresnel||this._useLinearAlphaFresnel,t.LINEARALPHAFRESNEL=this._useLinearAlphaFresnel),t._areImageProcessingDirty&&this._imageProcessingConfiguration&&this._imageProcessingConfiguration.prepareDefines(t),t.FORCENORMALFORWARD=this._forceNormalForward,t.RADIANCEOCCLUSION=this._useRadianceOcclusion,t.HORIZONOCCLUSION=this._useHorizonOcclusion,t._areMiscDirty&&(se.PrepareDefinesForMisc(e,o,this._useLogarithmicDepth,this.pointsCloud,this.fogEnabled,this._shouldTurnAlphaTestOn(e)||this._forceAlphaTest,t),t.UNLIT=this._unlit||(this.pointsCloud||this.wireframe)&&!e.isVerticesDataPresent(y.NormalKind),t.DEBUGMODE=this._debugMode),se.PrepareDefinesForFrameBoundValues(o,l,t,!!i,s,r),this._eventInfo.defines=t,this._eventInfo.mesh=e,this._callbackPluginEventPrepareDefinesBeforeAttributes(this._eventInfo),se.PrepareDefinesForAttributes(e,t,!0,!0,!0,this._transparencyMode!==vt.PBRMATERIAL_OPAQUE),this._callbackPluginEventPrepareDefines(this._eventInfo)}forceCompilation(e,t,i){const s={clipPlane:!1,useInstances:!1,...i};this._uniformBufferLayoutBuilt||this.buildUniformLayout(),this._callbackPluginEventGeneric(Wi.GetDefineNames,this._eventInfo);const r=new Bf(this._eventInfo.defineNames),n=this._prepareEffect(e,r,void 0,void 0,s.useInstances,s.clipPlane,e.hasThinInstances);this._onEffectCreatedObservable&&(so.effect=n,so.subMesh=null,this._onEffectCreatedObservable.notifyObservers(so)),n.isReady()?t&&t(this):n.onCompileObservable.add(()=>{t&&t(this)})}buildUniformLayout(){const e=this._uniformBuffer;e.addUniform("vAlbedoInfos",2),e.addUniform("vAmbientInfos",4),e.addUniform("vOpacityInfos",2),e.addUniform("vEmissiveInfos",2),e.addUniform("vLightmapInfos",2),e.addUniform("vReflectivityInfos",3),e.addUniform("vMicroSurfaceSamplerInfos",2),e.addUniform("vReflectionInfos",2),e.addUniform("vReflectionFilteringInfo",2),e.addUniform("vReflectionPosition",3),e.addUniform("vReflectionSize",3),e.addUniform("vBumpInfos",3),e.addUniform("albedoMatrix",16),e.addUniform("ambientMatrix",16),e.addUniform("opacityMatrix",16),e.addUniform("emissiveMatrix",16),e.addUniform("lightmapMatrix",16),e.addUniform("reflectivityMatrix",16),e.addUniform("microSurfaceSamplerMatrix",16),e.addUniform("bumpMatrix",16),e.addUniform("vTangentSpaceParams",2),e.addUniform("reflectionMatrix",16),e.addUniform("vReflectionColor",3),e.addUniform("vAlbedoColor",4),e.addUniform("vLightingIntensity",4),e.addUniform("vReflectionMicrosurfaceInfos",3),e.addUniform("pointSize",1),e.addUniform("vReflectivityColor",4),e.addUniform("vEmissiveColor",3),e.addUniform("vAmbientColor",3),e.addUniform("vDebugMode",2),e.addUniform("vMetallicReflectanceFactors",4),e.addUniform("vMetallicReflectanceInfos",2),e.addUniform("metallicReflectanceMatrix",16),e.addUniform("vReflectanceInfos",2),e.addUniform("reflectanceMatrix",16),e.addUniform("vSphericalL00",3),e.addUniform("vSphericalL1_1",3),e.addUniform("vSphericalL10",3),e.addUniform("vSphericalL11",3),e.addUniform("vSphericalL2_2",3),e.addUniform("vSphericalL2_1",3),e.addUniform("vSphericalL20",3),e.addUniform("vSphericalL21",3),e.addUniform("vSphericalL22",3),e.addUniform("vSphericalX",3),e.addUniform("vSphericalY",3),e.addUniform("vSphericalZ",3),e.addUniform("vSphericalXX_ZZ",3),e.addUniform("vSphericalYY_ZZ",3),e.addUniform("vSphericalZZ",3),e.addUniform("vSphericalXY",3),e.addUniform("vSphericalYZ",3),e.addUniform("vSphericalZX",3),super.buildUniformLayout()}bindForSubMesh(e,t,i){var s,r,n,o;const l=this.getScene(),h=i.materialDefines;if(!h)return;const c=i.effect;if(!c)return;this._activeEffect=c,t.getMeshUniformBuffer().bindToEffect(c,"Mesh"),t.transferToEffect(e);const u=l.getEngine();this._uniformBuffer.bindToEffect(c,"Material"),this.prePassConfiguration.bindForSubMesh(this._activeEffect,l,t,e,this.isFrozen),this._eventInfo.subMesh=i,this._callbackPluginEventHardBindForSubMesh(this._eventInfo),h.OBJECTSPACE_NORMALMAP&&(e.toNormalMatrix(this._normalMatrix),this.bindOnlyNormalMatrix(this._normalMatrix));const d=this._mustRebind(l,c,t.visibility);se.BindBonesParameters(t,this._activeEffect,this.prePassConfiguration);let f=null;const p=this._uniformBuffer;if(d){if(this.bindViewProjection(c),f=this._getReflectionTexture(),!p.useUbo||!this.isFrozen||!p.isSync){if(l.texturesEnabled){if(this._albedoTexture&&ce.DiffuseTextureEnabled&&(p.updateFloat2("vAlbedoInfos",this._albedoTexture.coordinatesIndex,this._albedoTexture.level),se.BindTextureMatrix(this._albedoTexture,p,"albedo")),this._ambientTexture&&ce.AmbientTextureEnabled&&(p.updateFloat4("vAmbientInfos",this._ambientTexture.coordinatesIndex,this._ambientTexture.level,this._ambientTextureStrength,this._ambientTextureImpactOnAnalyticalLights),se.BindTextureMatrix(this._ambientTexture,p,"ambient")),this._opacityTexture&&ce.OpacityTextureEnabled&&(p.updateFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),se.BindTextureMatrix(this._opacityTexture,p,"opacity")),f&&ce.ReflectionTextureEnabled){if(p.updateMatrix("reflectionMatrix",f.getReflectionTextureMatrix()),p.updateFloat2("vReflectionInfos",f.level,0),f.boundingBoxSize){const _=f;p.updateVector3("vReflectionPosition",_.boundingBoxPosition),p.updateVector3("vReflectionSize",_.boundingBoxSize)}if(this.realTimeFiltering){const _=f.getSize().width;p.updateFloat2("vReflectionFilteringInfo",_,oe.Log2(_))}if(!h.USEIRRADIANCEMAP){const _=f.sphericalPolynomial;if(h.USESPHERICALFROMREFLECTIONMAP&&_)if(h.SPHERICAL_HARMONICS){const m=_.preScaledHarmonics;p.updateVector3("vSphericalL00",m.l00),p.updateVector3("vSphericalL1_1",m.l1_1),p.updateVector3("vSphericalL10",m.l10),p.updateVector3("vSphericalL11",m.l11),p.updateVector3("vSphericalL2_2",m.l2_2),p.updateVector3("vSphericalL2_1",m.l2_1),p.updateVector3("vSphericalL20",m.l20),p.updateVector3("vSphericalL21",m.l21),p.updateVector3("vSphericalL22",m.l22)}else p.updateFloat3("vSphericalX",_.x.x,_.x.y,_.x.z),p.updateFloat3("vSphericalY",_.y.x,_.y.y,_.y.z),p.updateFloat3("vSphericalZ",_.z.x,_.z.y,_.z.z),p.updateFloat3("vSphericalXX_ZZ",_.xx.x-_.zz.x,_.xx.y-_.zz.y,_.xx.z-_.zz.z),p.updateFloat3("vSphericalYY_ZZ",_.yy.x-_.zz.x,_.yy.y-_.zz.y,_.yy.z-_.zz.z),p.updateFloat3("vSphericalZZ",_.zz.x,_.zz.y,_.zz.z),p.updateFloat3("vSphericalXY",_.xy.x,_.xy.y,_.xy.z),p.updateFloat3("vSphericalYZ",_.yz.x,_.yz.y,_.yz.z),p.updateFloat3("vSphericalZX",_.zx.x,_.zx.y,_.zx.z)}p.updateFloat3("vReflectionMicrosurfaceInfos",f.getSize().width,f.lodGenerationScale,f.lodGenerationOffset)}this._emissiveTexture&&ce.EmissiveTextureEnabled&&(p.updateFloat2("vEmissiveInfos",this._emissiveTexture.coordinatesIndex,this._emissiveTexture.level),se.BindTextureMatrix(this._emissiveTexture,p,"emissive")),this._lightmapTexture&&ce.LightmapTextureEnabled&&(p.updateFloat2("vLightmapInfos",this._lightmapTexture.coordinatesIndex,this._lightmapTexture.level),se.BindTextureMatrix(this._lightmapTexture,p,"lightmap")),ce.SpecularTextureEnabled&&(this._metallicTexture?(p.updateFloat3("vReflectivityInfos",this._metallicTexture.coordinatesIndex,this._metallicTexture.level,this._ambientTextureStrength),se.BindTextureMatrix(this._metallicTexture,p,"reflectivity")):this._reflectivityTexture&&(p.updateFloat3("vReflectivityInfos",this._reflectivityTexture.coordinatesIndex,this._reflectivityTexture.level,1),se.BindTextureMatrix(this._reflectivityTexture,p,"reflectivity")),this._metallicReflectanceTexture&&(p.updateFloat2("vMetallicReflectanceInfos",this._metallicReflectanceTexture.coordinatesIndex,this._metallicReflectanceTexture.level),se.BindTextureMatrix(this._metallicReflectanceTexture,p,"metallicReflectance")),this._reflectanceTexture&&h.REFLECTANCE&&(p.updateFloat2("vReflectanceInfos",this._reflectanceTexture.coordinatesIndex,this._reflectanceTexture.level),se.BindTextureMatrix(this._reflectanceTexture,p,"reflectance")),this._microSurfaceTexture&&(p.updateFloat2("vMicroSurfaceSamplerInfos",this._microSurfaceTexture.coordinatesIndex,this._microSurfaceTexture.level),se.BindTextureMatrix(this._microSurfaceTexture,p,"microSurfaceSampler"))),this._bumpTexture&&u.getCaps().standardDerivatives&&ce.BumpTextureEnabled&&!this._disableBumpMap&&(p.updateFloat3("vBumpInfos",this._bumpTexture.coordinatesIndex,this._bumpTexture.level,this._parallaxScaleBias),se.BindTextureMatrix(this._bumpTexture,p,"bump"),l._mirroredCameraPosition?p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?1:-1,this._invertNormalMapY?1:-1):p.updateFloat2("vTangentSpaceParams",this._invertNormalMapX?-1:1,this._invertNormalMapY?-1:1))}if(this.pointsCloud&&p.updateFloat("pointSize",this.pointSize),h.METALLICWORKFLOW){ht.Color3[0].r=this._metallic===void 0||this._metallic===null?1:this._metallic,ht.Color3[0].g=this._roughness===void 0||this._roughness===null?1:this._roughness,p.updateColor4("vReflectivityColor",ht.Color3[0],1);const _=(r=(s=this.subSurface)===null||s===void 0?void 0:s._indexOfRefraction)!==null&&r!==void 0?r:1.5,m=1,v=Math.pow((_-m)/(_+m),2);this._metallicReflectanceColor.scaleToRef(v*this._metallicF0Factor,ht.Color3[0]);const x=this._metallicF0Factor;p.updateColor4("vMetallicReflectanceFactors",ht.Color3[0],x)}else p.updateColor4("vReflectivityColor",this._reflectivityColor,this._microSurface);p.updateColor3("vEmissiveColor",ce.EmissiveTextureEnabled?this._emissiveColor:re.BlackReadOnly),p.updateColor3("vReflectionColor",this._reflectionColor),!h.SS_REFRACTION&&((n=this.subSurface)===null||n===void 0?void 0:n._linkRefractionWithTransparency)?p.updateColor4("vAlbedoColor",this._albedoColor,1):p.updateColor4("vAlbedoColor",this._albedoColor,this.alpha),this._lightingInfos.x=this._directIntensity,this._lightingInfos.y=this._emissiveIntensity,this._lightingInfos.z=this._environmentIntensity*l.environmentIntensity,this._lightingInfos.w=this._specularIntensity,p.updateVector4("vLightingIntensity",this._lightingInfos),l.ambientColor.multiplyToRef(this._ambientColor,this._globalAmbientColor),p.updateColor3("vAmbientColor",this._globalAmbientColor),p.updateFloat2("vDebugMode",this._debugLimit,this._debugFactor)}l.texturesEnabled&&(this._albedoTexture&&ce.DiffuseTextureEnabled&&p.setTexture("albedoSampler",this._albedoTexture),this._ambientTexture&&ce.AmbientTextureEnabled&&p.setTexture("ambientSampler",this._ambientTexture),this._opacityTexture&&ce.OpacityTextureEnabled&&p.setTexture("opacitySampler",this._opacityTexture),f&&ce.ReflectionTextureEnabled&&(h.LODBASEDMICROSFURACE?p.setTexture("reflectionSampler",f):(p.setTexture("reflectionSampler",f._lodTextureMid||f),p.setTexture("reflectionSamplerLow",f._lodTextureLow||f),p.setTexture("reflectionSamplerHigh",f._lodTextureHigh||f)),h.USEIRRADIANCEMAP&&p.setTexture("irradianceSampler",f.irradianceTexture)),h.ENVIRONMENTBRDF&&p.setTexture("environmentBrdfSampler",this._environmentBRDFTexture),this._emissiveTexture&&ce.EmissiveTextureEnabled&&p.setTexture("emissiveSampler",this._emissiveTexture),this._lightmapTexture&&ce.LightmapTextureEnabled&&p.setTexture("lightmapSampler",this._lightmapTexture),ce.SpecularTextureEnabled&&(this._metallicTexture?p.setTexture("reflectivitySampler",this._metallicTexture):this._reflectivityTexture&&p.setTexture("reflectivitySampler",this._reflectivityTexture),this._metallicReflectanceTexture&&p.setTexture("metallicReflectanceSampler",this._metallicReflectanceTexture),this._reflectanceTexture&&h.REFLECTANCE&&p.setTexture("reflectanceSampler",this._reflectanceTexture),this._microSurfaceTexture&&p.setTexture("microSurfaceSampler",this._microSurfaceTexture)),this._bumpTexture&&u.getCaps().standardDerivatives&&ce.BumpTextureEnabled&&!this._disableBumpMap&&p.setTexture("bumpSampler",this._bumpTexture)),this.getScene().useOrderIndependentTransparency&&this.needAlphaBlendingForMesh(t)&&this.getScene().depthPeelingRenderer.bind(c),this._eventInfo.subMesh=i,this._callbackPluginEventBindForSubMesh(this._eventInfo),se.BindClipPlane(this._activeEffect,l),this.bindEyePosition(c)}else l.getEngine()._features.needToAlwaysBindUniformBuffers&&(this._needToBindSceneUbo=!0);(d||!this.isFrozen)&&(l.lightsEnabled&&!this._disableLighting&&se.BindLights(l,t,this._activeEffect,h,this._maxSimultaneousLights),(l.fogEnabled&&t.applyFog&&l.fogMode!==ge.FOGMODE_NONE||f||t.receiveShadows||h.PREPASS)&&this.bindView(c),se.BindFogParameters(l,t,this._activeEffect,!0),h.NUM_MORPH_INFLUENCERS&&se.BindMorphTargetParameters(t,this._activeEffect),h.BAKED_VERTEX_ANIMATION_TEXTURE&&((o=t.bakedVertexAnimationManager)===null||o===void 0||o.bind(c,h.INSTANCES)),this._imageProcessingConfiguration.bind(this._activeEffect),se.BindLogDepth(h,this._activeEffect,l)),this._afterBind(t,this._activeEffect),p.update()}getAnimatables(){const e=super.getAnimatables();return this._albedoTexture&&this._albedoTexture.animations&&this._albedoTexture.animations.length>0&&e.push(this._albedoTexture),this._ambientTexture&&this._ambientTexture.animations&&this._ambientTexture.animations.length>0&&e.push(this._ambientTexture),this._opacityTexture&&this._opacityTexture.animations&&this._opacityTexture.animations.length>0&&e.push(this._opacityTexture),this._reflectionTexture&&this._reflectionTexture.animations&&this._reflectionTexture.animations.length>0&&e.push(this._reflectionTexture),this._emissiveTexture&&this._emissiveTexture.animations&&this._emissiveTexture.animations.length>0&&e.push(this._emissiveTexture),this._metallicTexture&&this._metallicTexture.animations&&this._metallicTexture.animations.length>0?e.push(this._metallicTexture):this._reflectivityTexture&&this._reflectivityTexture.animations&&this._reflectivityTexture.animations.length>0&&e.push(this._reflectivityTexture),this._bumpTexture&&this._bumpTexture.animations&&this._bumpTexture.animations.length>0&&e.push(this._bumpTexture),this._lightmapTexture&&this._lightmapTexture.animations&&this._lightmapTexture.animations.length>0&&e.push(this._lightmapTexture),e}_getReflectionTexture(){return this._reflectionTexture?this._reflectionTexture:this.getScene().environmentTexture}getActiveTextures(){const e=super.getActiveTextures();return this._albedoTexture&&e.push(this._albedoTexture),this._ambientTexture&&e.push(this._ambientTexture),this._opacityTexture&&e.push(this._opacityTexture),this._reflectionTexture&&e.push(this._reflectionTexture),this._emissiveTexture&&e.push(this._emissiveTexture),this._reflectivityTexture&&e.push(this._reflectivityTexture),this._metallicTexture&&e.push(this._metallicTexture),this._metallicReflectanceTexture&&e.push(this._metallicReflectanceTexture),this._reflectanceTexture&&e.push(this._reflectanceTexture),this._microSurfaceTexture&&e.push(this._microSurfaceTexture),this._bumpTexture&&e.push(this._bumpTexture),this._lightmapTexture&&e.push(this._lightmapTexture),e}hasTexture(e){return!!(super.hasTexture(e)||this._albedoTexture===e||this._ambientTexture===e||this._opacityTexture===e||this._reflectionTexture===e||this._reflectivityTexture===e||this._metallicTexture===e||this._metallicReflectanceTexture===e||this._reflectanceTexture===e||this._microSurfaceTexture===e||this._bumpTexture===e||this._lightmapTexture===e)}setPrePassRenderer(){var e;if(!((e=this.subSurface)===null||e===void 0)&&e.isScatteringEnabled){const t=this.getScene().enableSubSurfaceForPrePass();return t&&(t.enabled=!0),!0}return!1}dispose(e,t){var i,s,r,n,o,l,h,c,u,d,f,p;t&&(this._environmentBRDFTexture&&this.getScene().environmentBRDFTexture!==this._environmentBRDFTexture&&this._environmentBRDFTexture.dispose(),(i=this._albedoTexture)===null||i===void 0||i.dispose(),(s=this._ambientTexture)===null||s===void 0||s.dispose(),(r=this._opacityTexture)===null||r===void 0||r.dispose(),(n=this._reflectionTexture)===null||n===void 0||n.dispose(),(o=this._emissiveTexture)===null||o===void 0||o.dispose(),(l=this._metallicTexture)===null||l===void 0||l.dispose(),(h=this._reflectivityTexture)===null||h===void 0||h.dispose(),(c=this._bumpTexture)===null||c===void 0||c.dispose(),(u=this._lightmapTexture)===null||u===void 0||u.dispose(),(d=this._metallicReflectanceTexture)===null||d===void 0||d.dispose(),(f=this._reflectanceTexture)===null||f===void 0||f.dispose(),(p=this._microSurfaceTexture)===null||p===void 0||p.dispose()),this._renderTargets.dispose(),this._imageProcessingConfiguration&&this._imageProcessingObserver&&this._imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingObserver),super.dispose(e,t)}}vt.PBRMATERIAL_OPAQUE=ne.MATERIAL_OPAQUE;vt.PBRMATERIAL_ALPHATEST=ne.MATERIAL_ALPHATEST;vt.PBRMATERIAL_ALPHABLEND=ne.MATERIAL_ALPHABLEND;vt.PBRMATERIAL_ALPHATESTANDBLEND=ne.MATERIAL_ALPHATESTANDBLEND;vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=0;vt.LIGHTFALLOFF_PHYSICAL=0;vt.LIGHTFALLOFF_GLTF=1;vt.LIGHTFALLOFF_STANDARD=2;T([d_()],vt.prototype,"_imageProcessingConfiguration",void 0);T([ie("_markAllSubMeshesAsMiscDirty")],vt.prototype,"debugMode",void 0);T([R()],vt.prototype,"useLogarithmicDepth",null);class Ue extends vt{constructor(e,t){super(e,t),this.directIntensity=1,this.emissiveIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.disableBumpMap=!1,this.ambientTextureStrength=1,this.ambientTextureImpactOnAnalyticalLights=Ue.DEFAULT_AO_ON_ANALYTICAL_LIGHTS,this.metallicF0Factor=1,this.metallicReflectanceColor=re.White(),this.useOnlyMetallicFromMetallicReflectanceTexture=!1,this.ambientColor=new re(0,0,0),this.albedoColor=new re(1,1,1),this.reflectivityColor=new re(1,1,1),this.reflectionColor=new re(1,1,1),this.emissiveColor=new re(0,0,0),this.microSurface=1,this.useLightmapAsShadowmap=!1,this.useAlphaFromAlbedoTexture=!1,this.forceAlphaTest=!1,this.alphaCutOff=.4,this.useSpecularOverAlpha=!0,this.useMicroSurfaceFromReflectivityMapAlpha=!1,this.useRoughnessFromMetallicTextureAlpha=!0,this.useRoughnessFromMetallicTextureGreen=!1,this.useMetallnessFromMetallicTextureBlue=!1,this.useAmbientOcclusionFromMetallicTextureRed=!1,this.useAmbientInGrayScale=!1,this.useAutoMicroSurfaceFromReflectivityMap=!1,this.useRadianceOverAlpha=!0,this.useObjectSpaceNormalMap=!1,this.useParallax=!1,this.useParallaxOcclusion=!1,this.parallaxScaleBias=.05,this.disableLighting=!1,this.forceIrradianceInFragment=!1,this.maxSimultaneousLights=4,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.twoSidedLighting=!1,this.useAlphaFresnel=!1,this.useLinearAlphaFresnel=!1,this.environmentBRDFTexture=null,this.forceNormalForward=!1,this.enableSpecularAntiAliasing=!1,this.useHorizonOcclusion=!0,this.useRadianceOcclusion=!0,this.unlit=!1,this._environmentBRDFTexture=r0(this.getScene())}get refractionTexture(){return this.subSurface.refractionTexture}set refractionTexture(e){this.subSurface.refractionTexture=e,e?this.subSurface.isRefractionEnabled=!0:this.subSurface.linkRefractionWithTransparency||(this.subSurface.isRefractionEnabled=!1)}get indexOfRefraction(){return this.subSurface.indexOfRefraction}set indexOfRefraction(e){this.subSurface.indexOfRefraction=e}get invertRefractionY(){return this.subSurface.invertRefractionY}set invertRefractionY(e){this.subSurface.invertRefractionY=e}get linkRefractionWithTransparency(){return this.subSurface.linkRefractionWithTransparency}set linkRefractionWithTransparency(e){this.subSurface.linkRefractionWithTransparency=e,e&&(this.subSurface.isRefractionEnabled=!0)}get usePhysicalLightFalloff(){return this._lightFalloff===vt.LIGHTFALLOFF_PHYSICAL}set usePhysicalLightFalloff(e){e!==this.usePhysicalLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=vt.LIGHTFALLOFF_PHYSICAL:this._lightFalloff=vt.LIGHTFALLOFF_STANDARD)}get useGLTFLightFalloff(){return this._lightFalloff===vt.LIGHTFALLOFF_GLTF}set useGLTFLightFalloff(e){e!==this.useGLTFLightFalloff&&(this._markAllSubMeshesAsTexturesDirty(),e?this._lightFalloff=vt.LIGHTFALLOFF_GLTF:this._lightFalloff=vt.LIGHTFALLOFF_STANDARD)}get imageProcessingConfiguration(){return this._imageProcessingConfiguration}set imageProcessingConfiguration(e){this._attachImageProcessingConfiguration(e),this._markAllSubMeshesAsTexturesDirty()}get cameraColorCurvesEnabled(){return this.imageProcessingConfiguration.colorCurvesEnabled}set cameraColorCurvesEnabled(e){this.imageProcessingConfiguration.colorCurvesEnabled=e}get cameraColorGradingEnabled(){return this.imageProcessingConfiguration.colorGradingEnabled}set cameraColorGradingEnabled(e){this.imageProcessingConfiguration.colorGradingEnabled=e}get cameraToneMappingEnabled(){return this._imageProcessingConfiguration.toneMappingEnabled}set cameraToneMappingEnabled(e){this._imageProcessingConfiguration.toneMappingEnabled=e}get cameraExposure(){return this._imageProcessingConfiguration.exposure}set cameraExposure(e){this._imageProcessingConfiguration.exposure=e}get cameraContrast(){return this._imageProcessingConfiguration.contrast}set cameraContrast(e){this._imageProcessingConfiguration.contrast=e}get cameraColorGradingTexture(){return this._imageProcessingConfiguration.colorGradingTexture}set cameraColorGradingTexture(e){this._imageProcessingConfiguration.colorGradingTexture=e}get cameraColorCurves(){return this._imageProcessingConfiguration.colorCurves}set cameraColorCurves(e){this._imageProcessingConfiguration.colorCurves=e}getClassName(){return"PBRMaterial"}clone(e){const t=xe.Clone(()=>new Ue(e,this.getScene()),this);return t.id=e,t.name=e,this.stencil.copyTo(t.stencil),this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=super.serialize();return e.customType="BABYLON.PBRMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=xe.Parse(()=>new Ue(e.name,t),e,t,i);return e.stencil&&s.stencil.parse(e.stencil,t,i),e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}Ue.PBRMATERIAL_OPAQUE=vt.PBRMATERIAL_OPAQUE;Ue.PBRMATERIAL_ALPHATEST=vt.PBRMATERIAL_ALPHATEST;Ue.PBRMATERIAL_ALPHABLEND=vt.PBRMATERIAL_ALPHABLEND;Ue.PBRMATERIAL_ALPHATESTANDBLEND=vt.PBRMATERIAL_ALPHATESTANDBLEND;Ue.DEFAULT_AO_ON_ANALYTICAL_LIGHTS=vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS;T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"directIntensity",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"emissiveIntensity",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"environmentIntensity",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"specularIntensity",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"disableBumpMap",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"albedoTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"ambientTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"ambientTextureStrength",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"ambientTextureImpactOnAnalyticalLights",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"opacityTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"reflectionTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"emissiveTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"reflectivityTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"metallicTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"metallic",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"roughness",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"metallicF0Factor",void 0);T([pi(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"metallicReflectanceColor",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useOnlyMetallicFromMetallicReflectanceTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"metallicReflectanceTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"reflectanceTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"microSurfaceTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"bumpTexture",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty",null)],Ue.prototype,"lightmapTexture",void 0);T([pi("ambient"),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"ambientColor",void 0);T([pi("albedo"),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"albedoColor",void 0);T([pi("reflectivity"),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"reflectivityColor",void 0);T([pi("reflection"),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"reflectionColor",void 0);T([pi("emissive"),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"emissiveColor",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"microSurface",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useLightmapAsShadowmap",void 0);T([R(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"useAlphaFromAlbedoTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"forceAlphaTest",void 0);T([R(),ie("_markAllSubMeshesAsTexturesAndMiscDirty")],Ue.prototype,"alphaCutOff",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useSpecularOverAlpha",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useMicroSurfaceFromReflectivityMapAlpha",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useRoughnessFromMetallicTextureAlpha",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useRoughnessFromMetallicTextureGreen",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useMetallnessFromMetallicTextureBlue",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useAmbientOcclusionFromMetallicTextureRed",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useAmbientInGrayScale",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useAutoMicroSurfaceFromReflectivityMap",void 0);T([R()],Ue.prototype,"usePhysicalLightFalloff",null);T([R()],Ue.prototype,"useGLTFLightFalloff",null);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useRadianceOverAlpha",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useObjectSpaceNormalMap",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useParallax",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useParallaxOcclusion",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"parallaxScaleBias",void 0);T([R(),ie("_markAllSubMeshesAsLightsDirty")],Ue.prototype,"disableLighting",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"forceIrradianceInFragment",void 0);T([R(),ie("_markAllSubMeshesAsLightsDirty")],Ue.prototype,"maxSimultaneousLights",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"invertNormalMapX",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"invertNormalMapY",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"twoSidedLighting",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useAlphaFresnel",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useLinearAlphaFresnel",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"environmentBRDFTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"forceNormalForward",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"enableSpecularAntiAliasing",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useHorizonOcclusion",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],Ue.prototype,"useRadianceOcclusion",void 0);T([R(),ie("_markAllSubMeshesAsMiscDirty")],Ue.prototype,"unlit",void 0);he("BABYLON.PBRMaterial",Ue);const my=542327876,Uf=131072,Vf=512,kf=4,Gf=64,zf=131072;function Zc(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function gy(a){return String.fromCharCode(a&255,a>>8&255,a>>16&255,a>>24&255)}const Wf=Zc("DXT1"),Hf=Zc("DXT3"),Xf=Zc("DXT5"),Mu=Zc("DX10"),Yf=113,Kf=116,$f=2,jf=10,vy=88,Du=31,xy=0,Ty=1,qf=2,Qf=3,Ou=4,Zf=7,wu=20,Jf=21,by=22,Sy=23,Ey=24,Cy=25,yy=26,Ay=28,Ry=32;class St{static GetDDSInfo(e){const t=new Int32Array(e.buffer,e.byteOffset,Du),i=new Int32Array(e.buffer,e.byteOffset,Du+4);let s=1;t[qf]&Uf&&(s=Math.max(1,t[Zf]));const r=t[Jf],n=r===Mu?i[Ry]:0;let o=0;switch(r){case Yf:o=2;break;case Kf:o=1;break;case Mu:if(n===jf){o=2;break}if(n===$f){o=1;break}}return{width:t[Ou],height:t[Qf],mipmapCount:s,isFourCC:(t[wu]&kf)===kf,isRGB:(t[wu]&Gf)===Gf,isLuminance:(t[wu]&zf)===zf,isCube:(t[Ay]&Vf)===Vf,isCompressed:r===Wf||r===Hf||r===Xf,dxgiFormat:n,textureType:o}}static _GetHalfFloatAsFloatRGBAArrayBuffer(e,t,i,s,r,n){const o=new Float32Array(s),l=new Uint16Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;o[h]=ln(l[d]),o[h+1]=ln(l[d+1]),o[h+2]=ln(l[d+2]),St.StoreLODInAlphaChannel?o[h+3]=n:o[h+3]=ln(l[d+3]),h+=4}return o}static _GetHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){if(St.StoreLODInAlphaChannel){const o=new Uint16Array(s),l=new Uint16Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;o[h]=l[d],o[h+1]=l[d+1],o[h+2]=l[d+2],o[h+3]=cn(n),h+=4}return o}return new Uint16Array(r,i,s)}static _GetFloatRGBAArrayBuffer(e,t,i,s,r,n){if(St.StoreLODInAlphaChannel){const o=new Float32Array(s),l=new Float32Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;o[h]=l[d],o[h+1]=l[d+1],o[h+2]=l[d+2],o[h+3]=n,h+=4}return o}return new Float32Array(r,i,s)}static _GetFloatAsHalfFloatRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint16Array(s),l=new Float32Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++)o[h]=cn(l[h]),o[h+1]=cn(l[h+1]),o[h+2]=cn(l[h+2]),St.StoreLODInAlphaChannel?o[h+3]=cn(n):o[h+3]=cn(l[h+3]),h+=4;return o}static _GetFloatAsUIntRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint8Array(s),l=new Float32Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;o[h]=oe.Clamp(l[d])*255,o[h+1]=oe.Clamp(l[d+1])*255,o[h+2]=oe.Clamp(l[d+2])*255,St.StoreLODInAlphaChannel?o[h+3]=n:o[h+3]=oe.Clamp(l[d+3])*255,h+=4}return o}static _GetHalfFloatAsUIntRGBAArrayBuffer(e,t,i,s,r,n){const o=new Uint8Array(s),l=new Uint16Array(r,i);let h=0;for(let c=0;c<t;c++)for(let u=0;u<e;u++){const d=(u+c*e)*4;o[h]=oe.Clamp(ln(l[d]))*255,o[h+1]=oe.Clamp(ln(l[d+1]))*255,o[h+2]=oe.Clamp(ln(l[d+2]))*255,St.StoreLODInAlphaChannel?o[h+3]=n:o[h+3]=oe.Clamp(ln(l[d+3]))*255,h+=4}return o}static _GetRGBAArrayBuffer(e,t,i,s,r,n,o,l,h){const c=new Uint8Array(s),u=new Uint8Array(r,i);let d=0;for(let f=0;f<t;f++)for(let p=0;p<e;p++){const _=(p+f*e)*4;c[d]=u[_+n],c[d+1]=u[_+o],c[d+2]=u[_+l],c[d+3]=u[_+h],d+=4}return c}static _ExtractLongWordOrder(e){return e===0||e===255||e===-16777216?0:1+St._ExtractLongWordOrder(e>>8)}static _GetRGBArrayBuffer(e,t,i,s,r,n,o,l){const h=new Uint8Array(s),c=new Uint8Array(r,i);let u=0;for(let d=0;d<t;d++)for(let f=0;f<e;f++){const p=(f+d*e)*3;h[u]=c[p+n],h[u+1]=c[p+o],h[u+2]=c[p+l],u+=3}return h}static _GetLuminanceArrayBuffer(e,t,i,s,r){const n=new Uint8Array(s),o=new Uint8Array(r,i);let l=0;for(let h=0;h<t;h++)for(let c=0;c<e;c++){const u=c+h*e;n[l]=o[u],l++}return n}static UploadDDSLevels(e,t,i,s,r,n,o=-1,l,h=!0){let c=null;s.sphericalPolynomial&&(c=new Array);const u=!!e.getCaps().s3tc;t.generateMipMaps=r;const d=new Int32Array(i.buffer,i.byteOffset,Du);let f,p,_,m=0,v,x,b,S,C=0,E=1;if(d[xy]!==my){B.Error("Invalid magic number in DDS header");return}if(!s.isFourCC&&!s.isRGB&&!s.isLuminance){B.Error("Unsupported format, must contain a FourCC, RGB or LUMINANCE code");return}if(s.isCompressed&&!u){B.Error("Compressed textures are not supported on this platform.");return}let A=d[by];v=d[Ty]+4;let M=!1;if(s.isFourCC)switch(f=d[Jf],f){case Wf:E=8,C=33777;break;case Hf:E=16,C=33778;break;case Xf:E=16,C=33779;break;case Yf:M=!0,A=64;break;case Kf:M=!0,A=128;break;case Mu:{v+=5*4;let K=!1;switch(s.dxgiFormat){case jf:M=!0,A=64,K=!0;break;case $f:M=!0,A=128,K=!0;break;case vy:s.isRGB=!0,s.isFourCC=!1,A=32,K=!0;break}if(K)break}default:console.error("Unsupported FourCC code:",gy(f));return}const D=St._ExtractLongWordOrder(d[Sy]),P=St._ExtractLongWordOrder(d[Ey]),O=St._ExtractLongWordOrder(d[Cy]),N=St._ExtractLongWordOrder(d[yy]);M&&(C=e._getRGBABufferInternalSizedFormat(s.textureType)),b=1,d[qf]&Uf&&r!==!1&&(b=Math.max(1,d[Zf]));const $=l||0,W=e.getCaps();for(let K=$;K<n;K++){for(p=d[Ou],_=d[Qf],S=0;S<b;++S){if(o===-1||o===S){const te=o===-1?S:0;if(!s.isCompressed&&s.isFourCC){t.format=5,m=p*_*4;let ve=null;if(e._badOS||e._badDesktopOS||!W.textureHalfFloat&&!W.textureFloat)A===128?(ve=St._GetFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+v,m,i.buffer,te),c&&te==0&&c.push(St._GetFloatRGBAArrayBuffer(p,_,i.byteOffset+v,m,i.buffer,te))):A===64&&(ve=St._GetHalfFloatAsUIntRGBAArrayBuffer(p,_,i.byteOffset+v,m,i.buffer,te),c&&te==0&&c.push(St._GetHalfFloatAsFloatRGBAArrayBuffer(p,_,i.byteOffset+v,m,i.buffer,te))),t.type=0;else{const _e=W.textureFloat&&(h&&W.textureFloatLinearFiltering||!h),j=W.textureHalfFloat&&(h&&W.textureHalfFloatLinearFiltering||!h),ee=(A===128||A===64&&!j)&&_e?1:(A===64||A===128&&!_e)&&j?2:0;let F,z=null;switch(A){case 128:{switch(ee){case 1:F=St._GetFloatRGBAArrayBuffer,z=null;break;case 2:F=St._GetFloatAsHalfFloatRGBAArrayBuffer,z=St._GetFloatRGBAArrayBuffer;break;case 0:F=St._GetFloatAsUIntRGBAArrayBuffer,z=St._GetFloatRGBAArrayBuffer;break}break}default:{switch(ee){case 1:F=St._GetHalfFloatAsFloatRGBAArrayBuffer,z=null;break;case 2:F=St._GetHalfFloatRGBAArrayBuffer,z=St._GetHalfFloatAsFloatRGBAArrayBuffer;break;case 0:F=St._GetHalfFloatAsUIntRGBAArrayBuffer,z=St._GetHalfFloatAsFloatRGBAArrayBuffer;break}break}}t.type=ee,ve=F(p,_,i.byteOffset+v,m,i.buffer,te),c&&te==0&&c.push(z?z(p,_,i.byteOffset+v,m,i.buffer,te):ve)}ve&&e._uploadDataToTextureDirectly(t,ve,K,te)}else if(s.isRGB)t.type=0,A===24?(t.format=4,m=p*_*3,x=St._GetRGBArrayBuffer(p,_,i.byteOffset+v,m,i.buffer,D,P,O),e._uploadDataToTextureDirectly(t,x,K,te)):(t.format=5,m=p*_*4,x=St._GetRGBAArrayBuffer(p,_,i.byteOffset+v,m,i.buffer,D,P,O,N),e._uploadDataToTextureDirectly(t,x,K,te));else if(s.isLuminance){const ve=e._getUnpackAlignement(),_e=p;m=Math.floor((p+ve-1)/ve)*ve*(_-1)+_e,x=St._GetLuminanceArrayBuffer(p,_,i.byteOffset+v,m,i.buffer),t.format=1,t.type=0,e._uploadDataToTextureDirectly(t,x,K,te)}else m=Math.max(4,p)/4*Math.max(4,_)/4*E,x=new Uint8Array(i.buffer,i.byteOffset+v,m),t.type=0,e._uploadCompressedDataToTextureDirectly(t,C,p,_,x,K,te)}v+=A?p*_*(A/8):m,p*=.5,_*=.5,p=Math.max(1,p),_=Math.max(1,_)}if(l!==void 0)break}c&&c.length>0?s.sphericalPolynomial=$c.ConvertCubeMapToSphericalPolynomial({size:d[Ou],right:c[0],left:c[1],up:c[2],down:c[3],front:c[4],back:c[5],format:5,type:1,gammaSpace:!1}):s.sphericalPolynomial=void 0}}St.StoreLODInAlphaChannel=!1;Te.prototype.createPrefilteredCubeTexture=function(a,e,t,i,s=null,r=null,n,o=null,l=!0){const h=c=>{if(!c){s&&s(null);return}const u=c.texture;if(l?c.info.sphericalPolynomial&&(u._sphericalPolynomial=c.info.sphericalPolynomial):u._sphericalPolynomial=new sa,u._source=We.CubePrefiltered,this.getCaps().textureLOD){s&&s(u);return}const d=3,f=this._gl,p=c.width;if(!p)return;const _=[];for(let m=0;m<d;m++){const v=m/(d-1),x=1-v,b=i,S=oe.Log2(p)*t+i,C=b+(S-b)*x,E=Math.round(Math.min(Math.max(C,0),S)),A=new gt(this,We.Temp);if(A.type=u.type,A.format=u.format,A.width=Math.pow(2,Math.max(oe.Log2(p)-E,0)),A.height=A.width,A.isCube=!0,A._cachedWrapU=0,A._cachedWrapV=0,this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,A,!0),A.samplingMode=2,f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_CUBE_MAP,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),c.isDDS){const D=c.info,P=c.data;this._unpackFlipY(D.isCompressed),St.UploadDDSLevels(this,A,P,D,!0,6,E)}else B.Warn("DDS is the only prefiltered cube map supported so far.");this._bindTextureDirectly(f.TEXTURE_CUBE_MAP,null);const M=new dt(e);M._isCube=!0,M._texture=A,A.isReady=!0,_.push(M)}u._lodTextureHigh=_[2],u._lodTextureMid=_[1],u._lodTextureLow=_[0],s&&s(u)};return this.createCubeTexture(a,e,null,!1,h,r,n,o,l,t,i)};class Iy{constructor(){this.supportCascades=!0}canLoad(e){return e.endsWith(".dds")}loadCubeData(e,t,i,s){const r=t.getEngine();let n,o=!1,l=1e3;if(Array.isArray(e))for(let h=0;h<e.length;h++){const c=e[h];n=St.GetDDSInfo(c),t.width=n.width,t.height=n.height,o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),St.UploadDDSLevels(r,t,c,n,o,6,-1,h),!n.isFourCC&&n.mipmapCount===1?r.generateMipMapsForCubemap(t):l=n.mipmapCount-1}else{const h=e;n=St.GetDDSInfo(h),t.width=n.width,t.height=n.height,i&&(n.sphericalPolynomial=new sa),o=(n.isRGB||n.isLuminance||n.mipmapCount>1)&&t.generateMipMaps,r._unpackFlipY(n.isCompressed),St.UploadDDSLevels(r,t,h,n,o,6),!n.isFourCC&&n.mipmapCount===1?r.generateMipMapsForCubemap(t,!1):l=n.mipmapCount-1}r._setCubeMapTextureParams(t,o,l),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s({isDDS:!0,width:t.width,info:n,data:e,texture:t})}loadData(e,t,i){const s=St.GetDDSInfo(e),r=(s.isRGB||s.isLuminance||s.mipmapCount>1)&&t.generateMipMaps&&s.width>>s.mipmapCount-1===1;i(s.width,s.height,r,s.isFourCC,()=>{St.UploadDDSLevels(t.getEngine(),t,e,s,r,1)})}}k._TextureLoaders.push(new Iy);class Py{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".env")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=mm(e);if(n){t.width=n.width,t.height=n.width;try{vm(t,n),ZS(t,e,n).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()},o=>{r==null||r("Can not upload environment levels",o)})}catch(o){r==null||r("Can not upload environment file",o)}}else r&&r("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}k._TextureLoaders.push(new Py);class Zs{constructor(e,t){if(this.data=e,this.isInvalid=!1,!Zs.IsValid(e)){this.isInvalid=!0,B.Error("texture missing KTX identifier");return}const i=Uint32Array.BYTES_PER_ELEMENT,s=new DataView(this.data.buffer,this.data.byteOffset+12,13*i),n=s.getUint32(0,!0)===67305985;if(this.glType=s.getUint32(1*i,n),this.glTypeSize=s.getUint32(2*i,n),this.glFormat=s.getUint32(3*i,n),this.glInternalFormat=s.getUint32(4*i,n),this.glBaseInternalFormat=s.getUint32(5*i,n),this.pixelWidth=s.getUint32(6*i,n),this.pixelHeight=s.getUint32(7*i,n),this.pixelDepth=s.getUint32(8*i,n),this.numberOfArrayElements=s.getUint32(9*i,n),this.numberOfFaces=s.getUint32(10*i,n),this.numberOfMipmapLevels=s.getUint32(11*i,n),this.bytesOfKeyValueData=s.getUint32(12*i,n),this.glType!==0){B.Error("only compressed formats currently supported");return}else this.numberOfMipmapLevels=Math.max(1,this.numberOfMipmapLevels);if(this.pixelHeight===0||this.pixelDepth!==0){B.Error("only 2D textures currently supported");return}if(this.numberOfArrayElements!==0){B.Error("texture arrays not currently supported");return}if(this.numberOfFaces!==t){B.Error("number of faces expected"+t+", but found "+this.numberOfFaces);return}this.loadType=Zs.COMPRESSED_2D}uploadLevels(e,t){switch(this.loadType){case Zs.COMPRESSED_2D:this._upload2DCompressedLevels(e,t);break}}_upload2DCompressedLevels(e,t){let i=Zs.HEADER_LEN+this.bytesOfKeyValueData,s=this.pixelWidth,r=this.pixelHeight;const n=t?this.numberOfMipmapLevels:1;for(let o=0;o<n;o++){const l=new Int32Array(this.data.buffer,this.data.byteOffset+i,1)[0];i+=4;for(let h=0;h<this.numberOfFaces;h++){const c=new Uint8Array(this.data.buffer,this.data.byteOffset+i,l);e.getEngine()._uploadCompressedDataToTextureDirectly(e,e.format,s,r,c,h,o),i+=l,i+=3-(l+3)%4}s=Math.max(1,s*.5),r=Math.max(1,r*.5)}}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===49&&t[6]===49&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}Zs.HEADER_LEN=12+13*4;Zs.COMPRESSED_2D=0;Zs.COMPRESSED_3D=1;Zs.TEX_2D=2;Zs.TEX_3D=3;class My{constructor(e){this._pendingActions=new Array,this._workerInfos=e.map(t=>({workerPromise:Promise.resolve(t),idle:!0}))}dispose(){for(const e of this._workerInfos)e.workerPromise.then(t=>{t.terminate()});this._workerInfos.length=0,this._pendingActions.length=0}push(e){this._executeOnIdleWorker(e)||this._pendingActions.push(e)}_executeOnIdleWorker(e){for(const t of this._workerInfos)if(t.idle)return this._execute(t,e),!0;return!1}_execute(e,t){e.idle=!1,e.workerPromise.then(i=>{t(i,()=>{const s=this._pendingActions.shift();s?this._execute(e,s):e.idle=!0})})}}class Jc extends My{constructor(e,t,i=Jc.DefaultOptions){super([]),this._maxWorkers=e,this._createWorkerAsync=t,this._options=i}push(e){if(!this._executeOnIdleWorker(e))if(this._workerInfos.length<this._maxWorkers){const t={workerPromise:this._createWorkerAsync(),idle:!1};this._workerInfos.push(t),this._execute(t,e)}else this._pendingActions.push(e)}_execute(e,t){e.timeoutId&&(clearTimeout(e.timeoutId),delete e.timeoutId),super._execute(e,(i,s)=>{t(i,()=>{s(),e.idle&&(e.timeoutId=setTimeout(()=>{e.workerPromise.then(n=>{n.terminate()});const r=this._workerInfos.indexOf(e);r!==-1&&this._workerInfos.splice(r,1)},this._options.idleTimeElapsedBeforeRelease))})})}}Jc.DefaultOptions={idleTimeElapsedBeforeRelease:1e3};class zi{constructor(e,t=zi.DefaultNumWorkers){this._engine=e,zi._Initialize(t)}static GetDefaultNumWorkers(){return typeof navigator!="object"||!navigator.hardwareConcurrency?1:Math.min(Math.floor(navigator.hardwareConcurrency*.5),4)}static _Initialize(e){zi._WorkerPoolPromise||zi._DecoderModulePromise||(e&&typeof Worker=="function"&&typeof URL<"u"?zi._WorkerPoolPromise=new Promise(t=>{const i=`(${Dy})()`,s=URL.createObjectURL(new Blob([i],{type:"application/javascript"}));t(new Jc(e,()=>new Promise((r,n)=>{const o=new Worker(s),l=c=>{o.removeEventListener("error",l),o.removeEventListener("message",h),n(c)},h=c=>{c.data.action==="init"&&(o.removeEventListener("error",l),o.removeEventListener("message",h),r(o))};o.addEventListener("error",l),o.addEventListener("message",h),o.postMessage({action:"init",urls:zi.URLConfig})})))}):typeof KTX2DECODER>"u"?zi._DecoderModulePromise=q.LoadScriptAsync(zi.URLConfig.jsDecoderModule).then(()=>{KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0;const t=zi.URLConfig;return t.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=t.wasmUASTCToASTC),t.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=t.wasmUASTCToRGBA_SRGB),t.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=t.jsMSCTranscoder),t.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=t.wasmMSCTranscoder),t.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=t.wasmZSTDDecoder),new KTX2DECODER.KTX2Decoder}):(KTX2DECODER.MSCTranscoder.UseFromWorkerThread=!1,KTX2DECODER.WASMMemoryManager.LoadBinariesFromCurrentThread=!0,zi._DecoderModulePromise=Promise.resolve(new KTX2DECODER.KTX2Decoder)))}uploadAsync(e,t,i){const s=this._engine.getCaps(),r={astc:!!s.astc,bptc:!!s.bptc,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,etc1:!!s.etc1};if(zi._WorkerPoolPromise)return zi._WorkerPoolPromise.then(n=>new Promise((o,l)=>{n.push((h,c)=>{const u=p=>{h.removeEventListener("error",u),h.removeEventListener("message",d),l(p),c()},d=p=>{if(p.data.action==="decoded"){if(h.removeEventListener("error",u),h.removeEventListener("message",d),!p.data.success)l({message:p.data.msg});else try{this._createTexture(p.data.decodedData,t,i),o()}catch(_){l({message:_})}c()}};h.addEventListener("error",u),h.addEventListener("message",d);const f=new Uint8Array(e.byteLength);f.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),h.postMessage({action:"decode",data:f,caps:r,options:i},[f.buffer])})}));if(zi._DecoderModulePromise)return zi._DecoderModulePromise.then(n=>new Promise((o,l)=>{n.decode(e,s).then(h=>{this._createTexture(h,t),o()}).catch(h=>{l({message:h})})}));throw new Error("KTX2 decoder module is not available")}_createTexture(e,t,i){if(this._engine._bindTextureDirectly(3553,t),i&&(i.transcodedFormat=e.transcodedFormat,i.isInGammaSpace=e.isInGammaSpace,i.hasAlpha=e.hasAlpha,i.transcoderName=e.transcoderName),e.transcodedFormat===32856?(t.type=0,t.format=5):t.format=e.transcodedFormat,t._gammaSpace=e.isInGammaSpace,t.generateMipMaps=e.mipmaps.length>1,e.errors)throw new Error("KTX2 container - could not transcode the data. "+e.errors);for(let r=0;r<e.mipmaps.length;++r){const n=e.mipmaps[r];if(!n||!n.data)throw new Error("KTX2 container - could not transcode one of the image");e.transcodedFormat===32856?(t.width=n.width,t.height=n.height,this._engine._uploadDataToTextureDirectly(t,n.data,0,r,void 0,!0)):this._engine._uploadCompressedDataToTextureDirectly(t,e.transcodedFormat,n.width,n.height,n.data,0,r)}t._extension=".ktx2",t.width=e.mipmaps[0].width,t.height=e.mipmaps[0].height,t.isReady=!0,this._engine._bindTextureDirectly(3553,null)}static IsValid(e){if(e.byteLength>=12){const t=new Uint8Array(e.buffer,e.byteOffset,12);if(t[0]===171&&t[1]===75&&t[2]===84&&t[3]===88&&t[4]===32&&t[5]===50&&t[6]===48&&t[7]===187&&t[8]===13&&t[9]===10&&t[10]===26&&t[11]===10)return!0}return!1}}zi.URLConfig={jsDecoderModule:"https://preview.babylonjs.com/babylon.ktx2Decoder.js",wasmUASTCToASTC:null,wasmUASTCToBC7:null,wasmUASTCToRGBA_UNORM:null,wasmUASTCToRGBA_SRGB:null,jsMSCTranscoder:null,wasmMSCTranscoder:null,wasmZSTDDecoder:null};zi.DefaultNumWorkers=zi.GetDefaultNumWorkers();function Dy(){let a;onmessage=e=>{if(!!e.data)switch(e.data.action){case"init":{const t=e.data.urls;importScripts(t.jsDecoderModule),t.wasmUASTCToASTC!==null&&(KTX2DECODER.LiteTranscoder_UASTC_ASTC.WasmModuleURL=t.wasmUASTCToASTC),t.wasmUASTCToBC7!==null&&(KTX2DECODER.LiteTranscoder_UASTC_BC7.WasmModuleURL=t.wasmUASTCToBC7),t.wasmUASTCToRGBA_UNORM!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_UNORM.WasmModuleURL=t.wasmUASTCToRGBA_UNORM),t.wasmUASTCToRGBA_SRGB!==null&&(KTX2DECODER.LiteTranscoder_UASTC_RGBA_SRGB.WasmModuleURL=t.wasmUASTCToRGBA_SRGB),t.jsMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.JSModuleURL=t.jsMSCTranscoder),t.wasmMSCTranscoder!==null&&(KTX2DECODER.MSCTranscoder.WasmModuleURL=t.wasmMSCTranscoder),t.wasmZSTDDecoder!==null&&(KTX2DECODER.ZSTDDecoder.WasmModuleURL=t.wasmZSTDDecoder),a=new KTX2DECODER.KTX2Decoder,postMessage({action:"init"});break}case"decode":a.decode(e.data.data,e.data.caps,e.data.options).then(t=>{const i=[];for(let s=0;s<t.mipmaps.length;++s){const r=t.mipmaps[s];r&&r.data&&i.push(r.data.buffer)}postMessage({action:"decoded",success:!0,decodedData:t},i)}).catch(t=>{postMessage({action:"decoded",success:!1,msg:t})});break}}}function Oy(a){switch(a){case 35916:return 33776;case 35918:return 33778;case 35919:return 33779;case 37493:return 37492;case 37497:return 37496;case 37495:return 37494;case 37840:return 37808;case 36493:return 36492}return null}class wy{constructor(){this.supportCascades=!1}canLoad(e,t){return e.endsWith(".ktx")||e.endsWith(".ktx2")||t==="image/ktx"||t==="image/ktx2"}loadCubeData(e,t,i,s){if(Array.isArray(e))return;t._invertVScale=!t.invertY;const r=t.getEngine(),n=new Zs(e,6),o=n.numberOfMipmapLevels>1&&t.generateMipMaps;r._unpackFlipY(!0),n.uploadLevels(t,t.generateMipMaps),t.width=n.pixelWidth,t.height=n.pixelHeight,r._setCubeMapTextureParams(t,o,n.numberOfMipmapLevels-1),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}loadData(e,t,i,s){if(Zs.IsValid(e)){t._invertVScale=!t.invertY;const r=new Zs(e,1),n=Oy(r.glInternalFormat);n?(t.format=n,t._useSRGBBuffer=t.getEngine()._getUseSRGBBuffer(!0,t.generateMipMaps),t._gammaSpace=!0):t.format=r.glInternalFormat,i(r.pixelWidth,r.pixelHeight,t.generateMipMaps,!0,()=>{r.uploadLevels(t,t.generateMipMaps)},r.isInvalid)}else zi.IsValid(e)?new zi(t.getEngine()).uploadAsync(e,t,s).then(()=>{i(t.width,t.height,t.generateMipMaps,!0,()=>{},!1)},n=>{B.Warn(`Failed to load KTX2 texture data: ${n.message}`),i(0,0,!1,!1,()=>{},!0)}):(B.Error("texture missing KTX identifier"),i(0,0,!1,!1,()=>{},!0))}}k._TextureLoaders.unshift(new wy);class Dl extends ws{constructor(e,t,i){super(e,g.Zero(),t),this._xrSessionManager=i,this._firstFrame=!1,this._referenceQuaternion=Q.Identity(),this._referencedPosition=new g,this._trackingState=uo.NOT_TRACKING,this.onBeforeCameraTeleport=new X,this.onAfterCameraTeleport=new X,this.onTrackingStateChanged=new X,this.compensateOnFirstFrame=!0,this._rotate180=new Q(0,1,0,0),this.minZ=.1,this.rotationQuaternion=new Q,this.cameraRigMode=be.RIG_MODE_CUSTOM,this.updateUpVectorFromRotation=!0,this._updateNumberOfRigCameras(1),this.freezeProjectionMatrix(),this._xrSessionManager.onXRSessionInit.add(()=>{this._referencedPosition.copyFromFloats(0,0,0),this._referenceQuaternion.copyFromFloats(0,0,0,1),this._firstFrame=this.compensateOnFirstFrame}),this._xrSessionManager.onXRFrameObservable.add(()=>{this._firstFrame&&this._updateFromXRSession(),this._updateReferenceSpace(),this._updateFromXRSession()},void 0,!0)}get trackingState(){return this._trackingState}_setTrackingState(e){this._trackingState!==e&&(this._trackingState=e,this.onTrackingStateChanged.notifyObservers(e))}get realWorldHeight(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.baseReferenceSpace);return e&&e.transform?e.transform.position.y:0}_updateForDualEyeDebugging(){this._updateNumberOfRigCameras(2),this.rigCameras[0].viewport=new Es(0,0,.5,1),this.rigCameras[0].outputRenderTarget=null,this.rigCameras[1].viewport=new Es(.5,0,.5,1),this.rigCameras[1].outputRenderTarget=null}setTransformationFromNonVRCamera(e=this.getScene().activeCamera,t=!0){if(!e||e===this)return;e.computeWorldMatrix().decompose(void 0,this.rotationQuaternion,this.position),this.position.y=0,Q.FromEulerAnglesToRef(0,this.rotationQuaternion.toEulerAngles().y,0,this.rotationQuaternion),this._firstFrame=!0,t&&this._xrSessionManager.resetReferenceSpace()}getClassName(){return"WebXRCamera"}dispose(){super.dispose(),this._lastXRViewerPose=void 0}_updateFromXRSession(){const e=this._xrSessionManager.currentFrame&&this._xrSessionManager.currentFrame.getViewerPose(this._xrSessionManager.referenceSpace);if(this._lastXRViewerPose=e||void 0,!e){this._setTrackingState(uo.NOT_TRACKING);return}const t=e.emulatedPosition?uo.TRACKING_LOST:uo.TRACKING;if(this._setTrackingState(t),this.minZ!==this._cache.minZ||this.maxZ!==this._cache.maxZ){const i={depthFar:this.maxZ||1e4,depthNear:this.minZ};this._xrSessionManager.updateRenderState(i),this._cache.minZ=this.minZ,this._cache.maxZ=this.maxZ}if(e.transform){const i=e.transform.orientation;if(e.transform.orientation.x===void 0)return;const s=e.transform.position;this._referencedPosition.set(s.x,s.y,s.z),this._referenceQuaternion.set(i.x,i.y,i.z,i.w),this._scene.useRightHandedSystem||(this._referencedPosition.z*=-1,this._referenceQuaternion.z*=-1,this._referenceQuaternion.w*=-1),this._firstFrame?(this._firstFrame=!1,this.position.y+=this._referencedPosition.y,this._referenceQuaternion.copyFromFloats(0,0,0,1)):(this.rotationQuaternion.copyFrom(this._referenceQuaternion),this.position.copyFrom(this._referencedPosition))}this.rigCameras.length!==e.views.length&&this._updateNumberOfRigCameras(e.views.length),e.views.forEach((i,s)=>{var r;const n=this.rigCameras[s];!n.isLeftCamera&&!n.isRightCamera&&(i.eye==="right"?n._isRightCamera=!0:i.eye==="left"&&(n._isLeftCamera=!0));const o=i.transform.position,l=i.transform.orientation;n.parent=this.parent,n.position.set(o.x,o.y,o.z),n.rotationQuaternion.set(l.x,l.y,l.z,l.w),this._scene.useRightHandedSystem?n.rotationQuaternion.multiplyInPlace(this._rotate180):(n.position.z*=-1,n.rotationQuaternion.z*=-1,n.rotationQuaternion.w*=-1),L.FromFloat32ArrayToRefScaled(i.projectionMatrix,0,1,n._projectionMatrix),this._scene.useRightHandedSystem||n._projectionMatrix.toggleProjectionMatrixHandInPlace(),s===0&&this._projectionMatrix.copyFrom(n._projectionMatrix);const h=this._xrSessionManager.getRenderTargetTextureForView(i);this._renderingMultiview=((r=h==null?void 0:h._texture)===null||r===void 0?void 0:r.isMultiview)||!1,this._renderingMultiview?s==0&&(this._xrSessionManager.trySetViewportForView(this.viewport,i),this.outputRenderTarget=h):(this._xrSessionManager.trySetViewportForView(n.viewport,i),n.outputRenderTarget=h||this._xrSessionManager.getRenderTargetTextureForView(i))})}_updateNumberOfRigCameras(e=1){for(;this.rigCameras.length<e;){const t=new ai("XR-RigCamera: "+this.rigCameras.length,g.Zero(),this.getScene());t.minZ=.1,t.rotationQuaternion=new Q,t.updateUpVectorFromRotation=!0,t.isRigCamera=!0,t.rigParent=this,t.freezeProjectionMatrix(),this.rigCameras.push(t)}for(;this.rigCameras.length>e;){const t=this.rigCameras.pop();t&&t.dispose()}}_updateReferenceSpace(){if(!this.position.equals(this._referencedPosition)||!this.rotationQuaternion.equals(this._referenceQuaternion)){const e=G.Matrix[0],t=G.Matrix[1],i=G.Matrix[2];L.ComposeToRef(Dl._ScaleReadOnly,this._referenceQuaternion,this._referencedPosition,e),L.ComposeToRef(Dl._ScaleReadOnly,this.rotationQuaternion,this.position,t),e.invert().multiplyToRef(t,i),i.invert(),this._scene.useRightHandedSystem||i.toggleModelMatrixHandInPlace(),i.decompose(void 0,this._referenceQuaternion,this._referencedPosition);const s=new XRRigidTransform({x:this._referencedPosition.x,y:this._referencedPosition.y,z:this._referencedPosition.z},{x:this._referenceQuaternion.x,y:this._referenceQuaternion.y,z:this._referenceQuaternion.z,w:this._referenceQuaternion.w});this._xrSessionManager.referenceSpace=this._xrSessionManager.referenceSpace.getOffsetReferenceSpace(s)}}}Dl._ScaleReadOnly=g.One();class n0{constructor(e){this._scene=e,this._nonVRCamera=null,this._attachedToElement=!1,this._spectatorCamera=null,this._originalSceneAutoClear=!0,this._supported=!1,this._spectatorMode=!1,this._lastTimestamp=0,this.onInitialXRPoseSetObservable=new X,this.onStateChangedObservable=new X,this.state=Ti.NOT_IN_XR,this.sessionManager=new zc(e),this.camera=new Dl("webxr",e,this.sessionManager),this.featuresManager=new ii(this.sessionManager),e.onDisposeObservable.addOnce(()=>{this.dispose()})}static CreateAsync(e){const t=new n0(e);return t.sessionManager.initializeAsync().then(()=>(t._supported=!0,t)).catch(i=>{throw t._setState(Ti.NOT_IN_XR),t.dispose(),i})}dispose(){var e;this.exitXRAsync(),this.camera.dispose(),this.onStateChangedObservable.clear(),this.onInitialXRPoseSetObservable.clear(),this.sessionManager.dispose(),(e=this._spectatorCamera)===null||e===void 0||e.dispose(),this._nonVRCamera&&(this._scene.activeCamera=this._nonVRCamera)}async enterXRAsync(e,t,i=this.sessionManager.getWebXRRenderTarget(),s={}){var r,n,o;if(!this._supported)throw"WebXR not supported in this browser or environment";this._setState(Ti.ENTERING_XR),t!=="viewer"&&t!=="local"&&(s.optionalFeatures=s.optionalFeatures||[],s.optionalFeatures.push(t)),s=await this.featuresManager._extendXRSessionInitObject(s),e==="immersive-ar"&&t!=="unbounded"&&B.Warn("We recommend using 'unbounded' reference space type when using 'immersive-ar' session mode");try{await this.sessionManager.initializeSessionAsync(e,s),await this.sessionManager.setReferenceSpaceTypeAsync(t);const l=await i.initializeXRLayerAsync(this.sessionManager.session),h={depthFar:this.camera.maxZ||1e4,depthNear:this.camera.minZ};return this.featuresManager.getEnabledFeature(pt.LAYERS)||(h.baseLayer=l),this.sessionManager.updateRenderState(h),this.sessionManager.runXRRenderLoop(),this._originalSceneAutoClear=this._scene.autoClear,this._nonVRCamera=this._scene.activeCamera,this._attachedToElement=!!(!((n=(r=this._nonVRCamera)===null||r===void 0?void 0:r.inputs)===null||n===void 0)&&n.attachedToElement),(o=this._nonVRCamera)===null||o===void 0||o.detachControl(),this._scene.activeCamera=this.camera,e!=="immersive-ar"?this._nonXRToXRCamera():(this._scene.autoClear=!1,this.camera.compensateOnFirstFrame=!1,this.camera.position.set(0,0,0),this.camera.rotationQuaternion.set(0,0,0,1)),this.sessionManager.onXRSessionEnded.addOnce(()=>{this.state!==Ti.EXITING_XR&&this._setState(Ti.EXITING_XR),this.camera.rigCameras.forEach(c=>{c.outputRenderTarget=null}),this._scene.autoClear=this._originalSceneAutoClear,this._scene.activeCamera=this._nonVRCamera,this._attachedToElement&&this._nonVRCamera&&this._nonVRCamera.attachControl(!!this._nonVRCamera.inputs.noPreventDefault),e!=="immersive-ar"&&this.camera.compensateOnFirstFrame&&(this._nonVRCamera.setPosition?this._nonVRCamera.setPosition(this.camera.position):this._nonVRCamera.position.copyFrom(this.camera.position)),this._setState(Ti.NOT_IN_XR)}),this.sessionManager.onXRFrameObservable.addOnce(()=>{this._setState(Ti.IN_XR)}),this.sessionManager}catch(l){throw console.log(l),console.log(l.message),this._setState(Ti.NOT_IN_XR),l}}exitXRAsync(){return this.state!==Ti.IN_XR?Promise.resolve():(this._setState(Ti.EXITING_XR),this.sessionManager.exitXRAsync())}enableSpectatorMode(e){this._spectatorMode||(this._spectatorMode=!0,this._switchSpectatorMode(e))}disableSpecatatorMode(){this._spectatorMode&&(this._spectatorMode=!1,this._switchSpectatorMode())}_switchSpectatorMode(e){const t=e!=null&&e.fps?e.fps:1e3,i=1/t*1e3,s=e!=null&&e.preferredCameraIndex?e==null?void 0:e.preferredCameraIndex:0,r=()=>{this._spectatorCamera&&this.sessionManager.currentTimestamp-this._lastTimestamp>=i&&(this._lastTimestamp=this.sessionManager.currentTimestamp,this._spectatorCamera.position.copyFrom(this.camera.rigCameras[s].globalPosition),this._spectatorCamera.rotationQuaternion.copyFrom(this.camera.rigCameras[s].absoluteRotation))};if(this._spectatorMode){if(s>=this.camera.rigCameras.length)throw new Error("the preferred camera index is beyond the length of rig camera array.");const n=()=>{this.state===Ti.IN_XR?(this._spectatorCamera=new Wo("webxr-spectator",g.Zero(),this._scene),this._spectatorCamera.rotationQuaternion=new Q,this._scene.activeCameras=[this.camera,this._spectatorCamera],this.sessionManager.onXRFrameObservable.add(r),this._scene.onAfterRenderCameraObservable.add(o=>{o===this.camera&&(this._scene.getEngine().framebufferDimensionsObject=null)})):this.state===Ti.EXITING_XR&&(this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=null)};this.onStateChangedObservable.add(n),n()}else this.sessionManager.onXRFrameObservable.removeCallback(r),this._scene.activeCameras=[this.camera]}_nonXRToXRCamera(){this.camera.setTransformationFromNonVRCamera(this._nonVRCamera),this.onInitialXRPoseSetObservable.notifyObservers(this.camera)}_setState(e){this.state!==e&&(this.state=e,this.onStateChangedObservable.notifyObservers(this.state))}}class zs{constructor(e,t,i=-1,s=[]){this.id=e,this.type=t,this._buttonIndex=i,this._axesIndices=s,this._axes={x:0,y:0},this._changes={},this._currentValue=0,this._hasChanges=!1,this._pressed=!1,this._touched=!1,this.onAxisValueChangedObservable=new X,this.onButtonStateChangedObservable=new X}get axes(){return this._axes}get changes(){return this._changes}get hasChanges(){return this._hasChanges}get pressed(){return this._pressed}get touched(){return this._touched}get value(){return this._currentValue}dispose(){this.onAxisValueChangedObservable.clear(),this.onButtonStateChangedObservable.clear()}isAxes(){return this._axesIndices.length!==0}isButton(){return this._buttonIndex!==-1}update(e){let t=!1,i=!1;if(this._hasChanges=!1,this._changes={},this.isButton()){const s=e.buttons[this._buttonIndex];if(!s)return;this._currentValue!==s.value&&(this.changes.value={current:s.value,previous:this._currentValue},t=!0,this._currentValue=s.value),this._touched!==s.touched&&(this.changes.touched={current:s.touched,previous:this._touched},t=!0,this._touched=s.touched),this._pressed!==s.pressed&&(this.changes.pressed={current:s.pressed,previous:this._pressed},t=!0,this._pressed=s.pressed)}this.isAxes()&&(this._axes.x!==e.axes[this._axesIndices[0]]&&(this.changes.axes={current:{x:e.axes[this._axesIndices[0]],y:this._axes.y},previous:{x:this._axes.x,y:this._axes.y}},this._axes.x=e.axes[this._axesIndices[0]],i=!0),this._axes.y!==e.axes[this._axesIndices[1]]&&(this.changes.axes?this.changes.axes.current.y=e.axes[this._axesIndices[1]]:this.changes.axes={current:{x:this._axes.x,y:e.axes[this._axesIndices[1]]},previous:{x:this._axes.x,y:this._axes.y}},this._axes.y=e.axes[this._axesIndices[1]],i=!0)),t&&(this._hasChanges=!0,this.onButtonStateChangedObservable.notifyObservers(this)),i&&(this._hasChanges=!0,this.onAxisValueChangedObservable.notifyObservers(this._axes))}}zs.BUTTON_TYPE="button";zs.SQUEEZE_TYPE="squeeze";zs.THUMBSTICK_TYPE="thumbstick";zs.TOUCHPAD_TYPE="touchpad";zs.TRIGGER_TYPE="trigger";class Ho{constructor(e,t,i,s,r=!1,n){this.scene=e,this.layout=t,this.gamepadObject=i,this.handedness=s,this._doNotLoadControllerMesh=r,this._controllerCache=n,this._initComponent=o=>{if(!o)return;const l=this.layout.components[o],h=l.type,c=l.gamepadIndices.button,u=[];l.gamepadIndices.xAxis!==void 0&&l.gamepadIndices.yAxis!==void 0&&u.push(l.gamepadIndices.xAxis,l.gamepadIndices.yAxis),this.components[o]=new zs(o,h,c,u)},this._modelReady=!1,this.components={},this.disableAnimation=!1,this.onModelLoadedObservable=new X,t.components&&Object.keys(t.components).forEach(this._initComponent)}dispose(){this.getComponentIds().forEach(e=>this.getComponent(e).dispose()),this.rootMesh&&(this.rootMesh.getChildren(void 0,!0).forEach(e=>{e.setEnabled(!1)}),this.rootMesh.dispose(!!this._controllerCache,!this._controllerCache))}getAllComponentsOfType(e){return this.getComponentIds().map(t=>this.components[t]).filter(t=>t.type===e)}getComponent(e){return this.components[e]}getComponentIds(){return Object.keys(this.components)}getComponentOfType(e){return this.getAllComponentsOfType(e)[0]||null}getMainComponent(){return this.getComponent(this.layout.selectComponentId)}async loadModel(){const e=!this._getModelLoadingConstraints();let t=this._getGenericFilenameAndPath();return e?B.Warn("Falling back to generic models"):t=this._getFilenameAndPath(),new Promise((i,s)=>{const r=n=>{e?this._getGenericParentMesh(n):this._setRootMesh(n),this._processLoadedModel(n),this._modelReady=!0,this.onModelLoadedObservable.notifyObservers(this),i(!0)};if(this._controllerCache){const n=this._controllerCache.filter(o=>o.filename===t.filename&&o.path===t.path);if(n[0]){n[0].meshes.forEach(o=>o.setEnabled(!0)),r(n[0].meshes);return}}Be.ImportMesh("",t.path,t.filename,this.scene,n=>{this._controllerCache&&this._controllerCache.push({...t,meshes:n}),r(n)},null,(n,o)=>{B.Log(o),B.Warn(`Failed to retrieve controller model of type ${this.profileId} from the remote server: ${t.path}${t.filename}`),s(o)})})}updateFromXRFrame(e){this.getComponentIds().forEach(t=>this.getComponent(t).update(this.gamepadObject)),this.updateModel(e)}get handness(){return this.handedness}pulse(e,t,i=0){return this.gamepadObject.hapticActuators&&this.gamepadObject.hapticActuators[i]?this.gamepadObject.hapticActuators[i].pulse(e,t):Promise.resolve(!1)}_getChildByName(e,t){return e.getChildren(i=>i.name===t,!1)[0]}_getImmediateChildByName(e,t){return e.getChildren(i=>i.name==t,!0)[0]}_lerpTransform(e,t,i){if(!e.minMesh||!e.maxMesh||!e.valueMesh||!e.minMesh.rotationQuaternion||!e.maxMesh.rotationQuaternion||!e.valueMesh.rotationQuaternion)return;const s=i?t*.5+.5:t;Q.SlerpToRef(e.minMesh.rotationQuaternion,e.maxMesh.rotationQuaternion,s,e.valueMesh.rotationQuaternion),g.LerpToRef(e.minMesh.position,e.maxMesh.position,s,e.valueMesh.position)}updateModel(e){!this._modelReady||this._updateModel(e)}_getGenericFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getGenericParentMesh(e){this.rootMesh=new V(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.parent||(t.isPickable=!1,t.setParent(this.rootMesh))}),this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0)}}class Ol extends Ho{constructor(e,t,i){super(e,Ny[i],t,i),this.profileId=Ol.ProfileId}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){this.rootMesh=new V(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.isPickable=!1,t.parent||t.setParent(this.rootMesh)}),this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0)}_updateModel(){}}Ol.ProfileId="generic-trigger";const Ny={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-trigger-none",assetPath:"none.glb"}};class Fy extends Ho{constructor(e,t,i,s,r){super(e,i.layouts[t.handedness||"none"],t.gamepad,t.handedness,void 0,r),this._repositoryUrl=s,this.controllerCache=r,this._buttonMeshMapping={},this._touchDots={},this.profileId=i.profileId}dispose(){super.dispose(),this.controllerCache||Object.keys(this._touchDots).forEach(e=>{this._touchDots[e].dispose()})}_getFilenameAndPath(){return{filename:this.layout.assetPath,path:`${this._repositoryUrl}/profiles/${this.profileId}/`}}_getModelLoadingConstraints(){const e=Be.IsPluginForExtensionAvailable(".glb");return e||B.Warn("glTF / glb loader was not registered, using generic controller instead"),e}_processLoadedModel(e){this.getComponentIds().forEach(t=>{const i=this.layout.components[t];this._buttonMeshMapping[t]={mainMesh:this._getChildByName(this.rootMesh,i.rootNodeName),states:{}},Object.keys(i.visualResponses).forEach(s=>{const r=i.visualResponses[s];if(r.valueNodeProperty==="transform")this._buttonMeshMapping[t].states[s]={valueMesh:this._getChildByName(this.rootMesh,r.valueNodeName),minMesh:this._getChildByName(this.rootMesh,r.minNodeName),maxMesh:this._getChildByName(this.rootMesh,r.maxNodeName)};else{const n=i.type===zs.TOUCHPAD_TYPE&&i.touchPointNodeName?i.touchPointNodeName:r.valueNodeName;if(this._buttonMeshMapping[t].states[s]={valueMesh:this._getChildByName(this.rootMesh,n)},i.type===zs.TOUCHPAD_TYPE&&!this._touchDots[s]){const o=qr(s+"dot",{diameter:.0015,segments:8},this.scene);o.material=new pe(s+"mat",this.scene),o.material.diffuseColor=re.Red(),o.parent=this._buttonMeshMapping[t].states[s].valueMesh||null,o.isVisible=!1,this._touchDots[s]=o}}})})}_setRootMesh(e){this.rootMesh=new V(this.profileId+"-"+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||this.rootMesh.rotate(ti.Y,Math.PI,Ze.WORLD)}_updateModel(e){this.disableAnimation||this.getComponentIds().forEach(t=>{const i=this.getComponent(t);if(!i.hasChanges)return;const s=this._buttonMeshMapping[t],r=this.layout.components[t];Object.keys(r.visualResponses).forEach(n=>{const o=r.visualResponses[n];let l=i.value;if(o.componentProperty==="xAxis"?l=i.axes.x:o.componentProperty==="yAxis"&&(l=i.axes.y),o.valueNodeProperty==="transform")this._lerpTransform(s.states[n],l,o.componentProperty!=="button");else{const h=s.states[n].valueMesh;h&&(h.isVisible=i.touched||i.pressed),this._touchDots[n]&&(this._touchDots[n].isVisible=i.touched||i.pressed)}})})}}const Nu=[];class Mi{static ClearProfilesCache(){this._ProfilesList=null,this._ProfileLoadingPromises={}}static DefaultFallbacks(){this.RegisterFallbacksForProfileId("google-daydream",["generic-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive-focus",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("htc-vive",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("magicleap-one",["generic-trigger-squeeze-touchpad"]),this.RegisterFallbacksForProfileId("windows-mixed-reality",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("microsoft-mixed-reality",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-go",["generic-trigger-touchpad"]),this.RegisterFallbacksForProfileId("oculus-touch-v2",["oculus-touch","generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("oculus-touch",["generic-trigger-squeeze-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-gearvr",["windows-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("samsung-odyssey",["generic-touchpad"]),this.RegisterFallbacksForProfileId("valve-index",["generic-trigger-squeeze-touchpad-thumbstick"]),this.RegisterFallbacksForProfileId("generic-hand-select",["generic-trigger"])}static FindFallbackWithProfileId(e){const t=this._Fallbacks[e]||[];return t.unshift(e),t}static GetMotionControllerWithXRInput(e,t,i){const s=[];if(i&&s.push(i),s.push(...e.profiles||[]),s.length&&!s[0]&&s.pop(),e.gamepad&&e.gamepad.id)switch(e.gamepad.id){case(e.gamepad.id.match(/oculus touch/gi)?e.gamepad.id:void 0):s.push("oculus-touch-v2");break}const r=s.indexOf("windows-mixed-reality");if(r!==-1&&s.splice(r,0,"microsoft-mixed-reality"),s.length||s.push("generic-trigger"),this.UseOnlineRepository){const n=this.PrioritizeOnlineRepository?this._LoadProfileFromRepository:this._LoadProfilesFromAvailableControllers,o=this.PrioritizeOnlineRepository?this._LoadProfilesFromAvailableControllers:this._LoadProfileFromRepository;return n.call(this,s,e,t).catch(()=>o.call(this,s,e,t))}else return this._LoadProfilesFromAvailableControllers(s,e,t)}static RegisterController(e,t){this._AvailableControllers[e]=t}static RegisterFallbacksForProfileId(e,t){this._Fallbacks[e]?this._Fallbacks[e].push(...t):this._Fallbacks[e]=t}static UpdateProfilesList(){return this._ProfilesList=q.LoadFileAsync(this.BaseRepositoryUrl+"/profiles/profilesList.json",!1).then(e=>JSON.parse(e.toString())),this._ProfilesList}static ClearControllerCache(){Nu.forEach(e=>{e.meshes.forEach(t=>{t.dispose(!1,!0)})}),Nu.length=0}static _LoadProfileFromRepository(e,t,i){return Promise.resolve().then(()=>this._ProfilesList?this._ProfilesList:this.UpdateProfilesList()).then(s=>{for(let r=0;r<e.length;++r)if(!!e[r]&&s[e[r]])return e[r];throw new Error(`neither controller ${e[0]} nor all fallbacks were found in the repository,`)}).then(s=>(this._ProfileLoadingPromises[s]||(this._ProfileLoadingPromises[s]=q.LoadFileAsync(`${this.BaseRepositoryUrl}/profiles/${s}/profile.json`,!1).then(r=>JSON.parse(r))),this._ProfileLoadingPromises[s])).then(s=>new Fy(i,t,s,this.BaseRepositoryUrl,this.DisableControllerCache?void 0:Nu))}static _LoadProfilesFromAvailableControllers(e,t,i){for(let s=0;s<e.length;++s){if(!e[s])continue;const r=this.FindFallbackWithProfileId(e[s]);for(let n=0;n<r.length;++n){const o=this._AvailableControllers[r[n]];if(o)return Promise.resolve(o(t,i))}}throw new Error("no controller requested was found in the available controllers list")}}Mi._AvailableControllers={};Mi._Fallbacks={};Mi._ProfileLoadingPromises={};Mi.BaseRepositoryUrl="https://immersive-web.github.io/webxr-input-profiles/packages/viewer/dist";Mi.PrioritizeOnlineRepository=!0;Mi.UseOnlineRepository=!0;Mi.DisableControllerCache=!0;Mi.RegisterController(Ol.ProfileId,(a,e)=>new Ol(e,a.gamepad,a.handedness));Mi.DefaultFallbacks();let Ly=0;class By{constructor(e,t,i={}){this._scene=e,this.inputSource=t,this._options=i,this._tmpVector=new g,this._disposed=!1,this.onDisposeObservable=new X,this.onMeshLoadedObservable=new X,this.onMotionControllerInitObservable=new X,this._uniqueId=`controller-${Ly++}-${t.targetRayMode}-${t.handedness}`,this.pointer=new ct(`${this._uniqueId}-pointer`,e),this.pointer.rotationQuaternion=new Q,this.inputSource.gripSpace&&(this.grip=new ct(`${this._uniqueId}-grip`,this._scene),this.grip.rotationQuaternion=new Q),this._tmpVector.set(0,0,this._scene.useRightHandedSystem?-1:1),this.inputSource.gamepad&&this.inputSource.targetRayMode==="tracked-pointer"&&Mi.GetMotionControllerWithXRInput(t,e,this._options.forceControllerProfile).then(s=>{this.motionController=s,this.onMotionControllerInitObservable.notifyObservers(s),!this._options.doNotLoadControllerMesh&&!this.motionController._doNotLoadControllerMesh&&this.motionController.loadModel().then(r=>{var n;r&&this.motionController&&this.motionController.rootMesh&&(this._options.renderingGroupId&&(this.motionController.rootMesh.renderingGroupId=this._options.renderingGroupId,this.motionController.rootMesh.getChildMeshes(!1).forEach(o=>o.renderingGroupId=this._options.renderingGroupId)),this.onMeshLoadedObservable.notifyObservers(this.motionController.rootMesh),this.motionController.rootMesh.parent=this.grip||this.pointer,this.motionController.disableAnimation=!!this._options.disableMotionControllerAnimation),this._disposed&&((n=this.motionController)===null||n===void 0||n.dispose())})},()=>{q.Warn("Could not find a matching motion controller for the registered input source")})}get uniqueId(){return this._uniqueId}dispose(){this.grip&&this.grip.dispose(!0),this.motionController&&this.motionController.dispose(),this.pointer.dispose(!0),this.onMotionControllerInitObservable.clear(),this.onMeshLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this._disposed=!0}getWorldPointerRayToRef(e,t=!1){const i=t&&this.grip?this.grip:this.pointer;g.TransformNormalToRef(this._tmpVector,i.getWorldMatrix(),e.direction),e.direction.normalize(),e.origin.copyFrom(i.absolutePosition),e.length=1e3}updateFromXRFrame(e,t,i){const s=e.getPose(this.inputSource.targetRaySpace,t);if(this._lastXRPose=s,s){const r=s.transform.position;this.pointer.position.set(r.x,r.y,r.z);const n=s.transform.orientation;this.pointer.rotationQuaternion.set(n.x,n.y,n.z,n.w),this._scene.useRightHandedSystem||(this.pointer.position.z*=-1,this.pointer.rotationQuaternion.z*=-1,this.pointer.rotationQuaternion.w*=-1),this.pointer.parent=i.parent}if(this.inputSource.gripSpace&&this.grip){const r=e.getPose(this.inputSource.gripSpace,t);if(r){const n=r.transform.position,o=r.transform.orientation;this.grip.position.set(n.x,n.y,n.z),this.grip.rotationQuaternion.set(o.x,o.y,o.z,o.w),this._scene.useRightHandedSystem||(this.grip.position.z*=-1,this.grip.rotationQuaternion.z*=-1,this.grip.rotationQuaternion.w*=-1)}this.grip.parent=i.parent}this.motionController&&this.motionController.updateFromXRFrame(e)}}class Uy{constructor(e,t,i={}){if(this.xrSessionManager=e,this.xrCamera=t,this._options=i,this.controllers=[],this.onControllerAddedObservable=new X,this.onControllerRemovedObservable=new X,this._onInputSourcesChange=s=>{this._addAndRemoveControllers(s.added,s.removed)},this._sessionEndedObserver=this.xrSessionManager.onXRSessionEnded.add(()=>{this._addAndRemoveControllers([],this.controllers.map(s=>s.inputSource))}),this._sessionInitObserver=this.xrSessionManager.onXRSessionInit.add(s=>{s.addEventListener("inputsourceschange",this._onInputSourcesChange)}),this._frameObserver=this.xrSessionManager.onXRFrameObservable.add(s=>{this.controllers.forEach(r=>{r.updateFromXRFrame(s,this.xrSessionManager.referenceSpace,this.xrCamera)})}),this._options.customControllersRepositoryURL&&(Mi.BaseRepositoryUrl=this._options.customControllersRepositoryURL),Mi.UseOnlineRepository=!this._options.disableOnlineControllerRepository,Mi.UseOnlineRepository)try{Mi.UpdateProfilesList().catch(()=>{Mi.UseOnlineRepository=!1})}catch{Mi.UseOnlineRepository=!1}}_addAndRemoveControllers(e,t){const i=this.controllers.map(n=>n.inputSource);for(const n of e)if(i.indexOf(n)===-1){const o=new By(this.xrSessionManager.scene,n,{...this._options.controllerOptions||{},forceControllerProfile:this._options.forceInputProfile,doNotLoadControllerMesh:this._options.doNotLoadControllerMeshes,disableMotionControllerAnimation:this._options.disableControllerAnimation});this.controllers.push(o),this.onControllerAddedObservable.notifyObservers(o)}const s=[],r=[];this.controllers.forEach(n=>{t.indexOf(n.inputSource)===-1?s.push(n):r.push(n)}),this.controllers=s,r.forEach(n=>{this.onControllerRemovedObservable.notifyObservers(n),n.dispose()})}dispose(){this.controllers.forEach(e=>{e.dispose()}),this.xrSessionManager.onXRFrameObservable.remove(this._frameObserver),this.xrSessionManager.onXRSessionInit.remove(this._sessionInitObserver),this.xrSessionManager.onXRSessionEnded.remove(this._sessionEndedObserver),this.onControllerAddedObservable.clear(),this.onControllerRemovedObservable.clear(),Mi.ClearControllerCache()}}class Yr extends Ji{constructor(e,t){super(e),this._options=t,this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{laserPointer:s,selectionMesh:r}=this._generateNewMeshPair(i.pointer);switch(this._controllers[i.uniqueId]={xrController:i,laserPointer:s,selectionMesh:r,meshUnderPointer:null,pick:null,tmpRay:new $e(new g,new g),disabledByNearInteraction:!1,id:Yr._IdCounter++},this._attachedController?!this._options.enablePointerSelectionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enablePointerSelectionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachTrackedPointerRayMode(i);case"gaze":return this._attachGazeMode(i);case"screen":return this._attachScreenRayMode(i)}},this._controllers={},this._tmpVectorForPickCompare=new g,this.disablePointerLighting=!0,this.disableSelectionMeshLighting=!0,this.displayLaserPointer=!0,this.displaySelectionMesh=!0,this.laserPointerPickedColor=new re(.9,.9,.9),this.laserPointerDefaultColor=new re(.7,.7,.7),this.selectionMeshDefaultColor=new re(.8,.8,.8),this.selectionMeshPickedColor=new re(.3,.3,1),this._identityMatrix=L.Identity(),this._screenCoordinatesRef=g.Zero(),this._viewportRef=new Es(0,0,0,0),this._scene=this._xrSessionManager.scene}attach(){if(!super.attach())return!1;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,this._options.gazeCamera){const e=this._options.gazeCamera,{laserPointer:t,selectionMesh:i}=this._generateNewMeshPair(e);this._controllers.camera={webXRCamera:e,laserPointer:t,selectionMesh:i,meshUnderPointer:null,pick:null,tmpRay:new $e(new g,new g),disabledByNearInteraction:!1,id:Yr._IdCounter++},this._attachGazeMode()}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}_getPointerSelectionDisabledByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].disabledByNearInteraction;return!0}_setPointerSelectionDisabledByPointerId(e,t){const i=Object.keys(this._controllers);for(let s=0;s<i.length;++s)if(this._controllers[i[s]].id===e){this._controllers[i[s]].disabledByNearInteraction=t;return}}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{const i=this._controllers[t];if(!this._options.enablePointerSelectionOnAllControllers&&t!==this._attachedController||i.disabledByNearInteraction){i.selectionMesh.isVisible=!1,i.laserPointer.isVisible=!1,i.pick=null;return}i.laserPointer.isVisible=this.displayLaserPointer;let s;if(i.xrController)s=i.xrController.pointer.position,i.xrController.getWorldPointerRayToRef(i.tmpRay);else if(i.webXRCamera)s=i.webXRCamera.position,i.webXRCamera.getForwardRayToRef(i.tmpRay);else return;if(this._options.maxPointerDistance&&(i.tmpRay.length=this._options.maxPointerDistance),!this._options.disableScenePointerVectorUpdate&&s){const l=this._xrSessionManager.scene,h=this._options.xrInput.xrCamera;h&&(h.viewport.toGlobalToRef(l.getEngine().getRenderWidth(),l.getEngine().getRenderHeight(),this._viewportRef),g.ProjectToRef(s,this._identityMatrix,l.getTransformMatrix(),this._viewportRef,this._screenCoordinatesRef),typeof this._screenCoordinatesRef.x=="number"&&typeof this._screenCoordinatesRef.y=="number"&&!isNaN(this._screenCoordinatesRef.x)&&!isNaN(this._screenCoordinatesRef.y)&&(l.pointerX=this._screenCoordinatesRef.x,l.pointerY=this._screenCoordinatesRef.y,i.screenCoordinates={x:this._screenCoordinatesRef.x,y:this._screenCoordinatesRef.y}))}let r=null;this._utilityLayerScene&&(r=this._utilityLayerScene.pickWithRay(i.tmpRay,this._utilityLayerScene.pointerMovePredicate||this.raySelectionPredicate));const n=this._scene.pickWithRay(i.tmpRay,this._scene.pointerMovePredicate||this.raySelectionPredicate);!r||!r.hit?i.pick=n:!n||!n.hit||r.distance<n.distance?i.pick=r:i.pick=n,i.pick&&i.xrController&&(i.pick.aimTransform=i.xrController.pointer,i.pick.gripTransform=i.xrController.grip||null);const o=i.pick;if(o&&o.pickedPoint&&o.hit){this._updatePointerDistance(i.laserPointer,o.distance),i.selectionMesh.position.copyFrom(o.pickedPoint),i.selectionMesh.scaling.x=Math.sqrt(o.distance),i.selectionMesh.scaling.y=Math.sqrt(o.distance),i.selectionMesh.scaling.z=Math.sqrt(o.distance);const l=this._convertNormalToDirectionOfRay(o.getNormal(!0),i.tmpRay),h=.001;if(i.selectionMesh.position.copyFrom(o.pickedPoint),l){const c=g.Cross(ti.Y,l),u=g.Cross(l,c);g.RotationFromAxisToRef(u,l,c,i.selectionMesh.rotation),i.selectionMesh.position.addInPlace(l.scale(h))}i.selectionMesh.isVisible=this.displaySelectionMesh,i.meshUnderPointer=o.pickedMesh}else i.selectionMesh.isVisible=!1,this._updatePointerDistance(i.laserPointer,1),i.meshUnderPointer=null})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene}_attachGazeMode(e){const t=this._controllers[e&&e.uniqueId||"camera"],i=this._options.timeToSelect||3e3,s=this._options.useUtilityLayer?this._utilityLayerScene:this._scene;let r=new ki;const n=La("selection",{diameter:.0035*15,thickness:.0025*6,tessellation:20},s);n.isVisible=!1,n.isPickable=!1,n.parent=t.selectionMesh;let o=0,l=!1;const h={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{if(!!t.pick){if(this._augmentPointerInit(h,t.id,t.screenCoordinates),t.laserPointer.material.alpha=0,n.isVisible=!1,t.pick.hit)if(this._pickingMoved(r,t.pick))l&&(this._options.disablePointerUpOnTouchOut||this._scene.simulatePointerUp(t.pick,h)),l=!1,o=0;else if(o>i/10&&(n.isVisible=!0),o+=this._scene.getEngine().getDeltaTime(),o>=i)this._scene.simulatePointerDown(t.pick,h),l=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,h),n.isVisible=!1;else{const c=1-o/i;n.scaling.set(c,c,c)}else l=!1,o=0;this._scene.simulatePointerMove(t.pick,h),r=t.pick}}),this._options.renderingGroupId!==void 0&&(n.renderingGroupId=this._options.renderingGroupId),e&&e.onDisposeObservable.addOnce(()=>{t.pick&&!this._options.disablePointerUpOnTouchOut&&l&&(this._scene.simulatePointerUp(t.pick,h),t.finalPointerUpTriggered=!0),n.dispose()})}_attachScreenRayMode(e){const t=this._controllers[e.uniqueId];let i=!1;const s={pointerId:t.id,pointerType:"xr"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),!(!t.pick||this._options.disablePointerUpOnTouchOut&&i)&&(i?this._scene.simulatePointerMove(t.pick,s):(this._scene.simulatePointerDown(t.pick,s),t.pointerDownTriggered=!0,i=!0,this._options.disablePointerUpOnTouchOut&&this._scene.simulatePointerUp(t.pick,s)))}),e.onDisposeObservable.addOnce(()=>{this._augmentPointerInit(s,t.id,t.screenCoordinates),this._xrSessionManager.runInXRFrame(()=>{t.pick&&!t.finalPointerUpTriggered&&i&&!this._options.disablePointerUpOnTouchOut&&(this._scene.simulatePointerUp(t.pick,s),t.finalPointerUpTriggered=!0)})})}_attachTrackedPointerRayMode(e){const t=this._controllers[e.uniqueId];if(this._options.forceGazeMode)return this._attachGazeMode(e);const i={pointerId:t.id,pointerType:"xr"};if(t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{t.laserPointer.material.disableLighting=this.disablePointerLighting,t.selectionMesh.material.disableLighting=this.disableSelectionMeshLighting,t.pick&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerMove(t.pick,i))}),e.inputSource.gamepad){const s=r=>{this._options.overrideButtonId&&(t.selectionComponent=r.getComponent(this._options.overrideButtonId)),t.selectionComponent||(t.selectionComponent=r.getMainComponent()),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(n=>{if(n.changes.pressed){const o=n.changes.pressed.current;t.pick?(this._options.enablePointerSelectionOnAllControllers||e.uniqueId===this._attachedController)&&(this._augmentPointerInit(i,t.id,t.screenCoordinates),o?(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor):(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)):o&&!this._options.enablePointerSelectionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)}})};e.motionController?s(e.motionController):e.onMotionControllerInitObservable.add(s)}else{const s=n=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&n.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerDown(t.pick,i),t.pointerDownTriggered=!0,t.selectionMesh.material.emissiveColor=this.selectionMeshPickedColor,t.laserPointer.material.emissiveColor=this.laserPointerPickedColor)},r=n=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),t.xrController&&n.inputSource===t.xrController.inputSource&&t.pick&&(this._scene.simulatePointerUp(t.pick,i),t.selectionMesh.material.emissiveColor=this.selectionMeshDefaultColor,t.laserPointer.material.emissiveColor=this.laserPointerDefaultColor)};t.eventListeners={selectend:r,selectstart:s},this._xrSessionManager.session.addEventListener("selectstart",s),this._xrSessionManager.session.addEventListener("selectend",r)}}_convertNormalToDirectionOfRay(e,t){return e&&Math.acos(g.Dot(e,t.direction))<Math.PI/2&&e.scaleInPlace(-1),e}_detachController(e){const t=this._controllers[e];if(!!t){if(t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const s=t.eventListeners&&t.eventListeners[i];s&&this._xrSessionManager.session.removeEventListener(i,s)}),!t.finalPointerUpTriggered&&t.pointerDownTriggered){const i={pointerId:t.id,pointerType:"xr"};this._xrSessionManager.runInXRFrame(()=>{this._augmentPointerInit(i,t.id,t.screenCoordinates),this._scene.simulatePointerUp(t.pick||new ki,i),t.finalPointerUpTriggered=!0})}this._xrSessionManager.scene.onBeforeRenderObservable.addOnce(()=>{try{if(t.selectionMesh.dispose(),t.laserPointer.dispose(),delete this._controllers[e],this._attachedController===e){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}catch{q.Warn("controller already detached.")}})}}_generateNewMeshPair(e){const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene:this._scene,i=this._options.customLasterPointerMeshGenerator?this._options.customLasterPointerMeshGenerator():jl("laserPointer",{height:1,diameterTop:2e-4,diameterBottom:.004,tessellation:20,subdivisions:1},t);i.parent=e;const s=new pe("laserPointerMat",t);s.emissiveColor=this.laserPointerDefaultColor,s.alpha=.7,i.material=s,i.rotation.x=Math.PI/2,this._updatePointerDistance(i,1),i.isPickable=!1,i.isVisible=!1;const r=this._options.customSelectionMeshGenerator?this._options.customSelectionMeshGenerator():La("gazeTracker",{diameter:.0035*3,thickness:.0025*3,tessellation:20},t);r.bakeCurrentTransformIntoVertices(),r.isPickable=!1,r.isVisible=!1;const n=new pe("targetMat",t);return n.specularColor=re.Black(),n.emissiveColor=this.selectionMeshDefaultColor,n.backFaceCulling=!1,r.material=n,this._options.renderingGroupId!==void 0&&(i.renderingGroupId=this._options.renderingGroupId,r.renderingGroupId=this._options.renderingGroupId),{laserPointer:i,selectionMesh:r}}_pickingMoved(e,t){var i;if(!e.hit||!t.hit||!e.pickedMesh||!e.pickedPoint||!t.pickedMesh||!t.pickedPoint||e.pickedMesh!==t.pickedMesh)return!0;(i=e.pickedPoint)===null||i===void 0||i.subtractToRef(t.pickedPoint,this._tmpVectorForPickCompare),this._tmpVectorForPickCompare.set(Math.abs(this._tmpVectorForPickCompare.x),Math.abs(this._tmpVectorForPickCompare.y),Math.abs(this._tmpVectorForPickCompare.z));const s=(this._options.gazeModePointerMovedFactor||1)*.01*t.distance;return this._tmpVectorForPickCompare.length()>s}_updatePointerDistance(e,t=100){e.scaling.y=t,this._scene.useRightHandedSystem&&(t*=-1),e.position.z=t/2+.05}_augmentPointerInit(e,t,i){e.pointerId=t,e.pointerType="xr",i&&(e.screenX=i.x,e.screenY=i.y)}get lasterPointerDefaultColor(){return this.laserPointerDefaultColor}}Yr._IdCounter=200;Yr.Name=pt.POINTER_SELECTION;Yr.Version=1;ii.AddWebXRFeature(Yr.Name,(a,e)=>()=>new Yr(a,e),Yr.Version,!0);fs.prototype._projectOnTrianglesToRef=function(a,e,t,i,s,r){const n=G.Vector3[0],o=G.Vector3[1];let l=1/0;for(let h=this.indexStart;h<this.indexStart+this.indexCount-(3-i);h+=i){const c=t[h],u=t[h+1],d=t[h+2];if(s&&d===4294967295){h+=2;continue}const f=e[c],p=e[u],_=e[d];if(!f||!p||!_)continue;const m=g.ProjectOnTriangleToRef(a,f,p,_,o);m<l&&(n.copyFrom(o),l=m)}return r.copyFrom(n),l};fs.prototype._projectOnUnIndexedTrianglesToRef=function(a,e,t,i){const s=G.Vector3[0],r=G.Vector3[1];let n=1/0;for(let o=this.verticesStart;o<this.verticesStart+this.verticesCount;o+=3){const l=e[o],h=e[o+1],c=e[o+2],u=g.ProjectOnTriangleToRef(a,l,h,c,r);u<n&&(s.copyFrom(r),n=u)}return i.copyFrom(s),n};fs.prototype.projectToRef=function(a,e,t,i){const s=this.getMaterial();if(!s)return-1;let r=3,n=!1;switch(s.fillMode){case 3:case 5:case 6:case 8:return-1;case 7:r=1,n=!0;break}return s.fillMode===4?-1:!t.length&&this._mesh._unIndexed?this._projectOnUnIndexedTrianglesToRef(a,e,t,i):this._projectOnTrianglesToRef(a,e,t,r,n,i)};var Bs;(function(a){a[a.DEHYDRATED=0]="DEHYDRATED",a[a.HOVER=1]="HOVER",a[a.TOUCH=2]="TOUCH"})(Bs||(Bs={}));var ba;(function(a){a[a.DISABLED=0]="DISABLED",a[a.CENTERED_ON_CONTROLLER=1]="CENTERED_ON_CONTROLLER",a[a.CENTERED_IN_FRONT=2]="CENTERED_IN_FRONT"})(ba||(ba={}));class Kr extends Ji{constructor(e,t){super(e),this._options=t,this._tmpRay=new $e(new g,new g),this._attachController=i=>{if(this._controllers[i.uniqueId])return;const{touchCollisionMesh:s,touchCollisionMeshFunction:r,hydrateCollisionMeshFunction:n}=this._generateNewTouchPointMesh(),o=this._generateVisualCue();switch(this._controllers[i.uniqueId]={xrController:i,meshUnderPointer:null,nearInteractionTargetMesh:null,pick:null,stalePick:null,touchCollisionMesh:s,touchCollisionMeshFunction:r,hydrateCollisionMeshFunction:n,currentAnimationState:Bs.DEHYDRATED,grabRay:new $e(new g,new g),hoverInteraction:!1,nearInteraction:!1,grabInteraction:!1,id:Kr._IdCounter++,pickedPointVisualCue:o},this._attachedController?!this._options.enableNearInteractionOnAllControllers&&this._options.preferredHandedness&&i.inputSource.handedness===this._options.preferredHandedness&&(this._attachedController=i.uniqueId):this._options.enableNearInteractionOnAllControllers||(this._attachedController=i.uniqueId),i.inputSource.targetRayMode){case"tracked-pointer":return this._attachNearInteractionMode(i);case"gaze":return null;case"screen":return null}},this._controllers={},this._farInteractionFeature=null,this.selectionMeshDefaultColor=new re(.8,.8,.8),this.selectionMeshPickedColor=new re(.3,.3,1),this._hoverRadius=.1,this._pickRadius=.02,this._controllerPickRadius=.03,this._nearGrabLengthScale=5,this._scene=this._xrSessionManager.scene,this._options.nearInteractionControllerMode===void 0&&(this._options.nearInteractionControllerMode=ba.CENTERED_IN_FRONT),this._options.farInteractionFeature&&(this._farInteractionFeature=this._options.farInteractionFeature)}attach(){return super.attach()?(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._scene.constantlyUpdateMeshUnderPointer=!0,!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),!0):!1}getMeshUnderPointer(e){return this._controllers[e]?this._controllers[e].meshUnderPointer:null}getXRControllerByPointerId(e){const t=Object.keys(this._controllers);for(let i=0;i<t.length;++i)if(this._controllers[t[i]].id===e)return this._controllers[t[i]].xrController||null;return null}setFarInteractionFeature(e){this._farInteractionFeature=e}_nearPickPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearPickable}_nearGrabPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&e.isNearGrabbable}_nearInteractionPredicate(e){return e.isEnabled()&&e.isVisible&&e.isPickable&&(e.isNearPickable||e.isNearGrabbable)}_controllerAvailablePredicate(e,t){let i=e;for(;i;){if(i.reservedDataStore&&i.reservedDataStore.nearInteraction&&i.reservedDataStore.nearInteraction.excludedControllerId===t)return!1;i=i.parent}return!0}_handleTransitionAnimation(e,t){var i;if(!(e.currentAnimationState===t||this._options.nearInteractionControllerMode!==ba.CENTERED_IN_FRONT||!!(!((i=e.xrController)===null||i===void 0)&&i.inputSource.hand))){if(t>e.currentAnimationState)switch(e.currentAnimationState){case Bs.DEHYDRATED:if(e.hydrateCollisionMeshFunction(!0),t===Bs.HOVER)break;case Bs.HOVER:if(e.touchCollisionMeshFunction(!0),t===Bs.TOUCH)break}else switch(e.currentAnimationState){case Bs.TOUCH:if(e.touchCollisionMeshFunction(!1),t===Bs.HOVER)break;case Bs.HOVER:if(e.hydrateCollisionMeshFunction(!1),t===Bs.DEHYDRATED)break}e.currentAnimationState=t}}_processTouchPoint(e,t,i){var s;const r=this._controllers[e];r.grabRay.origin.copyFrom(t),i.toEulerAnglesToRef(G.Vector3[0]),r.grabRay.direction.copyFrom(G.Vector3[0]),this._options.nearInteractionControllerMode===ba.CENTERED_IN_FRONT&&!(!((s=r.xrController)===null||s===void 0)&&s.inputSource.hand)&&(r.xrController.getWorldPointerRayToRef(this._tmpRay),r.grabRay.origin.addInPlace(this._tmpRay.direction.scale(.05))),r.grabRay.length=this._nearGrabLengthScale*this._hoverRadius,r.touchCollisionMesh.position.copyFrom(r.grabRay.origin)}_onXRFrame(e){Object.keys(this._controllers).forEach(t=>{var i;const s=this._controllers[t],r=(i=s.xrController)===null||i===void 0?void 0:i.inputSource.hand;if(!this._options.enableNearInteractionOnAllControllers&&t!==this._attachedController||!s.xrController||!r&&(!this._options.nearInteractionControllerMode||!s.xrController.inputSource.gamepad)){s.pick=null;return}if(s.hoverInteraction=!1,s.nearInteraction=!1,s.xrController){if(r){const h=r.get("index-finger-tip");if(h){const c=e.getJointPose(h,this._xrSessionManager.referenceSpace);if(c&&c.transform){const u=this._scene.useRightHandedSystem?1:-1;G.Vector3[0].set(c.transform.position.x,c.transform.position.y,c.transform.position.z*u),G.Quaternion[0].set(c.transform.orientation.x,c.transform.orientation.y,c.transform.orientation.z*u,c.transform.orientation.w*u),this._processTouchPoint(t,G.Vector3[0],G.Quaternion[0])}}}else if(s.xrController.inputSource.gamepad&&this._options.nearInteractionControllerMode!==ba.DISABLED){let h=s.xrController.pointer;s.xrController.grip&&this._options.nearInteractionControllerMode===ba.CENTERED_ON_CONTROLLER&&(h=s.xrController.grip),this._processTouchPoint(t,h.position,h.rotationQuaternion)}}else return;const n=(h,c)=>{let u=null;return!c||!c.hit?u=h:!h||!h.hit||c.distance<h.distance?u=c:u=h,u},o=h=>{let c=new ki,u=!1;const d=h&&h.pickedPoint&&h.hit;return h!=null&&h.pickedPoint&&(u=h.pickedPoint.x===0&&h.pickedPoint.y===0&&h.pickedPoint.z===0),d&&!u&&(c=h),c};if(!s.grabInteraction){let h=null,c=null;this._options.useUtilityLayer&&this._utilityLayerScene&&(c=this._pickWithSphere(s,this._hoverRadius,this._utilityLayerScene,f=>this._nearInteractionPredicate(f)));const u=this._pickWithSphere(s,this._hoverRadius,this._scene,f=>this._nearInteractionPredicate(f)),d=n(u,c);if(d&&d.hit&&(h=o(d),h.hit&&(s.hoverInteraction=!0)),s.hoverInteraction){let f=null;const p=r?this._pickRadius:this._controllerPickRadius;this._options.useUtilityLayer&&this._utilityLayerScene&&(f=this._pickWithSphere(s,p,this._utilityLayerScene,x=>this._nearPickPredicate(x)));const _=this._pickWithSphere(s,p,this._scene,x=>this._nearPickPredicate(x)),m=n(_,f),v=o(m);v.hit&&(h=v,s.nearInteraction=!0)}s.stalePick=s.pick,s.pick=h,s.pick&&s.pick.pickedPoint&&s.pick.hit?(s.meshUnderPointer=s.pick.pickedMesh,s.pickedPointVisualCue.position.copyFrom(s.pick.pickedPoint),s.pickedPointVisualCue.isVisible=!0,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!0)):(s.meshUnderPointer=null,s.pickedPointVisualCue.isVisible=!1,this._farInteractionFeature&&this._farInteractionFeature.attached&&this._farInteractionFeature._setPointerSelectionDisabledByPointerId(s.id,!1))}let l=Bs.DEHYDRATED;s.grabInteraction||s.nearInteraction?l=Bs.TOUCH:s.hoverInteraction&&(l=Bs.HOVER),this._handleTransitionAnimation(s,l)})}get _utilityLayerScene(){return this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene}_generateVisualCue(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene:this._scene,t=qr("nearInteraction",{diameter:.0035*3},e);t.bakeCurrentTransformIntoVertices(),t.isPickable=!1,t.isVisible=!1,t.rotationQuaternion=Q.Identity();const i=new pe("targetMat",e);return i.specularColor=re.Black(),i.emissiveColor=this.selectionMeshDefaultColor,i.backFaceCulling=!1,t.material=i,t}_isControllerReadyForNearInteraction(e){return this._farInteractionFeature?this._farInteractionFeature._getPointerSelectionDisabledByPointerId(e):!0}_attachNearInteractionMode(e){const t=this._controllers[e.uniqueId],i={pointerId:t.id,pointerType:"xr-near"};t.onFrameObserver=this._xrSessionManager.onXRFrameObservable.add(()=>{!this._options.enableNearInteractionOnAllControllers&&e.uniqueId!==this._attachedController||!t.xrController||!t.xrController.inputSource.hand&&(!this._options.nearInteractionControllerMode||!t.xrController.inputSource.gamepad)||(t.pick&&(t.pick.ray=t.grabRay),t.pick&&this._isControllerReadyForNearInteraction(t.id)&&this._scene.simulatePointerMove(t.pick,i),t.nearInteraction&&t.pick&&t.pick.hit?t.nearInteractionTargetMesh||(this._scene.simulatePointerDown(t.pick,i),t.nearInteractionTargetMesh=t.meshUnderPointer):t.nearInteractionTargetMesh&&t.stalePick&&(this._scene.simulatePointerUp(t.stalePick,i),t.nearInteractionTargetMesh=null))});const s=r=>{this._options.enableNearInteractionOnAllControllers||e.uniqueId===this._attachedController&&this._isControllerReadyForNearInteraction(t.id)?(t.pick&&(t.pick.ray=t.grabRay),r&&t.pick&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)?(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i)):!r&&t.pick&&t.grabInteraction&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)):r&&!this._options.enableNearInteractionOnAllControllers&&!this._options.disableSwitchOnClick&&(this._attachedController=e.uniqueId)};if(e.inputSource.gamepad){const r=n=>{t.squeezeComponent=n.getComponent("grasp"),t.squeezeComponent?t.onSqueezeButtonChangedObserver=t.squeezeComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const l=o.changes.pressed.current;s(l)}}):(t.selectionComponent=n.getMainComponent(),t.onButtonChangedObserver=t.selectionComponent.onButtonStateChangedObservable.add(o=>{if(o.changes.pressed){const l=o.changes.pressed.current;s(l)}}))};e.motionController?r(e.motionController):e.onMotionControllerInitObservable.add(r)}else{const r=o=>{t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&t.meshUnderPointer&&this._nearGrabPredicate(t.meshUnderPointer)&&(t.grabInteraction=!0,t.pickedPointVisualCue.isVisible=!1,this._scene.simulatePointerDown(t.pick,i))},n=o=>{t.xrController&&o.inputSource===t.xrController.inputSource&&t.pick&&this._isControllerReadyForNearInteraction(t.id)&&(this._scene.simulatePointerUp(t.pick,i),t.grabInteraction=!1,t.pickedPointVisualCue.isVisible=!0)};t.eventListeners={selectend:n,selectstart:r},this._xrSessionManager.session.addEventListener("selectstart",r),this._xrSessionManager.session.addEventListener("selectend",n)}}_detachController(e){const t=this._controllers[e];if(!!t&&(t.squeezeComponent&&t.onSqueezeButtonChangedObserver&&t.squeezeComponent.onButtonStateChangedObservable.remove(t.onSqueezeButtonChangedObserver),t.selectionComponent&&t.onButtonChangedObserver&&t.selectionComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver),t.onFrameObserver&&this._xrSessionManager.onXRFrameObservable.remove(t.onFrameObserver),t.eventListeners&&Object.keys(t.eventListeners).forEach(i=>{const s=t.eventListeners&&t.eventListeners[i];s&&this._xrSessionManager.session.removeEventListener(i,s)}),t.touchCollisionMesh.dispose(),t.pickedPointVisualCue.dispose(),this._xrSessionManager.runInXRFrame(()=>{const i={pointerId:t.id,pointerType:"xr-near"};this._scene.simulatePointerUp(new ki,i)}),delete this._controllers[e],this._attachedController===e)){const i=Object.keys(this._controllers);i.length?this._attachedController=i[0]:this._attachedController=""}}_generateNewTouchPointMesh(){const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene:this._scene,t=qr("PickSphere",{diameter:1},e);t.isVisible=!1,this._options.motionControllerOrbMaterial?t.material=this._options.motionControllerOrbMaterial:di.ParseFromSnippetAsync("8RUNKL#3",e).then(A=>{t.material=A});const i=new l1;i.setEasingMode(cs.EASINGMODE_EASEINOUT);const s=new g(this._controllerPickRadius,this._controllerPickRadius,this._controllerPickRadius),r=this._controllerPickRadius*(4/3),n=new g(r,r,r),o=this._controllerPickRadius*(7/6),l=new g(o,o,o),h=this._controllerPickRadius*(4/5),c=new g(h,h,h),u=this._controllerPickRadius*(3/2),d=new g(u,u,u),f=[{frame:0,value:s},{frame:10,value:d},{frame:18,value:n}],p=[{frame:0,value:n},{frame:10,value:c},{frame:18,value:s}],_=[{frame:0,value:g.ZeroReadOnly},{frame:12,value:l},{frame:15,value:s}],m=[{frame:0,value:s},{frame:10,value:g.ZeroReadOnly},{frame:15,value:g.ZeroReadOnly}],v=new ae("touch","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),x=new ae("release","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),b=new ae("hydrate","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT),S=new ae("dehydrate","scaling",60,ae.ANIMATIONTYPE_VECTOR3,ae.ANIMATIONLOOPMODE_CONSTANT);return v.setEasingFunction(i),x.setEasingFunction(i),b.setEasingFunction(i),S.setEasingFunction(i),v.setKeys(f),x.setKeys(p),b.setKeys(_),S.setKeys(m),{touchCollisionMesh:t,touchCollisionMeshFunction:A=>{const M=A?v:x;e.beginDirectAnimation(t,[M],0,18,!1,1)},hydrateCollisionMeshFunction:A=>{const M=A?b:S;A&&(t.isVisible=!0),e.beginDirectAnimation(t,[M],0,15,!1,1,()=>{A||(t.isVisible=!1)})}}}_pickWithSphere(e,t,i,s){const r=new ki;if(r.distance=1/0,e.touchCollisionMesh&&e.xrController){const n=e.touchCollisionMesh.position,o=vn.CreateFromCenterAndRadius(n,t);for(let l=0;l<i.meshes.length;l++){const h=i.meshes[l];if(!s(h)||!this._controllerAvailablePredicate(h,e.xrController.uniqueId))continue;const c=Kr.PickMeshWithSphere(h,o);c&&c.hit&&c.distance<r.distance&&(r.hit=c.hit,r.pickedMesh=h,r.pickedPoint=c.pickedPoint,r.aimTransform=e.xrController.pointer,r.gripTransform=e.xrController.grip||null,r.originMesh=e.touchCollisionMesh,r.distance=c.distance)}}return r}static PickMeshWithSphere(e,t,i=!1){const s=e.subMeshes,r=new ki,n=e.getBoundingInfo();if(!e._generatePointsArray()||!e.subMeshes||!n||!i&&!vn.Intersects(n.boundingSphere,t))return r;const o=G.Vector3[0],l=G.Vector3[1];let h=1/0,c,u,d;const f=G.Vector3[2],p=G.Matrix[0];p.copyFrom(e.getWorldMatrix()),p.invert(),g.TransformCoordinatesToRef(t.center,p,f);for(let _=0;_<s.length;_++)s[_].projectToRef(f,e._positions,e.getIndices(),l),g.TransformCoordinatesToRef(l,e.getWorldMatrix(),l),c=g.Distance(l,t.center),d=g.Distance(l,e.getAbsolutePosition()),u=g.Distance(t.center,e.getAbsolutePosition()),u!==-1&&d!==-1&&d>u&&(c=0,l.copyFrom(t.center)),c!==-1&&c<h&&(h=c,o.copyFrom(l));return h<t.radius&&(r.hit=!0,r.distance=h,r.pickedMesh=e,r.pickedPoint=o.clone()),r}}Kr._IdCounter=200;Kr.Name=pt.NEAR_INTERACTION;Kr.Version=1;ii.AddWebXRFeature(Kr.Name,(a,e)=>()=>new Kr(a,e),Kr.Version,!0);class Vy{constructor(e,t,i){this.element=e,this.sessionMode=t,this.referenceSpaceType=i}update(e){}}class a0{constructor(e,t){if(this._scene=e,this.options=t,this._activeButton=null,this._buttons=[],this.activeButtonChangedObservable=new X,this._onSessionGranted=s=>{this._helper&&this._enterXRWithButtonIndex(0)},this.overlay=document.createElement("div"),this.overlay.classList.add("xr-button-overlay"),!t.ignoreSessionGrantedEvent&&navigator.xr&&navigator.xr.addEventListener("sessiongranted",this._onSessionGranted),typeof window<"u"&&window.location&&window.location.protocol==="http:"&&window.location.hostname!=="localhost")throw q.Warn("WebXR can only be served over HTTPS"),new Error("WebXR can only be served over HTTPS");if(t.customButtons)this._buttons=t.customButtons;else{this.overlay.style.cssText="z-index:11;position: absolute; right: 20px;bottom: 50px;";const s=t.sessionMode||"immersive-vr",r=t.referenceSpaceType||"local-floor";let o=".babylonVRicon { color: #868686; border-color: #868686; border-style: solid; margin-left: 10px; height: 50px; width: 80px; background-color: rgba(51,51,51,0.7); background-image: url("+(typeof SVGSVGElement>"u"?"https://cdn.babylonjs.com/Assets/vrButton.png":"data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%222048%22%20height%3D%221152%22%20viewBox%3D%220%200%202048%201152%22%20version%3D%221.1%22%3E%3Cpath%20transform%3D%22rotate%28180%201024%2C576.0000000000001%29%22%20d%3D%22m1109%2C896q17%2C0%2030%2C-12t13%2C-30t-12.5%2C-30.5t-30.5%2C-12.5l-170%2C0q-18%2C0%20-30.5%2C12.5t-12.5%2C30.5t13%2C30t30%2C12l170%2C0zm-85%2C256q59%2C0%20132.5%2C-1.5t154.5%2C-5.5t164.5%2C-11.5t163%2C-20t150%2C-30t124.5%2C-41.5q23%2C-11%2042%2C-24t38%2C-30q27%2C-25%2041%2C-61.5t14%2C-72.5l0%2C-257q0%2C-123%20-47%2C-232t-128%2C-190t-190%2C-128t-232%2C-47l-81%2C0q-37%2C0%20-68.5%2C14t-60.5%2C34.5t-55.5%2C45t-53%2C45t-53%2C34.5t-55.5%2C14t-55.5%2C-14t-53%2C-34.5t-53%2C-45t-55.5%2C-45t-60.5%2C-34.5t-68.5%2C-14l-81%2C0q-123%2C0%20-232%2C47t-190%2C128t-128%2C190t-47%2C232l0%2C257q0%2C68%2038%2C115t97%2C73q54%2C24%20124.5%2C41.5t150%2C30t163%2C20t164.5%2C11.5t154.5%2C5.5t132.5%2C1.5zm939%2C-298q0%2C39%20-24.5%2C67t-58.5%2C42q-54%2C23%20-122%2C39.5t-143.5%2C28t-155.5%2C19t-157%2C11t-148.5%2C5t-129.5%2C1.5q-59%2C0%20-130%2C-1.5t-148%2C-5t-157%2C-11t-155.5%2C-19t-143.5%2C-28t-122%2C-39.5q-34%2C-14%20-58.5%2C-42t-24.5%2C-67l0%2C-257q0%2C-106%2040.5%2C-199t110%2C-162.5t162.5%2C-109.5t199%2C-40l81%2C0q27%2C0%2052%2C14t50%2C34.5t51%2C44.5t55.5%2C44.5t63.5%2C34.5t74%2C14t74%2C-14t63.5%2C-34.5t55.5%2C-44.5t51%2C-44.5t50%2C-34.5t52%2C-14l14%2C0q37%2C0%2070%2C0.5t64.5%2C4.5t63.5%2C12t68%2C23q71%2C30%20128.5%2C78.5t98.5%2C110t63.5%2C133.5t22.5%2C149l0%2C257z%22%20fill%3D%22white%22%20/%3E%3C/svg%3E%0A")+"); background-size: 80%; background-repeat:no-repeat; background-position: center; border: none; outline: none; transition: transform 0.125s ease-out } .babylonVRicon:hover { transform: scale(1.05) } .babylonVRicon:active {background-color: rgba(51,51,51,1) } .babylonVRicon:focus {background-color: rgba(51,51,51,1) }";o+='.babylonVRicon.vrdisplaypresenting { background-image: none;} .vrdisplaypresenting::after { content: "EXIT"} .xr-error::after { content: "ERROR"}';const l=document.createElement("style");l.appendChild(document.createTextNode(o)),document.getElementsByTagName("head")[0].appendChild(l);const h=document.createElement("button");h.className="babylonVRicon",h.title=`${s} - ${r}`,this._buttons.push(new Vy(h,s,r)),this._buttons[this._buttons.length-1].update=function(c){this.element.style.display=c===null||c===this?"":"none",h.className="babylonVRicon"+(c===this?" vrdisplaypresenting":"")},this._updateButtons(null)}const i=e.getEngine().getInputElement();i&&i.parentNode&&(i.parentNode.appendChild(this.overlay),e.onDisposeObservable.addOnce(()=>{this.dispose()}))}async setHelperAsync(e,t){this._helper=e,this._renderTarget=t;const i=this._buttons.map(r=>e.sessionManager.isSessionSupportedAsync(r.sessionMode));e.onStateChangedObservable.add(r=>{r==Ti.NOT_IN_XR&&this._updateButtons(null)}),(await Promise.all(i)).forEach((r,n)=>{r?(this.overlay.appendChild(this._buttons[n].element),this._buttons[n].element.onclick=this._enterXRWithButtonIndex.bind(this,n)):q.Warn(`Session mode "${this._buttons[n].sessionMode}" not supported in browser`)})}static async CreateAsync(e,t,i){const s=new a0(e,i);return await s.setHelperAsync(t,i.renderTarget||void 0),s}async _enterXRWithButtonIndex(e=0){if(this._helper.state==Ti.IN_XR)await this._helper.exitXRAsync(),this._updateButtons(null);else if(this._helper.state==Ti.NOT_IN_XR)try{await this._helper.enterXRAsync(this._buttons[e].sessionMode,this._buttons[e].referenceSpaceType,this._renderTarget,{optionalFeatures:this.options.optionalFeatures,requiredFeatures:this.options.requiredFeatures}),this._updateButtons(this._buttons[e])}catch(t){this._updateButtons(null);const i=this._buttons[e].element,s=i.title;i.title="Error entering XR session : "+s,i.classList.add("xr-error"),this.options.onError&&this.options.onError(t)}}dispose(){const e=this._scene.getEngine().getInputElement();e&&e.parentNode&&e.parentNode.contains(this.overlay)&&e.parentNode.removeChild(this.overlay),this.activeButtonChangedObservable.clear(),navigator.xr.removeEventListener("sessiongranted",this._onSessionGranted)}_updateButtons(e){this._activeButton=e,this._buttons.forEach(t=>{t.update(this._activeButton)}),this.activeButtonChangedObservable.notifyObservers(this._activeButton)}}var ep;(function(a){a[a.INIT=0]="INIT",a[a.STARTED=1]="STARTED",a[a.ENDED=2]="ENDED"})(ep||(ep={}));function tp(a){var e;let t=0;const i=Date.now();a.observableParameters=(e=a.observableParameters)!==null&&e!==void 0?e:{};const s=a.contextObservable.add(r=>{const n=Date.now();t=n-i;const o={startTime:i,currentTime:n,deltaTime:t,completeRate:t/a.timeout,payload:r};a.onTick&&a.onTick(o),a.breakCondition&&a.breakCondition()&&(a.contextObservable.remove(s),a.onAborted&&a.onAborted(o)),t>=a.timeout&&(a.contextObservable.remove(s),a.onEnded&&a.onEnded(o))},a.observableParameters.mask,a.observableParameters.insertFirst,a.observableParameters.scope);return s}class vo extends Ji{constructor(e,t){super(e),this._options=t,this._controllers={},this._snappedToPoint=!1,this._tmpRay=new $e(new g,new g),this._tmpVector=new g,this._tmpQuaternion=new Q,this.skipNextTeleportation=!1,this.backwardsMovementEnabled=!0,this.backwardsTeleportationDistance=.7,this.parabolicCheckRadius=5,this.parabolicRayEnabled=!0,this.straightRayEnabled=!0,this.rotationAngle=Math.PI/8,this.onTargetMeshPositionUpdatedObservable=new X,this.teleportationEnabled=!0,this._rotationEnabled=!0,this._attachController=i=>{if(this._controllers[i.uniqueId]||this._options.forceHandedness&&i.inputSource.handedness!==this._options.forceHandedness)return;this._controllers[i.uniqueId]={xrController:i,teleportationState:{forward:!1,backwards:!1,rotating:!1,currentRotation:0,baseRotation:0}};const s=this._controllers[i.uniqueId];if(s.xrController.inputSource.targetRayMode==="tracked-pointer"&&s.xrController.inputSource.gamepad){const r=()=>{if(i.motionController){const n=i.motionController.getComponentOfType(zs.THUMBSTICK_TYPE)||i.motionController.getComponentOfType(zs.TOUCHPAD_TYPE);if(!n||this._options.useMainComponentOnly){const o=i.motionController.getMainComponent();if(!o)return;s.teleportationComponent=o,s.onButtonChangedObserver=o.onButtonStateChangedObservable.add(()=>{if(!!this.teleportationEnabled&&o.changes.pressed)if(o.changes.pressed.current){s.teleportationState.forward=!0,this._currentTeleportationControllerId=s.xrController.uniqueId,s.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,s.teleportationState.currentRotation=0;const l=this._options.timeToTeleport||3e3;tp({timeout:l,contextObservable:this._xrSessionManager.onXRFrameObservable,breakCondition:()=>!o.pressed,onEnded:()=>{this._currentTeleportationControllerId===s.xrController.uniqueId&&s.teleportationState.forward&&this._teleportForward(i.uniqueId)}})}else s.teleportationState.forward=!1,this._currentTeleportationControllerId=""})}else s.teleportationComponent=n,s.onAxisChangedObserver=n.onAxisValueChangedObservable.add(o=>{if(o.y<=.7&&s.teleportationState.backwards&&(s.teleportationState.backwards=!1),o.y>.7&&!s.teleportationState.forward&&this.backwardsMovementEnabled&&!this.snapPointsOnly&&!s.teleportationState.backwards){s.teleportationState.backwards=!0,this._tmpQuaternion.copyFrom(this._options.xrInput.xrCamera.rotationQuaternion),this._tmpQuaternion.toEulerAnglesToRef(this._tmpVector),this._tmpVector.x=0,this._tmpVector.z=0,Q.FromEulerVectorToRef(this._tmpVector,this._tmpQuaternion),this._tmpVector.set(0,0,this.backwardsTeleportationDistance*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),this._tmpVector.rotateByQuaternionToRef(this._tmpQuaternion,this._tmpVector),this._tmpVector.addInPlace(this._options.xrInput.xrCamera.position),this._tmpRay.origin.copyFrom(this._tmpVector),this._tmpRay.length=this._options.xrInput.xrCamera.realWorldHeight+.1,this._tmpRay.direction.set(0,-1,0);const l=this._xrSessionManager.scene.pickWithRay(this._tmpRay,h=>this._floorMeshes.indexOf(h)!==-1);l&&l.pickedPoint&&(this._options.xrInput.xrCamera.position.x=l.pickedPoint.x,this._options.xrInput.xrCamera.position.z=l.pickedPoint.z)}if(o.y<-.7&&!this._currentTeleportationControllerId&&!s.teleportationState.rotating&&this.teleportationEnabled&&(s.teleportationState.forward=!0,this._currentTeleportationControllerId=s.xrController.uniqueId,s.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y),o.x){if(s.teleportationState.forward)this._currentTeleportationControllerId===s.xrController.uniqueId&&(this.rotationEnabled?setTimeout(()=>{s.teleportationState.currentRotation=Math.atan2(o.x,o.y*(this._xrSessionManager.scene.useRightHandedSystem?1:-1))}):s.teleportationState.currentRotation=0);else if(!s.teleportationState.rotating&&Math.abs(o.x)>.7){s.teleportationState.rotating=!0;const l=this.rotationAngle*(o.x>0?1:-1)*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);Q.FromEulerAngles(0,l,0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion)}}else s.teleportationState.rotating=!1;o.x===0&&o.y===0&&s.teleportationState.forward&&this._teleportForward(i.uniqueId)})}};i.motionController?r():i.onMotionControllerInitObservable.addOnce(()=>{r()})}else this._xrSessionManager.scene.onPointerObservable.add(r=>{if(r.type===Ce.POINTERDOWN){s.teleportationState.forward=!0,this._currentTeleportationControllerId=s.xrController.uniqueId,s.teleportationState.baseRotation=this._options.xrInput.xrCamera.rotationQuaternion.toEulerAngles().y,s.teleportationState.currentRotation=0;const n=this._options.timeToTeleport||3e3;tp({timeout:n,contextObservable:this._xrSessionManager.onXRFrameObservable,onEnded:()=>{this._currentTeleportationControllerId===s.xrController.uniqueId&&s.teleportationState.forward&&this._teleportForward(i.uniqueId)}})}else r.type===Ce.POINTERUP&&(s.teleportationState.forward=!1,this._currentTeleportationControllerId="")})},this._options.teleportationTargetMesh||this._createDefaultTargetMesh(),this._floorMeshes=this._options.floorMeshes||[],this._snapToPositions=this._options.snapPositions||[],this._setTargetMeshVisibility(!1)}get rotationEnabled(){return this._rotationEnabled}set rotationEnabled(e){if(this._rotationEnabled=e,this._options.teleportationTargetMesh){const t=this._options.teleportationTargetMesh.getChildMeshes(!1,i=>i.name==="rotationCone");t[0]&&t[0].setEnabled(e)}}get teleportationTargetMesh(){return this._options.teleportationTargetMesh||null}get snapPointsOnly(){return!!this._options.snapPointsOnly}set snapPointsOnly(e){this._options.snapPointsOnly=e}addFloorMesh(e){this._floorMeshes.push(e)}addBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[],this._options.pickBlockerMeshes.push(e)}addSnapPoint(e){this._snapToPositions.push(e)}attach(){return super.attach()?(this._currentTeleportationControllerId="",this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._setTargetMeshVisibility(!1),this._currentTeleportationControllerId="",this._controllers={},!0):!1}dispose(){super.dispose(),this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.dispose(!1,!0)}removeFloorMesh(e){const t=this._floorMeshes.indexOf(e);t!==-1&&this._floorMeshes.splice(t,1)}removeBlockerMesh(e){this._options.pickBlockerMeshes=this._options.pickBlockerMeshes||[];const t=this._options.pickBlockerMeshes.indexOf(e);t!==-1&&this._options.pickBlockerMeshes.splice(t,1)}removeFloorMeshByName(e){const t=this._xrSessionManager.scene.getMeshByName(e);t&&this.removeFloorMesh(t)}removeSnapPoint(e){let t=this._snapToPositions.indexOf(e);if(t===-1){for(let i=0;i<this._snapToPositions.length;++i)if(this._snapToPositions[i].equals(e)){t=i;break}}return t!==-1?(this._snapToPositions.splice(t,1),!0):!1}setSelectionFeature(e){this._selectionFeature=e}_onXRFrame(e){const t=this._xrSessionManager.currentFrame,i=this._xrSessionManager.scene;if(!this.attach||!t)return;const s=this._options.teleportationTargetMesh;if(this._currentTeleportationControllerId){if(!s)return;s.rotationQuaternion=s.rotationQuaternion||new Q;const r=this._controllers[this._currentTeleportationControllerId];if(r&&r.teleportationState.forward){Q.RotationYawPitchRollToRef(r.teleportationState.currentRotation+r.teleportationState.baseRotation,0,0,s.rotationQuaternion);let n=!1;if(r.xrController.getWorldPointerRayToRef(this._tmpRay),this.straightRayEnabled){const o=i.pickWithRay(this._tmpRay,l=>{if(this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(l)!==-1)return!0;const h=this._floorMeshes.indexOf(l);return h===-1?!1:this._floorMeshes[h].absolutePosition.y<this._options.xrInput.xrCamera.globalPosition.y});if(o&&o.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(o.pickedMesh)!==-1)return;o&&o.pickedPoint&&(n=!0,this._setTargetMeshPosition(o),this._setTargetMeshVisibility(!0),this._showParabolicPath(o))}if(this.parabolicRayEnabled&&!n){const o=r.xrController.pointer.rotationQuaternion.toEulerAngles().x,l=1+(Math.PI/2-Math.abs(o)),h=this.parabolicCheckRadius*l;this._tmpRay.origin.addToRef(this._tmpRay.direction.scale(h*2),this._tmpVector),this._tmpVector.y=this._tmpRay.origin.y,this._tmpRay.origin.addInPlace(this._tmpRay.direction.scale(h)),this._tmpVector.subtractToRef(this._tmpRay.origin,this._tmpRay.direction),this._tmpRay.direction.normalize();const c=i.pickWithRay(this._tmpRay,u=>this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(u)!==-1?!0:this._floorMeshes.indexOf(u)!==-1);if(c&&c.pickedMesh&&this._options.pickBlockerMeshes&&this._options.pickBlockerMeshes.indexOf(c.pickedMesh)!==-1)return;c&&c.pickedPoint&&(n=!0,this._setTargetMeshPosition(c),this._setTargetMeshVisibility(!0),this._showParabolicPath(c))}this._setTargetMeshVisibility(n)}else this._setTargetMeshVisibility(!1)}else this._setTargetMeshVisibility(!1)}_createDefaultTargetMesh(){this._options.defaultTargetMeshOptions=this._options.defaultTargetMeshOptions||{};const e=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,t=Wc("teleportationTarget",{width:2,height:2,subdivisions:2},e);if(t.isPickable=!1,this._options.defaultTargetMeshOptions.teleportationCircleMaterial)t.material=this._options.defaultTargetMeshOptions.teleportationCircleMaterial;else{const n=new ta("teleportationPlaneDynamicTexture",512,e,!0);n.hasAlpha=!0;const o=n.getContext(),l=512/2,h=512/2,c=200;o.beginPath(),o.arc(l,h,c,0,2*Math.PI,!1),o.fillStyle=this._options.defaultTargetMeshOptions.teleportationFillColor||"#444444",o.fill(),o.lineWidth=10,o.strokeStyle=this._options.defaultTargetMeshOptions.teleportationBorderColor||"#FFFFFF",o.stroke(),o.closePath(),n.update();const u=new pe("teleportationPlaneMaterial",e);u.diffuseTexture=n,t.material=u}const i=La("torusTeleportation",{diameter:.75,thickness:.1,tessellation:20},e);if(i.isPickable=!1,i.parent=t,!this._options.defaultTargetMeshOptions.disableAnimation){const r=new ae("animationInnerCircle","position.y",30,ae.ANIMATIONTYPE_FLOAT,ae.ANIMATIONLOOPMODE_CYCLE),n=[];n.push({frame:0,value:0}),n.push({frame:30,value:.4}),n.push({frame:60,value:0}),r.setKeys(n);const o=new C_;o.setEasingMode(cs.EASINGMODE_EASEINOUT),r.setEasingFunction(o),i.animations=[],i.animations.push(r),e.beginAnimation(i,0,60,!0)}const s=jl("rotationCone",{diameterTop:0,tessellation:4},e);if(s.isPickable=!1,s.scaling.set(.5,.12,.2),s.rotate(ti.X,Math.PI/2),s.position.z=.6,s.parent=i,this._options.defaultTargetMeshOptions.torusArrowMaterial)i.material=this._options.defaultTargetMeshOptions.torusArrowMaterial,s.material=this._options.defaultTargetMeshOptions.torusArrowMaterial;else{const r=new pe("torusConsMat",e);r.disableLighting=!!this._options.defaultTargetMeshOptions.disableLighting,r.disableLighting?r.emissiveColor=new re(.3,.3,1):r.diffuseColor=new re(.3,.3,1),r.alpha=.9,i.material=r,s.material=r,this._teleportationRingMaterial=r}this._options.renderingGroupId!==void 0&&(t.renderingGroupId=this._options.renderingGroupId,i.renderingGroupId=this._options.renderingGroupId,s.renderingGroupId=this._options.renderingGroupId),this._options.teleportationTargetMesh=t}_detachController(e){const t=this._controllers[e];!t||(t.teleportationComponent&&(t.onAxisChangedObserver&&t.teleportationComponent.onAxisValueChangedObservable.remove(t.onAxisChangedObserver),t.onButtonChangedObserver&&t.teleportationComponent.onButtonStateChangedObservable.remove(t.onButtonChangedObserver)),delete this._controllers[e])}_findClosestSnapPointWithRadius(e,t=this._options.snapToPositionRadius||.8){let i=null,s=Number.MAX_VALUE;if(this._snapToPositions.length){const r=t*t;this._snapToPositions.forEach(n=>{const o=g.DistanceSquared(n,e);o<=r&&o<s&&(s=o,i=n)})}return i}_setTargetMeshPosition(e){const t=e.pickedPoint;if(!this._options.teleportationTargetMesh||!t)return;const i=this._findClosestSnapPointWithRadius(t);this._snappedToPoint=!!i,this.snapPointsOnly&&!this._snappedToPoint&&this._teleportationRingMaterial?this._teleportationRingMaterial.diffuseColor.set(1,.3,.3):this.snapPointsOnly&&this._snappedToPoint&&this._teleportationRingMaterial&&this._teleportationRingMaterial.diffuseColor.set(.3,.3,1),this._options.teleportationTargetMesh.position.copyFrom(i||t),this._options.teleportationTargetMesh.position.y+=.01,this.onTargetMeshPositionUpdatedObservable.notifyObservers(e)}_setTargetMeshVisibility(e){!this._options.teleportationTargetMesh||this._options.teleportationTargetMesh.isVisible!==e&&(this._options.teleportationTargetMesh.isVisible=e,this._options.teleportationTargetMesh.getChildren(void 0,!1).forEach(t=>{t.isVisible=e}),e?this._selectionFeature&&this._selectionFeature.detach():(this._quadraticBezierCurve&&(this._quadraticBezierCurve.dispose(),this._quadraticBezierCurve=null),this._selectionFeature&&this._selectionFeature.attach()))}_showParabolicPath(e){if(!e.pickedPoint)return;const t=this._options.useUtilityLayer?this._options.customUtilityLayerScene||ci.DefaultUtilityLayer.utilityLayerScene:this._xrSessionManager.scene,i=this._controllers[this._currentTeleportationControllerId],s=hn.CreateQuadraticBezier(i.xrController.pointer.absolutePosition,e.ray.origin,e.pickedPoint,25);this._options.generateRayPathMesh?this._quadraticBezierCurve=this._options.generateRayPathMesh(s.getPoints(),e):this._quadraticBezierCurve=Kc("teleportation path line",{points:s.getPoints(),instance:this._quadraticBezierCurve,updatable:!0},t),this._quadraticBezierCurve.isPickable=!1,this._options.renderingGroupId!==void 0&&(this._quadraticBezierCurve.renderingGroupId=this._options.renderingGroupId)}_teleportForward(e){const t=this._controllers[e];if(!(!t||!t.teleportationState.forward||!this.teleportationEnabled)&&(t.teleportationState.forward=!1,this._currentTeleportationControllerId="",!(this.snapPointsOnly&&!this._snappedToPoint))){if(this.skipNextTeleportation){this.skipNextTeleportation=!1;return}if(this._options.teleportationTargetMesh&&this._options.teleportationTargetMesh.isVisible){const i=this._options.xrInput.xrCamera.realWorldHeight;this._options.xrInput.xrCamera.onBeforeCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position),this._options.xrInput.xrCamera.position.copyFrom(this._options.teleportationTargetMesh.position),this._options.xrInput.xrCamera.position.y+=i,Q.FromEulerAngles(0,t.teleportationState.currentRotation-(this._xrSessionManager.scene.useRightHandedSystem?Math.PI:0),0).multiplyToRef(this._options.xrInput.xrCamera.rotationQuaternion,this._options.xrInput.xrCamera.rotationQuaternion),this._options.xrInput.xrCamera.onAfterCameraTeleport.notifyObservers(this._options.xrInput.xrCamera.position)}}}}vo.Name=pt.TELEPORTATION;vo.Version=1;ii.AddWebXRFeature(vo.Name,(a,e)=>()=>new vo(a,e),vo.Version,!0);class o0{constructor(){}static CreateAsync(e,t={}){const i=new o0;if(e.onDisposeObservable.addOnce(()=>{i.dispose()}),!t.disableDefaultUI){const s={renderTarget:i.renderTarget,...t.uiOptions||{}};t.optionalFeatures&&(typeof t.optionalFeatures=="boolean"?s.optionalFeatures=["hit-test","anchors","plane-detection","hand-tracking"]:s.optionalFeatures=t.optionalFeatures),i.enterExitUI=new a0(e,s)}return n0.CreateAsync(e).then(s=>{if(i.baseExperience=s,t.ignoreNativeCameraTransformation&&(i.baseExperience.camera.compensateOnFirstFrame=!1),i.input=new Uy(s.sessionManager,s.camera,{controllerOptions:{renderingGroupId:t.renderingGroupId},...t.inputOptions||{}}),!t.disablePointerSelection){const r={...t.pointerSelectionOptions,xrInput:i.input,renderingGroupId:t.renderingGroupId};i.pointerSelection=i.baseExperience.featuresManager.enableFeature(Yr.Name,t.useStablePlugins?"stable":"latest",r),t.disableTeleportation||(i.teleportation=i.baseExperience.featuresManager.enableFeature(vo.Name,t.useStablePlugins?"stable":"latest",{floorMeshes:t.floorMeshes,xrInput:i.input,renderingGroupId:t.renderingGroupId,...t.teleportationOptions}),i.teleportation.setSelectionFeature(i.pointerSelection))}if(t.disableNearInteraction||(i.nearInteraction=i.baseExperience.featuresManager.enableFeature(Kr.Name,t.useStablePlugins?"stable":"latest",{xrInput:i.input,farInteractionFeature:i.pointerSelection,renderingGroupId:t.renderingGroupId,useUtilityLayer:!0,enableNearInteractionOnAllControllers:!0,...t.nearInteractionOptions})),i.renderTarget=i.baseExperience.sessionManager.getWebXRRenderTarget(t.outputCanvasOptions),!t.disableDefaultUI)return i.enterExitUI.setHelperAsync(i.baseExperience,i.renderTarget)}).then(()=>i).catch(s=>(B.Error("Error initializing XR"),B.Error(s),i))}dispose(){this.baseExperience&&this.baseExperience.dispose(),this.input&&this.input.dispose(),this.enterExitUI&&this.enterExitUI.dispose(),this.renderTarget&&this.renderTarget.dispose()}}ge.prototype.createDefaultLight=function(a=!1){if(a&&this.lights)for(let e=0;e<this.lights.length;e++)this.lights[e].dispose();this.lights.length===0&&new ea("default light",g.Up(),this)};ge.prototype.createDefaultCamera=function(a=!1,e=!1,t=!1){if(e&&this.activeCamera&&(this.activeCamera.dispose(),this.activeCamera=null),!this.activeCamera){const i=this.getWorldExtends(l=>l.isVisible&&l.isEnabled()),s=i.max.subtract(i.min),r=i.min.add(s.scale(.5));let n,o=s.length()*1.5;if(isFinite(o)||(o=1,r.copyFromFloats(0,0,0)),a){const l=new yt("default camera",-(Math.PI/2),Math.PI/2,o,r,this);l.lowerRadiusLimit=o*.01,l.wheelPrecision=100/o,n=l}else{const l=new ws("default camera",new g(r.x,r.y,-o),this);l.setTarget(r),n=l}n.minZ=o*.01,n.maxZ=o*1e3,n.speed=o*.2,this.activeCamera=n,t&&n.attachControl()}};ge.prototype.createDefaultCameraOrLight=function(a=!1,e=!1,t=!1){this.createDefaultLight(e),this.createDefaultCamera(a,e,t)};ge.prototype.createDefaultSkybox=function(a,e=!1,t=1e3,i=0,s=!0){if(!a)return B.Warn("Can not create default skybox without environment texture."),null;s&&a&&(this.environmentTexture=a);const r=Yc("hdrSkyBox",{size:t},this);if(e){const n=new Ue("skyBox",this);n.backFaceCulling=!1,n.reflectionTexture=a.clone(),n.reflectionTexture&&(n.reflectionTexture.coordinatesMode=H.SKYBOX_MODE),n.microSurface=1-i,n.disableLighting=!0,n.twoSidedLighting=!0,r.material=n}else{const n=new pe("skyBox",this);n.backFaceCulling=!1,n.reflectionTexture=a.clone(),n.reflectionTexture&&(n.reflectionTexture.coordinatesMode=H.SKYBOX_MODE),n.disableLighting=!0,r.material=n}return r.isPickable=!1,r.infiniteDistance=!0,r.ignoreCameraMaxZ=!0,r};ge.prototype.createDefaultEnvironment=function(a){return Va?new Va(a,this):null};ge.prototype.createDefaultVRExperience=function(a={}){return new Io(this,a)};ge.prototype.createDefaultXRExperienceAsync=function(a={}){return o0.CreateAsync(this,a).then(e=>e)};function ip(a){for(;a.firstChild;)a.removeChild(a.firstChild);a.srcObject=null,a.src="",a.removeAttribute("src")}class ec extends H{constructor(e,t,i,s=!1,r=!1,n=H.TRILINEAR_SAMPLINGMODE,o={},l){super(null,i,!s,r),this._onUserActionRequestedObservable=null,this._stillImageCaptured=!1,this._displayingPosterTexture=!1,this._frameId=-1,this._currentSrc=null,this._errorFound=!1,this._createInternalTexture=()=>{if(this._texture!=null)if(this._displayingPosterTexture)this._texture.dispose(),this._displayingPosterTexture=!1;else return;if(!this._getEngine().needPOTTextures||q.IsExponentOfTwo(this.video.videoWidth)&&q.IsExponentOfTwo(this.video.videoHeight)?(this.wrapU=H.WRAP_ADDRESSMODE,this.wrapV=H.WRAP_ADDRESSMODE):(this.wrapU=H.CLAMP_ADDRESSMODE,this.wrapV=H.CLAMP_ADDRESSMODE,this._generateMipMaps=!1),this._texture=this._getEngine().createDynamicTexture(this.video.videoWidth,this.video.videoHeight,this._generateMipMaps,this.samplingMode),!this.video.autoplay&&!this._settings.poster){const c=this.video.onplaying,u=this.video.muted;this.video.muted=!0,this.video.onplaying=()=>{this.video.muted=u,this.video.onplaying=c,this._updateInternalTexture(),this._errorFound||this.video.pause(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._handlePlay()}else this._updateInternalTexture(),this.onLoadObservable.hasObservers()&&this.onLoadObservable.notifyObservers(this)},this._reset=()=>{this._texture!=null&&(this._displayingPosterTexture||(this._texture.dispose(),this._texture=null))},this._updateInternalTexture=()=>{if(this._texture==null||this.video.readyState<this.video.HAVE_CURRENT_DATA||this._displayingPosterTexture)return;const c=this.getScene().getFrameId();this._frameId!==c&&(this._frameId=c,this._getEngine().updateVideoTexture(this._texture,this.video,this._invertY))},this._settings={autoPlay:!0,loop:!0,autoUpdateTexture:!0,...o},this._onError=l,this._generateMipMaps=s,this._initialSamplingMode=n,this.autoUpdateTexture=this._settings.autoUpdateTexture,this._currentSrc=t,this.name=e||this._getName(t),this.video=this._getVideo(t),this._settings.poster&&(this.video.poster=this._settings.poster),this._settings.autoPlay!==void 0&&(this.video.autoplay=this._settings.autoPlay),this._settings.loop!==void 0&&(this.video.loop=this._settings.loop),this._settings.muted!==void 0&&(this.video.muted=this._settings.muted),this.video.setAttribute("playsinline",""),this.video.addEventListener("paused",this._updateInternalTexture),this.video.addEventListener("seeked",this._updateInternalTexture),this.video.addEventListener("emptied",this._reset),this._createInternalTextureOnEvent=this._settings.poster&&!this._settings.autoPlay?"play":"canplay",this.video.addEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this._settings.autoPlay&&this._handlePlay();const h=this.video.readyState>=this.video.HAVE_CURRENT_DATA;this._settings.poster&&(!this._settings.autoPlay||!h)?(this._texture=this._getEngine().createTexture(this._settings.poster,!1,!this.invertY,i),this._displayingPosterTexture=!0):h&&this._createInternalTexture()}get onUserActionRequestedObservable(){return this._onUserActionRequestedObservable||(this._onUserActionRequestedObservable=new X),this._onUserActionRequestedObservable}_processError(e){this._errorFound=!0,this._onError?this._onError(e==null?void 0:e.message):B.Error(e==null?void 0:e.message)}_handlePlay(){this._errorFound=!1,this.video.play().catch(e=>{if((e==null?void 0:e.name)==="NotAllowedError"){if(this._onUserActionRequestedObservable&&this._onUserActionRequestedObservable.hasObservers()){this._onUserActionRequestedObservable.notifyObservers(this);return}else if(!this.video.muted){B.Warn("Unable to autoplay a video with sound. Trying again with muted turned true"),this.video.muted=!0,this._errorFound=!1,this.video.play().catch(t=>{this._processError(t)});return}}this._processError(e)})}getClassName(){return"VideoTexture"}_getName(e){return e instanceof HTMLVideoElement?e.currentSrc:typeof e=="object"?e.toString():e}_getVideo(e){if(e.isNative)return e;if(e instanceof HTMLVideoElement)return q.SetCorsBehavior(e.currentSrc,e),e;const t=document.createElement("video");return typeof e=="string"?(q.SetCorsBehavior(e,t),t.src=e):(q.SetCorsBehavior(e[0],t),e.forEach(i=>{const s=document.createElement("source");s.src=i,t.appendChild(s)})),this.onDisposeObservable.addOnce(()=>{ip(t)}),t}_rebuild(){this.update()}update(){!this.autoUpdateTexture||this.updateTexture(!0)}updateTexture(e){!e||this.video.paused&&this._stillImageCaptured||(this._stillImageCaptured=!0,this._updateInternalTexture())}updateURL(e){this.video.src=e,this._currentSrc=e}clone(){return new ec(this.name,this._currentSrc,this.getScene(),this._generateMipMaps,this.invertY,this.samplingMode,this._settings)}dispose(){super.dispose(),this._currentSrc=null,this._onUserActionRequestedObservable&&(this._onUserActionRequestedObservable.clear(),this._onUserActionRequestedObservable=null),this.video.removeEventListener(this._createInternalTextureOnEvent,this._createInternalTexture),this.video.removeEventListener("paused",this._updateInternalTexture),this.video.removeEventListener("seeked",this._updateInternalTexture),this.video.removeEventListener("emptied",this._reset),this.video.pause()}static CreateFromStreamAsync(e,t,i,s=!0){const r=e.getEngine().createVideoElement(i);return e.getEngine()._badOS&&(document.body.appendChild(r),r.style.transform="scale(0.0001, 0.0001)",r.style.opacity="0",r.style.position="fixed",r.style.bottom="0px",r.style.right="0px"),r.setAttribute("autoplay",""),r.setAttribute("muted","true"),r.setAttribute("playsinline",""),r.muted=!0,r.isNative||(r.mozSrcObject!==void 0?r.mozSrcObject=t:typeof r.srcObject=="object"?r.srcObject=t:r.src=window.URL&&window.URL.createObjectURL(t)),new Promise(n=>{const o=()=>{const l=new ec("video",r,e,!0,s);e.getEngine()._badOS&&l.onDisposeObservable.addOnce(()=>{r.remove()}),l.onDisposeObservable.addOnce(()=>{ip(r)}),n(l),r.removeEventListener("playing",o)};r.addEventListener("playing",o),r.play()})}static CreateFromWebCamAsync(e,t,i=!1,s=!0){let r;if(t&&t.deviceId&&(r={exact:t.deviceId}),navigator.mediaDevices)return navigator.mediaDevices.getUserMedia({video:t,audio:i}).then(n=>this.CreateFromStreamAsync(e,n,t,s));{const n=navigator.getUserMedia||navigator.mozGetUserMedia;n&&n({video:{deviceId:r,width:{min:t&&t.minWidth||256,max:t&&t.maxWidth||640},height:{min:t&&t.minHeight||256,max:t&&t.maxHeight||480}},audio:i},o=>this.CreateFromStreamAsync(e,o,t,s),function(o){B.Error(o.name)})}return Promise.reject("No support for userMedia on this device")}static CreateFromWebCam(e,t,i,s=!1,r=!0){this.CreateFromWebCamAsync(e,i,s,r).then(function(n){t&&t(n)}).catch(function(n){B.Error(n.name)})}}class l0 extends bs{get videoTexture(){return this._texture}get videoMode(){return this.textureMode}set videoMode(e){this.textureMode=e}_initTexture(e,t,i){const s={loop:i.loop,autoPlay:i.autoPlay,autoUpdateTexture:!0,poster:i.poster},r=new ec((this.name||"videoDome")+"_texture",e,t,i.generateMipMaps,this._useDirectMapping,H.TRILINEAR_SAMPLINGMODE,s);return i.clickToPlay&&(this._pointerObserver=t.onPointerObservable.add(n=>{var o;((o=n.pickInfo)===null||o===void 0?void 0:o.pickedMesh)===this.mesh&&this._texture.video.play()},Ce.POINTERDOWN)),this._textureObserver=r.onLoadObservable.add(()=>{this.onLoadObservable.notifyObservers()}),r}dispose(e,t=!1){this._texture.onLoadObservable.remove(this._textureObserver),this._scene.onPointerObservable.remove(this._pointerObserver),super.dispose(e,t)}}l0.MODE_MONOSCOPIC=bs.MODE_MONOSCOPIC;l0.MODE_TOPBOTTOM=bs.MODE_TOPBOTTOM;l0.MODE_SIDEBYSIDE=bs.MODE_SIDEBYSIDE;const ky="glowMapGenerationPixelShader",Gy=`#if defined(DIFFUSE_ISLINEAR) || defined(EMISSIVE_ISLINEAR)
#include<helperFunctions>
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform sampler2D diffuseSampler;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform sampler2D opacitySampler;
uniform float opacityIntensity;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform sampler2D emissiveSampler;
#endif
#ifdef VERTEXALPHA
varying vec4 vColor;
#endif
uniform vec4 glowColor;
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
vec4 finalColor=glowColor;
#ifdef DIFFUSE
vec4 albedoTexture=texture2D(diffuseSampler,vUVDiffuse);
#ifdef DIFFUSE_ISLINEAR
albedoTexture=toGammaSpace(albedoTexture);
#endif
#ifdef GLOW
finalColor.a*=albedoTexture.a;
#endif
#ifdef HIGHLIGHT
finalColor.a=albedoTexture.a;
#endif
#endif
#ifdef OPACITY
vec4 opacityMap=texture2D(opacitySampler,vUVOpacity);
#ifdef OPACITYRGB
finalColor.a*=getLuminance(opacityMap.rgb);
#else
finalColor.a*=opacityMap.a;
#endif
finalColor.a*=opacityIntensity;
#endif
#ifdef VERTEXALPHA
finalColor.a*=vColor.a;
#endif
#ifdef ALPHATEST
if (finalColor.a<ALPHATESTVALUE)
discard;
#endif
#ifdef EMISSIVE
vec4 emissive=texture2D(emissiveSampler,vUVEmissive);
#ifdef EMISSIVE_ISLINEAR
emissive=toGammaSpace(emissive);
#endif
gl_FragColor=emissive*finalColor;
#else
gl_FragColor=finalColor;
#endif
#ifdef HIGHLIGHT
gl_FragColor.a=glowColor.a;
#endif
}`;Y.ShadersStore[ky]=Gy;const zy="glowMapGenerationVertexShader",Wy=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
varying vec4 vPosition;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#ifdef DIFFUSE
varying vec2 vUVDiffuse;
uniform mat4 diffuseMatrix;
#endif
#ifdef OPACITY
varying vec2 vUVOpacity;
uniform mat4 opacityMatrix;
#endif
#ifdef EMISSIVE
varying vec2 vUVEmissive;
uniform mat4 emissiveMatrix;
#endif
#ifdef VERTEXALPHA
attribute vec4 color;
varying vec4 vColor;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef CUBEMAP
vPosition=worldPos;
gl_Position=viewProjection*finalWorld*vec4(position,1.0);
#else
vPosition=viewProjection*worldPos;
gl_Position=vPosition;
#endif
#ifdef DIFFUSE
#ifdef DIFFUSEUV1
vUVDiffuse=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef DIFFUSEUV2
vUVDiffuse=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef OPACITY
#ifdef OPACITYUV1
vUVOpacity=vec2(opacityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef OPACITYUV2
vUVOpacity=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef EMISSIVE
#ifdef EMISSIVEUV1
vUVEmissive=vec2(emissiveMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef EMISSIVEUV2
vUVEmissive=vec2(emissiveMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#ifdef VERTEXALPHA
vColor=color;
#endif
#include<clipPlaneVertex>
}`;Y.ShadersStore[zy]=Wy;class ar{constructor(e,t){this._vertexBuffers={},this._maxSize=0,this._mainTextureDesiredSize={width:0,height:0},this._shouldRender=!0,this._postProcesses=[],this._textures=[],this._emissiveTextureAndColor={texture:null,color:new J},this.neutralColor=new J,this.isEnabled=!0,this.disableBoundingBoxesFromEffectLayer=!1,this.onDisposeObservable=new X,this.onBeforeRenderMainTextureObservable=new X,this.onBeforeComposeObservable=new X,this.onBeforeRenderMeshToEffect=new X,this.onAfterRenderMeshToEffect=new X,this.onAfterComposeObservable=new X,this.onSizeChangedObservable=new X,this._materialForRendering={},this.name=e,this._scene=t||ye.LastCreatedScene,ar._SceneComponentInitialization(this._scene),this._engine=this._scene.getEngine(),this._maxSize=this._engine.getCaps().maxTextureSize,this._scene.effectLayers.push(this),this._mergeDrawWrapper=[],this._generateIndexBuffer(),this._generateVertexBuffer()}get camera(){return this._effectLayerOptions.camera}get renderingGroupId(){return this._effectLayerOptions.renderingGroupId}set renderingGroupId(e){this._effectLayerOptions.renderingGroupId=e}get mainTexture(){return this._mainTexture}setMaterialForRendering(e,t){if(this._mainTexture.setMaterialForRendering(e,t),Array.isArray(e))for(let i=0;i<e.length;++i){const s=e[i];t?this._materialForRendering[s.uniqueId]=[s,t]:delete this._materialForRendering[s.uniqueId]}else t?this._materialForRendering[e.uniqueId]=[e,t]:delete this._materialForRendering[e.uniqueId]}_numInternalDraws(){return 1}_init(e){this._effectLayerOptions={mainTextureRatio:.5,alphaBlendingMode:2,camera:null,renderingGroupId:-1,...e},this._setMainTextureSize(),this._createMainTexture(),this._createTextureAndPostProcesses()}_generateIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._engine.createIndexBuffer(e)}_generateVertexBuffer(){const e=[];e.push(1,1),e.push(-1,1),e.push(-1,-1),e.push(1,-1);const t=new y(this._engine,e,y.PositionKind,!1,!1,2);this._vertexBuffers[y.PositionKind]=t}_setMainTextureSize(){this._effectLayerOptions.mainTextureFixedSize?(this._mainTextureDesiredSize.width=this._effectLayerOptions.mainTextureFixedSize,this._mainTextureDesiredSize.height=this._effectLayerOptions.mainTextureFixedSize):(this._mainTextureDesiredSize.width=this._engine.getRenderWidth()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.height=this._engine.getRenderHeight()*this._effectLayerOptions.mainTextureRatio,this._mainTextureDesiredSize.width=this._engine.needPOTTextures?k.GetExponentOfTwo(this._mainTextureDesiredSize.width,this._maxSize):this._mainTextureDesiredSize.width,this._mainTextureDesiredSize.height=this._engine.needPOTTextures?k.GetExponentOfTwo(this._mainTextureDesiredSize.height,this._maxSize):this._mainTextureDesiredSize.height),this._mainTextureDesiredSize.width=Math.floor(this._mainTextureDesiredSize.width),this._mainTextureDesiredSize.height=Math.floor(this._mainTextureDesiredSize.height)}_createMainTexture(){this._mainTexture=new si("EffectLayerMainRTT",{width:this._mainTextureDesiredSize.width,height:this._mainTextureDesiredSize.height},this._scene,!1,!0,0),this._mainTexture.activeCamera=this._effectLayerOptions.camera,this._mainTexture.wrapU=H.CLAMP_ADDRESSMODE,this._mainTexture.wrapV=H.CLAMP_ADDRESSMODE,this._mainTexture.anisotropicFilteringLevel=1,this._mainTexture.updateSamplingMode(H.BILINEAR_SAMPLINGMODE),this._mainTexture.renderParticles=!1,this._mainTexture.renderList=null,this._mainTexture.ignoreCameraViewport=!0;for(const e in this._materialForRendering){const[t,i]=this._materialForRendering[e];this._mainTexture.setMaterialForRendering(t,i)}if(this._mainTexture.customIsReadyFunction=(e,t)=>{if(!e.isReady(!1))return!1;if(t===0&&e.subMeshes)for(let i=0;i<e.subMeshes.length;++i){const s=e.subMeshes[i],r=s.getMaterial(),n=s.getRenderingMesh();if(!r)continue;const l=n._getInstancesRenderList(s._id,!!s.getReplacementMesh()).hardwareInstancedRendering[s._id]||n.hasThinInstances;if(this._setEmissiveTextureAndColor(n,s,r),!this._isReady(s,l,this._emissiveTextureAndColor.texture))return!1}return!0},this._mainTexture.customRenderFunction=(e,t,i,s)=>{this.onBeforeRenderMainTextureObservable.notifyObservers(this);let r;const n=this._scene.getEngine();if(s.length){for(n.setColorWrite(!1),r=0;r<s.length;r++)this._renderSubMesh(s.data[r]);n.setColorWrite(!0)}for(r=0;r<e.length;r++)this._renderSubMesh(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMesh(t.data[r]);const o=n.getAlphaMode();for(r=0;r<i.length;r++)this._renderSubMesh(i.data[r],!0);n.setAlphaMode(o)},this._mainTexture.onClearObservable.add(e=>{e.clear(this.neutralColor,!0,!0,!0)}),this._scene.getBoundingBoxRenderer){const e=this._scene.getBoundingBoxRenderer().enabled;this._mainTexture.onBeforeBindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=!this.disableBoundingBoxesFromEffectLayer&&e}),this._mainTexture.onAfterUnbindObservable.add(()=>{this._scene.getBoundingBoxRenderer().enabled=e})}}_addCustomEffectDefines(e){}_isReady(e,t,i){var s;const r=this._scene.getEngine(),n=e.getMesh(),o=(s=n._internalAbstractMeshDataInfo._materialForRenderPass)===null||s===void 0?void 0:s[r.currentRenderPassId];if(o)return o.isReadyForSubMesh(n,e,t);const l=e.getMaterial();if(!l)return!1;if(this._useMeshMaterial(e.getRenderingMesh()))return l.isReadyForSubMesh(e.getMesh(),e,t);const h=[],c=[y.PositionKind];let u=!1,d=!1;if(l){const S=l.needAlphaTesting(),C=l.getAlphaTestTexture(),E=C&&C.hasAlpha&&(l.useAlphaFromDiffuseTexture||l._useAlphaFromAlbedoTexture);C&&(S||E)&&(h.push("#define DIFFUSE"),n.isVerticesDataPresent(y.UV2Kind)&&C.coordinatesIndex===1?(h.push("#define DIFFUSEUV2"),d=!0):n.isVerticesDataPresent(y.UVKind)&&(h.push("#define DIFFUSEUV1"),u=!0),S&&(h.push("#define ALPHATEST"),h.push("#define ALPHATESTVALUE 0.4")),C.gammaSpace||h.push("#define DIFFUSE_ISLINEAR"));const A=l.opacityTexture;A&&(h.push("#define OPACITY"),n.isVerticesDataPresent(y.UV2Kind)&&A.coordinatesIndex===1?(h.push("#define OPACITYUV2"),d=!0):n.isVerticesDataPresent(y.UVKind)&&(h.push("#define OPACITYUV1"),u=!0))}i&&(h.push("#define EMISSIVE"),n.isVerticesDataPresent(y.UV2Kind)&&i.coordinatesIndex===1?(h.push("#define EMISSIVEUV2"),d=!0):n.isVerticesDataPresent(y.UVKind)&&(h.push("#define EMISSIVEUV1"),u=!0),i.gammaSpace||h.push("#define EMISSIVE_ISLINEAR")),n.useVertexColors&&n.isVerticesDataPresent(y.ColorKind)&&n.hasVertexAlpha&&l.transparencyMode!==ne.MATERIAL_OPAQUE&&(c.push(y.ColorKind),h.push("#define VERTEXALPHA")),u&&(c.push(y.UVKind),h.push("#define UV1")),d&&(c.push(y.UV2Kind),h.push("#define UV2"));const f=new Wa;if(n.useBones&&n.computeBonesUsingShaders){c.push(y.MatricesIndicesKind),c.push(y.MatricesWeightsKind),n.numBoneInfluencers>4&&(c.push(y.MatricesIndicesExtraKind),c.push(y.MatricesWeightsExtraKind)),h.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers);const S=n.skeleton;S&&S.isUsingTextureForMatrices?h.push("#define BONETEXTURE"):h.push("#define BonesPerMesh "+(S?S.bones.length+1:0)),n.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,n)}else h.push("#define NUM_BONE_INFLUENCERS 0");const p=n.morphTargetManager;let _=0;p&&p.numInfluencers>0&&(h.push("#define MORPHTARGETS"),_=p.numInfluencers,h.push("#define NUM_MORPH_INFLUENCERS "+_),p.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(c,n,_)),t&&(h.push("#define INSTANCES"),se.PushAttributesForInstances(c),e.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES"));const m=this._scene;m.clipPlane&&h.push("#define CLIPPLANE"),m.clipPlane2&&h.push("#define CLIPPLANE2"),m.clipPlane3&&h.push("#define CLIPPLANE3"),m.clipPlane4&&h.push("#define CLIPPLANE4"),m.clipPlane5&&h.push("#define CLIPPLANE5"),m.clipPlane6&&h.push("#define CLIPPLANE6"),this._addCustomEffectDefines(h);const v=e._getDrawWrapper(void 0,!0),x=v.defines,b=h.join(`
`);return x!==b&&v.setEffect(this._engine.createEffect("glowMapGeneration",c,["world","mBones","viewProjection","glowColor","morphTargetInfluences","boneTextureWidth","diffuseMatrix","emissiveMatrix","opacityMatrix","opacityIntensity","morphTargetTextureInfo","morphTargetTextureIndices","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6"],["diffuseSampler","emissiveSampler","opacitySampler","boneSampler","morphTargets"],b,f,void 0,void 0,{maxSimultaneousMorphTargets:_}),b),v.effect.isReady()}render(){for(let n=0;n<this._postProcesses.length;n++)if(!this._postProcesses[n].isReady())return;const e=this._scene.getEngine(),t=this._numInternalDraws();let i=!0;for(let n=0;n<t;++n){let o=this._mergeDrawWrapper[n];o||(o=this._mergeDrawWrapper[n]=new Vi(this._engine),o.setEffect(this._createMergeEffect())),i=i&&o.effect.isReady()}if(!i)return;this.onBeforeComposeObservable.notifyObservers(this);const s=e.getAlphaMode();for(let n=0;n<t;++n){const o=this._mergeDrawWrapper[n];e.enableEffect(o),e.setState(!1),e.bindBuffers(this._vertexBuffers,this._indexBuffer,o.effect),e.setAlphaMode(this._effectLayerOptions.alphaBlendingMode),this._internalRender(o.effect,n)}e.setAlphaMode(s),this.onAfterComposeObservable.notifyObservers(this);const r=this._mainTexture.getSize();this._setMainTextureSize(),(r.width!==this._mainTextureDesiredSize.width||r.height!==this._mainTextureDesiredSize.height)&&this._mainTextureDesiredSize.width!==0&&this._mainTextureDesiredSize.height!==0&&(this.onSizeChangedObservable.notifyObservers(this),this._disposeTextureAndPostProcesses(),this._createMainTexture(),this._createTextureAndPostProcesses())}hasMesh(e){return this.renderingGroupId===-1||e.renderingGroupId===this.renderingGroupId}shouldRender(){return this.isEnabled&&this._shouldRender}_shouldRenderMesh(e){return!0}_canRenderMesh(e,t){return!t.needAlphaBlendingForMesh(e)}_shouldRenderEmissiveTextureForMesh(){return!0}_renderSubMesh(e,t=!1){var i,s;if(!this.shouldRender())return;const r=e.getMaterial(),n=e.getMesh(),o=e.getReplacementMesh(),l=e.getRenderingMesh(),h=e.getEffectiveMesh(),c=this._scene,u=c.getEngine();if(h._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!r||!this._canRenderMesh(l,r))return;let d=(i=l.overrideMaterialSideOrientation)!==null&&i!==void 0?i:r.sideOrientation;h._getWorldMatrixDeterminant()<0&&(d=d===ne.ClockWiseSideOrientation?ne.CounterClockWiseSideOrientation:ne.ClockWiseSideOrientation);const p=d===ne.ClockWiseSideOrientation;u.setState(r.backFaceCulling,r.zOffset,void 0,p,r.cullBackFaces,void 0,r.zOffsetUnits);const _=l._getInstancesRenderList(e._id,!!o);if(_.mustReturn||!this._shouldRenderMesh(l))return;const m=_.hardwareInstancedRendering[e._id]||l.hasThinInstances;if(this._setEmissiveTextureAndColor(l,e,r),this.onBeforeRenderMeshToEffect.notifyObservers(n),this._useMeshMaterial(l))l.render(e,m,o||void 0);else if(this._isReady(e,m,this._emissiveTextureAndColor.texture)){const v=(s=h._internalAbstractMeshDataInfo._materialForRenderPass)===null||s===void 0?void 0:s[u.currentRenderPassId];let x=e._getDrawWrapper();if(!x&&v&&(x=v._getDrawWrapper()),!x)return;const b=x.effect;if(u.enableEffect(x),!m){const S=c.forcePointsCloud?ne.PointFillMode:c.forceWireframe?ne.WireFrameFillMode:r.fillMode;l._bind(e,b,S)}if(v?v.bindForSubMesh(h.getWorldMatrix(),h,e):(b.setMatrix("viewProjection",c.getTransformMatrix()),b.setMatrix("world",h.getWorldMatrix()),b.setFloat4("glowColor",this._emissiveTextureAndColor.color.r,this._emissiveTextureAndColor.color.g,this._emissiveTextureAndColor.color.b,this._emissiveTextureAndColor.color.a)),!v){const S=r.needAlphaTesting(),C=r.getAlphaTestTexture(),E=C&&C.hasAlpha&&(r.useAlphaFromDiffuseTexture||r._useAlphaFromAlbedoTexture);if(C&&(S||E)){b.setTexture("diffuseSampler",C);const M=C.getTextureMatrix();M&&b.setMatrix("diffuseMatrix",M)}const A=r.opacityTexture;if(A){b.setTexture("opacitySampler",A),b.setFloat("opacityIntensity",A.level);const M=A.getTextureMatrix();M&&b.setMatrix("opacityMatrix",M)}if(this._emissiveTextureAndColor.texture&&(b.setTexture("emissiveSampler",this._emissiveTextureAndColor.texture),b.setMatrix("emissiveMatrix",this._emissiveTextureAndColor.texture.getTextureMatrix())),l.useBones&&l.computeBonesUsingShaders&&l.skeleton){const M=l.skeleton;if(M.isUsingTextureForMatrices){const D=M.getTransformMatrixTexture(l);if(!D)return;b.setTexture("boneSampler",D),b.setFloat("boneTextureWidth",4*(M.bones.length+1))}else b.setMatrices("mBones",M.getTransformMatrices(l))}se.BindMorphTargetParameters(l,b),l.morphTargetManager&&l.morphTargetManager.isUsingTextureForTargets&&l.morphTargetManager._bind(b),t&&u.setAlphaMode(r.alphaMode),se.BindClipPlane(b,c)}l._processRendering(h,e,b,r.fillMode,_,m,(S,C)=>b.setMatrix("world",C))}else this._mainTexture.resetRefreshCounter();this.onAfterRenderMeshToEffect.notifyObservers(n)}_useMeshMaterial(e){return!1}_rebuild(){const e=this._vertexBuffers[y.PositionKind];e&&e._rebuild(),this._generateIndexBuffer()}_disposeTextureAndPostProcesses(){this._mainTexture.dispose();for(let e=0;e<this._postProcesses.length;e++)this._postProcesses[e]&&this._postProcesses[e].dispose();this._postProcesses=[];for(let e=0;e<this._textures.length;e++)this._textures[e]&&this._textures[e].dispose();this._textures=[]}dispose(){const e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);for(const i of this._mergeDrawWrapper)i.dispose();this._mergeDrawWrapper=[],this._disposeTextureAndPostProcesses();const t=this._scene.effectLayers.indexOf(this,0);t>-1&&this._scene.effectLayers.splice(t,1),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onBeforeRenderMainTextureObservable.clear(),this.onBeforeComposeObservable.clear(),this.onBeforeRenderMeshToEffect.clear(),this.onAfterRenderMeshToEffect.clear(),this.onAfterComposeObservable.clear(),this.onSizeChangedObservable.clear()}getClassName(){return"EffectLayer"}static Parse(e,t,i){return q.Instantiate(e.customType).Parse(e,t,i)}}ar._SceneComponentInitialization=a=>{throw Ve("EffectLayerSceneComponent")};T([R()],ar.prototype,"name",void 0);T([Od()],ar.prototype,"neutralColor",void 0);T([R()],ar.prototype,"isEnabled",void 0);T([_x()],ar.prototype,"camera",null);T([R()],ar.prototype,"renderingGroupId",null);T([R()],ar.prototype,"disableBoundingBoxesFromEffectLayer",void 0);li.AddParser(ue.NAME_EFFECTLAYER,(a,e,t,i)=>{if(a.effectLayers){t.effectLayers||(t.effectLayers=new Array);for(let s=0;s<a.effectLayers.length;s++){const r=ar.Parse(a.effectLayers[s],e,i);t.effectLayers.push(r)}}});li.prototype.removeEffectLayer=function(a){const e=this.effectLayers.indexOf(a);return e!==-1&&this.effectLayers.splice(e,1),e};li.prototype.addEffectLayer=function(a){this.effectLayers.push(a)};class Hy{constructor(e){this.name=ue.NAME_EFFECTLAYER,this._renderEffects=!1,this._needStencil=!1,this._previousStencilState=!1,this.scene=e||ye.LastCreatedScene,this.scene&&(this._engine=this.scene.getEngine(),this.scene.effectLayers=new Array)}register(){this.scene._isReadyForMeshStage.registerStep(ue.STEP_ISREADYFORMESH_EFFECTLAYER,this,this._isReadyForMesh),this.scene._cameraDrawRenderTargetStage.registerStep(ue.STEP_CAMERADRAWRENDERTARGET_EFFECTLAYER,this,this._renderMainTexture),this.scene._beforeCameraDrawStage.registerStep(ue.STEP_BEFORECAMERADRAW_EFFECTLAYER,this,this._setStencil),this.scene._afterRenderingGroupDrawStage.registerStep(ue.STEP_AFTERRENDERINGGROUPDRAW_EFFECTLAYER_DRAW,this,this._drawRenderingGroup),this.scene._afterCameraDrawStage.registerStep(ue.STEP_AFTERCAMERADRAW_EFFECTLAYER,this,this._setStencilBack),this.scene._afterCameraDrawStage.registerStep(ue.STEP_AFTERCAMERADRAW_EFFECTLAYER_DRAW,this,this._drawCamera)}rebuild(){const e=this.scene.effectLayers;for(const t of e)t._rebuild()}serialize(e){e.effectLayers=[];const t=this.scene.effectLayers;for(const i of t)i.serialize&&e.effectLayers.push(i.serialize())}addFromContainer(e){!e.effectLayers||e.effectLayers.forEach(t=>{this.scene.addEffectLayer(t)})}removeFromContainer(e,t){!e.effectLayers||e.effectLayers.forEach(i=>{this.scene.removeEffectLayer(i),t&&i.dispose()})}dispose(){const e=this.scene.effectLayers;for(;e.length;)e[0].dispose()}_isReadyForMesh(e,t){const i=this._engine.currentRenderPassId,s=this.scene.effectLayers;for(const r of s){if(!r.hasMesh(e))continue;const n=r._mainTexture;this._engine.currentRenderPassId=n.renderPassId;for(const o of e.subMeshes)if(!r.isReady(o,t))return this._engine.currentRenderPassId=i,!1}return this._engine.currentRenderPassId=i,!0}_renderMainTexture(e){this._renderEffects=!1,this._needStencil=!1;let t=!1;const i=this.scene.effectLayers;if(i&&i.length>0){this._previousStencilState=this._engine.getStencilBuffer();for(const s of i)if(s.shouldRender()&&(!s.camera||s.camera.cameraRigMode===be.RIG_MODE_NONE&&e===s.camera||s.camera.cameraRigMode!==be.RIG_MODE_NONE&&s.camera._rigCameras.indexOf(e)>-1)){this._renderEffects=!0,this._needStencil=this._needStencil||s.needStencil();const r=s._mainTexture;r._shouldRender()&&(this.scene.incrementRenderId(),r.render(!1,!1),t=!0)}this.scene.incrementRenderId()}return t}_setStencil(){this._needStencil&&this._engine.setStencilBuffer(!0)}_setStencilBack(){this._needStencil&&this._engine.setStencilBuffer(this._previousStencilState)}_draw(e){if(this._renderEffects){this._engine.setDepthBuffer(!1);const t=this.scene.effectLayers;for(let i=0;i<t.length;i++){const s=t[i];s.renderingGroupId===e&&s.shouldRender()&&s.render()}this._engine.setDepthBuffer(!0)}}_drawCamera(){this._renderEffects&&this._draw(-1)}_drawRenderingGroup(e){!this.scene._isInIntermediateRendering()&&this._renderEffects&&this._draw(e)}}ar._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_EFFECTLAYER);e||(e=new Hy(a),a._addComponent(e))};const Xy="glowMapMergePixelShader",Yy=`varying vec2 vUV;
uniform sampler2D textureSampler;
#ifdef EMISSIVE
uniform sampler2D textureSampler2;
#endif
uniform float offset;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef EMISSIVE
baseColor+=texture2D(textureSampler2,vUV);
baseColor*=offset;
#else
baseColor.a=abs(offset-baseColor.a);
#ifdef STROKE
float alpha=smoothstep(.0,.1,baseColor.a);
baseColor.a=alpha;
baseColor.rgb=baseColor.rgb*alpha;
#endif
#endif
#if LDR
baseColor=clamp(baseColor,0.,1.0);
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[Xy]=Yy;const Ky="glowMapMergeVertexShader",$y=`attribute vec2 position;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[Ky]=$y;li.prototype.getGlowLayerByName=function(a){for(let e=0;e<this.effectLayers.length;e++)if(this.effectLayers[e].name===a&&this.effectLayers[e].getEffectName()===er.EffectName)return this.effectLayers[e];return null};class er extends ar{constructor(e,t,i){super(e,t),this._intensity=1,this._includedOnlyMeshes=[],this._excludedMeshes=[],this._meshesUsingTheirOwnMaterials=[],this.neutralColor=new J(0,0,0,1),this._options={mainTextureRatio:er.DefaultTextureRatio,blurKernelSize:32,mainTextureFixedSize:void 0,camera:null,mainTextureSamples:1,renderingGroupId:-1,ldrMerge:!1,alphaBlendingMode:1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId})}set blurKernelSize(e){if(e===this._options.blurKernelSize)return;this._options.blurKernelSize=e;const t=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1.kernel=t,this._verticalBlurPostprocess1.kernel=t,this._horizontalBlurPostprocess2.kernel=t,this._verticalBlurPostprocess2.kernel=t}get blurKernelSize(){return this._options.blurKernelSize}set intensity(e){this._intensity=e}get intensity(){return this._intensity}getEffectName(){return er.EffectName}_createMergeEffect(){let e=`#define EMISSIVE 
`;return this._options.ldrMerge&&(e+=`#define LDR 
`),this._engine.createEffect("glowMapMerge",[y.PositionKind],["offset"],["textureSampler","textureSampler2"],e)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width,t=this._mainTextureDesiredSize.height;e=this._engine.needPOTTextures?k.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?k.GetExponentOfTwo(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture1=new si("GlowLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture1.wrapU=H.CLAMP_ADDRESSMODE,this._blurTexture1.wrapV=H.CLAMP_ADDRESSMODE,this._blurTexture1.updateSamplingMode(H.BILINEAR_SAMPLINGMODE),this._blurTexture1.renderParticles=!1,this._blurTexture1.ignoreCameraViewport=!0;const s=Math.floor(e/2),r=Math.floor(t/2);this._blurTexture2=new si("GlowLayerBlurRTT2",{width:s,height:r},this._scene,!1,!0,i),this._blurTexture2.wrapU=H.CLAMP_ADDRESSMODE,this._blurTexture2.wrapV=H.CLAMP_ADDRESSMODE,this._blurTexture2.updateSamplingMode(H.BILINEAR_SAMPLINGMODE),this._blurTexture2.renderParticles=!1,this._blurTexture2.ignoreCameraViewport=!0,this._textures=[this._blurTexture1,this._blurTexture2];const n=this._getEffectiveBlurKernelSize();this._horizontalBlurPostprocess1=new Ei("GlowLayerHBP1",new le(1,0),n,{width:e,height:t},null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess1.width=e,this._horizontalBlurPostprocess1.height=t,this._horizontalBlurPostprocess1.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess1.onApplyObservable.add(o=>{o.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess1=new Ei("GlowLayerVBP1",new le(0,1),n,{width:e,height:t},null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2=new Ei("GlowLayerHBP2",new le(1,0),n,{width:s,height:r},null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess2.width=s,this._horizontalBlurPostprocess2.height=r,this._horizontalBlurPostprocess2.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess2.onApplyObservable.add(o=>{o.setTexture("textureSampler",this._blurTexture1)}),this._verticalBlurPostprocess2=new Ei("GlowLayerVBP2",new le(0,1),n,{width:s,height:r},null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1,this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._postProcesses1=[this._horizontalBlurPostprocess1,this._verticalBlurPostprocess1],this._postProcesses2=[this._horizontalBlurPostprocess2,this._verticalBlurPostprocess2],this._mainTexture.samples=this._options.mainTextureSamples,this._mainTexture.onAfterUnbindObservable.add(()=>{const o=this._blurTexture1.renderTarget;if(o){this._scene.postProcessManager.directRender(this._postProcesses1,o,!0);const l=this._blurTexture2.renderTarget;l&&this._scene.postProcessManager.directRender(this._postProcesses2,l,!0),this._engine.unBindFramebuffer(l!=null?l:o,!0)}}),this._postProcesses.map(o=>{o.autoClear=!1})}_getEffectiveBlurKernelSize(){return this._options.blurKernelSize/2}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s)return!1;const r=i.emissiveTexture;return super._isReady(e,t,r)}needStencil(){return!1}_canRenderMesh(e,t){return!0}_internalRender(e){e.setTexture("textureSampler",this._blurTexture1),e.setTexture("textureSampler2",this._blurTexture2),e.setFloat("offset",this._intensity);const t=this._engine,i=t.getStencilBuffer();t.setStencilBuffer(!1),t.drawElementsType(ne.TriangleFillMode,0,6),t.setStencilBuffer(i)}_setEmissiveTextureAndColor(e,t,i){var s;let r=1;this.customEmissiveTextureSelector?this._emissiveTextureAndColor.texture=this.customEmissiveTextureSelector(e,t,i):i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.texture&&(r=this._emissiveTextureAndColor.texture.level)):this._emissiveTextureAndColor.texture=null,this.customEmissiveColorSelector?this.customEmissiveColorSelector(e,t,i,this._emissiveTextureAndColor.color):i.emissiveColor?(r*=(s=i.emissiveIntensity)!==null&&s!==void 0?s:1,this._emissiveTextureAndColor.color.set(i.emissiveColor.r*r,i.emissiveColor.g*r,i.emissiveColor.b*r,i.alpha)):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a)}_shouldRenderMesh(e){return this.hasMesh(e)}_addCustomEffectDefines(e){e.push("#define GLOW")}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}addIncludedOnlyMesh(e){this._includedOnlyMeshes.indexOf(e.uniqueId)===-1&&this._includedOnlyMeshes.push(e.uniqueId)}removeIncludedOnlyMesh(e){const t=this._includedOnlyMeshes.indexOf(e.uniqueId);t!==-1&&this._includedOnlyMeshes.splice(t,1)}hasMesh(e){return super.hasMesh(e)?this._includedOnlyMeshes.length?this._includedOnlyMeshes.indexOf(e.uniqueId)!==-1:this._excludedMeshes.length?this._excludedMeshes.indexOf(e.uniqueId)===-1:!0:!1}_useMeshMaterial(e){return this._meshesUsingTheirOwnMaterials.length==0?!1:this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId)>-1}referenceMeshToUseItsOwnMaterial(e){e.resetDrawCache(this._mainTexture.renderPassId),this._meshesUsingTheirOwnMaterials.push(e.uniqueId),e.onDisposeObservable.add(()=>{this._disposeMesh(e)})}unReferenceMeshFromUsingItsOwnMaterial(e){let t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);for(;t>=0;)this._meshesUsingTheirOwnMaterials.splice(t,1),t=this._meshesUsingTheirOwnMaterials.indexOf(e.uniqueId);e.resetDrawCache(this._mainTexture.renderPassId)}_disposeMesh(e){this.removeIncludedOnlyMesh(e),this.removeExcludedMesh(e)}getClassName(){return"GlowLayer"}serialize(){const e=xe.Serialize(this);e.customType="BABYLON.GlowLayer";let t;if(e.includedMeshes=[],this._includedOnlyMeshes.length)for(t=0;t<this._includedOnlyMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._includedOnlyMeshes[t]);i&&e.includedMeshes.push(i.id)}if(e.excludedMeshes=[],this._excludedMeshes.length)for(t=0;t<this._excludedMeshes.length;t++){const i=this._scene.getMeshByUniqueId(this._excludedMeshes[t]);i&&e.excludedMeshes.push(i.id)}return e}static Parse(e,t,i){const s=xe.Parse(()=>new er(e.name,t,e.options),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const n=t.getMeshById(e.excludedMeshes[r]);n&&s.addExcludedMesh(n)}for(r=0;r<e.includedMeshes.length;r++){const n=t.getMeshById(e.includedMeshes[r]);n&&s.addIncludedOnlyMesh(n)}return s}}er.EffectName="GlowLayer";er.DefaultBlurKernelSize=32;er.DefaultTextureRatio=.5;T([R()],er.prototype,"blurKernelSize",null);T([R()],er.prototype,"intensity",null);T([R("options")],er.prototype,"_options",void 0);he("BABYLON.GlowLayer",er);const jy="glowBlurPostProcessPixelShader",qy=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform vec2 direction;
uniform float blurWidth;
float getLuminance(vec3 color)
{
return dot(color,vec3(0.2126,0.7152,0.0722));
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float weights[7];
weights[0]=0.05;
weights[1]=0.1;
weights[2]=0.2;
weights[3]=0.3;
weights[4]=0.2;
weights[5]=0.1;
weights[6]=0.05;
vec2 texelSize=vec2(1.0/screenSize.x,1.0/screenSize.y);
vec2 texelStep=texelSize*direction*blurWidth;
vec2 start=vUV-3.0*texelStep;
vec4 baseColor=vec4(0.,0.,0.,0.);
vec2 texelOffset=vec2(0.,0.);
for (int i=0; i<7; i++)
{
vec4 texel=texture2D(textureSampler,start+texelOffset);
baseColor.a+=texel.a*weights[i];
float luminance=getLuminance(baseColor.rgb);
float luminanceTexel=getLuminance(texel.rgb);
float choice=step(luminanceTexel,luminance);
baseColor.rgb=choice*baseColor.rgb+(1.0-choice)*texel.rgb;
texelOffset+=texelStep;
}
gl_FragColor=baseColor;
}`;Y.ShadersStore[jy]=qy;li.prototype.getHighlightLayerByName=function(a){var e;for(let t=0;t<((e=this.effectLayers)===null||e===void 0?void 0:e.length);t++)if(this.effectLayers[t].name===a&&this.effectLayers[t].getEffectName()===hs.EffectName)return this.effectLayers[t];return null};class sp extends Fe{constructor(e,t,i,s,r,n=H.BILINEAR_SAMPLINGMODE,o,l){super(e,"glowBlurPostProcess",["screenSize","direction","blurWidth"],null,s,r,n,o,l),this.direction=t,this.kernel=i,this.onApplyObservable.add(h=>{h.setFloat2("screenSize",this.width,this.height),h.setVector2("direction",this.direction),h.setFloat("blurWidth",this.kernel)})}}class hs extends ar{constructor(e,t,i){super(e,t),this.name=e,this.innerGlow=!0,this.outerGlow=!0,this.onBeforeBlurObservable=new X,this.onAfterBlurObservable=new X,this._instanceGlowingMeshStencilReference=hs.GlowingMeshStencilReference++,this._meshes={},this._excludedMeshes={},this.neutralColor=hs.NeutralColor,this._engine.isStencilEnable||B.Warn("Rendering the Highlight Layer requires the stencil to be active on the canvas. var engine = new Engine(canvas, antialias, { stencil: true }"),this._options={mainTextureRatio:.5,blurTextureSizeRatio:.5,blurHorizontalSize:1,blurVerticalSize:1,alphaBlendingMode:2,camera:null,renderingGroupId:-1,...i},this._init({alphaBlendingMode:this._options.alphaBlendingMode,camera:this._options.camera,mainTextureFixedSize:this._options.mainTextureFixedSize,mainTextureRatio:this._options.mainTextureRatio,renderingGroupId:this._options.renderingGroupId}),this._shouldRender=!1}set blurHorizontalSize(e){this._horizontalBlurPostprocess.kernel=e,this._options.blurHorizontalSize=e}set blurVerticalSize(e){this._verticalBlurPostprocess.kernel=e,this._options.blurVerticalSize=e}get blurHorizontalSize(){return this._horizontalBlurPostprocess.kernel}get blurVerticalSize(){return this._verticalBlurPostprocess.kernel}getEffectName(){return hs.EffectName}_numInternalDraws(){return 2}_createMergeEffect(){return this._engine.createEffect("glowMapMerge",[y.PositionKind],["offset"],["textureSampler"],this._options.isStroke?`#define STROKE 
`:void 0)}_createTextureAndPostProcesses(){let e=this._mainTextureDesiredSize.width*this._options.blurTextureSizeRatio,t=this._mainTextureDesiredSize.height*this._options.blurTextureSizeRatio;e=this._engine.needPOTTextures?k.GetExponentOfTwo(e,this._maxSize):e,t=this._engine.needPOTTextures?k.GetExponentOfTwo(t,this._maxSize):t;let i=0;this._engine.getCaps().textureHalfFloatRender?i=2:i=0,this._blurTexture=new si("HighlightLayerBlurRTT",{width:e,height:t},this._scene,!1,!0,i),this._blurTexture.wrapU=H.CLAMP_ADDRESSMODE,this._blurTexture.wrapV=H.CLAMP_ADDRESSMODE,this._blurTexture.anisotropicFilteringLevel=16,this._blurTexture.updateSamplingMode(H.TRILINEAR_SAMPLINGMODE),this._blurTexture.renderParticles=!1,this._blurTexture.ignoreCameraViewport=!0,this._textures=[this._blurTexture],this._options.alphaBlendingMode===2?(this._downSamplePostprocess=new Sn("HighlightLayerPPP",this._options.blurTextureSizeRatio,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._downSamplePostprocess.externalTextureSamplerBinding=!0,this._downSamplePostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._mainTexture)}),this._horizontalBlurPostprocess=new sp("HighlightLayerHBP",new le(1,0),this._options.blurHorizontalSize,1,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._horizontalBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",e,t)}),this._verticalBlurPostprocess=new sp("HighlightLayerVBP",new le(0,1),this._options.blurVerticalSize,1,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine()),this._verticalBlurPostprocess.onApplyObservable.add(s=>{s.setFloat2("screenSize",e,t)}),this._postProcesses=[this._downSamplePostprocess,this._horizontalBlurPostprocess,this._verticalBlurPostprocess]):(this._horizontalBlurPostprocess=new Ei("HighlightLayerHBP",new le(1,0),this._options.blurHorizontalSize/2,{width:e,height:t},null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._horizontalBlurPostprocess.width=e,this._horizontalBlurPostprocess.height=t,this._horizontalBlurPostprocess.externalTextureSamplerBinding=!0,this._horizontalBlurPostprocess.onApplyObservable.add(s=>{s.setTexture("textureSampler",this._mainTexture)}),this._verticalBlurPostprocess=new Ei("HighlightLayerVBP",new le(0,1),this._options.blurVerticalSize/2,{width:e,height:t},null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i),this._postProcesses=[this._horizontalBlurPostprocess,this._verticalBlurPostprocess]),this._mainTexture.onAfterUnbindObservable.add(()=>{this.onBeforeBlurObservable.notifyObservers(this);const s=this._blurTexture.renderTarget;s&&(this._scene.postProcessManager.directRender(this._postProcesses,s,!0),this._engine.unBindFramebuffer(s,!0)),this.onAfterBlurObservable.notifyObservers(this)}),this._postProcesses.map(s=>{s.autoClear=!1})}needStencil(){return!0}isReady(e,t){const i=e.getMaterial(),s=e.getRenderingMesh();if(!i||!s||!this._meshes)return!1;let r=null;const n=this._meshes[s.uniqueId];return n&&n.glowEmissiveOnly&&i&&(r=i.emissiveTexture),super._isReady(e,t,r)}_internalRender(e,t){e.setTexture("textureSampler",this._blurTexture);const i=this._engine;i.cacheStencilState(),i.setStencilOperationPass(7681),i.setStencilOperationFail(7680),i.setStencilOperationDepthFail(7680),i.setStencilMask(0),i.setStencilBuffer(!0),i.setStencilFunctionReference(this._instanceGlowingMeshStencilReference),this.outerGlow&&t===0&&(e.setFloat("offset",0),i.setStencilFunction(517),i.drawElementsType(ne.TriangleFillMode,0,6)),this.innerGlow&&t===1&&(e.setFloat("offset",1),i.setStencilFunction(514),i.drawElementsType(ne.TriangleFillMode,0,6)),i.restoreStencilState()}shouldRender(){return super.shouldRender()?!!this._meshes:!1}_shouldRenderMesh(e){return!(this._excludedMeshes&&this._excludedMeshes[e.uniqueId]||!super.hasMesh(e))}_canRenderMesh(e,t){return!0}_addCustomEffectDefines(e){e.push("#define HIGHLIGHT")}_setEmissiveTextureAndColor(e,t,i){const s=this._meshes[e.uniqueId];s?this._emissiveTextureAndColor.color.set(s.color.r,s.color.g,s.color.b,1):this._emissiveTextureAndColor.color.set(this.neutralColor.r,this.neutralColor.g,this.neutralColor.b,this.neutralColor.a),s&&s.glowEmissiveOnly&&i?(this._emissiveTextureAndColor.texture=i.emissiveTexture,this._emissiveTextureAndColor.color.set(1,1,1,1)):this._emissiveTextureAndColor.texture=null}addExcludedMesh(e){if(!this._excludedMeshes)return;this._excludedMeshes[e.uniqueId]||(this._excludedMeshes[e.uniqueId]={mesh:e,beforeBind:e.onBeforeBindObservable.add(i=>{i.getEngine().setStencilBuffer(!1)}),afterRender:e.onAfterRenderObservable.add(i=>{i.getEngine().setStencilBuffer(!0)})})}removeExcludedMesh(e){if(!this._excludedMeshes)return;const t=this._excludedMeshes[e.uniqueId];t&&(t.beforeBind&&e.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&e.onAfterRenderObservable.remove(t.afterRender)),this._excludedMeshes[e.uniqueId]=null}hasMesh(e){return!this._meshes||!super.hasMesh(e)?!1:this._meshes[e.uniqueId]!==void 0&&this._meshes[e.uniqueId]!==null}addMesh(e,t,i=!1){if(!this._meshes)return;const s=this._meshes[e.uniqueId];s?s.color=t:(this._meshes[e.uniqueId]={mesh:e,color:t,observerHighlight:e.onBeforeBindObservable.add(r=>{this.isEnabled&&(this._excludedMeshes&&this._excludedMeshes[r.uniqueId]?this._defaultStencilReference(r):r.getScene().getEngine().setStencilFunctionReference(this._instanceGlowingMeshStencilReference))}),observerDefault:e.onAfterRenderObservable.add(r=>{this.isEnabled&&this._defaultStencilReference(r)}),glowEmissiveOnly:i},e.onDisposeObservable.add(()=>{this._disposeMesh(e)})),this._shouldRender=!0}removeMesh(e){if(!this._meshes)return;const t=this._meshes[e.uniqueId];t&&(t.observerHighlight&&e.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&e.onAfterRenderObservable.remove(t.observerDefault),delete this._meshes[e.uniqueId]),this._shouldRender=!1;for(const i in this._meshes)if(this._meshes[i]){this._shouldRender=!0;break}}removeAllMeshes(){if(!!this._meshes){for(const e in this._meshes)if(Object.prototype.hasOwnProperty.call(this._meshes,e)){const t=this._meshes[e];t&&this.removeMesh(t.mesh)}}}_defaultStencilReference(e){e.getScene().getEngine().setStencilFunctionReference(hs.NormalMeshStencilReference)}_disposeMesh(e){this.removeMesh(e),this.removeExcludedMesh(e)}dispose(){if(this._meshes){for(const e in this._meshes){const t=this._meshes[e];t&&t.mesh&&(t.observerHighlight&&t.mesh.onBeforeBindObservable.remove(t.observerHighlight),t.observerDefault&&t.mesh.onAfterRenderObservable.remove(t.observerDefault))}this._meshes=null}if(this._excludedMeshes){for(const e in this._excludedMeshes){const t=this._excludedMeshes[e];t&&(t.beforeBind&&t.mesh.onBeforeBindObservable.remove(t.beforeBind),t.afterRender&&t.mesh.onAfterRenderObservable.remove(t.afterRender))}this._excludedMeshes=null}super.dispose()}getClassName(){return"HighlightLayer"}serialize(){const e=xe.Serialize(this);if(e.customType="BABYLON.HighlightLayer",e.meshes=[],this._meshes)for(const t in this._meshes){const i=this._meshes[t];i&&e.meshes.push({glowEmissiveOnly:i.glowEmissiveOnly,color:i.color.asArray(),meshId:i.mesh.id})}if(e.excludedMeshes=[],this._excludedMeshes)for(const t in this._excludedMeshes){const i=this._excludedMeshes[t];i&&e.excludedMeshes.push(i.mesh.id)}return e}static Parse(e,t,i){const s=xe.Parse(()=>new hs(e.name,t,e.options),e,t,i);let r;for(r=0;r<e.excludedMeshes.length;r++){const n=t.getMeshById(e.excludedMeshes[r]);n&&s.addExcludedMesh(n)}for(r=0;r<e.meshes.length;r++){const n=e.meshes[r],o=t.getMeshById(n.meshId);o&&s.addMesh(o,re.FromArray(n.color),n.glowEmissiveOnly)}return s}}hs.EffectName="HighlightLayer";hs.NeutralColor=new J(0,0,0,0);hs.GlowingMeshStencilReference=2;hs.NormalMeshStencilReference=1;T([R()],hs.prototype,"innerGlow",void 0);T([R()],hs.prototype,"outerGlow",void 0);T([R()],hs.prototype,"blurHorizontalSize",null);T([R()],hs.prototype,"blurVerticalSize",null);T([R("options")],hs.prototype,"_options",void 0);he("BABYLON.HighlightLayer",hs);const Qy="layerPixelShader",Zy=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec4 color;
#include<helperFunctions>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
#ifdef LINEAR
baseColor.rgb=toGammaSpace(baseColor.rgb);
#endif
#ifdef ALPHATEST
if (baseColor.a<0.4)
discard;
#endif
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[Qy]=Zy;const Jy="layerVertexShader",eA=`attribute vec2 position;
uniform vec2 scale;
uniform vec2 offset;
uniform mat4 textureMatrix;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 shiftedPosition=position*scale+offset;
vUV=vec2(textureMatrix*vec4(shiftedPosition*madd+madd,1.0,0.0));
gl_Position=vec4(shiftedPosition,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[Jy]=eA;class h0{constructor(e,t,i,s,r){this.size=e,this.position=t,this.alphaMode=6,this.color=i||new re(1,1,1),this.texture=s?new H(s,r.getScene(),!0):null,this._system=r;const n=r.scene.getEngine();this._drawWrapper=new Vi(n),this._drawWrapper.effect=n.createEffect("lensFlare",[y.PositionKind],["color","viewportMatrix"],["textureSampler"],""),r.lensFlares.push(this)}static AddFlare(e,t,i,s,r){return new h0(e,t,i,s,r)}dispose(){this.texture&&this.texture.dispose();const e=this._system.lensFlares.indexOf(this);this._system.lensFlares.splice(e,1)}}const tA="lensFlarePixelShader",iA=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 baseColor=texture2D(textureSampler,vUV);
gl_FragColor=baseColor*color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[tA]=iA;const sA="lensFlareVertexShader",rA=`attribute vec2 position;
uniform mat4 viewportMatrix;
varying vec2 vUV;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=position*madd+madd;
gl_Position=viewportMatrix*vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[sA]=rA;class No{constructor(e,t,i){this.name=e,this.lensFlares=new Array,this.borderLimit=300,this.viewportBorder=0,this.layerMask=268435455,this._vertexBuffers={},this._isEnabled=!0,this._scene=i||ye.LastCreatedScene,No._SceneComponentInitialization(this._scene),this._emitter=t,this.id=e,i.lensFlareSystems.push(this),this.meshesSelectionPredicate=n=>i.activeCamera&&n.material&&n.isVisible&&n.isEnabled()&&n.isBlocker&&(n.layerMask&i.activeCamera.layerMask)!=0;const s=i.getEngine(),r=[];r.push(1,1),r.push(-1,1),r.push(-1,-1),r.push(1,-1),this._vertexBuffers[y.PositionKind]=new y(s,r,y.PositionKind,!1,!1,2),this._createIndexBuffer()}get scene(){return this._scene}_createIndexBuffer(){const e=[];e.push(0),e.push(1),e.push(2),e.push(0),e.push(2),e.push(3),this._indexBuffer=this._scene.getEngine().createIndexBuffer(e)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled=e}getScene(){return this._scene}getEmitter(){return this._emitter}setEmitter(e){this._emitter=e}getEmitterPosition(){return this._emitter.getAbsolutePosition?this._emitter.getAbsolutePosition():this._emitter.position}computeEffectivePosition(e){let t=this.getEmitterPosition();t=g.Project(t,L.Identity(),this._scene.getTransformMatrix(),e),this._positionX=t.x,this._positionY=t.y,t=g.TransformCoordinates(this.getEmitterPosition(),this._scene.getViewMatrix()),this.viewportBorder>0&&(e.x-=this.viewportBorder,e.y-=this.viewportBorder,e.width+=this.viewportBorder*2,e.height+=this.viewportBorder*2,t.x+=this.viewportBorder,t.y+=this.viewportBorder,this._positionX+=this.viewportBorder,this._positionY+=this.viewportBorder);const i=this._scene.useRightHandedSystem;return t.z>0&&!i||t.z<0&&i?(this._positionX>e.x&&this._positionX<e.x+e.width&&this._positionY>e.y&&this._positionY<e.y+e.height,!0):!1}_isVisible(){if(!this._isEnabled||!this._scene.activeCamera)return!1;const t=this.getEmitterPosition().subtract(this._scene.activeCamera.globalPosition),i=t.length();t.normalize();const s=new $e(this._scene.activeCamera.globalPosition,t),r=this._scene.pickWithRay(s,this.meshesSelectionPredicate,!0);return!r||!r.hit||r.distance>i}render(){if(!this._scene.activeCamera)return!1;const e=this._scene.getEngine(),i=this._scene.activeCamera.viewport.toGlobal(e.getRenderWidth(!0),e.getRenderHeight(!0));if(!this.computeEffectivePosition(i)||!this._isVisible())return!1;let s,r;this._positionX<this.borderLimit+i.x?s=this.borderLimit+i.x-this._positionX:this._positionX>i.x+i.width-this.borderLimit?s=this._positionX-i.x-i.width+this.borderLimit:s=0,this._positionY<this.borderLimit+i.y?r=this.borderLimit+i.y-this._positionY:this._positionY>i.y+i.height-this.borderLimit?r=this._positionY-i.y-i.height+this.borderLimit:r=0;let n=s>r?s:r;n-=this.viewportBorder,n>this.borderLimit&&(n=this.borderLimit);let o=1-oe.Clamp(n/this.borderLimit,0,1);if(o<0)return!1;o>1&&(o=1),this.viewportBorder>0&&(i.x+=this.viewportBorder,i.y+=this.viewportBorder,i.width-=this.viewportBorder*2,i.height-=this.viewportBorder*2,this._positionX-=this.viewportBorder,this._positionY-=this.viewportBorder);const l=i.x+i.width/2,h=i.y+i.height/2,c=l-this._positionX,u=h-this._positionY;e.setState(!1),e.setDepthBuffer(!1);for(let d=0;d<this.lensFlares.length;d++){const f=this.lensFlares[d];if(!f._drawWrapper.effect.isReady()||f.texture&&!f.texture.isReady())continue;e.enableEffect(f._drawWrapper),e.bindBuffers(this._vertexBuffers,this._indexBuffer,f._drawWrapper.effect),e.setAlphaMode(f.alphaMode);const p=l-c*f.position,_=h-u*f.position,m=f.size,v=f.size*e.getAspectRatio(this._scene.activeCamera,!0),x=2*(p/(i.width+i.x*2))-1,b=1-2*(_/(i.height+i.y*2)),S=L.FromValues(m/2,0,0,0,0,v/2,0,0,0,0,1,0,x,b,0,1);f._drawWrapper.effect.setMatrix("viewportMatrix",S),f._drawWrapper.effect.setTexture("textureSampler",f.texture),f._drawWrapper.effect.setFloat4("color",f.color.r*o,f.color.g*o,f.color.b*o,1),e.drawElementsType(ne.TriangleFillMode,0,6)}return e.setDepthBuffer(!0),e.setAlphaMode(0),!0}rebuild(){var e;this._createIndexBuffer();for(const t in this._vertexBuffers)(e=this._vertexBuffers[t])===null||e===void 0||e._rebuild()}dispose(){const e=this._vertexBuffers[y.PositionKind];for(e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this._indexBuffer&&(this._scene.getEngine()._releaseBuffer(this._indexBuffer),this._indexBuffer=null);this.lensFlares.length;)this.lensFlares[0].dispose();const t=this._scene.lensFlareSystems.indexOf(this);this._scene.lensFlareSystems.splice(t,1)}static Parse(e,t,i){const s=t.getLastEntryById(e.emitterId),r=e.name||"lensFlareSystem#"+e.emitterId,n=new No(r,s,t);n.id=e.id||r,n.borderLimit=e.borderLimit;for(let o=0;o<e.flares.length;o++){const l=e.flares[o];h0.AddFlare(l.size,l.position,re.FromArray(l.color),l.textureName?i+l.textureName:"",n)}return n}serialize(){const e={};e.id=this.id,e.name=this.name,e.emitterId=this.getEmitter().id,e.borderLimit=this.borderLimit,e.flares=[];for(let t=0;t<this.lensFlares.length;t++){const i=this.lensFlares[t];e.flares.push({size:i.size,position:i.position,color:i.color.asArray(),textureName:q.GetFilename(i.texture?i.texture.name:"")})}return e}}No._SceneComponentInitialization=a=>{throw Ve("LensFlareSystemSceneComponent")};li.AddParser(ue.NAME_LENSFLARESYSTEM,(a,e,t,i)=>{if(a.lensFlareSystems!==void 0&&a.lensFlareSystems!==null){t.lensFlareSystems||(t.lensFlareSystems=new Array);for(let s=0,r=a.lensFlareSystems.length;s<r;s++){const n=a.lensFlareSystems[s],o=No.Parse(n,e,i);t.lensFlareSystems.push(o)}}});li.prototype.getLensFlareSystemByName=function(a){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].name===a)return this.lensFlareSystems[e];return null};li.prototype.getLensFlareSystemById=function(a){for(let e=0;e<this.lensFlareSystems.length;e++)if(this.lensFlareSystems[e].id===a)return this.lensFlareSystems[e];return null};li.prototype.getLensFlareSystemByID=function(a){return this.getLensFlareSystemById(a)};li.prototype.removeLensFlareSystem=function(a){const e=this.lensFlareSystems.indexOf(a);return e!==-1&&this.lensFlareSystems.splice(e,1),e};li.prototype.addLensFlareSystem=function(a){this.lensFlareSystems.push(a)};class nA{constructor(e){this.name=ue.NAME_LENSFLARESYSTEM,this.scene=e,e.lensFlareSystems=new Array}register(){this.scene._afterCameraDrawStage.registerStep(ue.STEP_AFTERCAMERADRAW_LENSFLARESYSTEM,this,this._draw)}rebuild(){for(let e=0;e<this.scene.lensFlareSystems.length;e++)this.scene.lensFlareSystems[e].rebuild()}addFromContainer(e){!e.lensFlareSystems||e.lensFlareSystems.forEach(t=>{this.scene.addLensFlareSystem(t)})}removeFromContainer(e,t){!e.lensFlareSystems||e.lensFlareSystems.forEach(i=>{this.scene.removeLensFlareSystem(i),t&&i.dispose()})}serialize(e){e.lensFlareSystems=[];const t=this.scene.lensFlareSystems;for(const i of t)e.lensFlareSystems.push(i.serialize())}dispose(){const e=this.scene.lensFlareSystems;for(;e.length;)e[0].dispose()}_draw(e){if(this.scene.lensFlaresEnabled){const t=this.scene.lensFlareSystems;q.StartPerformanceCounter("Lens flares",t.length>0);for(const i of t)(e.layerMask&i.layerMask)!==0&&i.render();q.EndPerformanceCounter("Lens flares",t.length>0)}}}No._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_LENSFLARESYSTEM);e||(e=new nA(a),a._addComponent(e))};const aA="bayerDitherFunctions",oA=`float bayerDither2(vec2 _P) {
return mod(2.0*_P.y+_P.x+1.0,4.0);
}
float bayerDither4(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5*mod(_P,4.0)); 
return 4.0*bayerDither2(P1)+bayerDither2(P2);
}
float bayerDither8(vec2 _P) {
vec2 P1=mod(_P,2.0); 
vec2 P2=floor(0.5 *mod(_P,4.0)); 
vec2 P4=floor(0.25*mod(_P,8.0)); 
return 4.0*(4.0*bayerDither2(P1)+bayerDither2(P2))+bayerDither2(P4);
}
`;Y.IncludesShadersStore[aA]=oA;const lA="shadowMapFragmentExtraDeclaration",hA=`#if SM_FLOAT==0
#include<packingFunctions>
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#include<bayerDitherFunctions>
uniform float softTransparentShadowSM;
#endif
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
uniform vec3 lightDataSM;
varying vec3 vPositionWSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;Y.IncludesShadersStore[lA]=hA;const cA="shadowMapFragment",uA=`float depthSM=vDepthMetricSM;
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
#if SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
#ifdef USE_REVERSE_DEPTHBUFFER
depthSM=(-zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
depthSM=(zSM+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_FragDepth=clamp(1.0-depthSM,0.0,1.0);
#else
gl_FragDepth=clamp(depthSM,0.0,1.0); 
#endif
#elif SM_USEDISTANCE==1
depthSM=(length(vPositionWSM-lightDataSM)+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#if SM_ESM==1
depthSM=clamp(exp(-min(87.,biasAndScaleSM.z*depthSM)),0.,1.);
#endif
#if SM_FLOAT==1
gl_FragColor=vec4(depthSM,1.0,1.0,1.0);
#else
gl_FragColor=pack(depthSM);
#endif
return;`;Y.IncludesShadersStore[cA]=uA;const dA="shadowMapPixelShader",fA=`#include<shadowMapFragmentExtraDeclaration>
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
float alphaFromAlphaTexture=texture2D(diffuseSampler,vUV).a;
if (alphaFromAlphaTexture<ALPHATESTVALUE)
discard;
#endif
#if SM_SOFTTRANSPARENTSHADOW==1
#ifdef ALPHATEST
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alphaFromAlphaTexture) discard;
#else
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM) discard;
#endif
#endif
#include<shadowMapFragment>
}`;Y.ShadersStore[dA]=fA;const pA="sceneVertexDeclaration",_A=`uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform vec4 vEyePosition;
`;Y.IncludesShadersStore[pA]=_A;const mA="meshVertexDeclaration",gA=`uniform mat4 world;
uniform float visibility;
`;Y.IncludesShadersStore[mA]=gA;const vA="shadowMapVertexDeclaration",xA=`#include<sceneVertexDeclaration>
#include<meshVertexDeclaration>
`;Y.IncludesShadersStore[vA]=xA;const TA="shadowMapUboDeclaration",bA=`layout(std140,column_major) uniform;
#include<sceneUboDeclaration>
#include<meshUboDeclaration>
`;Y.IncludesShadersStore[TA]=bA;const SA="shadowMapVertexExtraDeclaration",EA=`#if SM_NORMALBIAS==1
uniform vec3 lightDataSM;
#endif
uniform vec3 biasAndScaleSM;
uniform vec2 depthValuesSM;
varying float vDepthMetricSM;
#if SM_USEDISTANCE==1
varying vec3 vPositionWSM;
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
varying float zSM;
#endif
`;Y.IncludesShadersStore[SA]=EA;const CA="shadowMapVertexNormalBias",yA=`#if SM_NORMALBIAS==1
#if SM_DIRECTIONINLIGHTDATA==1
vec3 worldLightDirSM=normalize(-lightDataSM.xyz);
#else
vec3 directionToLightSM=lightDataSM.xyz-worldPos.xyz;
vec3 worldLightDirSM=normalize(directionToLightSM);
#endif
float ndlSM=dot(vNormalW,worldLightDirSM);
float sinNLSM=sqrt(1.0-ndlSM*ndlSM);
float normalBiasSM=biasAndScaleSM.y*sinNLSM;
worldPos.xyz-=vNormalW*normalBiasSM;
#endif
`;Y.IncludesShadersStore[CA]=yA;const AA="shadowMapVertexMetric",RA=`#if SM_USEDISTANCE==1
vPositionWSM=worldPos.xyz;
#endif
#if SM_DEPTHTEXTURE==1
#ifdef IS_NDC_HALF_ZRANGE
#define BIASFACTOR 0.5
#else
#define BIASFACTOR 1.0
#endif
#ifdef USE_REVERSE_DEPTHBUFFER
gl_Position.z-=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#else
gl_Position.z+=biasAndScaleSM.x*gl_Position.w*BIASFACTOR;
#endif
#endif
#if defined(SM_DEPTHCLAMP) && SM_DEPTHCLAMP==1
zSM=gl_Position.z;
gl_Position.z=0.0;
#elif SM_USEDISTANCE==0
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetricSM=(-gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#else
vDepthMetricSM=(gl_Position.z+depthValuesSM.x)/depthValuesSM.y+biasAndScaleSM.x;
#endif
#endif
`;Y.IncludesShadersStore[AA]=RA;const IA="shadowMapVertexShader",PA=`attribute vec3 position;
#ifdef NORMAL
attribute vec3 normal;
#endif
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#ifdef INSTANCES
attribute vec4 world0;
attribute vec4 world1;
attribute vec4 world2;
attribute vec4 world3;
#endif
#include<helperFunctions>
#include<__decl__shadowMapVertex>
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<shadowMapVertexExtraDeclaration>
#include<clipPlaneVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#ifdef NORMAL
vec3 normalUpdated=normal;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#ifdef NORMAL
mat3 normWorldSM=mat3(finalWorld);
#if defined(INSTANCES) && defined(THIN_INSTANCES)
vec3 vNormalW=normalUpdated/vec3(dot(normWorldSM[0],normWorldSM[0]),dot(normWorldSM[1],normWorldSM[1]),dot(normWorldSM[2],normWorldSM[2]));
vNormalW=normalize(normWorldSM*vNormalW);
#else
#ifdef NONUNIFORMSCALING
normWorldSM=transposeMat3(inverseMat3(normWorldSM));
#endif
vec3 vNormalW=normalize(normWorldSM*normalUpdated);
#endif
#endif
#include<shadowMapVertexNormalBias>
gl_Position=viewProjection*worldPos;
#include<shadowMapVertexMetric>
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
}`;Y.ShadersStore[IA]=PA;const MA="depthBoxBlurPixelShader",DA=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 colorDepth=vec4(0.0);
for (int x=-OFFSET; x<=OFFSET; x++)
for (int y=-OFFSET; y<=OFFSET; y++)
colorDepth+=texture2D(textureSampler,vUV+vec2(x,y)/screenSize);
gl_FragColor=(colorDepth/float((OFFSET*2+1)*(OFFSET*2+1)));
}`;Y.ShadersStore[MA]=DA;const OA="shadowMapFragmentSoftTransparentShadow",wA=`#if SM_SOFTTRANSPARENTSHADOW==1
if ((bayerDither8(floor(mod(gl_FragCoord.xy,8.0))))/64.0>=softTransparentShadowSM*alpha) discard;
#endif
`;Y.IncludesShadersStore[OA]=wA;class De{constructor(e,t,i){this.onBeforeShadowMapRenderObservable=new X,this.onAfterShadowMapRenderObservable=new X,this.onBeforeShadowMapRenderMeshObservable=new X,this.onAfterShadowMapRenderMeshObservable=new X,this._bias=5e-5,this._normalBias=0,this._blurBoxOffset=1,this._blurScale=2,this._blurKernel=1,this._useKernelBlur=!1,this._filter=De.FILTER_NONE,this._filteringQuality=De.QUALITY_HIGH,this._contactHardeningLightSizeUVRatio=.1,this._darkness=0,this._transparencyShadow=!1,this.enableSoftTransparentShadow=!1,this.useOpacityTextureForTransparentShadow=!1,this.frustumEdgeFalloff=0,this.forceBackFacesOnly=!1,this._lightDirection=g.Zero(),this._viewMatrix=L.Zero(),this._projectionMatrix=L.Zero(),this._transformMatrix=L.Zero(),this._cachedPosition=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cachedDirection=new g(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._currentFaceIndex=0,this._currentFaceIndexCache=0,this._defaultTextureMatrix=L.Identity(),this._mapSize=e,this._light=t,this._scene=t.getScene(),t._shadowGenerator=this,this.id=t.id,this._useUBO=this._scene.getEngine().supportsUniformBuffers,this._useUBO&&(this._sceneUBOs=[],this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for Shadow Generator (light "${this._light.name}")`))),De._SceneComponentInitialization(this._scene);const s=this._scene.getEngine().getCaps();i?s.textureFloatRender&&s.textureFloatLinearFiltering?this._textureType=1:s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?this._textureType=2:this._textureType=0:s.textureHalfFloatRender&&s.textureHalfFloatLinearFiltering?this._textureType=2:s.textureFloatRender&&s.textureFloatLinearFiltering?this._textureType=1:this._textureType=0,this._initializeGenerator(),this._applyFilterValues()}get bias(){return this._bias}set bias(e){this._bias=e}get normalBias(){return this._normalBias}set normalBias(e){this._normalBias=e}get blurBoxOffset(){return this._blurBoxOffset}set blurBoxOffset(e){this._blurBoxOffset!==e&&(this._blurBoxOffset=e,this._disposeBlurPostProcesses())}get blurScale(){return this._blurScale}set blurScale(e){this._blurScale!==e&&(this._blurScale=e,this._disposeBlurPostProcesses())}get blurKernel(){return this._blurKernel}set blurKernel(e){this._blurKernel!==e&&(this._blurKernel=e,this._disposeBlurPostProcesses())}get useKernelBlur(){return this._useKernelBlur}set useKernelBlur(e){this._useKernelBlur!==e&&(this._useKernelBlur=e,this._disposeBlurPostProcesses())}get depthScale(){return this._depthScale!==void 0?this._depthScale:this._light.getDepthScale()}set depthScale(e){this._depthScale=e}_validateFilter(e){return e}get filter(){return this._filter}set filter(e){if(e=this._validateFilter(e),this._light.needCube()){if(e===De.FILTER_BLUREXPONENTIALSHADOWMAP){this.useExponentialShadowMap=!0;return}else if(e===De.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP){this.useCloseExponentialShadowMap=!0;return}else if(e===De.FILTER_PCF||e===De.FILTER_PCSS){this.usePoissonSampling=!0;return}}if((e===De.FILTER_PCF||e===De.FILTER_PCSS)&&!this._scene.getEngine()._features.supportShadowSamplers){this.usePoissonSampling=!0;return}this._filter!==e&&(this._filter=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get usePoissonSampling(){return this.filter===De.FILTER_POISSONSAMPLING}set usePoissonSampling(e){const t=this._validateFilter(De.FILTER_POISSONSAMPLING);!e&&this.filter!==De.FILTER_POISSONSAMPLING||(this.filter=e?t:De.FILTER_NONE)}get useExponentialShadowMap(){return this.filter===De.FILTER_EXPONENTIALSHADOWMAP}set useExponentialShadowMap(e){const t=this._validateFilter(De.FILTER_EXPONENTIALSHADOWMAP);!e&&this.filter!==De.FILTER_EXPONENTIALSHADOWMAP||(this.filter=e?t:De.FILTER_NONE)}get useBlurExponentialShadowMap(){return this.filter===De.FILTER_BLUREXPONENTIALSHADOWMAP}set useBlurExponentialShadowMap(e){const t=this._validateFilter(De.FILTER_BLUREXPONENTIALSHADOWMAP);!e&&this.filter!==De.FILTER_BLUREXPONENTIALSHADOWMAP||(this.filter=e?t:De.FILTER_NONE)}get useCloseExponentialShadowMap(){return this.filter===De.FILTER_CLOSEEXPONENTIALSHADOWMAP}set useCloseExponentialShadowMap(e){const t=this._validateFilter(De.FILTER_CLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==De.FILTER_CLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:De.FILTER_NONE)}get useBlurCloseExponentialShadowMap(){return this.filter===De.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP}set useBlurCloseExponentialShadowMap(e){const t=this._validateFilter(De.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP);!e&&this.filter!==De.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP||(this.filter=e?t:De.FILTER_NONE)}get usePercentageCloserFiltering(){return this.filter===De.FILTER_PCF}set usePercentageCloserFiltering(e){const t=this._validateFilter(De.FILTER_PCF);!e&&this.filter!==De.FILTER_PCF||(this.filter=e?t:De.FILTER_NONE)}get filteringQuality(){return this._filteringQuality}set filteringQuality(e){this._filteringQuality!==e&&(this._filteringQuality=e,this._disposeBlurPostProcesses(),this._applyFilterValues(),this._light._markMeshesAsLightDirty())}get useContactHardeningShadow(){return this.filter===De.FILTER_PCSS}set useContactHardeningShadow(e){const t=this._validateFilter(De.FILTER_PCSS);!e&&this.filter!==De.FILTER_PCSS||(this.filter=e?t:De.FILTER_NONE)}get contactHardeningLightSizeUVRatio(){return this._contactHardeningLightSizeUVRatio}set contactHardeningLightSizeUVRatio(e){this._contactHardeningLightSizeUVRatio=e}get darkness(){return this._darkness}set darkness(e){this.setDarkness(e)}getDarkness(){return this._darkness}setDarkness(e){return e>=1?this._darkness=1:e<=0?this._darkness=0:this._darkness=e,this}get transparencyShadow(){return this._transparencyShadow}set transparencyShadow(e){this.setTransparencyShadow(e)}setTransparencyShadow(e){return this._transparencyShadow=e,this}getShadowMap(){return this._shadowMap}getShadowMapForRendering(){return this._shadowMap2?this._shadowMap2:this._shadowMap}getClassName(){return De.CLASSNAME}addShadowCaster(e,t=!0){if(!this._shadowMap)return this;if(this._shadowMap.renderList||(this._shadowMap.renderList=[]),this._shadowMap.renderList.indexOf(e)===-1&&this._shadowMap.renderList.push(e),t)for(const i of e.getChildMeshes())this._shadowMap.renderList.indexOf(i)===-1&&this._shadowMap.renderList.push(i);return this}removeShadowCaster(e,t=!0){if(!this._shadowMap||!this._shadowMap.renderList)return this;const i=this._shadowMap.renderList.indexOf(e);if(i!==-1&&this._shadowMap.renderList.splice(i,1),t)for(const s of e.getChildren())this.removeShadowCaster(s);return this}getLight(){return this._light}get mapSize(){return this._mapSize}set mapSize(e){this._mapSize=e,this._light._markMeshesAsLightDirty(),this.recreateShadowMap()}_initializeGenerator(){this._light._markMeshesAsLightDirty(),this._initializeShadowMap()}_createTargetRenderTexture(){const e=this._scene.getEngine();e._features.supportDepthStencilTexture?(this._shadowMap=new si(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube(),void 0,!1,!1),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)):this._shadowMap=new si(this._light.name+"_shadowMap",this._mapSize,this._scene,!1,!0,this._textureType,this._light.needCube())}_initializeShadowMap(){if(this._createTargetRenderTexture(),this._shadowMap===null)return;this._shadowMap.wrapU=H.CLAMP_ADDRESSMODE,this._shadowMap.wrapV=H.CLAMP_ADDRESSMODE,this._shadowMap.anisotropicFilteringLevel=1,this._shadowMap.updateSamplingMode(H.BILINEAR_SAMPLINGMODE),this._shadowMap.renderParticles=!1,this._shadowMap.ignoreCameraViewport=!0,this._storedUniqueId&&(this._shadowMap.uniqueId=this._storedUniqueId),this._shadowMap.customRenderFunction=this._renderForShadowMap.bind(this),this._shadowMap.customIsReadyFunction=()=>!0;const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.add(()=>{var s;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(s=e._debugPushGroup)===null||s===void 0||s.call(e,`shadow map generation for pass id ${e.currentRenderPassId}`,1)}),this._shadowMap.onBeforeRenderObservable.add(s=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[0]),this._currentFaceIndex=s,this._filter===De.FILTER_PCF&&e.setColorWrite(!1),this.getTransformMatrix(),this._scene.setTransformMatrix(this._viewMatrix,this._projectionMatrix),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onAfterUnbindObservable.add(()=>{var s,r;if(this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._currentSceneUBO),this._scene.updateTransformMatrix(),this._filter===De.FILTER_PCF&&e.setColorWrite(!0),!this.useBlurExponentialShadowMap&&!this.useBlurCloseExponentialShadowMap){(s=e._debugPopGroup)===null||s===void 0||s.call(e,1);return}const n=this.getShadowMapForRendering();n&&(this._scene.postProcessManager.directRender(this._blurPostProcesses,n.renderTarget,!0),e.unBindFramebuffer(n.renderTarget,!0),(r=e._debugPopGroup)===null||r===void 0||r.call(e,1))});const t=new J(0,0,0,0),i=new J(1,1,1,1);this._shadowMap.onClearObservable.add(s=>{this._filter===De.FILTER_PCF?s.clear(i,!1,!0,!1):this.useExponentialShadowMap||this.useBlurExponentialShadowMap?s.clear(t,!0,!0,!1):s.clear(i,!0,!0,!1)}),this._shadowMap.onResizeObservable.add(s=>{this._storedUniqueId=this._shadowMap.uniqueId,this._mapSize=s.getRenderSize(),this._light._markMeshesAsLightDirty(),this.recreateShadowMap()});for(let s=ns.MIN_RENDERINGGROUPS;s<ns.MAX_RENDERINGGROUPS;s++)this._shadowMap.setRenderingAutoClearDepthStencil(s,!1)}_initializeBlurRTTAndPostProcesses(){const e=this._scene.getEngine(),t=this._mapSize/this.blurScale;(!this.useKernelBlur||this.blurScale!==1)&&(this._shadowMap2=new si(this._light.name+"_shadowMap2",t,this._scene,!1,!0,this._textureType,void 0,void 0,!1),this._shadowMap2.wrapU=H.CLAMP_ADDRESSMODE,this._shadowMap2.wrapV=H.CLAMP_ADDRESSMODE,this._shadowMap2.updateSamplingMode(H.BILINEAR_SAMPLINGMODE)),this.useKernelBlur?(this._kernelBlurXPostprocess=new Ei(this._light.name+"KernelBlurX",new le(1,0),this.blurKernel,1,null,H.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.width=t,this._kernelBlurXPostprocess.height=t,this._kernelBlurXPostprocess.externalTextureSamplerBinding=!0,this._kernelBlurXPostprocess.onApplyObservable.add(i=>{i.setTexture("textureSampler",this._shadowMap)}),this._kernelBlurYPostprocess=new Ei(this._light.name+"KernelBlurY",new le(0,1),this.blurKernel,1,null,H.BILINEAR_SAMPLINGMODE,e,!1,this._textureType),this._kernelBlurXPostprocess.autoClear=!1,this._kernelBlurYPostprocess.autoClear=!1,this._textureType===0&&(this._kernelBlurXPostprocess.packedFloat=!0,this._kernelBlurYPostprocess.packedFloat=!0),this._blurPostProcesses=[this._kernelBlurXPostprocess,this._kernelBlurYPostprocess]):(this._boxBlurPostprocess=new Fe(this._light.name+"DepthBoxBlur","depthBoxBlur",["screenSize","boxOffset"],[],1,null,H.BILINEAR_SAMPLINGMODE,e,!1,"#define OFFSET "+this._blurBoxOffset,this._textureType),this._boxBlurPostprocess.externalTextureSamplerBinding=!0,this._boxBlurPostprocess.onApplyObservable.add(i=>{i.setFloat2("screenSize",t,t),i.setTexture("textureSampler",this._shadowMap)}),this._boxBlurPostprocess.autoClear=!1,this._blurPostProcesses=[this._boxBlurPostprocess])}_renderForShadowMap(e,t,i,s){let r;if(s.length)for(r=0;r<s.length;r++)this._renderSubMeshForShadowMap(s.data[r]);for(r=0;r<e.length;r++)this._renderSubMeshForShadowMap(e.data[r]);for(r=0;r<t.length;r++)this._renderSubMeshForShadowMap(t.data[r]);if(this._transparencyShadow)for(r=0;r<i.length;r++)this._renderSubMeshForShadowMap(i.data[r],!0);else for(r=0;r<i.length;r++)i.data[r].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}_bindCustomEffectForRenderSubMeshForShadowMap(e,t,i){t.setMatrix("viewProjection",this.getTransformMatrix())}_renderSubMeshForShadowMap(e,t=!1){var i,s;const r=e.getRenderingMesh(),n=e.getEffectiveMesh(),o=this._scene,l=o.getEngine(),h=e.getMaterial();if(n._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!h||e.verticesCount===0||e._renderId===o.getRenderId())return;const c=n._getWorldMatrixDeterminant()<0;let u=(i=r.overrideMaterialSideOrientation)!==null&&i!==void 0?i:h.sideOrientation;c&&(u=u===0?1:0);const d=u===0;l.setState(h.backFaceCulling,void 0,void 0,d,h.cullBackFaces);const f=r._getInstancesRenderList(e._id,!!e.getReplacementMesh());if(f.mustReturn)return;const p=l.getCaps().instancedArrays&&(f.visibleInstances[e._id]!==null&&f.visibleInstances[e._id]!==void 0||r.hasThinInstances);if(!(this.customAllowRendering&&!this.customAllowRendering(e)))if(this.isReady(e,p,t)){e._renderId=o.getRenderId();const _=h.shadowDepthWrapper,m=(s=_==null?void 0:_.getEffect(e,this,l.currentRenderPassId))!==null&&s!==void 0?s:e._getDrawWrapper(),v=Vi.GetEffect(m);if(l.enableEffect(m),p||r._bind(e,v,h.fillMode),this.getTransformMatrix(),v.setFloat3("biasAndScaleSM",this.bias,this.normalBias,this.depthScale),this.getLight().getTypeID()===je.LIGHTTYPEID_DIRECTIONALLIGHT?v.setVector3("lightDataSM",this._cachedDirection):v.setVector3("lightDataSM",this._cachedPosition),o.activeCamera&&v.setFloat2("depthValuesSM",this.getLight().getDepthMinZ(o.activeCamera),this.getLight().getDepthMinZ(o.activeCamera)+this.getLight().getDepthMaxZ(o.activeCamera)),t&&this.enableSoftTransparentShadow&&v.setFloat("softTransparentShadowSM",n.visibility*h.alpha),_)e._setMainDrawWrapperOverride(m),_.standalone?_.baseMaterial.bindForSubMesh(n.getWorldMatrix(),r,e):h.bindForSubMesh(n.getWorldMatrix(),r,e),e._setMainDrawWrapperOverride(null);else{if(h&&this.useOpacityTextureForTransparentShadow){const b=h.opacityTexture;b&&(v.setTexture("diffuseSampler",b),v.setMatrix("diffuseMatrix",b.getTextureMatrix()||this._defaultTextureMatrix))}else if(h&&h.needAlphaTesting()){const b=h.getAlphaTestTexture();b&&(v.setTexture("diffuseSampler",b),v.setMatrix("diffuseMatrix",b.getTextureMatrix()||this._defaultTextureMatrix))}if(r.useBones&&r.computeBonesUsingShaders&&r.skeleton){const b=r.skeleton;if(b.isUsingTextureForMatrices){const S=b.getTransformMatrixTexture(r);if(!S)return;v.setTexture("boneSampler",S),v.setFloat("boneTextureWidth",4*(b.bones.length+1))}else v.setMatrices("mBones",b.getTransformMatrices(r))}se.BindMorphTargetParameters(r,v),r.morphTargetManager&&r.morphTargetManager.isUsingTextureForTargets&&r.morphTargetManager._bind(v),se.BindClipPlane(v,o)}!this._useUBO&&!_&&this._bindCustomEffectForRenderSubMeshForShadowMap(e,v,n),se.BindSceneUniformBuffer(v,this._scene.getSceneUniformBuffer()),this._scene.getSceneUniformBuffer().bindUniformBuffer();const x=n.getWorldMatrix();p&&(n.getMeshUniformBuffer().bindToEffect(v,"Mesh"),n.transferToEffect(x)),this.forceBackFacesOnly&&l.setState(!0,0,!1,!0,h.cullBackFaces),this.onBeforeShadowMapRenderMeshObservable.notifyObservers(r),this.onBeforeShadowMapRenderObservable.notifyObservers(v),r._processRendering(n,e,v,h.fillMode,f,p,(b,S)=>{n!==r&&!b?(r.getMeshUniformBuffer().bindToEffect(v,"Mesh"),r.transferToEffect(S)):(n.getMeshUniformBuffer().bindToEffect(v,"Mesh"),n.transferToEffect(b?S:x))}),this.forceBackFacesOnly&&l.setState(!0,0,!1,!1,h.cullBackFaces),this.onAfterShadowMapRenderObservable.notifyObservers(v),this.onAfterShadowMapRenderMeshObservable.notifyObservers(r)}else this._shadowMap&&this._shadowMap.resetRefreshCounter()}_applyFilterValues(){!this._shadowMap||(this.filter===De.FILTER_NONE||this.filter===De.FILTER_PCSS?this._shadowMap.updateSamplingMode(H.NEAREST_SAMPLINGMODE):this._shadowMap.updateSamplingMode(H.BILINEAR_SAMPLINGMODE))}forceCompilation(e,t){const i={useInstances:!1,...t},s=this.getShadowMap();if(!s){e&&e(this);return}const r=s.renderList;if(!r){e&&e(this);return}const n=new Array;for(const h of r)n.push(...h.subMeshes);if(n.length===0){e&&e(this);return}let o=0;const l=()=>{var h,c;if(!(!this._scene||!this._scene.getEngine())){for(;this.isReady(n[o],i.useInstances,(c=(h=n[o].getMaterial())===null||h===void 0?void 0:h.needAlphaBlendingForMesh(n[o].getMesh()))!==null&&c!==void 0?c:!1);)if(o++,o>=n.length){e&&e(this);return}setTimeout(l,16)}};l()}forceCompilationAsync(e){return new Promise(t=>{this.forceCompilation(()=>{t()},e)})}_isReadyCustomDefines(e,t,i){}_prepareShadowDefines(e,t,i,s){i.push("#define SM_FLOAT "+(this._textureType!==0?"1":"0")),i.push("#define SM_ESM "+(this.useExponentialShadowMap||this.useBlurExponentialShadowMap?"1":"0")),i.push("#define SM_DEPTHTEXTURE "+(this.usePercentageCloserFiltering||this.useContactHardeningShadow?"1":"0"));const r=e.getMesh();return i.push("#define SM_NORMALBIAS "+(this.normalBias&&r.isVerticesDataPresent(y.NormalKind)?"1":"0")),i.push("#define SM_DIRECTIONINLIGHTDATA "+(this.getLight().getTypeID()===je.LIGHTTYPEID_DIRECTIONALLIGHT?"1":"0")),i.push("#define SM_USEDISTANCE "+(this._light.needCube()?"1":"0")),i.push("#define SM_SOFTTRANSPARENTSHADOW "+(this.enableSoftTransparentShadow&&s?"1":"0")),this._isReadyCustomDefines(i,e,t),i}isReady(e,t,i){var s;const r=e.getMaterial(),n=r==null?void 0:r.shadowDepthWrapper,o=[];if(this._prepareShadowDefines(e,t,o,i),n){if(!n.isReadyForSubMesh(e,o,this,t,this._scene.getEngine().currentRenderPassId))return!1}else{const l=e._getDrawWrapper(void 0,!0);let h=l.effect,c=l.defines;const u=[y.PositionKind],d=e.getMesh();if(this.normalBias&&d.isVerticesDataPresent(y.NormalKind)&&(u.push(y.NormalKind),o.push("#define NORMAL"),d.nonUniformScaling&&o.push("#define NONUNIFORMSCALING")),r&&r.needAlphaTesting()){let x=null;if(this.useOpacityTextureForTransparentShadow?x=r.opacityTexture:x=r.getAlphaTestTexture(),x){if(!x.isReady())return!1;const b=(s=r.alphaCutOff)!==null&&s!==void 0?s:De.DEFAULT_ALPHA_CUTOFF;o.push("#define ALPHATEST"),o.push(`#define ALPHATESTVALUE ${b}${b%1===0?".":""}`),d.isVerticesDataPresent(y.UVKind)&&(u.push(y.UVKind),o.push("#define UV1")),d.isVerticesDataPresent(y.UV2Kind)&&x.coordinatesIndex===1&&(u.push(y.UV2Kind),o.push("#define UV2"))}}const f=new Wa;if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){u.push(y.MatricesIndicesKind),u.push(y.MatricesWeightsKind),d.numBoneInfluencers>4&&(u.push(y.MatricesIndicesExtraKind),u.push(y.MatricesWeightsExtraKind));const x=d.skeleton;o.push("#define NUM_BONE_INFLUENCERS "+d.numBoneInfluencers),d.numBoneInfluencers>0&&f.addCPUSkinningFallback(0,d),x.isUsingTextureForMatrices?o.push("#define BONETEXTURE"):o.push("#define BonesPerMesh "+(x.bones.length+1))}else o.push("#define NUM_BONE_INFLUENCERS 0");const p=d.morphTargetManager;let _=0;p&&p.numInfluencers>0&&(o.push("#define MORPHTARGETS"),_=p.numInfluencers,o.push("#define NUM_MORPH_INFLUENCERS "+_),p.isUsingTextureForTargets&&o.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(u,d,_));const m=this._scene;if(m.clipPlane&&o.push("#define CLIPPLANE"),m.clipPlane2&&o.push("#define CLIPPLANE2"),m.clipPlane3&&o.push("#define CLIPPLANE3"),m.clipPlane4&&o.push("#define CLIPPLANE4"),m.clipPlane5&&o.push("#define CLIPPLANE5"),m.clipPlane6&&o.push("#define CLIPPLANE6"),t&&(o.push("#define INSTANCES"),se.PushAttributesForInstances(u),e.getRenderingMesh().hasThinInstances&&o.push("#define THIN_INSTANCES")),this.customShaderOptions&&this.customShaderOptions.defines)for(const x of this.customShaderOptions.defines)o.indexOf(x)===-1&&o.push(x);const v=o.join(`
`);if(c!==v){c=v;let x="shadowMap";const b=["world","mBones","viewProjection","diffuseMatrix","lightDataSM","depthValuesSM","biasAndScaleSM","morphTargetInfluences","boneTextureWidth","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","softTransparentShadowSM","morphTargetTextureInfo","morphTargetTextureIndices"],S=["diffuseSampler","boneSampler","morphTargets"],C=["Scene","Mesh"];if(this.customShaderOptions){if(x=this.customShaderOptions.shaderName,this.customShaderOptions.attributes)for(const A of this.customShaderOptions.attributes)u.indexOf(A)===-1&&u.push(A);if(this.customShaderOptions.uniforms)for(const A of this.customShaderOptions.uniforms)b.indexOf(A)===-1&&b.push(A);if(this.customShaderOptions.samplers)for(const A of this.customShaderOptions.samplers)S.indexOf(A)===-1&&S.push(A)}const E=this._scene.getEngine();h=E.createEffect(x,{attributes:u,uniformsNames:b,uniformBuffersNames:C,samplers:S,defines:v,fallbacks:f,onCompiled:null,onError:null,indexParameters:{maxSimultaneousMorphTargets:_}},E),l.setEffect(h,c)}if(!h.isReady())return!1}return(this.useBlurExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(!this._blurPostProcesses||!this._blurPostProcesses.length)&&this._initializeBlurRTTAndPostProcesses(),!(this._kernelBlurXPostprocess&&!this._kernelBlurXPostprocess.isReady()||this._kernelBlurYPostprocess&&!this._kernelBlurYPostprocess.isReady()||this._boxBlurPostprocess&&!this._boxBlurPostprocess.isReady())}prepareDefines(e,t){const i=this._scene,s=this._light;!i.shadowsEnabled||!s.shadowEnabled||(e["SHADOW"+t]=!0,this.useContactHardeningShadow?(e["SHADOWPCSS"+t]=!0,this._filteringQuality===De.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===De.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePercentageCloserFiltering?(e["SHADOWPCF"+t]=!0,this._filteringQuality===De.QUALITY_LOW?e["SHADOWLOWQUALITY"+t]=!0:this._filteringQuality===De.QUALITY_MEDIUM&&(e["SHADOWMEDIUMQUALITY"+t]=!0)):this.usePoissonSampling?e["SHADOWPOISSON"+t]=!0:this.useExponentialShadowMap||this.useBlurExponentialShadowMap?e["SHADOWESM"+t]=!0:(this.useCloseExponentialShadowMap||this.useBlurCloseExponentialShadowMap)&&(e["SHADOWCLOSEESM"+t]=!0),s.needCube()&&(e["SHADOWCUBE"+t]=!0))}bindShadowLight(e,t){const i=this._light,s=this._scene;if(!s.shadowsEnabled||!i.shadowEnabled)return;const r=s.activeCamera;if(!r)return;const n=this.getShadowMap();!n||(i.needCube()||t.setMatrix("lightMatrix"+e,this.getTransformMatrix()),this._filter===De.FILTER_PCF?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),n.getSize().width,1/n.getSize().width,this.frustumEdgeFalloff,e)):this._filter===De.FILTER_PCSS?(t.setDepthStencilTexture("shadowSampler"+e,this.getShadowMapForRendering()),t.setTexture("depthSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/n.getSize().width,this._contactHardeningLightSizeUVRatio*n.getSize().width,this.frustumEdgeFalloff,e)):(t.setTexture("shadowSampler"+e,this.getShadowMapForRendering()),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),this.blurScale/n.getSize().width,this.depthScale,this.frustumEdgeFalloff,e)),i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e))}getTransformMatrix(){const e=this._scene;if(this._currentRenderId===e.getRenderId()&&this._currentFaceIndexCache===this._currentFaceIndex)return this._transformMatrix;this._currentRenderId=e.getRenderId(),this._currentFaceIndexCache=this._currentFaceIndex;let t=this._light.position;if(this._light.computeTransformedInformation()&&(t=this._light.transformedPosition),g.NormalizeToRef(this._light.getShadowDirection(this._currentFaceIndex),this._lightDirection),Math.abs(g.Dot(this._lightDirection,g.Up()))===1&&(this._lightDirection.z=1e-13),this._light.needProjectionMatrixCompute()||!this._cachedPosition||!this._cachedDirection||!t.equals(this._cachedPosition)||!this._lightDirection.equals(this._cachedDirection)){this._cachedPosition.copyFrom(t),this._cachedDirection.copyFrom(this._lightDirection),L.LookAtLHToRef(t,t.add(this._lightDirection),g.Up(),this._viewMatrix);const i=this.getShadowMap();if(i){const s=i.renderList;s&&this._light.setShadowProjectionMatrix(this._projectionMatrix,this._viewMatrix,s)}this._viewMatrix.multiplyToRef(this._projectionMatrix,this._transformMatrix)}return this._transformMatrix}recreateShadowMap(){const e=this._shadowMap;if(!e)return;const t=e.renderList;if(this._disposeRTTandPostProcesses(),this._initializeGenerator(),this.filter=this._filter,this._applyFilterValues(),t){this._shadowMap.renderList||(this._shadowMap.renderList=[]);for(const i of t)this._shadowMap.renderList.push(i)}else this._shadowMap.renderList=null}_disposeBlurPostProcesses(){this._shadowMap2&&(this._shadowMap2.dispose(),this._shadowMap2=null),this._boxBlurPostprocess&&(this._boxBlurPostprocess.dispose(),this._boxBlurPostprocess=null),this._kernelBlurXPostprocess&&(this._kernelBlurXPostprocess.dispose(),this._kernelBlurXPostprocess=null),this._kernelBlurYPostprocess&&(this._kernelBlurYPostprocess.dispose(),this._kernelBlurYPostprocess=null),this._blurPostProcesses=[]}_disposeRTTandPostProcesses(){this._shadowMap&&(this._shadowMap.dispose(),this._shadowMap=null),this._disposeBlurPostProcesses()}_disposeSceneUBOs(){if(this._sceneUBOs){for(const e of this._sceneUBOs)e.dispose();this._sceneUBOs=[]}}dispose(){this._disposeRTTandPostProcesses(),this._disposeSceneUBOs(),this._light&&(this._light._shadowGenerator=null,this._light._markMeshesAsLightDirty()),this.onBeforeShadowMapRenderMeshObservable.clear(),this.onBeforeShadowMapRenderObservable.clear(),this.onAfterShadowMapRenderMeshObservable.clear(),this.onAfterShadowMapRenderObservable.clear()}serialize(){const e={},t=this.getShadowMap();if(!t)return e;if(e.className=this.getClassName(),e.lightId=this._light.id,e.id=this.id,e.mapSize=t.getRenderSize(),e.forceBackFacesOnly=this.forceBackFacesOnly,e.darkness=this.getDarkness(),e.transparencyShadow=this._transparencyShadow,e.frustumEdgeFalloff=this.frustumEdgeFalloff,e.bias=this.bias,e.normalBias=this.normalBias,e.usePercentageCloserFiltering=this.usePercentageCloserFiltering,e.useContactHardeningShadow=this.useContactHardeningShadow,e.contactHardeningLightSizeUVRatio=this.contactHardeningLightSizeUVRatio,e.filteringQuality=this.filteringQuality,e.useExponentialShadowMap=this.useExponentialShadowMap,e.useBlurExponentialShadowMap=this.useBlurExponentialShadowMap,e.useCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.useBlurCloseExponentialShadowMap=this.useBlurExponentialShadowMap,e.usePoissonSampling=this.usePoissonSampling,e.depthScale=this.depthScale,e.blurBoxOffset=this.blurBoxOffset,e.blurKernel=this.blurKernel,e.blurScale=this.blurScale,e.useKernelBlur=this.useKernelBlur,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t,i){const s=t.getLightById(e.lightId),r=i?i(e.mapSize,s):new De(e.mapSize,s),n=r.getShadowMap();for(let o=0;o<e.renderList.length;o++)t.getMeshesById(e.renderList[o]).forEach(function(h){!n||(n.renderList||(n.renderList=[]),n.renderList.push(h))});return e.id!==void 0&&(r.id=e.id),r.forceBackFacesOnly=!!e.forceBackFacesOnly,e.darkness!==void 0&&r.setDarkness(e.darkness),e.transparencyShadow&&r.setTransparencyShadow(!0),e.frustumEdgeFalloff!==void 0&&(r.frustumEdgeFalloff=e.frustumEdgeFalloff),e.bias!==void 0&&(r.bias=e.bias),e.normalBias!==void 0&&(r.normalBias=e.normalBias),e.usePercentageCloserFiltering?r.usePercentageCloserFiltering=!0:e.useContactHardeningShadow?r.useContactHardeningShadow=!0:e.usePoissonSampling?r.usePoissonSampling=!0:e.useExponentialShadowMap?r.useExponentialShadowMap=!0:e.useBlurExponentialShadowMap?r.useBlurExponentialShadowMap=!0:e.useCloseExponentialShadowMap?r.useCloseExponentialShadowMap=!0:e.useBlurCloseExponentialShadowMap?r.useBlurCloseExponentialShadowMap=!0:e.useVarianceShadowMap?r.useExponentialShadowMap=!0:e.useBlurVarianceShadowMap&&(r.useBlurExponentialShadowMap=!0),e.contactHardeningLightSizeUVRatio!==void 0&&(r.contactHardeningLightSizeUVRatio=e.contactHardeningLightSizeUVRatio),e.filteringQuality!==void 0&&(r.filteringQuality=e.filteringQuality),e.depthScale&&(r.depthScale=e.depthScale),e.blurScale&&(r.blurScale=e.blurScale),e.blurBoxOffset&&(r.blurBoxOffset=e.blurBoxOffset),e.useKernelBlur&&(r.useKernelBlur=e.useKernelBlur),e.blurKernel&&(r.blurKernel=e.blurKernel),r}}De.CLASSNAME="ShadowGenerator";De.FILTER_NONE=0;De.FILTER_EXPONENTIALSHADOWMAP=1;De.FILTER_POISSONSAMPLING=2;De.FILTER_BLUREXPONENTIALSHADOWMAP=3;De.FILTER_CLOSEEXPONENTIALSHADOWMAP=4;De.FILTER_BLURCLOSEEXPONENTIALSHADOWMAP=5;De.FILTER_PCF=6;De.FILTER_PCSS=7;De.QUALITY_HIGH=0;De.QUALITY_MEDIUM=1;De.QUALITY_LOW=2;De.DEFAULT_ALPHA_CUTOFF=.5;De._SceneComponentInitialization=a=>{throw Ve("ShadowGeneratorSceneComponent")};const NA="depthPixelShader",FA=`#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
varying float vDepthMetric;
#ifdef PACKED
#include<packingFunctions>
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#ifdef NONLINEARDEPTH
#ifdef PACKED
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(gl_FragCoord.z,0.0,0.0,0.0);
#endif
#else
#ifdef PACKED
gl_FragColor=pack(vDepthMetric);
#else
gl_FragColor=vec4(vDepthMetric,0.0,0.0,1.0);
#endif
#endif
}`;Y.ShadersStore[NA]=FA;const LA="depthVertexShader",BA=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
varying float vDepthMetric;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(positionUpdated,1.0);
#include<clipPlaneVertex>
gl_Position=viewProjection*worldPos;
#ifdef USE_REVERSE_DEPTHBUFFER
vDepthMetric=((-gl_Position.z+depthValues.x)/(depthValues.y));
#else
vDepthMetric=((gl_Position.z+depthValues.x)/(depthValues.y));
#endif
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;Y.ShadersStore[LA]=BA;class Xo{constructor(e,t=1,i=null,s=!1,r=H.TRILINEAR_SAMPLINGMODE){this.enabled=!0,this.forceDepthWriteTransparentMeshes=!1,this.useOnlyInActiveCamera=!1,this._scene=e,this._storeNonLinearDepth=s,this.isPacked=t===0,this.isPacked?this._clearColor=new J(1,1,1,1):this._clearColor=new J(1,0,0,1),Xo._SceneComponentInitialization(this._scene);const n=e.getEngine();this._camera=i,r!==H.NEAREST_SAMPLINGMODE&&(t===1&&!n._caps.textureFloatLinearFiltering&&(r=H.NEAREST_SAMPLINGMODE),t===2&&!n._caps.textureHalfFloatLinearFiltering&&(r=H.NEAREST_SAMPLINGMODE));const o=this.isPacked||!n._features.supportExtendedTextureFormats?5:6;this._depthMap=new si("DepthRenderer",{width:n.getRenderWidth(),height:n.getRenderHeight()},this._scene,!1,!0,t,!1,r,void 0,void 0,void 0,o),this._depthMap.wrapU=H.CLAMP_ADDRESSMODE,this._depthMap.wrapV=H.CLAMP_ADDRESSMODE,this._depthMap.refreshRate=1,this._depthMap.renderParticles=!1,this._depthMap.renderList=null,this._depthMap.activeCamera=this._camera,this._depthMap.ignoreCameraViewport=!0,this._depthMap.useCameraPostProcesses=!1,this._depthMap.onClearObservable.add(h=>{h.clear(this._clearColor,!0,!0,!0)}),this._depthMap.onBeforeBindObservable.add(()=>{var h;(h=n._debugPushGroup)===null||h===void 0||h.call(n,"depth renderer",1)}),this._depthMap.onAfterUnbindObservable.add(()=>{var h;(h=n._debugPopGroup)===null||h===void 0||h.call(n,1)}),this._depthMap.customIsReadyFunction=(h,c)=>{if(!h.isReady(!1))return!1;if(c===0&&h.subMeshes)for(let u=0;u<h.subMeshes.length;++u){const d=h.subMeshes[u],f=d.getRenderingMesh(),p=f._getInstancesRenderList(d._id,!!d.getReplacementMesh()),_=n.getCaps().instancedArrays&&(p.visibleInstances[d._id]!==null&&p.visibleInstances[d._id]!==void 0||f.hasThinInstances);if(!this.isReady(d,_))return!1}return!0};const l=h=>{var c,u;const d=h.getRenderingMesh(),f=h.getEffectiveMesh(),p=this._scene,_=p.getEngine(),m=h.getMaterial();if(f._internalAbstractMeshDataInfo._isActiveIntermediate=!1,!m||f.infiniteDistance||m.disableDepthWrite||h.verticesCount===0||h._renderId===p.getRenderId())return;const v=f._getWorldMatrixDeterminant()<0;let x=(c=d.overrideMaterialSideOrientation)!==null&&c!==void 0?c:m.sideOrientation;v&&(x=x===0?1:0);const b=x===0;_.setState(m.backFaceCulling,0,!1,b,m.cullBackFaces);const S=d._getInstancesRenderList(h._id,!!h.getReplacementMesh());if(S.mustReturn)return;const C=_.getCaps().instancedArrays&&(S.visibleInstances[h._id]!==null&&S.visibleInstances[h._id]!==void 0||d.hasThinInstances),E=this._camera||p.activeCamera;if(this.isReady(h,C)&&E){h._renderId=p.getRenderId();const A=(u=f._internalAbstractMeshDataInfo._materialForRenderPass)===null||u===void 0?void 0:u[_.currentRenderPassId];let M=h._getDrawWrapper();!M&&A&&(M=A._getDrawWrapper());const D=E.mode===be.ORTHOGRAPHIC_CAMERA;if(!M)return;const P=M.effect;_.enableEffect(M),C||d._bind(h,P,m.fillMode),A?A.bindForSubMesh(f.getWorldMatrix(),f,h):(P.setMatrix("viewProjection",p.getTransformMatrix()),P.setMatrix("world",f.getWorldMatrix()));let O,N;if(D?(O=!_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1,N=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:1):(O=_.useReverseDepthBuffer&&_.isNDCHalfZRange?E.minZ:_.isNDCHalfZRange?0:E.minZ,N=_.useReverseDepthBuffer&&_.isNDCHalfZRange?0:E.maxZ),P.setFloat2("depthValues",O,O+N),!A){if(m&&m.needAlphaTesting()){const $=m.getAlphaTestTexture();$&&(P.setTexture("diffuseSampler",$),P.setMatrix("diffuseMatrix",$.getTextureMatrix()))}if(d.useBones&&d.computeBonesUsingShaders&&d.skeleton){const $=d.skeleton;if($.isUsingTextureForMatrices){const W=$.getTransformMatrixTexture(d);if(!W)return;P.setTexture("boneSampler",W),P.setFloat("boneTextureWidth",4*($.bones.length+1))}else P.setMatrices("mBones",$.getTransformMatrices(d))}se.BindClipPlane(P,p),se.BindMorphTargetParameters(d,P),d.morphTargetManager&&d.morphTargetManager.isUsingTextureForTargets&&d.morphTargetManager._bind(P)}d._processRendering(f,h,P,m.fillMode,S,C,($,W)=>P.setMatrix("world",W))}};this._depthMap.customRenderFunction=(h,c,u,d)=>{let f;if(d.length)for(f=0;f<d.length;f++)l(d.data[f]);for(f=0;f<h.length;f++)l(h.data[f]);for(f=0;f<c.length;f++)l(c.data[f]);if(this.forceDepthWriteTransparentMeshes)for(f=0;f<u.length;f++)l(u.data[f]);else for(f=0;f<u.length;f++)u.data[f].getEffectiveMesh()._internalAbstractMeshDataInfo._isActiveIntermediate=!1}}setMaterialForRendering(e,t){this._depthMap.setMaterialForRendering(e,t)}isReady(e,t){var i;const s=this._scene.getEngine(),r=e.getMesh(),n=r.getScene(),o=(i=r._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[s.currentRenderPassId];if(o)return o.isReadyForSubMesh(r,e,t);const l=e.getMaterial();if(!l||l.disableDepthWrite)return!1;const h=[],c=[y.PositionKind];if(l&&l.needAlphaTesting()&&l.getAlphaTestTexture()&&(h.push("#define ALPHATEST"),r.isVerticesDataPresent(y.UVKind)&&(c.push(y.UVKind),h.push("#define UV1")),r.isVerticesDataPresent(y.UV2Kind)&&(c.push(y.UV2Kind),h.push("#define UV2"))),r.useBones&&r.computeBonesUsingShaders){c.push(y.MatricesIndicesKind),c.push(y.MatricesWeightsKind),r.numBoneInfluencers>4&&(c.push(y.MatricesIndicesExtraKind),c.push(y.MatricesWeightsExtraKind)),h.push("#define NUM_BONE_INFLUENCERS "+r.numBoneInfluencers),h.push("#define BonesPerMesh "+(r.skeleton?r.skeleton.bones.length+1:0));const m=e.getRenderingMesh().skeleton;m!=null&&m.isUsingTextureForMatrices&&h.push("#define BONETEXTURE")}else h.push("#define NUM_BONE_INFLUENCERS 0");const u=r.morphTargetManager;let d=0;u&&u.numInfluencers>0&&(d=u.numInfluencers,h.push("#define MORPHTARGETS"),h.push("#define NUM_MORPH_INFLUENCERS "+d),u.isUsingTextureForTargets&&h.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(c,r,d)),t&&(h.push("#define INSTANCES"),se.PushAttributesForInstances(c),e.getRenderingMesh().hasThinInstances&&h.push("#define THIN_INSTANCES")),this._storeNonLinearDepth&&h.push("#define NONLINEARDEPTH"),this.isPacked&&h.push("#define PACKED"),n.clipPlane&&h.push("#define CLIPPLANE"),n.clipPlane2&&h.push("#define CLIPPLANE2"),n.clipPlane3&&h.push("#define CLIPPLANE3"),n.clipPlane4&&h.push("#define CLIPPLANE4"),n.clipPlane5&&h.push("#define CLIPPLANE5"),n.clipPlane6&&h.push("#define CLIPPLANE6");const f=e._getDrawWrapper(void 0,!0),p=f.defines,_=h.join(`
`);return p!==_&&f.setEffect(s.createEffect("depth",c,["world","mBones","boneTextureWidth","viewProjection","diffuseMatrix","depthValues","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6"],["diffuseSampler","morphTargets","boneSampler"],_,void 0,void 0,void 0,{maxSimultaneousMorphTargets:d}),_),f.effect.isReady()}getDepthMap(){return this._depthMap}dispose(){const e=[];for(const t in this._scene._depthRenderer)this._scene._depthRenderer[t]===this&&e.push(t);if(e.length>0){this._depthMap.dispose();for(const t of e)delete this._scene._depthRenderer[t]}}}Xo._SceneComponentInitialization=a=>{throw Ve("DepthRendererSceneComponent")};const UA="minmaxReduxPixelShader",VA=`varying vec2 vUV;
uniform sampler2D textureSampler;
#if defined(INITIAL)
uniform sampler2D sourceTexture;
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
float f1=texelFetch(sourceTexture,coord,0).r;
float f2=texelFetch(sourceTexture,coord+ivec2(1,0),0).r;
float f3=texelFetch(sourceTexture,coord+ivec2(1,1),0).r;
float f4=texelFetch(sourceTexture,coord+ivec2(0,1),0).r;
float minz=min(min(min(f1,f2),f3),f4);
#ifdef DEPTH_REDUX
float maxz=max(max(max(sign(1.0-f1)*f1,sign(1.0-f2)*f2),sign(1.0-f3)*f3),sign(1.0-f4)*f4);
#else
float maxz=max(max(max(f1,f2),f3),f4);
#endif
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(MAIN)
uniform vec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*(texSize-1.0));
vec2 f1=texelFetch(textureSampler,coord,0).rg;
vec2 f2=texelFetch(textureSampler,coord+ivec2(1,0),0).rg;
vec2 f3=texelFetch(textureSampler,coord+ivec2(1,1),0).rg;
vec2 f4=texelFetch(textureSampler,coord+ivec2(0,1),0).rg;
float minz=min(min(min(f1.x,f2.x),f3.x),f4.x);
float maxz=max(max(max(f1.y,f2.y),f3.y),f4.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(ONEBEFORELAST)
uniform ivec2 texSize;
void main(void)
{
ivec2 coord=ivec2(vUV*vec2(texSize-1));
vec2 f1=texelFetch(textureSampler,coord % texSize,0).rg;
vec2 f2=texelFetch(textureSampler,(coord+ivec2(1,0)) % texSize,0).rg;
vec2 f3=texelFetch(textureSampler,(coord+ivec2(1,1)) % texSize,0).rg;
vec2 f4=texelFetch(textureSampler,(coord+ivec2(0,1)) % texSize,0).rg;
float minz=min(f1.x,f2.x);
float maxz=max(f1.y,f2.y);
glFragColor=vec4(minz,maxz,0.,0.);
}
#elif defined(LAST)
void main(void)
{
glFragColor=vec4(0.);
if (true) { 
discard;
}
}
#endif
`;Y.ShadersStore[UA]=VA;class kA{constructor(e){this.onAfterReductionPerformed=new X,this._forceFullscreenViewport=!0,this._activated=!1,this._camera=e,this._postProcessManager=new Yh(e.getScene()),this._onContextRestoredObserver=e.getEngine().onContextRestoredObservable.add(()=>{this._postProcessManager._rebuild()})}get sourceTexture(){return this._sourceTexture}setSourceTexture(e,t,i=2,s=!0){if(e===this._sourceTexture)return;this.dispose(!1),this._sourceTexture=e,this._reductionSteps=[],this._forceFullscreenViewport=s;const r=this._camera.getScene(),n=new Fe("Initial reduction phase","minmaxRedux",["texSize"],["sourceTexture"],1,null,1,r.getEngine(),!1,"#define INITIAL"+(t?`
#define DEPTH_REDUX`:""),i,void 0,void 0,void 0,7);n.autoClear=!1,n.forceFullscreenViewport=s;let o=this._sourceTexture.getRenderWidth(),l=this._sourceTexture.getRenderHeight();n.onApply=((c,u)=>d=>{d.setTexture("sourceTexture",this._sourceTexture),d.setFloat2("texSize",c,u)})(o,l),this._reductionSteps.push(n);let h=1;for(;o>1||l>1;){o=Math.max(Math.round(o/2),1),l=Math.max(Math.round(l/2),1);const c=new Fe("Reduction phase "+h,"minmaxRedux",["texSize"],null,{width:o,height:l},null,1,r.getEngine(),!1,"#define "+(o==1&&l==1?"LAST":o==1||l==1?"ONEBEFORELAST":"MAIN"),i,void 0,void 0,void 0,7);if(c.autoClear=!1,c.forceFullscreenViewport=s,c.onApply=((u,d)=>f=>{u==1||d==1?f.setInt2("texSize",u,d):f.setFloat2("texSize",u,d)})(o,l),this._reductionSteps.push(c),h++,o==1&&l==1){const u=(d,f,p)=>{const _=new Float32Array(4*d*f),m={min:0,max:0};return()=>{r.getEngine()._readTexturePixels(p.inputTexture.texture,d,f,-1,0,_,!1),m.min=_[0],m.max=_[1],this.onAfterReductionPerformed.notifyObservers(m)}};c.onAfterRenderObservable.add(u(o,l,c))}}}get refreshRate(){return this._sourceTexture?this._sourceTexture.refreshRate:-1}set refreshRate(e){this._sourceTexture&&(this._sourceTexture.refreshRate=e)}get activated(){return this._activated}activate(){this._onAfterUnbindObserver||!this._sourceTexture||(this._onAfterUnbindObserver=this._sourceTexture.onAfterUnbindObservable.add(()=>{var e,t;const i=this._camera.getScene().getEngine();(e=i._debugPushGroup)===null||e===void 0||e.call(i,"min max reduction",1),this._reductionSteps[0].activate(this._camera),this._postProcessManager.directRender(this._reductionSteps,this._reductionSteps[0].inputTexture,this._forceFullscreenViewport),i.unBindFramebuffer(this._reductionSteps[0].inputTexture,!1),(t=i._debugPopGroup)===null||t===void 0||t.call(i,1)}),this._activated=!0)}deactivate(){!this._onAfterUnbindObserver||!this._sourceTexture||(this._sourceTexture.onAfterUnbindObservable.remove(this._onAfterUnbindObserver),this._onAfterUnbindObserver=null,this._activated=!1)}dispose(e=!0){if(e&&(this.onAfterReductionPerformed.clear(),this._onContextRestoredObserver&&(this._camera.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)),this.deactivate(),this._reductionSteps){for(let t=0;t<this._reductionSteps.length;++t)this._reductionSteps[t].dispose();this._reductionSteps=null}this._postProcessManager&&e&&this._postProcessManager.dispose(),this._sourceTexture=null}}class GA extends kA{constructor(e){super(e)}get depthRenderer(){return this._depthRenderer}setDepthRenderer(e=null,t=2,i=!0){const s=this._camera.getScene();this._depthRenderer&&(delete s._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null),e===null&&(s._depthRenderer||(s._depthRenderer={}),e=this._depthRenderer=new Xo(s,t,this._camera,!1,1),e.enabled=!1,this._depthRendererId="minmax"+this._camera.id,s._depthRenderer[this._depthRendererId]=e),super.setSourceTexture(e.getDepthMap(),!0,t,i)}setSourceTexture(e,t,i=2,s=!0){super.setSourceTexture(e,t,i,s)}activate(){this._depthRenderer&&(this._depthRenderer.enabled=!0),super.activate()}deactivate(){super.deactivate(),this._depthRenderer&&(this._depthRenderer.enabled=!1)}dispose(e=!0){if(super.dispose(e),this._depthRenderer&&e){const t=this._depthRenderer.getDepthMap().getScene();t&&delete t._depthRenderer[this._depthRendererId],this._depthRenderer.dispose(),this._depthRenderer=null}}}const rp=g.Up(),zA=g.Zero(),vi=new g,ro=new g,Th=new L;class Fi extends De{constructor(e,t,i){if(!Fi.IsSupported){B.Error("CascadedShadowMap is not supported by the current engine.");return}super(e,t,i),this.usePercentageCloserFiltering=!0}_validateFilter(e){return e===De.FILTER_NONE||e===De.FILTER_PCF||e===De.FILTER_PCSS?e:(console.error('Unsupported filter "'+e+'"!'),De.FILTER_NONE)}get numCascades(){return this._numCascades}set numCascades(e){e=Math.min(Math.max(e,Fi.MIN_CASCADES_COUNT),Fi.MAX_CASCADES_COUNT),e!==this._numCascades&&(this._numCascades=e,this.recreateShadowMap(),this._recreateSceneUBOs())}get freezeShadowCastersBoundingInfo(){return this._freezeShadowCastersBoundingInfo}set freezeShadowCastersBoundingInfo(e){this._freezeShadowCastersBoundingInfoObservable&&e&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),!this._freezeShadowCastersBoundingInfoObservable&&!e&&(this._freezeShadowCastersBoundingInfoObservable=this._scene.onBeforeRenderObservable.add(this._computeShadowCastersBoundingInfo.bind(this))),this._freezeShadowCastersBoundingInfo=e,e&&this._computeShadowCastersBoundingInfo()}_computeShadowCastersBoundingInfo(){if(this._scbiMin.copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._scbiMax.copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._shadowMap&&this._shadowMap.renderList){const e=this._shadowMap.renderList;for(let i=0;i<e.length;i++){const s=e[i];if(!s)continue;const r=s.getBoundingInfo(),n=r.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}const t=this._scene.meshes;for(let i=0;i<t.length;i++){const s=t[i];if(!s||!s.isVisible||!s.isEnabled||!s.receiveShadows)continue;const r=s.getBoundingInfo(),n=r.boundingBox;this._scbiMin.minimizeInPlace(n.minimumWorld),this._scbiMax.maximizeInPlace(n.maximumWorld)}}this._shadowCastersBoundingInfo.reConstruct(this._scbiMin,this._scbiMax)}get shadowCastersBoundingInfo(){return this._shadowCastersBoundingInfo}set shadowCastersBoundingInfo(e){this._shadowCastersBoundingInfo=e}setMinMaxDistance(e,t){this._minDistance===e&&this._maxDistance===t||(e>t&&(e=0,t=1),e<0&&(e=0),t>1&&(t=1),this._minDistance=e,this._maxDistance=t,this._breaksAreDirty=!0)}get minDistance(){return this._minDistance}get maxDistance(){return this._maxDistance}getClassName(){return Fi.CLASSNAME}getCascadeMinExtents(e){return e>=0&&e<this._numCascades?this._cascadeMinExtents[e]:null}getCascadeMaxExtents(e){return e>=0&&e<this._numCascades?this._cascadeMaxExtents[e]:null}get shadowMaxZ(){return!this._scene||!this._scene.activeCamera?0:this._shadowMaxZ}set shadowMaxZ(e){if(!this._scene||!this._scene.activeCamera){this._shadowMaxZ=e;return}this._shadowMaxZ===e||e<this._scene.activeCamera.minZ||e>this._scene.activeCamera.maxZ||(this._shadowMaxZ=e,this._light._markMeshesAsLightDirty(),this._breaksAreDirty=!0)}get debug(){return this._debug}set debug(e){this._debug=e,this._light._markMeshesAsLightDirty()}get depthClamp(){return this._depthClamp}set depthClamp(e){this._depthClamp=e}get cascadeBlendPercentage(){return this._cascadeBlendPercentage}set cascadeBlendPercentage(e){this._cascadeBlendPercentage=e,this._light._markMeshesAsLightDirty()}get lambda(){return this._lambda}set lambda(e){const t=Math.min(Math.max(e,0),1);this._lambda!=t&&(this._lambda=t,this._breaksAreDirty=!0)}getCascadeViewMatrix(e){return e>=0&&e<this._numCascades?this._viewMatrices[e]:null}getCascadeProjectionMatrix(e){return e>=0&&e<this._numCascades?this._projectionMatrices[e]:null}getCascadeTransformMatrix(e){return e>=0&&e<this._numCascades?this._transformMatrices[e]:null}setDepthRenderer(e){this._depthRenderer=e,this._depthReducer&&this._depthReducer.setDepthRenderer(this._depthRenderer)}get autoCalcDepthBounds(){return this._autoCalcDepthBounds}set autoCalcDepthBounds(e){const t=this._scene.activeCamera;if(!!t){if(this._autoCalcDepthBounds=e,!e){this._depthReducer&&this._depthReducer.deactivate(),this.setMinMaxDistance(0,1);return}this._depthReducer||(this._depthReducer=new GA(t),this._depthReducer.onAfterReductionPerformed.add(i=>{let s=i.min,r=i.max;s>=r&&(s=0,r=1),(s!=this._minDistance||r!=this._maxDistance)&&this.setMinMaxDistance(s,r)}),this._depthReducer.setDepthRenderer(this._depthRenderer)),this._depthReducer.activate()}}get autoCalcDepthBoundsRefreshRate(){var e,t,i;return(i=(t=(e=this._depthReducer)===null||e===void 0?void 0:e.depthRenderer)===null||t===void 0?void 0:t.getDepthMap().refreshRate)!==null&&i!==void 0?i:-1}set autoCalcDepthBoundsRefreshRate(e){var t;!((t=this._depthReducer)===null||t===void 0)&&t.depthRenderer&&(this._depthReducer.depthRenderer.getDepthMap().refreshRate=e)}splitFrustum(){this._breaksAreDirty=!0}_splitFrustum(){const e=this._scene.activeCamera;if(!e)return;const t=e.minZ,i=e.maxZ,s=i-t,r=this._minDistance,n=this._shadowMaxZ<i&&this._shadowMaxZ>=t?Math.min((this._shadowMaxZ-t)/(i-t),this._maxDistance):this._maxDistance,o=t+r*s,l=t+n*s,h=l-o,c=l/o;for(let u=0;u<this._cascades.length;++u){const d=(u+1)/this._numCascades,f=o*c**d,p=o+h*d,_=this._lambda*(f-p)+p;this._cascades[u].prevBreakDistance=u===0?r:this._cascades[u-1].breakDistance,this._cascades[u].breakDistance=(_-t)/s,this._viewSpaceFrustumsZ[u]=_,this._frustumLengths[u]=(this._cascades[u].breakDistance-this._cascades[u].prevBreakDistance)*s}this._breaksAreDirty=!1}_computeMatrices(){const e=this._scene;if(!e.activeCamera)return;g.NormalizeToRef(this._light.getShadowDirection(0),this._lightDirection),Math.abs(g.Dot(this._lightDirection,g.Up()))===1&&(this._lightDirection.z=1e-13),this._cachedDirection.copyFrom(this._lightDirection);const i=e.getEngine().useReverseDepthBuffer;for(let s=0;s<this._numCascades;++s){this._computeFrustumInWorldSpace(s),this._computeCascadeFrustum(s),this._cascadeMaxExtents[s].subtractToRef(this._cascadeMinExtents[s],vi),this._frustumCenter[s].addToRef(this._lightDirection.scale(this._cascadeMinExtents[s].z),this._shadowCameraPos[s]),L.LookAtLHToRef(this._shadowCameraPos[s],this._frustumCenter[s],rp,this._viewMatrices[s]);let r=0,n=vi.z;const o=this._shadowCastersBoundingInfo;o.update(this._viewMatrices[s]),n=Math.min(n,o.boundingBox.maximumWorld.z),!this._depthClamp||this.filter===De.FILTER_PCSS?r=Math.min(r,o.boundingBox.minimumWorld.z):r=Math.max(r,o.boundingBox.minimumWorld.z),L.OrthoOffCenterLHToRef(this._cascadeMinExtents[s].x,this._cascadeMaxExtents[s].x,this._cascadeMinExtents[s].y,this._cascadeMaxExtents[s].y,i?n:r,i?r:n,this._projectionMatrices[s],e.getEngine().isNDCHalfZRange),this._cascadeMinExtents[s].z=r,this._cascadeMaxExtents[s].z=n,this._viewMatrices[s].multiplyToRef(this._projectionMatrices[s],this._transformMatrices[s]),g.TransformCoordinatesToRef(zA,this._transformMatrices[s],vi),vi.scaleInPlace(this._mapSize/2),ro.copyFromFloats(Math.round(vi.x),Math.round(vi.y),Math.round(vi.z)),ro.subtractInPlace(vi).scaleInPlace(2/this._mapSize),L.TranslationToRef(ro.x,ro.y,0,Th),this._projectionMatrices[s].multiplyToRef(Th,this._projectionMatrices[s]),this._viewMatrices[s].multiplyToRef(this._projectionMatrices[s],this._transformMatrices[s]),this._transformMatrices[s].copyToArray(this._transformMatricesAsArray,s*16)}}_computeFrustumInWorldSpace(e){if(!this._scene.activeCamera)return;const t=this._cascades[e].prevBreakDistance,i=this._cascades[e].breakDistance,s=this._scene.getEngine().isNDCHalfZRange;this._scene.activeCamera.getViewMatrix();const r=L.Invert(this._scene.activeCamera.getTransformationMatrix()),n=this._scene.getEngine().useReverseDepthBuffer?4:0;for(let o=0;o<Fi._FrustumCornersNDCSpace.length;++o)vi.copyFrom(Fi._FrustumCornersNDCSpace[(o+n)%Fi._FrustumCornersNDCSpace.length]),s&&vi.z===-1&&(vi.z=0),g.TransformCoordinatesToRef(vi,r,this._frustumCornersWorldSpace[e][o]);for(let o=0;o<Fi._FrustumCornersNDCSpace.length/2;++o)vi.copyFrom(this._frustumCornersWorldSpace[e][o+4]).subtractInPlace(this._frustumCornersWorldSpace[e][o]),ro.copyFrom(vi).scaleInPlace(t),vi.scaleInPlace(i),vi.addInPlace(this._frustumCornersWorldSpace[e][o]),this._frustumCornersWorldSpace[e][o+4].copyFrom(vi),this._frustumCornersWorldSpace[e][o].addInPlace(ro)}_computeCascadeFrustum(e){if(this._cascadeMinExtents[e].copyFromFloats(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._cascadeMaxExtents[e].copyFromFloats(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),this._frustumCenter[e].copyFromFloats(0,0,0),!!this._scene.activeCamera){for(let i=0;i<this._frustumCornersWorldSpace[e].length;++i)this._frustumCenter[e].addInPlace(this._frustumCornersWorldSpace[e][i]);if(this._frustumCenter[e].scaleInPlace(1/this._frustumCornersWorldSpace[e].length),this.stabilizeCascades){let i=0;for(let s=0;s<this._frustumCornersWorldSpace[e].length;++s){const r=this._frustumCornersWorldSpace[e][s].subtractToRef(this._frustumCenter[e],vi).length();i=Math.max(i,r)}i=Math.ceil(i*16)/16,this._cascadeMaxExtents[e].copyFromFloats(i,i,i),this._cascadeMinExtents[e].copyFromFloats(-i,-i,-i)}else{const i=this._frustumCenter[e];this._frustumCenter[e].addToRef(this._lightDirection,vi),L.LookAtLHToRef(i,vi,rp,Th);for(let s=0;s<this._frustumCornersWorldSpace[e].length;++s)g.TransformCoordinatesToRef(this._frustumCornersWorldSpace[e][s],Th,vi),this._cascadeMinExtents[e].minimizeInPlace(vi),this._cascadeMaxExtents[e].maximizeInPlace(vi)}}}_recreateSceneUBOs(){if(this._disposeSceneUBOs(),this._sceneUBOs)for(let e=0;e<this._numCascades;++e)this._sceneUBOs.push(this._scene.createSceneUniformBuffer(`Scene for CSM Shadow Generator (light "${this._light.name}" cascade #${e})`))}static get IsSupported(){const e=ye.LastCreatedEngine;return e?e._features.supportCSM:!1}_initializeGenerator(){var e,t,i,s,r,n,o,l,h,c,u,d,f,p,_,m,v,x,b,S;this.penumbraDarkness=(e=this.penumbraDarkness)!==null&&e!==void 0?e:1,this._numCascades=(t=this._numCascades)!==null&&t!==void 0?t:Fi.DEFAULT_CASCADES_COUNT,this.stabilizeCascades=(i=this.stabilizeCascades)!==null&&i!==void 0?i:!1,this._freezeShadowCastersBoundingInfoObservable=(s=this._freezeShadowCastersBoundingInfoObservable)!==null&&s!==void 0?s:null,this.freezeShadowCastersBoundingInfo=(r=this.freezeShadowCastersBoundingInfo)!==null&&r!==void 0?r:!1,this._scbiMin=(n=this._scbiMin)!==null&&n!==void 0?n:new g(0,0,0),this._scbiMax=(o=this._scbiMax)!==null&&o!==void 0?o:new g(0,0,0),this._shadowCastersBoundingInfo=(l=this._shadowCastersBoundingInfo)!==null&&l!==void 0?l:new Js(new g(0,0,0),new g(0,0,0)),this._breaksAreDirty=(h=this._breaksAreDirty)!==null&&h!==void 0?h:!0,this._minDistance=(c=this._minDistance)!==null&&c!==void 0?c:0,this._maxDistance=(u=this._maxDistance)!==null&&u!==void 0?u:1,this._currentLayer=(d=this._currentLayer)!==null&&d!==void 0?d:0,this._shadowMaxZ=(_=(f=this._shadowMaxZ)!==null&&f!==void 0?f:(p=this._scene.activeCamera)===null||p===void 0?void 0:p.maxZ)!==null&&_!==void 0?_:1e4,this._debug=(m=this._debug)!==null&&m!==void 0?m:!1,this._depthClamp=(v=this._depthClamp)!==null&&v!==void 0?v:!0,this._cascadeBlendPercentage=(x=this._cascadeBlendPercentage)!==null&&x!==void 0?x:.1,this._lambda=(b=this._lambda)!==null&&b!==void 0?b:.5,this._autoCalcDepthBounds=(S=this._autoCalcDepthBounds)!==null&&S!==void 0?S:!1,this._recreateSceneUBOs(),super._initializeGenerator()}_createTargetRenderTexture(){const e=this._scene.getEngine(),t={width:this._mapSize,height:this._mapSize,layers:this.numCascades};this._shadowMap=new si(this._light.name+"_CSMShadowMap",t,this._scene,!1,!0,this._textureType,!1,void 0,!1,!1,void 0),this._shadowMap.createDepthStencilTexture(e.useReverseDepthBuffer?516:513,!0)}_initializeShadowMap(){if(super._initializeShadowMap(),this._shadowMap===null)return;this._transformMatricesAsArray=new Float32Array(this._numCascades*16),this._viewSpaceFrustumsZ=new Array(this._numCascades),this._frustumLengths=new Array(this._numCascades),this._lightSizeUVCorrection=new Array(this._numCascades*2),this._depthCorrection=new Array(this._numCascades),this._cascades=[],this._viewMatrices=[],this._projectionMatrices=[],this._transformMatrices=[],this._cascadeMinExtents=[],this._cascadeMaxExtents=[],this._frustumCenter=[],this._shadowCameraPos=[],this._frustumCornersWorldSpace=[];for(let t=0;t<this._numCascades;++t){this._cascades[t]={prevBreakDistance:0,breakDistance:0},this._viewMatrices[t]=L.Zero(),this._projectionMatrices[t]=L.Zero(),this._transformMatrices[t]=L.Zero(),this._cascadeMinExtents[t]=new g,this._cascadeMaxExtents[t]=new g,this._frustumCenter[t]=new g,this._shadowCameraPos[t]=new g,this._frustumCornersWorldSpace[t]=new Array(Fi._FrustumCornersNDCSpace.length);for(let i=0;i<Fi._FrustumCornersNDCSpace.length;++i)this._frustumCornersWorldSpace[t][i]=new g}const e=this._scene.getEngine();this._shadowMap.onBeforeBindObservable.clear(),this._shadowMap.onBeforeRenderObservable.clear(),this._shadowMap.onBeforeRenderObservable.add(t=>{this._sceneUBOs&&this._scene.setSceneUniformBuffer(this._sceneUBOs[t]),this._currentLayer=t,this._filter===De.FILTER_PCF&&e.setColorWrite(!1),this._scene.setTransformMatrix(this.getCascadeViewMatrix(t),this.getCascadeProjectionMatrix(t)),this._useUBO&&(this._scene.getSceneUniformBuffer().unbindEffect(),this._scene.finalizeSceneUbo())}),this._shadowMap.onBeforeBindObservable.add(()=>{var t;this._currentSceneUBO=this._scene.getSceneUniformBuffer(),(t=e._debugPushGroup)===null||t===void 0||t.call(e,`cascaded shadow map generation for pass id ${e.currentRenderPassId}`,1),this._breaksAreDirty&&this._splitFrustum(),this._computeMatrices()}),this._splitFrustum()}_bindCustomEffectForRenderSubMeshForShadowMap(e,t){t.setMatrix("viewProjection",this.getCascadeTransformMatrix(this._currentLayer))}_isReadyCustomDefines(e){e.push("#define SM_DEPTHCLAMP "+(this._depthClamp&&this._filter!==De.FILTER_PCSS?"1":"0"))}prepareDefines(e,t){super.prepareDefines(e,t);const i=this._scene,s=this._light;if(!i.shadowsEnabled||!s.shadowEnabled)return;e["SHADOWCSM"+t]=!0,e["SHADOWCSMDEBUG"+t]=this.debug,e["SHADOWCSMNUM_CASCADES"+t]=this.numCascades,e["SHADOWCSM_RIGHTHANDED"+t]=i.useRightHandedSystem;const r=i.activeCamera;r&&this._shadowMaxZ<r.maxZ&&(e["SHADOWCSMUSESHADOWMAXZ"+t]=!0),this.cascadeBlendPercentage===0&&(e["SHADOWCSMNOBLEND"+t]=!0)}bindShadowLight(e,t){const i=this._light,s=this._scene;if(!s.shadowsEnabled||!i.shadowEnabled)return;const r=s.activeCamera;if(!r)return;const n=this.getShadowMap();if(!n)return;const o=n.getSize().width;if(t.setMatrices("lightMatrix"+e,this._transformMatricesAsArray),t.setArray("viewFrustumZ"+e,this._viewSpaceFrustumsZ),t.setFloat("cascadeBlendFactor"+e,this.cascadeBlendPercentage===0?1e4:1/this.cascadeBlendPercentage),t.setArray("frustumLengths"+e,this._frustumLengths),this._filter===De.FILTER_PCF)t.setDepthStencilTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);else if(this._filter===De.FILTER_PCSS){for(let l=0;l<this._numCascades;++l)this._lightSizeUVCorrection[l*2+0]=l===0?1:(this._cascadeMaxExtents[0].x-this._cascadeMinExtents[0].x)/(this._cascadeMaxExtents[l].x-this._cascadeMinExtents[l].x),this._lightSizeUVCorrection[l*2+1]=l===0?1:(this._cascadeMaxExtents[0].y-this._cascadeMinExtents[0].y)/(this._cascadeMaxExtents[l].y-this._cascadeMinExtents[l].y),this._depthCorrection[l]=l===0?1:(this._cascadeMaxExtents[l].z-this._cascadeMinExtents[l].z)/(this._cascadeMaxExtents[0].z-this._cascadeMinExtents[0].z);t.setDepthStencilTexture("shadowSampler"+e,n),t.setTexture("depthSampler"+e,n),t.setArray2("lightSizeUVCorrection"+e,this._lightSizeUVCorrection),t.setArray("depthCorrection"+e,this._depthCorrection),t.setFloat("penumbraDarkness"+e,this.penumbraDarkness),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),1/o,this._contactHardeningLightSizeUVRatio*o,this.frustumEdgeFalloff,e)}else t.setTexture("shadowSampler"+e,n),i._uniformBuffer.updateFloat4("shadowsInfo",this.getDarkness(),o,1/o,this.frustumEdgeFalloff,e);i._uniformBuffer.updateFloat2("depthValues",this.getLight().getDepthMinZ(r),this.getLight().getDepthMinZ(r)+this.getLight().getDepthMaxZ(r),e)}getTransformMatrix(){return this.getCascadeTransformMatrix(0)}dispose(){super.dispose(),this._freezeShadowCastersBoundingInfoObservable&&(this._scene.onBeforeRenderObservable.remove(this._freezeShadowCastersBoundingInfoObservable),this._freezeShadowCastersBoundingInfoObservable=null),this._depthReducer&&(this._depthReducer.dispose(),this._depthReducer=null)}serialize(){const e=super.serialize(),t=this.getShadowMap();if(!t)return e;if(e.numCascades=this._numCascades,e.debug=this._debug,e.stabilizeCascades=this.stabilizeCascades,e.lambda=this._lambda,e.cascadeBlendPercentage=this.cascadeBlendPercentage,e.depthClamp=this._depthClamp,e.autoCalcDepthBounds=this.autoCalcDepthBounds,e.shadowMaxZ=this._shadowMaxZ,e.penumbraDarkness=this.penumbraDarkness,e.freezeShadowCastersBoundingInfo=this._freezeShadowCastersBoundingInfo,e.minDistance=this.minDistance,e.maxDistance=this.maxDistance,e.renderList=[],t.renderList)for(let i=0;i<t.renderList.length;i++){const s=t.renderList[i];e.renderList.push(s.id)}return e}static Parse(e,t){const i=De.Parse(e,t,(s,r)=>new Fi(s,r));return e.numCascades!==void 0&&(i.numCascades=e.numCascades),e.debug!==void 0&&(i.debug=e.debug),e.stabilizeCascades!==void 0&&(i.stabilizeCascades=e.stabilizeCascades),e.lambda!==void 0&&(i.lambda=e.lambda),e.cascadeBlendPercentage!==void 0&&(i.cascadeBlendPercentage=e.cascadeBlendPercentage),e.depthClamp!==void 0&&(i.depthClamp=e.depthClamp),e.autoCalcDepthBounds!==void 0&&(i.autoCalcDepthBounds=e.autoCalcDepthBounds),e.shadowMaxZ!==void 0&&(i.shadowMaxZ=e.shadowMaxZ),e.penumbraDarkness!==void 0&&(i.penumbraDarkness=e.penumbraDarkness),e.freezeShadowCastersBoundingInfo!==void 0&&(i.freezeShadowCastersBoundingInfo=e.freezeShadowCastersBoundingInfo),e.minDistance!==void 0&&e.maxDistance!==void 0&&i.setMinMaxDistance(e.minDistance,e.maxDistance),i}}Fi._FrustumCornersNDCSpace=[new g(-1,1,-1),new g(1,1,-1),new g(1,-1,-1),new g(-1,-1,-1),new g(-1,1,1),new g(1,1,1),new g(1,-1,1),new g(-1,-1,1)];Fi.CLASSNAME="CascadedShadowGenerator";Fi.DEFAULT_CASCADES_COUNT=4;Fi.MIN_CASCADES_COUNT=2;Fi.MAX_CASCADES_COUNT=4;Fi._SceneComponentInitialization=a=>{throw Ve("ShadowGeneratorSceneComponent")};li.AddParser(ue.NAME_SHADOWGENERATOR,(a,e)=>{if(a.shadowGenerators!==void 0&&a.shadowGenerators!==null)for(let t=0,i=a.shadowGenerators.length;t<i;t++){const s=a.shadowGenerators[t];s.className===Fi.CLASSNAME?Fi.Parse(s,e):De.Parse(s,e)}});class WA{constructor(e){this.name=ue.NAME_SHADOWGENERATOR,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ue.STEP_GATHERRENDERTARGETS_SHADOWGENERATOR,this,this._gatherRenderTargets)}rebuild(){}serialize(e){e.shadowGenerators=[];const t=this.scene.lights;for(const i of t){const s=i.getShadowGenerator();s&&e.shadowGenerators.push(s.serialize())}}addFromContainer(e){}removeFromContainer(e,t){}dispose(){}_gatherRenderTargets(e){const t=this.scene;if(this.scene.shadowsEnabled)for(let i=0;i<t.lights.length;i++){const s=t.lights[i],r=s.getShadowGenerator();if(s.isEnabled()&&s.shadowEnabled&&r){const n=r.getShadowMap();t.textures.indexOf(n)!==-1&&e.push(n)}}}}De._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_SHADOWGENERATOR);e||(e=new WA(a),a._addComponent(e))};class zn{constructor(e,t="",i="black"){this._renderingCanvas=e,this._loadingText=t,this._loadingDivBackgroundColor=i,this._resizeLoadingUI=()=>{const s=this._renderingCanvas.getBoundingClientRect(),r=window.getComputedStyle(this._renderingCanvas).position;!this._loadingDiv||(this._loadingDiv.style.position=r==="fixed"?"fixed":"absolute",this._loadingDiv.style.left=s.left+"px",this._loadingDiv.style.top=s.top+"px",this._loadingDiv.style.width=s.width+"px",this._loadingDiv.style.height=s.height+"px")}}displayLoadingUI(){if(this._loadingDiv)return;this._loadingDiv=document.createElement("div"),this._loadingDiv.id="babylonjsLoadingDiv",this._loadingDiv.style.opacity="0",this._loadingDiv.style.transition="opacity 1.5s ease",this._loadingDiv.style.pointerEvents="none",this._loadingDiv.style.display="grid",this._loadingDiv.style.gridTemplateRows="100%",this._loadingDiv.style.gridTemplateColumns="100%",this._loadingDiv.style.justifyItems="center",this._loadingDiv.style.alignItems="center",this._loadingTextDiv=document.createElement("div"),this._loadingTextDiv.style.position="absolute",this._loadingTextDiv.style.left="0",this._loadingTextDiv.style.top="50%",this._loadingTextDiv.style.marginTop="80px",this._loadingTextDiv.style.width="100%",this._loadingTextDiv.style.height="20px",this._loadingTextDiv.style.fontFamily="Arial",this._loadingTextDiv.style.fontSize="14px",this._loadingTextDiv.style.color="white",this._loadingTextDiv.style.textAlign="center",this._loadingTextDiv.style.zIndex="1",this._loadingTextDiv.innerHTML="Loading",this._loadingDiv.appendChild(this._loadingTextDiv),this._loadingTextDiv.innerHTML=this._loadingText,this._style=document.createElement("style"),this._style.type="text/css";const e=`@-webkit-keyframes spin1 {                    0% { -webkit-transform: rotate(0deg);}
                    100% { -webkit-transform: rotate(360deg);}
                }                @keyframes spin1 {                    0% { transform: rotate(0deg);}
                    100% { transform: rotate(360deg);}
                }`;this._style.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(this._style);const t=!!window.SVGSVGElement,i=new Image;zn.DefaultLogoUrl?i.src=zn.DefaultLogoUrl:i.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAuMTcgMjA4LjA0Ij48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2ZmZjt9LmNscy0ye2ZpbGw6I2UwNjg0Yjt9LmNscy0ze2ZpbGw6I2JiNDY0Yjt9LmNscy00e2ZpbGw6I2UwZGVkODt9LmNscy01e2ZpbGw6I2Q1ZDJjYTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPkJhYnlsb25Mb2dvPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iUGFnZV9FbGVtZW50cyIgZGF0YS1uYW1lPSJQYWdlIEVsZW1lbnRzIj48cGF0aCBjbGFzcz0iY2xzLTEiIGQ9Ik05MC4wOSwwLDAsNTJWMTU2bDkwLjA5LDUyLDkwLjA4LTUyVjUyWiIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtMiIgcG9pbnRzPSIxODAuMTcgNTIuMDEgMTUxLjk3IDM1LjczIDEyNC44NSA1MS4zOSAxNTMuMDUgNjcuNjcgMTgwLjE3IDUyLjAxIi8+PHBvbHlnb24gY2xhc3M9ImNscy0yIiBwb2ludHM9IjI3LjEyIDY3LjY3IDExNy4yMSAxNS42NiA5MC4wOCAwIDAgNTIuMDEgMjcuMTIgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTIiIHBvaW50cz0iNjEuODkgMTIwLjMgOTAuMDggMTM2LjU4IDExOC4yOCAxMjAuMyA5MC4wOCAxMDQuMDIgNjEuODkgMTIwLjMiLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDE1My4wNSAxNDAuMzcgOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyAwIDUyLjAxIDAgMTU2LjAzIDkwLjA4IDIwOC4wNCAxODAuMTcgMTU2LjAzIDE4MC4xNyA1Mi4wMSAxNTMuMDUgNjcuNjciLz48cG9seWdvbiBjbGFzcz0iY2xzLTMiIHBvaW50cz0iOTAuMDggNzEuNDYgNjEuODkgODcuNzQgNjEuODkgMTIwLjMgOTAuMDggMTA0LjAyIDExOC4yOCAxMjAuMyAxMTguMjggODcuNzQgOTAuMDggNzEuNDYiLz48cG9seWdvbiBjbGFzcz0iY2xzLTQiIHBvaW50cz0iMTUzLjA1IDY3LjY3IDExOC4yOCA4Ny43NCAxMTguMjggMTIwLjMgOTAuMDggMTM2LjU4IDkwLjA4IDE3Ni43MiAxNTMuMDUgMTQwLjM3IDE1My4wNSA2Ny42NyIvPjxwb2x5Z29uIGNsYXNzPSJjbHMtNSIgcG9pbnRzPSIyNy4xMiA2Ny42NyA2MS44OSA4Ny43NCA2MS44OSAxMjAuMyA5MC4wOCAxMzYuNTggOTAuMDggMTc2LjcyIDI3LjEyIDE0MC4zNyAyNy4xMiA2Ny42NyIvPjwvZz48L2c+PC9zdmc+":"https://cdn.babylonjs.com/Assets/babylonLogo.png",i.style.width="150px",i.style.gridColumn="1",i.style.gridRow="1",i.style.top="50%",i.style.left="50%",i.style.transform="translate(-50%, -50%)",i.style.position="absolute";const s=document.createElement("div");s.style.width="300px",s.style.gridColumn="1",s.style.gridRow="1",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.position="absolute";const r=new Image;if(zn.DefaultSpinnerUrl?r.src=zn.DefaultSpinnerUrl:r.src=t?"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAzOTIgMzkyIj48ZGVmcz48c3R5bGU+LmNscy0xe2ZpbGw6I2UwNjg0Yjt9LmNscy0ye2ZpbGw6bm9uZTt9PC9zdHlsZT48L2RlZnM+PHRpdGxlPlNwaW5uZXJJY29uPC90aXRsZT48ZyBpZD0iTGF5ZXJfMiIgZGF0YS1uYW1lPSJMYXllciAyIj48ZyBpZD0iU3Bpbm5lciI+PHBhdGggY2xhc3M9ImNscy0xIiBkPSJNNDAuMjEsMTI2LjQzYzMuNy03LjMxLDcuNjctMTQuNDQsMTItMjEuMzJsMy4zNi01LjEsMy41Mi01YzEuMjMtMS42MywyLjQxLTMuMjksMy42NS00LjkxczIuNTMtMy4yMSwzLjgyLTQuNzlBMTg1LjIsMTg1LjIsMCwwLDEsODMuNCw2Ny40M2EyMDgsMjA4LDAsMCwxLDE5LTE1LjY2YzMuMzUtMi40MSw2Ljc0LTQuNzgsMTAuMjUtN3M3LjExLTQuMjgsMTAuNzUtNi4zMmM3LjI5LTQsMTQuNzMtOCwyMi41My0xMS40OSwzLjktMS43Miw3Ljg4LTMuMywxMi00LjY0YTEwNC4yMiwxMDQuMjIsMCwwLDEsMTIuNDQtMy4yMyw2Mi40NCw2Mi40NCwwLDAsMSwxMi43OC0xLjM5QTI1LjkyLDI1LjkyLDAsMCwxLDE5NiwyMS40NGE2LjU1LDYuNTUsMCwwLDEsMi4wNSw5LDYuNjYsNi42NiwwLDAsMS0xLjY0LDEuNzhsLS40MS4yOWEyMi4wNywyMi4wNywwLDAsMS01Ljc4LDMsMzAuNDIsMzAuNDIsMCwwLDEtNS42NywxLjYyLDM3LjgyLDM3LjgyLDAsMCwxLTUuNjkuNzFjLTEsMC0xLjkuMTgtMi44NS4yNmwtMi44NS4yNHEtNS43Mi41MS0xMS40OCwxLjFjLTMuODQuNC03LjcxLjgyLTExLjU4LDEuNGExMTIuMzQsMTEyLjM0LDAsMCwwLTIyLjk0LDUuNjFjLTMuNzIsMS4zNS03LjM0LDMtMTAuOTQsNC42NHMtNy4xNCwzLjUxLTEwLjYsNS41MUExNTEuNiwxNTEuNiwwLDAsMCw2OC41Niw4N0M2Ny4yMyw4OC40OCw2Niw5MCw2NC42NCw5MS41NnMtMi41MSwzLjE1LTMuNzUsNC43M2wtMy41NCw0LjljLTEuMTMsMS42Ni0yLjIzLDMuMzUtMy4zMyw1YTEyNywxMjcsMCwwLDAtMTAuOTMsMjEuNDksMS41OCwxLjU4LDAsMSwxLTMtMS4xNVM0MC4xOSwxMjYuNDcsNDAuMjEsMTI2LjQzWiIvPjxyZWN0IGNsYXNzPSJjbHMtMiIgd2lkdGg9IjM5MiIgaGVpZ2h0PSIzOTIiLz48L2c+PC9nPjwvc3ZnPg==":"https://cdn.babylonjs.com/Assets/loadingIcon.png",r.style.animation="spin1 0.75s infinite linear",r.style.webkitAnimation="spin1 0.75s infinite linear",r.style.transformOrigin="50% 50%",r.style.webkitTransformOrigin="50% 50%",!t){const n={w:16,h:18.5},o={w:30,h:30};i.style.width=`${n.w}vh`,i.style.height=`${n.h}vh`,i.style.left=`calc(50% - ${n.w/2}vh)`,i.style.top=`calc(50% - ${n.h/2}vh)`,r.style.width=`${o.w}vh`,r.style.height=`${o.h}vh`,r.style.left=`calc(50% - ${o.w/2}vh)`,r.style.top=`calc(50% - ${o.h/2}vh)`}s.appendChild(r),this._loadingDiv.appendChild(i),this._loadingDiv.appendChild(s),this._resizeLoadingUI(),window.addEventListener("resize",this._resizeLoadingUI),this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor,document.body.appendChild(this._loadingDiv),this._loadingDiv.style.opacity="1"}hideLoadingUI(){if(!this._loadingDiv)return;const e=()=>{this._loadingTextDiv&&(this._loadingTextDiv.remove(),this._loadingTextDiv=null),this._loadingDiv&&(this._loadingDiv.remove(),this._loadingDiv=null),this._style&&(this._style.remove(),this._style=null),window.removeEventListener("resize",this._resizeLoadingUI)};this._loadingDiv.style.opacity="0",this._loadingDiv.addEventListener("transitionend",e)}set loadingUIText(e){this._loadingText=e,this._loadingTextDiv&&(this._loadingTextDiv.innerHTML=this._loadingText)}get loadingUIText(){return this._loadingText}get loadingUIBackgroundColor(){return this._loadingDivBackgroundColor}set loadingUIBackgroundColor(e){this._loadingDivBackgroundColor=e,this._loadingDiv&&(this._loadingDiv.style.backgroundColor=this._loadingDivBackgroundColor)}}zn.DefaultLogoUrl="";zn.DefaultSpinnerUrl="";k.DefaultLoadingScreenFactory=a=>new zn(a);class ua{static ConvertPanoramaToCubemap(e,t,i,s){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=t*i*3)throw"ConvertPanoramaToCubemap: input size is wrong";const r=this.CreateCubemapTexture(s,this.FACE_FRONT,e,t,i),n=this.CreateCubemapTexture(s,this.FACE_BACK,e,t,i),o=this.CreateCubemapTexture(s,this.FACE_LEFT,e,t,i),l=this.CreateCubemapTexture(s,this.FACE_RIGHT,e,t,i),h=this.CreateCubemapTexture(s,this.FACE_UP,e,t,i),c=this.CreateCubemapTexture(s,this.FACE_DOWN,e,t,i);return{front:r,back:n,left:o,right:l,up:h,down:c,size:s,type:1,format:4,gammaSpace:!1}}static CreateCubemapTexture(e,t,i,s,r){const n=new ArrayBuffer(e*e*4*3),o=new Float32Array(n),l=t[1].subtract(t[0]).scale(1/e),h=t[3].subtract(t[2]).scale(1/e),c=1/e;let u=0;for(let d=0;d<e;d++){let f=t[0],p=t[2];for(let _=0;_<e;_++){const m=p.subtract(f).scale(u).add(f);m.normalize();const v=this.CalcProjectionSpherical(m,i,s,r);o[d*e*3+_*3+0]=v.r,o[d*e*3+_*3+1]=v.g,o[d*e*3+_*3+2]=v.b,f=f.add(l),p=p.add(h)}u+=c}return o}static CalcProjectionSpherical(e,t,i,s){let r=Math.atan2(e.z,e.x);const n=Math.acos(e.y);for(;r<-Math.PI;)r+=2*Math.PI;for(;r>Math.PI;)r-=2*Math.PI;let o=r/Math.PI;const l=n/Math.PI;o=o*.5+.5;let h=Math.round(o*i);h<0?h=0:h>=i&&(h=i-1);let c=Math.round(l*s);c<0?c=0:c>=s&&(c=s-1);const u=s-c-1,d=t[u*i*3+h*3+0],f=t[u*i*3+h*3+1],p=t[u*i*3+h*3+2];return{r:d,g:f,b:p}}}ua.FACE_LEFT=[new g(-1,-1,-1),new g(1,-1,-1),new g(-1,1,-1),new g(1,1,-1)];ua.FACE_RIGHT=[new g(1,-1,1),new g(-1,-1,1),new g(1,1,1),new g(-1,1,1)];ua.FACE_FRONT=[new g(1,-1,-1),new g(1,-1,1),new g(1,1,-1),new g(1,1,1)];ua.FACE_BACK=[new g(-1,-1,1),new g(-1,-1,-1),new g(-1,1,1),new g(-1,1,-1)];ua.FACE_DOWN=[new g(1,1,-1),new g(1,1,1),new g(-1,1,-1),new g(-1,1,1)];ua.FACE_UP=[new g(-1,-1,-1),new g(-1,-1,1),new g(1,-1,-1),new g(1,-1,1)];class nd{static _Ldexp(e,t){return t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t)}static _Rgbe2float(e,t,i,s,r,n){r>0?(r=this._Ldexp(1,r-(128+8)),e[n+0]=t*r,e[n+1]=i*r,e[n+2]=s*r):(e[n+0]=0,e[n+1]=0,e[n+2]=0)}static _ReadStringLine(e,t){let i="",s="";for(let r=t;r<e.length-t&&(s=String.fromCharCode(e[r]),s!=`
`);r++)i+=s;return i}static RGBE_ReadHeader(e){let t=0,i=0,s=this._ReadStringLine(e,0);if(s[0]!="#"||s[1]!="?")throw"Bad HDR Format.";let r=!1,n=!1,o=0;do o+=s.length+1,s=this._ReadStringLine(e,o),s=="FORMAT=32-bit_rle_rgbe"?n=!0:s.length==0&&(r=!0);while(!r);if(!n)throw"HDR Bad header format, unsupported FORMAT";o+=s.length+1,s=this._ReadStringLine(e,o);const h=/^-Y (.*) \+X (.*)$/g.exec(s);if(!h||h.length<3)throw"HDR Bad header format, no size";if(i=parseInt(h[2]),t=parseInt(h[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return o+=s.length+1,{height:t,width:i,dataPosition:o}}static GetCubeMapTextureData(e,t){const i=new Uint8Array(e),s=this.RGBE_ReadHeader(i),r=this.RGBE_ReadPixels(i,s);return ua.ConvertPanoramaToCubemap(r,s.width,s.height,t)}static RGBE_ReadPixels(e,t){return this._RGBEReadPixelsRLE(e,t)}static _RGBEReadPixelsRLE(e,t){let i=t.height;const s=t.width;let r,n,o,l,h,c=t.dataPosition,u=0,d=0,f=0;const p=new ArrayBuffer(s*4),_=new Uint8Array(p),m=new ArrayBuffer(t.width*t.height*4*3),v=new Float32Array(m);for(;i>0;){if(r=e[c++],n=e[c++],o=e[c++],l=e[c++],r!=2||n!=2||o&128||t.width<8||t.width>32767)return this._RGBEReadPixelsNOTRLE(e,t);if((o<<8|l)!=s)throw"HDR Bad header format, wrong scan line width";for(u=0,f=0;f<4;f++)for(d=(f+1)*s;u<d;)if(r=e[c++],n=e[c++],r>128){if(h=r-128,h==0||h>d-u)throw"HDR Bad Format, bad scanline data (run)";for(;h-- >0;)_[u++]=n}else{if(h=r,h==0||h>d-u)throw"HDR Bad Format, bad scanline data (non-run)";if(_[u++]=n,--h>0)for(let x=0;x<h;x++)_[u++]=e[c++]}for(f=0;f<s;f++)r=_[f],n=_[f+s],o=_[f+2*s],l=_[f+3*s],this._Rgbe2float(v,r,n,o,l,(t.height-i)*s*3+f*3);i--}return v}static _RGBEReadPixelsNOTRLE(e,t){let i=t.height;const s=t.width;let r,n,o,l,h,c=t.dataPosition;const u=new ArrayBuffer(t.width*t.height*4*3),d=new Float32Array(u);for(;i>0;){for(h=0;h<t.width;h++)r=e[c++],n=e[c++],o=e[c++],l=e[c++],this._Rgbe2float(d,r,n,o,l,(t.height-i)*s*3+h*3);i--}return d}}class Fo{constructor(e,t=Fo._DefaultOptions){this._engine=e,this._fullscreenViewport=new Es(0,0,1,1),t={...Fo._DefaultOptions,...t},this._vertexBuffers={[y.PositionKind]:new y(e,t.positions,y.PositionKind,!1,!1,2)},this._indexBuffer=e.createIndexBuffer(t.indices),this._onContextRestoredObserver=e.onContextRestoredObservable.add(()=>{this._indexBuffer=e.createIndexBuffer(t.indices);for(const i in this._vertexBuffers)this._vertexBuffers[i]._rebuild()})}setViewport(e=this._fullscreenViewport){this._engine.setViewport(e)}bindBuffers(e){this._engine.bindBuffers(this._vertexBuffers,this._indexBuffer,e)}applyEffectWrapper(e){this._engine.depthCullingState.depthTest=!1,this._engine.stencilState.stencilTest=!1,this._engine.enableEffect(e._drawWrapper),this.bindBuffers(e.effect),e.onApplyObservable.notifyObservers({})}restoreStates(){this._engine.depthCullingState.depthTest=!0,this._engine.stencilState.stencilTest=!0}draw(){this._engine.drawElementsType(0,0,6)}_isRenderTargetTexture(e){return e.renderTarget!==void 0}render(e,t=null){if(!e.effect.isReady())return;this.setViewport();const i=t===null?null:this._isRenderTargetTexture(t)?t.renderTarget:t;i&&this._engine.bindFramebuffer(i),this.applyEffectWrapper(e),this.draw(),i&&this._engine.unBindFramebuffer(i),this.restoreStates()}dispose(){const e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),delete this._vertexBuffers[y.PositionKind]),this._indexBuffer&&this._engine._releaseBuffer(this._indexBuffer),this._onContextRestoredObserver&&(this._engine.onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null)}}Fo._DefaultOptions={positions:[1,1,-1,1,-1,-1,1,-1],indices:[0,1,2,0,2,3]};class Oh{constructor(e){this.onApplyObservable=new X;let t;const i=e.uniformNames||[];e.vertexShader?t={fragmentSource:e.fragmentShader,vertexSource:e.vertexShader,spectorName:e.name||"effectWrapper"}:(i.push("scale"),t={fragmentSource:e.fragmentShader,vertex:"postprocess",spectorName:e.name||"effectWrapper"},this.onApplyObservable.add(()=>{this.effect.setFloat2("scale",1,1)}));const s=e.defines?e.defines.join(`
`):"";this._drawWrapper=new Vi(e.engine),e.useShaderStore?(t.fragment=t.fragmentSource,t.vertex||(t.vertex=t.vertexSource),delete t.fragmentSource,delete t.vertexSource,this.effect=e.engine.createEffect(t,e.attributeNames||["position"],i,e.samplerNames,s,void 0,e.onCompiled,void 0,void 0,e.shaderLanguage)):(this.effect=new Rt(t,e.attributeNames||["position"],i,e.samplerNames,e.engine,s,void 0,e.onCompiled,void 0,void 0,void 0,e.shaderLanguage),this._onContextRestoredObserver=e.engine.onContextRestoredObservable.add(()=>{this.effect._pipelineContext=null,this.effect._wasPreviouslyReady=!1,this.effect._prepareEffect()}))}get effect(){return this._drawWrapper.effect}set effect(e){this._drawWrapper.effect=e}dispose(){this._onContextRestoredObserver&&(this.effect.getEngine().onContextRestoredObservable.remove(this._onContextRestoredObserver),this._onContextRestoredObserver=null),this.effect.dispose()}}const HA="hdrFilteringVertexShader",XA=`attribute vec2 position;
varying vec3 direction;
uniform vec3 up;
uniform vec3 right;
uniform vec3 front;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
mat3 view=mat3(up,right,front);
direction=view*vec3(position,1.0);
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[HA]=XA;const YA="hdrFilteringPixelShader",KA=`#include<helperFunctions>
#include<importanceSampling>
#include<pbrBRDFFunctions>
#include<hdrFilteringFunctions>
uniform float alphaG;
uniform samplerCube inputTexture;
uniform vec2 vFilteringInfo;
uniform float hdrScale;
varying vec3 direction;
void main() {
vec3 color=radiance(alphaG,inputTexture,direction,vFilteringInfo);
gl_FragColor=vec4(color*hdrScale,1.0);
}`;Y.ShadersStore[YA]=KA;class $A{constructor(e,t={}){this._lodGenerationOffset=0,this._lodGenerationScale=.8,this.quality=4096,this.hdrScale=1,this._engine=e,this.hdrScale=t.hdrScale||this.hdrScale,this.quality=t.quality||this.quality}_createRenderTarget(e){let t=0;this._engine.getCaps().textureHalfFloatRender?t=2:this._engine.getCaps().textureFloatRender&&(t=1);const i=this._engine.createRenderTargetCubeTexture(e,{format:5,type:t,createMipMaps:!0,generateMipMaps:!1,generateDepthBuffer:!1,generateStencilBuffer:!1,samplingMode:1});return this._engine.updateTextureWrappingMode(i.texture,0,0,0),this._engine.updateTextureSamplingMode(3,i.texture,!0),i}_prefilterInternal(e){const t=e.getSize().width,i=oe.ILog2(t)+1,s=this._effectWrapper.effect,r=this._createRenderTarget(t);this._effectRenderer.setViewport();const n=e.getInternalTexture();n&&this._engine.updateTextureSamplingMode(3,n,!0),this._effectRenderer.applyEffectWrapper(this._effectWrapper);const o=[[new g(0,0,-1),new g(0,-1,0),new g(1,0,0)],[new g(0,0,1),new g(0,-1,0),new g(-1,0,0)],[new g(1,0,0),new g(0,0,1),new g(0,1,0)],[new g(1,0,0),new g(0,0,-1),new g(0,-1,0)],[new g(1,0,0),new g(0,-1,0),new g(0,0,1)],[new g(-1,0,0),new g(0,-1,0),new g(0,0,-1)]];s.setFloat("hdrScale",this.hdrScale),s.setFloat2("vFilteringInfo",e.getSize().width,i),s.setTexture("inputTexture",e);for(let l=0;l<6;l++){s.setVector3("up",o[l][0]),s.setVector3("right",o[l][1]),s.setVector3("front",o[l][2]);for(let h=0;h<i;h++){this._engine.bindFramebuffer(r,l,void 0,void 0,!0,h),this._effectRenderer.applyEffectWrapper(this._effectWrapper);let c=Math.pow(2,(h-this._lodGenerationOffset)/this._lodGenerationScale)/t;h===0&&(c=0),s.setFloat("alphaG",c),this._effectRenderer.draw()}}return this._effectRenderer.restoreStates(),this._engine.restoreDefaultFramebuffer(),this._engine._releaseTexture(e._texture),r._swapAndDie(e._texture),e._prefiltered=!0,e}_createEffect(e,t){const i=[];return e.gammaSpace&&i.push("#define GAMMA_INPUT"),i.push("#define NUM_SAMPLES "+this.quality+"u"),new Oh({engine:this._engine,name:"hdrFiltering",vertexShader:"hdrFiltering",fragmentShader:"hdrFiltering",samplerNames:["inputTexture"],uniformNames:["vSampleDirections","vWeights","up","right","front","vFilteringInfo","hdrScale","alphaG"],useShaderStore:!0,defines:i,onCompiled:t})}isReady(e){return e.isReady()&&this._effectWrapper.effect.isReady()}prefilter(e,t=null){return this._engine._features.allowTexturePrefiltering?new Promise(i=>{this._effectRenderer=new Fo(this._engine),this._effectWrapper=this._createEffect(e),this._effectWrapper.effect.executeWhenCompiled(()=>{this._prefilterInternal(e),this._effectRenderer.dispose(),this._effectWrapper.dispose(),i(),t&&t()})}):(B.Warn("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."),Promise.reject("HDR prefiltering is not available in WebGL 1., you can use real time filtering instead."))}}class Da extends dt{constructor(e,t,i,s=!1,r=!0,n=!1,o=!1,l=null,h=null){var c;super(t),this._generateHarmonics=!0,this._onError=null,this._isBlocking=!0,this._rotationY=0,this.boundingBoxPosition=g.Zero(),this.onLoadObservable=new X,e&&(this._coordinatesMode=H.CUBIC_MODE,this.name=e,this.url=e,this.hasAlpha=!1,this.isCube=!0,this._textureMatrix=L.Identity(),this._prefilterOnLoad=o,this._onLoad=()=>{this.onLoadObservable.notifyObservers(this),l&&l()},this._onError=h,this.gammaSpace=n,this._noMipmap=s,this._size=i,this._generateHarmonics=r,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?this._texture.isReady?q.SetImmediate(()=>this._onLoad()):this._texture.onLoadedObservable.add(this._onLoad):!((c=this.getScene())===null||c===void 0)&&c.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture())}set isBlocking(e){this._isBlocking=e}get isBlocking(){return this._isBlocking}set rotationY(e){this._rotationY=e,this.setReflectionTextureMatrix(L.RotationY(this._rotationY))}get rotationY(){return this._rotationY}set boundingBoxSize(e){if(this._boundingBoxSize&&this._boundingBoxSize.equals(e))return;this._boundingBoxSize=e;const t=this.getScene();t&&t.markAllMaterialsAsDirty(1)}get boundingBoxSize(){return this._boundingBoxSize}getClassName(){return"HDRCubeTexture"}_loadTexture(){const e=this._getEngine(),t=e.getCaps();let i=0;t.textureFloat&&t.textureFloatLinearFiltering?i=1:t.textureHalfFloat&&t.textureHalfFloatLinearFiltering&&(i=2);const s=r=>{this.lodGenerationOffset=0,this.lodGenerationScale=.8;const n=nd.GetCubeMapTextureData(r,this._size);if(this._generateHarmonics){const c=$c.ConvertCubeMapToSphericalPolynomial(n);this.sphericalPolynomial=c}const o=[];let l=null,h=null;for(let c=0;c<6;c++){i===2?h=new Uint16Array(this._size*this._size*3):i===0&&(l=new Uint8Array(this._size*this._size*3));const u=n[Da._FacesMapping[c]];if(this.gammaSpace||h||l){for(let d=0;d<this._size*this._size;d++)if(this.gammaSpace&&(u[d*3+0]=Math.pow(u[d*3+0],Wr),u[d*3+1]=Math.pow(u[d*3+1],Wr),u[d*3+2]=Math.pow(u[d*3+2],Wr)),h&&(h[d*3+0]=cn(u[d*3+0]),h[d*3+1]=cn(u[d*3+1]),h[d*3+2]=cn(u[d*3+2])),l){let f=Math.max(u[d*3+0]*255,0),p=Math.max(u[d*3+1]*255,0),_=Math.max(u[d*3+2]*255,0);const m=Math.max(Math.max(f,p),_);if(m>255){const v=255/m;f*=v,p*=v,_*=v}l[d*3+0]=f,l[d*3+1]=p,l[d*3+2]=_}}h?o.push(h):l?o.push(l):o.push(u)}return o};if(e._features.allowTexturePrefiltering&&this._prefilterOnLoad){const r=this._onLoad,n=new $A(e);this._onLoad=()=>{n.prefilter(this,r)}}this._texture=e.createRawCubeTextureFromUrl(this.url,this.getScene(),this._size,4,i,this._noMipmap,s,null,this._onLoad,this._onError)}clone(){const e=new Da(this.url,this.getScene()||this._getEngine(),this._size,this._noMipmap,this._generateHarmonics,this.gammaSpace);return e.level=this.level,e.wrapU=this.wrapU,e.wrapV=this.wrapV,e.coordinatesIndex=this.coordinatesIndex,e.coordinatesMode=this.coordinatesMode,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,this._noMipmap),this._texture||this._loadTexture())}getReflectionTextureMatrix(){return this._textureMatrix}setReflectionTextureMatrix(e){var t;this._textureMatrix=e,e.updateFlag!==this._textureMatrix.updateFlag&&e.isIdentity()!==this._textureMatrix.isIdentity()&&((t=this.getScene())===null||t===void 0||t.markAllMaterialsAsDirty(1,i=>i.getActiveTextures().indexOf(this)!==-1))}dispose(){this.onLoadObservable.clear(),super.dispose()}static Parse(e,t,i){let s=null;return e.name&&!e.isRenderTarget&&(s=new Da(i+e.name,t,e.size,e.noMipmap,e.generateHarmonics,e.useInGammaSpace),s.name=e.name,s.hasAlpha=e.hasAlpha,s.level=e.level,s.coordinatesMode=e.coordinatesMode,s.isBlocking=e.isBlocking),s&&(e.boundingBoxPosition&&(s.boundingBoxPosition=g.FromArray(e.boundingBoxPosition)),e.boundingBoxSize&&(s.boundingBoxSize=g.FromArray(e.boundingBoxSize)),e.rotationY&&(s.rotationY=e.rotationY)),s}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.hasAlpha=this.hasAlpha,e.isCube=!0,e.level=this.level,e.size=this._size,e.coordinatesMode=this.coordinatesMode,e.useInGammaSpace=this.gammaSpace,e.generateHarmonics=this._generateHarmonics,e.customType="BABYLON.HDRCubeTexture",e.noMipmap=this._noMipmap,e.isBlocking=this._isBlocking,e.rotationY=this._rotationY,e}}Da._FacesMapping=["right","left","up","down","front","back"];he("BABYLON.HDRCubeTexture",Da);class xo{constructor(e,t=0,i=null){this.name=e,this.animations=new Array,this._positions=null,this._normals=null,this._tangents=null,this._uvs=null,this._uniqueId=0,this.onInfluenceChanged=new X,this._onDataLayoutChanged=new X,this._animationPropertiesOverride=null,this._scene=i||ye.LastCreatedScene,this.influence=t,this._scene&&(this._uniqueId=this._scene.getUniqueId())}get influence(){return this._influence}set influence(e){if(this._influence===e)return;const t=this._influence;this._influence=e,this.onInfluenceChanged.hasObservers()&&this.onInfluenceChanged.notifyObservers(t===0||e===0)}get animationPropertiesOverride(){return!this._animationPropertiesOverride&&this._scene?this._scene.animationPropertiesOverride:this._animationPropertiesOverride}set animationPropertiesOverride(e){this._animationPropertiesOverride=e}get uniqueId(){return this._uniqueId}get hasPositions(){return!!this._positions}get hasNormals(){return!!this._normals}get hasTangents(){return!!this._tangents}get hasUVs(){return!!this._uvs}setPositions(e){const t=this.hasPositions;this._positions=e,t!==this.hasPositions&&this._onDataLayoutChanged.notifyObservers(void 0)}getPositions(){return this._positions}setNormals(e){const t=this.hasNormals;this._normals=e,t!==this.hasNormals&&this._onDataLayoutChanged.notifyObservers(void 0)}getNormals(){return this._normals}setTangents(e){const t=this.hasTangents;this._tangents=e,t!==this.hasTangents&&this._onDataLayoutChanged.notifyObservers(void 0)}getTangents(){return this._tangents}setUVs(e){const t=this.hasUVs;this._uvs=e,t!==this.hasUVs&&this._onDataLayoutChanged.notifyObservers(void 0)}getUVs(){return this._uvs}clone(){const e=xe.Clone(()=>new xo(this.name,this.influence,this._scene),this);return e._positions=this._positions,e._normals=this._normals,e._tangents=this._tangents,e._uvs=this._uvs,e}serialize(){const e={};return e.name=this.name,e.influence=this.influence,e.positions=Array.prototype.slice.call(this.getPositions()),this.id!=null&&(e.id=this.id),this.hasNormals&&(e.normals=Array.prototype.slice.call(this.getNormals())),this.hasTangents&&(e.tangents=Array.prototype.slice.call(this.getTangents())),this.hasUVs&&(e.uvs=Array.prototype.slice.call(this.getUVs())),xe.AppendSerializedAnimations(this,e),e}getClassName(){return"MorphTarget"}static Parse(e,t){const i=new xo(e.name,e.influence);if(i.setPositions(e.positions),e.id!=null&&(i.id=e.id),e.normals&&i.setNormals(e.normals),e.tangents&&i.setTangents(e.tangents),e.uvs&&i.setUVs(e.uvs),e.animations){for(let s=0;s<e.animations.length;s++){const r=e.animations[s],n=Si("BABYLON.Animation");n&&i.animations.push(n.Parse(r))}e.autoAnimate&&t&&t.beginAnimation(i,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1)}return i}static FromMesh(e,t,i){t||(t=e.name);const s=new xo(t,i,e.getScene());return s.setPositions(e.getVerticesData(y.PositionKind)),e.isVerticesDataPresent(y.NormalKind)&&s.setNormals(e.getVerticesData(y.NormalKind)),e.isVerticesDataPresent(y.TangentKind)&&s.setTangents(e.getVerticesData(y.TangentKind)),e.isVerticesDataPresent(y.UVKind)&&s.setUVs(e.getVerticesData(y.UVKind)),s}}T([R()],xo.prototype,"id",void 0);class c0 extends H{constructor(e,t,i,s,r,n,o=!0,l=!1,h=H.TRILINEAR_SAMPLINGMODE,c=0){super(null,n,!o,l),this.format=r,this._texture=n.getEngine().createRawTexture2DArray(e,t,i,s,r,o,l,h,null,c),this._depth=s,this.is2DArray=!0}get depth(){return this._depth}update(e){!this._texture||this._getEngine().updateRawTexture2DArray(this._texture,e,this._texture.format,this._texture.invertY,null,this._texture.type)}static CreateRGBATexture(e,t,i,s,r,n=!0,o=!1,l=3,h=0){return new c0(e,t,i,s,5,r,n,o,l,h)}}class Oa{constructor(e=null){if(this._targets=new Array,this._targetInfluenceChangedObservers=new Array,this._targetDataLayoutChangedObservers=new Array,this._activeTargets=new mi(16),this._supportsNormals=!1,this._supportsTangents=!1,this._supportsUVs=!1,this._vertexCount=0,this._textureVertexStride=0,this._textureWidth=0,this._textureHeight=1,this._uniqueId=0,this._tempInfluences=new Array,this._canUseTextureForTargets=!1,this._blockCounter=0,this._parentContainer=null,this.optimizeInfluencers=!0,this.enableNormalMorphing=!0,this.enableTangentMorphing=!0,this.enableUVMorphing=!0,this._useTextureToStoreTargets=!0,e||(e=ye.LastCreatedScene),this._scene=e,this._scene){this._scene.morphTargetManagers.push(this),this._uniqueId=this._scene.getUniqueId();const t=this._scene.getEngine().getCaps();this._canUseTextureForTargets=t.canUseGLVertexID&&t.textureFloat&&t.maxVertexTextureImageUnits>0&&t.texture2DArrayMaxLayerCount>1}}set areUpdatesFrozen(e){e?this._blockCounter++:(this._blockCounter--,this._blockCounter<=0&&(this._blockCounter=0,this._syncActiveTargets(!0)))}get areUpdatesFrozen(){return this._blockCounter>0}get uniqueId(){return this._uniqueId}get vertexCount(){return this._vertexCount}get supportsNormals(){return this._supportsNormals&&this.enableNormalMorphing}get supportsTangents(){return this._supportsTangents&&this.enableTangentMorphing}get supportsUVs(){return this._supportsUVs&&this.enableUVMorphing}get numTargets(){return this._targets.length}get numInfluencers(){return this._activeTargets.length}get influences(){return this._influences}get useTextureToStoreTargets(){return this._useTextureToStoreTargets}set useTextureToStoreTargets(e){this._useTextureToStoreTargets=e}get isUsingTextureForTargets(){return Oa.EnableTextureStorage&&this.useTextureToStoreTargets&&this._canUseTextureForTargets}getActiveTarget(e){return this._activeTargets.data[e]}getTarget(e){return this._targets[e]}addTarget(e){this._targets.push(e),this._targetInfluenceChangedObservers.push(e.onInfluenceChanged.add(t=>{this._syncActiveTargets(t)})),this._targetDataLayoutChangedObservers.push(e._onDataLayoutChanged.add(()=>{this._syncActiveTargets(!0)})),this._syncActiveTargets(!0)}removeTarget(e){const t=this._targets.indexOf(e);t>=0&&(this._targets.splice(t,1),e.onInfluenceChanged.remove(this._targetInfluenceChangedObservers.splice(t,1)[0]),e._onDataLayoutChanged.remove(this._targetDataLayoutChangedObservers.splice(t,1)[0]),this._syncActiveTargets(!0))}_bind(e){e.setFloat3("morphTargetTextureInfo",this._textureVertexStride,this._textureWidth,this._textureHeight),e.setFloatArray("morphTargetTextureIndices",this._morphTargetTextureIndices),e.setTexture("morphTargets",this._targetStoreTexture)}clone(){const e=new Oa(this._scene);for(const t of this._targets)e.addTarget(t.clone());return e.enableNormalMorphing=this.enableNormalMorphing,e.enableTangentMorphing=this.enableTangentMorphing,e.enableUVMorphing=this.enableUVMorphing,e}serialize(){const e={};e.id=this.uniqueId,e.targets=[];for(const t of this._targets)e.targets.push(t.serialize());return e}_syncActiveTargets(e){if(this.areUpdatesFrozen)return;let t=0;this._activeTargets.reset(),this._supportsNormals=!0,this._supportsTangents=!0,this._supportsUVs=!0,this._vertexCount=0,(!this._morphTargetTextureIndices||this._morphTargetTextureIndices.length!==this._targets.length)&&(this._morphTargetTextureIndices=new Float32Array(this._targets.length));let i=-1;for(const s of this._targets){if(i++,s.influence===0&&this.optimizeInfluencers)continue;this._activeTargets.push(s),this._morphTargetTextureIndices[t]=i,this._tempInfluences[t++]=s.influence,this._supportsNormals=this._supportsNormals&&s.hasNormals,this._supportsTangents=this._supportsTangents&&s.hasTangents,this._supportsUVs=this._supportsUVs&&s.hasUVs;const r=s.getPositions();if(r){const n=r.length/3;if(this._vertexCount===0)this._vertexCount=n;else if(this._vertexCount!==n){B.Error("Incompatible target. Targets must all have the same vertices count.");return}}}(!this._influences||this._influences.length!==t)&&(this._influences=new Float32Array(t));for(let s=0;s<t;s++)this._influences[s]=this._tempInfluences[s];e&&this.synchronize()}synchronize(){if(!(!this._scene||this.areUpdatesFrozen)){if(this.isUsingTextureForTargets&&this._vertexCount){this._textureVertexStride=1,this._supportsNormals&&this._textureVertexStride++,this._supportsTangents&&this._textureVertexStride++,this._supportsUVs&&this._textureVertexStride++,this._textureWidth=this._vertexCount*this._textureVertexStride,this._textureHeight=1;const e=this._scene.getEngine().getCaps().maxTextureSize;this._textureWidth>e&&(this._textureHeight=Math.ceil(this._textureWidth/e),this._textureWidth=e);let t=!0;if(this._targetStoreTexture){const i=this._targetStoreTexture.getSize();i.width===this._textureWidth&&i.height===this._textureHeight&&this._targetStoreTexture.depth===this._targets.length&&(t=!1)}if(t){this._targetStoreTexture&&this._targetStoreTexture.dispose();const i=this._targets.length,s=new Float32Array(i*this._textureWidth*this._textureHeight*4);let r=0;for(let n=0;n<i;n++){const o=this._targets[n],l=o.getPositions(),h=o.getNormals(),c=o.getUVs(),u=o.getTangents();if(!l){n===0&&B.Error("Invalid morph target. Target must have positions.");return}r=n*this._textureWidth*this._textureHeight*4;for(let d=0;d<this._vertexCount;d++)s[r]=l[d*3],s[r+1]=l[d*3+1],s[r+2]=l[d*3+2],r+=4,h&&(s[r]=h[d*3],s[r+1]=h[d*3+1],s[r+2]=h[d*3+2],r+=4),c&&(s[r]=c[d*2],s[r+1]=c[d*2+1],r+=4),u&&(s[r]=u[d*3],s[r+1]=u[d*3+1],s[r+2]=u[d*3+2],r+=4)}this._targetStoreTexture=c0.CreateRGBATexture(s,this._textureWidth,this._textureHeight,i,this._scene,!1,!1,1,1)}}for(const e of this._scene.meshes)e.morphTargetManager===this&&e._syncGeometryWithMorphTargetManager()}}dispose(){if(this._targetStoreTexture&&this._targetStoreTexture.dispose(),this._targetStoreTexture=null,this._scene&&(this._scene.removeMorphTargetManager(this),this._parentContainer)){const e=this._parentContainer.morphTargetManagers.indexOf(this);e>-1&&this._parentContainer.morphTargetManagers.splice(e,1),this._parentContainer=null}}static Parse(e,t){const i=new Oa(t);i._uniqueId=e.id;for(const s of e.targets)i.addTarget(xo.Parse(s,t));return i}}Oa.EnableTextureStorage=!0;class oa{constructor(e,t=oa.DefaultPluginFactory()){if(this._physicsPlugin=t,this._impostors=[],this._joints=[],this._subTimeStep=0,this._uniqueIdCounter=0,!this._physicsPlugin.isSupported())throw new Error("Physics Engine "+this._physicsPlugin.name+" cannot be found. Please make sure it is included.");e=e||new g(0,-9.807,0),this.setGravity(e),this.setTimeStep()}static DefaultPluginFactory(){throw Ve("CannonJSPlugin")}setGravity(e){this.gravity=e,this._physicsPlugin.setGravity(this.gravity)}setTimeStep(e=1/60){this._physicsPlugin.setTimeStep(e)}getTimeStep(){return this._physicsPlugin.getTimeStep()}setSubTimeStep(e=0){this._subTimeStep=e}getSubTimeStep(){return this._subTimeStep}dispose(){this._impostors.forEach(function(e){e.dispose()}),this._physicsPlugin.dispose()}getPhysicsPluginName(){return this._physicsPlugin.name}addImpostor(e){this._impostors.push(e),e.uniqueId=this._uniqueIdCounter++,e.parent||this._physicsPlugin.generatePhysicsBody(e)}removeImpostor(e){const t=this._impostors.indexOf(e);t>-1&&this._impostors.splice(t,1).length&&this.getPhysicsPlugin().removePhysicsBody(e)}addJoint(e,t,i){const s={mainImpostor:e,connectedImpostor:t,joint:i};i.physicsPlugin=this._physicsPlugin,this._joints.push(s),this._physicsPlugin.generateJoint(s)}removeJoint(e,t,i){const s=this._joints.filter(function(r){return r.connectedImpostor===t&&r.joint===i&&r.mainImpostor===e});s.length&&this._physicsPlugin.removeJoint(s[0])}_step(e){this._impostors.forEach(t=>{t.isBodyInitRequired()&&this._physicsPlugin.generatePhysicsBody(t)}),e>.1?e=.1:e<=0&&(e=1/60),this._physicsPlugin.executeStep(e,this._impostors)}getPhysicsPlugin(){return this._physicsPlugin}getImpostors(){return this._impostors}getImpostorForPhysicsObject(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].object===e)return this._impostors[t];return null}getImpostorWithPhysicsBody(e){for(let t=0;t<this._impostors.length;++t)if(this._impostors[t].physicsBody===e)return this._impostors[t];return null}raycast(e,t){return this._physicsPlugin.raycast(e,t)}}oa.Epsilon=.001;class u0{constructor(){this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=g.Zero(),this._hitPointWorld=g.Zero(),this._rayFromWorld=g.Zero(),this._rayToWorld=g.Zero()}get hasHit(){return this._hasHit}get hitDistance(){return this._hitDistance}get hitNormalWorld(){return this._hitNormalWorld}get hitPointWorld(){return this._hitPointWorld}get rayFromWorld(){return this._rayFromWorld}get rayToWorld(){return this._rayToWorld}setHitData(e,t){this._hasHit=!0,this._hitNormalWorld=new g(e.x,e.y,e.z),this._hitPointWorld=new g(t.x,t.y,t.z)}setHitDistance(e){this._hitDistance=e}calculateHitDistance(){this._hitDistance=g.Distance(this._rayFromWorld,this._hitPointWorld)}reset(e=g.Zero(),t=g.Zero()){this._rayFromWorld=e,this._rayToWorld=t,this._hasHit=!1,this._hitDistance=0,this._hitNormalWorld=g.Zero(),this._hitPointWorld=g.Zero()}}class ad{constructor(e=!0,t=10,i=CANNON){if(this._useDeltaForWorldStep=e,this.name="CannonJSPlugin",this._physicsMaterials=new Array,this._fixedTimeStep=1/60,this._physicsBodiesToRemoveAfterStep=new Array,this._firstFrame=!0,this._tmpQuaternion=new Q,this._minus90X=new Q(-.7071067811865475,0,0,.7071067811865475),this._plus90X=new Q(.7071067811865475,0,0,.7071067811865475),this._tmpPosition=g.Zero(),this._tmpDeltaPosition=g.Zero(),this._tmpUnityRotation=new Q,this.BJSCANNON=i,!this.isSupported()){B.Error("CannonJS is not available. Please make sure you included the js file.");return}this._extendNamespace(),this.world=new this.BJSCANNON.World,this.world.broadphase=new this.BJSCANNON.NaiveBroadphase,this.world.solver.iterations=t,this._cannonRaycastResult=new this.BJSCANNON.RaycastResult,this._raycastResult=new u0}setGravity(e){const t=e;this.world.gravity.set(t.x,t.y,t.z)}setTimeStep(e){this._fixedTimeStep=e}getTimeStep(){return this._fixedTimeStep}executeStep(e,t){if(this._firstFrame){this._firstFrame=!1;for(const i of t)i.type==Oe.HeightmapImpostor||i.type===Oe.PlaneImpostor||i.beforeStep()}this.world.step(this._useDeltaForWorldStep?e:this._fixedTimeStep),this._removeMarkedPhysicsBodiesFromWorld()}_removeMarkedPhysicsBodiesFromWorld(){this._physicsBodiesToRemoveAfterStep.length>0&&(this._physicsBodiesToRemoveAfterStep.forEach(e=>{typeof this.world.removeBody=="function"?this.world.removeBody(e):this.world.remove(e)}),this._physicsBodiesToRemoveAfterStep.length=0)}applyImpulse(e,t,i){const s=new this.BJSCANNON.Vec3(i.x,i.y,i.z),r=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyImpulse(r,s)}applyForce(e,t,i){const s=new this.BJSCANNON.Vec3(i.x,i.y,i.z),r=new this.BJSCANNON.Vec3(t.x,t.y,t.z);e.physicsBody.applyForce(r,s)}generatePhysicsBody(e){if(this._removeMarkedPhysicsBodiesFromWorld(),e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e);if(!t){B.Warn("It was not possible to create a physics body for this object.");return}const i=e.physicsBody;i&&this.removePhysicsBody(e);const s=this._addMaterial("mat-"+e.uniqueId,e.getParam("friction"),e.getParam("restitution")),r={mass:e.getParam("mass"),material:s},n=e.getParam("nativeOptions");for(const o in n)Object.prototype.hasOwnProperty.call(n,o)&&(r[o]=n[o]);e.physicsBody=new this.BJSCANNON.Body(r),e.physicsBody.addEventListener("collide",e.onCollide),this.world.addEventListener("preStep",e.beforeStep),this.world.addEventListener("postStep",e.afterStep),e.physicsBody.addShape(t),typeof this.world.addBody=="function"?this.world.addBody(e.physicsBody):this.world.add(e.physicsBody),i&&["force","torque","velocity","angularVelocity"].forEach(function(o){const l=i[o];e.physicsBody[o].set(l.x,l.y,l.z)}),this._processChildMeshes(e)}this._updatePhysicsBodyTransformation(e)}_processChildMeshes(e){const t=e.object.getChildMeshes?e.object.getChildMeshes(!0):[],i=e.object.rotationQuaternion;if(i?i.conjugateToRef(this._tmpQuaternion):this._tmpQuaternion.set(0,0,0,1),t.length){const s=r=>{if(!r.rotationQuaternion)return;const n=r.getPhysicsImpostor();if(n&&n.parent!==e&&r.parent){const l=r.getAbsolutePosition().subtract(r.parent.getAbsolutePosition()),h=r.rotationQuaternion.multiply(this._tmpQuaternion);n.physicsBody&&(this.removePhysicsBody(n),n.physicsBody=null),n.parent=e,n.resetUpdateFlags(),e.physicsBody.addShape(this._createShape(n),new this.BJSCANNON.Vec3(l.x,l.y,l.z),new this.BJSCANNON.Quaternion(h.x,h.y,h.z,h.w)),e.physicsBody.mass+=n.getParam("mass")}r.getChildMeshes(!0).filter(o=>!!o.physicsImpostor).forEach(s)};t.filter(r=>!!r.physicsImpostor).forEach(s)}}removePhysicsBody(e){e.physicsBody.removeEventListener("collide",e.onCollide),this.world.removeEventListener("preStep",e.beforeStep),this.world.removeEventListener("postStep",e.afterStep),this._physicsBodiesToRemoveAfterStep.indexOf(e.physicsBody)===-1&&this._physicsBodiesToRemoveAfterStep.push(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;let s;const r=e.joint.jointData,n={pivotA:r.mainPivot?new this.BJSCANNON.Vec3().set(r.mainPivot.x,r.mainPivot.y,r.mainPivot.z):null,pivotB:r.connectedPivot?new this.BJSCANNON.Vec3().set(r.connectedPivot.x,r.connectedPivot.y,r.connectedPivot.z):null,axisA:r.mainAxis?new this.BJSCANNON.Vec3().set(r.mainAxis.x,r.mainAxis.y,r.mainAxis.z):null,axisB:r.connectedAxis?new this.BJSCANNON.Vec3().set(r.connectedAxis.x,r.connectedAxis.y,r.connectedAxis.z):null,maxForce:r.nativeParams.maxForce,collideConnected:!!r.collision};switch(e.joint.type){case Nt.HingeJoint:case Nt.Hinge2Joint:s=new this.BJSCANNON.HingeConstraint(t,i,n);break;case Nt.DistanceJoint:s=new this.BJSCANNON.DistanceConstraint(t,i,r.maxDistance||2);break;case Nt.SpringJoint:{const o=r;s=new this.BJSCANNON.Spring(t,i,{restLength:o.length,stiffness:o.stiffness,damping:o.damping,localAnchorA:n.pivotA,localAnchorB:n.pivotB});break}case Nt.LockJoint:s=new this.BJSCANNON.LockConstraint(t,i,n);break;case Nt.PointToPointJoint:case Nt.BallAndSocketJoint:default:s=new this.BJSCANNON.PointToPointConstraint(t,n.pivotA,i,n.pivotB,n.maxForce);break}s.collideConnected=!!r.collision,e.joint.physicsJoint=s,e.joint.type!==Nt.SpringJoint?this.world.addConstraint(s):(e.joint.jointData.forceApplicationCallback=e.joint.jointData.forceApplicationCallback||function(){s.applyForce()},e.mainImpostor.registerAfterPhysicsStep(e.joint.jointData.forceApplicationCallback))}removeJoint(e){e.joint.type!==Nt.SpringJoint?this.world.removeConstraint(e.joint.physicsJoint):e.mainImpostor.unregisterAfterPhysicsStep(e.joint.jointData.forceApplicationCallback)}_addMaterial(e,t,i){let s,r;for(s=0;s<this._physicsMaterials.length;s++)if(r=this._physicsMaterials[s],r.friction===t&&r.restitution===i)return r;const n=new this.BJSCANNON.Material(e);return n.friction=t,n.restitution=i,this._physicsMaterials.push(n),n}_checkWithEpsilon(e){return e<oa.Epsilon?oa.Epsilon:e}_createShape(e){const t=e.object;let i;const s=e.getObjectExtents();switch(e.type){case Oe.SphereImpostor:{const r=s.x,n=s.y,o=s.z;i=new this.BJSCANNON.Sphere(Math.max(this._checkWithEpsilon(r),this._checkWithEpsilon(n),this._checkWithEpsilon(o))/2);break}case Oe.CylinderImpostor:{let r=e.getParam("nativeOptions");r||(r={});const n=r.radiusTop!==void 0?r.radiusTop:this._checkWithEpsilon(s.x)/2,o=r.radiusBottom!==void 0?r.radiusBottom:this._checkWithEpsilon(s.x)/2,l=r.height!==void 0?r.height:this._checkWithEpsilon(s.y),h=r.numSegments!==void 0?r.numSegments:16;i=new this.BJSCANNON.Cylinder(n,o,l,h);const c=new this.BJSCANNON.Quaternion;c.setFromAxisAngle(new this.BJSCANNON.Vec3(1,0,0),-Math.PI/2);const u=new this.BJSCANNON.Vec3(0,0,0);i.transformAllPoints(u,c);break}case Oe.BoxImpostor:{const r=s.scale(.5);i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(this._checkWithEpsilon(r.x),this._checkWithEpsilon(r.y),this._checkWithEpsilon(r.z)));break}case Oe.PlaneImpostor:B.Warn("Attention, PlaneImposter might not behave as you expect. Consider using BoxImposter instead"),i=new this.BJSCANNON.Plane;break;case Oe.MeshImpostor:{const r=t.getVerticesData?t.getVerticesData(y.PositionKind):[],n=t.getIndices?t.getIndices():[];if(!r){B.Warn("Tried to create a MeshImpostor for an object without vertices. This will fail.");return}const o=t.position.clone(),l=t.rotation&&t.rotation.clone(),h=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace();const c=t.computeWorldMatrix(!0),u=new Array;let d;for(d=0;d<r.length;d+=3)g.TransformCoordinates(g.FromArray(r,d),c).toArray(u,d);B.Warn("MeshImpostor only collides against spheres."),i=new this.BJSCANNON.Trimesh(u,n),t.position.copyFrom(o),l&&t.rotation&&t.rotation.copyFrom(l),h&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(h);break}case Oe.HeightmapImpostor:{const r=t.position.clone(),n=t.rotation&&t.rotation.clone(),o=t.rotationQuaternion&&t.rotationQuaternion.clone();t.position.copyFromFloats(0,0,0),t.rotation&&t.rotation.copyFromFloats(0,0,0),t.rotationQuaternion&&t.rotationQuaternion.copyFrom(e.getParentsRotation()),t.rotationQuaternion&&t.parent&&t.rotationQuaternion.conjugateInPlace(),t.rotationQuaternion&&t.rotationQuaternion.multiplyInPlace(this._minus90X),i=this._createHeightmap(t),t.position.copyFrom(r),n&&t.rotation&&t.rotation.copyFrom(n),o&&t.rotationQuaternion&&t.rotationQuaternion.copyFrom(o),t.computeWorldMatrix(!0);break}case Oe.ParticleImpostor:i=new this.BJSCANNON.Particle;break;case Oe.NoImpostor:i=new this.BJSCANNON.Box(new this.BJSCANNON.Vec3(0,0,0));break}return i}_createHeightmap(e,t){let i=e.getVerticesData(y.PositionKind);const s=e.computeWorldMatrix(!0),r=new Array;let n;for(n=0;n<i.length;n+=3)g.TransformCoordinates(g.FromArray(i,n),s).toArray(r,n);i=r;const o=new Array,l=t||~~(Math.sqrt(i.length/3)-1),h=e.getBoundingInfo(),c=Math.min(h.boundingBox.extendSizeWorld.x,h.boundingBox.extendSizeWorld.y),u=h.boundingBox.extendSizeWorld.z,d=c*2/l;for(let p=0;p<i.length;p=p+3){const _=Math.round(i[p+0]/d+l/2),m=Math.round((i[p+1]/d-l/2)*-1),v=-i[p+2]+u;o[_]||(o[_]=[]),o[_][m]||(o[_][m]=v),o[_][m]=Math.max(v,o[_][m])}for(let p=0;p<=l;++p){if(!o[p]){let _=1;for(;!o[(p+_)%l];)_++;o[p]=o[(p+_)%l].slice()}for(let _=0;_<=l;++_)if(!o[p][_]){let m=1,v;for(;v===void 0;)v=o[p][(_+m++)%l];o[p][_]=v}}const f=new this.BJSCANNON.Heightfield(o,{elementSize:d});return f.minY=u,f}_updatePhysicsBodyTransformation(e){const t=e.object;if(t.computeWorldMatrix&&t.computeWorldMatrix(!0),!t.getBoundingInfo())return;const i=e.getObjectCenter();this._tmpDeltaPosition.copyFrom(t.getAbsolutePivotPoint().subtract(i)),this._tmpDeltaPosition.divideInPlace(e.object.scaling),this._tmpPosition.copyFrom(i);let s=t.rotationQuaternion;if(!!s){if((e.type===Oe.PlaneImpostor||e.type===Oe.HeightmapImpostor)&&(s=s.multiply(this._minus90X),e.setDeltaRotation(this._plus90X)),e.type===Oe.HeightmapImpostor){const r=t;let n=r.getBoundingInfo();const o=r.rotationQuaternion;r.rotationQuaternion=this._tmpUnityRotation,r.computeWorldMatrix(!0);const l=i.clone();let h=r.getPivotMatrix();h?h=h.clone():h=L.Identity();const c=L.Translation(n.boundingBox.extendSizeWorld.x,0,-n.boundingBox.extendSizeWorld.z);r.setPreTransformMatrix(c),r.computeWorldMatrix(!0),n=r.getBoundingInfo();const u=n.boundingBox.centerWorld.subtract(i).subtract(r.position).negate();this._tmpPosition.copyFromFloats(u.x,u.y-n.boundingBox.extendSizeWorld.y,u.z),this._tmpDeltaPosition.copyFrom(n.boundingBox.centerWorld.subtract(l)),this._tmpDeltaPosition.y+=n.boundingBox.extendSizeWorld.y,r.rotationQuaternion=o,r.setPreTransformMatrix(h),r.computeWorldMatrix(!0)}else e.type===Oe.MeshImpostor&&this._tmpDeltaPosition.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpDeltaPosition),e.physicsBody.position.set(this._tmpPosition.x,this._tmpPosition.y,this._tmpPosition.z),e.physicsBody.quaternion.set(s.x,s.y,s.z,s.w)}}setTransformationFromPhysicsBody(e){if(e.object.position.set(e.physicsBody.position.x,e.physicsBody.position.y,e.physicsBody.position.z),e.object.rotationQuaternion){const t=e.physicsBody.quaternion;e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}setPhysicsBodyTransformation(e,t,i){e.physicsBody.position.set(t.x,t.y,t.z),e.physicsBody.quaternion.set(i.x,i.y,i.z,i.w)}isSupported(){return this.BJSCANNON!==void 0}setLinearVelocity(e,t){e.physicsBody.velocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.velocity;return t?new g(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new g(t.x,t.y,t.z):null}setBodyMass(e,t){e.physicsBody.mass=t,e.physicsBody.updateMassProperties()}getBodyMass(e){return e.physicsBody.mass}getBodyFriction(e){return e.physicsBody.material.friction}setBodyFriction(e,t){e.physicsBody.material.friction=t}getBodyRestitution(e){return e.physicsBody.material.restitution}setBodyRestitution(e,t){e.physicsBody.material.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.wakeUp()}updateDistanceJoint(e,t){e.physicsJoint.distance=t}setMotor(e,t,i,s){s||(e.physicsJoint.enableMotor(),e.physicsJoint.setMotorSpeed(t),i&&this.setLimit(e,i))}setLimit(e,t,i){e.physicsJoint.motorEquation.maxForce=i,e.physicsJoint.motorEquation.minForce=t===void 0?-t:t}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.quaternion.x,e.rotationQuaternion.y=i.quaternion.y,e.rotationQuaternion.z=i.quaternion.z,e.rotationQuaternion.w=i.quaternion.w)}getRadius(e){return e.physicsBody.shapes[0].boundingSphereRadius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes[0];t.x=i.halfExtents.x*2,t.y=i.halfExtents.y*2,t.z=i.halfExtents.z*2}dispose(){}_extendNamespace(){const e=new this.BJSCANNON.Vec3,t=this.BJSCANNON;this.BJSCANNON.World.prototype.step=function(i,s,r){if(r=r||10,s=s||0,s===0)this.internalStep(i),this.time+=i;else{let n=Math.floor((this.time+s)/i)-Math.floor(this.time/i);n=Math.min(n,r)||1;const o=performance.now();for(let d=0;d!==n&&(this.internalStep(i),!(performance.now()-o>i*1e3));d++);this.time+=s;const h=this.time%i/i,c=e,u=this.bodies;for(let d=0;d!==u.length;d++){const f=u[d];f.type!==t.Body.STATIC&&f.sleepState!==t.Body.SLEEPING?(f.position.vsub(f.previousPosition,c),c.scale(h,c),f.position.vadd(c,f.interpolatedPosition)):(f.interpolatedPosition.set(f.position.x,f.position.y,f.position.z),f.interpolatedQuaternion.set(f.quaternion.x,f.quaternion.y,f.quaternion.z,f.quaternion.w))}}}}raycast(e,t){return this._cannonRaycastResult.reset(),this.world.raycastClosest(e,t,{},this._cannonRaycastResult),this._raycastResult.reset(e,t),this._cannonRaycastResult.hasHit&&(this._raycastResult.setHitData({x:this._cannonRaycastResult.hitNormalWorld.x,y:this._cannonRaycastResult.hitNormalWorld.y,z:this._cannonRaycastResult.hitNormalWorld.z},{x:this._cannonRaycastResult.hitPointWorld.x,y:this._cannonRaycastResult.hitPointWorld.y,z:this._cannonRaycastResult.hitPointWorld.z}),this._raycastResult.setHitDistance(this._cannonRaycastResult.distance)),this._raycastResult}}oa.DefaultPluginFactory=()=>new ad;class np{constructor(e=!0,t,i=OIMO){this._useDeltaForWorldStep=e,this.name="OimoJSPlugin",this._fixedTimeStep=1/60,this._tmpImpostorsArray=[],this._tmpPositionVector=g.Zero(),this.BJSOIMO=i,this.world=new this.BJSOIMO.World({iterations:t}),this.world.clear(),this._raycastResult=new u0}setGravity(e){this.world.gravity.set(e.x,e.y,e.z)}setTimeStep(e){this.world.timeStep=e}getTimeStep(){return this.world.timeStep}executeStep(e,t){t.forEach(function(s){s.beforeStep()}),this.world.timeStep=this._useDeltaForWorldStep?e:this._fixedTimeStep,this.world.step(),t.forEach(s=>{s.afterStep(),this._tmpImpostorsArray[s.uniqueId]=s});let i=this.world.contacts;for(;i!==null;){if(i.touching&&!i.body1.sleeping&&!i.body2.sleeping){i=i.next;continue}const s=this._tmpImpostorsArray[+i.body1.name],r=this._tmpImpostorsArray[+i.body2.name];if(!s||!r){i=i.next;continue}s.onCollide({body:r.physicsBody,point:null,distance:0,impulse:0,normal:null}),r.onCollide({body:s.physicsBody,point:null,distance:0,impulse:0,normal:null}),i=i.next}}applyImpulse(e,t,i){const s=e.physicsBody.mass;e.physicsBody.applyImpulse(i.scale(this.world.invScale),t.scale(this.world.invScale*s))}applyForce(e,t,i){B.Warn("Oimo doesn't support applying force. Using impulse instead."),this.applyImpulse(e,t,i)}generatePhysicsBody(e){if(e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t={name:e.uniqueId,config:[e.getParam("mass")||.001,e.getParam("friction"),e.getParam("restitution")],size:[],type:[],pos:[],posShape:[],rot:[],rotShape:[],move:e.getParam("mass")!==0,density:e.getParam("mass"),friction:e.getParam("friction"),restitution:e.getParam("restitution"),world:this.world},i=[e];(o=>{!o.getChildMeshes||o.getChildMeshes().forEach(function(l){l.physicsImpostor&&i.push(l.physicsImpostor)})})(e.object);const r=o=>Math.max(o,oa.Epsilon),n=new Q;i.forEach(o=>{if(!o.object.rotationQuaternion)return;const l=o.object.rotationQuaternion;n.copyFrom(l),o.object.rotationQuaternion.set(0,0,0,1),o.object.computeWorldMatrix(!0);const h=n.toEulerAngles(),c=o.getObjectExtents(),u=57.29577951308232;if(o===e){const d=e.getObjectCenter();e.object.getAbsolutePivotPoint().subtractToRef(d,this._tmpPositionVector),this._tmpPositionVector.divideInPlace(e.object.scaling),t.pos.push(d.x),t.pos.push(d.y),t.pos.push(d.z),t.posShape.push(0,0,0),t.rotShape.push(0,0,0)}else{const d=o.object.position.clone();t.posShape.push(d.x),t.posShape.push(d.y),t.posShape.push(d.z),t.rotShape.push(h.x*u,h.y*u,h.z*u)}switch(o.object.rotationQuaternion.copyFrom(n),o.type){case Oe.ParticleImpostor:B.Warn("No Particle support in OIMO.js. using SphereImpostor instead");case Oe.SphereImpostor:{const d=c.x,f=c.y,p=c.z,_=Math.max(r(d),r(f),r(p))/2;t.type.push("sphere"),t.size.push(_),t.size.push(_),t.size.push(_);break}case Oe.CylinderImpostor:{const d=r(c.x)/2,f=r(c.y);t.type.push("cylinder"),t.size.push(d),t.size.push(f),t.size.push(f);break}case Oe.PlaneImpostor:case Oe.BoxImpostor:default:{const d=r(c.x),f=r(c.y),p=r(c.z);t.type.push("box"),t.size.push(d),t.size.push(f),t.size.push(p);break}}o.object.rotationQuaternion=l}),e.physicsBody=this.world.add(t),e.physicsBody.resetQuaternion(n),e.physicsBody.updatePosition(0)}else this._tmpPositionVector.copyFromFloats(0,0,0);e.setDeltaPosition(this._tmpPositionVector)}removePhysicsBody(e){this.world.removeRigidBody(e.physicsBody)}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const s=e.joint.jointData,r=s.nativeParams||{};let n;const o={body1:t,body2:i,axe1:r.axe1||(s.mainAxis?s.mainAxis.asArray():null),axe2:r.axe2||(s.connectedAxis?s.connectedAxis.asArray():null),pos1:r.pos1||(s.mainPivot?s.mainPivot.asArray():null),pos2:r.pos2||(s.connectedPivot?s.connectedPivot.asArray():null),min:r.min,max:r.max,collision:r.collision||s.collision,spring:r.spring,world:this.world};switch(e.joint.type){case Nt.BallAndSocketJoint:n="jointBall";break;case Nt.SpringJoint:{B.Warn("OIMO.js doesn't support Spring Constraint. Simulating using DistanceJoint instead");const l=s;o.min=l.length||o.min,o.max=Math.max(o.min,o.max)}case Nt.DistanceJoint:n="jointDistance",o.max=s.maxDistance;break;case Nt.PrismaticJoint:n="jointPrisme";break;case Nt.SliderJoint:n="jointSlide";break;case Nt.WheelJoint:n="jointWheel";break;case Nt.HingeJoint:default:n="jointHinge";break}o.type=n,e.joint.physicsJoint=this.world.add(o)}removeJoint(e){try{this.world.removeJoint(e.joint.physicsJoint)}catch(t){B.Warn(t)}}isSupported(){return this.BJSOIMO!==void 0}setTransformationFromPhysicsBody(e){if(!e.physicsBody.sleeping){if(e.physicsBody.shapes.next){let t=e.physicsBody.shapes;for(;t.next;)t=t.next;e.object.position.set(t.position.x,t.position.y,t.position.z)}else{const t=e.physicsBody.getPosition();e.object.position.set(t.x,t.y,t.z)}if(e.object.rotationQuaternion){const t=e.physicsBody.getQuaternion();e.object.rotationQuaternion.set(t.x,t.y,t.z,t.w)}}}setPhysicsBodyTransformation(e,t,i){const s=e.physicsBody;e.physicsBody.shapes.next||(s.position.set(t.x,t.y,t.z),s.orientation.set(i.x,i.y,i.z,i.w),s.syncShapes(),s.awake())}setLinearVelocity(e,t){e.physicsBody.linearVelocity.set(t.x,t.y,t.z)}setAngularVelocity(e,t){e.physicsBody.angularVelocity.set(t.x,t.y,t.z)}getLinearVelocity(e){const t=e.physicsBody.linearVelocity;return t?new g(t.x,t.y,t.z):null}getAngularVelocity(e){const t=e.physicsBody.angularVelocity;return t?new g(t.x,t.y,t.z):null}setBodyMass(e,t){const i=t===0;e.physicsBody.shapes.density=i?1:t,e.physicsBody.setupMass(i?2:1)}getBodyMass(e){return e.physicsBody.shapes.density}getBodyFriction(e){return e.physicsBody.shapes.friction}setBodyFriction(e,t){e.physicsBody.shapes.friction=t}getBodyRestitution(e){return e.physicsBody.shapes.restitution}setBodyRestitution(e,t){e.physicsBody.shapes.restitution=t}sleepBody(e){e.physicsBody.sleep()}wakeUpBody(e){e.physicsBody.awake()}updateDistanceJoint(e,t,i){e.physicsJoint.limitMotor.upperLimit=t,i!==void 0&&(e.physicsJoint.limitMotor.lowerLimit=i)}setMotor(e,t,i,s){i!==void 0?B.Warn("OimoJS plugin currently has unexpected behavior when using setMotor with force parameter"):i=1e6,t*=-1;const r=s?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;r&&r.setMotor(t,i)}setLimit(e,t,i,s){const r=s?e.physicsJoint.rotationalLimitMotor2:e.physicsJoint.rotationalLimitMotor1||e.physicsJoint.rotationalLimitMotor||e.physicsJoint.limitMotor;r&&r.setLimit(t,i===void 0?-t:i)}syncMeshWithImpostor(e,t){const i=t.physicsBody;e.position.x=i.position.x,e.position.y=i.position.y,e.position.z=i.position.z,e.rotationQuaternion&&(e.rotationQuaternion.x=i.orientation.x,e.rotationQuaternion.y=i.orientation.y,e.rotationQuaternion.z=i.orientation.z,e.rotationQuaternion.w=i.orientation.w)}getRadius(e){return e.physicsBody.shapes.radius}getBoxSizeToRef(e,t){const i=e.physicsBody.shapes;t.x=i.halfWidth*2,t.y=i.halfHeight*2,t.z=i.halfDepth*2}dispose(){this.world.clear()}raycast(e,t){return B.Warn("raycast is not currently supported by the Oimo physics plugin"),this._raycastResult.reset(e,t),this._raycastResult}}class zr{constructor(e=!0,t=Ammo,i=null){if(this._useDeltaForWorldStep=e,this.bjsAMMO={},this.name="AmmoJSPlugin",this._timeStep=1/60,this._fixedTimeStep=1/60,this._maxSteps=5,this._tmpQuaternion=new Q,this._tmpContactCallbackResult=!1,this._tmpContactPoint=new g,this._tmpContactNormal=new g,this._tmpVec3=new g,this._tmpMatrix=new L,typeof t=="function"){B.Error("AmmoJS is not ready. Please make sure you await Ammo() before using the plugin.");return}else this.bjsAMMO=t;if(!this.isSupported()){B.Error("AmmoJS is not available. Please make sure you included the js file.");return}this._collisionConfiguration=new this.bjsAMMO.btSoftBodyRigidBodyCollisionConfiguration,this._dispatcher=new this.bjsAMMO.btCollisionDispatcher(this._collisionConfiguration),this._overlappingPairCache=i||new this.bjsAMMO.btDbvtBroadphase,this._solver=new this.bjsAMMO.btSequentialImpulseConstraintSolver,this._softBodySolver=new this.bjsAMMO.btDefaultSoftBodySolver,this.world=new this.bjsAMMO.btSoftRigidDynamicsWorld(this._dispatcher,this._overlappingPairCache,this._solver,this._collisionConfiguration,this._softBodySolver),this._tmpAmmoConcreteContactResultCallback=new this.bjsAMMO.ConcreteContactResultCallback,this._tmpAmmoConcreteContactResultCallback.addSingleResult=s=>{s=this.bjsAMMO.wrapPointer(s,this.bjsAMMO.btManifoldPoint);const r=s.getPositionWorldOnA(),n=s.m_normalWorldOnB;this._tmpContactPoint.x=r.x(),this._tmpContactPoint.y=r.y(),this._tmpContactPoint.z=r.z(),this._tmpContactNormal.x=n.x(),this._tmpContactNormal.y=n.y(),this._tmpContactNormal.z=n.z(),this._tmpContactImpulse=s.getAppliedImpulse(),this._tmpContactDistance=s.getDistance(),this._tmpContactCallbackResult=!0},this._raycastResult=new u0,this._tmpAmmoTransform=new this.bjsAMMO.btTransform,this._tmpAmmoTransform.setIdentity(),this._tmpAmmoQuaternion=new this.bjsAMMO.btQuaternion(0,0,0,1),this._tmpAmmoVectorA=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorB=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorC=new this.bjsAMMO.btVector3(0,0,0),this._tmpAmmoVectorD=new this.bjsAMMO.btVector3(0,0,0)}setGravity(e){this._tmpAmmoVectorA.setValue(e.x,e.y,e.z),this.world.setGravity(this._tmpAmmoVectorA),this.world.getWorldInfo().set_m_gravity(this._tmpAmmoVectorA)}setTimeStep(e){this._timeStep=e}setFixedTimeStep(e){this._fixedTimeStep=e}setMaxSteps(e){this._maxSteps=e}getTimeStep(){return this._timeStep}_isImpostorInContact(e){return this._tmpContactCallbackResult=!1,this.world.contactTest(e.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_isImpostorPairInContact(e,t){return this._tmpContactCallbackResult=!1,this.world.contactPairTest(e.physicsBody,t.physicsBody,this._tmpAmmoConcreteContactResultCallback),this._tmpContactCallbackResult}_stepSimulation(e=1/60,t=10,i=1/60){if(t==0)this.world.stepSimulation(e,0);else for(;t>0&&e>0;)e-i<i?(this.world.stepSimulation(e,0),e=0):(e-=i,this.world.stepSimulation(i,0)),t--}executeStep(e,t){for(const i of t)i.soft||i.beforeStep();this._stepSimulation(this._useDeltaForWorldStep?e:this._timeStep,this._maxSteps,this._fixedTimeStep);for(const i of t)if(i.soft?this._afterSoftStep(i):i.afterStep(),i._onPhysicsCollideCallbacks.length>0&&this._isImpostorInContact(i))for(const s of i._onPhysicsCollideCallbacks)for(const r of s.otherImpostors)(i.physicsBody.isActive()||r.physicsBody.isActive())&&this._isImpostorPairInContact(i,r)&&(i.onCollide({body:r.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}),r.onCollide({body:i.physicsBody,point:this._tmpContactPoint,distance:this._tmpContactDistance,impulse:this._tmpContactImpulse,normal:this._tmpContactNormal}))}_afterSoftStep(e){e.type===Oe.RopeImpostor?this._ropeStep(e):this._softbodyOrClothStep(e)}_ropeStep(e){const t=e.physicsBody.get_m_nodes(),i=t.size();let s,r,n,o,l;const h=new Array;for(let d=0;d<i;d++)s=t.at(d),r=s.get_m_x(),n=r.x(),o=r.y(),l=r.z(),h.push(new g(n,o,l));const c=e.object,u=e.getParam("shape");e._isFromLine?e.object=Kc("lines",{points:h,instance:c}):e.object=e0("ext",{shape:u,path:h,instance:c})}_softbodyOrClothStep(e){const t=e.type===Oe.ClothImpostor?1:-1,i=e.object;let s=i.getVerticesData(y.PositionKind);s||(s=[]);let r=i.getVerticesData(y.NormalKind);r||(r=[]);const n=s.length/3,o=e.physicsBody.get_m_nodes();let l,h,c,u,d,f,p,_;for(let v=0;v<n;v++){l=o.at(v),h=l.get_m_x(),c=h.x(),u=h.y(),d=h.z()*t;const x=l.get_m_n();f=x.x(),p=x.y(),_=x.z()*t,s[3*v]=c,s[3*v+1]=u,s[3*v+2]=d,r[3*v]=f,r[3*v+1]=p,r[3*v+2]=_}const m=new de;m.positions=s,m.normals=r,m.uvs=i.getVerticesData(y.UVKind),m.colors=i.getVerticesData(y.ColorKind),i&&i.getIndices&&(m.indices=i.getIndices()),m.applyToMesh(i)}applyImpulse(e,t,i){if(e.soft)B.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const s=this._tmpAmmoVectorA,r=this._tmpAmmoVectorB;e.object&&e.object.getWorldMatrix&&i.subtractInPlace(e.object.getWorldMatrix().getTranslation()),s.setValue(i.x,i.y,i.z),r.setValue(t.x,t.y,t.z),e.physicsBody.applyImpulse(r,s)}}applyForce(e,t,i){if(e.soft)B.Warn("Cannot be applied to a soft body");else{e.physicsBody.activate();const s=this._tmpAmmoVectorA,r=this._tmpAmmoVectorB;if(e.object&&e.object.getWorldMatrix){const n=e.object.getWorldMatrix().getTranslation();s.setValue(i.x-n.x,i.y-n.y,i.z-n.z)}else s.setValue(i.x,i.y,i.z);r.setValue(t.x,t.y,t.z),e.physicsBody.applyForce(r,s)}}generatePhysicsBody(e){if(e._pluginData.toDispose=[],e.parent){e.physicsBody&&(this.removePhysicsBody(e),e.forceUpdate());return}if(e.isBodyInitRequired()){const t=this._createShape(e),i=e.getParam("mass");if(e._pluginData.mass=i,e.soft)t.get_m_cfg().set_collisions(17),t.get_m_cfg().set_kDP(e.getParam("damping")),this.bjsAMMO.castObject(t,this.bjsAMMO.btCollisionObject).getCollisionShape().setMargin(e.getParam("margin")),t.setActivationState(zr._DISABLE_DEACTIVATION_FLAG),this.world.addSoftBody(t,1,-1),e.physicsBody=t,e._pluginData.toDispose.push(t),this.setBodyPressure(e,0),e.type===Oe.SoftbodyImpostor&&this.setBodyPressure(e,e.getParam("pressure")),this.setBodyStiffness(e,e.getParam("stiffness")),this.setBodyVelocityIterations(e,e.getParam("velocityIterations")),this.setBodyPositionIterations(e,e.getParam("positionIterations"));else{const s=new this.bjsAMMO.btVector3(0,0,0),r=new this.bjsAMMO.btTransform;e.object.computeWorldMatrix(!0),r.setIdentity(),i!==0&&t.calculateLocalInertia(i,s),this._tmpAmmoVectorA.setValue(e.object.position.x,e.object.position.y,e.object.position.z),this._tmpAmmoQuaternion.setValue(e.object.rotationQuaternion.x,e.object.rotationQuaternion.y,e.object.rotationQuaternion.z,e.object.rotationQuaternion.w),r.setOrigin(this._tmpAmmoVectorA),r.setRotation(this._tmpAmmoQuaternion);const n=new this.bjsAMMO.btDefaultMotionState(r),o=new this.bjsAMMO.btRigidBodyConstructionInfo(i,n,t,s),l=new this.bjsAMMO.btRigidBody(o);if(i===0&&(l.setCollisionFlags(l.getCollisionFlags()|zr._KINEMATIC_FLAG),l.setActivationState(zr._DISABLE_DEACTIVATION_FLAG)),e.type==Oe.NoImpostor&&!t.getChildShape&&l.setCollisionFlags(l.getCollisionFlags()|zr._DISABLE_COLLISION_FLAG),e.type!==Oe.MeshImpostor&&e.type!==Oe.NoImpostor){const u=e.object.getBoundingInfo();this._tmpVec3.copyFrom(e.object.getAbsolutePosition()),this._tmpVec3.subtractInPlace(u.boundingBox.centerWorld),this._tmpVec3.x/=e.object.scaling.x,this._tmpVec3.y/=e.object.scaling.y,this._tmpVec3.z/=e.object.scaling.z,e.setDeltaPosition(this._tmpVec3)}const h=e.getParam("group"),c=e.getParam("mask");h&&c?this.world.addRigidBody(l,h,c):this.world.addRigidBody(l),e.physicsBody=l,e._pluginData.toDispose=e._pluginData.toDispose.concat([l,o,n,r,s,t])}this.setBodyRestitution(e,e.getParam("restitution")),this.setBodyFriction(e,e.getParam("friction"))}}removePhysicsBody(e){this.world&&(e.soft?this.world.removeSoftBody(e.physicsBody):this.world.removeRigidBody(e.physicsBody),e._pluginData&&(e._pluginData.toDispose.forEach(t=>{this.bjsAMMO.destroy(t)}),e._pluginData.toDispose=[]))}generateJoint(e){const t=e.mainImpostor.physicsBody,i=e.connectedImpostor.physicsBody;if(!t||!i)return;const s=e.joint.jointData;s.mainPivot||(s.mainPivot=new g(0,0,0)),s.connectedPivot||(s.connectedPivot=new g(0,0,0));let r;switch(e.joint.type){case Nt.DistanceJoint:{const n=s.maxDistance;n&&(s.mainPivot=new g(0,-n/2,0),s.connectedPivot=new g(0,n/2,0)),r=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break}case Nt.HingeJoint:{s.mainAxis||(s.mainAxis=new g(0,0,0)),s.connectedAxis||(s.connectedAxis=new g(0,0,0));const n=new this.bjsAMMO.btVector3(s.mainAxis.x,s.mainAxis.y,s.mainAxis.z),o=new this.bjsAMMO.btVector3(s.connectedAxis.x,s.connectedAxis.y,s.connectedAxis.z);r=new this.bjsAMMO.btHingeConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z),n,o);break}case Nt.BallAndSocketJoint:r=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break;default:B.Warn("JointType not currently supported by the Ammo plugin, falling back to PhysicsJoint.BallAndSocketJoint"),r=new this.bjsAMMO.btPoint2PointConstraint(t,i,new this.bjsAMMO.btVector3(s.mainPivot.x,s.mainPivot.y,s.mainPivot.z),new this.bjsAMMO.btVector3(s.connectedPivot.x,s.connectedPivot.y,s.connectedPivot.z));break}this.world.addConstraint(r,!e.joint.jointData.collision),e.joint.physicsJoint=r}removeJoint(e){this.world&&this.world.removeConstraint(e.joint.physicsJoint)}_addMeshVerts(e,t,i){let s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let r=i.getIndices();r||(r=[]);let n=i.getVerticesData(y.PositionKind);n||(n=[]);let o;if(t&&t!==i){let h;t.rotationQuaternion?h=t.rotationQuaternion:t.rotation?h=Q.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z):h=Q.Identity(),L.Compose(g.One(),h,t.position).invertToRef(this._tmpMatrix),o=i.computeWorldMatrix(!1).multiply(this._tmpMatrix)}else L.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),o=this._tmpMatrix;const l=r.length/3;for(let h=0;h<l;h++){const c=[];for(let u=0;u<3;u++){let d=new g(n[r[h*3+u]*3+0],n[r[h*3+u]*3+1],n[r[h*3+u]*3+2]);d=g.TransformCoordinates(d,o);let f;u==0?f=this._tmpAmmoVectorA:u==1?f=this._tmpAmmoVectorB:f=this._tmpAmmoVectorC,f.setValue(d.x,d.y,d.z),c.push(f)}e.addTriangle(c[0],c[1],c[2]),s++}i.getChildMeshes().forEach(h=>{s+=this._addMeshVerts(e,t,h)})}return s}_softVertexData(e){const t=e.object;if(t&&t.getIndices&&t.getWorldMatrix&&t.getChildMeshes){t.getIndices();let i=t.getVerticesData(y.PositionKind);i||(i=[]);let s=t.getVerticesData(y.NormalKind);s||(s=[]),t.computeWorldMatrix(!1);const r=[],n=[];for(let l=0;l<i.length;l+=3){let h=new g(i[l],i[l+1],i[l+2]),c=new g(s[l],s[l+1],s[l+2]);h=g.TransformCoordinates(h,t.getWorldMatrix()),c=g.TransformNormal(c,t.getWorldMatrix()),r.push(h.x,h.y,h.z),n.push(c.x,c.y,c.z)}const o=new de;return o.positions=r,o.normals=n,o.uvs=t.getVerticesData(y.UVKind),o.colors=t.getVerticesData(y.ColorKind),t&&t.getIndices&&(o.indices=t.getIndices()),o.applyToMesh(t),t.position=g.Zero(),t.rotationQuaternion=null,t.rotation=g.Zero(),t.computeWorldMatrix(!0),o}return de.ExtractFromMesh(t)}_createSoftbody(e){const t=e.object;if(t&&t.getIndices){let i=t.getIndices();i||(i=[]);const s=this._softVertexData(e),r=s.positions,n=s.normals;if(r===null||n===null)return new this.bjsAMMO.btCompoundShape;{const o=[],l=[];for(let p=0;p<r.length;p+=3){const _=new g(r[p],r[p+1],r[p+2]),m=new g(n[p],n[p+1],n[p+2]);o.push(_.x,_.y,-_.z),l.push(m.x,m.y,-m.z)}const h=new this.bjsAMMO.btSoftBodyHelpers().CreateFromTriMesh(this.world.getWorldInfo(),o,t.getIndices(),i.length/3,!0),c=r.length/3,u=h.get_m_nodes();let d,f;for(let p=0;p<c;p++)d=u.at(p),f=d.get_m_n(),f.setX(l[3*p]),f.setY(l[3*p+1]),f.setZ(l[3*p+2]);return h}}}_createCloth(e){const t=e.object;if(t&&t.getIndices){t.getIndices();const i=this._softVertexData(e),s=i.positions,r=i.normals;if(s===null||r===null)return new this.bjsAMMO.btCompoundShape;{const n=s.length,o=Math.sqrt(n/3);e.segments=o;const l=o-1;return this._tmpAmmoVectorA.setValue(s[0],s[1],s[2]),this._tmpAmmoVectorB.setValue(s[3*l],s[3*l+1],s[3*l+2]),this._tmpAmmoVectorD.setValue(s[n-3],s[n-2],s[n-1]),this._tmpAmmoVectorC.setValue(s[n-3-3*l],s[n-2-3*l],s[n-1-3*l]),new this.bjsAMMO.btSoftBodyHelpers().CreatePatch(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,this._tmpAmmoVectorC,this._tmpAmmoVectorD,o,o,e.getParam("fixedPoints"),!0)}}}_createRope(e){let t,i;const s=this._softVertexData(e),r=s.positions,n=s.normals;if(r===null||n===null)return new this.bjsAMMO.btCompoundShape;s.applyToMesh(e.object,!0),e._isFromLine=!0;const o=n.map(d=>d*d),l=(d,f)=>d+f;if(o.reduce(l)===0)t=r.length,i=t/3-1,this._tmpAmmoVectorA.setValue(r[0],r[1],r[2]),this._tmpAmmoVectorB.setValue(r[t-3],r[t-2],r[t-1]);else{e._isFromLine=!1;const d=e.getParam("path");if(e.getParam("shape")===null)return B.Warn("No shape available for extruded mesh"),new this.bjsAMMO.btCompoundShape;t=d.length,i=t-1,this._tmpAmmoVectorA.setValue(d[0].x,d[0].y,d[0].z),this._tmpAmmoVectorB.setValue(d[t-1].x,d[t-1].y,d[t-1].z)}e.segments=i;let c=e.getParam("fixedPoints");c=c>3?3:c;const u=new this.bjsAMMO.btSoftBodyHelpers().CreateRope(this.world.getWorldInfo(),this._tmpAmmoVectorA,this._tmpAmmoVectorB,i-1,c);return u.get_m_cfg().set_collisions(17),u}_createCustom(e){let t=null;return this.onCreateCustomShape&&(t=this.onCreateCustomShape(e)),t==null&&(t=new this.bjsAMMO.btCompoundShape),t}_addHullVerts(e,t,i){let s=0;if(i&&i.getIndices&&i.getWorldMatrix&&i.getChildMeshes){let r=i.getIndices();r||(r=[]);let n=i.getVerticesData(y.PositionKind);n||(n=[]),i.computeWorldMatrix(!1);const o=r.length/3;for(let l=0;l<o;l++){const h=[];for(let c=0;c<3;c++){let u=new g(n[r[l*3+c]*3+0],n[r[l*3+c]*3+1],n[r[l*3+c]*3+2]);L.ScalingToRef(i.scaling.x,i.scaling.y,i.scaling.z,this._tmpMatrix),u=g.TransformCoordinates(u,this._tmpMatrix);let d;c==0?d=this._tmpAmmoVectorA:c==1?d=this._tmpAmmoVectorB:d=this._tmpAmmoVectorC,d.setValue(u.x,u.y,u.z),h.push(d)}e.addPoint(h[0],!0),e.addPoint(h[1],!0),e.addPoint(h[2],!0),s++}i.getChildMeshes().forEach(l=>{s+=this._addHullVerts(e,t,l)})}return s}_createShape(e,t=!1){const i=e.object;let s;const r=e.getObjectExtents();if(!t){const n=e.object.getChildMeshes?e.object.getChildMeshes(!0):[];s=new this.bjsAMMO.btCompoundShape;let o=0;if(n.forEach(l=>{const h=l.getPhysicsImpostor();if(h){if(h.type==Oe.MeshImpostor)throw"A child MeshImpostor is not supported. Only primitive impostors are supported as children (eg. box or sphere)";const c=this._createShape(h),u=l.parent.getWorldMatrix().clone(),d=new g;u.decompose(d),this._tmpAmmoTransform.getOrigin().setValue(l.position.x*d.x,l.position.y*d.y,l.position.z*d.z),this._tmpAmmoQuaternion.setValue(l.rotationQuaternion.x,l.rotationQuaternion.y,l.rotationQuaternion.z,l.rotationQuaternion.w),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,c),h.dispose(),o++}}),o>0){if(e.type!=Oe.NoImpostor){const l=this._createShape(e,!0);l&&(this._tmpAmmoTransform.getOrigin().setValue(0,0,0),this._tmpAmmoQuaternion.setValue(0,0,0,1),this._tmpAmmoTransform.setRotation(this._tmpAmmoQuaternion),s.addChildShape(this._tmpAmmoTransform,l))}return s}else this.bjsAMMO.destroy(s),s=null}switch(e.type){case Oe.SphereImpostor:if(oe.WithinEpsilon(r.x,r.y,1e-4)&&oe.WithinEpsilon(r.x,r.z,1e-4))s=new this.bjsAMMO.btSphereShape(r.x/2);else{const n=[new this.bjsAMMO.btVector3(0,0,0)],o=[1];s=new this.bjsAMMO.btMultiSphereShape(n,o,1),s.setLocalScaling(new this.bjsAMMO.btVector3(r.x/2,r.y/2,r.z/2))}break;case Oe.CapsuleImpostor:{const n=r.x/2;s=new this.bjsAMMO.btCapsuleShape(n,r.y-n*2)}break;case Oe.CylinderImpostor:this._tmpAmmoVectorA.setValue(r.x/2,r.y/2,r.z/2),s=new this.bjsAMMO.btCylinderShape(this._tmpAmmoVectorA);break;case Oe.PlaneImpostor:case Oe.BoxImpostor:this._tmpAmmoVectorA.setValue(r.x/2,r.y/2,r.z/2),s=new this.bjsAMMO.btBoxShape(this._tmpAmmoVectorA);break;case Oe.MeshImpostor:if(e.getParam("mass")==0){if(this.onCreateCustomMeshImpostor)s=this.onCreateCustomMeshImpostor(e);else{const n=new this.bjsAMMO.btTriangleMesh;e._pluginData.toDispose.push(n),this._addMeshVerts(n,i,i)==0?s=new this.bjsAMMO.btCompoundShape:s=new this.bjsAMMO.btBvhTriangleMeshShape(n)}break}case Oe.ConvexHullImpostor:{if(this.onCreateCustomConvexHullImpostor)s=this.onCreateCustomConvexHullImpostor(e);else{const n=new this.bjsAMMO.btConvexHullShape;this._addHullVerts(n,i,i)==0?(e._pluginData.toDispose.push(n),s=new this.bjsAMMO.btCompoundShape):s=n}break}case Oe.NoImpostor:s=new this.bjsAMMO.btSphereShape(r.x/2);break;case Oe.CustomImpostor:s=this._createCustom(e);break;case Oe.SoftbodyImpostor:s=this._createSoftbody(e);break;case Oe.ClothImpostor:s=this._createCloth(e);break;case Oe.RopeImpostor:s=this._createRope(e);break;default:B.Warn("The impostor type is not currently supported by the ammo plugin.");break}return s}setTransformationFromPhysicsBody(e){e.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.object.position.set(this._tmpAmmoTransform.getOrigin().x(),this._tmpAmmoTransform.getOrigin().y(),this._tmpAmmoTransform.getOrigin().z()),e.object.rotationQuaternion?e.object.rotationQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()):e.object.rotation&&(this._tmpQuaternion.set(this._tmpAmmoTransform.getRotation().x(),this._tmpAmmoTransform.getRotation().y(),this._tmpAmmoTransform.getRotation().z(),this._tmpAmmoTransform.getRotation().w()),this._tmpQuaternion.toEulerAnglesToRef(e.object.rotation))}setPhysicsBodyTransformation(e,t,i){const s=e.physicsBody.getWorldTransform();if(Math.abs(s.getOrigin().x()-t.x)>tt||Math.abs(s.getOrigin().y()-t.y)>tt||Math.abs(s.getOrigin().z()-t.z)>tt||Math.abs(s.getRotation().x()-i.x)>tt||Math.abs(s.getRotation().y()-i.y)>tt||Math.abs(s.getRotation().z()-i.z)>tt||Math.abs(s.getRotation().w()-i.w)>tt)if(this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),s.setOrigin(this._tmpAmmoVectorA),this._tmpAmmoQuaternion.setValue(i.x,i.y,i.z,i.w),s.setRotation(this._tmpAmmoQuaternion),e.physicsBody.setWorldTransform(s),e.mass==0){const r=e.physicsBody.getMotionState();r&&r.setWorldTransform(s)}else e.physicsBody.activate()}isSupported(){return this.bjsAMMO!==void 0}setLinearVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.linearVelocity(this._tmpAmmoVectorA):e.physicsBody.setLinearVelocity(this._tmpAmmoVectorA)}setAngularVelocity(e,t){this._tmpAmmoVectorA.setValue(t.x,t.y,t.z),e.soft?e.physicsBody.angularVelocity(this._tmpAmmoVectorA):e.physicsBody.setAngularVelocity(this._tmpAmmoVectorA)}getLinearVelocity(e){let t;if(e.soft?t=e.physicsBody.linearVelocity():t=e.physicsBody.getLinearVelocity(),!t)return null;const i=new g(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}getAngularVelocity(e){let t;if(e.soft?t=e.physicsBody.angularVelocity():t=e.physicsBody.getAngularVelocity(),!t)return null;const i=new g(t.x(),t.y(),t.z());return this.bjsAMMO.destroy(t),i}setBodyMass(e,t){e.soft?e.physicsBody.setTotalMass(t,!1):e.physicsBody.setMassProps(t),e._pluginData.mass=t}getBodyMass(e){return e._pluginData.mass||0}getBodyFriction(e){return e._pluginData.friction||0}setBodyFriction(e,t){e.soft?e.physicsBody.get_m_cfg().set_kDF(t):e.physicsBody.setFriction(t),e._pluginData.friction=t}getBodyRestitution(e){return e._pluginData.restitution||0}setBodyRestitution(e,t){e.physicsBody.setRestitution(t),e._pluginData.restitution=t}getBodyPressure(e){return e.soft?e._pluginData.pressure||0:(B.Warn("Pressure is not a property of a rigid body"),0)}setBodyPressure(e,t){e.soft?e.type===Oe.SoftbodyImpostor?(e.physicsBody.get_m_cfg().set_kPR(t),e._pluginData.pressure=t):(e.physicsBody.get_m_cfg().set_kPR(0),e._pluginData.pressure=0):B.Warn("Pressure can only be applied to a softbody")}getBodyStiffness(e){return e.soft?e._pluginData.stiffness||0:(B.Warn("Stiffness is not a property of a rigid body"),0)}setBodyStiffness(e,t){e.soft?(t=t<0?0:t,t=t>1?1:t,e.physicsBody.get_m_materials().at(0).set_m_kLST(t),e._pluginData.stiffness=t):B.Warn("Stiffness cannot be applied to a rigid body")}getBodyVelocityIterations(e){return e.soft?e._pluginData.velocityIterations||0:(B.Warn("Velocity iterations is not a property of a rigid body"),0)}setBodyVelocityIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_viterations(t),e._pluginData.velocityIterations=t):B.Warn("Velocity iterations cannot be applied to a rigid body")}getBodyPositionIterations(e){return e.soft?e._pluginData.positionIterations||0:(B.Warn("Position iterations is not a property of a rigid body"),0)}setBodyPositionIterations(e,t){e.soft?(t=t<0?0:t,e.physicsBody.get_m_cfg().set_piterations(t),e._pluginData.positionIterations=t):B.Warn("Position iterations cannot be applied to a rigid body")}appendAnchor(e,t,i,s,r=1,n=!1){const o=e.segments,l=Math.round((o-1)*i),h=Math.round((o-1)*s),c=o-1-h,u=l+o*c;e.physicsBody.appendAnchor(u,t.physicsBody,n,r)}appendHook(e,t,i,s=1,r=!1){const n=Math.round(e.segments*i);e.physicsBody.appendAnchor(n,t.physicsBody,r,s)}sleepBody(e){e.physicsBody.forceActivationState(0)}wakeUpBody(e){e.physicsBody.activate()}updateDistanceJoint(){B.Warn("updateDistanceJoint is not currently supported by the Ammo physics plugin")}setMotor(e,t,i){e.physicsJoint.enableAngularMotor(!0,t,i)}setLimit(){B.Warn("setLimit is not currently supported by the Ammo physics plugin")}syncMeshWithImpostor(e,t){t.physicsBody.getMotionState().getWorldTransform(this._tmpAmmoTransform),e.position.x=this._tmpAmmoTransform.getOrigin().x(),e.position.y=this._tmpAmmoTransform.getOrigin().y(),e.position.z=this._tmpAmmoTransform.getOrigin().z(),e.rotationQuaternion&&(e.rotationQuaternion.x=this._tmpAmmoTransform.getRotation().x(),e.rotationQuaternion.y=this._tmpAmmoTransform.getRotation().y(),e.rotationQuaternion.z=this._tmpAmmoTransform.getRotation().z(),e.rotationQuaternion.w=this._tmpAmmoTransform.getRotation().w())}getRadius(e){return e.getObjectExtents().x/2}getBoxSizeToRef(e,t){const i=e.getObjectExtents();t.x=i.x,t.y=i.y,t.z=i.z}dispose(){this.bjsAMMO.destroy(this.world),this.bjsAMMO.destroy(this._solver),this.bjsAMMO.destroy(this._overlappingPairCache),this.bjsAMMO.destroy(this._dispatcher),this.bjsAMMO.destroy(this._collisionConfiguration),this.bjsAMMO.destroy(this._tmpAmmoVectorA),this.bjsAMMO.destroy(this._tmpAmmoVectorB),this.bjsAMMO.destroy(this._tmpAmmoVectorC),this.bjsAMMO.destroy(this._tmpAmmoTransform),this.bjsAMMO.destroy(this._tmpAmmoQuaternion),this.bjsAMMO.destroy(this._tmpAmmoConcreteContactResultCallback),this.world=null}raycast(e,t){this._tmpAmmoVectorRCA=new this.bjsAMMO.btVector3(e.x,e.y,e.z),this._tmpAmmoVectorRCB=new this.bjsAMMO.btVector3(t.x,t.y,t.z);const i=new this.bjsAMMO.ClosestRayResultCallback(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB);return this.world.rayTest(this._tmpAmmoVectorRCA,this._tmpAmmoVectorRCB,i),this._raycastResult.reset(e,t),i.hasHit()&&(this._raycastResult.setHitData({x:i.get_m_hitNormalWorld().x(),y:i.get_m_hitNormalWorld().y(),z:i.get_m_hitNormalWorld().z()},{x:i.get_m_hitPointWorld().x(),y:i.get_m_hitPointWorld().y(),z:i.get_m_hitPointWorld().z()}),this._raycastResult.calculateHitDistance()),this.bjsAMMO.destroy(i),this.bjsAMMO.destroy(this._tmpAmmoVectorRCA),this.bjsAMMO.destroy(this._tmpAmmoVectorRCB),this._raycastResult}}zr._DISABLE_COLLISION_FLAG=4;zr._KINEMATIC_FLAG=2;zr._DISABLE_DEACTIVATION_FLAG=4;li.prototype.removeReflectionProbe=function(a){if(!this.reflectionProbes)return-1;const e=this.reflectionProbes.indexOf(a);return e!==-1&&this.reflectionProbes.splice(e,1),e};li.prototype.addReflectionProbe=function(a){this.reflectionProbes||(this.reflectionProbes=[]),this.reflectionProbes.push(a)};class th{constructor(e,t,i,s=!0,r=!1,n=!1){if(this.name=e,this._viewMatrix=L.Identity(),this._target=g.Zero(),this._add=g.Zero(),this._invertYAxis=!1,this.position=g.Zero(),this.metadata=null,this._parentContainer=null,this._scene=i,i.getEngine().supportsUniformBuffers){this._sceneUBOs=[];for(let c=0;c<6;++c)this._sceneUBOs.push(i.createSceneUniformBuffer(`Scene for Reflection Probe (name "${e}") face #${c}`))}this._scene.reflectionProbes||(this._scene.reflectionProbes=new Array),this._scene.reflectionProbes.push(this);let o=0;if(r){const c=this._scene.getEngine().getCaps();c.textureHalfFloatRender?o=2:c.textureFloatRender&&(o=1)}this._renderTargetTexture=new si(e,t,i,s,!0,o,!0),this._renderTargetTexture.gammaSpace=!n;const l=i.getEngine().useReverseDepthBuffer;this._renderTargetTexture.onBeforeRenderObservable.add(c=>{switch(this._sceneUBOs&&(i.setSceneUniformBuffer(this._sceneUBOs[c]),i.getSceneUniformBuffer().unbindEffect()),c){case 0:this._add.copyFromFloats(1,0,0);break;case 1:this._add.copyFromFloats(-1,0,0);break;case 2:this._add.copyFromFloats(0,this._invertYAxis?1:-1,0);break;case 3:this._add.copyFromFloats(0,this._invertYAxis?-1:1,0);break;case 4:this._add.copyFromFloats(0,0,i.useRightHandedSystem?-1:1);break;case 5:this._add.copyFromFloats(0,0,i.useRightHandedSystem?1:-1);break}this._attachedMesh&&this.position.copyFrom(this._attachedMesh.getAbsolutePosition()),this.position.addToRef(this._add,this._target);const u=i.useRightHandedSystem?L.LookAtRHToRef:L.LookAtLHToRef,d=i.useRightHandedSystem?L.PerspectiveFovRH:L.PerspectiveFovLH;u(this.position,this._target,g.Up(),this._viewMatrix),i.activeCamera&&(this._projectionMatrix=d(Math.PI/2,1,l?i.activeCamera.maxZ:i.activeCamera.minZ,l?i.activeCamera.minZ:i.activeCamera.maxZ,this._scene.getEngine().isNDCHalfZRange),i.setTransformMatrix(this._viewMatrix,this._projectionMatrix),i.activeCamera.isRigCamera&&!this._renderTargetTexture.activeCamera&&(this._renderTargetTexture.activeCamera=i.activeCamera.rigParent||null)),i._forcedViewPosition=this.position});let h;this._renderTargetTexture.onBeforeBindObservable.add(()=>{var c,u;this._currentSceneUBO=i.getSceneUniformBuffer(),(u=(c=i.getEngine())._debugPushGroup)===null||u===void 0||u.call(c,`reflection probe generation for ${e}`,1),h=this._scene.imageProcessingConfiguration.applyByPostProcess,n&&(i.imageProcessingConfiguration.applyByPostProcess=!0)}),this._renderTargetTexture.onAfterUnbindObservable.add(()=>{var c,u;i.imageProcessingConfiguration.applyByPostProcess=h,i._forcedViewPosition=null,this._sceneUBOs&&i.setSceneUniformBuffer(this._currentSceneUBO),i.updateTransformMatrix(!0),(u=(c=i.getEngine())._debugPopGroup)===null||u===void 0||u.call(c,1)})}get samples(){return this._renderTargetTexture.samples}set samples(e){this._renderTargetTexture.samples=e}get refreshRate(){return this._renderTargetTexture.refreshRate}set refreshRate(e){this._renderTargetTexture.refreshRate=e}getScene(){return this._scene}get cubeTexture(){return this._renderTargetTexture}get renderList(){return this._renderTargetTexture.renderList}attachToMesh(e){this._attachedMesh=e}setRenderingAutoClearDepthStencil(e,t){this._renderTargetTexture.setRenderingAutoClearDepthStencil(e,t)}dispose(){const e=this._scene.reflectionProbes.indexOf(this);if(e!==-1&&this._scene.reflectionProbes.splice(e,1),this._parentContainer){const t=this._parentContainer.reflectionProbes.indexOf(this);t>-1&&this._parentContainer.reflectionProbes.splice(t,1),this._parentContainer=null}if(this._renderTargetTexture&&(this._renderTargetTexture.dispose(),this._renderTargetTexture=null),this._sceneUBOs){for(const t of this._sceneUBOs)t.dispose();this._sceneUBOs=[]}}toString(e){let t="Name: "+this.name;return e&&(t+=", position: "+this.position.toString(),this._attachedMesh&&(t+=", attached mesh: "+this._attachedMesh.name)),t}getClassName(){return"ReflectionProbe"}serialize(){const e=xe.Serialize(this,this._renderTargetTexture.serialize());return e.isReflectionProbe=!0,e.metadata=this.metadata,e}static Parse(e,t,i){let s=null;if(t.reflectionProbes)for(let r=0;r<t.reflectionProbes.length;r++){const n=t.reflectionProbes[r];if(n.name===e.name){s=n;break}}return s=xe.Parse(()=>s||new th(e.name,e.renderTargetSize,t,e._generateMipMaps),e,t,i),s.cubeTexture._waitingRenderList=e.renderList,e._attachedMesh&&s.attachToMesh(t.getMeshById(e._attachedMesh)),e.metadata&&(s.metadata=e.metadata),s}}T([Xl()],th.prototype,"_attachedMesh",void 0);T([Zi()],th.prototype,"position",void 0);class wh{}wh.LoaderInjectedPhysicsEngine=void 0;let oo={},wa={};const ap=(a,e,t,i)=>{if(!e.materials)return null;for(let s=0,r=e.materials.length;s<r;s++){const n=e.materials[s];if(a(n))return{parsedMaterial:n,material:ne.Parse(n,t,i)}}return null},jA=(a,e,t)=>{for(const i in e)if(a.name===e[i])return t.push(a.id),!0;return a.parentId!==void 0&&t.indexOf(a.parentId)!==-1?(t.push(a.id),!0):!1},fo=(a,e)=>a+" of "+(e?e.file+" from "+e.name+" version: "+e.version+", exporter version: "+e.exporter_version:"unknown"),Sm=(a,e)=>{const t=e;if(e._waitingData.lods){if(e._waitingData.lods.ids&&e._waitingData.lods.ids.length>0){const i=e._waitingData.lods.ids,s=t.isEnabled(!1);if(e._waitingData.lods.distances){const r=e._waitingData.lods.distances;if(r.length>=i.length){const n=r.length>i.length?r[r.length-1]:0;t.setEnabled(!1);for(let o=0;o<i.length;o++){const l=i[o],h=a.getMeshById(l);h!=null&&t.addLODLevel(r[o],h)}n>0&&t.addLODLevel(n,null),s===!0&&t.setEnabled(!0)}else q.Warn("Invalid level of detail distances for "+e.name)}}e._waitingData.lods=null}},bh=(a,e,t)=>{if(typeof a!="number"){const s=t.getLastEntryById(a);return s&&e!==void 0&&e!==null?s.instances[parseInt(e)]:s}const i=oo[a];return i&&e!==void 0&&e!==null?i.instances[parseInt(e)]:i},tc=(a,e)=>typeof a!="number"?e.getLastMaterialById(a,!0):wa[a],op=(a,e,t,i,s=!1)=>{const r=new I_(a);let n="importScene has failed JSON parse";try{var o=JSON.parse(e);n="";const l=Be.loggingLevel===Be.DETAILED_LOGGING;let h,c;if(o.environmentTexture!==void 0&&o.environmentTexture!==null){const d=o.isPBR!==void 0?o.isPBR:!0;if(o.environmentTextureType&&o.environmentTextureType==="BABYLON.HDRCubeTexture"){const f=o.environmentTextureSize?o.environmentTextureSize:128,p=new Da((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,a,f,!0,!d,void 0,o.environmentTexturePrefilterOnLoad);o.environmentTextureRotationY&&(p.rotationY=o.environmentTextureRotationY),a.environmentTexture=p}else if(typeof o.environmentTexture=="object"){const f=Xi.Parse(o.environmentTexture,a,t);a.environmentTexture=f}else if(o.environmentTexture.endsWith(".env")){const f=new Xi((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,a,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(f.rotationY=o.environmentTextureRotationY),a.environmentTexture=f}else{const f=Xi.CreateFromPrefilteredData((o.environmentTexture.match(/https?:\/\//g)?"":t)+o.environmentTexture,a,o.environmentTextureForcedExtension);o.environmentTextureRotationY&&(f.rotationY=o.environmentTextureRotationY),a.environmentTexture=f}if(o.createDefaultSkybox===!0){const f=a.activeCamera!==void 0&&a.activeCamera!==null?(a.activeCamera.maxZ-a.activeCamera.minZ)/2:1e3,p=o.skyboxBlurLevel||0;a.createDefaultSkybox(a.environmentTexture,d,f,p)}r.environmentTexture=a.environmentTexture}if(o.environmentIntensity!==void 0&&o.environmentIntensity!==null&&(a.environmentIntensity=o.environmentIntensity),o.lights!==void 0&&o.lights!==null)for(h=0,c=o.lights.length;h<c;h++){const d=o.lights[h],f=je.Parse(d,a);f&&(oo[d.uniqueId]=f,r.lights.push(f),f._parentContainer=r,n+=h===0?`
	Lights:`:"",n+=`
		`+f.toString(l))}if(o.reflectionProbes!==void 0&&o.reflectionProbes!==null)for(h=0,c=o.reflectionProbes.length;h<c;h++){const d=o.reflectionProbes[h],f=th.Parse(d,a,t);f&&(r.reflectionProbes.push(f),f._parentContainer=r,n+=h===0?`
	Reflection Probes:`:"",n+=`
		`+f.toString(l))}if(o.animations!==void 0&&o.animations!==null)for(h=0,c=o.animations.length;h<c;h++){const d=o.animations[h],f=Si("BABYLON.Animation");if(f){const p=f.Parse(d);a.animations.push(p),r.animations.push(p),n+=h===0?`
	Animations:`:"",n+=`
		`+p.toString(l)}}if(o.materials!==void 0&&o.materials!==null)for(h=0,c=o.materials.length;h<c;h++){const d=o.materials[h],f=ne.Parse(d,a,t);f&&(wa[d.uniqueId||d.id]=f,r.materials.push(f),f._parentContainer=r,n+=h===0?`
	Materials:`:"",n+=`
		`+f.toString(l),f.getActiveTextures().forEach(_=>{r.textures.indexOf(_)==-1&&(r.textures.push(_),_._parentContainer=r)}))}if(o.multiMaterials!==void 0&&o.multiMaterials!==null)for(h=0,c=o.multiMaterials.length;h<c;h++){const d=o.multiMaterials[h],f=Jn.ParseMultiMaterial(d,a);wa[d.uniqueId||d.id]=f,r.multiMaterials.push(f),f._parentContainer=r,n+=h===0?`
	MultiMaterials:`:"",n+=`
		`+f.toString(l),f.getActiveTextures().forEach(_=>{r.textures.indexOf(_)==-1&&(r.textures.push(_),_._parentContainer=r)})}if(o.morphTargetManagers!==void 0&&o.morphTargetManagers!==null)for(const d of o.morphTargetManagers){const f=Oa.Parse(d,a);r.morphTargetManagers.push(f),f._parentContainer=r}if(o.skeletons!==void 0&&o.skeletons!==null)for(h=0,c=o.skeletons.length;h<c;h++){const d=o.skeletons[h],f=Pl.Parse(d,a);r.skeletons.push(f),f._parentContainer=r,n+=h===0?`
	Skeletons:`:"",n+=`
		`+f.toString(l)}const u=o.geometries;if(u!=null){const d=new Array,f=u.vertexData;if(f!=null)for(h=0,c=f.length;h<c;h++){const p=f[h];d.push(os.Parse(p,a,t))}d.forEach(p=>{p&&(r.geometries.push(p),p._parentContainer=r)})}if(o.transformNodes!==void 0&&o.transformNodes!==null)for(h=0,c=o.transformNodes.length;h<c;h++){const d=o.transformNodes[h],f=ke.Parse(d,a,t);oo[d.uniqueId]=f,r.transformNodes.push(f),f._parentContainer=r}if(o.meshes!==void 0&&o.meshes!==null)for(h=0,c=o.meshes.length;h<c;h++){const d=o.meshes[h],f=V.Parse(d,a,t);if(oo[d.uniqueId]=f,r.meshes.push(f),f._parentContainer=r,f.hasInstances)for(const p of f.instances)r.meshes.push(p),p._parentContainer=r;n+=h===0?`
	Meshes:`:"",n+=`
		`+f.toString(l)}if(o.cameras!==void 0&&o.cameras!==null)for(h=0,c=o.cameras.length;h<c;h++){const d=o.cameras[h],f=be.Parse(d,a);oo[d.uniqueId]=f,r.cameras.push(f),f._parentContainer=r,n+=h===0?`
	Cameras:`:"",n+=`
		`+f.toString(l)}if(o.postProcesses!==void 0&&o.postProcesses!==null)for(h=0,c=o.postProcesses.length;h<c;h++){const d=o.postProcesses[h],f=Fe.Parse(d,a,t);f&&(r.postProcesses.push(f),f._parentContainer=r,n+=h===0?`
Postprocesses:`:"",n+=`
		`+f.toString())}if(o.animationGroups!==void 0&&o.animationGroups!==null)for(h=0,c=o.animationGroups.length;h<c;h++){const d=o.animationGroups[h],f=Qh.Parse(d,a);r.animationGroups.push(f),f._parentContainer=r,n+=h===0?`
	AnimationGroups:`:"",n+=`
		`+f.toString(l)}for(h=0,c=a.cameras.length;h<c;h++){const d=a.cameras[h];d._waitingParentId!==null&&(d.parent=bh(d._waitingParentId,d._waitingParentInstanceIndex,a),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(h=0,c=a.lights.length;h<c;h++){const d=a.lights[h];d&&d._waitingParentId!==null&&(d.parent=bh(d._waitingParentId,d._waitingParentInstanceIndex,a),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(h=0,c=a.transformNodes.length;h<c;h++){const d=a.transformNodes[h];d._waitingParentId!==null&&(d.parent=bh(d._waitingParentId,d._waitingParentInstanceIndex,a),d._waitingParentId=null,d._waitingParentInstanceIndex=null)}for(h=0,c=a.meshes.length;h<c;h++){const d=a.meshes[h];d._waitingParentId!==null&&(d.parent=bh(d._waitingParentId,d._waitingParentInstanceIndex,a),d._waitingParentId=null,d._waitingParentInstanceIndex=null),d._waitingData.lods&&Sm(a,d)}for(a.multiMaterials.forEach(d=>{d._waitingSubMaterialsUniqueIds.forEach(f=>{d.subMaterials.push(tc(f,a))}),d._waitingSubMaterialsUniqueIds=[]}),a.meshes.forEach(d=>{d._waitingMaterialId!==null&&(d.material=tc(d._waitingMaterialId,a),d._waitingMaterialId=null)}),h=0,c=a.skeletons.length;h<c;h++){const d=a.skeletons[h];d._hasWaitingData&&(d.bones!=null&&d.bones.forEach(f=>{if(f._waitingTransformNodeId){const p=a.getLastEntryById(f._waitingTransformNodeId);p&&f.linkTransformNode(p),f._waitingTransformNodeId=null}}),d._hasWaitingData=null)}for(h=0,c=a.meshes.length;h<c;h++){const d=a.meshes[h];d._waitingData.freezeWorldMatrix?(d.freezeWorldMatrix(),d._waitingData.freezeWorldMatrix=null):d.computeWorldMatrix(!0)}for(h=0,c=a.lights.length;h<c;h++){const d=a.lights[h];if(d._excludedMeshesIds.length>0){for(let f=0;f<d._excludedMeshesIds.length;f++){const p=a.getMeshById(d._excludedMeshesIds[f]);p&&d.excludedMeshes.push(p)}d._excludedMeshesIds=[]}if(d._includedOnlyMeshesIds.length>0){for(let f=0;f<d._includedOnlyMeshesIds.length;f++){const p=a.getMeshById(d._includedOnlyMeshesIds[f]);p&&d.includedOnlyMeshes.push(p)}d._includedOnlyMeshesIds=[]}}for(a.geometries.forEach(d=>{d._loadedUniqueId=""}),li.Parse(o,a,r,t),h=0,c=a.meshes.length;h<c;h++){const d=a.meshes[h];d._waitingData.actions&&(mt.Parse(d._waitingData.actions,d,a),d._waitingData.actions=null)}o.actions!==void 0&&o.actions!==null&&mt.Parse(o.actions,null,a)}catch(l){const h=fo("loadAssets",o?o.producer:"Unknown")+n;if(i)i(h,l);else throw B.Log(h),l}finally{oo={},wa={},s||r.removeAllFromScene(),n!==null&&Be.loggingLevel!==Be.NO_LOGGING&&B.Log(fo("loadAssets",o?o.producer:"Unknown")+(Be.loggingLevel!==Be.MINIMAL_LOGGING?n:""))}return r};Be.RegisterPlugin({name:"babylon.js",extensions:".babylon",canDirectLoad:a=>a.indexOf("babylon")!==-1,importMesh:(a,e,t,i,s,r,n,o)=>{var l;let h="importMesh has failed JSON parse";try{var c=JSON.parse(t);h="";const u=Be.loggingLevel===Be.DETAILED_LOGGING;a?Array.isArray(a)||(a=[a]):a=null;const d=new Array,f=new Map,p=[];if(c.transformNodes!==void 0&&c.transformNodes!==null)for(let _=0,m=c.transformNodes.length;_<m;_++){const v=c.transformNodes[_],x=ke.Parse(v,e,i);p.push(x),f.set(x._waitingParsedUniqueId,x),x._waitingParsedUniqueId=null}if(c.meshes!==void 0&&c.meshes!==null){const _=[],m=[],v=[],x=[];for(let S=0,C=c.meshes.length;S<C;S++){const E=c.meshes[S];if(a===null||jA(E,a,d)){if(a!==null&&delete a[a.indexOf(E.name)],E.geometryId!==void 0&&E.geometryId!==null&&c.geometries!==void 0&&c.geometries!==null){let M=!1;["boxes","spheres","cylinders","toruses","grounds","planes","torusKnots","vertexData"].forEach(D=>{M===!0||!c.geometries[D]||!Array.isArray(c.geometries[D])||c.geometries[D].forEach(P=>{if(P.id===E.geometryId){switch(D){case"vertexData":os.Parse(P,e,i);break}M=!0}})}),M===!1&&B.Warn("Geometry not found for mesh "+E.id)}if(E.materialUniqueId||E.materialId){const M=E.materialUniqueId?v:m;let D=M.indexOf(E.materialUniqueId||E.materialId)!==-1;if(D===!1&&c.multiMaterials!==void 0&&c.multiMaterials!==null){const P=(O,N)=>{M.push(O);const $=ap(N,c,e,i);$&&$.material&&(wa[$.parsedMaterial.uniqueId||$.parsedMaterial.id]=$.material,h+=`
	Material `+$.material.toString(u))};for(let O=0,N=c.multiMaterials.length;O<N;O++){const $=c.multiMaterials[O];if(E.materialUniqueId&&$.uniqueId===E.materialUniqueId||$.id===E.materialId){$.materialsUniqueIds?$.materialsUniqueIds.forEach(K=>P(K,te=>te.uniqueId===K)):$.materials.forEach(K=>P(K,te=>te.id===K)),M.push($.uniqueId||$.id);const W=Jn.ParseMultiMaterial($,e);wa[$.uniqueId||$.id]=W,W&&(D=!0,h+=`
	Multi-Material `+W.toString(u));break}}}if(D===!1){M.push(E.materialUniqueId||E.materialId);const P=ap(O=>E.materialUniqueId&&O.uniqueId===E.materialUniqueId||O.id===E.materialId,c,e,i);!P||!P.material?B.Warn("Material not found for mesh "+E.id):(wa[P.parsedMaterial.uniqueId||P.parsedMaterial.id]=P.material,h+=`
	Material `+P.material.toString(u))}}if(E.skeletonId>-1&&c.skeletons!==void 0&&c.skeletons!==null&&!(_.indexOf(E.skeletonId)>-1))for(let D=0,P=c.skeletons.length;D<P;D++){const O=c.skeletons[D];if(O.id===E.skeletonId){const N=Pl.Parse(O,e);n.push(N),_.push(O.id),h+=`
	Skeleton `+N.toString(u)}}if(E.morphTargetManagerId>-1&&c.morphTargetManagers!==void 0&&c.morphTargetManagers!==null&&!(x.indexOf(E.morphTargetManagerId)>-1))for(let D=0,P=c.morphTargetManagers.length;D<P;D++){const O=c.morphTargetManagers[D];if(O.id===E.morphTargetManagerId){const N=Oa.Parse(O,e);x.push(N.uniqueId),h+=`
Morph target `+N.toString()}}const A=V.Parse(E,e,i);s.push(A),f.set(A._waitingParsedUniqueId,A),A._waitingParsedUniqueId=null,h+=`
	Mesh `+A.toString(u)}}e.multiMaterials.forEach(S=>{S._waitingSubMaterialsUniqueIds.forEach(C=>{S.subMaterials.push(tc(C,e))}),S._waitingSubMaterialsUniqueIds=[]}),e.meshes.forEach(S=>{S._waitingMaterialId!==null&&(S.material=tc(S._waitingMaterialId,e),S._waitingMaterialId=null)});for(let S=0,C=e.transformNodes.length;S<C;S++){const E=e.transformNodes[S];if(E._waitingParentId!==null){let A=f.get(parseInt(E._waitingParentId))||null;A===null&&(A=e.getLastEntryById(E._waitingParentId));let M=A;E._waitingParentInstanceIndex&&(M=A.instances[parseInt(E._waitingParentInstanceIndex)],E._waitingParentInstanceIndex=null),E.parent=M,E._waitingParentId=null}}let b;for(let S=0,C=e.meshes.length;S<C;S++){if(b=e.meshes[S],b._waitingParentId){let E=f.get(parseInt(b._waitingParentId))||null;E===null&&(E=e.getLastEntryById(b._waitingParentId));let A=E;if(b._waitingParentInstanceIndex&&(A=E.instances[parseInt(b._waitingParentInstanceIndex)],b._waitingParentInstanceIndex=null),b.parent=A,((l=b.parent)===null||l===void 0?void 0:l.getClassName())==="TransformNode"){const M=p.indexOf(b.parent);M>-1&&p.splice(M,1)}b._waitingParentId=null}b._waitingData.lods&&Sm(e,b)}for(const S of p)S.dispose();for(let S=0,C=e.skeletons.length;S<C;S++){const E=e.skeletons[S];E._hasWaitingData&&(E.bones!=null&&E.bones.forEach(A=>{if(A._waitingTransformNodeId){const M=e.getLastEntryById(A._waitingTransformNodeId);M&&A.linkTransformNode(M),A._waitingTransformNodeId=null}}),E._hasWaitingData=null)}for(let S=0,C=e.meshes.length;S<C;S++)b=e.meshes[S],b._waitingData.freezeWorldMatrix?(b.freezeWorldMatrix(),b._waitingData.freezeWorldMatrix=null):b.computeWorldMatrix(!0)}if(c.particleSystems!==void 0&&c.particleSystems!==null){const _=li.GetIndividualParser(ue.NAME_PARTICLESYSTEM);if(_)for(let m=0,v=c.particleSystems.length;m<v;m++){const x=c.particleSystems[m];d.indexOf(x.emitterId)!==-1&&r.push(_(x,e,i))}}return!0}catch(u){const d=fo("importMesh",c?c.producer:"Unknown")+h;if(o)o(d,u);else throw B.Log(d),u}finally{h!==null&&Be.loggingLevel!==Be.NO_LOGGING&&B.Log(fo("importMesh",c?c.producer:"Unknown")+(Be.loggingLevel!==Be.MINIMAL_LOGGING?h:""))}return!1},load:(a,e,t,i)=>{let s="importScene has failed JSON parse";try{var r=JSON.parse(e);if(s="",r.useDelayedTextureLoading!==void 0&&r.useDelayedTextureLoading!==null&&(a.useDelayedTextureLoading=r.useDelayedTextureLoading&&!Be.ForceFullSceneLoadingForIncremental),r.autoClear!==void 0&&r.autoClear!==null&&(a.autoClear=r.autoClear),r.clearColor!==void 0&&r.clearColor!==null&&(a.clearColor=J.FromArray(r.clearColor)),r.ambientColor!==void 0&&r.ambientColor!==null&&(a.ambientColor=re.FromArray(r.ambientColor)),r.gravity!==void 0&&r.gravity!==null&&(a.gravity=g.FromArray(r.gravity)),r.useRightHandedSystem!==void 0&&(a.useRightHandedSystem=!!r.useRightHandedSystem),r.fogMode&&r.fogMode!==0)switch(a.fogMode=r.fogMode,a.fogColor=re.FromArray(r.fogColor),a.fogStart=r.fogStart,a.fogEnd=r.fogEnd,a.fogDensity=r.fogDensity,s+="	Fog mode for scene:  ",a.fogMode){case 1:s+=`exp
`;break;case 2:s+=`exp2
`;break;case 3:s+=`linear
`;break}if(r.physicsEnabled){let o;r.physicsEngine==="cannon"||r.physicsEngine===ad.name?o=new ad(void 0,void 0,wh.LoaderInjectedPhysicsEngine):r.physicsEngine==="oimo"||r.physicsEngine===np.name?o=new np(void 0,wh.LoaderInjectedPhysicsEngine):(r.physicsEngine==="ammo"||r.physicsEngine===zr.name)&&(o=new zr(void 0,wh.LoaderInjectedPhysicsEngine,void 0)),s="	Physics engine "+(r.physicsEngine?r.physicsEngine:"oimo")+` enabled
`;const l=r.physicsGravity?g.FromArray(r.physicsGravity):null;a.enablePhysics(l,o)}return r.metadata!==void 0&&r.metadata!==null&&(a.metadata=r.metadata),r.collisionsEnabled!==void 0&&r.collisionsEnabled!==null&&(a.collisionsEnabled=r.collisionsEnabled),op(a,e,t,i,!0)?(r.autoAnimate&&a.beginAnimation(a,r.autoAnimateFrom,r.autoAnimateTo,r.autoAnimateLoop,r.autoAnimateSpeed||1),r.activeCameraID!==void 0&&r.activeCameraID!==null&&a.setActiveCameraById(r.activeCameraID),!0):!1}catch(n){const o=fo("importScene",r?r.producer:"Unknown")+s;if(i)i(o,n);else throw B.Log(o),n}finally{s!==null&&Be.loggingLevel!==Be.NO_LOGGING&&B.Log(fo("importScene",r?r.producer:"Unknown")+(Be.loggingLevel!==Be.MINIMAL_LOGGING?s:""))}return!1},loadAssetContainer:(a,e,t,i)=>op(a,e,t,i)});class ic{constructor(e={}){this._isEnabled=!0,this.bias=e.bias===void 0?0:e.bias,this.power=e.power===void 0?1:e.power,this.leftColor=e.leftColor||re.White(),this.rightColor=e.rightColor||re.Black(),e.isEnabled===!1&&(this.isEnabled=!1)}get isEnabled(){return this._isEnabled}set isEnabled(e){this._isEnabled!==e&&(this._isEnabled=e,k.MarkAllMaterialsAsDirty(20))}clone(){const e=new ic;return ys.DeepCopy(this,e),e}equals(e){return e&&this.bias===e.bias&&this.power===e.power&&this.leftColor.equals(e.leftColor)&&this.rightColor.equals(e.rightColor)&&this.isEnabled===e.isEnabled}serialize(){return{isEnabled:this.isEnabled,leftColor:this.leftColor.asArray(),rightColor:this.rightColor.asArray(),bias:this.bias,power:this.power}}static Parse(e){return new ic({isEnabled:e.isEnabled,leftColor:re.FromArray(e.leftColor),rightColor:re.FromArray(e.rightColor),bias:e.bias,power:e.power||1})}}xe._FresnelParametersParser=ic.Parse;class As extends vt{constructor(e,t){super(e,t),this.maxSimultaneousLights=4,this.disableLighting=!1,this.invertNormalMapX=!1,this.invertNormalMapY=!1,this.emissiveColor=new re(0,0,0),this.occlusionStrength=1,this.useLightmapAsShadowmap=!1,this._useAlphaFromAlbedoTexture=!0,this._useAmbientInGrayScale=!0}get doubleSided(){return this._twoSidedLighting}set doubleSided(e){this._twoSidedLighting!==e&&(this._twoSidedLighting=e,this.backFaceCulling=!e,this._markAllSubMeshesAsTexturesDirty())}getClassName(){return"PBRBaseSimpleMaterial"}}T([R(),ie("_markAllSubMeshesAsLightsDirty")],As.prototype,"maxSimultaneousLights",void 0);T([R(),ie("_markAllSubMeshesAsLightsDirty")],As.prototype,"disableLighting",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_reflectionTexture")],As.prototype,"environmentTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],As.prototype,"invertNormalMapX",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],As.prototype,"invertNormalMapY",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_bumpTexture")],As.prototype,"normalTexture",void 0);T([pi("emissive"),ie("_markAllSubMeshesAsTexturesDirty")],As.prototype,"emissiveColor",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty")],As.prototype,"emissiveTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty","_ambientTextureStrength")],As.prototype,"occlusionStrength",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_ambientTexture")],As.prototype,"occlusionTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty","_alphaCutOff")],As.prototype,"alphaCutOff",void 0);T([R()],As.prototype,"doubleSided",null);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty",null)],As.prototype,"lightmapTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],As.prototype,"useLightmapAsShadowmap",void 0);class xn extends As{constructor(e,t){super(e,t),this._useRoughnessFromMetallicTextureAlpha=!1,this._useRoughnessFromMetallicTextureGreen=!0,this._useMetallnessFromMetallicTextureBlue=!0,this.metallic=1,this.roughness=1}getClassName(){return"PBRMetallicRoughnessMaterial"}clone(e){const t=xe.Clone(()=>new xn(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=xe.Serialize(this);return e.customType="BABYLON.PBRMetallicRoughnessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=xe.Parse(()=>new xn(e.name,t),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}T([pi(),ie("_markAllSubMeshesAsTexturesDirty","_albedoColor")],xn.prototype,"baseColor",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],xn.prototype,"baseTexture",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"metallic",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty")],xn.prototype,"roughness",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_metallicTexture")],xn.prototype,"metallicRoughnessTexture",void 0);he("BABYLON.PBRMetallicRoughnessMaterial",xn);class Tn extends As{constructor(e,t){super(e,t),this._useMicroSurfaceFromReflectivityMapAlpha=!0}get useMicroSurfaceFromReflectivityMapAlpha(){return this._useMicroSurfaceFromReflectivityMapAlpha}getClassName(){return"PBRSpecularGlossinessMaterial"}clone(e){const t=xe.Clone(()=>new Tn(e,this.getScene()),this);return t.id=e,t.name=e,this.clearCoat.copyTo(t.clearCoat),this.anisotropy.copyTo(t.anisotropy),this.brdf.copyTo(t.brdf),this.sheen.copyTo(t.sheen),this.subSurface.copyTo(t.subSurface),t}serialize(){const e=xe.Serialize(this);return e.customType="BABYLON.PBRSpecularGlossinessMaterial",e.clearCoat=this.clearCoat.serialize(),e.anisotropy=this.anisotropy.serialize(),e.brdf=this.brdf.serialize(),e.sheen=this.sheen.serialize(),e.subSurface=this.subSurface.serialize(),e.iridescence=this.iridescence.serialize(),e}static Parse(e,t,i){const s=xe.Parse(()=>new Tn(e.name,t),e,t,i);return e.clearCoat&&s.clearCoat.parse(e.clearCoat,t,i),e.anisotropy&&s.anisotropy.parse(e.anisotropy,t,i),e.brdf&&s.brdf.parse(e.brdf,t,i),e.sheen&&s.sheen.parse(e.sheen,t,i),e.subSurface&&s.subSurface.parse(e.subSurface,t,i),e.iridescence&&s.iridescence.parse(e.iridescence,t,i),s}}T([pi("diffuse"),ie("_markAllSubMeshesAsTexturesDirty","_albedoColor")],Tn.prototype,"diffuseColor",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_albedoTexture")],Tn.prototype,"diffuseTexture",void 0);T([pi("specular"),ie("_markAllSubMeshesAsTexturesDirty","_reflectivityColor")],Tn.prototype,"specularColor",void 0);T([R(),ie("_markAllSubMeshesAsTexturesDirty","_microSurface")],Tn.prototype,"glossiness",void 0);T([Qe(),ie("_markAllSubMeshesAsTexturesDirty","_reflectivityTexture")],Tn.prototype,"specularGlossinessTexture",void 0);he("BABYLON.PBRSpecularGlossinessMaterial",Tn);class To extends dt{constructor(e,t,i=null){if(super(t),!!e)if(this._textureMatrix=L.Identity(),this.name=e,this.url=e,this._onLoad=i,this._texture=this._getFromCache(e,!0),this._texture)this._triggerOnLoad();else{const s=this.getScene();s?s.useDelayedTextureLoading?this.delayLoadState=4:this._loadTexture():this._loadTexture()}}_triggerOnLoad(){this._onLoad&&this._onLoad()}getTextureMatrix(){return this._textureMatrix}_load3dlTexture(){const e=this._getEngine();let t;e._features.support3DTextures?t=e.createRawTexture3D(null,1,1,1,5,!1,!1,2,null,0):t=e.createRawTexture(null,1,1,5,!1,!1,2,null,0),this._texture=t,this._texture.isReady=!1,this.isCube=!1,this.is3D=e._features.support3DTextures,this.wrapU=0,this.wrapV=0,this.wrapR=0,this.anisotropicFilteringLevel=1;const i=r=>{if(typeof r!="string")return;let n=null,o=null,l;const h=r.split(`
`);let c=0,u=0,d=0,f=0,p=0;for(let _=0;_<h.length;_++){if(l=h[_],!To._NoneEmptyLineRegex.test(l)||l.indexOf("#")===0)continue;const m=l.split(" ");if(c===0){c=m.length,n=new Uint8Array(c*c*c*4),o=new Float32Array(c*c*c*4);continue}if(c!=0){const v=Math.max(parseInt(m[0]),0),x=Math.max(parseInt(m[1]),0),b=Math.max(parseInt(m[2]),0);p=Math.max(v,p),p=Math.max(x,p),p=Math.max(b,p);const S=(u+f*c+d*c*c)*4;o&&(o[S+0]=v,o[S+1]=x,o[S+2]=b),d++,d%c==0&&(f++,d=0,f%c==0&&(u++,f=0))}}if(o&&n)for(let _=0;_<o.length;_++)if(_>0&&(_+1)%4===0)n[_]=255;else{const m=o[_];n[_]=m/p*255}t.is3D?(t.updateSize(c,c,c),e.updateRawTexture3D(t,n,5,!1)):(t.updateSize(c*c,c),e.updateRawTexture(t,n,5,!1)),t.isReady=!0,this._triggerOnLoad()},s=this.getScene();return s?s._loadFile(this.url,i):e._loadFile(this.url,i),this._texture}_loadTexture(){this.url&&this.url.toLocaleLowerCase().indexOf(".3dl")==this.url.length-4&&this._load3dlTexture()}clone(){const e=new To(this.url,this.getScene()||this._getEngine());return e.level=this.level,e}delayLoad(){this.delayLoadState===4&&(this.delayLoadState=1,this._texture=this._getFromCache(this.url,!0),this._texture||this._loadTexture())}static Parse(e,t){let i=null;return e.name&&!e.isRenderTarget&&(i=new To(e.name,t),i.name=e.name,i.level=e.level),i}serialize(){if(!this.name)return null;const e={};return e.name=this.name,e.level=this.level,e.customType="BABYLON.ColorGradingTexture",e}}To._NoneEmptyLineRegex=/\S+/;he("BABYLON.ColorGradingTexture",To);class sc extends dt{constructor(e,t,i,s=!1,r=!0,n=null,o=null){if(super(t),this._onLoad=null,this._onError=null,!e)throw new Error("Image url is not set");this._coordinatesMode=H.CUBIC_MODE,this.name=e,this.url=e,this._size=i,this._noMipmap=s,this.gammaSpace=r,this._onLoad=n,this._onError=o,this.hasAlpha=!1,this.isCube=!0,this._texture=this._getFromCache(e,this._noMipmap,void 0,void 0,void 0,this.isCube),this._texture?n&&(this._texture.isReady?q.SetImmediate(()=>n()):this._texture.onLoadedObservable.add(n)):t.useDelayedTextureLoading?this.delayLoadState=4:this._loadImage(this._loadTexture.bind(this),this._onError)}_loadImage(e,t){const i=document.createElement("canvas");Wl(this.url,s=>{this._width=s.width,this._height=s.height,i.width=this._width,i.height=this._height;const r=i.getContext("2d");r.drawImage(s,0,0);const n=r.getImageData(0,0,s.width,s.height);this._buffer=n.data.buffer,i.remove(),e()},(s,r)=>{t&&t(`${this.getClassName()} could not be loaded`,r)},null)}_loadTexture(){const e=this.getScene(),t=()=>{const i=this._getFloat32ArrayFromArrayBuffer(this._buffer),s=ua.ConvertPanoramaToCubemap(i,this._width,this._height,this._size),r=[];for(let n=0;n<6;n++){const o=s[sc._FacesMapping[n]];r.push(o)}return r};!e||(this._texture=e.getEngine().createRawCubeTextureFromUrl(this.url,e,this._size,4,e.getEngine().getCaps().textureFloat?1:7,this._noMipmap,t,null,this._onLoad,this._onError))}_getFloat32ArrayFromArrayBuffer(e){const t=new DataView(e),i=new Float32Array(e.byteLength*3/4);let s=0;for(let r=0;r<e.byteLength;r++)(r+1)%4!==0&&(i[s++]=t.getUint8(r)/255);return i}getClassName(){return"EquiRectangularCubeTexture"}clone(){const e=this.getScene();if(!e)return this;const t=new sc(this.url,e,this._size,this._noMipmap,this.gammaSpace);return t.level=this.level,t.wrapU=this.wrapU,t.wrapV=this.wrapV,t.coordinatesIndex=this.coordinatesIndex,t.coordinatesMode=this.coordinatesMode,t}}sc._FacesMapping=["right","left","up","down","front","back"];class d0 extends dt{constructor(e,t,i){super(i.scene||i.engine),this.onLoadObservable=new X,!(!t||!i.engine&&!i.scene)&&(i={...d0._DefaultOptions,...i},this._generateMipMaps=i.generateMipMaps,this._samplingMode=i.samplingMode,this._textureMatrix=L.Identity(),this.name=e,this.element=t,this._isVideo=t instanceof HTMLVideoElement,this.anisotropicFilteringLevel=1,this._createInternalTexture())}_createInternalTexture(){let e=0,t=0;this._isVideo?(e=this.element.videoWidth,t=this.element.videoHeight):(e=this.element.width,t=this.element.height);const i=this._getEngine();i&&(this._texture=i.createDynamicTexture(e,t,this._generateMipMaps,this._samplingMode)),this.update()}getTextureMatrix(){return this._textureMatrix}update(e=null){const t=this._getEngine();if(this._texture==null||t==null)return;const i=this.isReady();if(this._isVideo){const s=this.element;if(s.readyState<s.HAVE_CURRENT_DATA)return;t.updateVideoTexture(this._texture,s,e===null?!0:e)}else{const s=this.element;t.updateDynamicTexture(this._texture,s,e===null?!0:e,!1)}!i&&this.isReady()&&this.onLoadObservable.notifyObservers(this)}dispose(){this.onLoadObservable.clear(),super.dispose()}}d0._DefaultOptions={generateMipMaps:!1,samplingMode:2,engine:null,scene:null};const qA=1,QA=2,ZA=3,JA=9,eR=10,tR=11,iR=48,sR=4,rR=0,nR=1,aR=2,oR=3;function eu(a){let e=0;return{id_length:a[e++],colormap_type:a[e++],image_type:a[e++],colormap_index:a[e++]|a[e++]<<8,colormap_length:a[e++]|a[e++]<<8,colormap_size:a[e++],origin:[a[e++]|a[e++]<<8,a[e++]|a[e++]<<8],width:a[e++]|a[e++]<<8,height:a[e++]|a[e++]<<8,pixel_size:a[e++],flags:a[e++]}}function Em(a,e){if(e.length<19){B.Error("Unable to load TGA file - Not enough data to contain header");return}let t=18;const i=eu(e);if(i.id_length+t>e.length){B.Error("Unable to load TGA file - Not enough data");return}t+=i.id_length;let s=!1,r=!1,n=!1;switch(i.image_type){case JA:s=!0;case qA:r=!0;break;case eR:s=!0;case QA:break;case tR:s=!0;case ZA:n=!0;break}let o;const l=i.pixel_size>>3,h=i.width*i.height*l;let c;if(r&&(c=e.subarray(t,t+=i.colormap_length*(i.colormap_size>>3))),s){o=new Uint8Array(h);let S,C,E,A=0;const M=new Uint8Array(l);for(;t<h&&A<h;)if(S=e[t++],C=(S&127)+1,S&128){for(E=0;E<l;++E)M[E]=e[t++];for(E=0;E<C;++E)o.set(M,A+E*l);A+=l*C}else{for(C*=l,E=0;E<C;++E)o[A+E]=e[t++];A+=C}}else o=e.subarray(t,t+=r?i.width*i.height:h);let u,d,f,p,_,m;switch((i.flags&iR)>>sR){default:case aR:u=0,f=1,m=i.width,d=0,p=1,_=i.height;break;case rR:u=0,f=1,m=i.width,d=i.height-1,p=-1,_=-1;break;case oR:u=i.width-1,f=-1,m=-1,d=0,p=1,_=i.height;break;case nR:u=i.width-1,f=-1,m=-1,d=i.height-1,p=-1,_=-1;break}const v="_getImageData"+(n?"Grey":"")+i.pixel_size+"bits",x=pR[v](i,c,o,d,p,_,u,f,m);a.getEngine()._uploadDataToTextureDirectly(a,x)}function lR(a,e,t,i,s,r,n,o,l){const h=t,c=e,u=a.width,d=a.height;let f,p=0,_,m;const v=new Uint8Array(u*d*4);for(m=i;m!==r;m+=s)for(_=n;_!==l;_+=o,p++)f=h[p],v[(_+u*m)*4+3]=255,v[(_+u*m)*4+2]=c[f*3+0],v[(_+u*m)*4+1]=c[f*3+1],v[(_+u*m)*4+0]=c[f*3+2];return v}function hR(a,e,t,i,s,r,n,o,l){const h=t,c=a.width,u=a.height;let d,f=0,p,_;const m=new Uint8Array(c*u*4);for(_=i;_!==r;_+=s)for(p=n;p!==l;p+=o,f+=2){d=h[f+0]+(h[f+1]<<8);const v=((d&31744)>>10)*255/31|0,x=((d&992)>>5)*255/31|0,b=(d&31)*255/31|0;m[(p+c*_)*4+0]=v,m[(p+c*_)*4+1]=x,m[(p+c*_)*4+2]=b,m[(p+c*_)*4+3]=d&32768?0:255}return m}function cR(a,e,t,i,s,r,n,o,l){const h=t,c=a.width,u=a.height;let d=0,f,p;const _=new Uint8Array(c*u*4);for(p=i;p!==r;p+=s)for(f=n;f!==l;f+=o,d+=3)_[(f+c*p)*4+3]=255,_[(f+c*p)*4+2]=h[d+0],_[(f+c*p)*4+1]=h[d+1],_[(f+c*p)*4+0]=h[d+2];return _}function uR(a,e,t,i,s,r,n,o,l){const h=t,c=a.width,u=a.height;let d=0,f,p;const _=new Uint8Array(c*u*4);for(p=i;p!==r;p+=s)for(f=n;f!==l;f+=o,d+=4)_[(f+c*p)*4+2]=h[d+0],_[(f+c*p)*4+1]=h[d+1],_[(f+c*p)*4+0]=h[d+2],_[(f+c*p)*4+3]=h[d+3];return _}function dR(a,e,t,i,s,r,n,o,l){const h=t,c=a.width,u=a.height;let d,f=0,p,_;const m=new Uint8Array(c*u*4);for(_=i;_!==r;_+=s)for(p=n;p!==l;p+=o,f++)d=h[f],m[(p+c*_)*4+0]=d,m[(p+c*_)*4+1]=d,m[(p+c*_)*4+2]=d,m[(p+c*_)*4+3]=255;return m}function fR(a,e,t,i,s,r,n,o,l){const h=t,c=a.width,u=a.height;let d=0,f,p;const _=new Uint8Array(c*u*4);for(p=i;p!==r;p+=s)for(f=n;f!==l;f+=o,d+=2)_[(f+c*p)*4+0]=h[d+0],_[(f+c*p)*4+1]=h[d+0],_[(f+c*p)*4+2]=h[d+0],_[(f+c*p)*4+3]=h[d+1];return _}const pR={GetTGAHeader:eu,UploadContent:Em,_getImageData8bits:lR,_getImageData16bits:hR,_getImageData24bits:cR,_getImageData32bits:uR,_getImageDataGrey8bits:dR,_getImageDataGrey16bits:fR};class _R{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".tga")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=eu(s);i(r.width,r.height,t.generateMipMaps,!1,()=>{Em(t,s)})}}k._TextureLoaders.push(new _R);class mR{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".hdr")}loadCubeData(){throw".env not supported in Cube."}loadData(e,t,i){const s=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),r=nd.RGBE_ReadHeader(s),n=nd.RGBE_ReadPixels(s,r),o=r.width*r.height,l=new Float32Array(o*4);for(let h=0;h<o;h+=1)l[h*4]=n[h*3],l[h*4+1]=n[h*3+1],l[h*4+2]=n[h*3+2],l[h*4+3]=1;i(r.width,r.height,t.generateMipMaps,!1,()=>{const h=t.getEngine();t.type=1,t.format=5,t._gammaSpace=!1,h._uploadDataToTextureDirectly(t,l)})}}k._TextureLoaders.push(new mR);var un;(function(a){a[a.cTFETC1=0]="cTFETC1",a[a.cTFETC2=1]="cTFETC2",a[a.cTFBC1=2]="cTFBC1",a[a.cTFBC3=3]="cTFBC3",a[a.cTFBC4=4]="cTFBC4",a[a.cTFBC5=5]="cTFBC5",a[a.cTFBC7=6]="cTFBC7",a[a.cTFPVRTC1_4_RGB=8]="cTFPVRTC1_4_RGB",a[a.cTFPVRTC1_4_RGBA=9]="cTFPVRTC1_4_RGBA",a[a.cTFASTC_4x4=10]="cTFASTC_4x4",a[a.cTFATC_RGB=11]="cTFATC_RGB",a[a.cTFATC_RGBA_INTERPOLATED_ALPHA=12]="cTFATC_RGBA_INTERPOLATED_ALPHA",a[a.cTFRGBA32=13]="cTFRGBA32",a[a.cTFRGB565=14]="cTFRGB565",a[a.cTFBGR565=15]="cTFBGR565",a[a.cTFRGBA4444=16]="cTFRGBA4444",a[a.cTFFXT1_RGB=17]="cTFFXT1_RGB",a[a.cTFPVRTC2_4_RGB=18]="cTFPVRTC2_4_RGB",a[a.cTFPVRTC2_4_RGBA=19]="cTFPVRTC2_4_RGBA",a[a.cTFETC2_EAC_R11=20]="cTFETC2_EAC_R11",a[a.cTFETC2_EAC_RG11=21]="cTFETC2_EAC_RG11"})(un||(un={}));const la={JSModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.js",WasmModuleURL:"https://cdn.babylonjs.com/basisTranscoder/1/basis_transcoder.wasm"},gR=(a,e)=>{let t;switch(a){case un.cTFETC1:t=36196;break;case un.cTFBC1:t=33776;break;case un.cTFBC4:t=33779;break;case un.cTFASTC_4x4:t=37808;break;case un.cTFETC2:t=37496;break;case un.cTFBC7:t=36492;break}if(t===void 0)throw"The chosen Basis transcoder format is not currently supported";return t};let Fu=null,Vr=null,vR=0;const xR=!1,TR=()=>(Fu||(Fu=new Promise((a,e)=>{Vr?a(Vr):q.LoadFileAsync(la.WasmModuleURL).then(t=>{if(typeof URL!="function")return e("Basis transcoder requires an environment with a URL constructor");const i=URL.createObjectURL(new Blob([`(${bR})()`],{type:"application/javascript"}));Vr=new Worker(i);const s=r=>{r.data.action==="init"?(Vr.removeEventListener("message",s),a(Vr)):r.data.action==="error"&&e(r.data.error||"error initializing worker")};Vr.addEventListener("message",s),Vr.postMessage({action:"init",url:la.JSModuleURL,wasmBinary:t})}).catch(e)})),Fu),od=(a,e)=>{const t=a instanceof ArrayBuffer?new Uint8Array(a):a;return new Promise((i,s)=>{TR().then(()=>{const r=vR++,n=l=>{l.data.action==="transcode"&&l.data.id===r&&(Vr.removeEventListener("message",n),l.data.success?i(l.data):s("Transcode is not supported on this device"))};Vr.addEventListener("message",n);const o=new Uint8Array(t.byteLength);o.set(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),Vr.postMessage({action:"transcode",id:r,imageData:o,config:e,ignoreSupportedFormats:xR},[o.buffer])},r=>{s(r)})})},Sh=(a,e)=>{let t=e._gl.TEXTURE_2D;a.isCube&&(t=e._gl.TEXTURE_CUBE_MAP),e._bindTextureDirectly(t,a,!0)},ld=(a,e)=>{const t=a.getEngine();for(let i=0;i<e.fileInfo.images.length;i++){const s=e.fileInfo.images[i].levels[0];if(a._invertVScale=a.invertY,e.format===-1||e.format===un.cTFRGB565)if(a.type=10,a.format=4,t._features.basisNeedsPOT&&(oe.Log2(s.width)%1!==0||oe.Log2(s.height)%1!==0)){const r=new gt(t,We.Temp);a._invertVScale=a.invertY,r.type=10,r.format=4,r.width=s.width+3&-4,r.height=s.height+3&-4,Sh(r,t),t._uploadDataToTextureDirectly(r,new Uint16Array(s.transcodedPixels.buffer),i,0,4,!0),t._rescaleTexture(r,a,t.scenes[0],t._getInternalFormat(4),()=>{t._releaseTexture(r),Sh(a,t)})}else a._invertVScale=!a.invertY,a.width=s.width+3&-4,a.height=s.height+3&-4,a.samplingMode=2,Sh(a,t),t._uploadDataToTextureDirectly(a,new Uint16Array(s.transcodedPixels.buffer),i,0,4,!0);else{a.width=s.width,a.height=s.height,a.generateMipMaps=e.fileInfo.images[i].levels.length>1;const r=f0.GetInternalFormatFromBasisFormat(e.format,t);a.format=r,Sh(a,t),e.fileInfo.images[i].levels.forEach((n,o)=>{t._uploadCompressedDataToTextureDirectly(a,r,n.width,n.height,n.transcodedPixels,i,o)}),t._features.basisNeedsPOT&&(oe.Log2(a.width)%1!==0||oe.Log2(a.height)%1!==0)&&(q.Warn("Loaded .basis texture width and height are not a power of two. Texture wrapping will be set to Texture.CLAMP_ADDRESSMODE as other modes are not supported with non power of two dimensions in webGL 1."),a._cachedWrapU=H.CLAMP_ADDRESSMODE,a._cachedWrapV=H.CLAMP_ADDRESSMODE)}}},f0={JSModuleURL:la.JSModuleURL,WasmModuleURL:la.WasmModuleURL,GetInternalFormatFromBasisFormat:gR,TranscodeAsync:od,LoadTextureFromTranscodeResult:ld};function bR(){const a={cTFETC1:0,cTFETC2:1,cTFBC1:2,cTFBC3:3,cTFBC4:4,cTFBC5:5,cTFBC7:6,cTFPVRTC1_4_RGB:8,cTFPVRTC1_4_RGBA:9,cTFASTC_4x4:10,cTFATC_RGB:11,cTFATC_RGBA_INTERPOLATED_ALPHA:12,cTFRGBA32:13,cTFRGB565:14,cTFBGR565:15,cTFRGBA4444:16,cTFFXT1_RGB:17,cTFPVRTC2_4_RGB:18,cTFPVRTC2_4_RGBA:19,cTFETC2_EAC_R11:20,cTFETC2_EAC_RG11:21};let e=null;onmessage=n=>{if(n.data.action==="init"){if(!e){try{importScripts(n.data.url)}catch(o){postMessage({action:"error",error:o})}e=BASIS({wasmBinary:n.data.wasmBinary})}e!==null&&e.then(o=>{BASIS=o,o.initializeBasis(),postMessage({action:"init"})})}else if(n.data.action==="transcode"){const o=n.data.config,l=n.data.imageData,h=new BASIS.BasisFile(l),c=i(h);let u=n.data.ignoreSupportedFormats?null:t(n.data.config,c),d=!1;u===null&&(d=!0,u=c.hasAlpha?a.cTFBC3:a.cTFBC1);let f=!0;h.startTranscoding()||(f=!1);const p=[];for(let _=0;_<c.images.length&&f;_++){const m=c.images[_];if(o.loadSingleImage===void 0||o.loadSingleImage===_){let v=m.levels.length;o.loadMipmapLevels===!1&&(v=1);for(let x=0;x<v;x++){const b=m.levels[x],S=s(h,_,x,u,d);if(!S){f=!1;break}b.transcodedPixels=S,p.push(b.transcodedPixels.buffer)}}}h.close(),h.delete(),d&&(u=-1),f?postMessage({action:"transcode",success:f,id:n.data.id,fileInfo:c,format:u},p):postMessage({action:"transcode",success:f,id:n.data.id})}};function t(n,o){let l=null;return n.supportedCompressionFormats&&(n.supportedCompressionFormats.astc?l=a.cTFASTC_4x4:n.supportedCompressionFormats.bc7?l=a.cTFBC7:n.supportedCompressionFormats.s3tc?l=o.hasAlpha?a.cTFBC3:a.cTFBC1:n.supportedCompressionFormats.pvrtc?l=o.hasAlpha?a.cTFPVRTC1_4_RGBA:a.cTFPVRTC1_4_RGB:n.supportedCompressionFormats.etc2?l=a.cTFETC2:n.supportedCompressionFormats.etc1?l=a.cTFETC1:l=a.cTFRGB565),l}function i(n){const o=n.getHasAlpha(),l=n.getNumImages(),h=[];for(let u=0;u<l;u++){const d={levels:[]},f=n.getNumLevels(u);for(let p=0;p<f;p++){const _={width:n.getImageWidth(u,p),height:n.getImageHeight(u,p)};d.levels.push(_)}h.push(d)}return{hasAlpha:o,images:h}}function s(n,o,l,h,c){const u=n.getImageTranscodedSizeInBytes(o,l,h);let d=new Uint8Array(u);if(!n.transcodeImage(d,o,l,h,1,0))return null;if(c){const f=n.getImageWidth(o,l)+3&-4,p=n.getImageHeight(o,l)+3&-4;d=r(d,0,f,p)}return d}function r(n,o,l,h){const c=new Uint16Array(4),u=new Uint16Array(l*h),d=l/4,f=h/4;for(let p=0;p<f;p++)for(let _=0;_<d;_++){const m=o+8*(p*d+_);c[0]=n[m]|n[m+1]<<8,c[1]=n[m+2]|n[m+3]<<8,c[2]=(2*(c[0]&31)+1*(c[1]&31))/3|(2*(c[0]&2016)+1*(c[1]&2016))/3&2016|(2*(c[0]&63488)+1*(c[1]&63488))/3&63488,c[3]=(2*(c[1]&31)+1*(c[0]&31))/3|(2*(c[1]&2016)+1*(c[0]&2016))/3&2016|(2*(c[1]&63488)+1*(c[0]&63488))/3&63488;for(let v=0;v<4;v++){const x=n[m+4+v];let b=(p*4+v)*l+_*4;u[b++]=c[x&3],u[b++]=c[x>>2&3],u[b++]=c[x>>4&3],u[b++]=c[x>>6&3]}}return u}}Object.defineProperty(f0,"JSModuleURL",{get:function(){return la.JSModuleURL},set:function(a){la.JSModuleURL=a}});Object.defineProperty(f0,"WasmModuleURL",{get:function(){return la.WasmModuleURL},set:function(a){la.WasmModuleURL=a}});class SR{constructor(){this.supportCascades=!1}canLoad(e){return e.endsWith(".basis")}loadCubeData(e,t,i,s,r){if(Array.isArray(e))return;const n=t.getEngine().getCaps(),o={supportedCompressionFormats:{etc1:!!n.etc1,s3tc:!!n.s3tc,pvrtc:!!n.pvrtc,etc2:!!n.etc2,astc:!!n.astc,bc7:!!n.bptc}};od(e,o).then(l=>{const h=l.fileInfo.images[0].levels.length>1&&t.generateMipMaps;ld(t,l),t.getEngine()._setCubeMapTextureParams(t,h),t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),s&&s()}).catch(l=>{const h="Failed to transcode Basis file, transcoding may not be supported on this device";q.Warn(h),t.isReady=!0,r&&r(l)})}loadData(e,t,i){const s=t.getEngine().getCaps(),r={supportedCompressionFormats:{etc1:!!s.etc1,s3tc:!!s.s3tc,pvrtc:!!s.pvrtc,etc2:!!s.etc2,astc:!!s.astc,bc7:!!s.bptc}};od(e,r).then(n=>{const o=n.fileInfo.images[0].levels[0],l=n.fileInfo.images[0].levels.length>1&&t.generateMipMaps;i(o.width,o.height,l,n.format!==-1,()=>{ld(t,n)})}).catch(n=>{q.Warn("Failed to transcode Basis file, transcoding may not be supported on this device"),q.Warn(`Failed to transcode Basis file: ${n}`),i(0,0,!1,!1,()=>{},!0)})}}k._TextureLoaders.push(new SR);class Sa extends si{constructor(e,t,i,s,r,n){const o=r&&r.generateMipMaps?r.generateMipMaps:!1,l=r&&r.generateDepthTexture?r.generateDepthTexture:!1,h=r&&r.depthTextureFormat?r.depthTextureFormat:15,c=!r||r.doNotChangeAspectRatio===void 0?!0:r.doNotChangeAspectRatio,u=r&&r.drawOnlyOnFirstAttachmentByDefault?r.drawOnlyOnFirstAttachmentByDefault:!1;if(super(e,t,s,o,c,void 0,void 0,void 0,void 0,void 0,void 0,void 0,!0),!this.isSupported){this.dispose();return}const d=[],f=[],p=[];this._initTypes(i,d,f,p,r);const _=!r||r.generateDepthBuffer===void 0?!0:r.generateDepthBuffer,m=!r||r.generateStencilBuffer===void 0?!1:r.generateStencilBuffer;this._size=t,this._multiRenderTargetOptions={samplingModes:f,generateMipMaps:o,generateDepthBuffer:_,generateStencilBuffer:m,generateDepthTexture:l,depthTextureFormat:h,types:d,textureCount:i,useSRGBBuffers:p},this._count=i,this._drawOnlyOnFirstAttachmentByDefault=u,i>0&&(this._createInternalTextures(),this._createTextures(n))}get isSupported(){var e,t;return(t=(e=this._engine)===null||e===void 0?void 0:e.getCaps().drawBuffersExtension)!==null&&t!==void 0?t:!1}get textures(){return this._textures}get count(){return this._count}get depthTexture(){return this._textures[this._textures.length-1]}set wrapU(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapU=e}set wrapV(e){if(this._textures)for(let t=0;t<this._textures.length;t++)this._textures[t].wrapV=e}_initTypes(e,t,i,s,r){for(let n=0;n<e;n++)r&&r.types&&r.types[n]!==void 0?t.push(r.types[n]):t.push(r&&r.defaultType?r.defaultType:0),r&&r.samplingModes&&r.samplingModes[n]!==void 0?i.push(r.samplingModes[n]):i.push(H.BILINEAR_SAMPLINGMODE),r&&r.useSRGBBuffers&&r.useSRGBBuffers[n]!==void 0?s.push(r.useSRGBBuffers[n]):s.push(!1)}_rebuild(e=!1,t){if(this._count<1)return;this.releaseInternalTextures(),this._createInternalTextures(),e&&(this._releaseTextures(),this._createTextures(t));const i=this._renderTarget.textures;for(let s=0;s<i.length;s++){const r=this._textures[s];r._texture=i[s]}this.samples!==1&&this._renderTarget.setSamples(this.samples,!this._drawOnlyOnFirstAttachmentByDefault,!0)}_createInternalTextures(){this._renderTarget=this._getEngine().createMultipleRenderTarget(this._size,this._multiRenderTargetOptions,!this._drawOnlyOnFirstAttachmentByDefault),this._texture=this._renderTarget.texture}_releaseTextures(){if(this._textures)for(let e=0;e<this._textures.length;e++)this._textures[e]._texture=null,this._textures[e].dispose()}_createTextures(e){const t=this._renderTarget.textures;this._textures=[];for(let i=0;i<t.length;i++){const s=new H(null,this.getScene());e!=null&&e[i]&&(s.name=e[i]),s._texture=t[i],this._textures.push(s)}}setInternalTexture(e,t,i=!0){!this.renderTarget||(t===0&&(this._texture=e),this.renderTarget.setTexture(e,t,i),this.textures[t]||(this.textures[t]=new H(null,this.getScene())),this.textures[t]._texture=e,this._count=this.renderTarget.textures?this.renderTarget.textures.length:0,this._multiRenderTargetOptions.types&&(this._multiRenderTargetOptions.types[t]=e.type),this._multiRenderTargetOptions.samplingModes&&(this._multiRenderTargetOptions.samplingModes[t]=e.samplingMode),this._multiRenderTargetOptions.useSRGBBuffers&&(this._multiRenderTargetOptions.useSRGBBuffers[t]=e._useSRGBBuffer))}get samples(){return this._samples}set samples(e){this._renderTarget?this._samples=this._renderTarget.setSamples(e):this._samples=e}resize(e){this._size=e,this._rebuild()}updateCount(e,t,i){this._multiRenderTargetOptions.textureCount=e,this._count=e;const s=[],r=[],n=[];this._initTypes(e,s,r,n,t),this._multiRenderTargetOptions.types=s,this._multiRenderTargetOptions.samplingModes=r,this._multiRenderTargetOptions.useSRGBBuffers=n,this._rebuild(!0,i)}_unbindFrameBuffer(e,t){this._renderTarget&&e.unBindMultiColorAttachmentFramebuffer(this._renderTarget,this.isCube,()=>{this.onAfterRenderObservable.notifyObservers(t)})}dispose(e=!1){this._releaseTextures(),e?this._texture=null:this.releaseInternalTextures(),super.dispose()}releaseInternalTextures(){var e,t;const i=(e=this._renderTarget)===null||e===void 0?void 0:e.textures;if(!!i){for(let s=i.length-1;s>=0;s--)this._textures[s]._texture=null;(t=this._renderTarget)===null||t===void 0||t.dispose(),this._renderTarget=null}}}const ER="noisePixelShader",CR=`uniform float brightness;
uniform float persistence;
uniform float timeScale;
varying vec2 vUV;
vec2 hash22(vec2 p)
{
p=p*mat2(127.1,311.7,269.5,183.3);
p=-1.0+2.0*fract(sin(p)*43758.5453123);
return sin(p*6.283+timeScale);
}
float interpolationNoise(vec2 p)
{
vec2 pi=floor(p);
vec2 pf=p-pi;
vec2 w=pf*pf*(3.-2.*pf);
float f00=dot(hash22(pi+vec2(.0,.0)),pf-vec2(.0,.0));
float f01=dot(hash22(pi+vec2(.0,1.)),pf-vec2(.0,1.));
float f10=dot(hash22(pi+vec2(1.0,0.)),pf-vec2(1.0,0.));
float f11=dot(hash22(pi+vec2(1.0,1.)),pf-vec2(1.0,1.));
float xm1=mix(f00,f10,w.x);
float xm2=mix(f01,f11,w.x);
float ym=mix(xm1,xm2,w.y); 
return ym;
}
float perlinNoise2D(float x,float y)
{
float sum=0.0;
float frequency=0.0;
float amplitude=0.0;
for(int i=0; i<OCTAVES; i++)
{
frequency=pow(2.0,float(i));
amplitude=pow(persistence,float(i));
sum=sum+interpolationNoise(vec2(x*frequency,y*frequency))*amplitude;
}
return sum;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float x=abs(vUV.x);
float y=abs(vUV.y);
float noise=brightness+(1.0-brightness)*perlinNoise2D(x,y);
gl_FragColor=vec4(noise,noise,noise,1.0);
}
`;Y.ShadersStore[ER]=CR;class rc extends Qr{constructor(e,t=256,i=ye.LastCreatedScene,s,r){super(e,t,"noise",i,s,r),this.time=0,this.brightness=.2,this.octaves=3,this.persistence=.8,this.animationSpeedFactor=1,this.autoClear=!1,this._updateShaderUniforms()}_updateShaderUniforms(){const e=this.getScene();!e||(this.time+=e.getAnimationRatio()*this.animationSpeedFactor*.01,this.setFloat("brightness",this.brightness),this.setFloat("persistence",this.persistence),this.setFloat("timeScale",this.time))}_getDefines(){return"#define OCTAVES "+(this.octaves|0)}render(e){this._updateShaderUniforms(),super.render(e)}serialize(){const e={};return e.customType="BABYLON.NoiseProceduralTexture",e.brightness=this.brightness,e.octaves=this.octaves,e.persistence=this.persistence,e.animationSpeedFactor=this.animationSpeedFactor,e.size=this.getSize().width,e.generateMipMaps=this._generateMipMaps,e.time=this.time,e}clone(){const e=this.getSize(),t=new rc(this.name,e.width,this.getScene(),this._fallbackTexture?this._fallbackTexture:void 0,this._generateMipMaps);return t.hasAlpha=this.hasAlpha,t.level=this.level,t.coordinatesMode=this.coordinatesMode,t.brightness=this.brightness,t.octaves=this.octaves,t.persistence=this.persistence,t.animationSpeedFactor=this.animationSpeedFactor,t.time=this.time,t}static Parse(e,t){var i;const s=new rc(e.name,e.size,t,void 0,e.generateMipMaps);return s.brightness=e.brightness,s.octaves=e.octaves,s.persistence=e.persistence,s.animationSpeedFactor=e.animationSpeedFactor,s.time=(i=e.time)!==null&&i!==void 0?i:0,s}}he("BABYLON.NoiseProceduralTexture",rc);class Di extends Ro{constructor(e,t,i,s,r,n){super(e,t,i),this._blockType=s,this._blockName=r,this._nameForCheking=n,this._nameForCheking||(this._nameForCheking=e),this.needDualDirectionValidation=!0}checkCompatibilityState(e){return e instanceof Di&&e.name===this._nameForCheking?Ks.Compatible:Ks.TypeIncompatible}createCustomInputBlock(){return[new this._blockType(this._blockName),this.name]}}class yR extends Ie{constructor(e){super(e,U.Vertex),this.registerInput("matricesIndices",I.Vector4),this.registerInput("matricesWeights",I.Vector4),this.registerInput("matricesIndicesExtra",I.Vector4,!0),this.registerInput("matricesWeightsExtra",I.Vector4,!0),this.registerInput("world",I.Matrix),this.registerOutput("output",I.Matrix)}initialize(e){e._excludeVariableName("boneSampler"),e._excludeVariableName("boneTextureWidth"),e._excludeVariableName("mBones"),e._excludeVariableName("BonesPerMesh")}getClassName(){return"BonesBlock"}get matricesIndices(){return this._inputs[0]}get matricesWeights(){return this._inputs[1]}get matricesIndicesExtra(){return this._inputs[2]}get matricesWeightsExtra(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.matricesIndices.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="matricesIndices");t||(t=new Ye("matricesIndices"),t.setAsAttribute("matricesIndices")),t.output.connectTo(this.matricesIndices)}if(!this.matricesWeights.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="matricesWeights");t||(t=new Ye("matricesWeights"),t.setAsAttribute("matricesWeights")),t.output.connectTo(this.matricesWeights)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.World);t||(t=new Ye("world"),t.setAsSystemValue(Ke.World)),t.output.connectTo(this.world)}}provideFallbacks(e,t){e&&e.useBones&&e.computeBonesUsingShaders&&e.skeleton&&t.addCPUSkinningFallback(0,e)}bind(e,t,i){se.BindBonesParameters(i,e)}prepareDefines(e,t,i){!i._areAttributesDirty||se.PrepareDefinesForBones(e,i)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithFallbacks.push(this),e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.uniforms.push("boneTextureWidth"),e.uniforms.push("mBones"),e.samplers.push("boneSampler");const t=`//${this.name}`;e._emitFunctionFromInclude("bonesDeclaration",t,{removeAttributes:!0,removeUniforms:!1,removeVaryings:!0,removeIfDef:!1});const i=e._getFreeVariableName("influence");e.compilationString+=e._emitCodeFromInclude("bonesVertex",t,{replaceStrings:[{search:/finalWorld=finalWorld\*influence;/,replace:""},{search:/influence/gm,replace:i}]});const s=this._outputs[0],r=this.world;return e.compilationString+=`#if NUM_BONE_INFLUENCERS>0\r
`,e.compilationString+=this._declareOutput(s,e)+` = ${r.associatedVariableName} * ${i};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(s,e)+` = ${r.associatedVariableName};\r
`,e.compilationString+=`#endif\r
`,this}}he("BABYLON.BonesBlock",yR);class AR extends Ie{constructor(e){super(e,U.Vertex),this.registerInput("world0",I.Vector4),this.registerInput("world1",I.Vector4),this.registerInput("world2",I.Vector4),this.registerInput("world3",I.Vector4),this.registerInput("world",I.Matrix,!0),this.registerOutput("output",I.Matrix),this.registerOutput("instanceID",I.Float)}getClassName(){return"InstancesBlock"}get world0(){return this._inputs[0]}get world1(){return this._inputs[1]}get world2(){return this._inputs[2]}get world3(){return this._inputs[3]}get world(){return this._inputs[4]}get output(){return this._outputs[0]}get instanceID(){return this._outputs[1]}autoConfigure(e){if(!this.world0.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world0");t||(t=new Ye("world0"),t.setAsAttribute("world0")),t.output.connectTo(this.world0)}if(!this.world1.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world1");t||(t=new Ye("world1"),t.setAsAttribute("world1")),t.output.connectTo(this.world1)}if(!this.world2.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world2");t||(t=new Ye("world2"),t.setAsAttribute("world2")),t.output.connectTo(this.world2)}if(!this.world3.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world3");t||(t=new Ye("world3"),t.setAsAttribute("world3")),t.output.connectTo(this.world3)}if(!this.world.connectedPoint){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="world");t||(t=new Ye("world"),t.setAsSystemValue(Ke.World)),t.output.connectTo(this.world)}this.world.define="!INSTANCES || THIN_INSTANCES"}prepareDefines(e,t,i,s=!1,r){let n=!1;i.INSTANCES!==s&&(i.setValue("INSTANCES",s),n=!0),r&&i.THIN_INSTANCES!==!!(r!=null&&r.getRenderingMesh().hasThinInstances)&&(i.setValue("THIN_INSTANCES",!!(r!=null&&r.getRenderingMesh().hasThinInstances)),n=!0),n&&i.markAsUnprocessed()}_buildBlock(e){super._buildBlock(e);const t=e.sharedData.scene.getEngine();e.sharedData.blocksWithDefines.push(this);const i=this._outputs[0],s=this._outputs[1],r=this.world0,n=this.world1,o=this.world2,l=this.world3;return e.compilationString+=`#ifdef INSTANCES\r
`,e.compilationString+=this._declareOutput(i,e)+` = mat4(${r.associatedVariableName}, ${n.associatedVariableName}, ${o.associatedVariableName}, ${l.associatedVariableName});\r
`,e.compilationString+=`#ifdef THIN_INSTANCES\r
`,e.compilationString+=`${i.associatedVariableName} = ${this.world.associatedVariableName} * ${i.associatedVariableName};\r
`,e.compilationString+=`#endif\r
`,t._caps.canUseGLInstanceID?e.compilationString+=this._declareOutput(s,e)+` = float(gl_InstanceID);\r
`:e.compilationString+=this._declareOutput(s,e)+` = 0.0;\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(i,e)+` = ${this.world.associatedVariableName};\r
`,e.compilationString+=this._declareOutput(s,e)+` = 0.0;\r
`,e.compilationString+=`#endif\r
`,this}}he("BABYLON.InstancesBlock",AR);class RR extends Ie{constructor(e){super(e,U.Vertex),this.registerInput("position",I.Vector3),this.registerInput("normal",I.Vector3),this.registerInput("tangent",I.Vector4),this.tangent.acceptedConnectionPointTypes.push(I.Vector3),this.registerInput("uv",I.Vector2),this.registerOutput("positionOutput",I.Vector3),this.registerOutput("normalOutput",I.Vector3),this.registerOutput("tangentOutput",I.Vector4),this.registerOutput("uvOutput",I.Vector2)}getClassName(){return"MorphTargetsBlock"}get position(){return this._inputs[0]}get normal(){return this._inputs[1]}get tangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get positionOutput(){return this._outputs[0]}get normalOutput(){return this._outputs[1]}get tangentOutput(){return this._outputs[2]}get uvOutput(){return this._outputs[3]}initialize(e){e._excludeVariableName("morphTargetInfluences")}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="position");t||(t=new Ye("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="normal");t||(t=new Ye("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="tangent");t||(t=new Ye("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="uv");t||(t=new Ye("uv"),t.setAsAttribute("uv")),t.output.connectTo(this.uv)}}prepareDefines(e,t,i){if(e.morphTargetManager){const s=e.morphTargetManager;(s==null?void 0:s.isUsingTextureForTargets)&&s.numInfluencers!==i.NUM_MORPH_INFLUENCERS&&i.markAsAttributesDirty()}!i._areAttributesDirty||se.PrepareDefinesForMorphTargets(e,i)}bind(e,t,i){i&&i.morphTargetManager&&i.morphTargetManager.numInfluencers>0&&(se.BindMorphTargetParameters(i,e),i.morphTargetManager.isUsingTextureForTargets&&i.morphTargetManager._bind(e))}replaceRepeatableContent(e,t,i,s){const r=this.position,n=this.normal,o=this.tangent,l=this.uv,h=this.positionOutput,c=this.normalOutput,u=this.tangentOutput,d=this.uvOutput,f=e,p=s.NUM_MORPH_INFLUENCERS,_=i.morphTargetManager,m=_&&_.supportsNormals&&s.NORMAL,v=_&&_.supportsTangents&&s.TANGENT,x=_&&_.supportsUVs&&s.UV1;let b="";(_==null?void 0:_.isUsingTextureForTargets)&&p>0&&(b+=`float vertexID;\r
`);for(let S=0;S<p;S++)b+=`#ifdef MORPHTARGETS\r
`,_!=null&&_.isUsingTextureForTargets?(b+=`vertexID = float(gl_VertexID) * morphTargetTextureInfo.x;\r
`,b+=`${h.associatedVariableName} += (readVector3FromRawSampler(${S}, vertexID) - ${r.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,b+=`vertexID += 1.0;\r
`):b+=`${h.associatedVariableName} += (position${S} - ${r.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,m&&(b+=`#ifdef MORPHTARGETS_NORMAL\r
`,_!=null&&_.isUsingTextureForTargets?(b+=`${c.associatedVariableName} += (readVector3FromRawSampler(${S}, vertexID) - ${n.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,b+=`vertexID += 1.0;\r
`):b+=`${c.associatedVariableName} += (normal${S} - ${n.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,b+=`#endif\r
`),x&&(b+=`#ifdef MORPHTARGETS_UV\r
`,_!=null&&_.isUsingTextureForTargets?(b+=`${d.associatedVariableName} += (readVector3FromRawSampler(${S}, vertexID).xy - ${l.associatedVariableName}) * morphTargetInfluences[${S}];\r
`,b+=`vertexID += 1.0;\r
`):b+=`${d.associatedVariableName}.xy += (uv_${S} - ${l.associatedVariableName}.xy) * morphTargetInfluences[${S}];\r
`,b+=`#endif\r
`),v&&(b+=`#ifdef MORPHTARGETS_TANGENT\r
`,_!=null&&_.isUsingTextureForTargets?b+=`${u.associatedVariableName}.xyz += (readVector3FromRawSampler(${S}, vertexID) - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${S}];\r
`:b+=`${u.associatedVariableName}.xyz += (tangent${S} - ${o.associatedVariableName}.xyz) * morphTargetInfluences[${S}];\r
`,o.type===I.Vector4?b+=`${u.associatedVariableName}.w = ${o.associatedVariableName}.w;\r
`:b+=`${u.associatedVariableName}.w = 1.;\r
`,b+=`#endif\r
`),b+=`#endif\r
`;if(f.compilationString=f.compilationString.replace(this._repeatableContentAnchor,b),p>0)for(let S=0;S<p;S++)f.attributes.push(y.PositionKind+S),m&&f.attributes.push(y.NormalKind+S),v&&f.attributes.push(y.TangentKind+S),x&&f.attributes.push(y.UVKind+"_"+S)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e.sharedData.repeatableContentBlocks.push(this);const t=this.position,i=this.normal,s=this.tangent,r=this.uv,n=this.positionOutput,o=this.normalOutput,l=this.tangentOutput,h=this.uvOutput,c=`//${this.name}`;return e.uniforms.push("morphTargetInfluences"),e.uniforms.push("morphTargetTextureInfo"),e.uniforms.push("morphTargetTextureIndices"),e.samplers.push("morphTargets"),e._emitFunctionFromInclude("morphTargetsVertexGlobalDeclaration",c),e._emitFunctionFromInclude("morphTargetsVertexDeclaration",c,{repeatKey:"maxSimultaneousMorphTargets"}),e.compilationString+=`${this._declareOutput(n,e)} = ${t.associatedVariableName};\r
`,e.compilationString+=`#ifdef NORMAL\r
`,e.compilationString+=`${this._declareOutput(o,e)} = ${i.associatedVariableName};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(o,e)} = vec3(0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef TANGENT\r
`,e.compilationString+=`${this._declareOutput(l,e)} = ${s.associatedVariableName};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(l,e)} = vec4(0., 0., 0., 0.);\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#ifdef UV1\r
`,e.compilationString+=`${this._declareOutput(h,e)} = ${r.associatedVariableName};\r
`,e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(h,e)} = vec2(0., 0.);\r
`,e.compilationString+=`#endif\r
`,this._repeatableContentAnchor=e._repeatableContentAnchor,e.compilationString+=this._repeatableContentAnchor,this}}he("BABYLON.MorphTargetsBlock",RR);class IR extends Ie{constructor(e){super(e,U.Vertex),this.registerInput("worldPosition",I.Vector4,!1,U.Vertex),this.registerOutput("direction",I.Vector3),this.registerOutput("color",I.Color3),this.registerOutput("intensity",I.Float),this.registerOutput("shadowBias",I.Float),this.registerOutput("shadowNormalBias",I.Float),this.registerOutput("shadowDepthScale",I.Float),this.registerOutput("shadowDepthRange",I.Vector2)}getClassName(){return"LightInformationBlock"}get worldPosition(){return this._inputs[0]}get direction(){return this._outputs[0]}get color(){return this._outputs[1]}get intensity(){return this._outputs[2]}get shadowBias(){return this._outputs[3]}get shadowNormalBias(){return this._outputs[4]}get shadowDepthScale(){return this._outputs[5]}get shadowDepthRange(){return this._outputs[6]}bind(e,t,i){if(!i)return;this.light&&this.light.isDisposed()&&(this.light=null);let s=this.light;const r=t.getScene();if(!s&&r.lights.length&&(s=this.light=r.lights[0],this._forcePrepareDefines=!0),!s||!s.isEnabled){e.setFloat3(this._lightDataUniformName,0,0,0),e.setFloat4(this._lightColorUniformName,0,0,0,0);return}s.transferToNodeMaterialEffect(e,this._lightDataUniformName),e.setColor4(this._lightColorUniformName,s.diffuse,s.intensity);const n=s.getShadowGenerator();if((this.shadowBias.hasEndpoints||this.shadowNormalBias.hasEndpoints||this.shadowDepthScale.hasEndpoints)&&(n?e.setFloat3(this._lightShadowUniformName,n.bias,n.normalBias,n.depthScale):e.setFloat3(this._lightShadowUniformName,0,0,0)),this.shadowDepthRange)if(n&&r.activeCamera){const o=s;e.setFloat2(this._lightShadowExtraUniformName,o.getDepthMinZ(r.activeCamera),o.getDepthMinZ(r.activeCamera)+o.getDepthMaxZ(r.activeCamera))}else e.setFloat2(this._lightShadowExtraUniformName,0,0)}prepareDefines(e,t,i){if(!i._areLightsDirty&&!this._forcePrepareDefines)return;this._forcePrepareDefines=!1;const s=this.light;i.setValue(this._lightTypeDefineName,!!(s&&s instanceof Sc),!0)}_buildBlock(e){super._buildBlock(e),e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=this.direction,i=this.color,s=this.intensity,r=this.shadowBias,n=this.shadowNormalBias,o=this.shadowDepthScale,l=this.shadowDepthRange;return this._lightDataUniformName=e._getFreeVariableName("lightData"),this._lightColorUniformName=e._getFreeVariableName("lightColor"),this._lightShadowUniformName=e._getFreeVariableName("shadowData"),this._lightShadowExtraUniformName=e._getFreeVariableName("shadowExtraData"),this._lightTypeDefineName=e._getFreeDefineName("LIGHTPOINTTYPE"),e._emitUniformFromString(this._lightDataUniformName,"vec3"),e._emitUniformFromString(this._lightColorUniformName,"vec4"),e.compilationString+=`#ifdef ${this._lightTypeDefineName}\r
`,e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.worldPosition.associatedVariableName}.xyz - ${this._lightDataUniformName});\r
`,e.compilationString+=`#else\r
`,e.compilationString+=this._declareOutput(t,e)+` = ${this._lightDataUniformName};\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=this._declareOutput(i,e)+` = ${this._lightColorUniformName}.rgb;\r
`,e.compilationString+=this._declareOutput(s,e)+` = ${this._lightColorUniformName}.a;\r
`,(r.hasEndpoints||n.hasEndpoints||o.hasEndpoints)&&(e._emitUniformFromString(this._lightShadowUniformName,"vec3"),r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = ${this._lightShadowUniformName}.x;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${this._lightShadowUniformName}.y;\r
`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${this._lightShadowUniformName}.z;\r
`)),l.hasEndpoints&&(e._emitUniformFromString(this._lightShadowExtraUniformName,"vec2"),e.compilationString+=this._declareOutput(l,e)+` = ${this._lightShadowUniformName};\r
`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}he("BABYLON.LightInformationBlock",IR);class Cm extends Ie{constructor(e){super(e,U.Fragment),this.convertInputToLinearSpace=!0,this.registerInput("color",I.Color4),this.registerOutput("output",I.Color4),this._inputs[0].acceptedConnectionPointTypes.push(I.Color3)}getClassName(){return"ImageProcessingBlock"}get color(){return this._inputs[0]}get output(){return this._outputs[0]}initialize(e){e._excludeVariableName("exposureLinear"),e._excludeVariableName("contrast"),e._excludeVariableName("vInverseScreenSize"),e._excludeVariableName("vignetteSettings1"),e._excludeVariableName("vignetteSettings2"),e._excludeVariableName("vCameraColorCurveNegative"),e._excludeVariableName("vCameraColorCurveNeutral"),e._excludeVariableName("vCameraColorCurvePositive"),e._excludeVariableName("txColorTransform"),e._excludeVariableName("colorTransformSettings"),e._excludeVariableName("ditherIntensity")}isReady(e,t,i){return!(i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}prepareDefines(e,t,i){i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i)}bind(e,t,i){!i||!t.imageProcessingConfiguration||t.imageProcessingConfiguration.bind(e)}_buildBlock(e){super._buildBlock(e),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this),e.sharedData.bindableBlocks.push(this),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity");const t=this.color,i=this._outputs[0],s=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",s),e._emitFunctionFromInclude("imageProcessingDeclaration",s),e._emitFunctionFromInclude("imageProcessingFunctions",s),t.connectedPoint.type===I.Color4||t.connectedPoint.type===I.Vector4?e.compilationString+=`${this._declareOutput(i,e)} = ${t.associatedVariableName};\r
`:e.compilationString+=`${this._declareOutput(i,e)} = vec4(${t.associatedVariableName}, 1.0);\r
`,e.compilationString+=`#ifdef IMAGEPROCESSINGPOSTPROCESS\r
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName}.rgb = toLinearSpace(${t.associatedVariableName}.rgb);\r
`),e.compilationString+=`#else\r
`,e.compilationString+=`#ifdef IMAGEPROCESSING\r
`,this.convertInputToLinearSpace&&(e.compilationString+=`${i.associatedVariableName}.rgb = toLinearSpace(${t.associatedVariableName}.rgb);\r
`),e.compilationString+=`${i.associatedVariableName} = applyImageProcessing(${i.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`,e.compilationString+=`#endif\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertInputToLinearSpace = ${this.convertInputToLinearSpace};\r
`,e}serialize(){const e=super.serialize();return e.convertInputToLinearSpace=this.convertInputToLinearSpace,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.convertInputToLinearSpace=(s=e.convertInputToLinearSpace)!==null&&s!==void 0?s:!0}}T([ft("Convert input to linear space",at.Boolean,"ADVANCED")],Cm.prototype,"convertInputToLinearSpace",void 0);he("BABYLON.ImageProcessingBlock",Cm);class Yo extends Ie{constructor(e){super(e,U.Fragment,!0),this.registerInput("normal",I.Vector4,!1),this.normal.acceptedConnectionPointTypes.push(I.Vector3),this.registerInput("tangent",I.Vector4,!1),this.registerInput("world",I.Matrix,!1),this.registerOutput("TBN",I.Object,U.Fragment,new Di("TBN",this,fi.Output,Yo,"TBNBlock")),this.registerOutput("row0",I.Vector3,U.Fragment),this.registerOutput("row1",I.Vector3,U.Fragment),this.registerOutput("row2",I.Vector3,U.Fragment)}getClassName(){return"TBNBlock"}initialize(e){e._excludeVariableName("tbnNormal"),e._excludeVariableName("tbnTangent"),e._excludeVariableName("tbnBitangent"),e._excludeVariableName("TBN")}get normal(){return this._inputs[0]}get tangent(){return this._inputs[1]}get world(){return this._inputs[2]}get TBN(){return this._outputs[0]}get row0(){return this._outputs[1]}get row1(){return this._outputs[2]}get row2(){return this._outputs[3]}get target(){return U.Fragment}set target(e){}autoConfigure(e){if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.isSystemValue&&i.systemValue===Ke.World);t||(t=new Ye("world"),t.setAsSystemValue(Ke.World)),t.output.connectTo(this.world)}if(!this.normal.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="normal");t||(t=new Ye("normal"),t.setAsAttribute("normal")),t.output.connectTo(this.normal)}if(!this.tangent.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="tangent"&&i.type===I.Vector4);t||(t=new Ye("tangent"),t.setAsAttribute("tangent")),t.output.connectTo(this.tangent)}}prepareDefines(e,t,i){var s,r,n,o;const l=this.normal,h=this.tangent;let c=l.isConnected;((s=l.connectInputBlock)===null||s===void 0?void 0:s.isAttribute)&&!e.isVerticesDataPresent((r=l.connectInputBlock)===null||r===void 0?void 0:r.name)&&(c=!1);let u=h.isConnected;((n=h.connectInputBlock)===null||n===void 0?void 0:n.isAttribute)&&!e.isVerticesDataPresent((o=h.connectInputBlock)===null||o===void 0?void 0:o.name)&&(u=!1);const d=c&&u;i.setValue("TBNBLOCK",d,!0)}_buildBlock(e){super._buildBlock(e);const t=this.normal,i=this.tangent,s=this.world,r=this.TBN,n=this.row0,o=this.row1,l=this.row2;return e.target===U.Fragment&&(e.compilationString+=`
                // ${this.name}
                vec3 tbnNormal = normalize(${t.associatedVariableName}).xyz;
                vec3 tbnTangent = normalize(${i.associatedVariableName}.xyz);
                vec3 tbnBitangent = cross(tbnNormal, tbnTangent) * ${i.associatedVariableName}.w;
                mat3 ${r.associatedVariableName} = mat3(${s.associatedVariableName}) * mat3(tbnTangent, tbnBitangent, tbnNormal);
            `,n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = vec3(${r.associatedVariableName}[0][0], ${r.associatedVariableName}[0][1], ${r.associatedVariableName}[0][2]);\r
`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec3(${r.associatedVariableName}[1[0], ${r.associatedVariableName}[1][1], ${r.associatedVariableName}[1][2]);\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${r.associatedVariableName}[2][0], ${r.associatedVariableName}[2][1], ${r.associatedVariableName}[2][2]);\r
`),e.sharedData.blocksWithDefines.push(this)),this}}he("BABYLON.TBNBlock",Yo);class tu extends Ie{constructor(e){super(e,U.Fragment),this._tangentSpaceParameterName="",this.invertX=!1,this.invertY=!1,this.useParallaxOcclusion=!1,this._isUnique=!0,this.registerInput("worldPosition",I.Vector4,!1),this.registerInput("worldNormal",I.Vector4,!1),this.registerInput("worldTangent",I.Vector4,!0),this.registerInput("uv",I.Vector2,!1),this.registerInput("normalMapColor",I.Color3,!1),this.registerInput("strength",I.Float,!1),this.registerInput("viewDirection",I.Vector3,!0),this.registerInput("parallaxScale",I.Float,!0),this.registerInput("parallaxHeight",I.Float,!0),this.registerInput("TBN",I.Object,!0,U.VertexAndFragment,new Di("TBN",this,fi.Input,Yo,"TBNBlock")),this.registerOutput("output",I.Vector4),this.registerOutput("uvOffset",I.Vector2)}getClassName(){return"PerturbNormalBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get worldTangent(){return this._inputs[2]}get uv(){return this._inputs[3]}get normalMapColor(){return this._inputs[4]}get strength(){return this._inputs[5]}get viewDirection(){return this._inputs[6]}get parallaxScale(){return this._inputs[7]}get parallaxHeight(){return this._inputs[8]}get TBN(){return this._inputs[9]}get output(){return this._outputs[0]}get uvOffset(){return this._outputs[1]}prepareDefines(e,t,i){const s=this.normalMapColor.connectedPoint._ownerBlock.samplerName,r=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&s||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected);i.setValue("BUMP",!0),i.setValue("PARALLAX",r,!0),i.setValue("PARALLAXOCCLUSION",this.useParallaxOcclusion,!0)}bind(e,t){t.getScene()._mirroredCameraPosition?e.setFloat2(this._tangentSpaceParameterName,this.invertX?1:-1,this.invertY?1:-1):e.setFloat2(this._tangentSpaceParameterName,this.invertX?-1:1,this.invertY?-1:1)}autoConfigure(e){if(!this.uv.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="uv");t||(t=new Ye("uv"),t.setAsAttribute()),t.output.connectTo(this.uv)}if(!this.strength.isConnected){const t=new Ye("strength");t.value=1,t.output.connectTo(this.strength)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`,i=this.uv,s=this.worldPosition,r=this.worldNormal,n=this.worldTangent;e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._tangentSpaceParameterName=e._getFreeDefineName("tangentSpaceParameter"),e._emitUniformFromString(this._tangentSpaceParameterName,"vec2");let o=null;this.normalMapColor.connectedPoint&&(o=this.normalMapColor.connectedPoint._ownerBlock.samplerName);const l=this.viewDirection.isConnected&&(this.useParallaxOcclusion&&o||!this.useParallaxOcclusion&&this.parallaxHeight.isConnected),h=this.parallaxScale.isConnectedToInputBlock?this.parallaxScale.connectInputBlock.isConstant?e._emitFloat(this.parallaxScale.connectInputBlock.value):this.parallaxScale.associatedVariableName:"0.05",c=this.strength.isConnectedToInputBlock&&this.strength.connectInputBlock.isConstant?`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
${e._emitFloat(this.strength.connectInputBlock.value)}`:`\r
#if !defined(NORMALXYSCALE)\r
1.0/\r
#endif\r
${this.strength.associatedVariableName}`;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const u={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},d={search:/varying mat3 vTBN/g,replace:""},f=this.TBN;f.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${f.associatedVariableName};
            #endif
            `:n.isConnected&&(e.compilationString+=`vec3 tbnNormal = normalize(${r.associatedVariableName}.xyz);\r
`,e.compilationString+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\r
`,e.compilationString+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,e.compilationString+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",t,{replaceStrings:[u,d]}),e._emitFunctionFromInclude("bumpFragmentFunctions",t,{replaceStrings:[{search:/#include<samplerFragmentDeclaration>\(_DEFINENAME_,BUMP,_VARYINGNAME_,Bump,_SAMPLERNAME_,bump\)/g,replace:""},{search:/uniform sampler2D bumpSampler;/g,replace:""},{search:/vec2 parallaxOcclusion\(vec3 vViewDirCoT,vec3 vNormalCoT,vec2 texCoord,float parallaxScale\)/g,replace:`#define inline\r
vec2 parallaxOcclusion(vec3 vViewDirCoT, vec3 vNormalCoT, vec2 texCoord, float parallaxScale, sampler2D bumpSampler)`},{search:/vec2 parallaxOffset\(vec3 viewDir,float heightScale\)/g,replace:"vec2 parallaxOffset(vec3 viewDir, float heightScale, float height_)"},{search:/texture2D\(bumpSampler,vBumpUV\)\.w/g,replace:"height_"}]});const p=!l||!o?this.normalMapColor.associatedVariableName:`texture2D(${o}, ${i.associatedVariableName} + uvOffset).xyz`;return e.compilationString+=this._declareOutput(this.output,e)+` = vec4(0.);\r
`,e.compilationString+=e._emitCodeFromInclude("bumpFragment",t,{replaceStrings:[{search:/perturbNormal\(TBN,texture2D\(bumpSampler,vBumpUV\+uvOffset\).xyz,vBumpInfos.y\)/g,replace:`perturbNormal(TBN, ${p}, vBumpInfos.y)`},{search:/parallaxOcclusion\(invTBN\*-viewDirectionW,invTBN\*normalW,vBumpUV,vBumpInfos.z\)/g,replace:`parallaxOcclusion((invTBN * -viewDirectionW), (invTBN * normalW), vBumpUV, vBumpInfos.z, ${l&&this.useParallaxOcclusion?o:"bumpSampler"})`},{search:/parallaxOffset\(invTBN\*viewDirectionW,vBumpInfos\.z\)/g,replace:`parallaxOffset(invTBN * viewDirectionW, vBumpInfos.z, ${l?this.parallaxHeight.associatedVariableName:"0."})`},{search:/vTangentSpaceParams/g,replace:this._tangentSpaceParameterName},{search:/vBumpInfos.y/g,replace:c},{search:/vBumpInfos.z/g,replace:h},{search:/vBumpUV/g,replace:i.associatedVariableName},{search:/vPositionW/g,replace:s.associatedVariableName+".xyz"},{search:/normalW=/g,replace:this.output.associatedVariableName+".xyz = "},{search:/mat3\(normalMatrix\)\*normalW/g,replace:"mat3(normalMatrix) * "+this.output.associatedVariableName+".xyz"},{search:/normalW/g,replace:r.associatedVariableName+".xyz"},{search:/viewDirectionW/g,replace:l?this.viewDirection.associatedVariableName:"vec3(0.)"},u]}),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.invertX = ${this.invertX};\r
`;return e+=`${this._codeVariableName}.invertY = ${this.invertY};\r
`,e+=`${this._codeVariableName}.useParallaxOcclusion = ${this.useParallaxOcclusion};\r
`,e}serialize(){const e=super.serialize();return e.invertX=this.invertX,e.invertY=this.invertY,e.useParallaxOcclusion=this.useParallaxOcclusion,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.invertX=e.invertX,this.invertY=e.invertY,this.useParallaxOcclusion=!!e.useParallaxOcclusion}}T([ft("Invert X axis",at.Boolean,"PROPERTIES",{notifiers:{update:!1}})],tu.prototype,"invertX",void 0);T([ft("Invert Y axis",at.Boolean,"PROPERTIES",{notifiers:{update:!1}})],tu.prototype,"invertY",void 0);T([ft("Use parallax occlusion",at.Boolean)],tu.prototype,"useParallaxOcclusion",void 0);he("BABYLON.PerturbNormalBlock",tu);class PR extends Ie{constructor(e){super(e,U.Fragment,!0),this.registerInput("value",I.Float,!0),this.registerInput("cutoff",I.Float,!0)}getClassName(){return"DiscardBlock"}get value(){return this._inputs[0]}get cutoff(){return this._inputs[1]}_buildBlock(e){if(super._buildBlock(e),e.sharedData.hints.needAlphaTesting=!0,!(!this.cutoff.isConnected||!this.value.isConnected))return e.compilationString+=`if (${this.value.associatedVariableName} < ${this.cutoff.associatedVariableName}) discard;\r
`,this}}he("BABYLON.DiscardBlock",PR);class MR extends Ie{constructor(e){super(e,U.Fragment),this.registerOutput("output",I.Float,U.Fragment)}getClassName(){return"FrontFacingBlock"}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),e.target===U.Vertex)throw"FrontFacingBlock must only be used in a fragment shader";const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = gl_FrontFacing ? 1.0 : 0.0;\r
`,this}}he("BABYLON.FrontFacingBlock",MR);class DR extends Ie{constructor(e){super(e,U.Fragment),this.registerInput("input",I.AutoDetect,!1),this.registerOutput("dx",I.BasedOnInput),this.registerOutput("dy",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[1]._typeConnectionSource=this._inputs[0]}getClassName(){return"DerivativeBlock"}get input(){return this._inputs[0]}get dx(){return this._outputs[0]}get dy(){return this._outputs[1]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._outputs[1];return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),t.hasEndpoints&&(e.compilationString+=this._declareOutput(t,e)+` = dFdx(${this.input.associatedVariableName});\r
`),i.hasEndpoints&&(e.compilationString+=this._declareOutput(i,e)+` = dFdy(${this.input.associatedVariableName});\r
`),this}}he("BABYLON.DerivativeBlock",DR);class OR extends Ie{constructor(e){super(e,U.Fragment),this.registerOutput("xy",I.Vector2,U.Fragment),this.registerOutput("xyz",I.Vector3,U.Fragment),this.registerOutput("xyzw",I.Vector4,U.Fragment),this.registerOutput("x",I.Float,U.Fragment),this.registerOutput("y",I.Float,U.Fragment),this.registerOutput("z",I.Float,U.Fragment),this.registerOutput("w",I.Float,U.Fragment)}getClassName(){return"FragCoordBlock"}get xy(){return this._outputs[0]}get xyz(){return this._outputs[1]}get xyzw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get output(){return this._outputs[6]}writeOutputs(e){let t="";for(const i of this._outputs)i.hasEndpoints&&(t+=`${this._declareOutput(i,e)} = gl_FragCoord.${i.name};\r
`);return t}_buildBlock(e){if(super._buildBlock(e),e.target===U.Vertex)throw"FragCoordBlock must only be used in a fragment shader";return e.compilationString+=this.writeOutputs(e),this}}he("BABYLON.FragCoordBlock",OR);class wR extends Ie{constructor(e){super(e,U.Fragment),this.registerOutput("xy",I.Vector2,U.Fragment),this.registerOutput("x",I.Float,U.Fragment),this.registerOutput("y",I.Float,U.Fragment)}getClassName(){return"ScreenSizeBlock"}get xy(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}bind(e){const t=this._scene.getEngine();e.setFloat2(this._varName,t.getRenderWidth(),t.getRenderHeight())}writeOutputs(e,t){let i="";for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\r
`);return i}_buildBlock(e){if(super._buildBlock(e),this._scene=e.sharedData.scene,e.target===U.Vertex)throw"ScreenSizeBlock must only be used in a fragment shader";return e.sharedData.bindableBlocks.push(this),this._varName=e._getFreeVariableName("screenSize"),e._emitUniformFromString(this._varName,"vec2"),e.compilationString+=this.writeOutputs(e,this._varName),this}}he("BABYLON.ScreenSizeBlock",wR);class NR extends Ie{constructor(e){super(e,U.Fragment),this.registerInput("vector",I.Vector3),this.registerInput("worldViewProjection",I.Matrix),this.registerOutput("output",I.Vector2),this.registerOutput("x",I.Float),this.registerOutput("y",I.Float),this.inputs[0].acceptedConnectionPointTypes.push(I.Vector4)}getClassName(){return"ScreenSpaceBlock"}get vector(){return this._inputs[0]}get worldViewProjection(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(e){if(!this.worldViewProjection.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.WorldViewProjection);t||(t=new Ye("worldViewProjection"),t.setAsSystemValue(Ke.WorldViewProjection)),t.output.connectTo(this.worldViewProjection)}}_buildBlock(e){super._buildBlock(e);const t=this.vector,i=this.worldViewProjection;if(!t.connectedPoint)return;const s=i.associatedVariableName,r=e._getFreeVariableName("screenSpaceTemp");switch(t.connectedPoint.type){case I.Vector3:e.compilationString+=`vec4 ${r} = ${s} * vec4(${t.associatedVariableName}, 1.0);\r
`;break;case I.Vector4:e.compilationString+=`vec4 ${r} = ${s} * ${t.associatedVariableName};\r
`;break}return e.compilationString+=`${r}.xy /= ${r}.w;`,e.compilationString+=`${r}.xy = ${r}.xy * 0.5 + vec2(0.5, 0.5);`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${r}.xy;\r
`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${r}.x;\r
`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${r}.y;\r
`),this}}he("BABYLON.ScreenSpaceBlock",NR);class FR extends Ie{constructor(e){super(e,U.Fragment),this.registerInput("input",I.Vector2),this.registerInput("strength",I.Float),this.registerInput("center",I.Vector2),this.registerInput("offset",I.Vector2),this.registerOutput("output",I.Vector2),this.registerOutput("x",I.Float),this.registerOutput("y",I.Float)}getClassName(){return"TwirlBlock"}get input(){return this._inputs[0]}get strength(){return this._inputs[1]}get center(){return this._inputs[2]}get offset(){return this._inputs[3]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}autoConfigure(){if(!this.center.isConnected){const e=new Ye("center");e.value=new le(.5,.5),e.output.connectTo(this.center)}if(!this.strength.isConnected){const e=new Ye("strength");e.value=1,e.output.connectTo(this.strength)}if(!this.offset.isConnected){const e=new Ye("offset");e.value=new le(0,0),e.output.connectTo(this.offset)}}_buildBlock(e){super._buildBlock(e);const t=e._getFreeVariableName("delta"),i=e._getFreeVariableName("angle"),s=e._getFreeVariableName("x"),r=e._getFreeVariableName("y"),n=e._getFreeVariableName("result");return e.compilationString+=`
            vec2 ${t} = ${this.input.associatedVariableName} - ${this.center.associatedVariableName};
            float ${i} = ${this.strength.associatedVariableName} * length(${t});
            float ${s} = cos(${i}) * ${t}.x - sin(${i}) * ${t}.y;
            float ${r} = sin(${i}) * ${t}.x + cos(${i}) * ${t}.y;
            vec2 ${n} = vec2(${s} + ${this.center.associatedVariableName}.x + ${this.offset.associatedVariableName}.x, ${r} + ${this.center.associatedVariableName}.y + ${this.offset.associatedVariableName}.y);
        `,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${n};\r
`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${n}.x;\r
`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${n}.y;\r
`),this}}he("BABYLON.TwirlBlock",FR);class LR extends Ie{constructor(e){super(e,U.Fragment),this.registerInput("input",I.Float),this.registerInput("position",I.Vector3),this.registerInput("normal",I.Vector3),this.registerInput("tangent",I.Vector3),this.registerOutput("output",I.Vector3),this._inputs[3].acceptedConnectionPointTypes.push(I.Vector4)}getClassName(){return"HeightToNormalBlock"}get input(){return this._inputs[0]}get position(){return this._inputs[1]}get normal(){return this._inputs[2]}get tangent(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`
        vec3 heightToNormal(in float height, in vec3 position, in vec3 tangent, in vec3 normal) {
            vec3 biTangent = cross(tangent, normal);
            mat3 TBN = mat3(tangent, biTangent, normal);
            vec3 worlddX = dFdx(position * 100.0);
            vec3 worlddY = dFdy(position * 100.0);
            vec3 crossX = cross(normal, worlddX);
            vec3 crossY = cross(normal, worlddY);
            float d = abs(dot(crossY, worlddX));
            vec3 inToNormal = vec3(((((height + dFdx(height)) - height) * crossY) + (((height + dFdy(height)) - height) * crossX)) * sign(d));
            inToNormal.y *= -1.0;
            vec3 result = normalize((d * normal) - inToNormal);
            return TBN * result;
        }`;return e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e._emitFunction("heightToNormal",i,"// heightToNormal"),e.compilationString+=this._declareOutput(t,e)+` = heightToNormal(${this.input.associatedVariableName}, ${this.position.associatedVariableName}, ${this.tangent.associatedVariableName}.xyz, ${this.normal.associatedVariableName});\r
`,this}}he("BABYLON.HeightToNormalBlock",LR);class BR extends Ie{constructor(e){super(e,U.VertexAndFragment,!1),this.registerInput("worldPosition",I.Vector4,!1,U.Vertex),this.registerInput("view",I.Matrix,!1,U.Vertex),this.registerInput("input",I.Color3,!1,U.Fragment),this.registerInput("fogColor",I.Color3,!1,U.Fragment),this.registerOutput("output",I.Color3,U.Fragment),this.input.acceptedConnectionPointTypes.push(I.Color4),this.fogColor.acceptedConnectionPointTypes.push(I.Color4)}getClassName(){return"FogBlock"}get worldPosition(){return this._inputs[0]}get view(){return this._inputs[1]}get input(){return this._inputs[2]}get fogColor(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.View);t||(t=new Ye("view"),t.setAsSystemValue(Ke.View)),t.output.connectTo(this.view)}if(!this.fogColor.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.FogColor);t||(t=new Ye("fogColor",void 0,I.Color3),t.setAsSystemValue(Ke.FogColor)),t.output.connectTo(this.fogColor)}}prepareDefines(e,t,i){const s=e.getScene();i.setValue("FOG",t.fogEnabled&&se.GetFogState(e,s))}bind(e,t,i){if(!i)return;const s=i.getScene();e.setFloat4(this._fogParameters,s.fogMode,s.fogStart,s.fogEnd,s.fogDensity)}_buildBlock(e){if(super._buildBlock(e),e.target===U.Fragment){e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),e._emitFunctionFromInclude("fogFragmentDeclaration",`//${this.name}`,{removeUniforms:!0,removeVaryings:!0,removeIfDef:!1,replaceStrings:[{search:/float CalcFogFactor\(\)/,replace:"float CalcFogFactor(vec3 vFogDistance, vec4 vFogInfos)"}]});const t=e._getFreeVariableName("fog"),i=this.input,s=this.fogColor;this._fogParameters=e._getFreeVariableName("fogParameters");const r=this._outputs[0];e._emitUniformFromString(this._fogParameters,"vec4"),e.compilationString+=`#ifdef FOG\r
`,e.compilationString+=`float ${t} = CalcFogFactor(${this._fogDistanceName}, ${this._fogParameters});\r
`,e.compilationString+=this._declareOutput(r,e)+` = ${t} * ${i.associatedVariableName}.rgb + (1.0 - ${t}) * ${s.associatedVariableName}.rgb;\r
`,e.compilationString+=`#else\r
${this._declareOutput(r,e)} =  ${i.associatedVariableName}.rgb;\r
`,e.compilationString+=`#endif\r
`}else{const t=this.worldPosition,i=this.view;this._fogDistanceName=e._getFreeVariableName("vFogDistance"),e._emitVaryingFromString(this._fogDistanceName,"vec3"),e.compilationString+=`${this._fogDistanceName} = (${i.associatedVariableName} * ${t.associatedVariableName}).xyz;\r
`}return this}}he("BABYLON.FogBlock",BR);class UR extends Ie{constructor(e){super(e,U.VertexAndFragment),this._isUnique=!0,this.registerInput("worldPosition",I.Vector4,!1,U.Vertex),this.registerInput("worldNormal",I.Vector4,!1,U.Fragment),this.registerInput("cameraPosition",I.Vector3,!1,U.Fragment),this.registerInput("glossiness",I.Float,!0,U.Fragment),this.registerInput("glossPower",I.Float,!0,U.Fragment),this.registerInput("diffuseColor",I.Color3,!0,U.Fragment),this.registerInput("specularColor",I.Color3,!0,U.Fragment),this.registerInput("view",I.Matrix,!0),this.registerOutput("diffuseOutput",I.Color3,U.Fragment),this.registerOutput("specularOutput",I.Color3,U.Fragment),this.registerOutput("shadow",I.Float,U.Fragment)}getClassName(){return"LightBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get cameraPosition(){return this._inputs[2]}get glossiness(){return this._inputs[3]}get glossPower(){return this._inputs[4]}get diffuseColor(){return this._inputs[5]}get specularColor(){return this._inputs[6]}get view(){return this._inputs[7]}get diffuseOutput(){return this._outputs[0]}get specularOutput(){return this._outputs[1]}get shadow(){return this._outputs[2]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.CameraPosition);t||(t=new Ye("cameraPosition"),t.setAsSystemValue(Ke.CameraPosition)),t.output.connectTo(this.cameraPosition)}}prepareDefines(e,t,i){if(!i._areLightsDirty)return;const s=e.getScene();if(!this.light)se.PrepareDefinesForLights(s,e,i,!0,t.maxSimultaneousLights);else{const r={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};se.PrepareDefinesForLight(s,e,this.light,this._lightId,i,!0,r),r.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const n=e.uniforms.indexOf("vLightData"+r)>=0;se.PrepareUniformsAndSamplersForLight(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,n)}}bind(e,t,i){if(!i)return;const s=i.getScene();this.light?se.BindLight(this.light,this._lightId,s,e,!0):se.BindLights(s,i,e,!0,t.maxSimultaneousLights)}_injectVertexCode(e){const t=this.worldPosition,i=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",i,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const s="v_"+t.associatedVariableName;e._emitVaryingFromString(s,"vec4")&&(e.compilationString+=`${s} = ${t.associatedVariableName};\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:t.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${t.associatedVariableName};\r
`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",i,{repeatKey:"maxSimultaneousLights"}))}_buildBlock(e){if(super._buildBlock(e),e.target!==U.Fragment){this._injectVertexCode(e);return}e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this);const t=`//${this.name}`,i=this.worldPosition;e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("lightsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+i.associatedVariableName+".xyz"}]}),e._emitFunctionFromInclude("shadowsFragmentFunctions",t,{replaceStrings:[{search:/vPositionW/g,replace:"v_"+i.associatedVariableName+".xyz"}]}),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",t,{repeatKey:"maxSimultaneousLights"}),this._lightId===0&&(e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${"v_"+i.associatedVariableName}.xyz);\r
`),e.compilationString+=`lightingInfo info;\r
`,e.compilationString+=`float shadow = 1.;\r
`,e.compilationString+=`float glossiness = ${this.glossiness.isConnected?this.glossiness.associatedVariableName:"1.0"} * ${this.glossPower.isConnected?this.glossPower.associatedVariableName:"1024.0"};\r
`,e.compilationString+=`vec3 diffuseBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 specularBase = vec3(0., 0., 0.);\r
`,e.compilationString+=`vec3 normalW = ${this.worldNormal.associatedVariableName}.xyz;\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",t,{repeatKey:"maxSimultaneousLights"});const s=this.diffuseOutput,r=this.specularOutput;return e.compilationString+=this._declareOutput(s,e)+` = diffuseBase${this.diffuseColor.isConnected?" * "+this.diffuseColor.associatedVariableName:""};\r
`,r.hasEndpoints&&(e.compilationString+=this._declareOutput(r,e)+` = specularBase${this.specularColor.isConnected?" * "+this.specularColor.associatedVariableName:""};\r
`),this.shadow.hasEndpoints&&(e.compilationString+=this._declareOutput(this.shadow,e)+` = shadow;\r
`),this}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId))}}he("BABYLON.LightBlock",UR);class iu extends Ie{constructor(e){super(e,U.VertexAndFragment),this.registerOutput("source",I.Object,U.VertexAndFragment,new Di("source",this,fi.Output,iu,"ImageSourceBlock"))}get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:ye.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}get samplerName(){return this._samplerName}bind(e){!this.texture||e.setTexture(this._samplerName,this.texture)}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}getClassName(){return"ImageSourceBlock"}get source(){return this._outputs[0]}_buildBlock(e){return super._buildBlock(e),e.target===U.Vertex&&(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.bindableBlocks.push(this)),e._emit2DSampler(this._samplerName),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&!di.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=H.Parse(e.texture,t,i))}}he("BABYLON.ImageSourceBlock",iu);class VR extends Ie{constructor(e,t=!1){super(e,t?U.Fragment:U.VertexAndFragment),this._convertToGammaSpace=!1,this._convertToLinearSpace=!1,this.disableLevelMultiplication=!1,this._fragmentOnly=t,this.registerInput("uv",I.Vector2,!1,U.VertexAndFragment),this.registerInput("source",I.Object,!0,U.VertexAndFragment,new Di("source",this,fi.Input,iu,"ImageSourceBlock")),this.registerOutput("rgba",I.Color4,U.Neutral),this.registerOutput("rgb",I.Color3,U.Neutral),this.registerOutput("r",I.Float,U.Neutral),this.registerOutput("g",I.Float,U.Neutral),this.registerOutput("b",I.Float,U.Neutral),this.registerOutput("a",I.Float,U.Neutral),this.registerOutput("level",I.Float,U.Neutral),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0]._prioritizeVertex=!t}get texture(){var e;return this.source.isConnected?((e=this.source.connectedPoint)===null||e===void 0?void 0:e.ownerBlock).texture:this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:ye.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}get samplerName(){return this._imageSource?this._imageSource.samplerName:this._samplerName}get hasImageSource(){return!!this._imageSource}set convertToGammaSpace(e){var t;if(e!==this._convertToGammaSpace&&(this._convertToGammaSpace=e,this.texture)){const i=(t=this.texture.getScene())!==null&&t!==void 0?t:ye.LastCreatedScene;i==null||i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this.texture))}}get convertToGammaSpace(){return this._convertToGammaSpace}set convertToLinearSpace(e){var t;if(e!==this._convertToLinearSpace&&(this._convertToLinearSpace=e,this.texture)){const i=(t=this.texture.getScene())!==null&&t!==void 0?t:ye.LastCreatedScene;i==null||i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this.texture))}}get convertToLinearSpace(){return this._convertToLinearSpace}getClassName(){return"TextureBlock"}get uv(){return this._inputs[0]}get source(){return this._inputs[1]}get rgba(){return this._outputs[0]}get rgb(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}get level(){return this._outputs[6]}get target(){if(this._fragmentOnly)return U.Fragment;if(!this.uv.isConnected||this.uv.sourceBlock.isInput)return U.VertexAndFragment;let e=this.uv.connectedPoint;for(;e;){if(e.target===U.Fragment)return U.Fragment;if(e.target===U.Vertex)return U.VertexAndFragment;if(e.target===U.Neutral||e.target===U.VertexAndFragment){const t=e.ownerBlock;if(t.target===U.Fragment)return U.Fragment;e=null;for(const i of t.inputs)if(i.connectedPoint){e=i.connectedPoint;break}}}return U.VertexAndFragment}set target(e){}autoConfigure(e){if(!this.uv.isConnected)if(e.mode===Ps.PostProcess){const t=e.getBlockByPredicate(i=>i.name==="uv");t&&t.connectTo(this)}else{const t=e.mode===Ps.Particle?"particle_uv":"uv";let i=e.getInputBlockByPredicate(s=>s.isAttribute&&s.name===t);i||(i=new Ye("uv"),i.setAsAttribute(t)),i.output.connectTo(this.uv)}}initializeDefines(e,t,i){!i._areTexturesDirty||this._mainUVDefineName!==void 0&&i.setValue(this._mainUVDefineName,!1,!0)}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;if(!this.texture||!this.texture.getTextureMatrix){this._isMixed&&(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0));return}const s=this.convertToGammaSpace&&this.texture&&!this.texture.gammaSpace,r=this.convertToLinearSpace&&this.texture&&this.texture.gammaSpace;i.setValue(this._linearDefineName,s,!0),i.setValue(this._gammaDefineName,r,!0),this._isMixed&&(this.texture.getTextureMatrix().isIdentityAs3x2()?(i.setValue(this._defineName,!1,!0),i.setValue(this._mainUVDefineName,!0,!0)):(i.setValue(this._defineName,!0),i[this._mainUVDefineName]==null&&i.setValue(this._mainUVDefineName,!1,!0)))}isReady(){return!(this.texture&&!this.texture.isReadyOrNotBlocking())}bind(e){!this.texture||(this._isMixed&&(e.setFloat(this._textureInfoName,this.texture.level),e.setMatrix(this._textureTransformName,this.texture.getTextureMatrix())),this._imageSource||e.setTexture(this._samplerName,this.texture))}get _isMixed(){return this.target!==U.Fragment}_injectVertexCode(e){const t=this.uv;if(this._defineName=e._getFreeDefineName("UVTRANSFORM"),this._mainUVDefineName="VMAIN"+t.associatedVariableName.toUpperCase(),this._mainUVName="vMain"+t.associatedVariableName,this._transformedUVName=e._getFreeVariableName("transformedUV"),this._textureTransformName=e._getFreeVariableName("textureTransform"),this._textureInfoName=e._getFreeVariableName("textureInfoName"),this.level.associatedVariableName=this._textureInfoName,e._emitVaryingFromString(this._transformedUVName,"vec2",this._defineName),e._emitVaryingFromString(this._mainUVName,"vec2",this._mainUVDefineName),e._emitUniformFromString(this._textureTransformName,"mat4",this._defineName),e.compilationString+=`#ifdef ${this._defineName}\r
`,e.compilationString+=`${this._transformedUVName} = vec2(${this._textureTransformName} * vec4(${t.associatedVariableName}.xy, 1.0, 0.0));\r
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r
`,e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,e.compilationString+=`#endif\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name,!0)}}_generateTextureLookup(e){const t=this.samplerName;e.compilationString+=`#ifdef ${this._defineName}\r
`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._transformedUVName});\r
`,e.compilationString+=`#elif defined(${this._mainUVDefineName})\r
`,e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${t}, ${this._mainUVName?this._mainUVName:this.uv.associatedVariableName});\r
`,e.compilationString+=`#endif\r
`}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===U.Fragment)return;this._generateTextureLookup(e);return}if(this.uv.ownerBlock.target===U.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this.samplerName}, ${i.associatedVariableName});\r
`;return}this._generateTextureLookup(e)}_generateConversionCode(e,t,i){i!=="a"&&((!this.texture||!this.texture.gammaSpace)&&(e.compilationString+=`#ifdef ${this._linearDefineName}
                    ${t.associatedVariableName} = toGammaSpace(${t.associatedVariableName});
                    #endif
                `),e.compilationString+=`#ifdef ${this._gammaDefineName}
                ${t.associatedVariableName} = toLinearSpace(${t.associatedVariableName});
                #endif
            `)}_writeOutput(e,t,i,s=!1){if(s){if(e.target===U.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,this._generateConversionCode(e,t,i);return}if(this.uv.ownerBlock.target===U.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`,this._generateConversionCode(e,t,i);return}let r="";this.disableLevelMultiplication||(r=` * ${this._textureInfoName}`),e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i}${r};\r
`,this._generateConversionCode(e,t,i)}_buildBlock(e){if(super._buildBlock(e),this.source.isConnected?this._imageSource=this.source.connectedPoint.ownerBlock:this._imageSource=null,(e.target===U.Vertex||this._fragmentOnly||e.target===U.Fragment&&this._tempTextureRead===void 0)&&(this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),this._linearDefineName=e._getFreeDefineName("ISLINEAR"),this._gammaDefineName=e._getFreeDefineName("ISGAMMA")),(!this._isMixed&&e.target===U.Fragment||this._isMixed&&e.target===U.Vertex)&&(this._imageSource||(this._samplerName=e._getFreeVariableName(this.name+"Sampler"),e._emit2DSampler(this._samplerName)),e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this)),e.target!==U.Fragment){this._injectVertexCode(e);return}if(!this._outputs.some(i=>i.isConnectedInFragmentShader))return;this._isMixed&&!this._imageSource&&e._emit2DSampler(this._samplerName);const t=`//${this.name}`;e._emitFunctionFromInclude("helperFunctions",t),this._isMixed&&e._emitUniformFromString(this._textureInfoName,"float"),this._writeTextureRead(e);for(const i of this._outputs)i.hasEndpoints&&i.name!=="level"&&this._writeOutput(e,i,i.name);return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.convertToGammaSpace = ${this.convertToGammaSpace};\r
`,e+=`${this._codeVariableName}.convertToLinearSpace = ${this.convertToLinearSpace};\r
`,e+=`${this._codeVariableName}.disableLevelMultiplication = ${this.disableLevelMultiplication};\r
`,this.texture&&(e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null, ${this.texture.noMipmap}, ${this.texture.invertY}, ${this.texture.samplingMode});\r
`,e+=`${this._codeVariableName}.texture.wrapU = ${this.texture.wrapU};\r
`,e+=`${this._codeVariableName}.texture.wrapV = ${this.texture.wrapV};\r
`,e+=`${this._codeVariableName}.texture.uAng = ${this.texture.uAng};\r
`,e+=`${this._codeVariableName}.texture.vAng = ${this.texture.vAng};\r
`,e+=`${this._codeVariableName}.texture.wAng = ${this.texture.wAng};\r
`,e+=`${this._codeVariableName}.texture.uOffset = ${this.texture.uOffset};\r
`,e+=`${this._codeVariableName}.texture.vOffset = ${this.texture.vOffset};\r
`,e+=`${this._codeVariableName}.texture.uScale = ${this.texture.uScale};\r
`,e+=`${this._codeVariableName}.texture.vScale = ${this.texture.vScale};\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e}serialize(){const e=super.serialize();return e.convertToGammaSpace=this.convertToGammaSpace,e.convertToLinearSpace=this.convertToLinearSpace,e.fragmentOnly=this._fragmentOnly,e.disableLevelMultiplication=this.disableLevelMultiplication,!this.hasImageSource&&this.texture&&!this.texture.isRenderTarget&&this.texture.getClassName()!=="VideoTexture"&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),this.convertToGammaSpace=e.convertToGammaSpace,this.convertToLinearSpace=!!e.convertToLinearSpace,this._fragmentOnly=!!e.fragmentOnly,this.disableLevelMultiplication=!!e.disableLevelMultiplication,e.texture&&!di.IgnoreTexturesAtLoadTime&&e.texture.url!==void 0&&(i=e.texture.url.indexOf("data:")===0?"":i,this.texture=H.Parse(e.texture,t,i))}}he("BABYLON.TextureBlock",VR);class p0 extends Ie{constructor(e){super(e,U.VertexAndFragment)}get texture(){return this._texture}set texture(e){var t;if(this._texture===e)return;const i=(t=e==null?void 0:e.getScene())!==null&&t!==void 0?t:ye.LastCreatedScene;!e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(this._texture)),this._texture=e,e&&i&&i.markAllMaterialsAsDirty(1,s=>s.hasTexture(e))}getClassName(){return"ReflectionTextureBaseBlock"}_getTexture(){return this.texture}autoConfigure(e){if(!this.position.isConnected){let t=e.getInputBlockByPredicate(i=>i.isAttribute&&i.name==="position");t||(t=new Ye("position"),t.setAsAttribute()),t.output.connectTo(this.position)}if(!this.world.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.World);t||(t=new Ye("world"),t.setAsSystemValue(Ke.World)),t.output.connectTo(this.world)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.View);t||(t=new Ye("view"),t.setAsSystemValue(Ke.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){if(!i._areTexturesDirty)return;const s=this._getTexture();!s||!s.getTextureMatrix||(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLocalCubicName,!!s.boundingBoxSize,!0),i.setValue(this._defineExplicitName,s.coordinatesMode===0,!0),i.setValue(this._defineSkyboxName,s.coordinatesMode===5,!0),i.setValue(this._defineCubicName,s.coordinatesMode===3||s.coordinatesMode===6,!0),i.setValue("INVERTCUBICMAP",s.coordinatesMode===6,!0),i.setValue(this._defineSphericalName,s.coordinatesMode===1,!0),i.setValue(this._definePlanarName,s.coordinatesMode===2,!0),i.setValue(this._defineProjectionName,s.coordinatesMode===4,!0),i.setValue(this._defineEquirectangularName,s.coordinatesMode===7,!0),i.setValue(this._defineEquirectangularFixedName,s.coordinatesMode===8,!0),i.setValue(this._defineMirroredEquirectangularFixedName,s.coordinatesMode===9,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){const s=this._getTexture();if(!(!i||!s)&&(e.setMatrix(this._reflectionMatrixName,s.getReflectionTextureMatrix()),s.isCube?e.setTexture(this._cubeSamplerName,s):e.setTexture(this._2DSamplerName,s),s.boundingBoxSize)){const r=s;e.setVector3(this._reflectionPositionName,r.boundingBoxPosition),e.setVector3(this._reflectionSizeName,r.boundingBoxSize)}}handleVertexSide(e){this._define3DName=e._getFreeDefineName("REFLECTIONMAP_3D"),this._defineCubicName=e._getFreeDefineName("REFLECTIONMAP_CUBIC"),this._defineSphericalName=e._getFreeDefineName("REFLECTIONMAP_SPHERICAL"),this._definePlanarName=e._getFreeDefineName("REFLECTIONMAP_PLANAR"),this._defineProjectionName=e._getFreeDefineName("REFLECTIONMAP_PROJECTION"),this._defineExplicitName=e._getFreeDefineName("REFLECTIONMAP_EXPLICIT"),this._defineEquirectangularName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR"),this._defineLocalCubicName=e._getFreeDefineName("USE_LOCAL_REFLECTIONMAP_CUBIC"),this._defineMirroredEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_MIRROREDEQUIRECTANGULAR_FIXED"),this._defineEquirectangularFixedName=e._getFreeDefineName("REFLECTIONMAP_EQUIRECTANGULAR_FIXED"),this._defineSkyboxName=e._getFreeDefineName("REFLECTIONMAP_SKYBOX"),this._defineOppositeZ=e._getFreeDefineName("REFLECTIONMAP_OPPOSITEZ"),this._reflectionMatrixName=e._getFreeVariableName("reflectionMatrix"),e._emitUniformFromString(this._reflectionMatrixName,"mat4");let t="";const i="v_"+this.worldPosition.associatedVariableName;return e._emitVaryingFromString(i,"vec4")&&(t+=`${i} = ${this.worldPosition.associatedVariableName};\r
`),this._positionUVWName=e._getFreeVariableName("positionUVW"),this._directionWName=e._getFreeVariableName("directionW"),e._emitVaryingFromString(this._positionUVWName,"vec3",this._defineSkyboxName)&&(t+=`#ifdef ${this._defineSkyboxName}\r
`,t+=`${this._positionUVWName} = ${this.position.associatedVariableName}.xyz;\r
`,t+=`#endif\r
`),e._emitVaryingFromString(this._directionWName,"vec3",`defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})`)&&(t+=`#if defined(${this._defineEquirectangularFixedName}) || defined(${this._defineMirroredEquirectangularFixedName})\r
`,t+=`${this._directionWName} = normalize(vec3(${this.world.associatedVariableName} * vec4(${this.position.associatedVariableName}.xyz, 0.0)));\r
`,t+=`#endif\r
`),t}handleFragmentSideInits(e){e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r
`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this);const t=`//${this.name}`;e._emitFunction("ReciprocalPI","#define RECIPROCAL_PI2 0.15915494",""),e._emitFunctionFromInclude("helperFunctions",t),e._emitFunctionFromInclude("reflectionFunction",t,{replaceStrings:[{search:/vec3 computeReflectionCoords/g,replace:"void DUMMYFUNC"}]}),this._reflectionColorName=e._getFreeVariableName("reflectionColor"),this._reflectionVectorName=e._getFreeVariableName("reflectionUVW"),this._reflectionCoordsName=e._getFreeVariableName("reflectionCoords"),this._reflectionPositionName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionPositionName,"vec3"),this._reflectionSizeName=e._getFreeVariableName("vReflectionPosition"),e._emitUniformFromString(this._reflectionSizeName,"vec3")}handleFragmentSideCodeReflectionCoords(e,t,i=!1,s=!1){t||(t=`v_${this.worldPosition.associatedVariableName}`);const r=this._reflectionMatrixName,n=`normalize(${this._directionWName})`,o=`${this._positionUVWName}`,l=`${this.cameraPosition.associatedVariableName}`,h=`${this.view.associatedVariableName}`;e+=".xyz";let c=`
            #ifdef ${this._defineMirroredEquirectangularFixedName}
                vec3 ${this._reflectionVectorName} = computeMirroredFixedEquirectangularCoords(${t}, ${e}, ${n});
            #endif

            #ifdef ${this._defineEquirectangularFixedName}
                vec3 ${this._reflectionVectorName} = computeFixedEquirectangularCoords(${t}, ${e}, ${n});
            #endif

            #ifdef ${this._defineEquirectangularName}
                vec3 ${this._reflectionVectorName} = computeEquirectangularCoords(${t}, ${e}, ${l}.xyz, ${r});
            #endif

            #ifdef ${this._defineSphericalName}
                vec3 ${this._reflectionVectorName} = computeSphericalCoords(${t}, ${e}, ${h}, ${r});
            #endif

            #ifdef ${this._definePlanarName}
                vec3 ${this._reflectionVectorName} = computePlanarCoords(${t}, ${e}, ${l}.xyz, ${r});
            #endif

            #ifdef ${this._defineCubicName}
                #ifdef ${this._defineLocalCubicName}
                    vec3 ${this._reflectionVectorName} = computeCubicLocalCoords(${t}, ${e}, ${l}.xyz, ${r}, ${this._reflectionSizeName}, ${this._reflectionPositionName});
                #else
                vec3 ${this._reflectionVectorName} = computeCubicCoords(${t}, ${e}, ${l}.xyz, ${r});
                #endif
            #endif

            #ifdef ${this._defineProjectionName}
                vec3 ${this._reflectionVectorName} = computeProjectionCoords(${t}, ${h}, ${r});
            #endif

            #ifdef ${this._defineSkyboxName}
                vec3 ${this._reflectionVectorName} = computeSkyBoxCoords(${o}, ${r});
            #endif

            #ifdef ${this._defineExplicitName}
                vec3 ${this._reflectionVectorName} = vec3(0, 0, 0);
            #endif\r
`;return s||(c+=`#ifdef ${this._defineOppositeZ}
                ${this._reflectionVectorName}.z *= -1.0;
            #endif\r
`),i||(c+=`
                #ifdef ${this._define3DName}
                    vec3 ${this._reflectionCoordsName} = ${this._reflectionVectorName};
                #else
                    vec2 ${this._reflectionCoordsName} = ${this._reflectionVectorName}.xy;
                    #ifdef ${this._defineProjectionName}
                        ${this._reflectionCoordsName} /= ${this._reflectionVectorName}.z;
                    #endif
                    ${this._reflectionCoordsName}.y = 1.0 - ${this._reflectionCoordsName}.y;
                #endif\r
`),c}handleFragmentSideCodeReflectionColor(e,t=".rgb"){let s=`${"vec"+(t.length===0?"4":t.length-1)} ${this._reflectionColorName};
            #ifdef ${this._define3DName}\r
`;return e?s+=`${this._reflectionColorName} = textureCubeLodEXT(${this._cubeSamplerName}, ${this._reflectionVectorName}, ${e})${t};\r
`:s+=`${this._reflectionColorName} = textureCube(${this._cubeSamplerName}, ${this._reflectionVectorName})${t};\r
`,s+=`
            #else\r
`,e?s+=`${this._reflectionColorName} = texture2DLodEXT(${this._2DSamplerName}, ${this._reflectionCoordsName}, ${e})${t};\r
`:s+=`${this._reflectionColorName} = texture2D(${this._2DSamplerName}, ${this._reflectionCoordsName})${t};\r
`,s+=`#endif\r
`,s}writeOutputs(e,t){let i="";if(e.target===U.Fragment)for(const s of this._outputs)s.hasEndpoints&&(i+=`${this._declareOutput(s,e)} = ${t}.${s.name};\r
`);return i}_buildBlock(e){return super._buildBlock(e),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();if(!this.texture)return e;if(this.texture.isCube){const t=this.texture.forcedExtension;e+=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}", undefined, undefined, ${this.texture.noMipmap}, null, undefined, undefined, undefined, ${this.texture._prefiltered}, ${t?'"'+t+'"':"null"});\r
`}else e+=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}", null);\r
`;return e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=Xi.Parse(e.texture,t,i):this.texture=H.Parse(e.texture,t,i))}}he("BABYLON.ReflectionTextureBaseBlock",p0);class kR extends p0{constructor(e){super(e),this.registerInput("position",I.Vector3,!1,U.Vertex),this.registerInput("worldPosition",I.Vector4,!1,U.Vertex),this.registerInput("worldNormal",I.Vector4,!1,U.Fragment),this.registerInput("world",I.Matrix,!1,U.Vertex),this.registerInput("cameraPosition",I.Vector3,!1,U.Fragment),this.registerInput("view",I.Matrix,!1,U.Fragment),this.registerOutput("rgb",I.Color3,U.Fragment),this.registerOutput("rgba",I.Color4,U.Fragment),this.registerOutput("r",I.Float,U.Fragment),this.registerOutput("g",I.Float,U.Fragment),this.registerOutput("b",I.Float,U.Fragment),this.registerOutput("a",I.Float,U.Fragment),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4)}getClassName(){return"ReflectionTextureBlock"}get position(){return this._inputs[0]}get worldPosition(){return this._inputs[1]}get worldNormal(){return this._inputs[2]}get world(){return this._inputs[3]}get cameraPosition(){return this._inputs[4]}get view(){return this._inputs[5]}get rgb(){return this._outputs[0]}get rgba(){return this._outputs[1]}get r(){return this._outputs[2]}get g(){return this._outputs[3]}get b(){return this._outputs[4]}get a(){return this._outputs[5]}autoConfigure(e){if(super.autoConfigure(e),!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.CameraPosition);t||(t=new Ye("cameraPosition"),t.setAsSystemValue(Ke.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){if(super._buildBlock(e),!this.texture)return e.compilationString+=this.writeOutputs(e,"vec4(0.)"),this;if(e.target!==U.Fragment)return e.compilationString+=this.handleVertexSide(e),this;this.handleFragmentSideInits(e);const t=e._getFreeVariableName("normalWUnit");return e.compilationString+=`vec4 ${t} = normalize(${this.worldNormal.associatedVariableName});\r
`,e.compilationString+=this.handleFragmentSideCodeReflectionCoords(t),e.compilationString+=this.handleFragmentSideCodeReflectionColor(void 0,""),e.compilationString+=this.writeOutputs(e,this._reflectionColorName),this}}he("BABYLON.ReflectionTextureBlock",kR);class _0 extends Ie{constructor(e){super(e,U.VertexAndFragment),this.useNonLinearDepth=!1,this.force32itsFloat=!1,this._isUnique=!0,this.registerInput("uv",I.Vector2,!1,U.VertexAndFragment),this.registerOutput("depth",I.Float,U.Neutral),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0]._prioritizeVertex=!1}getClassName(){return"SceneDepthBlock"}get uv(){return this._inputs[0]}get depth(){return this._outputs[0]}initialize(e){e._excludeVariableName("textureSampler")}get target(){return!this.uv.isConnected||this.uv.sourceBlock.isInput?U.VertexAndFragment:U.Fragment}_getTexture(e){return e.enableDepthRenderer(void 0,this.useNonLinearDepth,this.force32itsFloat).getDepthMap()}bind(e,t){const i=this._getTexture(t.getScene());e.setTexture(this._samplerName,i)}_injectVertexCode(e){const t=this.uv;if(t.connectedPoint.ownerBlock.isInput&&(t.connectedPoint.ownerBlock.isAttribute||e._emitUniformFromString(t.associatedVariableName,"vec"+(t.type===I.Vector3?"3":t.type===I.Vector4?"4":"2"))),this._mainUVName="vMain"+t.associatedVariableName,e._emitVaryingFromString(this._mainUVName,"vec2"),e.compilationString+=`${this._mainUVName} = ${t.associatedVariableName}.xy;\r
`,!!this._outputs.some(i=>i.isConnectedInVertexShader)){this._writeTextureRead(e,!0);for(const i of this._outputs)i.hasEndpoints&&this._writeOutput(e,i,"r",!0)}}_writeTextureRead(e,t=!1){const i=this.uv;if(t){if(e.target===U.Fragment)return;e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r
`;return}if(this.uv.ownerBlock.target===U.Fragment){e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${i.associatedVariableName}.xy);\r
`;return}e.compilationString+=`vec4 ${this._tempTextureRead} = texture2D(${this._samplerName}, ${this._mainUVName});\r
`}_writeOutput(e,t,i,s=!1){if(s){if(e.target===U.Fragment)return;e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}if(this.uv.ownerBlock.target===U.Fragment){e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`;return}e.compilationString+=`${this._declareOutput(t,e)} = ${this._tempTextureRead}.${i};\r
`}_buildBlock(e){if(super._buildBlock(e),this._samplerName=e._getFreeVariableName(this.name+"Sampler"),this._tempTextureRead=e._getFreeVariableName("tempTextureRead"),e.sharedData.bindableBlocks.indexOf(this)<0&&e.sharedData.bindableBlocks.push(this),e.target!==U.Fragment){e._emit2DSampler(this._samplerName),this._injectVertexCode(e);return}if(!!this._outputs.some(t=>t.isConnectedInFragmentShader)){e._emit2DSampler(this._samplerName),this._writeTextureRead(e);for(const t of this._outputs)t.hasEndpoints&&this._writeOutput(e,t,"r");return this}}serialize(){const e=super.serialize();return e.useNonLinearDepth=this.useNonLinearDepth,e.force32itsFloat=this.force32itsFloat,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.useNonLinearDepth=e.useNonLinearDepth,this.force32itsFloat=e.force32itsFloat}}T([ft("Use non linear depth",at.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:a=>a.disableDepthRenderer()}})],_0.prototype,"useNonLinearDepth",void 0);T([ft("Force 32 bits float",at.Boolean,"ADVANCED",{notifiers:{activatePreviewCommand:!0,callback:a=>a.disableDepthRenderer()}})],_0.prototype,"force32itsFloat",void 0);he("BABYLON.SceneDepthBlock",_0);class GR extends Ie{constructor(e){super(e,U.VertexAndFragment,!0),this.registerInput("worldPosition",I.Vector4,!1)}getClassName(){return"ClipPlanesBlock"}initialize(e){e._excludeVariableName("vClipPlane"),e._excludeVariableName("fClipDistance"),e._excludeVariableName("vClipPlane2"),e._excludeVariableName("fClipDistance2"),e._excludeVariableName("vClipPlane3"),e._excludeVariableName("fClipDistance3"),e._excludeVariableName("vClipPlane4"),e._excludeVariableName("fClipDistance4"),e._excludeVariableName("vClipPlane5"),e._excludeVariableName("fClipDistance5"),e._excludeVariableName("vClipPlane6"),e._excludeVariableName("fClipDistance6")}get worldPosition(){return this._inputs[0]}get target(){return U.VertexAndFragment}set target(e){}prepareDefines(e,t,i){const s=e.getScene(),r=s.clipPlane!==void 0&&s.clipPlane!==null,n=s.clipPlane2!==void 0&&s.clipPlane2!==null,o=s.clipPlane3!==void 0&&s.clipPlane3!==null,l=s.clipPlane4!==void 0&&s.clipPlane4!==null,h=s.clipPlane5!==void 0&&s.clipPlane5!==null,c=s.clipPlane6!==void 0&&s.clipPlane6!==null;i.setValue("CLIPPLANE",r,!0),i.setValue("CLIPPLANE2",n,!0),i.setValue("CLIPPLANE3",o,!0),i.setValue("CLIPPLANE4",l,!0),i.setValue("CLIPPLANE5",h,!0),i.setValue("CLIPPLANE6",c,!0)}bind(e,t,i){if(!i)return;const s=i.getScene();se.BindClipPlane(e,s)}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;if(e.target!==U.Fragment){const i=this.worldPosition;e._emitFunctionFromInclude("clipPlaneVertexDeclaration",t,{replaceStrings:[{search:/uniform vec4 vClipPlane\d*;/g,replace:""}]}),e.compilationString+=e._emitCodeFromInclude("clipPlaneVertex",t,{replaceStrings:[{search:/worldPos/g,replace:i.associatedVariableName}]}),e._emitUniformFromString("vClipPlane","vec4"),e._emitUniformFromString("vClipPlane2","vec4"),e._emitUniformFromString("vClipPlane3","vec4"),e._emitUniformFromString("vClipPlane4","vec4"),e._emitUniformFromString("vClipPlane5","vec4"),e._emitUniformFromString("vClipPlane6","vec4");return}return e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e._emitFunctionFromInclude("clipPlaneFragmentDeclaration",t),e.compilationString+=e._emitCodeFromInclude("clipPlaneFragment",t),this}}he("BABYLON.ClipPlanesBlock",GR);class zR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"AddBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} + ${this.right.associatedVariableName};\r
`,this}}he("BABYLON.AddBlock",zR);class WR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("input",I.AutoDetect),this.registerInput("factor",I.Float),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ScaleBlock"}get input(){return this._inputs[0]}get factor(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} * ${this.factor.associatedVariableName};\r
`,this}}he("BABYLON.ScaleBlock",WR);class m0 extends Ie{constructor(e){super(e,U.Neutral),this.minimum=0,this.maximum=1,this.registerInput("value",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ClampBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = clamp(${this.value.associatedVariableName}, ${this._writeFloat(this.minimum)}, ${this._writeFloat(this.maximum)});\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode()+`${this._codeVariableName}.minimum = ${this.minimum};\r
`;return e+=`${this._codeVariableName}.maximum = ${this.maximum};\r
`,e}serialize(){const e=super.serialize();return e.minimum=this.minimum,e.maximum=this.maximum,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.minimum=e.minimum,this.maximum=e.maximum}}T([ft("Minimum",at.Float)],m0.prototype,"minimum",void 0);T([ft("Maximum",at.Float)],m0.prototype,"maximum",void 0);he("BABYLON.ClampBlock",m0);class HR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.Vector3),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix),this._inputs[0].excludedConnectionPointTypes.push(I.Vector2),this._inputs[1].excludedConnectionPointTypes.push(I.Float),this._inputs[1].excludedConnectionPointTypes.push(I.Matrix),this._inputs[1].excludedConnectionPointTypes.push(I.Vector2)}getClassName(){return"CrossBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = cross(${this.left.associatedVariableName}.xyz, ${this.right.associatedVariableName}.xyz);\r
`,this}}he("BABYLON.CrossBlock",HR);class XR extends Ie{constructor(e){super(e)}get options(){return this._options}set options(e){this._deserializeOptions(e)}getClassName(){return"CustomBlock"}_buildBlock(e){super._buildBlock(e);let t=this._code,i=this._options.functionName;this._inputs.forEach(r=>{const n=new RegExp("\\{TYPE_"+r.name+"\\}","gm"),o=e._getGLType(r.type);t=t.replace(n,o),i=i.replace(n,o)}),this._outputs.forEach(r=>{const n=new RegExp("\\{TYPE_"+r.name+"\\}","gm"),o=e._getGLType(r.type);t=t.replace(n,o),i=i.replace(n,o)}),e._emitFunction(i,t,""),this._outputs.forEach(r=>{e.compilationString+=this._declareOutput(r,e)+`;\r
`}),e.compilationString+=i+"(";let s=!1;return this._inputs.forEach((r,n)=>{n>0&&(e.compilationString+=", "),e.compilationString+=r.associatedVariableName,s=!0}),this._outputs.forEach((r,n)=>{(n>0||s)&&(e.compilationString+=", "),e.compilationString+=r.associatedVariableName}),e.compilationString+=`);\r
`,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.options = ${JSON.stringify(this._options)};\r
`,e}serialize(){const e=super.serialize();return e.options=this._options,e}_deserialize(e,t,i){this._deserializeOptions(e.options),super._deserialize(e,t,i)}_deserializeOptions(e){var t,i,s;this._options=e,this._code=e.code.join(`\r
`)+`\r
`,this.name=this.name||e.name,this.target=U[e.target],(t=e.inParameters)===null||t===void 0||t.forEach((r,n)=>{const o=I[r.type];this.registerInput(r.name,o),Object.defineProperty(this,r.name,{get:function(){return this._inputs[n]},enumerable:!0,configurable:!0})}),(i=e.outParameters)===null||i===void 0||i.forEach((r,n)=>{this.registerOutput(r.name,I[r.type]),Object.defineProperty(this,r.name,{get:function(){return this._outputs[n]},enumerable:!0,configurable:!0}),r.type==="BasedOnInput"&&(this._outputs[n]._typeConnectionSource=this._findInputByName(r.typeFromInput)[0])}),(s=e.inLinkedConnectionTypes)===null||s===void 0||s.forEach(r=>{this._linkConnectionTypes(this._findInputByName(r.input1)[1],this._findInputByName(r.input2)[1])})}_findInputByName(e){if(!e)return null;for(let t=0;t<this._inputs.length;t++)if(this._inputs[t].name===e)return[this._inputs[t],t];return null}}he("BABYLON.CustomBlock",XR);class YR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix),this._inputs[1].excludedConnectionPointTypes.push(I.Float),this._inputs[1].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"DotBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = dot(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}he("BABYLON.DotBlock",YR);class KR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("input",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"NormalizeBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${i.associatedVariableName});\r
`,this}}he("BABYLON.NormalizeBlock",KR);class $R extends Ie{constructor(e){super(e,U.Neutral),this.rSwizzle="r",this.gSwizzle="g",this.bSwizzle="b",this.aSwizzle="a",this.registerInput("rgb ",I.Color3,!0),this.registerInput("r",I.Float,!0),this.registerInput("g",I.Float,!0),this.registerInput("b",I.Float,!0),this.registerInput("a",I.Float,!0),this.registerOutput("rgba",I.Color4),this.registerOutput("rgb",I.Color3)}getClassName(){return"ColorMergerBlock"}get rgbIn(){return this._inputs[0]}get r(){return this._inputs[1]}get g(){return this._inputs[2]}get b(){return this._inputs[3]}get a(){return this._inputs[4]}get rgba(){return this._outputs[0]}get rgbOut(){return this._outputs[1]}get rgb(){return this.rgbOut}_inputRename(e){return e==="rgb "?"rgbIn":e}_buildSwizzle(e){const t=this.rSwizzle+this.gSwizzle+this.bSwizzle+this.aSwizzle;return"."+t.substr(0,e)}_buildBlock(e){super._buildBlock(e);const t=this.r,i=this.g,s=this.b,r=this.a,n=this.rgbIn,o=this._outputs[0],l=this._outputs[1];return n.isConnected?(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${n.associatedVariableName}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${n.associatedVariableName}${this._buildSwizzle(3)};\r
`)):(o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = vec4(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"}, ${r.isConnected?this._writeVariable(r):"0.0"})${this._buildSwizzle(4)};\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = vec3(${t.isConnected?this._writeVariable(t):"0.0"}, ${i.isConnected?this._writeVariable(i):"0.0"}, ${s.isConnected?this._writeVariable(s):"0.0"})${this._buildSwizzle(3)};\r
`)),this}serialize(){const e=super.serialize();return e.rSwizzle=this.rSwizzle,e.gSwizzle=this.gSwizzle,e.bSwizzle=this.bSwizzle,e.aSwizzle=this.aSwizzle,e}_deserialize(e,t,i){var s,r,n,o;super._deserialize(e,t,i),this.rSwizzle=(s=e.rSwizzle)!==null&&s!==void 0?s:"r",this.gSwizzle=(r=e.gSwizzle)!==null&&r!==void 0?r:"g",this.bSwizzle=(n=e.bSwizzle)!==null&&n!==void 0?n:"b",this.aSwizzle=(o=e.aSwizzle)!==null&&o!==void 0?o:"a"}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.rSwizzle = "${this.rSwizzle}";\r
`,e+=`${this._codeVariableName}.gSwizzle = "${this.gSwizzle}";\r
`,e+=`${this._codeVariableName}.bSwizzle = "${this.bSwizzle}";\r
`,e+=`${this._codeVariableName}.aSwizzle = "${this.aSwizzle}";\r
`,e}}he("BABYLON.ColorMergerBlock",$R);class jR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("xyzw",I.Vector4,!0),this.registerInput("xyz ",I.Vector3,!0),this.registerInput("xy ",I.Vector2,!0),this.registerOutput("xyz",I.Vector3),this.registerOutput("xy",I.Vector2),this.registerOutput("zw",I.Vector2),this.registerOutput("x",I.Float),this.registerOutput("y",I.Float),this.registerOutput("z",I.Float),this.registerOutput("w",I.Float),this.inputsAreExclusive=!0}getClassName(){return"VectorSplitterBlock"}get xyzw(){return this._inputs[0]}get xyzIn(){return this._inputs[1]}get xyIn(){return this._inputs[2]}get xyzOut(){return this._outputs[0]}get xyOut(){return this._outputs[1]}get zw(){return this._outputs[2]}get x(){return this._outputs[3]}get y(){return this._outputs[4]}get z(){return this._outputs[5]}get w(){return this._outputs[6]}_inputRename(e){switch(e){case"xy ":return"xyIn";case"xyz ":return"xyzIn";default:return e}}_outputRename(e){switch(e){case"xy":return"xyOut";case"xyz":return"xyzOut";default:return e}}_buildBlock(e){super._buildBlock(e);const t=this.xyzw.isConnected?this.xyzw:this.xyzIn.isConnected?this.xyzIn:this.xyIn,i=this._outputs[0],s=this._outputs[1],r=this._outputs[2],n=this._outputs[3],o=this._outputs[4],l=this._outputs[5],h=this._outputs[6];return i.hasEndpoints&&(t===this.xyIn?e.compilationString+=this._declareOutput(i,e)+` = vec3(${t.associatedVariableName}, 0.0);\r
`:e.compilationString+=this._declareOutput(i,e)+` = ${t.associatedVariableName}.xyz;\r
`),r.hasEndpoints&&this.xyzw.isConnected&&(e.compilationString+=this._declareOutput(r,e)+` = ${this.xyzw.associatedVariableName}.zw;\r
`),s.hasEndpoints&&(e.compilationString+=this._declareOutput(s,e)+` = ${t.associatedVariableName}.xy;\r
`),n.hasEndpoints&&(e.compilationString+=this._declareOutput(n,e)+` = ${t.associatedVariableName}.x;\r
`),o.hasEndpoints&&(e.compilationString+=this._declareOutput(o,e)+` = ${t.associatedVariableName}.y;\r
`),l.hasEndpoints&&(e.compilationString+=this._declareOutput(l,e)+` = ${t.associatedVariableName}.z;\r
`),h.hasEndpoints&&(e.compilationString+=this._declareOutput(h,e)+` = ${t.associatedVariableName}.w;\r
`),this}}he("BABYLON.VectorSplitterBlock",jR);class qR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerInput("gradient",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(I.Float)}getClassName(){return"LerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName});\r
`,this}}he("BABYLON.LerpBlock",qR);class QR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"DivideBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} / ${this.right.associatedVariableName};\r
`,this}}he("BABYLON.DivideBlock",QR);class ZR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"SubtractBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${this.left.associatedVariableName} - ${this.right.associatedVariableName};\r
`,this}}he("BABYLON.SubtractBlock",ZR);class JR extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.Float),this.registerInput("edge",I.Float),this.registerOutput("output",I.Float)}getClassName(){return"StepBlock"}get value(){return this._inputs[0]}get edge(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = step(${this.edge.associatedVariableName}, ${this.value.associatedVariableName});\r
`,this}}he("BABYLON.StepBlock",JR);class ym extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("input",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"OneMinusBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = 1. - ${this.input.associatedVariableName};\r
`,this}}he("BABYLON.OneMinusBlock",ym);he("BABYLON.OppositeBlock",ym);class Am extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("worldPosition",I.Vector4),this.registerInput("cameraPosition",I.Vector3),this.registerOutput("output",I.Vector3)}getClassName(){return"ViewDirectionBlock"}get worldPosition(){return this._inputs[0]}get cameraPosition(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.CameraPosition);t||(t=new Ye("cameraPosition"),t.setAsSystemValue(Ke.CameraPosition)),t.output.connectTo(this.cameraPosition)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(${this.cameraPosition.associatedVariableName} - ${this.worldPosition.associatedVariableName}.xyz);\r
`,this}}he("BABYLON.ViewDirectionBlock",Am);class eI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("worldNormal",I.Vector4),this.registerInput("viewDirection",I.Vector3),this.registerInput("bias",I.Float),this.registerInput("power",I.Float),this.registerOutput("fresnel",I.Float)}getClassName(){return"FresnelBlock"}get worldNormal(){return this._inputs[0]}get viewDirection(){return this._inputs[1]}get bias(){return this._inputs[2]}get power(){return this._inputs[3]}get fresnel(){return this._outputs[0]}autoConfigure(e){if(!this.viewDirection.isConnected){const t=new Am("View direction");t.output.connectTo(this.viewDirection),t.autoConfigure(e)}if(!this.bias.isConnected){const t=new Ye("bias");t.value=0,t.output.connectTo(this.bias)}if(!this.power.isConnected){const t=new Ye("power");t.value=1,t.output.connectTo(this.power)}}_buildBlock(e){super._buildBlock(e);const t=`//${this.name}`;return e._emitFunctionFromInclude("fresnelFunction",t,{removeIfDef:!0}),e.compilationString+=this._declareOutput(this.fresnel,e)+` = computeFresnelTerm(${this.viewDirection.associatedVariableName}.xyz, ${this.worldNormal.associatedVariableName}.xyz, ${this.bias.associatedVariableName}, ${this.power.associatedVariableName});\r
`,this}}he("BABYLON.FresnelBlock",eI);class tI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MaxBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = max(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}he("BABYLON.MaxBlock",tI);class iI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"MinBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = min(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}he("BABYLON.MinBlock",iI);class sI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.Float),this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix),this._inputs[1].excludedConnectionPointTypes.push(I.Float),this._inputs[1].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"DistanceBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.left.associatedVariableName} - ${this.right.associatedVariableName});\r
`,this}}he("BABYLON.DistanceBlock",sI);class rI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.AutoDetect),this.registerOutput("output",I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"LengthBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = length(${this.value.associatedVariableName});\r
`,this}}he("BABYLON.LengthBlock",rI);class nI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"NegateBlock"}get value(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = -1.0 * ${this.value.associatedVariableName};\r
`,this}}he("BABYLON.NegateBlock",nI);class aI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.AutoDetect),this.registerInput("power",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"PowBlock"}get value(){return this._inputs[0]}get power(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = pow(${this.value.associatedVariableName}, ${this.power.associatedVariableName});\r
`,this}}he("BABYLON.PowBlock",aI);class oI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("seed",I.Vector2),this.registerOutput("output",I.Float),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0].acceptedConnectionPointTypes.push(I.Color3),this._inputs[0].acceptedConnectionPointTypes.push(I.Color4)}getClassName(){return"RandomNumberBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=`//${this.name}`;return e._emitFunctionFromInclude("helperFunctions",i),e.compilationString+=this._declareOutput(t,e)+` = getRand(${this.seed.associatedVariableName}.xy);\r
`,this}}he("BABYLON.RandomNumberBlock",oI);class lI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("x",I.Float),this.registerInput("y",I.Float),this.registerOutput("output",I.Float)}getClassName(){return"ArcTan2Block"}get x(){return this._inputs[0]}get y(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = atan(${this.x.associatedVariableName}, ${this.y.associatedVariableName});\r
`,this}}he("BABYLON.ArcTan2Block",lI);class hI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.AutoDetect),this.registerInput("edge0",I.Float),this.registerInput("edge1",I.Float),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"SmoothStepBlock"}get value(){return this._inputs[0]}get edge0(){return this._inputs[1]}get edge1(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = smoothstep(${this.edge0.associatedVariableName}, ${this.edge1.associatedVariableName}, ${this.value.associatedVariableName});\r
`,this}}he("BABYLON.SmoothStepBlock",hI);class cI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("input",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._outputs[0].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"ReciprocalBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = 1. / ${this.input.associatedVariableName};\r
`,this}}he("BABYLON.ReciprocalBlock",cI);class uI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.AutoDetect),this.registerInput("reference",I.AutoDetect),this.registerInput("distance",I.Float),this.registerInput("replacement",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(0,3),this._inputs[0].excludedConnectionPointTypes.push(I.Float),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix),this._inputs[1].excludedConnectionPointTypes.push(I.Float),this._inputs[1].excludedConnectionPointTypes.push(I.Matrix),this._inputs[3].excludedConnectionPointTypes.push(I.Float),this._inputs[3].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"ReplaceColorBlock"}get value(){return this._inputs[0]}get reference(){return this._inputs[1]}get distance(){return this._inputs[2]}get replacement(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+=`if (length(${this.value.associatedVariableName} - ${this.reference.associatedVariableName}) < ${this.distance.associatedVariableName}) {\r
`,e.compilationString+=`${t.associatedVariableName} = ${this.replacement.associatedVariableName};\r
`,e.compilationString+=`} else {\r
`,e.compilationString+=`${t.associatedVariableName} = ${this.value.associatedVariableName};\r
`,e.compilationString+=`}\r
`,this}}he("BABYLON.ReplaceColorBlock",uI);class dI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("value",I.AutoDetect),this.registerInput("steps",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._inputs[0].excludedConnectionPointTypes.push(I.Matrix),this._inputs[1].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"PosterizeBlock"}get value(){return this._inputs[0]}get steps(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = floor(${this.value.associatedVariableName} / (1.0 / ${this.steps.associatedVariableName})) * (1.0 / ${this.steps.associatedVariableName});\r
`,this}}he("BABYLON.PosterizeBlock",dI);var po;(function(a){a[a.SawTooth=0]="SawTooth",a[a.Square=1]="Square",a[a.Triangle=2]="Triangle"})(po||(po={}));class fI extends Ie{constructor(e){super(e,U.Neutral),this.kind=po.SawTooth,this.registerInput("input",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._inputs[0].excludedConnectionPointTypes.push(I.Matrix)}getClassName(){return"WaveBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];switch(this.kind){case po.SawTooth:{e.compilationString+=this._declareOutput(t,e)+` = ${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName});\r
`;break}case po.Square:{e.compilationString+=this._declareOutput(t,e)+` = 1.0 - 2.0 * round(fract(${this.input.associatedVariableName}));\r
`;break}case po.Triangle:{e.compilationString+=this._declareOutput(t,e)+` = 2.0 * abs(2.0 * (${this.input.associatedVariableName} - floor(0.5 + ${this.input.associatedVariableName}))) - 1.0;\r
`;break}}return this}serialize(){const e=super.serialize();return e.kind=this.kind,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.kind=e.kind}}he("BABYLON.WaveBlock",fI);class Lu{constructor(e,t){this.step=e,this.color=t}get step(){return this._step}set step(e){this._step=e}get color(){return this._color}set color(e){this._color=e}}class pI extends Ie{constructor(e){super(e,U.Neutral),this.colorSteps=[new Lu(0,re.Black()),new Lu(1,re.White())],this.onValueChangedObservable=new X,this.registerInput("gradient",I.Float),this.registerOutput("output",I.Color3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0].acceptedConnectionPointTypes.push(I.Color3),this._inputs[0].acceptedConnectionPointTypes.push(I.Color4)}colorStepsUpdated(){this.onValueChangedObservable.notifyObservers(this)}getClassName(){return"GradientBlock"}get gradient(){return this._inputs[0]}get output(){return this._outputs[0]}_writeColorConstant(e){const t=this.colorSteps[e];return`vec3(${t.color.r}, ${t.color.g}, ${t.color.b})`}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];if(!this.colorSteps.length||!this.gradient.connectedPoint){e.compilationString+=this._declareOutput(t,e)+` = vec3(0., 0., 0.);\r
`;return}const i=e._getFreeVariableName("gradientTempColor"),s=e._getFreeVariableName("gradientTempPosition");e.compilationString+=`vec3 ${i} = ${this._writeColorConstant(0)};\r
`,e.compilationString+=`float ${s};\r
`;let r=this.gradient.associatedVariableName;this.gradient.connectedPoint.type!==I.Float&&(r+=".x");for(let n=1;n<this.colorSteps.length;n++){const o=this.colorSteps[n],l=this.colorSteps[n-1];e.compilationString+=`${s} = clamp((${r} - ${e._emitFloat(l.step)}) / (${e._emitFloat(o.step)} -  ${e._emitFloat(l.step)}), 0.0, 1.0) * step(${e._emitFloat(n)}, ${e._emitFloat(this.colorSteps.length-1)});\r
`,e.compilationString+=`${i} = mix(${i}, ${this._writeColorConstant(n)}, ${s});\r
`}return e.compilationString+=this._declareOutput(t,e)+` = ${i};\r
`,this}serialize(){const e=super.serialize();e.colorSteps=[];for(const t of this.colorSteps)e.colorSteps.push({step:t.step,color:{r:t.color.r,g:t.color.g,b:t.color.b}});return e}_deserialize(e,t,i){super._deserialize(e,t,i),this.colorSteps.length=0;for(const s of e.colorSteps)this.colorSteps.push(new Lu(s.step,new re(s.color.r,s.color.g,s.color.b)))}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();e+=`${this._codeVariableName}.colorSteps = [];\r
`;for(const t of this.colorSteps)e+=`${this._codeVariableName}.colorSteps.push(new BABYLON.GradientBlockColorStep(${t.step}, new BABYLON.Color3(${t.color.r}, ${t.color.g}, ${t.color.b})));\r
`;return e}}he("BABYLON.GradientBlock",pI);class _I extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerInput("gradient",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1),this._linkConnectionTypes(1,2,!0),this._inputs[2].acceptedConnectionPointTypes.push(I.Float)}getClassName(){return"NLerpBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get gradient(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = normalize(mix(${this.left.associatedVariableName} , ${this.right.associatedVariableName}, ${this.gradient.associatedVariableName}));\r
`,this}}he("BABYLON.NLerpBlock",_I);class Rm extends Ie{constructor(e){super(e,U.Neutral),this.manhattanDistance=!1,this.registerInput("seed",I.Vector3),this.registerInput("jitter",I.Float),this.registerOutput("output",I.Vector2),this.registerOutput("x",I.Float),this.registerOutput("y",I.Float)}getClassName(){return"WorleyNoise3DBlock"}get seed(){return this._inputs[0]}get jitter(){return this._inputs[1]}get output(){return this._outputs[0]}get x(){return this._outputs[1]}get y(){return this._outputs[2]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this.output.hasEndpoints&&!this.x.hasEndpoints&&!this.y.hasEndpoints)return;let t=`vec3 permute(vec3 x){\r
`;t+=`    return mod((34.0 * x + 1.0) * x, 289.0);\r
`,t+=`}\r
\r
`,t+=`vec3 dist(vec3 x, vec3 y, vec3 z,  bool manhattanDistance){\r
`,t+=`    return manhattanDistance ?  abs(x) + abs(y) + abs(z) :  (x * x + y * y + z * z);\r
`,t+=`}\r
\r
`,t+=`vec2 worley(vec3 P, float jitter, bool manhattanDistance){\r
`,t+=`    float K = 0.142857142857; // 1/7\r
`,t+=`    float Ko = 0.428571428571; // 1/2-K/2\r
`,t+=`    float  K2 = 0.020408163265306; // 1/(7*7)\r
`,t+=`    float Kz = 0.166666666667; // 1/6\r
`,t+=`    float Kzo = 0.416666666667; // 1/2-1/6*2\r
`,t+=`\r
`,t+=`    vec3 Pi = mod(floor(P), 289.0);\r
`,t+=`    vec3 Pf = fract(P) - 0.5;\r
`,t+=`\r
`,t+=`    vec3 Pfx = Pf.x + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfy = Pf.y + vec3(1.0, 0.0, -1.0);\r
`,t+=`    vec3 Pfz = Pf.z + vec3(1.0, 0.0, -1.0);\r
`,t+=`\r
`,t+=`    vec3 p = permute(Pi.x + vec3(-1.0, 0.0, 1.0));\r
`,t+=`    vec3 p1 = permute(p + Pi.y - 1.0);\r
`,t+=`    vec3 p2 = permute(p + Pi.y);\r
`,t+=`    vec3 p3 = permute(p + Pi.y + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p11 = permute(p1 + Pi.z - 1.0);\r
`,t+=`    vec3 p12 = permute(p1 + Pi.z);\r
`,t+=`    vec3 p13 = permute(p1 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p21 = permute(p2 + Pi.z - 1.0);\r
`,t+=`    vec3 p22 = permute(p2 + Pi.z);\r
`,t+=`    vec3 p23 = permute(p2 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 p31 = permute(p3 + Pi.z - 1.0);\r
`,t+=`    vec3 p32 = permute(p3 + Pi.z);\r
`,t+=`    vec3 p33 = permute(p3 + Pi.z + 1.0);\r
`,t+=`\r
`,t+=`    vec3 ox11 = fract(p11*K) - Ko;\r
`,t+=`    vec3 oy11 = mod(floor(p11*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz11 = floor(p11*K2)*Kz - Kzo; // p11 < 289 guaranteed\r
`,t+=`\r
`,t+=`    vec3 ox12 = fract(p12*K) - Ko;\r
`,t+=`    vec3 oy12 = mod(floor(p12*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz12 = floor(p12*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox13 = fract(p13*K) - Ko;\r
`,t+=`    vec3 oy13 = mod(floor(p13*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz13 = floor(p13*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox21 = fract(p21*K) - Ko;\r
`,t+=`    vec3 oy21 = mod(floor(p21*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz21 = floor(p21*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox22 = fract(p22*K) - Ko;\r
`,t+=`    vec3 oy22 = mod(floor(p22*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz22 = floor(p22*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox23 = fract(p23*K) - Ko;\r
`,t+=`    vec3 oy23 = mod(floor(p23*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz23 = floor(p23*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox31 = fract(p31*K) - Ko;\r
`,t+=`    vec3 oy31 = mod(floor(p31*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz31 = floor(p31*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox32 = fract(p32*K) - Ko;\r
`,t+=`    vec3 oy32 = mod(floor(p32*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz32 = floor(p32*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 ox33 = fract(p33*K) - Ko;\r
`,t+=`    vec3 oy33 = mod(floor(p33*K), 7.0)*K - Ko;\r
`,t+=`    vec3 oz33 = floor(p33*K2)*Kz - Kzo;\r
`,t+=`\r
`,t+=`    vec3 dx11 = Pfx + jitter*ox11;\r
`,t+=`    vec3 dy11 = Pfy.x + jitter*oy11;\r
`,t+=`    vec3 dz11 = Pfz.x + jitter*oz11;\r
`,t+=`\r
`,t+=`    vec3 dx12 = Pfx + jitter*ox12;\r
`,t+=`    vec3 dy12 = Pfy.x + jitter*oy12;\r
`,t+=`    vec3 dz12 = Pfz.y + jitter*oz12;\r
`,t+=`\r
`,t+=`    vec3 dx13 = Pfx + jitter*ox13;\r
`,t+=`    vec3 dy13 = Pfy.x + jitter*oy13;\r
`,t+=`    vec3 dz13 = Pfz.z + jitter*oz13;\r
`,t+=`\r
`,t+=`    vec3 dx21 = Pfx + jitter*ox21;\r
`,t+=`    vec3 dy21 = Pfy.y + jitter*oy21;\r
`,t+=`    vec3 dz21 = Pfz.x + jitter*oz21;\r
`,t+=`\r
`,t+=`    vec3 dx22 = Pfx + jitter*ox22;\r
`,t+=`    vec3 dy22 = Pfy.y + jitter*oy22;\r
`,t+=`    vec3 dz22 = Pfz.y + jitter*oz22;\r
`,t+=`\r
`,t+=`    vec3 dx23 = Pfx + jitter*ox23;\r
`,t+=`    vec3 dy23 = Pfy.y + jitter*oy23;\r
`,t+=`    vec3 dz23 = Pfz.z + jitter*oz23;\r
`,t+=`\r
`,t+=`    vec3 dx31 = Pfx + jitter*ox31;\r
`,t+=`    vec3 dy31 = Pfy.z + jitter*oy31;\r
`,t+=`    vec3 dz31 = Pfz.x + jitter*oz31;\r
`,t+=`\r
`,t+=`    vec3 dx32 = Pfx + jitter*ox32;\r
`,t+=`    vec3 dy32 = Pfy.z + jitter*oy32;\r
`,t+=`    vec3 dz32 = Pfz.y + jitter*oz32;\r
`,t+=`\r
`,t+=`    vec3 dx33 = Pfx + jitter*ox33;\r
`,t+=`    vec3 dy33 = Pfy.z + jitter*oy33;\r
`,t+=`    vec3 dz33 = Pfz.z + jitter*oz33;\r
`,t+=`\r
`,t+=`    vec3 d11 = dist(dx11, dy11, dz11, manhattanDistance);\r
`,t+=`    vec3 d12 =dist(dx12, dy12, dz12, manhattanDistance);\r
`,t+=`    vec3 d13 = dist(dx13, dy13, dz13, manhattanDistance);\r
`,t+=`    vec3 d21 = dist(dx21, dy21, dz21, manhattanDistance);\r
`,t+=`    vec3 d22 = dist(dx22, dy22, dz22, manhattanDistance);\r
`,t+=`    vec3 d23 = dist(dx23, dy23, dz23, manhattanDistance);\r
`,t+=`    vec3 d31 = dist(dx31, dy31, dz31, manhattanDistance);\r
`,t+=`    vec3 d32 = dist(dx32, dy32, dz32, manhattanDistance);\r
`,t+=`    vec3 d33 = dist(dx33, dy33, dz33, manhattanDistance);\r
`,t+=`\r
`,t+=`    vec3 d1a = min(d11, d12);\r
`,t+=`    d12 = max(d11, d12);\r
`,t+=`    d11 = min(d1a, d13); // Smallest now not in d12 or d13\r
`,t+=`    d13 = max(d1a, d13);\r
`,t+=`    d12 = min(d12, d13); // 2nd smallest now not in d13\r
`,t+=`    vec3 d2a = min(d21, d22);\r
`,t+=`    d22 = max(d21, d22);\r
`,t+=`    d21 = min(d2a, d23); // Smallest now not in d22 or d23\r
`,t+=`    d23 = max(d2a, d23);\r
`,t+=`    d22 = min(d22, d23); // 2nd smallest now not in d23\r
`,t+=`    vec3 d3a = min(d31, d32);\r
`,t+=`    d32 = max(d31, d32);\r
`,t+=`    d31 = min(d3a, d33); // Smallest now not in d32 or d33\r
`,t+=`    d33 = max(d3a, d33);\r
`,t+=`    d32 = min(d32, d33); // 2nd smallest now not in d33\r
`,t+=`    vec3 da = min(d11, d21);\r
`,t+=`    d21 = max(d11, d21);\r
`,t+=`    d11 = min(da, d31); // Smallest now in d11\r
`,t+=`    d31 = max(da, d31); // 2nd smallest now not in d31\r
`,t+=`    d11.xy = (d11.x < d11.y) ? d11.xy : d11.yx;\r
`,t+=`    d11.xz = (d11.x < d11.z) ? d11.xz : d11.zx; // d11.x now smallest\r
`,t+=`    d12 = min(d12, d21); // 2nd smallest now not in d21\r
`,t+=`    d12 = min(d12, d22); // nor in d22\r
`,t+=`    d12 = min(d12, d31); // nor in d31\r
`,t+=`    d12 = min(d12, d32); // nor in d32\r
`,t+=`    d11.yz = min(d11.yz,d12.xy); // nor in d12.yz\r
`,t+=`    d11.y = min(d11.y,d12.z); // Only two more to go\r
`,t+=`    d11.y = min(d11.y,d11.z); // Done! (Phew!)\r
`,t+=`    return sqrt(d11.xy); // F1, F2\r
`,t+=`}\r
\r
`,e._emitFunction("worley3D",t,"// Worley3D");const i=e._getFreeVariableName("worleyTemp");return e.compilationString+=`vec2 ${i} = worley(${this.seed.associatedVariableName}, ${this.jitter.associatedVariableName}, ${this.manhattanDistance});\r
`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r
`),this.x.hasEndpoints&&(e.compilationString+=this._declareOutput(this.x,e)+` = ${i}.x;\r
`),this.y.hasEndpoints&&(e.compilationString+=this._declareOutput(this.y,e)+` = ${i}.y;\r
`),this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.manhattanDistance = ${this.manhattanDistance};\r
`}serialize(){const e=super.serialize();return e.manhattanDistance=this.manhattanDistance,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.manhattanDistance=e.manhattanDistance}}T([ft("Use Manhattan Distance",at.Boolean,"PROPERTIES",{notifiers:{update:!1}})],Rm.prototype,"manhattanDistance",void 0);he("BABYLON.WorleyNoise3DBlock",Rm);class mI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("seed",I.Vector3),this.registerOutput("output",I.Float)}getClassName(){return"SimplexPerlin3DBlock"}get seed(){return this._inputs[0]}get output(){return this._outputs[0]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;let t=`const float SKEWFACTOR = 1.0/3.0;\r
`;return t+=`const float UNSKEWFACTOR = 1.0/6.0;\r
`,t+=`const float SIMPLEX_CORNER_POS = 0.5;\r
`,t+=`const float SIMPLEX_TETRAHADRON_HEIGHT = 0.70710678118654752440084436210485;\r
`,t+=`float SimplexPerlin3D( vec3 P ){\r
`,t+=`    P.x = P == vec3(0., 0., 0.) ? 0.00001 : P.x;\r
`,t+=`    P *= SIMPLEX_TETRAHADRON_HEIGHT;\r
`,t+="    vec3 Pi = floor( P + dot( P, vec3( SKEWFACTOR) ) );",t+=`    vec3 x0 = P - Pi + dot(Pi, vec3( UNSKEWFACTOR ) );\r
`,t+=`    vec3 g = step(x0.yzx, x0.xyz);\r
`,t+=`    vec3 l = 1.0 - g;\r
`,t+=`    vec3 Pi_1 = min( g.xyz, l.zxy );\r
`,t+=`    vec3 Pi_2 = max( g.xyz, l.zxy );\r
`,t+=`    vec3 x1 = x0 - Pi_1 + UNSKEWFACTOR;\r
`,t+=`    vec3 x2 = x0 - Pi_2 + SKEWFACTOR;\r
`,t+=`    vec3 x3 = x0 - SIMPLEX_CORNER_POS;\r
`,t+=`    vec4 v1234_x = vec4( x0.x, x1.x, x2.x, x3.x );\r
`,t+=`    vec4 v1234_y = vec4( x0.y, x1.y, x2.y, x3.y );\r
`,t+=`    vec4 v1234_z = vec4( x0.z, x1.z, x2.z, x3.z );\r
`,t+=`    Pi.xyz = Pi.xyz - floor(Pi.xyz * ( 1.0 / 69.0 )) * 69.0;\r
`,t+=`    vec3 Pi_inc1 = step( Pi, vec3( 69.0 - 1.5 ) ) * ( Pi + 1.0 );\r
`,t+=`    vec4 Pt = vec4( Pi.xy, Pi_inc1.xy ) + vec2( 50.0, 161.0 ).xyxy;\r
`,t+=`    Pt *= Pt;\r
`,t+=`    vec4 V1xy_V2xy = mix( Pt.xyxy, Pt.zwzw, vec4( Pi_1.xy, Pi_2.xy ) );\r
`,t+=`    Pt = vec4( Pt.x, V1xy_V2xy.xz, Pt.z ) * vec4( Pt.y, V1xy_V2xy.yw, Pt.w );\r
`,t+=`    const vec3 SOMELARGEFLOATS = vec3( 635.298681, 682.357502, 668.926525 );\r
`,t+=`    const vec3 ZINC = vec3( 48.500388, 65.294118, 63.934599 );\r
`,t+=`    vec3 lowz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi.zzz * ZINC.xyz ) );\r
`,t+=`    vec3 highz_mods = vec3( 1.0 / ( SOMELARGEFLOATS.xyz + Pi_inc1.zzz * ZINC.xyz ) );\r
`,t+=`    Pi_1 = ( Pi_1.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    Pi_2 = ( Pi_2.z < 0.5 ) ? lowz_mods : highz_mods;\r
`,t+=`    vec4 hash_0 = fract( Pt * vec4( lowz_mods.x, Pi_1.x, Pi_2.x, highz_mods.x ) ) - 0.49999;\r
`,t+=`    vec4 hash_1 = fract( Pt * vec4( lowz_mods.y, Pi_1.y, Pi_2.y, highz_mods.y ) ) - 0.49999;\r
`,t+=`    vec4 hash_2 = fract( Pt * vec4( lowz_mods.z, Pi_1.z, Pi_2.z, highz_mods.z ) ) - 0.49999;\r
`,t+=`    vec4 grad_results = inversesqrt( hash_0 * hash_0 + hash_1 * hash_1 + hash_2 * hash_2 ) * ( hash_0 * v1234_x + hash_1 * v1234_y + hash_2 * v1234_z );\r
`,t+=`    const float FINAL_NORMALIZATION = 37.837227241611314102871574478976;\r
`,t+=`    vec4 kernel_weights = v1234_x * v1234_x + v1234_y * v1234_y + v1234_z * v1234_z;\r
`,t+=`    kernel_weights = max(0.5 - kernel_weights, 0.0);\r
`,t+=`    kernel_weights = kernel_weights*kernel_weights*kernel_weights;\r
`,t+=`    return dot( kernel_weights, grad_results ) * FINAL_NORMALIZATION;\r
`,t+=`}\r
`,e._emitFunction("SimplexPerlin3D",t,"// SimplexPerlin3D"),e.compilationString+=this._declareOutput(this._outputs[0],e)+` = SimplexPerlin3D(${this.seed.associatedVariableName});\r
`,this}}he("BABYLON.SimplexPerlin3DBlock",mI);class gI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("normalMap0",I.Vector3),this.registerInput("normalMap1",I.Vector3),this.registerOutput("output",I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Color3),this._inputs[0].acceptedConnectionPointTypes.push(I.Color4),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[1].acceptedConnectionPointTypes.push(I.Color3),this._inputs[1].acceptedConnectionPointTypes.push(I.Color4),this._inputs[1].acceptedConnectionPointTypes.push(I.Vector4)}getClassName(){return"NormalBlendBlock"}get normalMap0(){return this._inputs[0]}get normalMap1(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0],s=this._inputs[1],r=e._getFreeVariableName("stepR"),n=e._getFreeVariableName("stepG");return e.compilationString+=`float ${r} = step(0.5, ${i.associatedVariableName}.r);\r
`,e.compilationString+=`float ${n} = step(0.5, ${i.associatedVariableName}.g);\r
`,e.compilationString+=this._declareOutput(t,e)+`;\r
`,e.compilationString+=`${t.associatedVariableName}.r = (1.0 - ${r}) * ${i.associatedVariableName}.r * ${s.associatedVariableName}.r * 2.0 + ${r} * (1.0 - (1.0 - ${i.associatedVariableName}.r) * (1.0 - ${s.associatedVariableName}.r) * 2.0);\r
`,e.compilationString+=`${t.associatedVariableName}.g = (1.0 - ${n}) * ${i.associatedVariableName}.g * ${s.associatedVariableName}.g * 2.0 + ${n} * (1.0 - (1.0 - ${i.associatedVariableName}.g) * (1.0 - ${s.associatedVariableName}.g) * 2.0);\r
`,e.compilationString+=`${t.associatedVariableName}.b = ${i.associatedVariableName}.b * ${s.associatedVariableName}.b;\r
`,this}}he("BABYLON.NormalBlendBlock",gI);class vI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("input",I.Vector2),this.registerInput("angle",I.Float),this.registerOutput("output",I.Vector2)}getClassName(){return"Rotate2dBlock"}get input(){return this._inputs[0]}get angle(){return this._inputs[1]}get output(){return this._outputs[0]}autoConfigure(){if(!this.angle.isConnected){const e=new Ye("angle");e.value=0,e.output.connectTo(this.angle)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.angle,s=this.input;return e.compilationString+=this._declareOutput(t,e)+` = vec2(cos(${i.associatedVariableName}) * ${s.associatedVariableName}.x - sin(${i.associatedVariableName}) * ${s.associatedVariableName}.y, sin(${i.associatedVariableName}) * ${s.associatedVariableName}.x + cos(${i.associatedVariableName}) * ${s.associatedVariableName}.y);\r
`,this}}he("BABYLON.Rotate2dBlock",vI);class xI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("incident",I.Vector3),this.registerInput("normal",I.Vector3),this.registerOutput("output",I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0].acceptedConnectionPointTypes.push(I.Color3),this._inputs[0].acceptedConnectionPointTypes.push(I.Color4),this._inputs[1].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[1].acceptedConnectionPointTypes.push(I.Color3),this._inputs[1].acceptedConnectionPointTypes.push(I.Color4)}getClassName(){return"ReflectBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = reflect(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz);\r
`,this}}he("BABYLON.ReflectBlock",xI);class TI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("incident",I.Vector3),this.registerInput("normal",I.Vector3),this.registerInput("ior",I.Float),this.registerOutput("output",I.Vector3),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[0].acceptedConnectionPointTypes.push(I.Color3),this._inputs[0].acceptedConnectionPointTypes.push(I.Color4),this._inputs[1].acceptedConnectionPointTypes.push(I.Vector4),this._inputs[1].acceptedConnectionPointTypes.push(I.Color3),this._inputs[1].acceptedConnectionPointTypes.push(I.Color4)}getClassName(){return"RefractBlock"}get incident(){return this._inputs[0]}get normal(){return this._inputs[1]}get ior(){return this._inputs[2]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = refract(${this.incident.associatedVariableName}.xyz, ${this.normal.associatedVariableName}.xyz, ${this.ior.associatedVariableName});\r
`,this}}he("BABYLON.RefractBlock",TI);class bI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("color",I.Color3),this.registerInput("level",I.Float),this.registerOutput("output",I.Color3)}getClassName(){return"DesaturateBlock"}get color(){return this._inputs[0]}get level(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],s=this.color.associatedVariableName,r=e._getFreeVariableName("colorMin"),n=e._getFreeVariableName("colorMax"),o=e._getFreeVariableName("colorMerge");return e.compilationString+=`float ${r} = min(min(${s}.x, ${s}.y), ${s}.z);\r
`,e.compilationString+=`float ${n} = max(max(${s}.x, ${s}.y), ${s}.z);\r
`,e.compilationString+=`float ${o} = 0.5 * (${r} + ${n});\r
`,e.compilationString+=this._declareOutput(t,e)+` = mix(${s}, vec3(${o}, ${o}, ${o}), ${this.level.associatedVariableName});\r
`,this}}he("BABYLON.DesaturateBlock",bI);class Ko extends Ie{constructor(e){super(e,U.Fragment),this.albedoScaling=!1,this.linkSheenWithAlbedo=!1,this._isUnique=!0,this.registerInput("intensity",I.Float,!0,U.Fragment),this.registerInput("color",I.Color3,!0,U.Fragment),this.registerInput("roughness",I.Float,!0,U.Fragment),this.registerOutput("sheen",I.Object,U.Fragment,new Di("sheen",this,fi.Output,Ko,"SheenBlock"))}initialize(e){e._excludeVariableName("sheenOut"),e._excludeVariableName("sheenMapData"),e._excludeVariableName("vSheenColor"),e._excludeVariableName("vSheenRoughness")}getClassName(){return"SheenBlock"}get intensity(){return this._inputs[0]}get color(){return this._inputs[1]}get roughness(){return this._inputs[2]}get sheen(){return this._outputs[0]}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("SHEEN",!0),i.setValue("SHEEN_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("SHEEN_LINKWITHALBEDO",this.linkSheenWithAlbedo,!0),i.setValue("SHEEN_ROUGHNESS",this.roughness.isConnected,!0),i.setValue("SHEEN_ALBEDOSCALING",this.albedoScaling,!0)}getCode(e){let t="";const i=this.color.isConnected?this.color.associatedVariableName:"vec3(1.)",s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.",r=this.roughness.isConnected?this.roughness.associatedVariableName:"0.";return t=`#ifdef SHEEN
            sheenOutParams sheenOut;

            vec4 vSheenColor = vec4(${i}, ${s});

            sheenBlock(
                vSheenColor,
            #ifdef SHEEN_ROUGHNESS
                ${r},
            #endif
                roughness,
            #ifdef SHEEN_TEXTURE
                vec4(0.),
                1.0,
            #endif
                reflectance,
            #ifdef SHEEN_LINKWITHALBEDO
                baseColor,
                surfaceAlbedo,
            #endif
            #ifdef ENVIRONMENTBRDF
                NdotV,
                environmentBrdf,
            #endif
            #if defined(REFLECTION) && defined(ENVIRONMENTBRDF)
                AARoughnessFactors,
                ${e==null?void 0:e._vReflectionMicrosurfaceInfosName},
                ${e==null?void 0:e._vReflectionInfosName},
                ${e==null?void 0:e.reflectionColor},
                vLightingIntensity,
                #ifdef ${e==null?void 0:e._define3DName}
                    ${e==null?void 0:e._cubeSamplerName},
                #else
                    ${e==null?void 0:e._2DSamplerName},
                #endif
                reflectionOut.reflectionCoords,
                NdotVUnclamped,
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${e==null?void 0:e._define3DName}
                        ${e==null?void 0:e._cubeSamplerName},
                        ${e==null?void 0:e._cubeSamplerName},
                    #else
                        ${e==null?void 0:e._2DSamplerName},
                        ${e==null?void 0:e._2DSamplerName},
                    #endif
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(RADIANCEOCCLUSION)
                    seo,
                #endif
                #if !defined(${e==null?void 0:e._defineSkyboxName}) && defined(HORIZONOCCLUSION) && defined(BUMP) && defined(${e==null?void 0:e._define3DName})
                    eho,
                #endif
            #endif
                sheenOut
            );

            #ifdef SHEEN_LINKWITHALBEDO
                surfaceAlbedo = sheenOut.surfaceAlbedo;
            #endif
        #endif\r
`,t}_buildBlock(e){return e.target===U.Fragment&&e.sharedData.blocksWithDefines.push(this),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.albedoScaling = ${this.albedoScaling};\r
`,e+=`${this._codeVariableName}.linkSheenWithAlbedo = ${this.linkSheenWithAlbedo};\r
`,e}serialize(){const e=super.serialize();return e.albedoScaling=this.albedoScaling,e.linkSheenWithAlbedo=this.linkSheenWithAlbedo,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.albedoScaling=e.albedoScaling,this.linkSheenWithAlbedo=e.linkSheenWithAlbedo}}T([ft("Albedo scaling",at.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ko.prototype,"albedoScaling",void 0);T([ft("Link sheen with albedo",at.Boolean,"PROPERTIES",{notifiers:{update:!0}})],Ko.prototype,"linkSheenWithAlbedo",void 0);he("BABYLON.SheenBlock",Ko);class su extends Ie{constructor(e){super(e,U.Fragment),this._isUnique=!0,this.registerInput("intensity",I.Float,!0,U.Fragment),this.registerInput("direction",I.Vector2,!0,U.Fragment),this.registerInput("uv",I.Vector2,!0),this.registerInput("worldTangent",I.Vector4,!0),this.registerInput("TBN",I.Object,!0,U.VertexAndFragment,new Di("TBN",this,fi.Input,Yo,"TBNBlock")),this.registerOutput("anisotropy",I.Object,U.Fragment,new Di("anisotropy",this,fi.Output,su,"AnisotropyBlock"))}initialize(e){e._excludeVariableName("anisotropicOut"),e._excludeVariableName("TBN")}getClassName(){return"AnisotropyBlock"}get intensity(){return this._inputs[0]}get direction(){return this._inputs[1]}get uv(){return this._inputs[2]}get worldTangent(){return this._inputs[3]}get TBN(){return this._inputs[4]}get anisotropy(){return this._outputs[0]}_generateTBNSpace(e){let t="";const i=`//${this.name}`,s=this.uv,r=this.worldPositionConnectionPoint,n=this.worldNormalConnectionPoint,o=this.worldTangent;s.isConnected||console.error("You must connect the 'uv' input of the Anisotropy block!"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const l={search:/defined\(TANGENT\)/g,replace:o.isConnected?"defined(TANGENT)":"defined(IGNORE)"},h=this.TBN;return h.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${h.associatedVariableName};
            #endif
            `:o.isConnected&&(t+=`vec3 tbnNormal = normalize(${n.associatedVariableName}.xyz);\r
`,t+=`vec3 tbnTangent = normalize(${o.associatedVariableName}.xyz);\r
`,t+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,t+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),t+=`
            #if defined(${o.isConnected?"TANGENT":"IGNORE"}) && defined(NORMAL)
                mat3 TBN = vTBN;
            #else
                mat3 TBN = cotangent_frame(${n.associatedVariableName+".xyz"}, ${"v_"+r.associatedVariableName+".xyz"}, ${s.isConnected?s.associatedVariableName:"vec2(0.)"}, vec2(1., 1.));
            #endif\r
`,e._emitFunctionFromInclude("bumpFragmentMainFunctions",i,{replaceStrings:[l]}),t}getCode(e,t=!1){let i="";t&&(i+=this._generateTBNSpace(e));const s=this.intensity.isConnected?this.intensity.associatedVariableName:"1.0";return i+=`anisotropicOutParams anisotropicOut;
            anisotropicBlock(
                vec3(${this.direction.isConnected?this.direction.associatedVariableName:"vec2(1., 0.)"}, ${s}),
            #ifdef ANISOTROPIC_TEXTURE
                vec3(0.),
            #endif
                TBN,
                normalW,
                viewDirectionW,
                anisotropicOut
            );\r
`,i}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("ANISOTROPIC",!0),i.setValue("ANISOTROPIC_TEXTURE",!1,!0)}_buildBlock(e){return e.target===U.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}he("BABYLON.AnisotropyBlock",su);class $o extends p0{constructor(e){super(e),this.useSphericalHarmonics=!0,this.forceIrradianceInFragment=!1,this._isUnique=!0,this.registerInput("position",I.Vector3,!1,U.Vertex),this.registerInput("world",I.Matrix,!1,U.Vertex),this.registerInput("color",I.Color3,!0,U.Fragment),this.registerOutput("reflection",I.Object,U.Fragment,new Di("reflection",this,fi.Output,$o,"ReflectionBlock"))}getClassName(){return"ReflectionBlock"}get position(){return this._inputs[0]}get worldPosition(){return this.worldPositionConnectionPoint}get worldNormal(){return this.worldNormalConnectionPoint}get world(){return this._inputs[1]}get cameraPosition(){return this.cameraPositionConnectionPoint}get view(){return this.viewConnectionPoint}get color(){return this._inputs[2]}get reflection(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}get reflectionColor(){return this.color.isConnected?this.color.associatedVariableName:"vec3(1., 1., 1.)"}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),r=s&&s.getTextureMatrix;i.setValue("REFLECTION",r,!0),r&&(i.setValue(this._defineLODReflectionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularReflection,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SPHERICAL_HARMONICS",this.useSphericalHarmonics,!0),i.setValue("GAMMAREFLECTION",s.gammaSpace,!0),i.setValue("RGBDREFLECTION",s.isRGBD,!0),s&&s.coordinatesMode!==H.SKYBOX_MODE&&s.isCube&&(i.setValue("USESPHERICALFROMREFLECTIONMAP",!0),i.setValue("USEIRRADIANCEMAP",!1),this.forceIrradianceInFragment||this._scene.getEngine().getCaps().maxVaryingVectors<=8?i.setValue("USESPHERICALINVERTEX",!1):i.setValue("USESPHERICALINVERTEX",!0)))}bind(e,t,i,s){super.bind(e,t,i);const r=this._getTexture();if(!r||!s)return;r.isCube?e.setTexture(this._cubeSamplerName,r):e.setTexture(this._2DSamplerName,r);const n=r.getSize().width;e.setFloat3(this._vReflectionMicrosurfaceInfosName,n,r.lodGenerationScale,r.lodGenerationOffset),e.setFloat2(this._vReflectionFilteringInfoName,n,oe.Log2(n));const o=s.materialDefines,l=r.sphericalPolynomial;if(o.USESPHERICALFROMREFLECTIONMAP&&l)if(o.SPHERICAL_HARMONICS){const h=l.preScaledHarmonics;e.setVector3("vSphericalL00",h.l00),e.setVector3("vSphericalL1_1",h.l1_1),e.setVector3("vSphericalL10",h.l10),e.setVector3("vSphericalL11",h.l11),e.setVector3("vSphericalL2_2",h.l2_2),e.setVector3("vSphericalL2_1",h.l2_1),e.setVector3("vSphericalL20",h.l20),e.setVector3("vSphericalL21",h.l21),e.setVector3("vSphericalL22",h.l22)}else e.setFloat3("vSphericalX",l.x.x,l.x.y,l.x.z),e.setFloat3("vSphericalY",l.y.x,l.y.y,l.y.z),e.setFloat3("vSphericalZ",l.z.x,l.z.y,l.z.z),e.setFloat3("vSphericalXX_ZZ",l.xx.x-l.zz.x,l.xx.y-l.zz.y,l.xx.z-l.zz.z),e.setFloat3("vSphericalYY_ZZ",l.yy.x-l.zz.x,l.yy.y-l.zz.y,l.yy.z-l.zz.z),e.setFloat3("vSphericalZZ",l.zz.x,l.zz.y,l.zz.z),e.setFloat3("vSphericalXY",l.xy.x,l.xy.y,l.xy.z),e.setFloat3("vSphericalYZ",l.yz.x,l.yz.y,l.yz.z),e.setFloat3("vSphericalZX",l.zx.x,l.zx.y,l.zx.z)}handleVertexSide(e){let t=super.handleVertexSide(e);e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]});const i=e._getFreeVariableName("reflectionVector");return this._vEnvironmentIrradianceName=e._getFreeVariableName("vEnvironmentIrradiance"),e._emitVaryingFromString(this._vEnvironmentIrradianceName,"vec3","defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)"),e._emitUniformFromString("vSphericalL00","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL1_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL10","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL11","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_2","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL2_1","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL20","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL21","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalL22","vec3","SPHERICAL_HARMONICS"),e._emitUniformFromString("vSphericalX","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXX_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYY_ZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalXY","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalYZ","vec3","SPHERICAL_HARMONICS",!0),e._emitUniformFromString("vSphericalZX","vec3","SPHERICAL_HARMONICS",!0),t+=`#if defined(USESPHERICALFROMREFLECTIONMAP) && defined(USESPHERICALINVERTEX)
                vec3 ${i} = vec3(${this._reflectionMatrixName} * vec4(normalize(${this.worldNormal.associatedVariableName}).xyz, 0)).xyz;
                #ifdef ${this._defineOppositeZ}
                    ${i}.z *= -1.0;
                #endif
                ${this._vEnvironmentIrradianceName} = computeEnvironmentIrradiance(${i});
            #endif\r
`,t}getCode(e,t){let i="";this.handleFragmentSideInits(e),e._emitFunctionFromInclude("harmonicsFunctions",`//${this.name}`,{replaceStrings:[{search:/uniform vec3 vSphericalL00;[\s\S]*?uniform vec3 vSphericalL22;/g,replace:""},{search:/uniform vec3 vSphericalX;[\s\S]*?uniform vec3 vSphericalZX;/g,replace:""}]}),e._emitFunction("sampleReflection",`
            #ifdef ${this._define3DName}
                #define sampleReflection(s, c) textureCube(s, c)
            #else
                #define sampleReflection(s, c) texture2D(s, c)
            #endif\r
`,`//${this.name}`),e._emitFunction("sampleReflectionLod",`
            #ifdef ${this._define3DName}
                #define sampleReflectionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleReflectionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,`//${this.name}`);const s=`
            vec3 computeReflectionCoordsPBR(vec4 worldPos, vec3 worldNormal) {
                ${this.handleFragmentSideCodeReflectionCoords("worldNormal","worldPos",!0,!0)}
                return ${this._reflectionVectorName};
            }\r
`;return e._emitFunction("computeReflectionCoordsPBR",s,`//${this.name}`),this._vReflectionMicrosurfaceInfosName=e._getFreeVariableName("vReflectionMicrosurfaceInfos"),e._emitUniformFromString(this._vReflectionMicrosurfaceInfosName,"vec3"),this._vReflectionInfosName=e._getFreeVariableName("vReflectionInfos"),this._vReflectionFilteringInfoName=e._getFreeVariableName("vReflectionFilteringInfo"),e._emitUniformFromString(this._vReflectionFilteringInfoName,"vec2"),i+=`#ifdef REFLECTION
            vec2 ${this._vReflectionInfosName} = vec2(1., 0.);

            reflectionOutParams reflectionOut;

            reflectionBlock(
                ${"v_"+this.worldPosition.associatedVariableName+".xyz"},
                ${t},
                alphaG,
                ${this._vReflectionMicrosurfaceInfosName},
                ${this._vReflectionInfosName},
                ${this.reflectionColor},
            #ifdef ANISOTROPIC
                anisotropicOut,
            #endif
            #if defined(${this._defineLODReflectionAlpha}) && !defined(${this._defineSkyboxName})
                NdotVUnclamped,
            #endif
            #ifdef ${this._defineLinearSpecularReflection}
                roughness,
            #endif
            #ifdef ${this._define3DName}
                ${this._cubeSamplerName},
            #else
                ${this._2DSamplerName},
            #endif
            #if defined(NORMAL) && defined(USESPHERICALINVERTEX)
                ${this._vEnvironmentIrradianceName},
            #endif
            #ifdef USESPHERICALFROMREFLECTIONMAP
                #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                    ${this._reflectionMatrixName},
                #endif
            #endif
            #ifdef USEIRRADIANCEMAP
                irradianceSampler, // ** not handled **
            #endif
            #ifndef LODBASEDMICROSFURACE
                #ifdef ${this._define3DName}
                    ${this._cubeSamplerName},
                    ${this._cubeSamplerName},
                #else
                    ${this._2DSamplerName},
                    ${this._2DSamplerName},
                #endif
            #endif
            #ifdef REALTIME_FILTERING
                ${this._vReflectionFilteringInfoName},
            #endif
                reflectionOut
            );
        #endif\r
`,i}_buildBlock(e){return this._scene=e.sharedData.scene,e.target!==U.Fragment&&(this._defineLODReflectionAlpha=e._getFreeDefineName("LODINREFLECTIONALPHA"),this._defineLinearSpecularReflection=e._getFreeDefineName("LINEARSPECULARREFLECTION")),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(e+=`${this._codeVariableName}.texture.gammaSpace = ${this.texture.gammaSpace};\r
`),e+=`${this._codeVariableName}.useSphericalHarmonics = ${this.useSphericalHarmonics};\r
`,e+=`${this._codeVariableName}.forceIrradianceInFragment = ${this.forceIrradianceInFragment};\r
`,e}serialize(){var e,t;const i=super.serialize();return i.useSphericalHarmonics=this.useSphericalHarmonics,i.forceIrradianceInFragment=this.forceIrradianceInFragment,i.gammaSpace=(t=(e=this.texture)===null||e===void 0?void 0:e.gammaSpace)!==null&&t!==void 0?t:!0,i}_deserialize(e,t,i){super._deserialize(e,t,i),this.useSphericalHarmonics=e.useSphericalHarmonics,this.forceIrradianceInFragment=e.forceIrradianceInFragment,this.texture&&(this.texture.gammaSpace=e.gammaSpace)}}T([ft("Spherical Harmonics",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],$o.prototype,"useSphericalHarmonics",void 0);T([ft("Force irradiance in fragment",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],$o.prototype,"forceIrradianceInFragment",void 0);he("BABYLON.ReflectionBlock",$o);class Lo extends Ie{constructor(e){super(e,U.Fragment),this.remapF0OnInterfaceChange=!0,this._isUnique=!0,this.registerInput("intensity",I.Float,!1,U.Fragment),this.registerInput("roughness",I.Float,!0,U.Fragment),this.registerInput("indexOfRefraction",I.Float,!0,U.Fragment),this.registerInput("normalMapColor",I.Color3,!0,U.Fragment),this.registerInput("uv",I.Vector2,!0,U.Fragment),this.registerInput("tintColor",I.Color3,!0,U.Fragment),this.registerInput("tintAtDistance",I.Float,!0,U.Fragment),this.registerInput("tintThickness",I.Float,!0,U.Fragment),this.registerInput("worldTangent",I.Vector4,!0),this.registerInput("worldNormal",I.Vector4,!0),this.worldNormal.acceptedConnectionPointTypes.push(I.Vector3),this.registerInput("TBN",I.Object,!0,U.VertexAndFragment,new Di("TBN",this,fi.Input,Yo,"TBNBlock")),this.registerOutput("clearcoat",I.Object,U.Fragment,new Di("clearcoat",this,fi.Output,Lo,"ClearCoatBlock"))}initialize(e){e._excludeVariableName("clearcoatOut"),e._excludeVariableName("vClearCoatParams"),e._excludeVariableName("vClearCoatTintParams"),e._excludeVariableName("vClearCoatRefractionParams"),e._excludeVariableName("vClearCoatTangentSpaceParams"),e._excludeVariableName("vGeometricNormaClearCoatW")}getClassName(){return"ClearCoatBlock"}get intensity(){return this._inputs[0]}get roughness(){return this._inputs[1]}get indexOfRefraction(){return this._inputs[2]}get normalMapColor(){return this._inputs[3]}get uv(){return this._inputs[4]}get tintColor(){return this._inputs[5]}get tintAtDistance(){return this._inputs[6]}get tintThickness(){return this._inputs[7]}get worldTangent(){return this._inputs[8]}get worldNormal(){return this._inputs[9]}get TBN(){return this._inputs[10]}get clearcoat(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Ye("ClearCoat intensity",U.Fragment,I.Float);e.value=1,e.output.connectTo(this.intensity)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("CLEARCOAT",!0),i.setValue("CLEARCOAT_TEXTURE",!1,!0),i.setValue("CLEARCOAT_USE_ROUGHNESS_FROM_MAINTEXTURE",!0,!0),i.setValue("CLEARCOAT_TINT",this.tintColor.isConnected||this.tintThickness.isConnected||this.tintAtDistance.isConnected,!0),i.setValue("CLEARCOAT_BUMP",this.normalMapColor.isConnected,!0),i.setValue("CLEARCOAT_DEFAULTIOR",this.indexOfRefraction.isConnected?this.indexOfRefraction.connectInputBlock.value===Oi._DefaultIndexOfRefraction:!0,!0),i.setValue("CLEARCOAT_REMAP_F0",this.remapF0OnInterfaceChange,!0)}bind(e,t,i){var s,r;super.bind(e,t,i);const n=(r=(s=this.indexOfRefraction.connectInputBlock)===null||s===void 0?void 0:s.value)!==null&&r!==void 0?r:Oi._DefaultIndexOfRefraction,o=1-n,l=1+n,h=Math.pow(-o/l,2),c=1/n;e.setFloat4("vClearCoatRefractionParams",h,c,o,l);const u=this.clearcoat.hasEndpoints?this.clearcoat.endpoints[0].ownerBlock:null,d=u!=null&&u.perturbedNormal.isConnected?u.perturbedNormal.connectedPoint.ownerBlock:null;this._scene._mirroredCameraPosition?e.setFloat2("vClearCoatTangentSpaceParams",d!=null&&d.invertX?1:-1,d!=null&&d.invertY?1:-1):e.setFloat2("vClearCoatTangentSpaceParams",d!=null&&d.invertX?-1:1,d!=null&&d.invertY?-1:1)}_generateTBNSpace(e,t,i){let s="";const r=`//${this.name}`,n=this.worldTangent;e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable");const o={search:/defined\(TANGENT\)/g,replace:n.isConnected?"defined(TANGENT)":"defined(IGNORE)"},l=this.TBN;return l.isConnected?e.compilationString+=`
            #ifdef TBNBLOCK
            mat3 vTBN = ${l.associatedVariableName};
            #endif
            `:n.isConnected&&(s+=`vec3 tbnNormal = normalize(${i}.xyz);\r
`,s+=`vec3 tbnTangent = normalize(${n.associatedVariableName}.xyz);\r
`,s+=`vec3 tbnBitangent = cross(tbnNormal, tbnTangent);\r
`,s+=`mat3 vTBN = mat3(tbnTangent, tbnBitangent, tbnNormal);\r
`),e._emitFunctionFromInclude("bumpFragmentMainFunctions",r,{replaceStrings:[o]}),s}static GetCode(e,t,i,s,r,n,o){let l="";const h=t!=null&&t.intensity.isConnected?t.intensity.associatedVariableName:"1.",c=t!=null&&t.roughness.isConnected?t.roughness.associatedVariableName:"0.",u=t!=null&&t.normalMapColor.isConnected?t.normalMapColor.associatedVariableName:"vec3(0.)",d=t!=null&&t.uv.isConnected?t.uv.associatedVariableName:"vec2(0.)",f=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",p=t!=null&&t.tintThickness.isConnected?t.tintThickness.associatedVariableName:"1.",_=t!=null&&t.tintAtDistance.isConnected?t.tintAtDistance.associatedVariableName:"1.",m="vec4(0.)";if(t){e._emitUniformFromString("vClearCoatRefractionParams","vec4"),e._emitUniformFromString("vClearCoatTangentSpaceParams","vec2");const v=t.worldNormal;l+=`vec3 vGeometricNormaClearCoatW = ${v.isConnected?"normalize("+v.associatedVariableName+".xyz)":"geometricNormalW"};\r
`}else l+=`vec3 vGeometricNormaClearCoatW = geometricNormalW;\r
`;return r&&t&&(l+=t._generateTBNSpace(e,s,o),n=t.worldTangent.isConnected),l+=`clearcoatOutParams clearcoatOut;

        #ifdef CLEARCOAT
            vec2 vClearCoatParams = vec2(${h}, ${c});
            vec4 vClearCoatTintParams = vec4(${f}, ${p});

            clearcoatBlock(
                ${s}.xyz,
                vGeometricNormaClearCoatW,
                viewDirectionW,
                vClearCoatParams,
                specularEnvironmentR0,
            #ifdef CLEARCOAT_TEXTURE
                vec2(0.),
            #endif
            #ifdef CLEARCOAT_TINT
                vClearCoatTintParams,
                ${_},
                vClearCoatRefractionParams,
                #ifdef CLEARCOAT_TINT_TEXTURE
                    ${m},
                #endif
            #endif
            #ifdef CLEARCOAT_BUMP
                vec2(0., 1.),
                vec4(${u}, 0.),
                ${d},
                #if defined(${n?"TANGENT":"IGNORE"}) && defined(NORMAL)
                    vTBN,
                #else
                    vClearCoatTangentSpaceParams,
                #endif
                #ifdef OBJECTSPACE_NORMALMAP
                    normalMatrix,
                #endif
            #endif
            #if defined(FORCENORMALFORWARD) && defined(NORMAL)
                faceNormal,
            #endif
            #ifdef REFLECTION
                ${i==null?void 0:i._vReflectionMicrosurfaceInfosName},
                ${i==null?void 0:i._vReflectionInfosName},
                ${i==null?void 0:i.reflectionColor},
                vLightingIntensity,
                #ifdef ${i==null?void 0:i._define3DName}
                    ${i==null?void 0:i._cubeSamplerName},
                #else
                    ${i==null?void 0:i._2DSamplerName},
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${i==null?void 0:i._define3DName}
                        ${i==null?void 0:i._cubeSamplerName},
                        ${i==null?void 0:i._cubeSamplerName},
                    #else
                        ${i==null?void 0:i._2DSamplerName},
                        ${i==null?void 0:i._2DSamplerName},
                    #endif
                #endif
            #endif
            #if defined(ENVIRONMENTBRDF) && !defined(${i==null?void 0:i._defineSkyboxName})
                #ifdef RADIANCEOCCLUSION
                    ambientMonochrome,
                #endif
            #endif
            #if defined(CLEARCOAT_BUMP) || defined(TWOSIDEDLIGHTING)
                (gl_FrontFacing ? 1. : -1.),
            #endif
                clearcoatOut
            );
        #else
            clearcoatOut.specularEnvironmentR0 = specularEnvironmentR0;
        #endif\r
`,l}_buildBlock(e){return this._scene=e.sharedData.scene,e.target===U.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.remapF0OnInterfaceChange = ${this.remapF0OnInterfaceChange};\r
`,e}serialize(){const e=super.serialize();return e.remapF0OnInterfaceChange=this.remapF0OnInterfaceChange,e}_deserialize(e,t,i){var s;super._deserialize(e,t,i),this.remapF0OnInterfaceChange=(s=e.remapF0OnInterfaceChange)!==null&&s!==void 0?s:!0}}T([ft("Remap F0 on interface change",at.Boolean,"ADVANCED")],Lo.prototype,"remapF0OnInterfaceChange",void 0);he("BABYLON.ClearCoatBlock",Lo);class wl extends Ie{constructor(e){super(e,U.Fragment),this._isUnique=!0,this.registerInput("intensity",I.Float,!0,U.Fragment),this.registerInput("indexOfRefraction",I.Float,!0,U.Fragment),this.registerInput("thickness",I.Float,!0,U.Fragment),this.registerOutput("iridescence",I.Object,U.Fragment,new Di("iridescence",this,fi.Output,wl,"IridescenceBlock"))}initialize(e){e._excludeVariableName("iridescenceOut"),e._excludeVariableName("vIridescenceParams")}getClassName(){return"IridescenceBlock"}get intensity(){return this._inputs[0]}get indexOfRefraction(){return this._inputs[1]}get thickness(){return this._inputs[2]}get iridescence(){return this._outputs[0]}autoConfigure(){if(!this.intensity.isConnected){const e=new Ye("Iridescence intensity",U.Fragment,I.Float);e.value=1,e.output.connectTo(this.intensity);const t=new Ye("Iridescence ior",U.Fragment,I.Float);t.value=1.3,t.output.connectTo(this.indexOfRefraction);const i=new Ye("Iridescence thickness",U.Fragment,I.Float);i.value=400,i.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i),i.setValue("IRIDESCENCE",!0,!0),i.setValue("IRIDESCENCE_TEXTURE",!1,!0),i.setValue("IRIDESCENCE_THICKNESS_TEXTURE",!1,!0)}static GetCode(e){let t="";const i=e!=null&&e.intensity.isConnected?e.intensity.associatedVariableName:"1.",s=e!=null&&e.indexOfRefraction.isConnected?e.indexOfRefraction.associatedVariableName:_s._DefaultIndexOfRefraction,r=e!=null&&e.thickness.isConnected?e.thickness.associatedVariableName:_s._DefaultMaximumThickness;return t+=`iridescenceOutParams iridescenceOut;

        #ifdef IRIDESCENCE
            iridescenceBlock(
                vec4(${i}, ${s}, 1., ${r}),
                NdotV,
                specularEnvironmentR0,
                #ifdef CLEARCOAT
                    NdotVUnclamped,
                #endif
                iridescenceOut
            );

            float iridescenceIntensity = iridescenceOut.iridescenceIntensity;
            specularEnvironmentR0 = iridescenceOut.specularEnvironmentR0;
        #endif\r
`,t}_buildBlock(e){return e.target===U.Fragment&&(e.sharedData.bindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this)),this}serialize(){return super.serialize()}_deserialize(e,t,i){super._deserialize(e,t,i)}}he("BABYLON.IridescenceBlock",wl);class Ka extends Ie{constructor(e){super(e,U.Fragment),this.linkRefractionWithTransparency=!1,this.invertRefractionY=!1,this.useThicknessAsDepth=!1,this._isUnique=!0,this.registerInput("intensity",I.Float,!1,U.Fragment),this.registerInput("tintAtDistance",I.Float,!0,U.Fragment),this.registerInput("volumeIndexOfRefraction",I.Float,!0,U.Fragment),this.registerOutput("refraction",I.Object,U.Fragment,new Di("refraction",this,fi.Output,Ka,"RefractionBlock"))}initialize(e){e._excludeVariableName("vRefractionPosition"),e._excludeVariableName("vRefractionSize")}getClassName(){return"RefractionBlock"}get intensity(){return this._inputs[0]}get tintAtDistance(){return this._inputs[1]}get volumeIndexOfRefraction(){return this._inputs[2]}get view(){return this.viewConnectionPoint}get refraction(){return this._outputs[0]}get hasTexture(){return!!this._getTexture()}_getTexture(){return this.texture?this.texture:this._scene.environmentTexture}autoConfigure(e){if(!this.intensity.isConnected){const t=new Ye("Refraction intensity",U.Fragment,I.Float);t.value=1,t.output.connectTo(this.intensity)}if(this.view&&!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.View);t||(t=new Ye("view"),t.setAsSystemValue(Ke.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this._getTexture(),r=s&&s.getTextureMatrix;i.setValue("SS_REFRACTION",r,!0),r&&(i.setValue(this._define3DName,s.isCube,!0),i.setValue(this._defineLODRefractionAlpha,s.lodLevelInAlpha,!0),i.setValue(this._defineLinearSpecularRefraction,s.linearSpecularLOD,!0),i.setValue(this._defineOppositeZ,this._scene.useRightHandedSystem?!s.invertZ:s.invertZ,!0),i.setValue("SS_LINKREFRACTIONTOTRANSPARENCY",this.linkRefractionWithTransparency,!0),i.setValue("SS_GAMMAREFRACTION",s.gammaSpace,!0),i.setValue("SS_RGBDREFRACTION",s.isRGBD,!0),i.setValue("SS_USE_LOCAL_REFRACTIONMAP_CUBIC",!!s.boundingBoxSize,!0),i.setValue("SS_USE_THICKNESS_AS_DEPTH",this.useThicknessAsDepth,!0))}isReady(){const e=this._getTexture();return!(e&&!e.isReadyOrNotBlocking())}bind(e,t,i){var s,r,n,o;super.bind(e,t,i);const l=this._getTexture();if(!l)return;l.isCube?e.setTexture(this._cubeSamplerName,l):e.setTexture(this._2DSamplerName,l),e.setMatrix(this._refractionMatrixName,l.getReflectionTextureMatrix());let h=1;l.isCube||l.depth&&(h=l.depth);const c=(o=(r=(s=this.volumeIndexOfRefraction.connectInputBlock)===null||s===void 0?void 0:s.value)!==null&&r!==void 0?r:(n=this.indexOfRefractionConnectionPoint.connectInputBlock)===null||n===void 0?void 0:n.value)!==null&&o!==void 0?o:1.5;e.setFloat4(this._vRefractionInfosName,l.level,1/c,h,this.invertRefractionY?-1:1),e.setFloat4(this._vRefractionMicrosurfaceInfosName,l.getSize().width,l.lodGenerationScale,l.lodGenerationOffset,1/c);const u=l.getSize().width;if(e.setFloat2(this._vRefractionFilteringInfoName,u,oe.Log2(u)),l.boundingBoxSize){const d=l;e.setVector3("vRefractionPosition",d.boundingBoxPosition),e.setVector3("vRefractionSize",d.boundingBoxSize)}}getCode(e){const t="";return e.sharedData.blockingBlocks.push(this),e.sharedData.textureBlocks.push(this),this._cubeSamplerName=e._getFreeVariableName(this.name+"CubeSampler"),e.samplers.push(this._cubeSamplerName),this._2DSamplerName=e._getFreeVariableName(this.name+"2DSampler"),e.samplers.push(this._2DSamplerName),this._define3DName=e._getFreeDefineName("SS_REFRACTIONMAP_3D"),e._samplerDeclaration+=`#ifdef ${this._define3DName}\r
`,e._samplerDeclaration+=`uniform samplerCube ${this._cubeSamplerName};\r
`,e._samplerDeclaration+=`#else\r
`,e._samplerDeclaration+=`uniform sampler2D ${this._2DSamplerName};\r
`,e._samplerDeclaration+=`#endif\r
`,e.sharedData.blocksWithDefines.push(this),e.sharedData.bindableBlocks.push(this),this._defineLODRefractionAlpha=e._getFreeDefineName("SS_LODINREFRACTIONALPHA"),this._defineLinearSpecularRefraction=e._getFreeDefineName("SS_LINEARSPECULARREFRACTION"),this._defineOppositeZ=e._getFreeDefineName("SS_REFRACTIONMAP_OPPOSITEZ"),this._refractionMatrixName=e._getFreeVariableName("refractionMatrix"),e._emitUniformFromString(this._refractionMatrixName,"mat4"),e._emitFunction("sampleRefraction",`
            #ifdef ${this._define3DName}
                #define sampleRefraction(s, c) textureCube(s, c)
            #else
                #define sampleRefraction(s, c) texture2D(s, c)
            #endif\r
`,`//${this.name}`),e._emitFunction("sampleRefractionLod",`
            #ifdef ${this._define3DName}
                #define sampleRefractionLod(s, c, l) textureCubeLodEXT(s, c, l)
            #else
                #define sampleRefractionLod(s, c, l) texture2DLodEXT(s, c, l)
            #endif\r
`,`//${this.name}`),this._vRefractionMicrosurfaceInfosName=e._getFreeVariableName("vRefractionMicrosurfaceInfos"),e._emitUniformFromString(this._vRefractionMicrosurfaceInfosName,"vec4"),this._vRefractionInfosName=e._getFreeVariableName("vRefractionInfos"),e._emitUniformFromString(this._vRefractionInfosName,"vec4"),this._vRefractionFilteringInfoName=e._getFreeVariableName("vRefractionFilteringInfo"),e._emitUniformFromString(this._vRefractionFilteringInfoName,"vec2"),e._emitUniformFromString("vRefractionPosition","vec3"),e._emitUniformFromString("vRefractionSize","vec3"),t}_buildBlock(e){return this._scene=e.sharedData.scene,this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return this.texture&&(this.texture.isCube?e=`${this._codeVariableName}.texture = new BABYLON.CubeTexture("${this.texture.name}");\r
`:e=`${this._codeVariableName}.texture = new BABYLON.Texture("${this.texture.name}");\r
`,e+=`${this._codeVariableName}.texture.coordinatesMode = ${this.texture.coordinatesMode};\r
`),e+=`${this._codeVariableName}.linkRefractionWithTransparency = ${this.linkRefractionWithTransparency};\r
`,e+=`${this._codeVariableName}.invertRefractionY = ${this.invertRefractionY};\r
`,e+=`${this._codeVariableName}.useThicknessAsDepth = ${this.useThicknessAsDepth};\r
`,e}serialize(){const e=super.serialize();return this.texture&&!this.texture.isRenderTarget&&(e.texture=this.texture.serialize()),e.linkRefractionWithTransparency=this.linkRefractionWithTransparency,e.invertRefractionY=this.invertRefractionY,e.useThicknessAsDepth=this.useThicknessAsDepth,e}_deserialize(e,t,i){super._deserialize(e,t,i),e.texture&&(i=e.texture.url.indexOf("data:")===0?"":i,e.texture.isCube?this.texture=Xi.Parse(e.texture,t,i):this.texture=H.Parse(e.texture,t,i)),this.linkRefractionWithTransparency=e.linkRefractionWithTransparency,this.invertRefractionY=e.invertRefractionY,this.useThicknessAsDepth=!!e.useThicknessAsDepth}}T([ft("Link refraction to transparency",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ka.prototype,"linkRefractionWithTransparency",void 0);T([ft("Invert refraction Y",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ka.prototype,"invertRefractionY",void 0);T([ft("Use thickness as depth",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Ka.prototype,"useThicknessAsDepth",void 0);he("BABYLON.RefractionBlock",Ka);class Nl extends Ie{constructor(e){super(e,U.Fragment),this._isUnique=!0,this.registerInput("thickness",I.Float,!1,U.Fragment),this.registerInput("tintColor",I.Color3,!0,U.Fragment),this.registerInput("translucencyIntensity",I.Float,!0,U.Fragment),this.registerInput("translucencyDiffusionDist",I.Color3,!0,U.Fragment),this.registerInput("refraction",I.Object,!0,U.Fragment,new Di("refraction",this,fi.Input,Ka,"RefractionBlock")),this.registerOutput("subsurface",I.Object,U.Fragment,new Di("subsurface",this,fi.Output,Nl,"SubSurfaceBlock"))}initialize(e){e._excludeVariableName("subSurfaceOut"),e._excludeVariableName("vThicknessParam"),e._excludeVariableName("vTintColor"),e._excludeVariableName("vSubSurfaceIntensity")}getClassName(){return"SubSurfaceBlock"}get thickness(){return this._inputs[0]}get tintColor(){return this._inputs[1]}get translucencyIntensity(){return this._inputs[2]}get translucencyDiffusionDist(){return this._inputs[3]}get refraction(){return this._inputs[4]}get subsurface(){return this._outputs[0]}autoConfigure(){if(!this.thickness.isConnected){const e=new Ye("SubSurface thickness",U.Fragment,I.Float);e.value=0,e.output.connectTo(this.thickness)}}prepareDefines(e,t,i){super.prepareDefines(e,t,i);const s=this.translucencyDiffusionDist.isConnected||this.translucencyIntensity.isConnected;i.setValue("SUBSURFACE",s||this.refraction.isConnected,!0),i.setValue("SS_TRANSLUCENCY",s,!0),i.setValue("SS_THICKNESSANDMASK_TEXTURE",!1,!0),i.setValue("SS_REFRACTIONINTENSITY_TEXTURE",!1,!0),i.setValue("SS_TRANSLUCENCYINTENSITY_TEXTURE",!1,!0),i.setValue("SS_MASK_FROM_THICKNESS_TEXTURE",!1,!0),i.setValue("SS_USE_GLTF_TEXTURES",!1,!0)}static GetCode(e,t,i,s){var r,n,o,l,h,c,u,d,f,p,_,m,v,x,b,S;let C="";const E=t!=null&&t.thickness.isConnected?t.thickness.associatedVariableName:"0.",A=t!=null&&t.tintColor.isConnected?t.tintColor.associatedVariableName:"vec3(1.)",M=t!=null&&t.translucencyIntensity.isConnected?t==null?void 0:t.translucencyIntensity.associatedVariableName:"1.",D=t!=null&&t.translucencyDiffusionDist.isConnected?t==null?void 0:t.translucencyDiffusionDist.associatedVariableName:"vec3(1.)",P=t!=null&&t.refraction.isConnected?(r=t==null?void 0:t.refraction.connectedPoint)===null||r===void 0?void 0:r.ownerBlock:null,O=P!=null&&P.tintAtDistance.isConnected?P.tintAtDistance.associatedVariableName:"1.",N=P!=null&&P.intensity.isConnected?P.intensity.associatedVariableName:"1.",$=P!=null&&P.view.isConnected?P.view.associatedVariableName:"";return C+=(n=P==null?void 0:P.getCode(e))!==null&&n!==void 0?n:"",C+=`subSurfaceOutParams subSurfaceOut;

        #ifdef SUBSURFACE
            vec2 vThicknessParam = vec2(0., ${E});
            vec4 vTintColor = vec4(${A}, ${O});
            vec3 vSubSurfaceIntensity = vec3(${N}, ${M}, 0.);

            subSurfaceBlock(
                vSubSurfaceIntensity,
                vThicknessParam,
                vTintColor,
                normalW,
                specularEnvironmentReflectance,
            #ifdef SS_THICKNESSANDMASK_TEXTURE
                vec4(0.),
            #endif
            #ifdef REFLECTION
                #ifdef SS_TRANSLUCENCY
                    ${i==null?void 0:i._reflectionMatrixName},
                    #ifdef USESPHERICALFROMREFLECTIONMAP
                        #if !defined(NORMAL) || !defined(USESPHERICALINVERTEX)
                            reflectionOut.irradianceVector,
                        #endif
                        #if defined(REALTIME_FILTERING)
                            ${i==null?void 0:i._cubeSamplerName},
                            ${i==null?void 0:i._vReflectionFilteringInfoName},
                        #endif
                        #endif
                    #ifdef USEIRRADIANCEMAP
                        irradianceSampler,
                    #endif
                #endif
            #endif
            #if defined(SS_REFRACTION) || defined(SS_TRANSLUCENCY)
                surfaceAlbedo,
            #endif
            #ifdef SS_REFRACTION
                ${s}.xyz,
                viewDirectionW,
                ${$},
                ${(o=P==null?void 0:P._vRefractionInfosName)!==null&&o!==void 0?o:""},
                ${(l=P==null?void 0:P._refractionMatrixName)!==null&&l!==void 0?l:""},
                ${(h=P==null?void 0:P._vRefractionMicrosurfaceInfosName)!==null&&h!==void 0?h:""},
                vLightingIntensity,
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha,
                #endif
                #ifdef ${(c=P==null?void 0:P._defineLODRefractionAlpha)!==null&&c!==void 0?c:"IGNORE"}
                    NdotVUnclamped,
                #endif
                #ifdef ${(u=P==null?void 0:P._defineLinearSpecularRefraction)!==null&&u!==void 0?u:"IGNORE"}
                    roughness,
                #endif
                alphaG,
                #ifdef ${(d=P==null?void 0:P._define3DName)!==null&&d!==void 0?d:"IGNORE"}
                    ${(f=P==null?void 0:P._cubeSamplerName)!==null&&f!==void 0?f:""},
                #else
                    ${(p=P==null?void 0:P._2DSamplerName)!==null&&p!==void 0?p:""},
                #endif
                #ifndef LODBASEDMICROSFURACE
                    #ifdef ${(_=P==null?void 0:P._define3DName)!==null&&_!==void 0?_:"IGNORE"}
                        ${(m=P==null?void 0:P._cubeSamplerName)!==null&&m!==void 0?m:""},
                        ${(v=P==null?void 0:P._cubeSamplerName)!==null&&v!==void 0?v:""},
                    #else
                        ${(x=P==null?void 0:P._2DSamplerName)!==null&&x!==void 0?x:""},
                        ${(b=P==null?void 0:P._2DSamplerName)!==null&&b!==void 0?b:""},
                    #endif
                #endif
                #ifdef ANISOTROPIC
                    anisotropicOut,
                #endif
                #ifdef REALTIME_FILTERING
                    ${(S=P==null?void 0:P._vRefractionFilteringInfoName)!==null&&S!==void 0?S:""},
                #endif
                #ifdef SS_USE_LOCAL_REFRACTIONMAP_CUBIC
                    vRefractionPosition,
                    vRefractionSize,
                #endif
            #endif
            #ifdef SS_TRANSLUCENCY
                ${D},
            #endif
                subSurfaceOut
            );

            #ifdef SS_REFRACTION
                surfaceAlbedo = subSurfaceOut.surfaceAlbedo;
                #ifdef SS_LINKREFRACTIONTOTRANSPARENCY
                    alpha = subSurfaceOut.alpha;
                #endif
            #endif
        #else
            subSurfaceOut.specularEnvironmentReflectance = specularEnvironmentReflectance;
        #endif\r
`,C}_buildBlock(e){return e.target===U.Fragment&&e.sharedData.blocksWithDefines.push(this),this}}he("BABYLON.SubSurfaceBlock",Nl);const SI={ambientClr:["finalAmbient",""],diffuseDir:["finalDiffuse",""],specularDir:["finalSpecularScaled","!defined(UNLIT) && defined(SPECULARTERM)"],clearcoatDir:["finalClearCoatScaled","!defined(UNLIT) && defined(CLEARCOAT)"],sheenDir:["finalSheenScaled","!defined(UNLIT) && defined(SHEEN)"],diffuseInd:["finalIrradiance","!defined(UNLIT) && defined(REFLECTION)"],specularInd:["finalRadianceScaled","!defined(UNLIT) && defined(REFLECTION)"],clearcoatInd:["clearcoatOut.finalClearCoatRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(CLEARCOAT)"],sheenInd:["sheenOut.finalSheenRadianceScaled","!defined(UNLIT) && defined(REFLECTION) && defined(SHEEN) && defined(ENVIRONMENTBRDF)"],refraction:["subSurfaceOut.finalRefraction","!defined(UNLIT) && defined(SS_REFRACTION)"],lighting:["finalColor.rgb",""],shadow:["shadow",""],alpha:["alpha",""]};class Gi extends Ie{constructor(e){super(e,U.VertexAndFragment),this._environmentBRDFTexture=null,this._metallicReflectanceColor=re.White(),this._metallicF0Factor=1,this.directIntensity=1,this.environmentIntensity=1,this.specularIntensity=1,this.lightFalloff=0,this.useAlphaTest=!1,this.alphaTestCutoff=.5,this.useAlphaBlending=!1,this.useRadianceOverAlpha=!0,this.useSpecularOverAlpha=!0,this.enableSpecularAntiAliasing=!1,this.realTimeFiltering=!1,this.realTimeFilteringQuality=8,this.useEnergyConservation=!0,this.useRadianceOcclusion=!0,this.useHorizonOcclusion=!0,this.unlit=!1,this.forceNormalForward=!1,this.debugMode=0,this.debugLimit=0,this.debugFactor=1,this._isUnique=!0,this.registerInput("worldPosition",I.Vector4,!1,U.Vertex),this.registerInput("worldNormal",I.Vector4,!1,U.Fragment),this.registerInput("view",I.Matrix,!1),this.registerInput("cameraPosition",I.Vector3,!1,U.Fragment),this.registerInput("perturbedNormal",I.Vector4,!0,U.Fragment),this.registerInput("baseColor",I.Color3,!0,U.Fragment),this.registerInput("metallic",I.Float,!1,U.Fragment),this.registerInput("roughness",I.Float,!1,U.Fragment),this.registerInput("ambientOcc",I.Float,!0,U.Fragment),this.registerInput("opacity",I.Float,!0,U.Fragment),this.registerInput("indexOfRefraction",I.Float,!0,U.Fragment),this.registerInput("ambientColor",I.Color3,!0,U.Fragment),this.registerInput("reflection",I.Object,!0,U.Fragment,new Di("reflection",this,fi.Input,$o,"ReflectionBlock")),this.registerInput("clearcoat",I.Object,!0,U.Fragment,new Di("clearcoat",this,fi.Input,Lo,"ClearCoatBlock")),this.registerInput("sheen",I.Object,!0,U.Fragment,new Di("sheen",this,fi.Input,Ko,"SheenBlock")),this.registerInput("subsurface",I.Object,!0,U.Fragment,new Di("subsurface",this,fi.Input,Nl,"SubSurfaceBlock")),this.registerInput("anisotropy",I.Object,!0,U.Fragment,new Di("anisotropy",this,fi.Input,su,"AnisotropyBlock")),this.registerInput("iridescence",I.Object,!0,U.Fragment,new Di("iridescence",this,fi.Input,wl,"IridescenceBlock")),this.registerOutput("ambientClr",I.Color3,U.Fragment),this.registerOutput("diffuseDir",I.Color3,U.Fragment),this.registerOutput("specularDir",I.Color3,U.Fragment),this.registerOutput("clearcoatDir",I.Color3,U.Fragment),this.registerOutput("sheenDir",I.Color3,U.Fragment),this.registerOutput("diffuseInd",I.Color3,U.Fragment),this.registerOutput("specularInd",I.Color3,U.Fragment),this.registerOutput("clearcoatInd",I.Color3,U.Fragment),this.registerOutput("sheenInd",I.Color3,U.Fragment),this.registerOutput("refraction",I.Color3,U.Fragment),this.registerOutput("lighting",I.Color3,U.Fragment),this.registerOutput("shadow",I.Float,U.Fragment),this.registerOutput("alpha",I.Float,U.Fragment)}initialize(e){e._excludeVariableName("vLightingIntensity"),e._excludeVariableName("geometricNormalW"),e._excludeVariableName("normalW"),e._excludeVariableName("faceNormal"),e._excludeVariableName("albedoOpacityOut"),e._excludeVariableName("surfaceAlbedo"),e._excludeVariableName("alpha"),e._excludeVariableName("aoOut"),e._excludeVariableName("baseColor"),e._excludeVariableName("reflectivityOut"),e._excludeVariableName("microSurface"),e._excludeVariableName("roughness"),e._excludeVariableName("NdotVUnclamped"),e._excludeVariableName("NdotV"),e._excludeVariableName("alphaG"),e._excludeVariableName("AARoughnessFactors"),e._excludeVariableName("environmentBrdf"),e._excludeVariableName("ambientMonochrome"),e._excludeVariableName("seo"),e._excludeVariableName("eho"),e._excludeVariableName("environmentRadiance"),e._excludeVariableName("irradianceVector"),e._excludeVariableName("environmentIrradiance"),e._excludeVariableName("diffuseBase"),e._excludeVariableName("specularBase"),e._excludeVariableName("preInfo"),e._excludeVariableName("info"),e._excludeVariableName("shadow"),e._excludeVariableName("finalDiffuse"),e._excludeVariableName("finalAmbient"),e._excludeVariableName("ambientOcclusionForDirectDiffuse"),e._excludeVariableName("finalColor"),e._excludeVariableName("vClipSpacePosition"),e._excludeVariableName("vDebugMode")}getClassName(){return"PBRMetallicRoughnessBlock"}get worldPosition(){return this._inputs[0]}get worldNormal(){return this._inputs[1]}get view(){return this._inputs[2]}get cameraPosition(){return this._inputs[3]}get perturbedNormal(){return this._inputs[4]}get baseColor(){return this._inputs[5]}get metallic(){return this._inputs[6]}get roughness(){return this._inputs[7]}get ambientOcc(){return this._inputs[8]}get opacity(){return this._inputs[9]}get indexOfRefraction(){return this._inputs[10]}get ambientColor(){return this._inputs[11]}get reflection(){return this._inputs[12]}get clearcoat(){return this._inputs[13]}get sheen(){return this._inputs[14]}get subsurface(){return this._inputs[15]}get anisotropy(){return this._inputs[16]}get iridescence(){return this._inputs[17]}get ambientClr(){return this._outputs[0]}get diffuseDir(){return this._outputs[1]}get specularDir(){return this._outputs[2]}get clearcoatDir(){return this._outputs[3]}get sheenDir(){return this._outputs[4]}get diffuseInd(){return this._outputs[5]}get specularInd(){return this._outputs[6]}get clearcoatInd(){return this._outputs[7]}get sheenInd(){return this._outputs[8]}get refraction(){return this._outputs[9]}get lighting(){return this._outputs[10]}get shadow(){return this._outputs[11]}get alpha(){return this._outputs[12]}autoConfigure(e){if(!this.cameraPosition.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.CameraPosition);t||(t=new Ye("cameraPosition"),t.setAsSystemValue(Ke.CameraPosition)),t.output.connectTo(this.cameraPosition)}if(!this.view.isConnected){let t=e.getInputBlockByPredicate(i=>i.systemValue===Ke.View);t||(t=new Ye("view"),t.setAsSystemValue(Ke.View)),t.output.connectTo(this.view)}}prepareDefines(e,t,i){i.setValue("PBR",!0),i.setValue("METALLICWORKFLOW",!0),i.setValue("DEBUGMODE",this.debugMode,!0),i.setValue("NORMALXYSCALE",!0),i.setValue("BUMP",this.perturbedNormal.isConnected,!0),i.setValue("LODBASEDMICROSFURACE",this._scene.getEngine().getCaps().textureLOD),i.setValue("ALBEDO",!1,!0),i.setValue("OPACITY",this.opacity.isConnected,!0),i.setValue("AMBIENT",!0,!0),i.setValue("AMBIENTINGRAYSCALE",!1,!0),i.setValue("REFLECTIVITY",!1,!0),i.setValue("AOSTOREINMETALMAPRED",!1,!0),i.setValue("METALLNESSSTOREINMETALMAPBLUE",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPALPHA",!1,!0),i.setValue("ROUGHNESSSTOREINMETALMAPGREEN",!1,!0),this.lightFalloff===vt.LIGHTFALLOFF_STANDARD?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!1)):this.lightFalloff===vt.LIGHTFALLOFF_GLTF?(i.setValue("USEPHYSICALLIGHTFALLOFF",!1),i.setValue("USEGLTFLIGHTFALLOFF",!0)):(i.setValue("USEPHYSICALLIGHTFALLOFF",!0),i.setValue("USEGLTFLIGHTFALLOFF",!1));const s=this.alphaTestCutoff.toString();i.setValue("ALPHABLEND",this.useAlphaBlending,!0),i.setValue("ALPHAFROMALBEDO",!1,!0),i.setValue("ALPHATEST",this.useAlphaTest,!0),i.setValue("ALPHATESTVALUE",s.indexOf(".")<0?s+".":s,!0),i.setValue("OPACITYRGB",!1,!0),i.setValue("RADIANCEOVERALPHA",this.useRadianceOverAlpha,!0),i.setValue("SPECULAROVERALPHA",this.useSpecularOverAlpha,!0),i.setValue("SPECULARAA",this._scene.getEngine().getCaps().standardDerivatives&&this.enableSpecularAntiAliasing,!0),i.setValue("REALTIME_FILTERING",this.realTimeFiltering,!0);const r=e.getScene();if(r.getEngine()._features.needTypeSuffixInShaderConstants?i.setValue("NUM_SAMPLES",this.realTimeFilteringQuality+"u",!0):i.setValue("NUM_SAMPLES",""+this.realTimeFilteringQuality,!0),i.setValue("BRDF_V_HEIGHT_CORRELATED",!0),i.setValue("MS_BRDF_ENERGY_CONSERVATION",this.useEnergyConservation,!0),i.setValue("RADIANCEOCCLUSION",this.useRadianceOcclusion,!0),i.setValue("HORIZONOCCLUSION",this.useHorizonOcclusion,!0),i.setValue("UNLIT",this.unlit,!0),i.setValue("FORCENORMALFORWARD",this.forceNormalForward,!0),this._environmentBRDFTexture&&ce.ReflectionTextureEnabled?(i.setValue("ENVIRONMENTBRDF",!0),i.setValue("ENVIRONMENTBRDF_RGBD",this._environmentBRDFTexture.isRGBD,!0)):(i.setValue("ENVIRONMENTBRDF",!1),i.setValue("ENVIRONMENTBRDF_RGBD",!1)),i._areImageProcessingDirty&&t.imageProcessingConfiguration&&t.imageProcessingConfiguration.prepareDefines(i),!!i._areLightsDirty)if(!this.light)se.PrepareDefinesForLights(r,e,i,!0,t.maxSimultaneousLights),i._needNormals=!0,se.PrepareDefinesForMultiview(r,i);else{const o={needNormals:!1,needRebuild:!1,lightmapMode:!1,shadowEnabled:!1,specularEnabled:!1};se.PrepareDefinesForLight(r,e,this.light,this._lightId,i,!0,o),o.needRebuild&&i.rebuild()}}updateUniformsAndSamples(e,t,i,s){for(let r=0;r<t.maxSimultaneousLights&&i["LIGHT"+r];r++){const n=e.uniforms.indexOf("vLightData"+r)>=0;se.PrepareUniformsAndSamplersForLight(r,e.uniforms,e.samplers,i["PROJECTEDLIGHTTEXTURE"+r],s,n)}}isReady(e,t,i){return!(this._environmentBRDFTexture&&!this._environmentBRDFTexture.isReady()||i._areImageProcessingDirty&&t.imageProcessingConfiguration&&!t.imageProcessingConfiguration.isReady())}bind(e,t,i){var s,r;if(!i)return;const n=i.getScene();this.light?se.BindLight(this.light,this._lightId,n,e,!0):se.BindLights(n,i,e,!0,t.maxSimultaneousLights),e.setTexture(this._environmentBrdfSamplerName,this._environmentBRDFTexture),e.setFloat2("vDebugMode",this.debugLimit,this.debugFactor);const o=this._scene.ambientColor;o&&e.setColor3("ambientFromScene",o);const l=n.useRightHandedSystem===(n._mirroredCameraPosition!=null);e.setFloat(this._invertNormalName,l?-1:1),e.setFloat4("vLightingIntensity",this.directIntensity,1,this.environmentIntensity*this._scene.environmentIntensity,this.specularIntensity);const h=1,c=(r=(s=this.indexOfRefraction.connectInputBlock)===null||s===void 0?void 0:s.value)!==null&&r!==void 0?r:1.5,u=Math.pow((c-h)/(c+h),2);this._metallicReflectanceColor.scaleToRef(u*this._metallicF0Factor,ht.Color3[0]);const d=this._metallicF0Factor;e.setColor4(this._vMetallicReflectanceFactorsName,ht.Color3[0],d),t.imageProcessingConfiguration&&t.imageProcessingConfiguration.bind(e)}_injectVertexCode(e){var t,i;const s=this.worldPosition,r=`//${this.name}`;this.light?(this._lightId=(e.counters.lightCounter!==void 0?e.counters.lightCounter:-1)+1,e.counters.lightCounter=this._lightId,e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString())):(e._emitFunctionFromInclude(e.supportUniformBuffers?"lightVxUboDeclaration":"lightVxFragmentDeclaration",r,{repeatKey:"maxSimultaneousLights"}),this._lightId=0,e.sharedData.dynamicUniformBlocks.push(this));const n="v_"+s.associatedVariableName;e._emitVaryingFromString(n,"vec4")&&(e.compilationString+=`${n} = ${s.associatedVariableName};\r
`);const o=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;o&&(o.viewConnectionPoint=this.view),e.compilationString+=(i=o==null?void 0:o.handleVertexSide(e))!==null&&i!==void 0?i:"",e._emitUniformFromString("vDebugMode","vec2","defined(IGNORE) || DEBUGMODE > 0"),e._emitUniformFromString("ambientFromScene","vec3"),e._emitVaryingFromString("vClipSpacePosition","vec4","defined(IGNORE) || DEBUGMODE > 0")&&(e._injectAtEnd+=`#if DEBUGMODE > 0\r
`,e._injectAtEnd+=`vClipSpacePosition = gl_Position;\r
`,e._injectAtEnd+=`#endif\r
`),this.light?e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()},{search:/worldPos/g,replace:s.associatedVariableName}]}):(e.compilationString+=`vec4 worldPos = ${s.associatedVariableName};\r
`,this.view.isConnected&&(e.compilationString+=`mat4 view = ${this.view.associatedVariableName};\r
`),e.compilationString+=e._emitCodeFromInclude("shadowsVertex",r,{repeatKey:"maxSimultaneousLights"}))}_getAlbedoOpacityCode(){let e=`albedoOpacityOutParams albedoOpacityOut;\r
`;const t=this.baseColor.isConnected?this.baseColor.associatedVariableName:"vec3(1.)",i=this.opacity.isConnected?this.opacity.associatedVariableName:"1.";return e+=`albedoOpacityBlock(
                vec4(${t}, 1.),
            #ifdef ALBEDO
                vec4(1.),
                vec2(1., 1.),
            #endif
            #ifdef OPACITY
                vec4(${i}),
                vec2(1., 1.),
            #endif
                albedoOpacityOut
            );

            vec3 surfaceAlbedo = albedoOpacityOut.surfaceAlbedo;
            float alpha = albedoOpacityOut.alpha;\r
`,e}_getAmbientOcclusionCode(){let e=`ambientOcclusionOutParams aoOut;\r
`;return e+=`ambientOcclusionBlock(
            #ifdef AMBIENT
                vec3(${this.ambientOcc.isConnected?this.ambientOcc.associatedVariableName:"1."}),
                vec4(0., 1.0, 1.0, 0.),
            #endif
                aoOut
            );\r
`,e}_getReflectivityCode(e){let t=`reflectivityOutParams reflectivityOut;\r
`;const i="1.";return this._vMetallicReflectanceFactorsName=e._getFreeVariableName("vMetallicReflectanceFactors"),e._emitUniformFromString(this._vMetallicReflectanceFactorsName,"vec4"),t+=`vec3 baseColor = surfaceAlbedo;

            reflectivityBlock(
                vec4(${this.metallic.associatedVariableName}, ${this.roughness.associatedVariableName}, 0., 0.),
            #ifdef METALLICWORKFLOW
                surfaceAlbedo,
                ${this._vMetallicReflectanceFactorsName},
            #endif
            #ifdef REFLECTIVITY
                vec3(0., 0., ${i}),
                vec4(1.),
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY)  && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor,
            #endif
            #ifdef MICROSURFACEMAP
                microSurfaceTexel, <== not handled!
            #endif
                reflectivityOut
            );

            float microSurface = reflectivityOut.microSurface;
            float roughness = reflectivityOut.roughness;

            #ifdef METALLICWORKFLOW
                surfaceAlbedo = reflectivityOut.surfaceAlbedo;
            #endif
            #if defined(METALLICWORKFLOW) && defined(REFLECTIVITY) && defined(AOSTOREINMETALMAPRED)
                aoOut.ambientOcclusionColor = reflectivityOut.ambientOcclusionColor;
            #endif\r
`,t}_buildBlock(e){var t,i,s,r,n,o,l,h,c,u,d,f,p,_,m,v,x,b,S,C,E,A,M,D,P,O,N,$,W,K,te,ve,_e,j,ee,F,z,Z,Ee,He,ut;super._buildBlock(e),this._scene=e.sharedData.scene,this._environmentBRDFTexture||(this._environmentBRDFTexture=r0(this._scene));const me=this.reflection.isConnected?(t=this.reflection.connectedPoint)===null||t===void 0?void 0:t.ownerBlock:null;if(me&&(me.worldPositionConnectionPoint=this.worldPosition,me.cameraPositionConnectionPoint=this.cameraPosition,me.worldNormalConnectionPoint=this.worldNormal),e.target!==U.Fragment)return this._injectVertexCode(e),this;e.sharedData.forcedBindableBlocks.push(this),e.sharedData.blocksWithDefines.push(this),e.sharedData.blockingBlocks.push(this);const Se=`//${this.name}`,it="v_"+this.worldPosition.associatedVariableName,Zt=this.perturbedNormal;this._environmentBrdfSamplerName=e._getFreeVariableName("environmentBrdfSampler"),e._emit2DSampler(this._environmentBrdfSamplerName),e.sharedData.hints.needAlphaBlending=e.sharedData.hints.needAlphaBlending||this.useAlphaBlending,e.sharedData.hints.needAlphaTesting=e.sharedData.hints.needAlphaTesting||this.useAlphaTest,e._emitExtension("lod","#extension GL_EXT_shader_texture_lod : enable","defined(LODBASEDMICROSFURACE)"),e._emitExtension("derivatives","#extension GL_OES_standard_derivatives : enable"),e.uniforms.push("exposureLinear"),e.uniforms.push("contrast"),e.uniforms.push("vInverseScreenSize"),e.uniforms.push("vignetteSettings1"),e.uniforms.push("vignetteSettings2"),e.uniforms.push("vCameraColorCurveNegative"),e.uniforms.push("vCameraColorCurveNeutral"),e.uniforms.push("vCameraColorCurvePositive"),e.uniforms.push("txColorTransform"),e.uniforms.push("colorTransformSettings"),e.uniforms.push("ditherIntensity"),this.light?e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",Se,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]},this._lightId.toString()):e._emitFunctionFromInclude(e.supportUniformBuffers?"lightUboDeclaration":"lightFragmentDeclaration",Se,{repeatKey:"maxSimultaneousLights"}),e._emitFunctionFromInclude("helperFunctions",Se),e._emitFunctionFromInclude("importanceSampling",Se),e._emitFunctionFromInclude("pbrHelperFunctions",Se),e._emitFunctionFromInclude("imageProcessingDeclaration",Se),e._emitFunctionFromInclude("imageProcessingFunctions",Se),e._emitFunctionFromInclude("shadowsFragmentFunctions",Se,{replaceStrings:[{search:/vPositionW/g,replace:it+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingSetupFunctions",Se,{replaceStrings:[{search:/vPositionW/g,replace:it+".xyz"}]}),e._emitFunctionFromInclude("pbrDirectLightingFalloffFunctions",Se),e._emitFunctionFromInclude("pbrBRDFFunctions",Se,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(i=me==null?void 0:me._defineSkyboxName)!==null&&i!==void 0?i:"REFLECTIONMAP_SKYBOX"}]}),e._emitFunctionFromInclude("hdrFilteringFunctions",Se),e._emitFunctionFromInclude("pbrDirectLightingFunctions",Se,{replaceStrings:[{search:/vPositionW/g,replace:it+".xyz"}]}),e._emitFunctionFromInclude("pbrIBLFunctions",Se),e._emitFunctionFromInclude("pbrBlockAlbedoOpacity",Se),e._emitFunctionFromInclude("pbrBlockReflectivity",Se),e._emitFunctionFromInclude("pbrBlockAmbientOcclusion",Se),e._emitFunctionFromInclude("pbrBlockAlphaFresnel",Se),e._emitFunctionFromInclude("pbrBlockAnisotropic",Se),e._emitUniformFromString("vLightingIntensity","vec4"),this._vNormalWName=e._getFreeVariableName("vNormalW"),e.compilationString+=`vec4 ${this._vNormalWName} = normalize(${this.worldNormal.associatedVariableName});\r
`,e._registerTempVariable("viewDirectionW")&&(e.compilationString+=`vec3 viewDirectionW = normalize(${this.cameraPosition.associatedVariableName} - ${it}.xyz);\r
`),e.compilationString+=`vec3 geometricNormalW = ${this._vNormalWName}.xyz;\r
`,e.compilationString+=`vec3 normalW = ${Zt.isConnected?"normalize("+Zt.associatedVariableName+".xyz)":"geometricNormalW"};\r
`,this._invertNormalName=e._getFreeVariableName("invertNormal"),e._emitUniformFromString(this._invertNormalName,"float"),e.compilationString+=e._emitCodeFromInclude("pbrBlockNormalFinal",Se,{replaceStrings:[{search:/vPositionW/g,replace:it+".xyz"},{search:/vEyePosition.w/g,replace:this._invertNormalName}]}),e.compilationString+=this._getAlbedoOpacityCode(),e.compilationString+=e._emitCodeFromInclude("depthPrePass",Se),e.compilationString+=this._getAmbientOcclusionCode(),e.compilationString+=e._emitCodeFromInclude("pbrBlockLightmapInit",Se),e.compilationString+=`#ifdef UNLIT
                vec3 diffuseBase = vec3(1., 1., 1.);
            #else\r
`,e.compilationString+=this._getReflectivityCode(e),e.compilationString+=e._emitCodeFromInclude("pbrBlockGeometryInfo",Se,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(s=me==null?void 0:me._defineSkyboxName)!==null&&s!==void 0?s:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(r=me==null?void 0:me._define3DName)!==null&&r!==void 0?r:"REFLECTIONMAP_3D"}]});const Xe=this.anisotropy.isConnected?(n=this.anisotropy.connectedPoint)===null||n===void 0?void 0:n.ownerBlock:null;Xe&&(Xe.worldPositionConnectionPoint=this.worldPosition,Xe.worldNormalConnectionPoint=this.worldNormal,e.compilationString+=Xe.getCode(e,!this.perturbedNormal.isConnected)),me&&me.hasTexture&&(e.compilationString+=me.getCode(e,Xe?"anisotropicOut.anisotropicNormal":"normalW")),e._emitFunctionFromInclude("pbrBlockReflection",Se,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(o=me==null?void 0:me._define3DName)!==null&&o!==void 0?o:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(l=me==null?void 0:me._defineOppositeZ)!==null&&l!==void 0?l:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(h=me==null?void 0:me._defineProjectionName)!==null&&h!==void 0?h:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(c=me==null?void 0:me._defineSkyboxName)!==null&&c!==void 0?c:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(u=me==null?void 0:me._defineLODReflectionAlpha)!==null&&u!==void 0?u:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(d=me==null?void 0:me._defineLinearSpecularReflection)!==null&&d!==void 0?d:"LINEARSPECULARREFLECTION"},{search:/vReflectionFilteringInfo/g,replace:(f=me==null?void 0:me._vReflectionFilteringInfoName)!==null&&f!==void 0?f:"vReflectionFilteringInfo"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance0",Se,{replaceStrings:[{search:/metallicReflectanceFactors/g,replace:this._vMetallicReflectanceFactorsName}]});const Re=this.sheen.isConnected?(p=this.sheen.connectedPoint)===null||p===void 0?void 0:p.ownerBlock:null;Re&&(e.compilationString+=Re.getCode(me)),e._emitFunctionFromInclude("pbrBlockSheen",Se,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(_=me==null?void 0:me._define3DName)!==null&&_!==void 0?_:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(m=me==null?void 0:me._defineSkyboxName)!==null&&m!==void 0?m:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:(v=me==null?void 0:me._defineLODReflectionAlpha)!==null&&v!==void 0?v:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(x=me==null?void 0:me._defineLinearSpecularReflection)!==null&&x!==void 0?x:"LINEARSPECULARREFLECTION"}]});const rt=this.iridescence.isConnected?(b=this.iridescence.connectedPoint)===null||b===void 0?void 0:b.ownerBlock:null;e.compilationString+=wl.GetCode(rt),e._emitFunctionFromInclude("pbrBlockIridescence",Se,{replaceStrings:[]});const xt=this.clearcoat.isConnected?(S=this.clearcoat.connectedPoint)===null||S===void 0?void 0:S.ownerBlock:null,At=!this.perturbedNormal.isConnected&&!this.anisotropy.isConnected,Ut=this.perturbedNormal.isConnected&&((E=((C=this.perturbedNormal.connectedPoint)===null||C===void 0?void 0:C.ownerBlock).worldTangent)===null||E===void 0?void 0:E.isConnected),ms=this.anisotropy.isConnected&&((A=this.anisotropy.connectedPoint)===null||A===void 0?void 0:A.ownerBlock).worldTangent.isConnected;let wi=Ut||!this.perturbedNormal.isConnected&&ms;e.compilationString+=Lo.GetCode(e,xt,me,it,At,wi,this.worldNormal.associatedVariableName),At&&(wi=(M=xt==null?void 0:xt.worldTangent.isConnected)!==null&&M!==void 0?M:!1),e._emitFunctionFromInclude("pbrBlockClearcoat",Se,{replaceStrings:[{search:/computeReflectionCoords/g,replace:"computeReflectionCoordsPBR"},{search:/REFLECTIONMAP_3D/g,replace:(D=me==null?void 0:me._define3DName)!==null&&D!==void 0?D:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(P=me==null?void 0:me._defineOppositeZ)!==null&&P!==void 0?P:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(O=me==null?void 0:me._defineProjectionName)!==null&&O!==void 0?O:"REFLECTIONMAP_PROJECTION"},{search:/REFLECTIONMAP_SKYBOX/g,replace:(N=me==null?void 0:me._defineSkyboxName)!==null&&N!==void 0?N:"REFLECTIONMAP_SKYBOX"},{search:/LODINREFLECTIONALPHA/g,replace:($=me==null?void 0:me._defineLODReflectionAlpha)!==null&&$!==void 0?$:"LODINREFLECTIONALPHA"},{search:/LINEARSPECULARREFLECTION/g,replace:(W=me==null?void 0:me._defineLinearSpecularReflection)!==null&&W!==void 0?W:"LINEARSPECULARREFLECTION"},{search:/defined\(TANGENT\)/g,replace:wi?"defined(TANGENT)":"defined(IGNORE)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockReflectance",Se,{replaceStrings:[{search:/REFLECTIONMAP_SKYBOX/g,replace:(K=me==null?void 0:me._defineSkyboxName)!==null&&K!==void 0?K:"REFLECTIONMAP_SKYBOX"},{search:/REFLECTIONMAP_3D/g,replace:(te=me==null?void 0:me._define3DName)!==null&&te!==void 0?te:"REFLECTIONMAP_3D"}]});const Tr=this.subsurface.isConnected?(ve=this.subsurface.connectedPoint)===null||ve===void 0?void 0:ve.ownerBlock:null,jt=this.subsurface.isConnected?(j=((_e=this.subsurface.connectedPoint)===null||_e===void 0?void 0:_e.ownerBlock).refraction.connectedPoint)===null||j===void 0?void 0:j.ownerBlock:null;jt&&(jt.viewConnectionPoint=this.view,jt.indexOfRefractionConnectionPoint=this.indexOfRefraction),e.compilationString+=Nl.GetCode(e,Tr,me,it),e._emitFunctionFromInclude("pbrBlockSubSurface",Se,{replaceStrings:[{search:/REFLECTIONMAP_3D/g,replace:(ee=me==null?void 0:me._define3DName)!==null&&ee!==void 0?ee:"REFLECTIONMAP_3D"},{search:/REFLECTIONMAP_OPPOSITEZ/g,replace:(F=me==null?void 0:me._defineOppositeZ)!==null&&F!==void 0?F:"REFLECTIONMAP_OPPOSITEZ"},{search:/REFLECTIONMAP_PROJECTION/g,replace:(z=me==null?void 0:me._defineProjectionName)!==null&&z!==void 0?z:"REFLECTIONMAP_PROJECTION"},{search:/SS_REFRACTIONMAP_3D/g,replace:(Z=jt==null?void 0:jt._define3DName)!==null&&Z!==void 0?Z:"SS_REFRACTIONMAP_3D"},{search:/SS_LODINREFRACTIONALPHA/g,replace:(Ee=jt==null?void 0:jt._defineLODRefractionAlpha)!==null&&Ee!==void 0?Ee:"SS_LODINREFRACTIONALPHA"},{search:/SS_LINEARSPECULARREFRACTION/g,replace:(He=jt==null?void 0:jt._defineLinearSpecularRefraction)!==null&&He!==void 0?He:"SS_LINEARSPECULARREFRACTION"},{search:/SS_REFRACTIONMAP_OPPOSITEZ/g,replace:(ut=jt==null?void 0:jt._defineOppositeZ)!==null&&ut!==void 0?ut:"SS_REFRACTIONMAP_OPPOSITEZ"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockDirectLighting",Se),this.light?e.compilationString+=e._emitCodeFromInclude("lightFragment",Se,{replaceStrings:[{search:/{X}/g,replace:this._lightId.toString()}]}):e.compilationString+=e._emitCodeFromInclude("lightFragment",Se,{repeatKey:"maxSimultaneousLights"}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalLitComponents",Se),e.compilationString+=`#endif\r
`;const Rs=this.ambientColor.isConnected?this.ambientColor.associatedVariableName:"vec3(0., 0., 0.)";let Ls=vt.DEFAULT_AO_ON_ANALYTICAL_LIGHTS.toString();Ls.indexOf(".")===-1&&(Ls+="."),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalUnlitComponents",Se,{replaceStrings:[{search:/vec3 finalEmissive[\s\S]*?finalEmissive\*=vLightingIntensity\.y;/g,replace:""},{search:/vAmbientColor/g,replace:Rs+" * ambientFromScene"},{search:/vAmbientInfos\.w/g,replace:Ls}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockFinalColorComposition",Se,{replaceStrings:[{search:/finalEmissive/g,replace:"vec3(0.)"}]}),e.compilationString+=e._emitCodeFromInclude("pbrBlockImageProcessing",Se,{replaceStrings:[{search:/visibility/g,replace:"1."}]}),e.compilationString+=e._emitCodeFromInclude("pbrDebug",Se,{replaceStrings:[{search:/vNormalW/g,replace:this._vNormalWName},{search:/vPositionW/g,replace:it},{search:/albedoTexture\.rgb;/g,replace:`vec3(1.);\r
gl_FragColor.rgb = toGammaSpace(gl_FragColor.rgb);\r
`}]});for(const or of this._outputs)if(or.hasEndpoints){const Hs=SI[or.name];if(Hs){const[us,Ni]=Hs;Ni&&(e.compilationString+=`#if ${Ni}\r
`),e.compilationString+=`${this._declareOutput(or,e)} = ${us};\r
`,Ni&&(e.compilationString+=`#else\r
`,e.compilationString+=`${this._declareOutput(or,e)} = vec3(0.);\r
`,e.compilationString+=`#endif\r
`)}else console.error(`There's no remapping for the ${or.name} end point! No code generated`)}return this}_dumpPropertiesCode(){let e=super._dumpPropertiesCode();return e+=`${this._codeVariableName}.lightFalloff = ${this.lightFalloff};\r
`,e+=`${this._codeVariableName}.useAlphaTest = ${this.useAlphaTest};\r
`,e+=`${this._codeVariableName}.alphaTestCutoff = ${this.alphaTestCutoff};\r
`,e+=`${this._codeVariableName}.useAlphaBlending = ${this.useAlphaBlending};\r
`,e+=`${this._codeVariableName}.useRadianceOverAlpha = ${this.useRadianceOverAlpha};\r
`,e+=`${this._codeVariableName}.useSpecularOverAlpha = ${this.useSpecularOverAlpha};\r
`,e+=`${this._codeVariableName}.enableSpecularAntiAliasing = ${this.enableSpecularAntiAliasing};\r
`,e+=`${this._codeVariableName}.realTimeFiltering = ${this.realTimeFiltering};\r
`,e+=`${this._codeVariableName}.realTimeFilteringQuality = ${this.realTimeFilteringQuality};\r
`,e+=`${this._codeVariableName}.useEnergyConservation = ${this.useEnergyConservation};\r
`,e+=`${this._codeVariableName}.useRadianceOcclusion = ${this.useRadianceOcclusion};\r
`,e+=`${this._codeVariableName}.useHorizonOcclusion = ${this.useHorizonOcclusion};\r
`,e+=`${this._codeVariableName}.unlit = ${this.unlit};\r
`,e+=`${this._codeVariableName}.forceNormalForward = ${this.forceNormalForward};\r
`,e+=`${this._codeVariableName}.debugMode = ${this.debugMode};\r
`,e+=`${this._codeVariableName}.debugLimit = ${this.debugLimit};\r
`,e+=`${this._codeVariableName}.debugFactor = ${this.debugFactor};\r
`,e}serialize(){const e=super.serialize();return this.light&&(e.lightId=this.light.id),e.lightFalloff=this.lightFalloff,e.useAlphaTest=this.useAlphaTest,e.alphaTestCutoff=this.alphaTestCutoff,e.useAlphaBlending=this.useAlphaBlending,e.useRadianceOverAlpha=this.useRadianceOverAlpha,e.useSpecularOverAlpha=this.useSpecularOverAlpha,e.enableSpecularAntiAliasing=this.enableSpecularAntiAliasing,e.realTimeFiltering=this.realTimeFiltering,e.realTimeFilteringQuality=this.realTimeFilteringQuality,e.useEnergyConservation=this.useEnergyConservation,e.useRadianceOcclusion=this.useRadianceOcclusion,e.useHorizonOcclusion=this.useHorizonOcclusion,e.unlit=this.unlit,e.forceNormalForward=this.forceNormalForward,e.debugMode=this.debugMode,e.debugLimit=this.debugLimit,e.debugFactor=this.debugFactor,e}_deserialize(e,t,i){var s,r;super._deserialize(e,t,i),e.lightId&&(this.light=t.getLightById(e.lightId)),this.lightFalloff=(s=e.lightFalloff)!==null&&s!==void 0?s:0,this.useAlphaTest=e.useAlphaTest,this.alphaTestCutoff=e.alphaTestCutoff,this.useAlphaBlending=e.useAlphaBlending,this.useRadianceOverAlpha=e.useRadianceOverAlpha,this.useSpecularOverAlpha=e.useSpecularOverAlpha,this.enableSpecularAntiAliasing=e.enableSpecularAntiAliasing,this.realTimeFiltering=!!e.realTimeFiltering,this.realTimeFilteringQuality=(r=e.realTimeFilteringQuality)!==null&&r!==void 0?r:8,this.useEnergyConservation=e.useEnergyConservation,this.useRadianceOcclusion=e.useRadianceOcclusion,this.useHorizonOcclusion=e.useHorizonOcclusion,this.unlit=e.unlit,this.forceNormalForward=!!e.forceNormalForward,this.debugMode=e.debugMode,this.debugLimit=e.debugLimit,this.debugFactor=e.debugFactor}}T([ft("Direct lights",at.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Gi.prototype,"directIntensity",void 0);T([ft("Environment lights",at.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Gi.prototype,"environmentIntensity",void 0);T([ft("Specular highlights",at.Float,"INTENSITY",{min:0,max:1,notifiers:{update:!0}})],Gi.prototype,"specularIntensity",void 0);T([ft("Light falloff",at.List,"LIGHTING & COLORS",{notifiers:{update:!0},options:[{label:"Physical",value:vt.LIGHTFALLOFF_PHYSICAL},{label:"GLTF",value:vt.LIGHTFALLOFF_GLTF},{label:"Standard",value:vt.LIGHTFALLOFF_STANDARD}]})],Gi.prototype,"lightFalloff",void 0);T([ft("Alpha Testing",at.Boolean,"OPACITY")],Gi.prototype,"useAlphaTest",void 0);T([ft("Alpha CutOff",at.Float,"OPACITY",{min:0,max:1,notifiers:{update:!0}})],Gi.prototype,"alphaTestCutoff",void 0);T([ft("Alpha blending",at.Boolean,"OPACITY")],Gi.prototype,"useAlphaBlending",void 0);T([ft("Radiance over alpha",at.Boolean,"RENDERING",{notifiers:{update:!0}})],Gi.prototype,"useRadianceOverAlpha",void 0);T([ft("Specular over alpha",at.Boolean,"RENDERING",{notifiers:{update:!0}})],Gi.prototype,"useSpecularOverAlpha",void 0);T([ft("Specular anti-aliasing",at.Boolean,"RENDERING",{notifiers:{update:!0}})],Gi.prototype,"enableSpecularAntiAliasing",void 0);T([ft("Realtime filtering",at.Boolean,"RENDERING",{notifiers:{update:!0}})],Gi.prototype,"realTimeFiltering",void 0);T([ft("Realtime filtering quality",at.List,"RENDERING",{notifiers:{update:!0},options:[{label:"Low",value:8},{label:"Medium",value:16},{label:"High",value:64}]})],Gi.prototype,"realTimeFilteringQuality",void 0);T([ft("Energy Conservation",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Gi.prototype,"useEnergyConservation",void 0);T([ft("Radiance occlusion",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Gi.prototype,"useRadianceOcclusion",void 0);T([ft("Horizon occlusion",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Gi.prototype,"useHorizonOcclusion",void 0);T([ft("Unlit",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Gi.prototype,"unlit",void 0);T([ft("Force normal forward",at.Boolean,"ADVANCED",{notifiers:{update:!0}})],Gi.prototype,"forceNormalForward",void 0);T([ft("Debug mode",at.List,"DEBUG",{notifiers:{update:!0},options:[{label:"None",value:0},{label:"Normalized position",value:1},{label:"Normals",value:2},{label:"Tangents",value:3},{label:"Bitangents",value:4},{label:"Bump Normals",value:5},{label:"ClearCoat Normals",value:8},{label:"ClearCoat Tangents",value:9},{label:"ClearCoat Bitangents",value:10},{label:"Anisotropic Normals",value:11},{label:"Anisotropic Tangents",value:12},{label:"Anisotropic Bitangents",value:13},{label:"Env Refraction",value:40},{label:"Env Reflection",value:41},{label:"Env Clear Coat",value:42},{label:"Direct Diffuse",value:50},{label:"Direct Specular",value:51},{label:"Direct Clear Coat",value:52},{label:"Direct Sheen",value:53},{label:"Env Irradiance",value:54},{label:"Surface Albedo",value:60},{label:"Reflectance 0",value:61},{label:"Metallic",value:62},{label:"Metallic F0",value:71},{label:"Roughness",value:63},{label:"AlphaG",value:64},{label:"NdotV",value:65},{label:"ClearCoat Color",value:66},{label:"ClearCoat Roughness",value:67},{label:"ClearCoat NdotV",value:68},{label:"Transmittance",value:69},{label:"Refraction Transmittance",value:70},{label:"SEO",value:80},{label:"EHO",value:81},{label:"Energy Factor",value:82},{label:"Specular Reflectance",value:83},{label:"Clear Coat Reflectance",value:84},{label:"Sheen Reflectance",value:85},{label:"Luminance Over Alpha",value:86},{label:"Alpha",value:87}]})],Gi.prototype,"debugMode",void 0);T([ft("Split position",at.Float,"DEBUG",{min:-1,max:1,notifiers:{update:!0}})],Gi.prototype,"debugLimit",void 0);T([ft("Output factor",at.Float,"DEBUG",{min:0,max:5,notifiers:{update:!0}})],Gi.prototype,"debugFactor",void 0);he("BABYLON.PBRMetallicRoughnessBlock",Gi);class EI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("left",I.AutoDetect),this.registerInput("right",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0],this._linkConnectionTypes(0,1)}getClassName(){return"ModBlock"}get left(){return this._inputs[0]}get right(){return this._inputs[1]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0];return e.compilationString+=this._declareOutput(t,e)+` = mod(${this.left.associatedVariableName}, ${this.right.associatedVariableName});\r
`,this}}he("BABYLON.ModBlock",EI);class CI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("row0",I.Vector4),this.registerInput("row1",I.Vector4),this.registerInput("row2",I.Vector4),this.registerInput("row3",I.Vector4),this.registerOutput("output",I.Matrix)}getClassName(){return"MatrixBuilder"}get row0(){return this._inputs[0]}get row1(){return this._inputs[1]}get row2(){return this._inputs[2]}get row3(){return this._inputs[3]}get output(){return this._outputs[0]}autoConfigure(){if(!this.row0.isConnected){const e=new Ye("row0");e.value=new Ge(1,0,0,0),e.output.connectTo(this.row0)}if(!this.row1.isConnected){const e=new Ye("row1");e.value=new Ge(0,1,0,0),e.output.connectTo(this.row1)}if(!this.row2.isConnected){const e=new Ye("row2");e.value=new Ge(0,0,1,0),e.output.connectTo(this.row2)}if(!this.row3.isConnected){const e=new Ye("row3");e.value=new Ge(0,0,0,1),e.output.connectTo(this.row3)}}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.row0,s=this.row1,r=this.row2,n=this.row3;return e.compilationString+=this._declareOutput(t,e)+` = mat4(${i.associatedVariableName}, ${s.associatedVariableName}, ${r.associatedVariableName}, ${n.associatedVariableName});\r
`,this}}he("BABYLON.MatrixBuilder",CI);var Xs;(function(a){a[a.Equal=0]="Equal",a[a.NotEqual=1]="NotEqual",a[a.LessThan=2]="LessThan",a[a.GreaterThan=3]="GreaterThan",a[a.LessOrEqual=4]="LessOrEqual",a[a.GreaterOrEqual=5]="GreaterOrEqual",a[a.Xor=6]="Xor",a[a.Or=7]="Or",a[a.And=8]="And"})(Xs||(Xs={}));class yI extends Ie{constructor(e){super(e,U.Neutral),this.condition=Xs.LessThan,this.registerInput("a",I.Float),this.registerInput("b",I.Float),this.registerInput("true",I.AutoDetect,!0),this.registerInput("false",I.AutoDetect,!0),this.registerOutput("output",I.BasedOnInput),this._linkConnectionTypes(2,3),this._outputs[0]._typeConnectionSource=this._inputs[2],this._outputs[0]._defaultConnectionPointType=I.Float}getClassName(){return"ConditionalBlock"}get a(){return this._inputs[0]}get b(){return this._inputs[1]}get true(){return this._inputs[2]}get false(){return this._inputs[3]}get output(){return this._outputs[0]}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this.true.isConnected?this.true.associatedVariableName:"1.0",s=this.false.isConnected?this.false.associatedVariableName:"0.0";switch(this.condition){case Xs.Equal:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} == ${this.b.associatedVariableName} ? ${i} : ${s};\r
`;break}case Xs.NotEqual:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} != ${this.b.associatedVariableName} ? ${i} : ${s};\r
`;break}case Xs.LessThan:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} < ${this.b.associatedVariableName} ? ${i} : ${s};\r
`;break}case Xs.LessOrEqual:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} <= ${this.b.associatedVariableName} ? ${i} : ${s};\r
`;break}case Xs.GreaterThan:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} > ${this.b.associatedVariableName} ? ${i} : ${s};\r
`;break}case Xs.GreaterOrEqual:{e.compilationString+=this._declareOutput(t,e)+` = ${this.a.associatedVariableName} >= ${this.b.associatedVariableName} ? ${i} : ${s};\r
`;break}case Xs.Xor:{e.compilationString+=this._declareOutput(t,e)+` = (mod(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 2.0) > 0.0) ? ${i} : ${s};\r
`;break}case Xs.Or:{e.compilationString+=this._declareOutput(t,e)+` = (min(${this.a.associatedVariableName} + ${this.b.associatedVariableName}, 1.0) > 0.0) ? ${i} : ${s};\r
`;break}case Xs.And:{e.compilationString+=this._declareOutput(t,e)+` = (${this.a.associatedVariableName} * ${this.b.associatedVariableName} > 0.0)  ? ${i} : ${s};\r
`;break}}return this}serialize(){const e=super.serialize();return e.condition=this.condition,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.condition=e.condition}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.condition = BABYLON.ConditionalBlockConditions.${Xs[this.condition]};\r
`}}he("BABYLON.ConditionalBlock",yI);class Im extends Ie{constructor(e){super(e,U.Neutral),this.octaves=6,this.registerInput("seed",I.AutoDetect),this.registerInput("chaos",I.AutoDetect,!0),this.registerInput("offsetX",I.Float,!0),this.registerInput("offsetY",I.Float,!0),this.registerInput("offsetZ",I.Float,!0),this.registerOutput("output",I.Float),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector2),this._inputs[0].acceptedConnectionPointTypes.push(I.Vector3),this._linkConnectionTypes(0,1)}getClassName(){return"CloudBlock"}get seed(){return this._inputs[0]}get chaos(){return this._inputs[1]}get offsetX(){return this._inputs[2]}get offsetY(){return this._inputs[3]}get offsetZ(){return this._inputs[4]}get output(){return this._outputs[0]}_buildBlock(e){var t,i;if(super._buildBlock(e),!this.seed.isConnected||!this._outputs[0].hasEndpoints)return;const s=`

        float cloudRandom(in float p) { p = fract(p * 0.011); p *= p + 7.5; p *= p + p; return fract(p); }

        // Based on Morgan McGuire @morgan3d
        // https://www.shadertoy.com/view/4dS3Wd
        float cloudNoise(in vec2 x, in vec2 chaos) {
            vec2 step = chaos * vec2(75., 120.) + vec2(75., 120.);

            vec2 i = floor(x);
            vec2 f = fract(x);

            float n = dot(i, step);

            vec2 u = f * f * (3.0 - 2.0 * f);
            return mix(
                    mix(cloudRandom(n + dot(step, vec2(0, 0))), cloudRandom(n + dot(step, vec2(1, 0))), u.x),
                    mix(cloudRandom(n + dot(step, vec2(0, 1))), cloudRandom(n + dot(step, vec2(1, 1))), u.x),
                    u.y
                );
        }

        float cloudNoise(in vec3 x, in vec3 chaos) {
            vec3 step = chaos * vec3(60., 120., 75.) + vec3(60., 120., 75.);

            vec3 i = floor(x);
            vec3 f = fract(x);

            float n = dot(i, step);

            vec3 u = f * f * (3.0 - 2.0 * f);
            return mix(mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 0))), cloudRandom(n + dot(step, vec3(1, 0, 0))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 0))), cloudRandom(n + dot(step, vec3(1, 1, 0))), u.x), u.y),
                       mix(mix( cloudRandom(n + dot(step, vec3(0, 0, 1))), cloudRandom(n + dot(step, vec3(1, 0, 1))), u.x),
                           mix( cloudRandom(n + dot(step, vec3(0, 1, 1))), cloudRandom(n + dot(step, vec3(1, 1, 1))), u.x), u.y), u.z);
        }`,r=`
        float fbm(in vec2 st, in vec2 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = .5;
            float frequency = 0.;

            // Loop of octaves
            for (int i = 0; i < OCTAVES; i++) {
                value += amplitude * cloudNoise(st, chaos);
                st *= 2.0;
                amplitude *= 0.5;
            }
            return value;
        }

        float fbm(in vec3 x, in vec3 chaos) {
            // Initial values
            float value = 0.0;
            float amplitude = 0.5;
            for (int i = 0; i < OCTAVES; ++i) {
                value += amplitude * cloudNoise(x, chaos);
                x = x * 2.0;
                amplitude *= 0.5;
            }
            return value;
        }`,n=`fbm${this.octaves}`;e._emitFunction("CloudBlockCode",s,"// CloudBlockCode"),e._emitFunction("CloudBlockCodeFBM"+this.octaves,r.replace(/fbm/gi,n).replace(/OCTAVES/gi,(this.octaves|0).toString()),"// CloudBlockCode FBM");const o=e._getFreeVariableName("st"),l=((t=this.seed.connectedPoint)===null||t===void 0?void 0:t.type)===I.Vector2?"vec2":"vec3";e.compilationString+=`${l} ${o} = ${this.seed.associatedVariableName};\r
`,this.offsetX.isConnected&&(e.compilationString+=`${o}.x += 0.1 * ${this.offsetX.associatedVariableName};\r
`),this.offsetY.isConnected&&(e.compilationString+=`${o}.y += 0.1 * ${this.offsetY.associatedVariableName};\r
`),this.offsetZ.isConnected&&l==="vec3"&&(e.compilationString+=`${o}.z += 0.1 * ${this.offsetZ.associatedVariableName};\r
`);let h="";return this.chaos.isConnected?h=this.chaos.associatedVariableName:h=((i=this.seed.connectedPoint)===null||i===void 0?void 0:i.type)===I.Vector2?"vec2(0., 0.)":"vec3(0., 0., 0.)",e.compilationString+=this._declareOutput(this._outputs[0],e)+` = ${n}(${o}, ${h});\r
`,this}_dumpPropertiesCode(){return super._dumpPropertiesCode()+`${this._codeVariableName}.octaves = ${this.octaves};\r
`}serialize(){const e=super.serialize();return e.octaves=this.octaves,e}_deserialize(e,t,i){super._deserialize(e,t,i),this.octaves=e.octaves}}T([ft("Octaves",at.Int)],Im.prototype,"octaves",void 0);he("BABYLON.CloudBlock",Im);class AI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("seed",I.Vector2),this.registerInput("offset",I.Float),this.registerInput("density",I.Float),this.registerOutput("output",I.Float),this.registerOutput("cells",I.Float)}getClassName(){return"VoronoiNoiseBlock"}get seed(){return this._inputs[0]}get offset(){return this._inputs[1]}get density(){return this._inputs[2]}get output(){return this._outputs[0]}get cells(){return this._outputs[1]}_buildBlock(e){if(super._buildBlock(e),!this.seed.isConnected)return;let t=`vec2 voronoiRandom(vec2 seed, float offset){
            mat2 m = mat2(15.27, 47.63, 99.41, 89.98);
            vec2 uv = fract(sin(m * seed) * 46839.32);
            return vec2(sin(uv.y * offset) * 0.5 + 0.5, cos(uv.x * offset) * 0.5 + 0.5);
        }
        `;e._emitFunction("voronoiRandom",t,"// Voronoi random generator"),t=`void voronoi(vec2 seed, float offset, float density, out float outValue, out float cells){
            vec2 g = floor(seed * density);
            vec2 f = fract(seed * density);
            float t = 8.0;
            vec3 res = vec3(8.0, 0.0, 0.0);

            for(int y=-1; y<=1; y++)
            {
                for(int x=-1; x<=1; x++)
                {
                    vec2 lattice = vec2(x,y);
                    vec2 randomOffset = voronoiRandom(lattice + g, offset);
                    float d = distance(lattice + randomOffset, f);
                    if(d < res.x)
                    {
                        res = vec3(d, randomOffset.x, randomOffset.y);
                        outValue = res.x;
                        cells = res.y;
                    }
                }
            }
        }
        `,e._emitFunction("voronoi",t,"// Voronoi");const i=e._getFreeVariableName("tempOutput"),s=e._getFreeVariableName("tempCells");return e.compilationString+=`float ${i} = 0.0;\r
`,e.compilationString+=`float ${s} = 0.0;\r
`,e.compilationString+=`voronoi(${this.seed.associatedVariableName}, ${this.offset.associatedVariableName}, ${this.density.associatedVariableName}, ${i}, ${s});\r
`,this.output.hasEndpoints&&(e.compilationString+=this._declareOutput(this.output,e)+` = ${i};\r
`),this.cells.hasEndpoints&&(e.compilationString+=this._declareOutput(this.cells,e)+` = ${s};\r
`),this}}he("BABYLON.VoronoiNoiseBlock",AI);class RI extends Ie{constructor(e){super(e,U.Neutral),this.registerInput("input",I.AutoDetect),this.registerOutput("output",I.BasedOnInput),this._outputs[0]._typeConnectionSource=this._inputs[0]}getClassName(){return"ElbowBlock"}get input(){return this._inputs[0]}get output(){return this._outputs[0]}get target(){const e=this._inputs[0];if(e.isConnected){const t=e.connectedPoint.ownerBlock;if(t.target!==U.VertexAndFragment)return t.target;if(e.connectedPoint.target!==U.VertexAndFragment)return e.connectedPoint.target}return this._target}set target(e){(this._target&e)===0&&(this._target=e)}_buildBlock(e){super._buildBlock(e);const t=this._outputs[0],i=this._inputs[0];return e.compilationString+=this._declareOutput(t,e)+` = ${i.associatedVariableName};\r
`,this}}he("BABYLON.ElbowBlock",RI);V._GoldbergMeshParser=(a,e)=>ru.Parse(a,e);class ru extends V{constructor(){super(...arguments),this.goldbergData={faceColors:[],faceCenters:[],faceZaxis:[],faceXaxis:[],faceYaxis:[],nbSharedFaces:0,nbUnsharedFaces:0,nbFaces:0,nbFacesAtPole:0,adjacentFaces:[]}}relatedGoldbergFace(e,t){return t===void 0?(e>this.goldbergData.nbUnsharedFaces-1&&(B.Warn("Maximum number of unshared faces used"),e=this.goldbergData.nbUnsharedFaces-1),this.goldbergData.nbUnsharedFaces+e):(e>11&&(B.Warn("Last pole used"),e=11),t>this.goldbergData.nbFacesAtPole-1&&(B.Warn("Maximum number of faces at a pole used"),t=this.goldbergData.nbFacesAtPole-1),12+e*this.goldbergData.nbFacesAtPole+t)}_changeGoldbergFaceColors(e){for(let i=0;i<e.length;i++){const s=e[i][0],r=e[i][1],n=e[i][2];for(let o=s;o<r+1;o++)this.goldbergData.faceColors[o]=n}const t=[];for(let i=0;i<12;i++)for(let s=0;s<5;s++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);for(let i=12;i<this.goldbergData.faceColors.length;i++)for(let s=0;s<6;s++)t.push(this.goldbergData.faceColors[i].r,this.goldbergData.faceColors[i].g,this.goldbergData.faceColors[i].b,this.goldbergData.faceColors[i].a);return t}setGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.setVerticesData(y.ColorKind,t)}updateGoldbergFaceColors(e){const t=this._changeGoldbergFaceColors(e);this.updateVerticesData(y.ColorKind,t)}_changeGoldbergFaceUVs(e){const t=this.getVerticesData(y.UVKind);for(let i=0;i<e.length;i++){const s=e[i][0],r=e[i][1],n=e[i][2],o=e[i][3],l=e[i][4],h=[],c=[];let u,d;for(let f=0;f<5;f++)u=n.x+o*Math.cos(l+f*Math.PI/2.5),d=n.y+o*Math.sin(l+f*Math.PI/2.5),u<0&&(u=0),u>1&&(u=1),h.push(u,d);for(let f=0;f<6;f++)u=n.x+o*Math.cos(l+f*Math.PI/3),d=n.y+o*Math.sin(l+f*Math.PI/3),u<0&&(u=0),u>1&&(u=1),c.push(u,d);for(let f=s;f<Math.min(12,r+1);f++)for(let p=0;p<5;p++)t[10*f+2*p]=h[2*p],t[10*f+2*p+1]=h[2*p+1];for(let f=Math.max(12,s);f<r+1;f++)for(let p=0;p<6;p++)t[12*f-24+2*p]=c[2*p],t[12*f-23+2*p]=c[2*p+1]}return t}setGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.setVerticesData(y.UVKind,t)}updateGoldbergFaceUVs(e){const t=this._changeGoldbergFaceUVs(e);this.updateVerticesData(y.UVKind,t)}placeOnGoldbergFaceAt(e,t,i){const s=g.RotationFromAxis(this.goldbergData.faceXaxis[t],this.goldbergData.faceYaxis[t],this.goldbergData.faceZaxis[t]);e.rotation=s,e.position=this.goldbergData.faceCenters[t].add(this.goldbergData.faceXaxis[t].scale(i.x)).add(this.goldbergData.faceYaxis[t].scale(i.y)).add(this.goldbergData.faceZaxis[t].scale(i.z))}serialize(e){super.serialize(e),e.type="GoldbergMesh";const t={};if(t.adjacentFaces=this.goldbergData.adjacentFaces,t.nbSharedFaces=this.goldbergData.nbSharedFaces,t.nbUnsharedFaces=this.goldbergData.nbUnsharedFaces,t.nbFaces=this.goldbergData.nbFaces,t.nbFacesAtPole=this.goldbergData.nbFacesAtPole,this.goldbergData.faceColors){t.faceColors=[];for(const i of this.goldbergData.faceColors)t.faceColors.push(i.asArray())}if(this.goldbergData.faceCenters){t.faceCenters=[];for(const i of this.goldbergData.faceCenters)t.faceCenters.push(i.asArray())}if(this.goldbergData.faceZaxis){t.faceZaxis=[];for(const i of this.goldbergData.faceZaxis)t.faceZaxis.push(i.asArray())}if(this.goldbergData.faceYaxis){t.faceYaxis=[];for(const i of this.goldbergData.faceYaxis)t.faceYaxis.push(i.asArray())}if(this.goldbergData.faceXaxis){t.faceXaxis=[];for(const i of this.goldbergData.faceXaxis)t.faceXaxis.push(i.asArray())}e.goldbergData=t}static Parse(e,t){const i=e.goldbergData;i.faceColors=i.faceColors.map(r=>J.FromArray(r)),i.faceCenters=i.faceCenters.map(r=>g.FromArray(r)),i.faceZaxis=i.faceZaxis.map(r=>g.FromArray(r)),i.faceXaxis=i.faceXaxis.map(r=>g.FromArray(r)),i.faceYaxis=i.faceYaxis.map(r=>g.FromArray(r));const s=new ru(e.name,t);return s.goldbergData=i,s}}function ul(a){const e=a.pattern||V.NO_FLIP,t=a.tileWidth||a.tileSize||1,i=a.tileHeight||a.tileSize||1,s=a.alignHorizontal||0,r=a.alignVertical||0,n=a.width||a.size||1,o=Math.floor(n/t);let l=n-o*t;const h=a.height||a.size||1,c=Math.floor(h/i);let u=h-c*i;const d=t*o/2,f=i*c/2;let p=0,_=0,m=0,v=0,x=0,b=0;if(l>0||u>0){switch(m=-d,v=-f,x=d,b=f,s){case V.CENTER:l/=2,m-=l,x+=l;break;case V.LEFT:x+=l,p=-l/2;break;case V.RIGHT:m-=l,p=l/2;break}switch(r){case V.CENTER:u/=2,v-=u,b+=u;break;case V.BOTTOM:b+=u,_=-u/2;break;case V.TOP:v-=u,_=u/2;break}}const S=[],C=[],E=[];E[0]=[0,0,1,0,1,1,0,1],E[1]=[0,0,1,0,1,1,0,1],(e===V.ROTATE_TILE||e===V.ROTATE_ROW)&&(E[1]=[1,1,0,1,0,0,1,0]),(e===V.FLIP_TILE||e===V.FLIP_ROW)&&(E[1]=[1,0,0,0,0,1,1,1]),(e===V.FLIP_N_ROTATE_TILE||e===V.FLIP_N_ROTATE_ROW)&&(E[1]=[0,1,1,1,1,0,0,0]);let A=[];const M=[],D=[];let P=0;for(let W=0;W<c;W++)for(let K=0;K<o;K++)S.push(-d+K*t+p,-f+W*i+_,0),S.push(-d+(K+1)*t+p,-f+W*i+_,0),S.push(-d+(K+1)*t+p,-f+(W+1)*i+_,0),S.push(-d+K*t+p,-f+(W+1)*i+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),e===V.FLIP_TILE||e===V.ROTATE_TILE||e===V.FLIP_N_ROTATE_TILE?A=A.concat(E[(K%2+W%2)%2]):e===V.FLIP_ROW||e===V.ROTATE_ROW||e===V.FLIP_N_ROTATE_ROW?A=A.concat(E[W%2]):A=A.concat(E[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1),P+=4;if(l>0||u>0){const W=u>0&&(r===V.CENTER||r===V.TOP),K=u>0&&(r===V.CENTER||r===V.BOTTOM),te=l>0&&(s===V.CENTER||s===V.RIGHT),ve=l>0&&(s===V.CENTER||s===V.LEFT);let _e=[],j,ee,F,z;if(W&&te&&(S.push(m+p,v+_,0),S.push(-d+p,v+_,0),S.push(-d+p,v+u+_,0),S.push(m+p,v+u+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,j=1-l/t,ee=1-u/i,F=1,z=1,_e=[j,ee,F,ee,F,z,j,z],e===V.ROTATE_ROW&&(_e=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),e===V.FLIP_ROW&&(_e=[1-j,ee,1-F,ee,1-F,z,1-j,z]),e===V.FLIP_N_ROTATE_ROW&&(_e=[j,1-ee,F,1-ee,F,1-z,j,1-z]),A=A.concat(_e),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),W&&ve&&(S.push(d+p,v+_,0),S.push(x+p,v+_,0),S.push(x+p,v+u+_,0),S.push(d+p,v+u+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,j=0,ee=1-u/i,F=l/t,z=1,_e=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_ROW||e===V.ROTATE_TILE&&o%2===0)&&(_e=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_ROW||e===V.FLIP_TILE&&o%2===0)&&(_e=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_ROW||e===V.FLIP_N_ROTATE_TILE&&o%2===0)&&(_e=[j,1-ee,F,1-ee,F,1-z,j,1-z]),A=A.concat(_e),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),K&&te&&(S.push(m+p,f+_,0),S.push(-d+p,f+_,0),S.push(-d+p,b+_,0),S.push(m+p,b+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,j=1-l/t,ee=0,F=1,z=u/i,_e=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_ROW&&c%2===1||e===V.ROTATE_TILE&&c%1===0)&&(_e=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_ROW&&c%2===1||e===V.FLIP_TILE&&c%2===0)&&(_e=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_ROW&&c%2===1||e===V.FLIP_N_ROTATE_TILE&&c%2===0)&&(_e=[j,1-ee,F,1-ee,F,1-z,j,1-z]),A=A.concat(_e),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),K&&ve&&(S.push(d+p,f+_,0),S.push(x+p,f+_,0),S.push(x+p,b+_,0),S.push(d+p,b+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,j=0,ee=0,F=l/t,z=u/i,_e=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_ROW&&c%2===1||e===V.ROTATE_TILE&&(c+o)%2===1)&&(_e=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_ROW&&c%2===1||e===V.FLIP_TILE&&(c+o)%2===1)&&(_e=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_ROW&&c%2===1||e===V.FLIP_N_ROTATE_TILE&&(c+o)%2===1)&&(_e=[j,1-ee,F,1-ee,F,1-z,j,1-z]),A=A.concat(_e),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)),W){const Z=[];j=0,ee=1-u/i,F=1,z=1,Z[0]=[j,ee,F,ee,F,z,j,z],Z[1]=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_TILE||e===V.ROTATE_ROW)&&(Z[1]=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_TILE||e===V.FLIP_ROW)&&(Z[1]=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_TILE||e===V.FLIP_N_ROTATE_ROW)&&(Z[1]=[j,1-ee,F,1-ee,F,1-z,j,1-z]);for(let Ee=0;Ee<o;Ee++)S.push(-d+Ee*t+p,v+_,0),S.push(-d+(Ee+1)*t+p,v+_,0),S.push(-d+(Ee+1)*t+p,v+u+_,0),S.push(-d+Ee*t+p,v+u+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,e===V.FLIP_TILE||e===V.ROTATE_TILE||e===V.FLIP_N_ROTATE_TILE?A=A.concat(Z[(Ee+1)%2]):e===V.FLIP_ROW||e===V.ROTATE_ROW||e===V.FLIP_N_ROTATE_ROW?A=A.concat(Z[1]):A=A.concat(Z[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(K){const Z=[];j=0,ee=0,F=1,z=u/i,Z[0]=[j,ee,F,ee,F,z,j,z],Z[1]=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_TILE||e===V.ROTATE_ROW)&&(Z[1]=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_TILE||e===V.FLIP_ROW)&&(Z[1]=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_TILE||e===V.FLIP_N_ROTATE_ROW)&&(Z[1]=[j,1-ee,F,1-ee,F,1-z,j,1-z]);for(let Ee=0;Ee<o;Ee++)S.push(-d+Ee*t+p,b-u+_,0),S.push(-d+(Ee+1)*t+p,b-u+_,0),S.push(-d+(Ee+1)*t+p,b+_,0),S.push(-d+Ee*t+p,b+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,e===V.FLIP_TILE||e===V.ROTATE_TILE||e===V.FLIP_N_ROTATE_TILE?A=A.concat(Z[(Ee+c)%2]):e===V.FLIP_ROW||e===V.ROTATE_ROW||e===V.FLIP_N_ROTATE_ROW?A=A.concat(Z[c%2]):A=A.concat(Z[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(te){const Z=[];j=1-l/t,ee=0,F=1,z=1,Z[0]=[j,ee,F,ee,F,z,j,z],Z[1]=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_TILE||e===V.ROTATE_ROW)&&(Z[1]=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_TILE||e===V.FLIP_ROW)&&(Z[1]=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_TILE||e===V.FLIP_N_ROTATE_ROW)&&(Z[1]=[j,1-ee,F,1-ee,F,1-z,j,1-z]);for(let Ee=0;Ee<c;Ee++)S.push(m+p,-f+Ee*i+_,0),S.push(m+l+p,-f+Ee*i+_,0),S.push(m+l+p,-f+(Ee+1)*i+_,0),S.push(m+p,-f+(Ee+1)*i+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,e===V.FLIP_TILE||e===V.ROTATE_TILE||e===V.FLIP_N_ROTATE_TILE?A=A.concat(Z[(Ee+1)%2]):e===V.FLIP_ROW||e===V.ROTATE_ROW||e===V.FLIP_N_ROTATE_ROW?A=A.concat(Z[Ee%2]):A=A.concat(Z[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}if(ve){const Z=[];j=0,ee=0,F=l/i,z=1,Z[0]=[j,ee,F,ee,F,z,j,z],Z[1]=[j,ee,F,ee,F,z,j,z],(e===V.ROTATE_TILE||e===V.ROTATE_ROW)&&(Z[1]=[1-j,1-ee,1-F,1-ee,1-F,1-z,1-j,1-z]),(e===V.FLIP_TILE||e===V.FLIP_ROW)&&(Z[1]=[1-j,ee,1-F,ee,1-F,z,1-j,z]),(e===V.FLIP_N_ROTATE_TILE||e===V.FLIP_N_ROTATE_ROW)&&(Z[1]=[j,1-ee,F,1-ee,F,1-z,j,1-z]);for(let Ee=0;Ee<c;Ee++)S.push(x-l+p,-f+Ee*i+_,0),S.push(x+p,-f+Ee*i+_,0),S.push(x+p,-f+(Ee+1)*i+_,0),S.push(x-l+p,-f+(Ee+1)*i+_,0),D.push(P,P+1,P+3,P+1,P+2,P+3),P+=4,e===V.FLIP_TILE||e===V.ROTATE_TILE||e===V.FLIP_N_ROTATE_TILE?A=A.concat(Z[(Ee+o)%2]):e===V.FLIP_ROW||e===V.ROTATE_ROW||e===V.FLIP_N_ROTATE_ROW?A=A.concat(Z[Ee%2]):A=A.concat(Z[0]),M.push(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1),C.push(0,0,-1,0,0,-1,0,0,-1,0,0,-1)}}const O=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE;de._ComputeSides(O,S,D,C,A,a.frontUVs,a.backUVs);const N=new de;N.indices=D,N.positions=S,N.normals=C,N.uvs=A;const $=O===de.DOUBLESIDE?M.concat(M):M;return N.colors=$,N}function II(a,e,t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,ul(e).applyToMesh(i,e.updatable),i}de.CreateTiledPlane=ul;function Pm(a){const t=a.faceUV||new Array(6),i=a.faceColors,s=a.pattern||V.NO_FLIP,r=a.width||a.size||1,n=a.height||a.size||1,o=a.depth||a.size||1,l=a.tileWidth||a.tileSize||1,h=a.tileHeight||a.tileSize||1,c=a.alignHorizontal||0,u=a.alignVertical||0,d=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE;for(let F=0;F<6;F++)t[F]===void 0&&(t[F]=new Ge(0,0,1,1)),i&&i[F]===void 0&&(i[F]=new J(1,1,1,1));const f=r/2,p=n/2,_=o/2,m=[];for(let F=0;F<2;F++)m[F]=ul({pattern:s,tileWidth:l,tileHeight:h,width:r,height:n,alignVertical:u,alignHorizontal:c,sideOrientation:d});for(let F=2;F<4;F++)m[F]=ul({pattern:s,tileWidth:l,tileHeight:h,width:o,height:n,alignVertical:u,alignHorizontal:c,sideOrientation:d});let v=u;u===V.BOTTOM?v=V.TOP:u===V.TOP&&(v=V.BOTTOM);for(let F=4;F<6;F++)m[F]=ul({pattern:s,tileWidth:l,tileHeight:h,width:r,height:o,alignVertical:v,alignHorizontal:c,sideOrientation:d});let x=[],b=[],S=[],C=[];const E=[],A=[],M=[],D=[];let P=0,O=0;for(let F=0;F<6;F++){const z=m[F].positions.length;A[F]=[],M[F]=[];for(let Z=0;Z<z/3;Z++)A[F].push(new g(m[F].positions[3*Z],m[F].positions[3*Z+1],m[F].positions[3*Z+2])),M[F].push(new g(m[F].normals[3*Z],m[F].normals[3*Z+1],m[F].normals[3*Z+2]));P=m[F].uvs.length,D[F]=[];for(let Z=0;Z<P;Z+=2)D[F][Z]=t[F].x+(t[F].z-t[F].x)*m[F].uvs[Z],D[F][Z+1]=t[F].y+(t[F].w-t[F].y)*m[F].uvs[Z+1],nt.UseOpenGLOrientationForUV&&(D[F][Z+1]=1-D[F][Z+1]);if(S=S.concat(D[F]),C=C.concat(m[F].indices.map(Z=>Z+O)),O+=A[F].length,i)for(let Z=0;Z<4;Z++)E.push(i[F].r,i[F].g,i[F].b,i[F].a)}const N=new g(0,0,_),$=L.RotationY(Math.PI);x=A[0].map(F=>g.TransformNormal(F,$).add(N)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[]),b=M[0].map(F=>g.TransformNormal(F,$)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[]),x=x.concat(A[1].map(F=>F.subtract(N)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[])),b=b.concat(M[1].map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[]));const W=new g(f,0,0),K=L.RotationY(-Math.PI/2);x=x.concat(A[2].map(F=>g.TransformNormal(F,K).add(W)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[])),b=b.concat(M[2].map(F=>g.TransformNormal(F,K)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[]));const te=L.RotationY(Math.PI/2);x=x.concat(A[3].map(F=>g.TransformNormal(F,te).subtract(W)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[])),b=b.concat(M[3].map(F=>g.TransformNormal(F,te)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[]));const ve=new g(0,p,0),_e=L.RotationX(Math.PI/2);x=x.concat(A[4].map(F=>g.TransformNormal(F,_e).add(ve)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[])),b=b.concat(M[4].map(F=>g.TransformNormal(F,_e)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[]));const j=L.RotationX(-Math.PI/2);x=x.concat(A[5].map(F=>g.TransformNormal(F,j).subtract(ve)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[])),b=b.concat(M[5].map(F=>g.TransformNormal(F,j)).map(F=>[F.x,F.y,F.z]).reduce((F,z)=>F.concat(z),[])),de._ComputeSides(d,x,C,b,S);const ee=new de;if(ee.indices=C,ee.positions=x,ee.normals=b,ee.uvs=S,i){const F=d===de.DOUBLESIDE?E.concat(E):E;ee.colors=F}return ee}function PI(a,e,t=null){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Pm(e).applyToMesh(i,e.updatable),i}de.CreateTiledBox=Pm;function Mm(a){const e=new Array,t=new Array,i=new Array,s=new Array,r=a.radius||2,n=a.tube||.5,o=a.radialSegments||32,l=a.tubularSegments||32,h=a.p||2,c=a.q||3,u=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,d=m=>{const v=Math.cos(m),x=Math.sin(m),b=c/h*m,S=Math.cos(b),C=r*(2+S)*.5*v,E=r*(2+S)*x*.5,A=r*Math.sin(b)*.5;return new g(C,E,A)};let f,p;for(f=0;f<=o;f++){const v=f%o/o*2*h*Math.PI,x=d(v),b=d(v+.01),S=b.subtract(x);let C=b.add(x);const E=g.Cross(S,C);for(C=g.Cross(E,S),E.normalize(),C.normalize(),p=0;p<l;p++){const M=p%l/l*2*Math.PI,D=-n*Math.cos(M),P=n*Math.sin(M);t.push(x.x+D*C.x+P*E.x),t.push(x.y+D*C.y+P*E.y),t.push(x.z+D*C.z+P*E.z),s.push(f/o),s.push(nt.UseOpenGLOrientationForUV?1-p/l:p/l)}}for(f=0;f<o;f++)for(p=0;p<l;p++){const m=(p+1)%l,v=f*l+p,x=(f+1)*l+p,b=(f+1)*l+m,S=f*l+m;e.push(S),e.push(x),e.push(v),e.push(S),e.push(b),e.push(x)}de.ComputeNormals(t,e,i),de._ComputeSides(u,t,e,i,s,a.frontUVs,a.backUVs);const _=new de;return _.indices=e,_.positions=t,_.normals=i,_.uvs=s,_}function Dm(a,e={},t){const i=new V(a,t);return e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),i._originalBuilderSideOrientation=e.sideOrientation,Mm(e).applyToMesh(i,e.updatable),i}de.CreateTorusKnot=Mm;V.CreateTorusKnot=(a,e,t,i,s,r,n,o,l,h)=>Dm(a,{radius:e,tube:t,radialSegments:i,tubularSegments:s,p:r,q:n,sideOrientation:h,updatable:l},o);class MI extends le{constructor(e,t){super(e.x,e.y),this.index=t}}class Bu{constructor(){this.elements=new Array}add(e){const t=new Array;return e.forEach(i=>{const s=new MI(i,this.elements.length);t.push(s),this.elements.push(s)}),t}computeBounds(){const e=new le(this.elements[0].x,this.elements[0].y),t=new le(this.elements[0].x,this.elements[0].y);return this.elements.forEach(i=>{i.x<e.x?e.x=i.x:i.x>t.x&&(t.x=i.x),i.y<e.y?e.y=i.y:i.y>t.y&&(t.y=i.y)}),{min:e,max:t,width:t.x-e.x,height:t.y-e.y}}}class DI{constructor(e,t,i,s=earcut){this._points=new Bu,this._outlinepoints=new Bu,this._holes=new Array,this._epoints=new Array,this._eholes=new Array,this.bjsEarcut=s,this._name=e,this._scene=i||ye.LastCreatedScene;let r;t instanceof Cd?r=t.getPoints():r=t,this._addToepoint(r),this._points.add(r),this._outlinepoints.add(r),typeof this.bjsEarcut>"u"&&B.Warn("Earcut was not found, the polygon will not be built.")}_addToepoint(e){for(const t of e)this._epoints.push(t.x,t.y)}addHole(e){this._points.add(e);const t=new Bu;return t.add(e),this._holes.push(t),this._eholes.push(this._epoints.length/2),this._addToepoint(e),this}build(e=!1,t=0,i=2){const s=new V(this._name,this._scene),r=this.buildVertexData(t,i);return s.setVerticesData(y.PositionKind,r.positions,e),s.setVerticesData(y.NormalKind,r.normals,e),s.setVerticesData(y.UVKind,r.uvs,e),s.setIndices(r.indices),s}buildVertexData(e=0,t=2){const i=new de,s=new Array,r=new Array,n=new Array,o=this._points.computeBounds();this._points.elements.forEach(c=>{s.push(0,1,0),r.push(c.x,0,c.y),n.push((c.x-o.min.x)/o.width,(c.y-o.min.y)/o.height)});const l=new Array,h=this.bjsEarcut(this._epoints,this._eholes,2);for(let c=0;c<h.length;c++)l.push(h[c]);if(e>0){const c=r.length/3;this._points.elements.forEach(d=>{s.push(0,-1,0),r.push(d.x,-e,d.y),n.push(1-(d.x-o.min.x)/o.width,1-(d.y-o.min.y)/o.height)});const u=l.length;for(let d=0;d<u;d+=3){const f=l[d+0],p=l[d+1],_=l[d+2];l.push(_+c),l.push(p+c),l.push(f+c)}this._addSide(r,s,n,l,o,this._outlinepoints,e,!1,t),this._holes.forEach(d=>{this._addSide(r,s,n,l,o,d,e,!0,t)})}return i.indices=l,i.positions=r,i.normals=s,i.uvs=n,i}_addSide(e,t,i,s,r,n,o,l,h){let c=e.length/3,u=0;for(let d=0;d<n.elements.length;d++){const f=n.elements[d],p=n.elements[(d+1)%n.elements.length];e.push(f.x,0,f.y),e.push(f.x,-o,f.y),e.push(p.x,0,p.y),e.push(p.x,-o,p.y);const _=n.elements[(d+n.elements.length-1)%n.elements.length],m=n.elements[(d+2)%n.elements.length];let v=new g(-(p.y-f.y),0,p.x-f.x),x=new g(-(f.y-_.y),0,f.x-_.x),b=new g(-(m.y-p.y),0,m.x-p.x);l||(v=v.scale(-1),x=x.scale(-1),b=b.scale(-1));const S=v.normalizeToNew();let C=x.normalizeToNew(),E=b.normalizeToNew();const A=g.Dot(C,S);A>h?A<tt-1?C=new g(f.x,0,f.y).subtract(new g(p.x,0,p.y)).normalize():C=x.add(v).normalize():C=S;const M=g.Dot(b,v);M>h?M<tt-1?E=new g(p.x,0,p.y).subtract(new g(f.x,0,f.y)).normalize():E=b.add(v).normalize():E=S,i.push(u/r.width,0),i.push(u/r.width,1),u+=v.length(),i.push(u/r.width,0),i.push(u/r.width,1),t.push(C.x,C.y,C.z),t.push(C.x,C.y,C.z),t.push(E.x,E.y,E.z),t.push(E.x,E.y,E.z),l?(s.push(c),s.push(c+2),s.push(c+1),s.push(c+1),s.push(c+2),s.push(c+3)):(s.push(c),s.push(c+1),s.push(c+2),s.push(c+1),s.push(c+3),s.push(c+2)),c+=4}}}function Om(a,e,t,i,s,r,n){const o=t||new Array(3),l=i,h=[],c=n||!1;for(let D=0;D<3;D++)o[D]===void 0&&(o[D]=new Ge(0,0,1,1)),l&&l[D]===void 0&&(l[D]=new J(1,1,1,1));const u=a.getVerticesData(y.PositionKind),d=a.getVerticesData(y.NormalKind),f=a.getVerticesData(y.UVKind),p=a.getIndices(),_=u.length/9;let m=0,v=0,x=0,b=0,S=0;const C=[0];if(c)for(let D=_;D<u.length/3;D+=4)v=u[3*(D+2)]-u[3*D],x=u[3*(D+2)+2]-u[3*D+2],b=Math.sqrt(v*v+x*x),S+=b,C.push(S);let E=0,A=0;for(let D=0;D<d.length;D+=3)Math.abs(d[D+1])<.001&&(A=1),Math.abs(d[D+1]-1)<.001&&(A=0),Math.abs(d[D+1]+1)<.001&&(A=2),E=D/3,A===1?(m=E-_,m%4<1.5?c?f[2*E]=o[A].x+(o[A].z-o[A].x)*C[Math.floor(m/4)]/S:f[2*E]=o[A].x:c?f[2*E]=o[A].x+(o[A].z-o[A].x)*C[Math.floor(m/4)+1]/S:f[2*E]=o[A].z,m%2===0?f[2*E+1]=nt.UseOpenGLOrientationForUV?1-o[A].w:o[A].w:f[2*E+1]=nt.UseOpenGLOrientationForUV?1-o[A].y:o[A].y):(f[2*E]=(1-f[2*E])*o[A].x+f[2*E]*o[A].z,f[2*E+1]=(1-f[2*E+1])*o[A].y+f[2*E+1]*o[A].w,nt.UseOpenGLOrientationForUV&&(f[2*E+1]=1-f[2*E+1])),l&&h.push(l[A].r,l[A].g,l[A].b,l[A].a);de._ComputeSides(e,u,p,d,f,s,r);const M=new de;if(M.indices=p,M.positions=u,M.normals=d,M.uvs=f,l){const D=e===de.DOUBLESIDE?h.concat(h):h;M.colors=D}return M}function g0(a,e,t=null,i=earcut){e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation);const s=e.shape,r=e.holes||[],n=e.depth||0,o=e.smoothingThreshold||2,l=[];let h=[];for(let p=0;p<s.length;p++)l[p]=new le(s[p].x,s[p].z);const c=1e-8;l[0].equalsWithEpsilon(l[l.length-1],c)&&l.pop();const u=new DI(a,l,t||ye.LastCreatedScene,i);for(let p=0;p<r.length;p++){h=[];for(let _=0;_<r[p].length;_++)h.push(new le(r[p][_].x,r[p][_].z));u.addHole(h)}const d=u.build(!1,n,o);return d._originalBuilderSideOrientation=e.sideOrientation,Om(d,e.sideOrientation,e.faceUV,e.faceColors,e.frontUVs,e.backUVs,e.wrap).applyToMesh(d,e.updatable),d}function wm(a,e,t=null,i=earcut){return g0(a,e,t,i)}de.CreatePolygon=Om;V.CreatePolygon=(a,e,t,i,s,r,n=earcut)=>g0(a,{shape:e,holes:i,updatable:s,sideOrientation:r},t,n);V.ExtrudePolygon=(a,e,t,i,s,r,n,o=earcut)=>wm(a,{shape:e,holes:s,depth:t,updatable:r,sideOrientation:n},i,o);function Nm(a,e,t=null){const i=e.arc?e.arc<=0||e.arc>1?1:e.arc:1,s=e.closed===void 0?!0:e.closed,r=e.shape,n=e.radius||1,o=e.tessellation||64,l=e.clip||0,h=e.updatable,c=V._GetDefaultSideOrientation(e.sideOrientation),u=e.cap||V.NO_CAP,d=Math.PI*2,f=new Array,p=e.invertUV||!1;let _=0,m=0;const v=d/o*i;let x,b;for(_=0;_<=o-l;_++){for(b=[],(u==V.CAP_START||u==V.CAP_ALL)&&(b.push(new g(0,r[0].y,0)),b.push(new g(Math.cos(_*v)*r[0].x*n,r[0].y,Math.sin(_*v)*r[0].x*n))),m=0;m<r.length;m++)x=new g(Math.cos(_*v)*r[m].x*n,r[m].y,Math.sin(_*v)*r[m].x*n),b.push(x);(u==V.CAP_END||u==V.CAP_ALL)&&(b.push(new g(Math.cos(_*v)*r[r.length-1].x*n,r[r.length-1].y,Math.sin(_*v)*r[r.length-1].x*n)),b.push(new g(0,r[r.length-1].y,0))),f.push(b)}return Ba(a,{pathArray:f,closeArray:s,sideOrientation:c,updatable:h,invertUV:p,frontUVs:e.frontUVs,backUVs:e.backUVs},t)}V.CreateLathe=(a,e,t,i,s,r,n)=>Nm(a,{shape:e,radius:t,tessellation:i,sideOrientation:n,updatable:r},s);function Fm(a,e,t=null){const i=e.path;let s=e.instance,r=1;e.radius!==void 0?r=e.radius:s&&(r=s._creationDataStorage.radius);const n=e.tessellation||64,o=e.radiusFunction||null;let l=e.cap||V.NO_CAP;const h=e.invertUV||!1,c=e.updatable,u=V._GetDefaultSideOrientation(e.sideOrientation);e.arc=e.arc&&(e.arc<=0||e.arc>1)?1:e.arc||1;const d=(v,x,b,S,C,E,A,M)=>{const D=x.getTangents(),P=x.getNormals(),O=x.getDistances(),$=Math.PI*2/C*M,K=E||(()=>S);let te,ve,_e,j;const ee=G.Matrix[0];let F=A===V.NO_CAP||A===V.CAP_END?0:2;for(let Z=0;Z<v.length;Z++){ve=K(Z,O[Z]),te=Array(),_e=P[Z];for(let Ee=0;Ee<C;Ee++)L.RotationAxisToRef(D[Z],$*Ee,ee),j=te[Ee]?te[Ee]:g.Zero(),g.TransformCoordinatesToRef(_e,ee,j),j.scaleInPlace(ve).addInPlace(v[Z]),te[Ee]=j;b[F]=te,F++}const z=(Z,Ee)=>{const He=Array();for(let ut=0;ut<Z;ut++)He.push(v[Ee]);return He};switch(A){case V.NO_CAP:break;case V.CAP_START:b[0]=z(C,0),b[1]=b[2].slice(0);break;case V.CAP_END:b[F]=b[F-1].slice(0),b[F+1]=z(C,v.length-1);break;case V.CAP_ALL:b[0]=z(C,0),b[1]=b[2].slice(0),b[F]=b[F-1].slice(0),b[F+1]=z(C,v.length-1);break}return b};let f,p;if(s){const v=s._creationDataStorage,x=e.arc||v.arc;return f=v.path3D.update(i),p=d(i,f,v.pathArray,r,v.tessellation,o,v.cap,x),s=Ba("",{pathArray:p,instance:s}),v.path3D=f,v.pathArray=p,v.arc=x,v.radius=r,s}f=new Al(i);const _=new Array;l=l<0||l>3?0:l,p=d(i,f,_,r,n,o,l,e.arc);const m=Ba(a,{pathArray:p,closePath:!0,closeArray:!1,updatable:c,sideOrientation:u,invertUV:h,frontUVs:e.frontUVs,backUVs:e.backUVs},t);return m._creationDataStorage.pathArray=p,m._creationDataStorage.path3D=f,m._creationDataStorage.tessellation=n,m._creationDataStorage.cap=l,m._creationDataStorage.arc=e.arc,m._creationDataStorage.radius=r,m}V.CreateTube=(a,e,t,i,s,r,n,o,l,h)=>Fm(a,{path:e,radius:t,tessellation:i,radiusFunction:s,arc:1,cap:r,updatable:o,sideOrientation:l,instance:h},n);function Lm(a,e,t){const i=e.getIndices(),s=e.getVerticesData(y.PositionKind),r=e.getVerticesData(y.NormalKind),n=e.getVerticesData(y.UVKind),o=t.position||g.Zero();let l=t.normal||g.Up();const h=t.size||g.One(),c=t.angle||0;if(!l){const A=new g(0,0,1),M=e.getScene().activeCamera,D=g.TransformCoordinates(A,M.getWorldMatrix());l=M.globalPosition.subtract(D)}const u=-Math.atan2(l.z,l.x)-Math.PI/2,d=Math.sqrt(l.x*l.x+l.z*l.z),f=Math.atan2(l.y,d),p=L.RotationYawPitchRoll(u,f,c).multiply(L.Translation(o.x,o.y,o.z)),_=L.Invert(p),v=e.getWorldMatrix().multiply(_),x=new de;x.indices=[],x.positions=[],x.normals=[],x.uvs=[];let b=0;const S=A=>{const M=new Uh;if(!i||!s||!r)return M;const D=i[A];if(M.position=new g(s[D*3],s[D*3+1],s[D*3+2]),M.position=g.TransformCoordinates(M.position,v),M.normal=new g(r[D*3],r[D*3+1],r[D*3+2]),M.normal=g.TransformNormal(M.normal,v),t.captureUVS&&n){const P=n[D*2+1];M.uv=new le(n[D*2],nt.UseOpenGLOrientationForUV?1-P:P)}return M},C=(A,M)=>{if(A.length===0)return A;const D=.5*Math.abs(g.Dot(h,M)),P=(N,$)=>{const W=g.GetClipFactor(N.position,$.position,M,D);return new Uh(g.Lerp(N.position,$.position,W),g.Lerp(N.normal,$.normal,W))},O=new Array;for(let N=0;N<A.length;N+=3){let $=0,W=null,K=null,te=null,ve=null;const _e=g.Dot(A[N].position,M)-D,j=g.Dot(A[N+1].position,M)-D,ee=g.Dot(A[N+2].position,M)-D,F=_e>0,z=j>0,Z=ee>0;switch($=(F?1:0)+(z?1:0)+(Z?1:0),$){case 0:O.push(A[N]),O.push(A[N+1]),O.push(A[N+2]);break;case 1:if(F&&(W=A[N+1],K=A[N+2],te=P(A[N],W),ve=P(A[N],K)),z){W=A[N],K=A[N+2],te=P(A[N+1],W),ve=P(A[N+1],K),O.push(te),O.push(K.clone()),O.push(W.clone()),O.push(K.clone()),O.push(te.clone()),O.push(ve);break}Z&&(W=A[N],K=A[N+1],te=P(A[N+2],W),ve=P(A[N+2],K)),W&&K&&te&&ve&&(O.push(W.clone()),O.push(K.clone()),O.push(te),O.push(ve),O.push(te.clone()),O.push(K.clone()));break;case 2:F||(W=A[N].clone(),K=P(W,A[N+1]),te=P(W,A[N+2]),O.push(W),O.push(K),O.push(te)),z||(W=A[N+1].clone(),K=P(W,A[N+2]),te=P(W,A[N]),O.push(W),O.push(K),O.push(te)),Z||(W=A[N+2].clone(),K=P(W,A[N]),te=P(W,A[N+1]),O.push(W),O.push(K),O.push(te));break}}return O};for(let A=0;A<i.length;A+=3){let M=new Array;if(M.push(S(A)),M.push(S(A+1)),M.push(S(A+2)),M=C(M,new g(1,0,0)),M=C(M,new g(-1,0,0)),M=C(M,new g(0,1,0)),M=C(M,new g(0,-1,0)),M=C(M,new g(0,0,1)),M=C(M,new g(0,0,-1)),M.length!==0)for(let D=0;D<M.length;D++){const P=M[D];if(x.indices.push(b),P.position.toArray(x.positions,b*3),P.normal.toArray(x.normals,b*3),t.captureUVS)P.uv.toArray(x.uvs,b*2);else{x.uvs.push(.5+P.position.x/h.x);const O=.5+P.position.y/h.y;x.uvs.push(nt.UseOpenGLOrientationForUV?1-O:O)}b++}}const E=new V(a,e.getScene());return x.applyToMesh(E),E.position=o.clone(),E.rotation=new g(f,u,c),E}V.CreateDecal=(a,e,t,i,s,r)=>Lm(a,e,{position:t,normal:i,size:s,angle:r});class Yt{constructor(e=0,t=0){this.x=e,this.y=t,e!==Math.floor(e)&&B.Warn("x is not an integer, floor(x) used"),t!==Math.floor(t)&&B.Warn("y is not an integer, floor(y) used")}clone(){return new Yt(this.x,this.y)}rotate60About(e){const t=this.x;return this.x=e.x+e.y-this.y,this.y=t+this.y-e.x,this}rotateNeg60About(e){const t=this.x;return this.x=t+this.y-e.y,this.y=e.x+e.y-t,this}rotate120(e,t){e!==Math.floor(e)&&B.Warn("m not an integer only floor(m) used"),t!==Math.floor(t)&&B.Warn("n not an integer only floor(n) used");const i=this.x;return this.x=e-i-this.y,this.y=t+i,this}rotateNeg120(e,t){e!==Math.floor(e)&&B.Warn("m is not an integer, floor(m) used"),t!==Math.floor(t)&&B.Warn("n is not an integer,   floor(n) used");const i=this.x;return this.x=this.y-t,this.y=e+t-i-this.y,this}toCartesianOrigin(e,t){const i=g.Zero();return i.x=e.x+2*this.x*t+this.y*t,i.y=e.y+Math.sqrt(3)*this.y*t,i}static Zero(){return new Yt(0,0)}}class Bm{constructor(){this.cartesian=[],this.vertices=[],this.max=[],this.min=[],this.closestTo=[],this.innerFacets=[],this.isoVecsABOB=[],this.isoVecsOBOA=[],this.isoVecsBAOA=[],this.vertexTypes=[],this.IDATA=new hd("icosahedron","Regular",[[0,_i,-1],[-_i,1,0],[-1,0,-_i],[1,0,-_i],[_i,1,0],[0,_i,1],[-1,0,_i],[-_i,-1,0],[0,-_i,-1],[_i,-1,0],[1,0,_i],[0,-_i,1]],[[0,2,1],[0,3,2],[0,4,3],[0,5,4],[0,1,5],[7,6,1],[8,7,2],[9,8,3],[10,9,4],[6,10,5],[2,7,1],[3,8,2],[4,9,3],[5,10,4],[1,6,5],[11,6,7],[11,7,8],[11,8,9],[11,9,10],[11,10,6]])}setIndices(){let e=12;const t={},i=this.m,s=this.n;let r=i,n=1,o=0;s!==0&&(r=oe.HCF(i,s)),n=i/r,o=s/r;let l,h,c,u,d;const f=Yt.Zero(),p=new Yt(i,s),_=new Yt(-s,i+s),m=Yt.Zero(),v=Yt.Zero(),x=Yt.Zero();let b=[],S,C,E,A;const M=[],D=this.vertByDist,P=(O,N,$,W)=>{S=O+"|"+$,C=N+"|"+W,S in t||C in t?S in t&&!(C in t)?t[C]=t[S]:C in t&&!(S in t)&&(t[S]=t[C]):(t[S]=e,t[C]=e,e++),D[$][0]>2?M[t[S]]=[-D[$][0],D[$][1],t[S]]:M[t[S]]=[b[D[$][0]],D[$][1],t[S]]};this.IDATA.edgematch=[[1,"B"],[2,"B"],[3,"B"],[4,"B"],[0,"B"],[10,"O",14,"A"],[11,"O",10,"A"],[12,"O",11,"A"],[13,"O",12,"A"],[14,"O",13,"A"],[0,"O"],[1,"O"],[2,"O"],[3,"O"],[4,"O"],[19,"B",5,"A"],[15,"B",6,"A"],[16,"B",7,"A"],[17,"B",8,"A"],[18,"B",9,"A"]];for(let O=0;O<20;O++){if(b=this.IDATA.face[O],c=b[2],u=b[1],d=b[0],E=f.x+"|"+f.y,S=O+"|"+E,S in t||(t[S]=c,M[c]=[b[D[E][0]],D[E][1]]),E=p.x+"|"+p.y,S=O+"|"+E,S in t||(t[S]=u,M[u]=[b[D[E][0]],D[E][1]]),E=_.x+"|"+_.y,S=O+"|"+E,S in t||(t[S]=d,M[d]=[b[D[E][0]],D[E][1]]),l=this.IDATA.edgematch[O][0],h=this.IDATA.edgematch[O][1],h==="B")for(let N=1;N<r;N++)v.x=i-N*(n+o),v.y=s+N*n,x.x=-N*o,x.y=N*(n+o),E=v.x+"|"+v.y,A=x.x+"|"+x.y,P(O,l,E,A);if(h==="O")for(let N=1;N<r;N++)x.x=-N*o,x.y=N*(n+o),m.x=N*n,m.y=N*o,E=x.x+"|"+x.y,A=m.x+"|"+m.y,P(O,l,E,A);if(l=this.IDATA.edgematch[O][2],h=this.IDATA.edgematch[O][3],h&&h==="A")for(let N=1;N<r;N++)m.x=N*n,m.y=N*o,v.x=i-(r-N)*(n+o),v.y=s+(r-N)*n,E=m.x+"|"+m.y,A=v.x+"|"+v.y,P(O,l,E,A);for(let N=0;N<this.vertices.length;N++)E=this.vertices[N].x+"|"+this.vertices[N].y,S=O+"|"+E,S in t||(t[S]=e++,D[E][0]>2?M[t[S]]=[-D[E][0],D[E][1],t[S]]:M[t[S]]=[b[D[E][0]],D[E][1],t[S]])}this.closestTo=M,this.vecToidx=t}calcCoeffs(){const e=this.m,t=this.n,i=Math.sqrt(3)/3,s=e*e+t*t+e*t;this.coau=(e+t)/s,this.cobu=-t/s,this.coav=-i*(e-t)/s,this.cobv=i*(2*e+t)/s}createInnerFacets(){const e=this.m,t=this.n;for(let i=0;i<t+e+1;i++)for(let s=this.min[i];s<this.max[i]+1;s++)s<this.max[i]&&s<this.max[i+1]+1&&this.innerFacets.push(["|"+s+"|"+i,"|"+s+"|"+(i+1),"|"+(s+1)+"|"+i]),i>0&&s<this.max[i-1]&&s+1<this.max[i]+1&&this.innerFacets.push(["|"+s+"|"+i,"|"+(s+1)+"|"+i,"|"+(s+1)+"|"+(i-1)])}edgeVecsABOB(){const e=this.m,t=this.n,i=new Yt(-t,e+t);for(let s=1;s<e+t;s++){const r=new Yt(this.min[s],s),n=new Yt(this.min[s-1],s-1),o=new Yt(this.min[s+1],s+1),l=r.clone(),h=n.clone(),c=o.clone();l.rotate60About(i),h.rotate60About(i),c.rotate60About(i);const u=new Yt(this.max[l.y],l.y),d=new Yt(this.max[l.y-1],l.y-1),f=new Yt(this.max[l.y-1]-1,l.y-1);(l.x!==u.x||l.y!==u.y)&&(l.x!==d.x?(this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([r,d,f]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([r,f,u])):l.y===c.y?(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([r,n,d]),this.vertexTypes.push([1,0,1]),this.isoVecsABOB.push([r,d,o])):(this.vertexTypes.push([1,1,0]),this.isoVecsABOB.push([r,n,d]),this.vertexTypes.push([1,0,0]),this.isoVecsABOB.push([r,d,u])))}}mapABOBtoOBOA(){const e=new Yt(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let s=0;s<3;s++)e.x=this.isoVecsABOB[t][s].x,e.y=this.isoVecsABOB[t][s].y,this.vertexTypes[t][s]===0&&e.rotateNeg120(this.m,this.n),i.push(e.clone());this.isoVecsOBOA.push(i)}}mapABOBtoBAOA(){const e=new Yt(0,0);for(let t=0;t<this.isoVecsABOB.length;t++){const i=[];for(let s=0;s<3;s++)e.x=this.isoVecsABOB[t][s].x,e.y=this.isoVecsABOB[t][s].y,this.vertexTypes[t][s]===1&&e.rotate120(this.m,this.n),i.push(e.clone());this.isoVecsBAOA.push(i)}}MapToFace(e,t){const i=this.IDATA.face[e],s=i[2],r=i[1],n=i[0],o=g.FromArray(this.IDATA.vertex[s]),l=g.FromArray(this.IDATA.vertex[r]),h=g.FromArray(this.IDATA.vertex[n]),c=l.subtract(o),u=h.subtract(o),d=c.scale(this.coau).add(u.scale(this.cobu)),f=c.scale(this.coav).add(u.scale(this.cobv));let p,_=G.Vector3[0];for(let m=0;m<this.cartesian.length;m++)_=d.scale(this.cartesian[m].x).add(f.scale(this.cartesian[m].y)).add(o),_.x,_.y,_.z,p=e+"|"+this.vertices[m].x+"|"+this.vertices[m].y,t.vertex[this.vecToidx[p]]=[_.x,_.y,_.z]}build(e,t){const i=new Array,s=Yt.Zero(),r=new Yt(e,t),n=new Yt(-t,e+t);i.push(s,r,n);for(let C=t;C<e+1;C++)for(let E=0;E<e+1-C;E++)i.push(new Yt(E,C));if(t>0){const C=oe.HCF(e,t),E=e/C,A=t/C;for(let D=1;D<C;D++)i.push(new Yt(D*E,D*A)),i.push(new Yt(-D*A,D*(E+A))),i.push(new Yt(e-D*(E+A),t+D*E));const M=e/t;for(let D=1;D<t;D++)for(let P=0;P<D*M;P++)i.push(new Yt(P,D)),i.push(new Yt(P,D).rotate120(e,t)),i.push(new Yt(P,D).rotateNeg120(e,t))}i.sort((C,E)=>C.x-E.x),i.sort((C,E)=>C.y-E.y);const o=new Array(e+t+1),l=new Array(e+t+1);for(let C=0;C<o.length;C++)o[C]=1/0,l[C]=-1/0;let h=0,c=0;const u=i.length;for(let C=0;C<u;C++)c=i[C].x,h=i[C].y,o[h]=Math.min(c,o[h]),l[h]=Math.max(c,l[h]);const d=(C,E)=>{const A=C.clone();return E==="A"&&A.rotateNeg120(e,t),E==="B"&&A.rotate120(e,t),A.x<0?A.y:A.x+A.y},f=[],p=[],_=[],m=[],v={},x=[];let b=-1,S=-1;for(let C=0;C<u;C++)f[C]=i[C].toCartesianOrigin(new Yt(0,0),.5),p[C]=d(i[C],"O"),_[C]=d(i[C],"A"),m[C]=d(i[C],"B"),p[C]===_[C]&&_[C]===m[C]?(b=3,S=p[C]):p[C]===_[C]?(b=4,S=p[C]):_[C]===m[C]?(b=5,S=_[C]):m[C]===p[C]&&(b=6,S=p[C]),p[C]<_[C]&&p[C]<m[C]&&(b=2,S=p[C]),_[C]<p[C]&&_[C]<m[C]&&(b=1,S=_[C]),m[C]<_[C]&&m[C]<p[C]&&(b=0,S=m[C]),x.push([b,S,i[C].x,i[C].y]);x.sort((C,E)=>C[2]-E[2]),x.sort((C,E)=>C[3]-E[3]),x.sort((C,E)=>C[1]-E[1]),x.sort((C,E)=>C[0]-E[0]);for(let C=0;C<x.length;C++)v[x[C][2]+"|"+x[C][3]]=[x[C][0],x[C][1],C];return this.m=e,this.n=t,this.vertices=i,this.vertByDist=v,this.cartesian=f,this.min=o,this.max=l,this}}class hd{constructor(e,t,i,s){this.name=e,this.category=t,this.vertex=i,this.face=s}}class nu extends hd{innerToData(e,t){for(let i=0;i<t.innerFacets.length;i++)this.face.push(t.innerFacets[i].map(s=>t.vecToidx[e+s]))}mapABOBtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let s=0;s<t.isoVecsABOB.length;s++){const r=[];for(let n=0;n<3;n++)t.vertexTypes[s][n]===0?r.push(e+"|"+t.isoVecsABOB[s][n].x+"|"+t.isoVecsABOB[s][n].y):r.push(i+"|"+t.isoVecsABOB[s][n].x+"|"+t.isoVecsABOB[s][n].y);this.face.push([t.vecToidx[r[0]],t.vecToidx[r[1]],t.vecToidx[r[2]]])}}mapOBOAtoDATA(e,t){const i=t.IDATA.edgematch[e][0];for(let s=0;s<t.isoVecsOBOA.length;s++){const r=[];for(let n=0;n<3;n++)t.vertexTypes[s][n]===1?r.push(e+"|"+t.isoVecsOBOA[s][n].x+"|"+t.isoVecsOBOA[s][n].y):r.push(i+"|"+t.isoVecsOBOA[s][n].x+"|"+t.isoVecsOBOA[s][n].y);this.face.push([t.vecToidx[r[0]],t.vecToidx[r[1]],t.vecToidx[r[2]]])}}mapBAOAtoDATA(e,t){const i=t.IDATA.edgematch[e][2];for(let s=0;s<t.isoVecsBAOA.length;s++){const r=[];for(let n=0;n<3;n++)t.vertexTypes[s][n]===1?r.push(e+"|"+t.isoVecsBAOA[s][n].x+"|"+t.isoVecsBAOA[s][n].y):r.push(i+"|"+t.isoVecsBAOA[s][n].x+"|"+t.isoVecsBAOA[s][n].y);this.face.push([t.vecToidx[r[0]],t.vecToidx[r[1]],t.vecToidx[r[2]]])}}orderData(e){const t=[];for(let n=0;n<13;n++)t[n]=[];const i=e.closestTo;for(let n=0;n<i.length;n++)i[n][0]>-1?i[n][1]>0&&t[i[n][0]].push([n,i[n][1]]):t[12].push([n,i[n][0]]);const s=[];for(let n=0;n<12;n++)s[n]=n;let r=12;for(let n=0;n<12;n++){t[n].sort((o,l)=>o[1]-l[1]);for(let o=0;o<t[n].length;o++)s[t[n][o][0]]=r++}for(let n=0;n<t[12].length;n++)s[t[12][n][0]]=r++;for(let n=0;n<this.vertex.length;n++)this.vertex[n].push(s[n]);this.vertex.sort((n,o)=>n[3]-o[3]);for(let n=0;n<this.vertex.length;n++)this.vertex[n].pop();for(let n=0;n<this.face.length;n++)for(let o=0;o<this.face[n].length;o++)this.face[n][o]=s[this.face[n][o]];this.sharedNodes=t[12].length,this.poleNodes=this.vertex.length-this.sharedNodes}setOrder(e,t){const i=[],s=[];let r=t.pop();s.push(r);let n=this.face[r].indexOf(e);n=(n+2)%3;let o=this.face[r][n];i.push(o);let l=0;for(;t.length>0;)r=t[l],this.face[r].indexOf(o)>-1?(n=(this.face[r].indexOf(o)+1)%3,o=this.face[r][n],i.push(o),s.push(r),t.splice(l,1),l=0):l++;return this.adjacentFaces.push(i),s}toGoldbergPolyhedronData(){const e=new hd("GeoDual","Goldberg",[],[]);e.name="GD dual";const t=this.vertex.length,i=new Array(t);for(let h=0;h<t;h++)i[h]=[];for(let h=0;h<this.face.length;h++)for(let c=0;c<3;c++)i[this.face[h][c]].push(h);let s=0,r=0,n=0,o=[],l=[];this.adjacentFaces=[];for(let h=0;h<i.length;h++)e.face[h]=this.setOrder(h,i[h].concat([])),i[h].forEach(c=>{s=0,r=0,n=0,o=this.face[c];for(let u=0;u<3;u++)l=this.vertex[o[u]],s+=l[0],r+=l[1],n+=l[2];e.vertex[c]=[s/3,r/3,n/3]});return e}static BuildGeodesicData(e){const t=new nu("Geodesic-m-n","Geodesic",[[0,_i,-1],[-_i,1,0],[-1,0,-_i],[1,0,-_i],[_i,1,0],[0,_i,1],[-1,0,_i],[-_i,-1,0],[0,-_i,-1],[_i,-1,0],[1,0,_i],[0,-_i,1]],[]);e.setIndices(),e.calcCoeffs(),e.createInnerFacets(),e.edgeVecsABOB(),e.mapABOBtoOBOA(),e.mapABOBtoBAOA();for(let s=0;s<e.IDATA.face.length;s++)e.MapToFace(s,t),t.innerToData(s,e),e.IDATA.edgematch[s][1]==="B"&&t.mapABOBtoDATA(s,e),e.IDATA.edgematch[s][1]==="O"&&t.mapOBOAtoDATA(s,e),e.IDATA.edgematch[s][3]==="A"&&t.mapBAOAtoDATA(s,e);t.orderData(e);const i=1;return t.vertex=t.vertex.map(function(s){const r=s[0],n=s[1],o=s[2],l=Math.sqrt(r*r+n*n+o*o);return s[0]*=i/l,s[1]*=i/l,s[2]*=i/l,s}),t}}function OI(a,e,t=null){let i=e.m||1;i!==Math.floor(i)&&B.Warn("m not an integer only floor(m) used");let s=e.n||0;if(s!==Math.floor(s)&&B.Warn("n not an integer only floor(n) used"),s>i){const h=s;s=i,i=h,B.Warn("n > m therefore m and n swapped")}const r=new Bm;r.build(i,s);const o={custom:nu.BuildGeodesicData(r),size:e.size,sizeX:e.sizeX,sizeY:e.sizeY,sizeZ:e.sizeZ,faceUV:e.faceUV,faceColors:e.faceColors,flat:e.flat,updatable:e.updatable,sideOrientation:e.sideOrientation,frontUVs:e.frontUVs,backUVs:e.backUVs};return t0(a,o,t)}function wI(a,e){const t=a.size,i=a.sizeX||t||1,s=a.sizeY||t||1,r=a.sizeZ||t||1,n=a.sideOrientation===0?0:a.sideOrientation||de.DEFAULTSIDE,o=new Array,l=new Array,h=new Array,c=new Array;let u=1/0,d=-1/0,f=1/0,p=-1/0;for(let v=0;v<e.vertex.length;v++)u=Math.min(u,e.vertex[v][0]*i),d=Math.max(d,e.vertex[v][0]*i),f=Math.min(f,e.vertex[v][1]*s),p=Math.max(p,e.vertex[v][1]*s);let _=0;for(let v=0;v<e.face.length;v++){const x=e.face[v],b=g.FromArray(e.vertex[x[0]]),S=g.FromArray(e.vertex[x[2]]),C=g.FromArray(e.vertex[x[1]]),E=S.subtract(b),A=C.subtract(b),M=g.Cross(A,E).normalize();for(let D=0;D<x.length;D++){h.push(M.x,M.y,M.z);const P=e.vertex[x[D]];o.push(P[0]*i,P[1]*s,P[2]*r);const O=(P[1]*s-f)/(p-f);c.push((P[0]*i-u)/(d-u),nt.UseOpenGLOrientationForUV?1-O:O)}for(let D=0;D<x.length-2;D++)l.push(_,_+D+2,_+D+1);_+=x.length}de._ComputeSides(n,o,l,h,c);const m=new de;return m.positions=o,m.indices=l,m.normals=h,m.uvs=c,m}function Um(a,e,t=null){const i=e.size,s=e.sizeX||i||1,r=e.sizeY||i||1,n=e.sizeZ||i||1;let o=e.m||1;o!==Math.floor(o)&&B.Warn("m not an integer only floor(m) used");let l=e.n||0;if(l!==Math.floor(l)&&B.Warn("n not an integer only floor(n) used"),l>o){const p=l;l=o,o=p,B.Warn("n > m therefore m and n swapped")}const h=new Bm;h.build(o,l);const c=nu.BuildGeodesicData(h),u=c.toGoldbergPolyhedronData(),d=new ru(a,t);e.sideOrientation=V._GetDefaultSideOrientation(e.sideOrientation),d._originalBuilderSideOrientation=e.sideOrientation,wI(e,u).applyToMesh(d,e.updatable),d.goldbergData.nbSharedFaces=c.sharedNodes,d.goldbergData.nbUnsharedFaces=c.poleNodes,d.goldbergData.adjacentFaces=c.adjacentFaces,d.goldbergData.nbFaces=d.goldbergData.nbSharedFaces+d.goldbergData.nbUnsharedFaces,d.goldbergData.nbFacesAtPole=(d.goldbergData.nbUnsharedFaces-12)/12;for(let p=0;p<c.vertex.length;p++)d.goldbergData.faceCenters.push(g.FromArray(c.vertex[p])),d.goldbergData.faceCenters[p].x*=s,d.goldbergData.faceCenters[p].y*=r,d.goldbergData.faceCenters[p].z*=n,d.goldbergData.faceColors.push(new J(1,1,1,1));for(let p=0;p<u.face.length;p++){const _=u.face[p],m=g.FromArray(u.vertex[_[0]]),v=g.FromArray(u.vertex[_[2]]),x=g.FromArray(u.vertex[_[1]]),b=v.subtract(m),S=x.subtract(m),C=g.Cross(S,b).normalize(),E=g.Cross(S,C).normalize();d.goldbergData.faceXaxis.push(S.normalize()),d.goldbergData.faceYaxis.push(C),d.goldbergData.faceZaxis.push(E)}return d}V.CreateGoldberg=Um;const Os={CreateBox:Yc,CreateTiledBox:PI,CreateSphere:qr,CreateDisc:i0,CreateIcoSphere:Hd,CreateRibbon:Ba,CreateCylinder:jl,CreateTorus:La,CreateTorusKnot:Dm,CreateLineSystem:lm,CreateLines:Kc,CreateDashedLines:hm,ExtrudeShape:e0,ExtrudeShapeCustom:um,CreateLathe:Nm,CreateTiledPlane:II,CreatePlane:Ec,CreateGround:Wc,CreateTiledGround:Z_,CreateGroundFromHeightMap:J_,CreatePolygon:g0,ExtrudePolygon:wm,CreateTube:Fm,CreatePolyhedron:t0,CreateGeodesic:OI,CreateGoldberg:Um,CreateDecal:Lm,CreateCapsule:sm};class NI{constructor(){this.running=!1,this._simplificationArray=[]}addTask(e){this._simplificationArray.push(e)}executeNext(){const e=this._simplificationArray.pop();e?(this.running=!0,this.runSimplification(e)):this.running=!1}runSimplification(e){if(e.parallelProcessing)e.settings.forEach(t=>{this._getSimplifier(e).simplify(t,s=>{t.distance!==void 0&&e.mesh.addLODLevel(t.distance,s),s.isVisible=!0,t.quality===e.settings[e.settings.length-1].quality&&e.successCallback&&e.successCallback(),this.executeNext()})});else{const t=this._getSimplifier(e),i=(s,r)=>{t.simplify(s,n=>{s.distance!==void 0&&e.mesh.addLODLevel(s.distance,n),n.isVisible=!0,r()})};fr.Run(e.settings.length,s=>{i(e.settings[s.index],()=>{s.executeNext()})},()=>{e.successCallback&&e.successCallback(),this.executeNext()})}}_getSimplifier(e){switch(e.simplificationType){case nc.QUADRATIC:default:return new UI(e.mesh)}}}var nc;(function(a){a[a.QUADRATIC=0]="QUADRATIC"})(nc||(nc={}));class FI{constructor(e){this._vertices=e,this.error=new Array(4),this.deleted=!1,this.isDirty=!1,this.deletePending=!1,this.borderFactor=0}}class LI{constructor(e,t){this.position=e,this.id=t,this.isBorder=!0,this.q=new bo,this.triangleCount=0,this.triangleStart=0,this.originalOffsets=[]}updatePosition(e){this.position.copyFrom(e)}}class bo{constructor(e){this.data=new Array(10);for(let t=0;t<10;++t)e&&e[t]?this.data[t]=e[t]:this.data[t]=0}det(e,t,i,s,r,n,o,l,h){return this.data[e]*this.data[r]*this.data[h]+this.data[i]*this.data[s]*this.data[l]+this.data[t]*this.data[n]*this.data[o]-this.data[i]*this.data[r]*this.data[o]-this.data[e]*this.data[n]*this.data[l]-this.data[t]*this.data[s]*this.data[h]}addInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e.data[t]}addArrayInPlace(e){for(let t=0;t<10;++t)this.data[t]+=e[t]}add(e){const t=new bo;for(let i=0;i<10;++i)t.data[i]=this.data[i]+e.data[i];return t}static FromData(e,t,i,s){return new bo(bo.DataFromNumbers(e,t,i,s))}static DataFromNumbers(e,t,i,s){return[e*e,e*t,e*i,e*s,t*t,t*i,t*s,i*i,i*s,s*s]}}class BI{constructor(e,t){this.vertexId=e,this.triangleId=t}}class UI{constructor(e){this._mesh=e,this.syncIterations=5e3,this.aggressiveness=7,this.decimationIterations=100,this.boundingBoxEpsilon=tt}simplify(e,t){this._initDecimatedMesh(),fr.Run(this._mesh.subMeshes.length,i=>{this._initWithMesh(i.index,()=>{this._runDecimation(e,i.index,()=>{i.executeNext()})},e.optimizeMesh)},()=>{setTimeout(()=>{t(this._reconstructedMesh)},0)})}_runDecimation(e,t,i){const s=~~(this._triangles.length*e.quality);let r=0;const n=this._triangles.length,o=(l,h)=>{setTimeout(()=>{l%5===0&&this._updateMesh(l===0);for(let d=0;d<this._triangles.length;++d)this._triangles[d].isDirty=!1;const c=1e-9*Math.pow(l+3,this.aggressiveness),u=d=>{const f=~~((this._triangles.length/2+d)%this._triangles.length),p=this._triangles[f];if(!!p&&!(p.error[3]>c||p.deleted||p.isDirty)){for(let _=0;_<3;++_)if(p.error[_]<c){const m=[],v=[],x=p._vertices[_],b=p._vertices[(_+1)%3];if(x.isBorder||b.isBorder)continue;const S=g.Zero();this._calculateError(x,b,S);const C=new Array;if(this._isFlipped(x,b,S,m,C)||this._isFlipped(b,x,S,v,C)||m.indexOf(!0)<0||v.indexOf(!0)<0)continue;const E=new Array;if(C.forEach(D=>{E.indexOf(D)===-1&&(D.deletePending=!0,E.push(D))}),E.length%2!==0)continue;x.q=b.q.add(x.q),x.updatePosition(S);const A=this._references.length;r=this._updateTriangles(x,x,m,r),r=this._updateTriangles(x,b,v,r);const M=this._references.length-A;if(M<=x.triangleCount){if(M)for(let D=0;D<M;D++)this._references[x.triangleStart+D]=this._references[A+D]}else x.triangleStart=A;x.triangleCount=M;break}}};fr.SyncAsyncForLoop(this._triangles.length,this.syncIterations,u,h,()=>n-r<=s)},0)};fr.Run(this.decimationIterations,l=>{n-r<=s?l.breakLoop():o(l.index,()=>{l.executeNext()})},()=>{setTimeout(()=>{this._reconstructMesh(t),i()},0)})}_initWithMesh(e,t,i){this._vertices=[],this._triangles=[];const s=this._mesh.getVerticesData(y.PositionKind),r=this._mesh.getIndices(),n=this._mesh.subMeshes[e],o=u=>{if(i){for(let d=0;d<this._vertices.length;++d)if(this._vertices[d].position.equalsWithEpsilon(u,1e-4))return this._vertices[d]}return null},l=[],h=u=>{if(!s)return;const d=u+n.verticesStart,f=g.FromArray(s,d*3),p=o(f)||new LI(f,this._vertices.length);p.originalOffsets.push(d),p.id===this._vertices.length&&this._vertices.push(p),l.push(p.id)},c=n.verticesCount;fr.SyncAsyncForLoop(c,this.syncIterations/4>>0,h,()=>{const u=d=>{if(!r)return;const p=(n.indexStart/3+d)*3,_=r[p+0],m=r[p+1],v=r[p+2],x=this._vertices[l[_-n.verticesStart]],b=this._vertices[l[m-n.verticesStart]],S=this._vertices[l[v-n.verticesStart]],C=new FI([x,b,S]);C.originalOffset=p,this._triangles.push(C)};fr.SyncAsyncForLoop(n.indexCount/3,this.syncIterations,u,()=>{this._init(t)})})}_init(e){const t=i=>{const s=this._triangles[i];s.normal=g.Cross(s._vertices[1].position.subtract(s._vertices[0].position),s._vertices[2].position.subtract(s._vertices[0].position)).normalize();for(let r=0;r<3;r++)s._vertices[r].q.addArrayInPlace(bo.DataFromNumbers(s.normal.x,s.normal.y,s.normal.z,-g.Dot(s.normal,s._vertices[0].position)))};fr.SyncAsyncForLoop(this._triangles.length,this.syncIterations,t,()=>{const i=s=>{const r=this._triangles[s];for(let n=0;n<3;++n)r.error[n]=this._calculateError(r._vertices[n],r._vertices[(n+1)%3]);r.error[3]=Math.min(r.error[0],r.error[1],r.error[2])};fr.SyncAsyncForLoop(this._triangles.length,this.syncIterations,i,()=>{e()})})}_reconstructMesh(e){const t=[];let i;for(i=0;i<this._vertices.length;++i)this._vertices[i].triangleCount=0;let s,r;for(i=0;i<this._triangles.length;++i)if(!this._triangles[i].deleted){for(s=this._triangles[i],r=0;r<3;++r)s._vertices[r].triangleCount=1;t.push(s)}const n=this._reconstructedMesh.getVerticesData(y.PositionKind)||[],o=this._reconstructedMesh.getVerticesData(y.NormalKind)||[],l=this._reconstructedMesh.getVerticesData(y.UVKind)||[],h=this._reconstructedMesh.getVerticesData(y.ColorKind)||[],c=this._mesh.getVerticesData(y.NormalKind),u=this._mesh.getVerticesData(y.UVKind),d=this._mesh.getVerticesData(y.ColorKind);let f=0;for(i=0;i<this._vertices.length;++i){const S=this._vertices[i];S.id=f,S.triangleCount&&S.originalOffsets.forEach(C=>{n.push(S.position.x),n.push(S.position.y),n.push(S.position.z),c&&c.length&&(o.push(c[C*3]),o.push(c[C*3+1]),o.push(c[C*3+2])),u&&u.length&&(l.push(u[C*2]),l.push(u[C*2+1])),d&&d.length&&(h.push(d[C*4]),h.push(d[C*4+1]),h.push(d[C*4+2]),h.push(d[C*4+3])),++f})}const p=this._reconstructedMesh.getTotalIndices(),_=this._reconstructedMesh.getTotalVertices(),m=this._reconstructedMesh.subMeshes;this._reconstructedMesh.subMeshes=[];const v=this._reconstructedMesh.getIndices(),x=this._mesh.getIndices();for(i=0;i<t.length;++i)s=t[i],[0,1,2].forEach(S=>{const C=x[s.originalOffset+S];let E=s._vertices[S].originalOffsets.indexOf(C);E<0&&(E=0),v.push(s._vertices[S].id+E+_)});this._reconstructedMesh.setIndices(v),this._reconstructedMesh.setVerticesData(y.PositionKind,n),o.length>0&&this._reconstructedMesh.setVerticesData(y.NormalKind,o),l.length>0&&this._reconstructedMesh.setVerticesData(y.UVKind,l),h.length>0&&this._reconstructedMesh.setVerticesData(y.ColorKind,h);const b=this._mesh.subMeshes[e];e>0&&(this._reconstructedMesh.subMeshes=[],m.forEach(S=>{fs.AddToMesh(S.materialIndex,S.verticesStart,S.verticesCount,S.indexStart,S.indexCount,S.getMesh())}),fs.AddToMesh(b.materialIndex,_,f,p,t.length*3,this._reconstructedMesh))}_initDecimatedMesh(){this._reconstructedMesh=new V(this._mesh.name+"Decimated",this._mesh.getScene()),this._reconstructedMesh.material=this._mesh.material,this._reconstructedMesh.parent=this._mesh.parent,this._reconstructedMesh.isVisible=!1,this._reconstructedMesh.renderingGroupId=this._mesh.renderingGroupId}_isFlipped(e,t,i,s,r){for(let n=0;n<e.triangleCount;++n){const o=this._triangles[this._references[e.triangleStart+n].triangleId];if(o.deleted)continue;const l=this._references[e.triangleStart+n].vertexId,h=o._vertices[(l+1)%3],c=o._vertices[(l+2)%3];if(h===t||c===t){s[n]=!0,r.push(o);continue}let u=h.position.subtract(i);u=u.normalize();let d=c.position.subtract(i);if(d=d.normalize(),Math.abs(g.Dot(u,d))>.999)return!0;const f=g.Cross(u,d).normalize();if(s[n]=!1,g.Dot(f,o.normal)<.2)return!0}return!1}_updateTriangles(e,t,i,s){let r=s;for(let n=0;n<t.triangleCount;++n){const o=this._references[t.triangleStart+n],l=this._triangles[o.triangleId];if(!l.deleted){if(i[n]&&l.deletePending){l.deleted=!0,r++;continue}l._vertices[o.vertexId]=e,l.isDirty=!0,l.error[0]=this._calculateError(l._vertices[0],l._vertices[1])+l.borderFactor/2,l.error[1]=this._calculateError(l._vertices[1],l._vertices[2])+l.borderFactor/2,l.error[2]=this._calculateError(l._vertices[2],l._vertices[0])+l.borderFactor/2,l.error[3]=Math.min(l.error[0],l.error[1],l.error[2]),this._references.push(o)}}return r}_identifyBorder(){for(let e=0;e<this._vertices.length;++e){const t=[],i=[],s=this._vertices[e];let r;for(r=0;r<s.triangleCount;++r){const n=this._triangles[this._references[s.triangleStart+r].triangleId];for(let o=0;o<3;o++){let l=0;const h=n._vertices[o];for(;l<t.length&&i[l]!==h.id;)++l;l===t.length?(t.push(1),i.push(h.id)):t[l]++}}for(r=0;r<t.length;++r)t[r]===1?this._vertices[i[r]].isBorder=!0:this._vertices[i[r]].isBorder=!1}}_updateMesh(e=!1){let t;if(!e){const l=[];for(t=0;t<this._triangles.length;++t)this._triangles[t].deleted||l.push(this._triangles[t]);this._triangles=l}for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleCount=0,this._vertices[t].triangleStart=0;let i,s,r;for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)r=i._vertices[s],r.triangleCount++;let n=0;for(t=0;t<this._vertices.length;++t)this._vertices[t].triangleStart=n,n+=this._vertices[t].triangleCount,this._vertices[t].triangleCount=0;const o=new Array(this._triangles.length*3);for(t=0;t<this._triangles.length;++t)for(i=this._triangles[t],s=0;s<3;++s)r=i._vertices[s],o[r.triangleStart+r.triangleCount]=new BI(s,t),r.triangleCount++;this._references=o,e&&this._identifyBorder()}_vertexError(e,t){const i=t.x,s=t.y,r=t.z;return e.data[0]*i*i+2*e.data[1]*i*s+2*e.data[2]*i*r+2*e.data[3]*i+e.data[4]*s*s+2*e.data[5]*s*r+2*e.data[6]*s+e.data[7]*r*r+2*e.data[8]*r+e.data[9]}_calculateError(e,t,i){const s=e.q.add(t.q),r=e.isBorder&&t.isBorder;let n=0;const o=s.det(0,1,2,1,4,5,2,5,7);if(o!==0&&!r)i||(i=g.Zero()),i.x=-1/o*s.det(1,2,3,4,5,6,5,7,8),i.y=1/o*s.det(0,2,3,1,5,6,2,7,8),i.z=-1/o*s.det(0,1,3,1,4,6,2,5,8),n=this._vertexError(s,i);else{const l=e.position.add(t.position).divide(new g(2,2,2)),h=this._vertexError(s,e.position),c=this._vertexError(s,t.position),u=this._vertexError(s,l);n=Math.min(h,c,u),n===h?i&&i.copyFrom(e.position):n===c?i&&i.copyFrom(t.position):i&&i.copyFrom(l)}return n}}Object.defineProperty(ge.prototype,"simplificationQueue",{get:function(){if(!this._simplificationQueue){this._simplificationQueue=new NI;let a=this._getComponent(ue.NAME_SIMPLIFICATIONQUEUE);a||(a=new VI(this),this._addComponent(a))}return this._simplificationQueue},set:function(a){this._simplificationQueue=a},enumerable:!0,configurable:!0});V.prototype.simplify=function(a,e=!0,t=nc.QUADRATIC,i){return this.getScene().simplificationQueue.addTask({settings:a,parallelProcessing:e,mesh:this,simplificationType:t,successCallback:i}),this};class VI{constructor(e){this.name=ue.NAME_SIMPLIFICATIONQUEUE,this.scene=e}register(){this.scene._beforeCameraUpdateStage.registerStep(ue.STEP_BEFORECAMERAUPDATE_SIMPLIFICATIONQUEUE,this,this._beforeCameraUpdate)}rebuild(){}dispose(){}_beforeCameraUpdate(){this.scene._simplificationQueue&&!this.scene._simplificationQueue.running&&this.scene._simplificationQueue.executeNext()}}V.prototype.thinInstanceAdd=function(a,e=!0){if(!this.getScene().getEngine().getCaps().instancedArrays)return B.Error("Thin Instances are not supported on this device as Instanced Array extension not supported"),-1;this._thinInstanceUpdateBufferSize("matrix",Array.isArray(a)?a.length:1);const t=this._thinInstanceDataStorage.instancesCount;if(Array.isArray(a))for(let i=0;i<a.length;++i)this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,a[i],i===a.length-1&&e);else this.thinInstanceSetMatrixAt(this._thinInstanceDataStorage.instancesCount++,a,e);return t};V.prototype.thinInstanceAddSelf=function(a=!0){return this.thinInstanceAdd(L.IdentityReadOnly,a)};V.prototype.thinInstanceRegisterAttribute=function(a,e){a===y.ColorKind&&(a=y.ColorInstanceKind),this.removeVerticesData(a),this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.strides[a]=e,this._userThinInstanceBuffersStorage.sizes[a]=e*Math.max(32,this._thinInstanceDataStorage.instancesCount),this._userThinInstanceBuffersStorage.data[a]=new Float32Array(this._userThinInstanceBuffersStorage.sizes[a]),this._userThinInstanceBuffersStorage.vertexBuffers[a]=new y(this.getEngine(),this._userThinInstanceBuffersStorage.data[a],a,!0,!1,e,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a])};V.prototype.thinInstanceSetMatrixAt=function(a,e,t=!0){if(!this._thinInstanceDataStorage.matrixData||a>=this._thinInstanceDataStorage.instancesCount)return!1;const i=this._thinInstanceDataStorage.matrixData;return e.copyToArray(i,a*16),this._thinInstanceDataStorage.worldMatrices&&(this._thinInstanceDataStorage.worldMatrices[a]=e),t&&(this.thinInstanceBufferUpdated("matrix"),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)),!0};V.prototype.thinInstanceSetAttributeAt=function(a,e,t,i=!0){return a===y.ColorKind&&(a=y.ColorInstanceKind),!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.data[a]||e>=this._thinInstanceDataStorage.instancesCount?!1:(this._thinInstanceUpdateBufferSize(a,0),this._userThinInstanceBuffersStorage.data[a].set(t,e*this._userThinInstanceBuffersStorage.strides[a]),i&&this.thinInstanceBufferUpdated(a),!0)};Object.defineProperty(V.prototype,"thinInstanceCount",{get:function(){return this._thinInstanceDataStorage.instancesCount},set:function(a){var e,t;const i=(e=this._thinInstanceDataStorage.matrixData)!==null&&e!==void 0?e:(t=this.source)===null||t===void 0?void 0:t._thinInstanceDataStorage.matrixData,s=i?i.length/16:0;a<=s&&(this._thinInstanceDataStorage.instancesCount=a)},enumerable:!0,configurable:!0});V.prototype._thinInstanceCreateMatrixBuffer=function(a,e,t=!1){a===y.ColorKind&&(a=y.ColorInstanceKind);const i=new Hr(this.getEngine(),e,!t,16,!1,!0);for(let s=0;s<4;s++)this.setVerticesBuffer(i.createVertexBuffer(a+s,s*4,4));return i};V.prototype.thinInstanceSetBuffer=function(a,e,t=0,i=!1){var s,r,n;t=t||16,a==="matrix"?((s=this._thinInstanceDataStorage.matrixBuffer)===null||s===void 0||s.dispose(),this._thinInstanceDataStorage.matrixBuffer=null,this._thinInstanceDataStorage.matrixBufferSize=e?e.length:32*t,this._thinInstanceDataStorage.matrixData=e,this._thinInstanceDataStorage.worldMatrices=null,e!==null?(this._thinInstanceDataStorage.instancesCount=e.length/t,this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",e,i),this.doNotSyncBoundingInfo||this.thinInstanceRefreshBoundingInfo(!1)):(this._thinInstanceDataStorage.instancesCount=0,this.doNotSyncBoundingInfo||this.refreshBoundingInfo())):a==="previousMatrix"?((r=this._thinInstanceDataStorage.previousMatrixBuffer)===null||r===void 0||r.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=null,this._thinInstanceDataStorage.previousMatrixData=e,e!==null&&(this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",e,i))):(a===y.ColorKind&&(a=y.ColorInstanceKind),e===null?!((n=this._userThinInstanceBuffersStorage)===null||n===void 0)&&n.data[a]&&(this.removeVerticesData(a),delete this._userThinInstanceBuffersStorage.data[a],delete this._userThinInstanceBuffersStorage.strides[a],delete this._userThinInstanceBuffersStorage.sizes[a],delete this._userThinInstanceBuffersStorage.vertexBuffers[a]):(this._thinInstanceInitializeUserStorage(),this._userThinInstanceBuffersStorage.data[a]=e,this._userThinInstanceBuffersStorage.strides[a]=t,this._userThinInstanceBuffersStorage.sizes[a]=e.length,this._userThinInstanceBuffersStorage.vertexBuffers[a]=new y(this.getEngine(),e,a,!i,!1,t,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a])))};V.prototype.thinInstanceBufferUpdated=function(a){var e,t,i;a==="matrix"?(e=this._thinInstanceDataStorage.matrixBuffer)===null||e===void 0||e.updateDirectly(this._thinInstanceDataStorage.matrixData,0,this._thinInstanceDataStorage.instancesCount):a==="previousMatrix"?(t=this._thinInstanceDataStorage.previousMatrixBuffer)===null||t===void 0||t.updateDirectly(this._thinInstanceDataStorage.previousMatrixData,0,this._thinInstanceDataStorage.instancesCount):(a===y.ColorKind&&(a=y.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[a]&&this._userThinInstanceBuffersStorage.vertexBuffers[a].updateDirectly(this._userThinInstanceBuffersStorage.data[a],0))};V.prototype.thinInstancePartialBufferUpdate=function(a,e,t){var i;a==="matrix"?this._thinInstanceDataStorage.matrixBuffer&&this._thinInstanceDataStorage.matrixBuffer.updateDirectly(e,t):(a===y.ColorKind&&(a=y.ColorInstanceKind),!((i=this._userThinInstanceBuffersStorage)===null||i===void 0)&&i.vertexBuffers[a]&&this._userThinInstanceBuffersStorage.vertexBuffers[a].updateDirectly(e,t))};V.prototype.thinInstanceGetWorldMatrices=function(){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return[];const a=this._thinInstanceDataStorage.matrixData;if(!this._thinInstanceDataStorage.worldMatrices){this._thinInstanceDataStorage.worldMatrices=new Array;for(let e=0;e<this._thinInstanceDataStorage.instancesCount;++e)this._thinInstanceDataStorage.worldMatrices[e]=L.FromArray(a,e*16)}return this._thinInstanceDataStorage.worldMatrices};V.prototype.thinInstanceRefreshBoundingInfo=function(a=!1,e=!1,t=!1){if(!this._thinInstanceDataStorage.matrixData||!this._thinInstanceDataStorage.matrixBuffer)return;const i=this._thinInstanceDataStorage.boundingVectors;a&&(i.length=0,this.refreshBoundingInfo(e,t));const s=this.getBoundingInfo(),r=this._thinInstanceDataStorage.matrixData;if(i.length===0)for(let n=0;n<s.boundingBox.vectors.length;++n)i.push(s.boundingBox.vectors[n].clone());G.Vector3[0].setAll(Number.POSITIVE_INFINITY),G.Vector3[1].setAll(Number.NEGATIVE_INFINITY);for(let n=0;n<this._thinInstanceDataStorage.instancesCount;++n){L.FromArrayToRef(r,n*16,G.Matrix[0]);for(let o=0;o<i.length;++o)g.TransformCoordinatesToRef(i[o],G.Matrix[0],G.Vector3[2]),G.Vector3[0].minimizeInPlace(G.Vector3[2]),G.Vector3[1].maximizeInPlace(G.Vector3[2])}s.reConstruct(G.Vector3[0],G.Vector3[1]),this._updateBoundingInfo()};V.prototype._thinInstanceUpdateBufferSize=function(a,e=1){var t,i,s;a===y.ColorKind&&(a=y.ColorInstanceKind);const r=a==="matrix";if(!r&&(!this._userThinInstanceBuffersStorage||!this._userThinInstanceBuffersStorage.strides[a]))return;const n=r?16:this._userThinInstanceBuffersStorage.strides[a],o=r?this._thinInstanceDataStorage.matrixBufferSize:this._userThinInstanceBuffersStorage.sizes[a];let l=r?this._thinInstanceDataStorage.matrixData:this._userThinInstanceBuffersStorage.data[a];const h=(this._thinInstanceDataStorage.instancesCount+e)*n;let c=o;for(;c<h;)c*=2;if(!l||o!=c){if(!l)l=new Float32Array(c);else{const u=new Float32Array(c);u.set(l,0),l=u}r?((t=this._thinInstanceDataStorage.matrixBuffer)===null||t===void 0||t.dispose(),this._thinInstanceDataStorage.matrixBuffer=this._thinInstanceCreateMatrixBuffer("world",l,!1),this._thinInstanceDataStorage.matrixData=l,this._thinInstanceDataStorage.matrixBufferSize=c,this._scene.needsPreviousWorldMatrices&&!this._thinInstanceDataStorage.previousMatrixData&&((i=this._thinInstanceDataStorage.previousMatrixBuffer)===null||i===void 0||i.dispose(),this._thinInstanceDataStorage.previousMatrixBuffer=this._thinInstanceCreateMatrixBuffer("previousWorld",l,!1))):((s=this._userThinInstanceBuffersStorage.vertexBuffers[a])===null||s===void 0||s.dispose(),this._userThinInstanceBuffersStorage.data[a]=l,this._userThinInstanceBuffersStorage.sizes[a]=c,this._userThinInstanceBuffersStorage.vertexBuffers[a]=new y(this.getEngine(),l,a,!0,!1,n,!0),this.setVerticesBuffer(this._userThinInstanceBuffersStorage.vertexBuffers[a]))}};V.prototype._thinInstanceInitializeUserStorage=function(){this._userThinInstanceBuffersStorage||(this._userThinInstanceBuffersStorage={data:{},sizes:{},vertexBuffers:{},strides:{}})};V.prototype._disposeThinInstanceSpecificData=function(){var a;!((a=this._thinInstanceDataStorage)===null||a===void 0)&&a.matrixBuffer&&(this._thinInstanceDataStorage.matrixBuffer.dispose(),this._thinInstanceDataStorage.matrixBuffer=null)};k.OfflineProviderFactory=(a,e,t=!1)=>new vs(a,e,t);class vs{constructor(e,t,i=!1){this._idbFactory=typeof indexedDB<"u"?indexedDB:void 0,this._currentSceneUrl=vs._ReturnFullUrlLocation(e),this._db=null,this._enableSceneOffline=!1,this._enableTexturesOffline=!1,this._manifestVersionFound=0,this._mustUpdateRessources=!1,this._hasReachedQuota=!1,vs.IDBStorageEnabled?i?(this._enableSceneOffline=!0,this._enableTexturesOffline=!0,this._manifestVersionFound=1,q.SetImmediate(()=>{t(!0)})):this._checkManifestFile(t):t(!0)}get enableSceneOffline(){return this._enableSceneOffline}get enableTexturesOffline(){return this._enableTexturesOffline}_checkManifestFile(e){const t=()=>{this._enableSceneOffline=!1,this._enableTexturesOffline=!1,e(!1)},i=()=>{try{if(typeof URL=="function"&&this._currentSceneUrl.indexOf("http")===0){const o=new URL(this._currentSceneUrl);return o.pathname+=".manifest",o.toString()}}catch{}return`${this._currentSceneUrl}.manifest`};let s=!1,r=i();const n=new Ui;navigator.onLine&&(s=!0,r=r+(r.match(/\?/)==null?"?":"&")+Date.now()),n.open("GET",r),n.addEventListener("load",()=>{if(n.status===200||vs._ValidateXHRData(n,1))try{const o=JSON.parse(n.response);this._enableSceneOffline=o.enableSceneOffline,this._enableTexturesOffline=o.enableTexturesOffline&&vs._IsUASupportingBlobStorage,o.version&&!isNaN(parseInt(o.version))&&(this._manifestVersionFound=o.version),e(!0)}catch{t()}else t()},!1),n.addEventListener("error",()=>{if(s){s=!1;const o=i();n.open("GET",o),n.send()}else t()},!1);try{n.send()}catch{B.Error("Error on XHR send request."),e(!1)}}open(e,t){const i=()=>{this._isSupported=!1,t&&t()};if(!this._idbFactory||!(this._enableSceneOffline||this._enableTexturesOffline))this._isSupported=!1,t&&t();else if(this._db)e&&e();else{this._hasReachedQuota=!1,this._isSupported=!0;const s=this._idbFactory.open("babylonjs",1);s.onerror=()=>{i()},s.onblocked=()=>{B.Error("IDB request blocked. Please reload the page."),i()},s.onsuccess=()=>{this._db=s.result,e()},s.onupgradeneeded=r=>{if(this._db=r.target.result,this._db)try{this._db.createObjectStore("scenes",{keyPath:"sceneUrl"}),this._db.createObjectStore("versions",{keyPath:"sceneUrl"}),this._db.createObjectStore("textures",{keyPath:"textureUrl"})}catch(n){B.Error("Error while creating object stores. Exception: "+n.message),i()}}}}loadImage(e,t){const i=vs._ReturnFullUrlLocation(e),s=()=>{!this._hasReachedQuota&&this._db!==null?this._saveImageIntoDBAsync(i,t):t.src=e};this._mustUpdateRessources?s():this._loadImageFromDBAsync(i,t,s)}_loadImageFromDBAsync(e,t,i){if(this._isSupported&&this._db!==null){let s;const r=this._db.transaction(["textures"]);r.onabort=()=>{t.src=e},r.oncomplete=()=>{let o;s&&typeof URL=="function"?(o=URL.createObjectURL(s.data),t.onerror=()=>{B.Error("Error loading image from blob URL: "+o+" switching back to web url: "+e),t.src=e},t.src=o):i()};const n=r.objectStore("textures").get(e);n.onsuccess=o=>{s=o.target.result},n.onerror=()=>{B.Error("Error loading texture "+e+" from DB."),t.src=e}}else B.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t.src=e}_saveImageIntoDBAsync(e,t){let i;if(this._isSupported){const s=()=>{let r;if(i&&typeof URL=="function")try{r=URL.createObjectURL(i)}catch{r=URL.createObjectURL(i)}r&&(t.src=r)};if(vs._IsUASupportingBlobStorage){const r=new Ui;r.open("GET",e),r.responseType="blob",r.addEventListener("load",()=>{if(r.status===200&&this._db){i=r.response;const n=this._db.transaction(["textures"],"readwrite");n.onabort=l=>{try{const c=l.target.error;c&&c.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}s()},n.oncomplete=()=>{s()};const o={textureUrl:e,data:i};try{const l=n.objectStore("textures").put(o);l.onsuccess=()=>{},l.onerror=()=>{s()}}catch(l){l.code===25&&(vs._IsUASupportingBlobStorage=!1,this._enableTexturesOffline=!1),t.src=e}}else t.src=e},!1),r.addEventListener("error",()=>{B.Error("Error in XHR request in BABYLON.Database."),t.src=e},!1),r.send()}else t.src=e}else B.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t.src=e}_checkVersionFromDB(e,t){const i=()=>{this._saveVersionIntoDBAsync(e,t)};this._loadVersionFromDBAsync(e,t,i)}_loadVersionFromDBAsync(e,t,i){if(this._isSupported&&this._db){let s;try{const r=this._db.transaction(["versions"]);r.oncomplete=()=>{s?this._manifestVersionFound!==s.data?(this._mustUpdateRessources=!0,i()):t(s.data):(this._mustUpdateRessources=!0,i())},r.onabort=()=>{t(-1)};const n=r.objectStore("versions").get(e);n.onsuccess=o=>{s=o.target.result},n.onerror=()=>{B.Error("Error loading version for scene "+e+" from DB."),t(-1)}}catch(r){B.Error("Error while accessing 'versions' object store (READ OP). Exception: "+r.message),t(-1)}}else B.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),t(-1)}_saveVersionIntoDBAsync(e,t){if(this._isSupported&&!this._hasReachedQuota&&this._db)try{const i=this._db.transaction(["versions"],"readwrite");i.onabort=n=>{try{const o=n.target.error;o&&o.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}t(-1)},i.oncomplete=()=>{t(this._manifestVersionFound)};const s={sceneUrl:e,data:this._manifestVersionFound},r=i.objectStore("versions").put(s);r.onsuccess=()=>{},r.onerror=()=>{B.Error("Error in DB add version request in BABYLON.Database.")}}catch(i){B.Error("Error while accessing 'versions' object store (WRITE OP). Exception: "+i.message),t(-1)}else t(-1)}loadFile(e,t,i,s,r){const n=vs._ReturnFullUrlLocation(e),o=()=>{this._saveFileAsync(n,t,i,r,s)};this._checkVersionFromDB(n,l=>{l!==-1?this._mustUpdateRessources?this._saveFileAsync(n,t,i,r,s):this._loadFileAsync(n,t,o):s&&s()})}_loadFileAsync(e,t,i){if(this._isSupported&&this._db){let s;e.indexOf(".babylon")!==-1?s="scenes":s="textures";let r;const n=this._db.transaction([s]);n.oncomplete=()=>{r?t(r.data):i()},n.onabort=()=>{i()};const o=n.objectStore(s).get(e);o.onsuccess=l=>{r=l.target.result},o.onerror=()=>{B.Error("Error loading file "+e+" from DB."),i()}}else B.Error("Error: IndexedDB not supported by your browser or BabylonJS Database is not open."),t()}_saveFileAsync(e,t,i,s,r){if(this._isSupported){let n;e.indexOf(".babylon")!==-1?n="scenes":n="textures";const o=new Ui;let l;o.open("GET",e+(e.match(/\?/)==null?"?":"&")+Date.now()),s&&(o.responseType="arraybuffer"),i&&(o.onprogress=i),o.addEventListener("load",()=>{if(o.status===200||o.status<400&&vs._ValidateXHRData(o,s?6:1))if(l=s?o.response:o.responseText,!this._hasReachedQuota&&this._db){const h=this._db.transaction([n],"readwrite");h.onabort=u=>{try{const d=u.target.error;d&&d.name==="QuotaExceededError"&&(this._hasReachedQuota=!0)}catch{}t(l)},h.oncomplete=()=>{t(l)};let c;n==="scenes"?c={sceneUrl:e,data:l,version:this._manifestVersionFound}:c={textureUrl:e,data:l};try{const u=h.objectStore(n).put(c);u.onsuccess=()=>{},u.onerror=()=>{B.Error("Error in DB add file request in BABYLON.Database.")}}catch{t(l)}}else t(l);else o.status>=400&&r?r(o):t()},!1),o.addEventListener("error",()=>{B.Error("error on XHR request."),r&&r()},!1),o.send()}else B.Error("Error: IndexedDB not supported by your browser or Babylon.js database is not open."),r&&r()}static _ValidateXHRData(e,t=7){try{if(t&1){if(e.responseText&&e.responseText.length>0)return!0;if(t===1)return!1}if(t&2){const i=eu(e.response);if(i.width&&i.height&&i.width>0&&i.height>0)return!0;if(t===2)return!1}if(t&4){const i=new Uint8Array(e.response,0,3);return i[0]===68&&i[1]===68&&i[2]===83}}catch{}return!1}}vs._IsUASupportingBlobStorage=!0;vs.IDBStorageEnabled=!1;vs._ParseURL=a=>{const e=document.createElement("a");e.href=a;const t=a.substring(0,a.lastIndexOf("#")),i=a.substring(t.lastIndexOf("/")+1,a.length);return a.substring(0,a.indexOf(i,0))};vs._ReturnFullUrlLocation=a=>a.indexOf("http:/")===-1&&a.indexOf("https:/")===-1&&typeof window<"u"?vs._ParseURL(window.location.href)+a:a;class Vm{constructor(e){this._isUbo(e)?(this.setMatrix3x3=e.updateMatrix3x3.bind(e),this.setMatrix2x2=e.updateMatrix2x2.bind(e),this.setFloat=e.updateFloat.bind(e),this.setFloat2=e.updateFloat2.bind(e),this.setFloat3=e.updateFloat3.bind(e),this.setFloat4=e.updateFloat4.bind(e),this.setFloatArray=e.updateFloatArray.bind(e),this.setArray=e.updateArray.bind(e),this.setIntArray=e.updateIntArray.bind(e),this.setMatrix=e.updateMatrix.bind(e),this.setMatrices=e.updateMatrices.bind(e),this.setVector3=e.updateVector3.bind(e),this.setVector4=e.updateVector4.bind(e),this.setColor3=e.updateColor3.bind(e),this.setColor4=e.updateColor4.bind(e),this.setDirectColor4=e.updateDirectColor4.bind(e),this.setInt=e.updateInt.bind(e),this.setInt2=e.updateInt2.bind(e),this.setInt3=e.updateInt3.bind(e),this.setInt4=e.updateInt4.bind(e)):(this.setMatrix3x3=e.setMatrix3x3.bind(e),this.setMatrix2x2=e.setMatrix2x2.bind(e),this.setFloat=e.setFloat.bind(e),this.setFloat2=e.setFloat2.bind(e),this.setFloat3=e.setFloat3.bind(e),this.setFloat4=e.setFloat4.bind(e),this.setFloatArray=e.setFloatArray.bind(e),this.setArray=e.setArray.bind(e),this.setIntArray=e.setIntArray.bind(e),this.setMatrix=e.setMatrix.bind(e),this.setMatrices=e.setMatrices.bind(e),this.setVector3=e.setVector3.bind(e),this.setVector4=e.setVector4.bind(e),this.setColor3=e.setColor3.bind(e),this.setColor4=e.setColor4.bind(e),this.setDirectColor4=e.setDirectColor4.bind(e),this.setInt=e.setInt.bind(e),this.setInt2=e.setInt2.bind(e),this.setInt3=e.setInt3.bind(e),this.setInt4=e.setInt4.bind(e))}_isUbo(e){return e.addUniform!==void 0}}const kI="gpuUpdateParticlesPixelShader",GI=`#version 300 es
void main() {
discard;
}
`;Y.ShadersStore[kI]=GI;const zI="gpuUpdateParticlesVertexShader",WI=`#version 300 es
#define PI 3.14159
uniform float currentCount;
uniform float timeDelta;
uniform float stopFactor;
#ifndef LOCAL
uniform mat4 emitterWM;
#endif
uniform vec2 lifeTime;
uniform vec2 emitPower;
uniform vec2 sizeRange;
uniform vec4 scaleRange;
#ifndef COLORGRADIENTS
uniform vec4 color1;
uniform vec4 color2;
#endif
uniform vec3 gravity;
uniform sampler2D randomSampler;
uniform sampler2D randomSampler2;
uniform vec4 angleRange;
#ifdef BOXEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
uniform vec3 minEmitBox;
uniform vec3 maxEmitBox;
#endif
#ifdef POINTEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#endif
#ifdef HEMISPHERICEMITTER
uniform float radius;
uniform float radiusRange;
uniform float directionRandomizer;
#endif
#ifdef SPHEREEMITTER
uniform float radius;
uniform float radiusRange;
#ifdef DIRECTEDSPHEREEMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CYLINDEREMITTER
uniform float radius;
uniform float height;
uniform float radiusRange;
#ifdef DIRECTEDCYLINDEREMITTER
uniform vec3 direction1;
uniform vec3 direction2;
#else
uniform float directionRandomizer;
#endif
#endif
#ifdef CONEEMITTER
uniform vec2 radius;
uniform float coneAngle;
uniform vec2 height;
uniform float directionRandomizer;
#endif
in vec3 position;
#ifdef CUSTOMEMITTER
in vec3 initialPosition;
#endif
in float age;
in float life;
in vec4 seed;
in vec3 size;
#ifndef COLORGRADIENTS
in vec4 color;
#endif
in vec3 direction;
#ifndef BILLBOARD
in vec3 initialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
in float angle;
#else
in vec2 angle;
#endif
#ifdef ANIMATESHEET
in float cellIndex;
#ifdef ANIMATESHEETRANDOMSTART
in float cellStartOffset;
#endif
#endif
#ifdef NOISE
in vec3 noiseCoordinates1;
in vec3 noiseCoordinates2;
#endif
out vec3 outPosition;
#ifdef CUSTOMEMITTER
out vec3 outInitialPosition;
#endif
out float outAge;
out float outLife;
out vec4 outSeed;
out vec3 outSize;
#ifndef COLORGRADIENTS
out vec4 outColor;
#endif
out vec3 outDirection;
#ifndef BILLBOARD
out vec3 outInitialDirection;
#endif
#ifdef ANGULARSPEEDGRADIENTS
out float outAngle;
#else
out vec2 outAngle;
#endif
#ifdef ANIMATESHEET
out float outCellIndex;
#ifdef ANIMATESHEETRANDOMSTART
out float outCellStartOffset;
#endif
#endif
#ifdef NOISE
out vec3 outNoiseCoordinates1;
out vec3 outNoiseCoordinates2;
#endif
#ifdef SIZEGRADIENTS
uniform sampler2D sizeGradientSampler;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
uniform sampler2D angularSpeedGradientSampler;
#endif 
#ifdef VELOCITYGRADIENTS
uniform sampler2D velocityGradientSampler;
#endif
#ifdef LIMITVELOCITYGRADIENTS
uniform sampler2D limitVelocityGradientSampler;
uniform float limitVelocityDamping;
#endif
#ifdef DRAGGRADIENTS
uniform sampler2D dragGradientSampler;
#endif
#ifdef NOISE
uniform vec3 noiseStrength;
uniform sampler2D noiseSampler;
#endif
#ifdef ANIMATESHEET
uniform vec4 cellInfos;
#endif
vec3 getRandomVec3(float offset) {
return texture(randomSampler2,vec2(float(gl_VertexID)*offset/currentCount,0)).rgb;
}
vec4 getRandomVec4(float offset) {
return texture(randomSampler,vec2(float(gl_VertexID)*offset/currentCount,0));
}
void main() {
float newAge=age+timeDelta; 
if (newAge>=life && stopFactor != 0.) {
vec3 newPosition;
vec3 newDirection;
vec4 randoms=getRandomVec4(seed.x);
outLife=lifeTime.x+(lifeTime.y-lifeTime.x)*randoms.r;
outAge=newAge-life;
outSeed=seed;
#ifdef SIZEGRADIENTS 
outSize.x=texture(sizeGradientSampler,vec2(0,0)).r;
#else
outSize.x=sizeRange.x+(sizeRange.y-sizeRange.x)*randoms.g;
#endif
outSize.y=scaleRange.x+(scaleRange.y-scaleRange.x)*randoms.b;
outSize.z=scaleRange.z+(scaleRange.w-scaleRange.z)*randoms.a; 
#ifndef COLORGRADIENTS
outColor=color1+(color2-color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
outAngle.y=angleRange.x+(angleRange.y-angleRange.x)*randoms.a;
outAngle.x=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#else
outAngle=angleRange.z+(angleRange.w-angleRange.z)*randoms.r;
#endif 
#ifdef POINTEMITTER
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=vec3(0,0,0);
newDirection=direction1+(direction2-direction1)*randoms3;
#elif defined(BOXEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
newPosition=minEmitBox+(maxEmitBox-minEmitBox)*randoms2;
newDirection=direction1+(direction2-direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,abs(randY),randZ);
newDirection=newPosition+directionRandomizer*randoms3; 
#elif defined(SPHEREEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
float phi=2.0*PI*randoms2.x;
float theta=acos(2.0*randoms2.y-1.0);
float randX=cos(phi)*sin(theta);
float randY=cos(theta);
float randZ=sin(phi)*sin(theta);
newPosition=(radius-(radius*radiusRange*randoms2.z))*vec3(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(direction1+(direction2-direction1)*randoms3);
#else
newDirection=normalize(newPosition+directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
vec3 randoms2=getRandomVec3(seed.y);
vec3 randoms3=getRandomVec3(seed.z);
float yPos=(randoms2.x-0.5)*height;
float angle=randoms2.y*PI*2.;
float inverseRadiusRangeSquared=((1.-radiusRange)*(1.-radiusRange));
float positionRadius=radius*sqrt(inverseRadiusRangeSquared+(randoms2.z*(1.-inverseRadiusRangeSquared)));
float xPos=positionRadius*cos(angle);
float zPos=positionRadius*sin(angle);
newPosition=vec3(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=direction1+(direction2-direction1)*randoms3;
#else
angle=angle+((randoms3.x-0.5)*PI)*directionRandomizer;
newDirection=vec3(cos(angle),(randoms3.y-0.5)*directionRandomizer,sin(angle));
newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
vec3 randoms2=getRandomVec3(seed.y);
float s=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
float h=0.0001;
#else
float h=randoms2.y*height.y;
h=1.-h*h; 
#endif
float lRadius=radius.x-radius.x*randoms2.z*radius.y;
lRadius=lRadius*h;
float randX=lRadius*sin(s);
float randZ=lRadius*cos(s);
float randY=h *height.x;
newPosition=vec3(randX,randY,randZ); 
if (abs(cos(coneAngle))==1.0) {
newDirection=vec3(0.,1.0,0.);
} else {
vec3 randoms3=getRandomVec3(seed.z);
newDirection=normalize(newPosition+directionRandomizer*randoms3); 
}
#elif defined(CUSTOMEMITTER)
newPosition=initialPosition;
outInitialPosition=initialPosition;
#else 
newPosition=vec3(0.,0.,0.);
newDirection=2.0*(getRandomVec3(seed.w)-vec3(0.5,0.5,0.5));
#endif
float power=emitPower.x+(emitPower.y-emitPower.x)*randoms.a;
#ifdef LOCAL
outPosition=newPosition;
#else
outPosition=(emitterWM*vec4(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#ifndef BILLBOARD 
outInitialDirection=direction;
#endif
#else
#ifdef LOCAL
vec3 initial=newDirection;
#else 
vec3 initial=(emitterWM*vec4(newDirection,0.)).xyz;
#endif
outDirection=initial*power;
#ifndef BILLBOARD 
outInitialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
outCellIndex=cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif
} else {
float directionScale=timeDelta;
outAge=newAge;
float ageGradient=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale*=texture(velocityGradientSampler,vec2(ageGradient,0)).r;
#endif
#ifdef DRAGGRADIENTS
directionScale*=1.0-texture(dragGradientSampler,vec2(ageGradient,0)).r;
#endif
#if defined(CUSTOMEMITTER)
outPosition=position+(direction-position)*ageGradient; 
outInitialPosition=initialPosition;
#else
outPosition=position+direction*directionScale;
#endif
outLife=life;
outSeed=seed;
#ifndef COLORGRADIENTS 
outColor=color;
#endif
#ifdef SIZEGRADIENTS
outSize.x=texture(sizeGradientSampler,vec2(ageGradient,0)).r;
outSize.yz=size.yz;
#else
outSize=size;
#endif 
#ifndef BILLBOARD 
outInitialDirection=initialDirection;
#endif
#ifdef CUSTOMEMITTER
outDirection=direction;
#else
vec3 updatedDirection=direction+gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
float limitVelocity=texture(limitVelocityGradientSampler,vec2(ageGradient,0)).r;
float currentVelocity=length(updatedDirection);
if (currentVelocity>limitVelocity) {
updatedDirection=updatedDirection*limitVelocityDamping;
}
#endif
outDirection=updatedDirection;
#ifdef NOISE
float fetchedR=texture(noiseSampler,vec2(noiseCoordinates1.x,noiseCoordinates1.y)*vec2(0.5)+vec2(0.5)).r;
float fetchedG=texture(noiseSampler,vec2(noiseCoordinates1.z,noiseCoordinates2.x)*vec2(0.5)+vec2(0.5)).r;
float fetchedB=texture(noiseSampler,vec2(noiseCoordinates2.y,noiseCoordinates2.z)*vec2(0.5)+vec2(0.5)).r;
vec3 force=vec3(2.*fetchedR-1.,2.*fetchedG-1.,2.*fetchedB-1.)*noiseStrength;
outDirection=outDirection+force*timeDelta;
outNoiseCoordinates1=noiseCoordinates1;
outNoiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
float angularSpeed=texture(angularSpeedGradientSampler,vec2(ageGradient,0)).r;
outAngle=angle+angularSpeed*timeDelta;
#else
outAngle=vec2(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
float offsetAge=outAge;
float dist=cellInfos.y-cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
outCellStartOffset=cellStartOffset;
offsetAge+=cellStartOffset;
#else
float cellStartOffset=0.;
#endif 
float ratio=0.;
if (cellInfos.w==1.0) {
ratio=clamp(mod(cellStartOffset+cellInfos.z*offsetAge,life)/life,0.,1.0);
}
else {
ratio=clamp(cellStartOffset+cellInfos.z*offsetAge/life,0.,1.0);
}
outCellIndex=float(int(cellInfos.x+ratio*dist));
#endif
}
}`;Y.ShadersStore[zI]=WI;class HI{constructor(e,t){this._renderVAO=[],this._updateVAO=[],this.alignDataInBuffer=!1,this._parent=e,this._engine=t,this._updateEffectOptions={attributes:["position","initialPosition","age","life","seed","size","color","direction","initialDirection","angle","cellIndex","cellStartOffset","noiseCoordinates1","noiseCoordinates2"],uniformsNames:["currentCount","timeDelta","emitterWM","lifeTime","color1","color2","sizeRange","scaleRange","gravity","emitPower","direction1","direction2","minEmitBox","maxEmitBox","radius","directionRandomizer","height","coneAngle","stopFactor","angleRange","radiusRange","cellInfos","noiseStrength","limitVelocityDamping"],uniformBuffersNames:[],samplers:["randomSampler","randomSampler2","sizeGradientSampler","angularSpeedGradientSampler","velocityGradientSampler","limitVelocityGradientSampler","noiseSampler","dragGradientSampler"],defines:"",fallbacks:null,onCompiled:null,onError:null,indexParameters:null,maxSimultaneousLights:0,transformFeedbackVaryings:[]}}isUpdateBufferCreated(){return!!this._updateEffect}isUpdateBufferReady(){var e,t;return(t=(e=this._updateEffect)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}createUpdateBuffer(e){return this._updateEffectOptions.transformFeedbackVaryings=["outPosition"],this._updateEffectOptions.transformFeedbackVaryings.push("outAge"),this._updateEffectOptions.transformFeedbackVaryings.push("outSize"),this._updateEffectOptions.transformFeedbackVaryings.push("outLife"),this._updateEffectOptions.transformFeedbackVaryings.push("outSeed"),this._updateEffectOptions.transformFeedbackVaryings.push("outDirection"),this._parent.particleEmitterType instanceof Ma&&this._updateEffectOptions.transformFeedbackVaryings.push("outInitialPosition"),this._parent._colorGradientsTexture||this._updateEffectOptions.transformFeedbackVaryings.push("outColor"),this._parent._isBillboardBased||this._updateEffectOptions.transformFeedbackVaryings.push("outInitialDirection"),this._parent.noiseTexture&&(this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates1"),this._updateEffectOptions.transformFeedbackVaryings.push("outNoiseCoordinates2")),this._updateEffectOptions.transformFeedbackVaryings.push("outAngle"),this._parent.isAnimationSheetEnabled&&(this._updateEffectOptions.transformFeedbackVaryings.push("outCellIndex"),this._parent.spriteRandomStartCell&&this._updateEffectOptions.transformFeedbackVaryings.push("outCellStartOffset")),this._updateEffectOptions.defines=e,this._updateEffect=new Rt("gpuUpdateParticles",this._updateEffectOptions,this._engine),new Vm(this._updateEffect)}createVertexBuffers(e,t){this._updateVAO.push(this._createUpdateVAO(e)),this._renderVAO.push(this._engine.recordVertexArrayObject(t,null,this._parent._getWrapper(this._parent.blendMode).effect)),this._engine.bindArrayBuffer(null)}createParticleBuffer(e){return e}bindDrawBuffers(e){this._engine.bindVertexArrayObject(this._renderVAO[e],null)}preUpdateParticleBuffer(){const e=this._engine;if(this._engine.enableEffect(this._updateEffect),!e.setState)throw new Error("GPU particles cannot work without a full Engine. ThinEngine is not supported")}updateParticleBuffer(e,t,i){this._updateEffect.setTexture("randomSampler",this._parent._randomTexture),this._updateEffect.setTexture("randomSampler2",this._parent._randomTexture2),this._parent._sizeGradientsTexture&&this._updateEffect.setTexture("sizeGradientSampler",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateEffect.setTexture("angularSpeedGradientSampler",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateEffect.setTexture("velocityGradientSampler",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateEffect.setTexture("limitVelocityGradientSampler",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateEffect.setTexture("dragGradientSampler",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateEffect.setTexture("noiseSampler",this._parent.noiseTexture),this._engine.bindVertexArrayObject(this._updateVAO[e],null);const s=this._engine;s.bindTransformFeedbackBuffer(t.getBuffer()),s.setRasterizerState(!1),s.beginTransformFeedback(!0),s.drawArraysType(3,0,i),s.endTransformFeedback(),s.setRasterizerState(!0),s.bindTransformFeedbackBuffer(null)}releaseBuffers(){}releaseVertexBuffers(){for(let e=0;e<this._updateVAO.length;e++)this._engine.releaseVertexArrayObject(this._updateVAO[e]);this._updateVAO.length=0;for(let e=0;e<this._renderVAO.length;e++)this._engine.releaseVertexArrayObject(this._renderVAO[e]);this._renderVAO.length=0}_createUpdateVAO(e){const t={};t.position=e.createVertexBuffer("position",0,3);let i=3;t.age=e.createVertexBuffer("age",i,1),i+=1,t.size=e.createVertexBuffer("size",i,3),i+=3,t.life=e.createVertexBuffer("life",i,1),i+=1,t.seed=e.createVertexBuffer("seed",i,4),i+=4,t.direction=e.createVertexBuffer("direction",i,3),i+=3,this._parent.particleEmitterType instanceof Ma&&(t.initialPosition=e.createVertexBuffer("initialPosition",i,3),i+=3),this._parent._colorGradientsTexture||(t.color=e.createVertexBuffer("color",i,4),i+=4),this._parent._isBillboardBased||(t.initialDirection=e.createVertexBuffer("initialDirection",i,3),i+=3),this._parent.noiseTexture&&(t.noiseCoordinates1=e.createVertexBuffer("noiseCoordinates1",i,3),i+=3,t.noiseCoordinates2=e.createVertexBuffer("noiseCoordinates2",i,3),i+=3),this._parent._angularSpeedGradientsTexture?(t.angle=e.createVertexBuffer("angle",i,1),i+=1):(t.angle=e.createVertexBuffer("angle",i,2),i+=2),this._parent._isAnimationSheetEnabled&&(t.cellIndex=e.createVertexBuffer("cellIndex",i,1),i+=1,this._parent.spriteRandomStartCell&&(t.cellStartOffset=e.createVertexBuffer("cellStartOffset",i,1),i+=1));const s=this._engine.recordVertexArrayObject(t,null,this._updateEffect);return this._engine.bindArrayBuffer(null),s}}he("BABYLON.WebGL2ParticleSystem",HI);const XI="gpuUpdateParticlesComputeShader",YI=`struct Particle {
position : vec3<f32>,
age : f32,
size : vec3<f32>,
life : f32,
seed : vec4<f32>,
direction : vec3<f32>,
dummy0: f32,
#ifdef CUSTOMEMITTER
initialPosition : vec3<f32>,
dummy1: f32,
#endif
#ifndef COLORGRADIENTS
color : vec4<f32>,
#endif
#ifndef BILLBOARD
initialDirection : vec3<f32>,
dummy2: f32,
#endif
#ifdef NOISE
noiseCoordinates1 : vec3<f32>,
dummy3: f32,
noiseCoordinates2 : vec3<f32>,
dummy4: f32,
#endif
#ifdef ANGULARSPEEDGRADIENTS
angle : f32,
#else
angle : vec2<f32>,
#endif
#ifdef ANIMATESHEET
cellIndex : f32,
#ifdef ANIMATESHEETRANDOMSTART
cellStartOffset : f32,
#endif
#endif
};
struct Particles {
particles : array<Particle>,
};
struct SimParams {
currentCount : f32,
timeDelta : f32,
stopFactor : f32,
randomTextureSize: i32,
lifeTime : vec2<f32>,
emitPower : vec2<f32>,
#ifndef COLORGRADIENTS
color1 : vec4<f32>,
color2 : vec4<f32>,
#endif
sizeRange : vec2<f32>,
scaleRange : vec4<f32>,
angleRange : vec4<f32>,
gravity : vec3<f32>,
#ifdef LIMITVELOCITYGRADIENTS
limitVelocityDamping : f32,
#endif
#ifdef ANIMATESHEET
cellInfos : vec4<f32>,
#endif
#ifdef NOISE
noiseStrength : vec3<f32>,
#endif
#ifndef LOCAL
emitterWM : mat4x4<f32>,
#endif
#ifdef BOXEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
minEmitBox : vec3<f32>,
maxEmitBox : vec3<f32>,
#endif
#ifdef CONEEMITTER
radius : vec2<f32>,
coneAngle : f32,
height : vec2<f32>,
directionRandomizer : f32,
#endif
#ifdef CYLINDEREMITTER
radius : f32,
height : f32,
radiusRange : f32,
#ifdef DIRECTEDCYLINDEREMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
#ifdef HEMISPHERICEMITTER
radius : f32,
radiusRange : f32,
directionRandomizer : f32,
#endif
#ifdef POINTEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#endif
#ifdef SPHEREEMITTER
radius : f32,
radiusRange : f32,
#ifdef DIRECTEDSPHEREEMITTER
direction1 : vec3<f32>,
direction2 : vec3<f32>,
#else
directionRandomizer : f32,
#endif
#endif
};
@binding(0) @group(0) var<uniform> params : SimParams;
@binding(1) @group(0) var<storage,read> particlesIn : Particles;
@binding(2) @group(0) var<storage,read_write> particlesOut : Particles;
@binding(3) @group(0) var randomTexture : texture_2d<f32>;
@binding(4) @group(0) var randomTexture2 : texture_2d<f32>;
#ifdef SIZEGRADIENTS
@binding(0) @group(1) var sizeGradientSampler : sampler;
@binding(1) @group(1) var sizeGradientTexture : texture_2d<f32>;
#endif 
#ifdef ANGULARSPEEDGRADIENTS
@binding(2) @group(1) var angularSpeedGradientSampler : sampler;
@binding(3) @group(1) var angularSpeedGradientTexture : texture_2d<f32>;
#endif 
#ifdef VELOCITYGRADIENTS
@binding(4) @group(1) var velocityGradientSampler : sampler;
@binding(5) @group(1) var velocityGradientTexture : texture_2d<f32>;
#endif
#ifdef LIMITVELOCITYGRADIENTS
@binding(6) @group(1) var limitVelocityGradientSampler : sampler;
@binding(7) @group(1) var limitVelocityGradientTexture : texture_2d<f32>;
#endif
#ifdef DRAGGRADIENTS
@binding(8) @group(1) var dragGradientSampler : sampler;
@binding(9) @group(1) var dragGradientTexture : texture_2d<f32>;
#endif
#ifdef NOISE
@binding(10) @group(1) var noiseSampler : sampler;
@binding(11) @group(1) var noiseTexture : texture_2d<f32>;
#endif
fn getRandomVec3(offset : f32,vertexID : f32)->vec3<f32> {
return textureLoad(randomTexture2,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0).rgb;
}
fn getRandomVec4(offset : f32,vertexID : f32)->vec4<f32> {
return textureLoad(randomTexture,vec2<i32>(i32(vertexID*offset/params.currentCount*f32(params.randomTextureSize)) % params.randomTextureSize,0),0);
}
@stage(compute) @workgroup_size(64)
fn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {
let index : u32=GlobalInvocationID.x;
let vertexID : f32=f32(index);
if (index>=u32(params.currentCount)) {
return;
}
let PI : f32=3.14159;
let timeDelta : f32=params.timeDelta;
let newAge : f32=particlesIn.particles[index].age+timeDelta;
let life : f32=particlesIn.particles[index].life;
let seed : vec4<f32>=particlesIn.particles[index].seed;
let direction : vec3<f32>=particlesIn.particles[index].direction;
if (newAge>=life && params.stopFactor != 0.) {
var newPosition : vec3<f32>;
var newDirection : vec3<f32>;
let randoms : vec4<f32>=getRandomVec4(seed.x,vertexID);
let outLife : f32=params.lifeTime.x+(params.lifeTime.y-params.lifeTime.x)*randoms.r;
particlesOut.particles[index].life=outLife;
particlesOut.particles[index].age=newAge-life;
particlesOut.particles[index].seed=seed;
var sizex : f32;
#ifdef SIZEGRADIENTS 
sizex=textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(0.,0.),0.).r;
#else
sizex=params.sizeRange.x+(params.sizeRange.y-params.sizeRange.x)*randoms.g;
#endif
particlesOut.particles[index].size=vec3<f32>(
sizex,
params.scaleRange.x+(params.scaleRange.y-params.scaleRange.x)*randoms.b,
params.scaleRange.z+(params.scaleRange.w-params.scaleRange.z)*randoms.a);
#ifndef COLORGRADIENTS
particlesOut.particles[index].color=params.color1+(params.color2-params.color1)*randoms.b;
#endif
#ifndef ANGULARSPEEDGRADIENTS 
particlesOut.particles[index].angle=vec2<f32>(
params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r,
params.angleRange.x+(params.angleRange.y-params.angleRange.x)*randoms.a);
#else
particlesOut.particles[index].angle=params.angleRange.z+(params.angleRange.w-params.angleRange.z)*randoms.r;
#endif 
#if defined(POINTEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
newPosition=vec3<f32>(0.,0.,0.);
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#elif defined(BOXEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
newPosition=params.minEmitBox+(params.maxEmitBox-params.minEmitBox)*randoms2;
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3; 
#elif defined(HEMISPHERICEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
let phi : f32=2.0*PI*randoms2.x;
let theta : f32=acos(-1.0+2.0*randoms2.y);
let randX : f32=cos(phi)*sin(theta);
let randY : f32=cos(theta);
let randZ : f32=sin(phi)*sin(theta);
newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,abs(randY),randZ);
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#elif defined(SPHEREEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
let phi : f32=2.0*PI*randoms2.x;
let theta : f32=acos(-1.0+2.0*randoms2.y);
let randX : f32=cos(phi)*sin(theta);
let randY : f32=cos(theta);
let randZ : f32=sin(phi)*sin(theta);
newPosition=(params.radius-(params.radius*params.radiusRange*randoms2.z))*vec3<f32>(randX,randY,randZ);
#ifdef DIRECTEDSPHEREEMITTER
newDirection=normalize(params.direction1+(params.direction2-params.direction1)*randoms3);
#else
newDirection=normalize(newPosition+params.directionRandomizer*randoms3);
#endif
#elif defined(CYLINDEREMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
let yPos : f32=(-0.5+randoms2.x)*params.height;
var angle : f32=randoms2.y*PI*2.;
let inverseRadiusRangeSquared : f32=(1.-params.radiusRange)*(1.-params.radiusRange);
let positionRadius : f32=params.radius*sqrt(inverseRadiusRangeSquared+randoms2.z*(1.-inverseRadiusRangeSquared));
let xPos : f32=positionRadius*cos(angle);
let zPos : f32=positionRadius*sin(angle);
newPosition=vec3<f32>(xPos,yPos,zPos);
#ifdef DIRECTEDCYLINDEREMITTER
newDirection=params.direction1+(params.direction2-params.direction1)*randoms3;
#else
angle=angle+(-0.5+randoms3.x)*PI*params.directionRandomizer;
newDirection=vec3<f32>(cos(angle),(-0.5+randoms3.y)*params.directionRandomizer,sin(angle));
newDirection=normalize(newDirection);
#endif
#elif defined(CONEEMITTER)
let randoms2 : vec3<f32>=getRandomVec3(seed.y,vertexID);
let s : f32=2.0*PI*randoms2.x;
#ifdef CONEEMITTERSPAWNPOINT
let h : f32=0.0001;
#else
var h : f32=randoms2.y*params.height.y;
h=1.-h*h; 
#endif
var lRadius : f32=params.radius.x-params.radius.x*randoms2.z*params.radius.y;
lRadius=lRadius*h;
let randX : f32=lRadius*sin(s);
let randZ : f32=lRadius*cos(s);
let randY : f32=h *params.height.x;
newPosition=vec3<f32>(randX,randY,randZ); 
if (abs(cos(params.coneAngle))==1.0) {
newDirection=vec3<f32>(0.,1.0,0.);
} else {
let randoms3 : vec3<f32>=getRandomVec3(seed.z,vertexID);
newDirection=normalize(newPosition+params.directionRandomizer*randoms3); 
}
#elif defined(CUSTOMEMITTER)
newPosition=particlesIn.particles[index].initialPosition;
particlesOut.particles[index].initialPosition=newPosition;
#else 
newPosition=vec3<f32>(0.,0.,0.);
newDirection=2.0*(getRandomVec3(seed.w,vertexID)-vec3<f32>(0.5,0.5,0.5));
#endif
let power : f32=params.emitPower.x+(params.emitPower.y-params.emitPower.x)*randoms.a;
#ifdef LOCAL
particlesOut.particles[index].position=newPosition;
#else
particlesOut.particles[index].position=(params.emitterWM*vec4<f32>(newPosition,1.)).xyz;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=direction;
#endif
#else
#ifdef LOCAL
let initial : vec3<f32>=newDirection;
#else 
let initial : vec3<f32>=(params.emitterWM*vec4<f32>(newDirection,0.)).xyz;
#endif
particlesOut.particles[index].direction=initial*power;
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=initial;
#endif
#endif
#ifdef ANIMATESHEET 
particlesOut.particles[index].cellIndex=params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
particlesOut.particles[index].cellStartOffset=randoms.a*outLife;
#endif 
#endif
#ifdef NOISE
particlesOut.particles[index].noiseCoordinates1=particlesIn.particles[index].noiseCoordinates1;
particlesOut.particles[index].noiseCoordinates2=particlesIn.particles[index].noiseCoordinates2;
#endif
} else {
var directionScale : f32=timeDelta;
particlesOut.particles[index].age=newAge;
let ageGradient : f32=newAge/life;
#ifdef VELOCITYGRADIENTS
directionScale=directionScale*textureSampleLevel(velocityGradientTexture,velocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
#endif
#ifdef DRAGGRADIENTS
directionScale=directionScale*(1.0-textureSampleLevel(dragGradientTexture,dragGradientSampler,vec2<f32>(ageGradient,0.),0.).r);
#endif
let position : vec3<f32>=particlesIn.particles[index].position;
#if defined(CUSTOMEMITTER)
particlesOut.particles[index].position=position+(direction-position)*ageGradient; 
particlesOut.particles[index].initialPosition=particlesIn.particles[index].initialPosition;
#else
particlesOut.particles[index].position=position+direction*directionScale;
#endif
particlesOut.particles[index].life=life;
particlesOut.particles[index].seed=seed;
#ifndef COLORGRADIENTS 
particlesOut.particles[index].color=particlesIn.particles[index].color;
#endif
#ifdef SIZEGRADIENTS
particlesOut.particles[index].size=vec3<f32>(
textureSampleLevel(sizeGradientTexture,sizeGradientSampler,vec2<f32>(ageGradient,0.),0.).r,
particlesIn.particles[index].size.yz);
#else
particlesOut.particles[index].size=particlesIn.particles[index].size;
#endif 
#ifndef BILLBOARD 
particlesOut.particles[index].initialDirection=particlesIn.particles[index].initialDirection;
#endif
#ifdef CUSTOMEMITTER
particlesOut.particles[index].direction=direction;
#else
var updatedDirection : vec3<f32>=direction+params.gravity*timeDelta;
#ifdef LIMITVELOCITYGRADIENTS
let limitVelocity : f32=textureSampleLevel(limitVelocityGradientTexture,limitVelocityGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
let currentVelocity : f32=length(updatedDirection);
if (currentVelocity>limitVelocity) {
updatedDirection=updatedDirection*params.limitVelocityDamping;
}
#endif
particlesOut.particles[index].direction=updatedDirection;
#ifdef NOISE
let noiseCoordinates1 : vec3<f32>=particlesIn.particles[index].noiseCoordinates1;
let noiseCoordinates2 : vec3<f32>=particlesIn.particles[index].noiseCoordinates2;
let fetchedR : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.x,noiseCoordinates1.y)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;
let fetchedG : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates1.z,noiseCoordinates2.x)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;
let fetchedB : f32=textureSampleLevel(noiseTexture,noiseSampler,vec2<f32>(noiseCoordinates2.y,noiseCoordinates2.z)*vec2<f32>(0.5,0.5)+vec2<f32>(0.5,0.5),0.).r;
let force : vec3<f32>=vec3<f32>(-1.+2.*fetchedR,-1.+2.*fetchedG,-1.+2.*fetchedB)*params.noiseStrength;
particlesOut.particles[index].direction=particlesOut.particles[index].direction+force*timeDelta;
particlesOut.particles[index].noiseCoordinates1=noiseCoordinates1;
particlesOut.particles[index].noiseCoordinates2=noiseCoordinates2;
#endif 
#endif 
#ifdef ANGULARSPEEDGRADIENTS
let angularSpeed : f32=textureSampleLevel(angularSpeedGradientTexture,angularSpeedGradientSampler,vec2<f32>(ageGradient,0.),0.).r;
particlesOut.particles[index].angle=particlesIn.particles[index].angle+angularSpeed*timeDelta;
#else
let angle : vec2<f32>=particlesIn.particles[index].angle;
particlesOut.particles[index].angle=vec2<f32>(angle.x+angle.y*timeDelta,angle.y);
#endif
#ifdef ANIMATESHEET 
var offsetAge : f32=particlesOut.particles[index].age;
let dist : f32=params.cellInfos.y-params.cellInfos.x;
#ifdef ANIMATESHEETRANDOMSTART
let cellStartOffset : f32=particlesIn.particles[index].cellStartOffset;
particlesOut.particles[index].cellStartOffset=cellStartOffset;
offsetAge=offsetAge+cellStartOffset;
#else
let cellStartOffset : f32=0.;
#endif 
var ratio : f32;
if (params.cellInfos.w==1.0) {
ratio=clamp(((cellStartOffset+params.cellInfos.z*offsetAge) % life)/life,0.,1.0);
}
else {
ratio=clamp((cellStartOffset+params.cellInfos.z*offsetAge)/life,0.,1.0);
}
particlesOut.particles[index].cellIndex=f32(i32(params.cellInfos.x+ratio*dist));
#endif
}
}
`;Y.ShadersStoreWGSL[XI]=YI;class KI{constructor(e,t){this._bufferComputeShader=[],this._renderVertexBuffers=[],this.alignDataInBuffer=!0,this._parent=e,this._engine=t}isUpdateBufferCreated(){return!!this._updateComputeShader}isUpdateBufferReady(){var e,t;return(t=(e=this._updateComputeShader)===null||e===void 0?void 0:e.isReady())!==null&&t!==void 0?t:!1}createUpdateBuffer(e){var t;const i={params:{group:0,binding:0},particlesIn:{group:0,binding:1},particlesOut:{group:0,binding:2},randomTexture:{group:0,binding:3},randomTexture2:{group:0,binding:4}};return this._parent._sizeGradientsTexture&&(i.sizeGradientTexture={group:1,binding:1}),this._parent._angularSpeedGradientsTexture&&(i.angularSpeedGradientTexture={group:1,binding:3}),this._parent._velocityGradientsTexture&&(i.velocityGradientTexture={group:1,binding:5}),this._parent._limitVelocityGradientsTexture&&(i.limitVelocityGradientTexture={group:1,binding:7}),this._parent._dragGradientsTexture&&(i.dragGradientTexture={group:1,binding:9}),this._parent.noiseTexture&&(i.noiseTexture={group:1,binding:11}),this._updateComputeShader=new Zl("updateParticles",this._engine,"gpuUpdateParticles",{bindingsMapping:i,defines:e.split(`
`)}),(t=this._simParamsComputeShader)===null||t===void 0||t.dispose(),this._simParamsComputeShader=new Pe(this._engine),this._simParamsComputeShader.addUniform("currentCount",1),this._simParamsComputeShader.addUniform("timeDelta",1),this._simParamsComputeShader.addUniform("stopFactor",1),this._simParamsComputeShader.addUniform("randomTextureSize",1),this._simParamsComputeShader.addUniform("lifeTime",2),this._simParamsComputeShader.addUniform("emitPower",2),this._parent._colorGradientsTexture||(this._simParamsComputeShader.addUniform("color1",4),this._simParamsComputeShader.addUniform("color2",4)),this._simParamsComputeShader.addUniform("sizeRange",2),this._simParamsComputeShader.addUniform("scaleRange",4),this._simParamsComputeShader.addUniform("angleRange",4),this._simParamsComputeShader.addUniform("gravity",3),this._parent._limitVelocityGradientsTexture&&this._simParamsComputeShader.addUniform("limitVelocityDamping",1),this._parent.isAnimationSheetEnabled&&this._simParamsComputeShader.addUniform("cellInfos",4),this._parent.noiseTexture&&this._simParamsComputeShader.addUniform("noiseStrength",3),this._parent.isLocal||this._simParamsComputeShader.addUniform("emitterWM",16),this._parent.particleEmitterType&&this._parent.particleEmitterType.buildUniformLayout(this._simParamsComputeShader),this._updateComputeShader.setUniformBuffer("params",this._simParamsComputeShader),new Vm(this._simParamsComputeShader)}createVertexBuffers(e,t){this._renderVertexBuffers.push(t)}createParticleBuffer(e){const t=new V1(this._engine,e.length*4,11);return t.update(e),this._bufferComputeShader.push(t),t.getBuffer()}bindDrawBuffers(e,t){this._engine.bindBuffers(this._renderVertexBuffers[e],null,t)}preUpdateParticleBuffer(){}updateParticleBuffer(e,t,i){this._simParamsComputeShader.update(),this._updateComputeShader.setTexture("randomTexture",this._parent._randomTexture,!1),this._updateComputeShader.setTexture("randomTexture2",this._parent._randomTexture2,!1),this._parent._sizeGradientsTexture&&this._updateComputeShader.setTexture("sizeGradientTexture",this._parent._sizeGradientsTexture),this._parent._angularSpeedGradientsTexture&&this._updateComputeShader.setTexture("angularSpeedGradientTexture",this._parent._angularSpeedGradientsTexture),this._parent._velocityGradientsTexture&&this._updateComputeShader.setTexture("velocityGradientTexture",this._parent._velocityGradientsTexture),this._parent._limitVelocityGradientsTexture&&this._updateComputeShader.setTexture("limitVelocityGradientTexture",this._parent._limitVelocityGradientsTexture),this._parent._dragGradientsTexture&&this._updateComputeShader.setTexture("dragGradientTexture",this._parent._dragGradientsTexture),this._parent.noiseTexture&&this._updateComputeShader.setTexture("noiseTexture",this._parent.noiseTexture),this._updateComputeShader.setStorageBuffer("particlesIn",this._bufferComputeShader[e]),this._updateComputeShader.setStorageBuffer("particlesOut",this._bufferComputeShader[e^1]),this._updateComputeShader.dispatch(Math.ceil(i/64))}releaseBuffers(){var e;for(let t=0;t<this._bufferComputeShader.length;++t)this._bufferComputeShader[t].dispose();this._bufferComputeShader.length=0,(e=this._simParamsComputeShader)===null||e===void 0||e.dispose(),this._simParamsComputeShader=null,this._updateComputeShader=null}releaseVertexBuffers(){this._renderVertexBuffers.length=0}}he("BABYLON.ComputeShaderParticleSystem",KI);class km{constructor(e,t,i){this.gradient=e,this.color1=t,this.color2=i}getColorToRef(e){if(!this.color2){e.copyFrom(this.color1);return}J.LerpToRef(this.color1,this.color2,Math.random(),e)}}class $I{constructor(e,t){this.gradient=e,this.color=t}}class Gm{constructor(e,t,i){this.gradient=e,this.factor1=t,this.factor2=i}getFactor(){return this.factor2===void 0||this.factor2===this.factor1?this.factor1:this.factor1+(this.factor2-this.factor1)*Math.random()}}class Us{static GetCurrentGradient(e,t,i){if(t[0].gradient>e){i(t[0],t[0],1);return}for(let r=0;r<t.length-1;r++){const n=t[r],o=t[r+1];if(e>=n.gradient&&e<=o.gradient){const l=(e-n.gradient)/(o.gradient-n.gradient);i(n,o,l);return}}const s=t.length-1;i(t[s],t[s],1)}}class Fl{constructor(e){this.particleSystem=e,this.position=g.Zero(),this.direction=g.Zero(),this.color=new J(0,0,0,0),this.colorStep=new J(0,0,0,0),this.lifeTime=1,this.age=0,this.size=0,this.scale=new le(1,1),this.angle=0,this.angularSpeed=0,this.cellIndex=0,this._attachedSubEmitters=null,this._currentColor1=new J(0,0,0,0),this._currentColor2=new J(0,0,0,0),this._currentSize1=0,this._currentSize2=0,this._currentAngularSpeed1=0,this._currentAngularSpeed2=0,this._currentVelocity1=0,this._currentVelocity2=0,this._currentLimitVelocity1=0,this._currentLimitVelocity2=0,this._currentDrag1=0,this._currentDrag2=0,this.id=Fl._Count++,this.particleSystem.isAnimationSheetEnabled&&this._updateCellInfoFromSystem()}_updateCellInfoFromSystem(){this.cellIndex=this.particleSystem.startSpriteCellID}updateCellIndex(){let e=this.age,t=this.particleSystem.spriteCellChangeSpeed;this.particleSystem.spriteRandomStartCell&&(this._randomCellOffset===void 0&&(this._randomCellOffset=Math.random()*this.lifeTime),t===0?(t=1,e=this._randomCellOffset):e+=this._randomCellOffset);const i=this._initialEndSpriteCellID-this._initialStartSpriteCellID;let s;this._initialSpriteCellLoop?s=oe.Clamp(e*t%this.lifeTime/this.lifeTime):s=oe.Clamp(e*t/this.lifeTime),this.cellIndex=this._initialStartSpriteCellID+s*i|0}_inheritParticleInfoToSubEmitter(e){if(e.particleSystem.emitter.position){const t=e.particleSystem.emitter;if(t.position.copyFrom(this.position),e.inheritDirection){const i=G.Vector3[0];this.direction.normalizeToRef(i),t.setDirection(i,0,Math.PI/2)}}else e.particleSystem.emitter.copyFrom(this.position);this.direction.scaleToRef(e.inheritedVelocityAmount/2,G.Vector3[0]),e.particleSystem._inheritedVelocityOffset.copyFrom(G.Vector3[0])}_inheritParticleInfoToSubEmitters(){this._attachedSubEmitters&&this._attachedSubEmitters.length>0&&this._attachedSubEmitters.forEach(e=>{this._inheritParticleInfoToSubEmitter(e)})}_reset(){this.age=0,this.id=Fl._Count++,this._currentColorGradient=null,this._currentSizeGradient=null,this._currentAngularSpeedGradient=null,this._currentVelocityGradient=null,this._currentLimitVelocityGradient=null,this._currentDragGradient=null,this.cellIndex=this.particleSystem.startSpriteCellID,this._randomCellOffset=void 0}copyTo(e){e.position.copyFrom(this.position),this._initialDirection?e._initialDirection?e._initialDirection.copyFrom(this._initialDirection):e._initialDirection=this._initialDirection.clone():e._initialDirection=null,e.direction.copyFrom(this.direction),this._localPosition&&(e._localPosition?e._localPosition.copyFrom(this._localPosition):e._localPosition=this._localPosition.clone()),e.color.copyFrom(this.color),e.colorStep.copyFrom(this.colorStep),e.lifeTime=this.lifeTime,e.age=this.age,e._randomCellOffset=this._randomCellOffset,e.size=this.size,e.scale.copyFrom(this.scale),e.angle=this.angle,e.angularSpeed=this.angularSpeed,e.particleSystem=this.particleSystem,e.cellIndex=this.cellIndex,e.id=this.id,e._attachedSubEmitters=this._attachedSubEmitters,this._currentColorGradient&&(e._currentColorGradient=this._currentColorGradient,e._currentColor1.copyFrom(this._currentColor1),e._currentColor2.copyFrom(this._currentColor2)),this._currentSizeGradient&&(e._currentSizeGradient=this._currentSizeGradient,e._currentSize1=this._currentSize1,e._currentSize2=this._currentSize2),this._currentAngularSpeedGradient&&(e._currentAngularSpeedGradient=this._currentAngularSpeedGradient,e._currentAngularSpeed1=this._currentAngularSpeed1,e._currentAngularSpeed2=this._currentAngularSpeed2),this._currentVelocityGradient&&(e._currentVelocityGradient=this._currentVelocityGradient,e._currentVelocity1=this._currentVelocity1,e._currentVelocity2=this._currentVelocity2),this._currentLimitVelocityGradient&&(e._currentLimitVelocityGradient=this._currentLimitVelocityGradient,e._currentLimitVelocity1=this._currentLimitVelocity1,e._currentLimitVelocity2=this._currentLimitVelocity2),this._currentDragGradient&&(e._currentDragGradient=this._currentDragGradient,e._currentDrag1=this._currentDrag1,e._currentDrag2=this._currentDrag2),this.particleSystem.isAnimationSheetEnabled&&(e._initialStartSpriteCellID=this._initialStartSpriteCellID,e._initialEndSpriteCellID=this._initialEndSpriteCellID,e._initialSpriteCellLoop=this._initialSpriteCellLoop),this.particleSystem.useRampGradients&&(e.remapData&&this.remapData?e.remapData.copyFrom(this.remapData):e.remapData=new Ge(0,0,0,0)),this._randomNoiseCoordinates1&&(e._randomNoiseCoordinates1?(e._randomNoiseCoordinates1.copyFrom(this._randomNoiseCoordinates1),e._randomNoiseCoordinates2.copyFrom(this._randomNoiseCoordinates2)):(e._randomNoiseCoordinates1=this._randomNoiseCoordinates1.clone(),e._randomNoiseCoordinates2=this._randomNoiseCoordinates2.clone()))}}Fl._Count=0;var Ll;(function(a){a[a.ATTACHED=0]="ATTACHED",a[a.END=1]="END"})(Ll||(Ll={}));class Xn{constructor(e){if(this.particleSystem=e,this.type=Ll.END,this.inheritDirection=!1,this.inheritedVelocityAmount=0,!e.emitter||!e.emitter.dispose){const t=Si("BABYLON.AbstractMesh");e.emitter=new t("SubemitterSystemEmitter",e.getScene()),e._disposeEmitterOnDispose=!0}}clone(){let e=this.particleSystem.emitter;if(!e)e=new g;else if(e instanceof g)e=e.clone();else if(e.getClassName().indexOf("Mesh")!==-1){const i=Si("BABYLON.Mesh");e=new i("",e.getScene()),e.isVisible=!1}const t=new Xn(this.particleSystem.clone(this.particleSystem.name,e));return t.particleSystem.name+="Clone",t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem._disposeEmitterOnDispose=!0,t.particleSystem.disposeOnStop=!0,t}serialize(e=!1){const t={};return t.type=this.type,t.inheritDirection=this.inheritDirection,t.inheritedVelocityAmount=this.inheritedVelocityAmount,t.particleSystem=this.particleSystem.serialize(e),t}static _ParseParticleSystem(e,t,i,s=!1){throw Ve("ParseParticle")}static Parse(e,t,i){const s=e.particleSystem,r=new Xn(Xn._ParseParticleSystem(s,t,i,!0));return r.type=e.type,r.inheritDirection=e.inheritDirection,r.inheritedVelocityAmount=e.inheritedVelocityAmount,r.particleSystem._isSubEmitter=!0,r}dispose(){this.particleSystem.dispose()}}const jI="particlesPixelShader",qI=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
varying vec2 vUV;
varying vec4 vColor;
uniform vec4 textureMask;
uniform sampler2D diffuseSampler;
#include<clipPlaneFragmentDeclaration>
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
uniform sampler2D rampSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
vec4 textureColor=texture2D(diffuseSampler,vUV);
vec4 baseColor=(textureColor*textureMask+(vec4(1.,1.,1.,1.)-textureMask))*vColor;
#ifdef RAMPGRADIENT
float alpha=baseColor.a;
float remappedColorIndex=clamp((alpha-remapRanges.x)/remapRanges.y,0.0,1.0);
vec4 rampColor=texture2D(rampSampler,vec2(1.0-remappedColorIndex,0.));
baseColor.rgb*=rampColor.rgb;
float finalAlpha=baseColor.a;
baseColor.a=clamp((alpha*rampColor.a-remapRanges.z)/remapRanges.w,0.0,1.0);
#endif
#ifdef BLENDMULTIPLYMODE
float sourceAlpha=vColor.a*textureColor.a;
baseColor.rgb=baseColor.rgb*sourceAlpha+vec3(1.0)*(1.0-sourceAlpha);
#endif
#include<logDepthFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
baseColor.rgb=toLinearSpace(baseColor.rgb);
#else
#ifdef IMAGEPROCESSING
baseColor.rgb=toLinearSpace(baseColor.rgb);
baseColor=applyImageProcessing(baseColor);
#endif
#endif
gl_FragColor=baseColor;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[jI]=qI;const QI="particlesVertexShader",ZI=`attribute vec3 position;
attribute vec4 color;
attribute float angle;
attribute vec2 size;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
#ifndef BILLBOARD
attribute vec3 direction;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
#ifdef RAMPGRADIENT
attribute vec4 remapData;
#endif
attribute vec2 offset;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
#ifdef ANIMATESHEET
uniform vec3 particlesInfos; 
#endif
varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#ifdef RAMPGRADIENT
varying vec4 remapRanges;
#endif
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration>
#include<logDepthDeclaration>
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
return position+alignedCorner;
}
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec2 cornerPos;
cornerPos=(vec2(offset.x-0.5,offset.y -0.5)-translationPivot)*size+translationPivot;
#ifdef BILLBOARD
vec3 rotatedCorner;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=position-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=position-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner);
vec3 viewPos=(view*vec4(vPositionW,1.0)).xyz;
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 viewPos=(view*vec4(position,1.0)).xyz+rotatedCorner;
vPositionW=(invView*vec4(viewPos,1)).xyz;
#endif
#ifdef RAMPGRADIENT
remapRanges=remapData;
#endif
gl_Position=projection*vec4(viewPos,1.0);
#else
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=normalize(direction);
vPositionW=rotate(yaxis,rotatedCorner);
gl_Position=projection*view*vec4(vPositionW,1.0);
#endif
vColor=color;
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex*particlesInfos.z);
float columnOffset=cellIndex-rowOffset/particlesInfos.z;
vec2 uvScale=particlesInfos.xy;
vec2 uvOffset=vec2(offset.x ,1.0-offset.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=offset;
#endif
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[QI]=ZI;class et extends Dr{constructor(e,t,i,s=null,r=!1,n=.01){super(e),this._emitterInverseWorldMatrix=L.Identity(),this._inheritedVelocityOffset=new g,this.onDisposeObservable=new X,this.onStoppedObservable=new X,this._particles=new Array,this._stockParticles=new Array,this._newPartsExcess=0,this._vertexBuffers={},this._scaledColorStep=new J(0,0,0,0),this._colorDiff=new J(0,0,0,0),this._scaledDirection=g.Zero(),this._scaledGravity=g.Zero(),this._currentRenderId=-1,this._useInstancing=!1,this._started=!1,this._stopped=!1,this._actualFrame=0,this._currentEmitRate1=0,this._currentEmitRate2=0,this._currentStartSize1=0,this._currentStartSize2=0,this._rawTextureWidth=256,this._useRampGradients=!1,this._disposeEmitterOnDispose=!1,this.isLocal=!1,this._onBeforeDrawParticlesObservable=null,this.recycleParticle=l=>{const h=this._particles.pop();h!==l&&h.copyTo(l),this._stockParticles.push(h)},this._createParticle=()=>{let l;if(this._stockParticles.length!==0?(l=this._stockParticles.pop(),l._reset()):l=new Fl(this),this._subEmitters&&this._subEmitters.length>0){const h=this._subEmitters[Math.floor(Math.random()*this._subEmitters.length)];l._attachedSubEmitters=[],h.forEach(c=>{if(c.type===Ll.ATTACHED){const u=c.clone();l._attachedSubEmitters.push(u),u.particleSystem.start()}})}return l},this._emitFromParticle=l=>{if(!this._subEmitters||this._subEmitters.length===0)return;const h=Math.floor(Math.random()*this._subEmitters.length);this._subEmitters[h].forEach(c=>{if(c.type===Ll.END){const u=c.clone();l._inheritParticleInfoToSubEmitter(u),u.particleSystem._rootParticleSystem=this,this.activeSubSystems.push(u.particleSystem),u.particleSystem.start()}})},this._capacity=t,this._epsilon=n,this._isAnimationSheetEnabled=r,!i||i.getClassName()==="Scene"?(this._scene=i||ye.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=L.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._attachImageProcessingConfiguration(null),this._customWrappers={0:new Vi(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers=[],this._useInstancing=this._engine.getCaps().instancedArrays,this._createIndexBuffer(),this._createVertexBuffers(),this.particleEmitterType=new Pa;let o=null;this.updateFunction=l=>{var h;let c=null;this.noiseTexture&&(c=this.noiseTexture.getSize(),(h=this.noiseTexture.getContent())===null||h===void 0||h.then(u=>{o=u}));for(let u=0;u<l.length;u++){const d=l[u];let f=this._scaledUpdateSpeed;const p=d.age;if(d.age+=f,d.age>d.lifeTime){const v=d.age-p;f=(d.lifeTime-p)*f/v,d.age=d.lifeTime}const _=d.age/d.lifeTime;this._colorGradients&&this._colorGradients.length>0?Us.GetCurrentGradient(_,this._colorGradients,(v,x,b)=>{v!==d._currentColorGradient&&(d._currentColor1.copyFrom(d._currentColor2),x.getColorToRef(d._currentColor2),d._currentColorGradient=v),J.LerpToRef(d._currentColor1,d._currentColor2,b,d.color)}):(d.colorStep.scaleToRef(f,this._scaledColorStep),d.color.addInPlace(this._scaledColorStep),d.color.a<0&&(d.color.a=0)),this._angularSpeedGradients&&this._angularSpeedGradients.length>0&&Us.GetCurrentGradient(_,this._angularSpeedGradients,(v,x,b)=>{v!==d._currentAngularSpeedGradient&&(d._currentAngularSpeed1=d._currentAngularSpeed2,d._currentAngularSpeed2=x.getFactor(),d._currentAngularSpeedGradient=v),d.angularSpeed=oe.Lerp(d._currentAngularSpeed1,d._currentAngularSpeed2,b)}),d.angle+=d.angularSpeed*f;let m=f;if(this._velocityGradients&&this._velocityGradients.length>0&&Us.GetCurrentGradient(_,this._velocityGradients,(v,x,b)=>{v!==d._currentVelocityGradient&&(d._currentVelocity1=d._currentVelocity2,d._currentVelocity2=x.getFactor(),d._currentVelocityGradient=v),m*=oe.Lerp(d._currentVelocity1,d._currentVelocity2,b)}),d.direction.scaleToRef(m,this._scaledDirection),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&Us.GetCurrentGradient(_,this._limitVelocityGradients,(v,x,b)=>{v!==d._currentLimitVelocityGradient&&(d._currentLimitVelocity1=d._currentLimitVelocity2,d._currentLimitVelocity2=x.getFactor(),d._currentLimitVelocityGradient=v);const S=oe.Lerp(d._currentLimitVelocity1,d._currentLimitVelocity2,b);d.direction.length()>S&&d.direction.scaleInPlace(this.limitVelocityDamping)}),this._dragGradients&&this._dragGradients.length>0&&Us.GetCurrentGradient(_,this._dragGradients,(v,x,b)=>{v!==d._currentDragGradient&&(d._currentDrag1=d._currentDrag2,d._currentDrag2=x.getFactor(),d._currentDragGradient=v);const S=oe.Lerp(d._currentDrag1,d._currentDrag2,b);this._scaledDirection.scaleInPlace(1-S)}),this.isLocal&&d._localPosition?(d._localPosition.addInPlace(this._scaledDirection),g.TransformCoordinatesToRef(d._localPosition,this._emitterWorldMatrix,d.position)):d.position.addInPlace(this._scaledDirection),o&&c&&d._randomNoiseCoordinates1){const v=this._fetchR(d._randomNoiseCoordinates1.x,d._randomNoiseCoordinates1.y,c.width,c.height,o),x=this._fetchR(d._randomNoiseCoordinates1.z,d._randomNoiseCoordinates2.x,c.width,c.height,o),b=this._fetchR(d._randomNoiseCoordinates2.y,d._randomNoiseCoordinates2.z,c.width,c.height,o),S=G.Vector3[0],C=G.Vector3[1];S.copyFromFloats((2*v-1)*this.noiseStrength.x,(2*x-1)*this.noiseStrength.y,(2*b-1)*this.noiseStrength.z),S.scaleToRef(f,C),d.direction.addInPlace(C)}if(this.gravity.scaleToRef(f,this._scaledGravity),d.direction.addInPlace(this._scaledGravity),this._sizeGradients&&this._sizeGradients.length>0&&Us.GetCurrentGradient(_,this._sizeGradients,(v,x,b)=>{v!==d._currentSizeGradient&&(d._currentSize1=d._currentSize2,d._currentSize2=x.getFactor(),d._currentSizeGradient=v),d.size=oe.Lerp(d._currentSize1,d._currentSize2,b)}),this._useRampGradients&&(this._colorRemapGradients&&this._colorRemapGradients.length>0&&Us.GetCurrentGradient(_,this._colorRemapGradients,(v,x,b)=>{const S=oe.Lerp(v.factor1,x.factor1,b),C=oe.Lerp(v.factor2,x.factor2,b);d.remapData.x=S,d.remapData.y=C-S}),this._alphaRemapGradients&&this._alphaRemapGradients.length>0&&Us.GetCurrentGradient(_,this._alphaRemapGradients,(v,x,b)=>{const S=oe.Lerp(v.factor1,x.factor1,b),C=oe.Lerp(v.factor2,x.factor2,b);d.remapData.z=S,d.remapData.w=C-S})),this._isAnimationSheetEnabled&&d.updateCellIndex(),d._inheritParticleInfoToSubEmitters(),d.age>=d.lifeTime){this._emitFromParticle(d),d._attachedSubEmitters&&(d._attachedSubEmitters.forEach(v=>{v.particleSystem.disposeOnStop=!0,v.particleSystem.stop()}),d._attachedSubEmitters=null),this.recycleParticle(d),u--;continue}}}}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}get useRampGradients(){return this._useRampGradients}set useRampGradients(e){this._useRampGradients!==e&&(this._useRampGradients=e,this._resetEffect())}get particles(){return this._particles}getActiveCount(){return this._particles.length}getClassName(){return"ParticleSystem"}isStopping(){return this._stopped&&this.isAlive()}getCustomEffect(e=0){var t,i;return(i=(t=this._customWrappers[e])===null||t===void 0?void 0:t.effect)!==null&&i!==void 0?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return(t=this._customWrappers[e])!==null&&t!==void 0?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Vi(this._engine),this._customWrappers[t].effect=e,this._customWrappers[t].drawContext&&(this._customWrappers[t].drawContext.useInstancing=this._useInstancing)}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new X),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"particles"}get vertexBuffers(){return this._vertexBuffers}get indexBuffer(){return this._indexBuffer}_addFactorGradient(e,t,i,s){const r=new Gm(t,i,s);e.push(r),e.sort((n,o)=>n.gradient<o.gradient?-1:n.gradient>o.gradient?1:0)}_removeFactorGradient(e,t){if(!e)return;let i=0;for(const s of e){if(s.gradient===t){e.splice(i,1);break}i++}}addLifeTimeGradient(e,t,i){return this._lifeTimeGradients||(this._lifeTimeGradients=[]),this._addFactorGradient(this._lifeTimeGradients,e,t,i),this}removeLifeTimeGradient(e){return this._removeFactorGradient(this._lifeTimeGradients,e),this}addSizeGradient(e,t,i){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t,i),this}removeSizeGradient(e){return this._removeFactorGradient(this._sizeGradients,e),this}addColorRemapGradient(e,t,i){return this._colorRemapGradients||(this._colorRemapGradients=[]),this._addFactorGradient(this._colorRemapGradients,e,t,i),this}removeColorRemapGradient(e){return this._removeFactorGradient(this._colorRemapGradients,e),this}addAlphaRemapGradient(e,t,i){return this._alphaRemapGradients||(this._alphaRemapGradients=[]),this._addFactorGradient(this._alphaRemapGradients,e,t,i),this}removeAlphaRemapGradient(e){return this._removeFactorGradient(this._alphaRemapGradients,e),this}addAngularSpeedGradient(e,t,i){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t,i),this}removeAngularSpeedGradient(e){return this._removeFactorGradient(this._angularSpeedGradients,e),this}addVelocityGradient(e,t,i){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t,i),this}removeVelocityGradient(e){return this._removeFactorGradient(this._velocityGradients,e),this}addLimitVelocityGradient(e,t,i){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t,i),this}removeLimitVelocityGradient(e){return this._removeFactorGradient(this._limitVelocityGradients,e),this}addDragGradient(e,t,i){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t,i),this}removeDragGradient(e){return this._removeFactorGradient(this._dragGradients,e),this}addEmitRateGradient(e,t,i){return this._emitRateGradients||(this._emitRateGradients=[]),this._addFactorGradient(this._emitRateGradients,e,t,i),this}removeEmitRateGradient(e){return this._removeFactorGradient(this._emitRateGradients,e),this}addStartSizeGradient(e,t,i){return this._startSizeGradients||(this._startSizeGradients=[]),this._addFactorGradient(this._startSizeGradients,e,t,i),this}removeStartSizeGradient(e){return this._removeFactorGradient(this._startSizeGradients,e),this}_createRampGradientTexture(){if(!this._rampGradients||!this._rampGradients.length||this._rampGradientsTexture||!this._scene)return;const e=new Uint8Array(this._rawTextureWidth*4),t=ht.Color3[0];for(let i=0;i<this._rawTextureWidth;i++){const s=i/this._rawTextureWidth;Us.GetCurrentGradient(s,this._rampGradients,(r,n,o)=>{re.LerpToRef(r.color,n.color,o,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=255})}this._rampGradientsTexture=Ts.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}getRampGradients(){return this._rampGradients}forceRefreshGradients(){this._syncRampGradientTexture()}_syncRampGradientTexture(){!this._rampGradients||(this._rampGradients.sort((e,t)=>e.gradient<t.gradient?-1:e.gradient>t.gradient?1:0),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._createRampGradientTexture())}addRampGradient(e,t){this._rampGradients||(this._rampGradients=[]);const i=new $I(e,t);return this._rampGradients.push(i),this._syncRampGradientTexture(),this}removeRampGradient(e){return this._removeGradientAndTexture(e,this._rampGradients,this._rampGradientsTexture),this._rampGradientsTexture=null,this._rampGradients&&this._rampGradients.length>0&&this._createRampGradientTexture(),this}addColorGradient(e,t,i){this._colorGradients||(this._colorGradients=[]);const s=new km(e,t,i);return this._colorGradients.push(s),this._colorGradients.sort((r,n)=>r.gradient<n.gradient?-1:r.gradient>n.gradient?1:0),this}removeColorGradient(e){if(!this._colorGradients)return this;let t=0;for(const i of this._colorGradients){if(i.gradient===e){this._colorGradients.splice(t,1);break}t++}return this}resetDrawCache(){for(const e of this._drawWrappers)if(e)for(const t of e)t==null||t.dispose();this._drawWrappers=[]}_fetchR(e,t,i,s,r){e=Math.abs(e)*.5+.5,t=Math.abs(t)*.5+.5;const n=e*i%i|0,o=t*s%s|0,l=(n+o*i)*4;return r[l]/255}_reset(){this._resetEffect()}_resetEffect(){this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),this._createVertexBuffers()}_createVertexBuffers(){this._vertexBufferSize=this._useInstancing?10:12,this._isAnimationSheetEnabled&&(this._vertexBufferSize+=1),(!this._isBillboardBased||this.billboardMode===et.BILLBOARDMODE_STRETCHED)&&(this._vertexBufferSize+=3),this._useRampGradients&&(this._vertexBufferSize+=4);const e=this._engine,t=this._vertexBufferSize*(this._useInstancing?1:4);this._vertexData=new Float32Array(this._capacity*t),this._vertexBuffer=new Hr(e,this._vertexData,!0,t);let i=0;const s=this._vertexBuffer.createVertexBuffer(y.PositionKind,i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[y.PositionKind]=s,i+=3;const r=this._vertexBuffer.createVertexBuffer(y.ColorKind,i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers[y.ColorKind]=r,i+=4;const n=this._vertexBuffer.createVertexBuffer("angle",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.angle=n,i+=1;const o=this._vertexBuffer.createVertexBuffer("size",i,2,this._vertexBufferSize,this._useInstancing);if(this._vertexBuffers.size=o,i+=2,this._isAnimationSheetEnabled){const h=this._vertexBuffer.createVertexBuffer("cellIndex",i,1,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.cellIndex=h,i+=1}if(!this._isBillboardBased||this.billboardMode===et.BILLBOARDMODE_STRETCHED){const h=this._vertexBuffer.createVertexBuffer("direction",i,3,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.direction=h,i+=3}if(this._useRampGradients){const h=this._vertexBuffer.createVertexBuffer("remapData",i,4,this._vertexBufferSize,this._useInstancing);this._vertexBuffers.remapData=h,i+=4}let l;if(this._useInstancing){const h=new Float32Array([0,0,1,0,0,1,1,1]);this._spriteBuffer=new Hr(e,h,!1,2),l=this._spriteBuffer.createVertexBuffer("offset",0,2)}else l=this._vertexBuffer.createVertexBuffer("offset",i,2,this._vertexBufferSize,this._useInstancing),i+=2;this._vertexBuffers.offset=l,this.resetDrawCache()}_createIndexBuffer(){if(this._useInstancing)return;const e=[];let t=0;for(let i=0;i<this._capacity;i++)e.push(t),e.push(t+1),e.push(t+2),e.push(t),e.push(t+2),e.push(t+3),t+=4;this._indexBuffer=this._engine.createIndexBuffer(e)}getCapacity(){return this._capacity}isAlive(){return this._alive}isStarted(){return this._started}_prepareSubEmitterInternalArray(){this._subEmitters=new Array,this.subEmitters&&this.subEmitters.forEach(e=>{e instanceof et?this._subEmitters.push([new Xn(e)]):e instanceof Xn?this._subEmitters.push([e]):e instanceof Array&&this._subEmitters.push(e)})}start(e=this.startDelay){var t;if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}if(this._prepareSubEmitterInternalArray(),this._started=!0,this._stopped=!1,this._actualFrame=0,this._subEmitters&&this._subEmitters.length!=0&&(this.activeSubSystems=new Array),this._emitRateGradients&&(this._emitRateGradients.length>0&&(this._currentEmitRateGradient=this._emitRateGradients[0],this._currentEmitRate1=this._currentEmitRateGradient.getFactor(),this._currentEmitRate2=this._currentEmitRate1),this._emitRateGradients.length>1&&(this._currentEmitRate2=this._emitRateGradients[1].getFactor())),this._startSizeGradients&&(this._startSizeGradients.length>0&&(this._currentStartSizeGradient=this._startSizeGradients[0],this._currentStartSize1=this._currentStartSizeGradient.getFactor(),this._currentStartSize2=this._currentStartSize1),this._startSizeGradients.length>1&&(this._currentStartSize2=this._startSizeGradients[1].getFactor())),this.preWarmCycles){((t=this.emitter)===null||t===void 0?void 0:t.getClassName().indexOf("Mesh"))!==-1&&this.emitter.computeWorldMatrix(!0);const i=this.noiseTexture;if(i&&i.onGeneratedObservable)i.onGeneratedObservable.addOnce(()=>{setTimeout(()=>{for(let s=0;s<this.preWarmCycles;s++)this.animate(!0),i.render()})});else for(let s=0;s<this.preWarmCycles;s++)this.animate(!0)}this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(e=!0){this._stopped||(this.onStoppedObservable.notifyObservers(this),this._stopped=!0,e&&this._stopSubEmitters())}reset(){this._stockParticles.length=0,this._particles.length=0}_appendParticleVertex(e,t,i,s){let r=e*this._vertexBufferSize;if(this._vertexData[r++]=t.position.x+this.worldOffset.x,this._vertexData[r++]=t.position.y+this.worldOffset.y,this._vertexData[r++]=t.position.z+this.worldOffset.z,this._vertexData[r++]=t.color.r,this._vertexData[r++]=t.color.g,this._vertexData[r++]=t.color.b,this._vertexData[r++]=t.color.a,this._vertexData[r++]=t.angle,this._vertexData[r++]=t.scale.x*t.size,this._vertexData[r++]=t.scale.y*t.size,this._isAnimationSheetEnabled&&(this._vertexData[r++]=t.cellIndex),this._isBillboardBased)this.billboardMode===et.BILLBOARDMODE_STRETCHED&&(this._vertexData[r++]=t.direction.x,this._vertexData[r++]=t.direction.y,this._vertexData[r++]=t.direction.z);else if(t._initialDirection){let n=t._initialDirection;this.isLocal&&(g.TransformNormalToRef(n,this._emitterWorldMatrix,G.Vector3[0]),n=G.Vector3[0]),n.x===0&&n.z===0&&(n.x=.001),this._vertexData[r++]=n.x,this._vertexData[r++]=n.y,this._vertexData[r++]=n.z}else{let n=t.direction;this.isLocal&&(g.TransformNormalToRef(n,this._emitterWorldMatrix,G.Vector3[0]),n=G.Vector3[0]),n.x===0&&n.z===0&&(n.x=.001),this._vertexData[r++]=n.x,this._vertexData[r++]=n.y,this._vertexData[r++]=n.z}this._useRampGradients&&t.remapData&&(this._vertexData[r++]=t.remapData.x,this._vertexData[r++]=t.remapData.y,this._vertexData[r++]=t.remapData.z,this._vertexData[r++]=t.remapData.w),this._useInstancing||(this._isAnimationSheetEnabled&&(i===0?i=this._epsilon:i===1&&(i=1-this._epsilon),s===0?s=this._epsilon:s===1&&(s=1-this._epsilon)),this._vertexData[r++]=i,this._vertexData[r++]=s)}_stopSubEmitters(){!this.activeSubSystems||(this.activeSubSystems.forEach(e=>{e.stop(!0)}),this.activeSubSystems=new Array)}_removeFromRoot(){if(!this._rootParticleSystem)return;const e=this._rootParticleSystem.activeSubSystems.indexOf(this);e!==-1&&this._rootParticleSystem.activeSubSystems.splice(e,1),this._rootParticleSystem=null}_update(e){if(this._alive=this._particles.length>0,this.emitter.position){const i=this.emitter;this._emitterWorldMatrix=i.getWorldMatrix()}else{const i=this.emitter;this._emitterWorldMatrix=L.Translation(i.x,i.y,i.z)}this._emitterWorldMatrix.invertToRef(this._emitterInverseWorldMatrix),this.updateFunction(this._particles);let t;for(let i=0;i<e&&this._particles.length!==this._capacity;i++){if(t=this._createParticle(),this._particles.push(t),this.targetStopDuration&&this._lifeTimeGradients&&this._lifeTimeGradients.length>0){const r=oe.Clamp(this._actualFrame/this.targetStopDuration);Us.GetCurrentGradient(r,this._lifeTimeGradients,(n,o)=>{const l=n,h=o,c=l.getFactor(),u=h.getFactor(),d=(r-l.gradient)/(h.gradient-l.gradient);t.lifeTime=oe.Lerp(c,u,d)})}else t.lifeTime=oe.RandomRange(this.minLifeTime,this.maxLifeTime);const s=oe.RandomRange(this.minEmitPower,this.maxEmitPower);if(this.startPositionFunction?this.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal):this.particleEmitterType.startPositionFunction(this._emitterWorldMatrix,t.position,t,this.isLocal),this.isLocal&&(t._localPosition?t._localPosition.copyFrom(t.position):t._localPosition=t.position.clone(),g.TransformCoordinatesToRef(t._localPosition,this._emitterWorldMatrix,t.position)),this.startDirectionFunction?this.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal):this.particleEmitterType.startDirectionFunction(this._emitterWorldMatrix,t.direction,t,this.isLocal,this._emitterInverseWorldMatrix),s===0?t._initialDirection?t._initialDirection.copyFrom(t.direction):t._initialDirection=t.direction.clone():t._initialDirection=null,t.direction.scaleInPlace(s),!this._sizeGradients||this._sizeGradients.length===0?t.size=oe.RandomRange(this.minSize,this.maxSize):(t._currentSizeGradient=this._sizeGradients[0],t._currentSize1=t._currentSizeGradient.getFactor(),t.size=t._currentSize1,this._sizeGradients.length>1?t._currentSize2=this._sizeGradients[1].getFactor():t._currentSize2=t._currentSize1),t.scale.copyFromFloats(oe.RandomRange(this.minScaleX,this.maxScaleX),oe.RandomRange(this.minScaleY,this.maxScaleY)),this._startSizeGradients&&this._startSizeGradients[0]&&this.targetStopDuration){const r=this._actualFrame/this.targetStopDuration;Us.GetCurrentGradient(r,this._startSizeGradients,(n,o,l)=>{n!==this._currentStartSizeGradient&&(this._currentStartSize1=this._currentStartSize2,this._currentStartSize2=o.getFactor(),this._currentStartSizeGradient=n);const h=oe.Lerp(this._currentStartSize1,this._currentStartSize2,l);t.scale.scaleInPlace(h)})}if(!this._angularSpeedGradients||this._angularSpeedGradients.length===0?t.angularSpeed=oe.RandomRange(this.minAngularSpeed,this.maxAngularSpeed):(t._currentAngularSpeedGradient=this._angularSpeedGradients[0],t.angularSpeed=t._currentAngularSpeedGradient.getFactor(),t._currentAngularSpeed1=t.angularSpeed,this._angularSpeedGradients.length>1?t._currentAngularSpeed2=this._angularSpeedGradients[1].getFactor():t._currentAngularSpeed2=t._currentAngularSpeed1),t.angle=oe.RandomRange(this.minInitialRotation,this.maxInitialRotation),this._velocityGradients&&this._velocityGradients.length>0&&(t._currentVelocityGradient=this._velocityGradients[0],t._currentVelocity1=t._currentVelocityGradient.getFactor(),this._velocityGradients.length>1?t._currentVelocity2=this._velocityGradients[1].getFactor():t._currentVelocity2=t._currentVelocity1),this._limitVelocityGradients&&this._limitVelocityGradients.length>0&&(t._currentLimitVelocityGradient=this._limitVelocityGradients[0],t._currentLimitVelocity1=t._currentLimitVelocityGradient.getFactor(),this._limitVelocityGradients.length>1?t._currentLimitVelocity2=this._limitVelocityGradients[1].getFactor():t._currentLimitVelocity2=t._currentLimitVelocity1),this._dragGradients&&this._dragGradients.length>0&&(t._currentDragGradient=this._dragGradients[0],t._currentDrag1=t._currentDragGradient.getFactor(),this._dragGradients.length>1?t._currentDrag2=this._dragGradients[1].getFactor():t._currentDrag2=t._currentDrag1),!this._colorGradients||this._colorGradients.length===0){const r=oe.RandomRange(0,1);J.LerpToRef(this.color1,this.color2,r,t.color),this.colorDead.subtractToRef(t.color,this._colorDiff),this._colorDiff.scaleToRef(1/t.lifeTime,t.colorStep)}else t._currentColorGradient=this._colorGradients[0],t._currentColorGradient.getColorToRef(t.color),t._currentColor1.copyFrom(t.color),this._colorGradients.length>1?this._colorGradients[1].getColorToRef(t._currentColor2):t._currentColor2.copyFrom(t.color);this._isAnimationSheetEnabled&&(t._initialStartSpriteCellID=this.startSpriteCellID,t._initialEndSpriteCellID=this.endSpriteCellID,t._initialSpriteCellLoop=this.spriteCellLoop),t.direction.addInPlace(this._inheritedVelocityOffset),this._useRampGradients&&(t.remapData=new Ge(0,1,0,1)),this.noiseTexture&&(t._randomNoiseCoordinates1?(t._randomNoiseCoordinates1.copyFromFloats(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2.copyFromFloats(Math.random(),Math.random(),Math.random())):(t._randomNoiseCoordinates1=new g(Math.random(),Math.random(),Math.random()),t._randomNoiseCoordinates2=new g(Math.random(),Math.random(),Math.random()))),t._inheritParticleInfoToSubEmitters()}}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1){const s=[y.PositionKind,y.ColorKind,"angle","offset","size"];return e&&s.push("cellIndex"),t||s.push("direction"),i&&s.push("remapData"),s}static _GetEffectCreationOptions(e=!1,t=!1){const i=["invView","view","projection","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","textureMask","translationPivot","eyePosition"];return e&&i.push("particlesInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t){if(this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),this._isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),t===et.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this._useRampGradients&&e.push("#define RAMPGRADIENT"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case et.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case et.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case et.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(...et._GetAttributeNamesOrOptions(this._isAnimationSheetEnabled,this._isBillboardBased&&this.billboardMode!==et.BILLBOARDMODE_STRETCHED,this._useRampGradients)),e.push(...et._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","rampSampler"),this._imageProcessingConfiguration&&(qe.PrepareUniforms(e,this._imageProcessingConfigurationDefines),qe.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);const s=this._engine._features.supportRenderPasses?this._engine.currentRenderPassId:0;let r=this._drawWrappers[s];r||(r=this._drawWrappers[s]=[]);let n=r[e];n||(n=new Vi(this._engine),n.drawContext&&(n.drawContext.useInstancing=this._useInstancing),r[e]=n);const o=i.join(`
`);if(n.defines!==o){const l=[],h=[],c=[];this.fillUniformsAttributesAndSamplerNames(h,l,c),n.setEffect(this._engine.createEffect("particles",l,h,c,o),o)}return n}animate(e=!1){var t;if(!this._started)return;if(!e&&this._scene){if(!this.isReady()||this._currentRenderId===this._scene.getFrameId())return;this._currentRenderId=this._scene.getFrameId()}this._scaledUpdateSpeed=this.updateSpeed*(e?this.preWarmStepOffset:((t=this._scene)===null||t===void 0?void 0:t.getAnimationRatio())||1);let i;if(this.manualEmitCount>-1)i=this.manualEmitCount,this._newPartsExcess=0,this.manualEmitCount=0;else{let s=this.emitRate;if(this._emitRateGradients&&this._emitRateGradients.length>0&&this.targetStopDuration){const r=this._actualFrame/this.targetStopDuration;Us.GetCurrentGradient(r,this._emitRateGradients,(n,o,l)=>{n!==this._currentEmitRateGradient&&(this._currentEmitRate1=this._currentEmitRate2,this._currentEmitRate2=o.getFactor(),this._currentEmitRateGradient=n),s=oe.Lerp(this._currentEmitRate1,this._currentEmitRate2,l)})}i=s*this._scaledUpdateSpeed>>0,this._newPartsExcess+=s*this._scaledUpdateSpeed-i}if(this._newPartsExcess>1&&(i+=this._newPartsExcess>>0,this._newPartsExcess-=this._newPartsExcess>>0),this._alive=!1,this._stopped?i=0:(this._actualFrame+=this._scaledUpdateSpeed,this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()),this._update(i),this._stopped&&(this._alive||(this._started=!1,this.onAnimationEnd&&this.onAnimationEnd(),this.disposeOnStop&&this._scene&&this._scene._toBeDisposed.push(this))),!e){let s=0;for(let r=0;r<this._particles.length;r++){const n=this._particles[r];this._appendParticleVertices(s,n),s+=this._useInstancing?1:4}this._vertexBuffer&&this._vertexBuffer.updateDirectly(this._vertexData,0,this._particles.length)}this.manualEmitCount===0&&this.disposeOnStop&&this.stop()}_appendParticleVertices(e,t){this._appendParticleVertex(e++,t,0,0),this._useInstancing||(this._appendParticleVertex(e++,t,1,0),this._appendParticleVertex(e++,t,1,1),this._appendParticleVertex(e++,t,0,1))}rebuild(){var e,t;this._engine.getCaps().vertexArrayObject&&(this._vertexArrayObject=null),this._createIndexBuffer(),(e=this._spriteBuffer)===null||e===void 0||e._rebuild(),(t=this._vertexBuffer)===null||t===void 0||t._rebuild();for(const i in this._vertexBuffers)this._vertexBuffers[i]._rebuild();this.resetDrawCache()}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==et.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(et.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(et.BLENDMODE_ADD).effect.isReady())return!1;return!0}_render(e){var t,i;const s=this._getWrapper(e),r=s.effect,n=this._engine;n.enableEffect(s);const o=(t=this.defaultViewMatrix)!==null&&t!==void 0?t:this._scene.getViewMatrix();if(r.setTexture("diffuseSampler",this.particleTexture),r.setMatrix("view",o),r.setMatrix("projection",(i=this.defaultProjectionMatrix)!==null&&i!==void 0?i:this._scene.getProjectionMatrix()),this._isAnimationSheetEnabled&&this.particleTexture){const h=this.particleTexture.getBaseSize();r.setFloat3("particlesInfos",this.spriteCellWidth/h.width,this.spriteCellHeight/h.height,this.spriteCellWidth/h.width)}if(r.setVector2("translationPivot",this.translationPivot),r.setFloat4("textureMask",this.textureMask.r,this.textureMask.g,this.textureMask.b,this.textureMask.a),this._isBillboardBased&&this._scene){const h=this._scene.activeCamera;r.setVector3("eyePosition",h.globalPosition)}this._rampGradientsTexture&&((!this._rampGradients||!this._rampGradients.length)&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),r.setTexture("rampSampler",this._rampGradientsTexture));const l=r.defines;switch(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&S_.BindClipPlane(r,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0&&(o.invertToRef(G.Matrix[0]),r.setMatrix("invView",G.Matrix[0])),this._vertexArrayObject!==void 0?(this._vertexArrayObject||(this._vertexArrayObject=this._engine.recordVertexArrayObject(this._vertexBuffers,this._indexBuffer,r)),this._engine.bindVertexArrayObject(this._vertexArrayObject,this._indexBuffer)):n.bindBuffers(this._vertexBuffers,this._indexBuffer,r),this.useLogarithmicDepth&&this._scene&&se.BindLogDepth(l,r,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(r),e){case et.BLENDMODE_ADD:n.setAlphaMode(1);break;case et.BLENDMODE_ONEONE:n.setAlphaMode(6);break;case et.BLENDMODE_STANDARD:n.setAlphaMode(2);break;case et.BLENDMODE_MULTIPLY:n.setAlphaMode(4);break}return this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(r),this._useInstancing?n.drawArraysType(7,0,4,this._particles.length):n.drawElementsType(0,0,this._particles.length*6),this._particles.length}render(){if(!this.isReady()||!this._particles.length)return 0;const e=this._engine;e.setState&&(e.setState(!1),this.forceDepthWrite&&e.setDepthWrite(!0));let t=0;return this.blendMode===et.BLENDMODE_MULTIPLYADD?t=this._render(et.BLENDMODE_MULTIPLY)+this._render(et.BLENDMODE_ADD):t=this._render(this.blendMode),this._engine.unbindInstanceAttributes(),this._engine.setAlphaMode(0),t}dispose(e=!0){if(this.resetDrawCache(),this._vertexBuffer&&(this._vertexBuffer.dispose(),this._vertexBuffer=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._indexBuffer&&(this._engine._releaseBuffer(this._indexBuffer),this._indexBuffer=null),this._vertexArrayObject&&(this._engine.releaseVertexArrayObject(this._vertexArrayObject),this._vertexArrayObject=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this._rampGradientsTexture&&(this._rampGradientsTexture.dispose(),this._rampGradientsTexture=null),this._removeFromRoot(),this.subEmitters&&!this._subEmitters&&this._prepareSubEmitterInternalArray(),this._subEmitters&&this._subEmitters.length){for(let t=0;t<this._subEmitters.length;t++)for(const i of this._subEmitters[t])i.dispose();this._subEmitters=[],this.subEmitters=[]}if(this._disposeEmitterOnDispose&&this.emitter&&this.emitter.dispose&&this.emitter.dispose(!0),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.clear(),this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1),this._scene._activeParticleSystems.dispose()}this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear(),this.onStoppedObservable.clear(),this.reset()}clone(e,t){const i={...this._customWrappers};let s=null;const r=this._engine;if(r.createEffectForParticles&&this.customShader!=null){s=this.customShader;const l=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"",h=r.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,l);i[0]?i[0].effect=h:this.setCustomEffect(h,0)}const n=this.serialize(),o=et.Parse(n,this._scene||this._engine,this._rootUrl);return o.name=e,o.customShader=s,o._customWrappers=i,t===void 0&&(t=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=t,this.preventAutoStart||o.start(),o}serialize(e=!1){const t={};if(et._Serialize(t,this,e),t.textureMask=this.textureMask.asArray(),t.customShader=this.customShader,t.preventAutoStart=this.preventAutoStart,this.subEmitters){t.subEmitters=[],this._subEmitters||this._prepareSubEmitterInternalArray();for(const i of this._subEmitters){const s=[];for(const r of i)s.push(r.serialize(e));t.subEmitters.push(s)}}return t}static _Serialize(e,t,i){if(e.name=t.name,e.id=t.id,e.capacity=t.getCapacity(),e.disposeOnStop=t.disposeOnStop,e.manualEmitCount=t.manualEmitCount,t.emitter.position){const m=t.emitter;e.emitterId=m.id}else{const m=t.emitter;e.emitter=m.asArray()}t.particleEmitterType&&(e.particleEmitterType=t.particleEmitterType.serialize()),t.particleTexture&&(i?e.texture=t.particleTexture.serialize():(e.textureName=t.particleTexture.name,e.invertY=!!t.particleTexture._invertY)),e.isLocal=t.isLocal,xe.AppendSerializedAnimations(t,e),e.beginAnimationOnStart=t.beginAnimationOnStart,e.beginAnimationFrom=t.beginAnimationFrom,e.beginAnimationTo=t.beginAnimationTo,e.beginAnimationLoop=t.beginAnimationLoop,e.startDelay=t.startDelay,e.renderingGroupId=t.renderingGroupId,e.isBillboardBased=t.isBillboardBased,e.billboardMode=t.billboardMode,e.minAngularSpeed=t.minAngularSpeed,e.maxAngularSpeed=t.maxAngularSpeed,e.minSize=t.minSize,e.maxSize=t.maxSize,e.minScaleX=t.minScaleX,e.maxScaleX=t.maxScaleX,e.minScaleY=t.minScaleY,e.maxScaleY=t.maxScaleY,e.minEmitPower=t.minEmitPower,e.maxEmitPower=t.maxEmitPower,e.minLifeTime=t.minLifeTime,e.maxLifeTime=t.maxLifeTime,e.emitRate=t.emitRate,e.gravity=t.gravity.asArray(),e.noiseStrength=t.noiseStrength.asArray(),e.color1=t.color1.asArray(),e.color2=t.color2.asArray(),e.colorDead=t.colorDead.asArray(),e.updateSpeed=t.updateSpeed,e.targetStopDuration=t.targetStopDuration,e.blendMode=t.blendMode,e.preWarmCycles=t.preWarmCycles,e.preWarmStepOffset=t.preWarmStepOffset,e.minInitialRotation=t.minInitialRotation,e.maxInitialRotation=t.maxInitialRotation,e.startSpriteCellID=t.startSpriteCellID,e.spriteCellLoop=t.spriteCellLoop,e.endSpriteCellID=t.endSpriteCellID,e.spriteCellChangeSpeed=t.spriteCellChangeSpeed,e.spriteCellWidth=t.spriteCellWidth,e.spriteCellHeight=t.spriteCellHeight,e.spriteRandomStartCell=t.spriteRandomStartCell,e.isAnimationSheetEnabled=t.isAnimationSheetEnabled,e.useLogarithmicDepth=t.useLogarithmicDepth;const s=t.getColorGradients();if(s){e.colorGradients=[];for(const m of s){const v={gradient:m.gradient,color1:m.color1.asArray()};m.color2?v.color2=m.color2.asArray():v.color2=m.color1.asArray(),e.colorGradients.push(v)}}const r=t.getRampGradients();if(r){e.rampGradients=[];for(const m of r){const v={gradient:m.gradient,color:m.color.asArray()};e.rampGradients.push(v)}e.useRampGradients=t.useRampGradients}const n=t.getColorRemapGradients();if(n){e.colorRemapGradients=[];for(const m of n){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.colorRemapGradients.push(v)}}const o=t.getAlphaRemapGradients();if(o){e.alphaRemapGradients=[];for(const m of o){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.alphaRemapGradients.push(v)}}const l=t.getSizeGradients();if(l){e.sizeGradients=[];for(const m of l){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.sizeGradients.push(v)}}const h=t.getAngularSpeedGradients();if(h){e.angularSpeedGradients=[];for(const m of h){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.angularSpeedGradients.push(v)}}const c=t.getVelocityGradients();if(c){e.velocityGradients=[];for(const m of c){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.velocityGradients.push(v)}}const u=t.getDragGradients();if(u){e.dragGradients=[];for(const m of u){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.dragGradients.push(v)}}const d=t.getEmitRateGradients();if(d){e.emitRateGradients=[];for(const m of d){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.emitRateGradients.push(v)}}const f=t.getStartSizeGradients();if(f){e.startSizeGradients=[];for(const m of f){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.startSizeGradients.push(v)}}const p=t.getLifeTimeGradients();if(p){e.lifeTimeGradients=[];for(const m of p){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.lifeTimeGradients.push(v)}}const _=t.getLimitVelocityGradients();if(_){e.limitVelocityGradients=[];for(const m of _){const v={gradient:m.gradient,factor1:m.factor1};m.factor2!==void 0?v.factor2=m.factor2:v.factor2=m.factor1,e.limitVelocityGradients.push(v)}e.limitVelocityDamping=t.limitVelocityDamping}t.noiseTexture&&(e.noiseTexture=t.noiseTexture.serialize())}static _Parse(e,t,i,s){var r,n,o;let l;i instanceof Te?l=null:l=i;const h=Si("BABYLON.Texture");if(h&&l&&(e.texture?t.particleTexture=h.Parse(e.texture,l,s):e.textureName&&(t.particleTexture=new h(s+e.textureName,l,!1,e.invertY!==void 0?e.invertY:!0),t.particleTexture.name=e.textureName)),!e.emitterId&&e.emitterId!==0&&e.emitter===void 0?t.emitter=g.Zero():e.emitterId&&l?t.emitter=l.getLastMeshById(e.emitterId):t.emitter=g.FromArray(e.emitter),t.isLocal=!!e.isLocal,e.renderingGroupId!==void 0&&(t.renderingGroupId=e.renderingGroupId),e.isBillboardBased!==void 0&&(t.isBillboardBased=e.isBillboardBased),e.billboardMode!==void 0&&(t.billboardMode=e.billboardMode),e.useLogarithmicDepth!==void 0&&(t.useLogarithmicDepth=e.useLogarithmicDepth),e.animations){for(let u=0;u<e.animations.length;u++){const d=e.animations[u],f=Si("BABYLON.Animation");f&&t.animations.push(f.Parse(d))}t.beginAnimationOnStart=e.beginAnimationOnStart,t.beginAnimationFrom=e.beginAnimationFrom,t.beginAnimationTo=e.beginAnimationTo,t.beginAnimationLoop=e.beginAnimationLoop}if(e.autoAnimate&&l&&l.beginAnimation(t,e.autoAnimateFrom,e.autoAnimateTo,e.autoAnimateLoop,e.autoAnimateSpeed||1),t.startDelay=e.startDelay|0,t.minAngularSpeed=e.minAngularSpeed,t.maxAngularSpeed=e.maxAngularSpeed,t.minSize=e.minSize,t.maxSize=e.maxSize,e.minScaleX&&(t.minScaleX=e.minScaleX,t.maxScaleX=e.maxScaleX,t.minScaleY=e.minScaleY,t.maxScaleY=e.maxScaleY),e.preWarmCycles!==void 0&&(t.preWarmCycles=e.preWarmCycles,t.preWarmStepOffset=e.preWarmStepOffset),e.minInitialRotation!==void 0&&(t.minInitialRotation=e.minInitialRotation,t.maxInitialRotation=e.maxInitialRotation),t.minLifeTime=e.minLifeTime,t.maxLifeTime=e.maxLifeTime,t.minEmitPower=e.minEmitPower,t.maxEmitPower=e.maxEmitPower,t.emitRate=e.emitRate,t.gravity=g.FromArray(e.gravity),e.noiseStrength&&(t.noiseStrength=g.FromArray(e.noiseStrength)),t.color1=J.FromArray(e.color1),t.color2=J.FromArray(e.color2),t.colorDead=J.FromArray(e.colorDead),t.updateSpeed=e.updateSpeed,t.targetStopDuration=e.targetStopDuration,t.blendMode=e.blendMode,e.colorGradients)for(const u of e.colorGradients)t.addColorGradient(u.gradient,J.FromArray(u.color1),u.color2?J.FromArray(u.color2):void 0);if(e.rampGradients){for(const u of e.rampGradients)t.addRampGradient(u.gradient,re.FromArray(u.color));t.useRampGradients=e.useRampGradients}if(e.colorRemapGradients)for(const u of e.colorRemapGradients)t.addColorRemapGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.alphaRemapGradients)for(const u of e.alphaRemapGradients)t.addAlphaRemapGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.sizeGradients)for(const u of e.sizeGradients)t.addSizeGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.angularSpeedGradients)for(const u of e.angularSpeedGradients)t.addAngularSpeedGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.velocityGradients)for(const u of e.velocityGradients)t.addVelocityGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.dragGradients)for(const u of e.dragGradients)t.addDragGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.emitRateGradients)for(const u of e.emitRateGradients)t.addEmitRateGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.startSizeGradients)for(const u of e.startSizeGradients)t.addStartSizeGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.lifeTimeGradients)for(const u of e.lifeTimeGradients)t.addLifeTimeGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);if(e.limitVelocityGradients){for(const u of e.limitVelocityGradients)t.addLimitVelocityGradient(u.gradient,u.factor1!==void 0?u.factor1:u.factor,u.factor2);t.limitVelocityDamping=e.limitVelocityDamping}if(e.noiseTexture&&l){const u=Si("BABYLON.ProceduralTexture");t.noiseTexture=u.Parse(e.noiseTexture,l,s)}let c;if(e.particleEmitterType){switch(e.particleEmitterType.type){case"SphereParticleEmitter":c=new $l;break;case"SphereDirectedParticleEmitter":c=new Pc;break;case"ConeEmitter":case"ConeParticleEmitter":c=new yc;break;case"CylinderParticleEmitter":c=new Kl;break;case"CylinderDirectedParticleEmitter":c=new Ac;break;case"HemisphericParticleEmitter":c=new Rc;break;case"PointParticleEmitter":c=new Ic;break;case"MeshParticleEmitter":c=new Wd;break;case"BoxEmitter":case"BoxParticleEmitter":default:c=new Pa;break}c.parse(e.particleEmitterType,l)}else c=new Pa,c.parse(e,l);t.particleEmitterType=c,t.startSpriteCellID=e.startSpriteCellID,t.endSpriteCellID=e.endSpriteCellID,t.spriteCellLoop=(r=e.spriteCellLoop)!==null&&r!==void 0?r:!0,t.spriteCellWidth=e.spriteCellWidth,t.spriteCellHeight=e.spriteCellHeight,t.spriteCellChangeSpeed=e.spriteCellChangeSpeed,t.spriteRandomStartCell=e.spriteRandomStartCell,t.disposeOnStop=(n=e.disposeOnStop)!==null&&n!==void 0?n:!1,t.manualEmitCount=(o=e.manualEmitCount)!==null&&o!==void 0?o:-1}static Parse(e,t,i,s=!1,r){const n=e.name;let o=null,l=null,h,c;if(t instanceof Te?h=t:(c=t,h=c.getEngine()),e.customShader&&h.createEffectForParticles){l=e.customShader;const d=l.shaderOptions.defines.length>0?l.shaderOptions.defines.join(`
`):"";o=h.createEffectForParticles(l.shaderPath.fragmentElement,l.shaderOptions.uniforms,l.shaderOptions.samplers,d)}const u=new et(n,r||e.capacity,t,o,e.isAnimationSheetEnabled);if(u.customShader=l,u._rootUrl=i,e.id&&(u.id=e.id),e.subEmitters){u.subEmitters=[];for(const d of e.subEmitters){const f=[];for(const p of d)f.push(Xn.Parse(p,t,i));u.subEmitters.push(f)}}return et._Parse(e,u,t,i),e.textureMask&&(u.textureMask=J.FromArray(e.textureMask)),e.preventAutoStart&&(u.preventAutoStart=e.preventAutoStart),!s&&!u.preventAutoStart&&u.start(),u}}et.BILLBOARDMODE_Y=2;et.BILLBOARDMODE_ALL=7;et.BILLBOARDMODE_STRETCHED=8;Xn._ParseParticleSystem=et.Parse;const JI="clipPlaneFragmentDeclaration2",eP=`#ifdef CLIPPLANE
in float fClipDistance;
#endif
#ifdef CLIPPLANE2
in float fClipDistance2;
#endif
#ifdef CLIPPLANE3
in float fClipDistance3;
#endif
#ifdef CLIPPLANE4
in float fClipDistance4;
#endif
#ifdef CLIPPLANE5
in float fClipDistance5;
#endif
#ifdef CLIPPLANE6
in float fClipDistance6;
#endif
`;Y.IncludesShadersStore[JI]=eP;const tP="gpuRenderParticlesPixelShader",iP=`precision highp float;
#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform sampler2D diffuseSampler;
varying vec2 vUV;
varying vec4 vColor;
#include<clipPlaneFragmentDeclaration2> 
#include<imageProcessingDeclaration>
#include<logDepthDeclaration>
#include<helperFunctions>
#include<imageProcessingFunctions>
void main() {
#include<clipPlaneFragment> 
vec4 textureColor=texture2D(diffuseSampler,vUV);
gl_FragColor=textureColor*vColor;
#ifdef BLENDMULTIPLYMODE
float alpha=vColor.a*textureColor.a;
gl_FragColor.rgb=gl_FragColor.rgb*alpha+vec3(1.0)*(1.0-alpha);
#endif 
#include<logDepthFragment>
#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
#else
#ifdef IMAGEPROCESSING
gl_FragColor.rgb=toLinearSpace(gl_FragColor.rgb);
gl_FragColor=applyImageProcessing(gl_FragColor);
#endif
#endif
}
`;Y.ShadersStore[tP]=iP;const sP="clipPlaneVertexDeclaration2",rP=`#ifdef CLIPPLANE
uniform vec4 vClipPlane;
out float fClipDistance;
#endif
#ifdef CLIPPLANE2
uniform vec4 vClipPlane2;
out float fClipDistance2;
#endif
#ifdef CLIPPLANE3
uniform vec4 vClipPlane3;
out float fClipDistance3;
#endif
#ifdef CLIPPLANE4
uniform vec4 vClipPlane4;
out float fClipDistance4;
#endif
#ifdef CLIPPLANE5
uniform vec4 vClipPlane5;
out float fClipDistance5;
#endif
#ifdef CLIPPLANE6
uniform vec4 vClipPlane6;
out float fClipDistance6;
#endif
`;Y.IncludesShadersStore[sP]=rP;const nP="gpuRenderParticlesVertexShader",aP=`precision highp float;
uniform mat4 view;
uniform mat4 projection;
uniform vec2 translationPivot;
uniform vec3 worldOffset;
#ifdef LOCAL
uniform mat4 emitterWM;
#endif
attribute vec3 position;
attribute float age;
attribute float life;
attribute vec3 size;
#ifndef BILLBOARD
attribute vec3 initialDirection;
#endif
#ifdef BILLBOARDSTRETCHED
attribute vec3 direction;
#endif
attribute float angle;
#ifdef ANIMATESHEET
attribute float cellIndex;
#endif
attribute vec2 offset;
attribute vec2 uv;
varying vec2 vUV;
varying vec4 vColor;
varying vec3 vPositionW;
#if defined(BILLBOARD) && !defined(BILLBOARDY) && !defined(BILLBOARDSTRETCHED)
uniform mat4 invView;
#endif
#include<clipPlaneVertexDeclaration2>
#include<logDepthDeclaration>
#ifdef COLORGRADIENTS
uniform sampler2D colorGradientSampler;
#else
uniform vec4 colorDead;
attribute vec4 color;
#endif
#ifdef ANIMATESHEET
uniform vec3 sheetInfos;
#endif
#ifdef BILLBOARD
uniform vec3 eyePosition;
#endif
vec3 rotate(vec3 yaxis,vec3 rotatedCorner) {
vec3 xaxis=normalize(cross(vec3(0.,1.0,0.),yaxis));
vec3 zaxis=normalize(cross(yaxis,xaxis));
vec3 row0=vec3(xaxis.x,xaxis.y,xaxis.z);
vec3 row1=vec3(yaxis.x,yaxis.y,yaxis.z);
vec3 row2=vec3(zaxis.x,zaxis.y,zaxis.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#ifdef BILLBOARDSTRETCHED
vec3 rotateAlign(vec3 toCamera,vec3 rotatedCorner) {
vec3 normalizedToCamera=normalize(toCamera);
vec3 normalizedCrossDirToCamera=normalize(cross(normalize(direction),normalizedToCamera));
vec3 crossProduct=normalize(cross(normalizedToCamera,normalizedCrossDirToCamera));
vec3 row0=vec3(normalizedCrossDirToCamera.x,normalizedCrossDirToCamera.y,normalizedCrossDirToCamera.z);
vec3 row1=vec3(crossProduct.x,crossProduct.y,crossProduct.z);
vec3 row2=vec3(normalizedToCamera.x,normalizedToCamera.y,normalizedToCamera.z);
mat3 rotMatrix= mat3(row0,row1,row2);
vec3 alignedCorner=rotMatrix*rotatedCorner;
#ifdef LOCAL
return ((emitterWM*vec4(position,1.0)).xyz+worldOffset)+alignedCorner;
#else
return (position+worldOffset)+alignedCorner;
#endif
}
#endif
void main() {
#ifdef ANIMATESHEET
float rowOffset=floor(cellIndex/sheetInfos.z);
float columnOffset=cellIndex-rowOffset*sheetInfos.z;
vec2 uvScale=sheetInfos.xy;
vec2 uvOffset=vec2(uv.x ,1.0-uv.y);
vUV=(uvOffset+vec2(columnOffset,rowOffset))*uvScale;
#else
vUV=uv;
#endif
float ratio=age/life;
#ifdef COLORGRADIENTS
vColor=texture2D(colorGradientSampler,vec2(ratio,0));
#else
vColor=color*vec4(1.0-ratio)+colorDead*vec4(ratio);
#endif
vec2 cornerPos=(offset-translationPivot)*size.yz*size.x+translationPivot;
#ifdef BILLBOARD
vec4 rotatedCorner;
rotatedCorner.w=0.;
#ifdef BILLBOARDY
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.y=0.;
vec3 yaxis=(position+worldOffset)-eyePosition;
yaxis.y=0.;
vPositionW=rotate(normalize(yaxis),rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#elif defined(BILLBOARDSTRETCHED)
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
vec3 toCamera=(position+worldOffset)-eyePosition;
vPositionW=rotateAlign(toCamera,rotatedCorner.xyz);
vec4 viewPosition=(view*vec4(vPositionW,1.0));
#else
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
#ifdef LOCAL
vec4 viewPosition=view*vec4(((emitterWM*vec4(position,1.0)).xyz+worldOffset),1.0)+rotatedCorner;
#else
vec4 viewPosition=view*vec4((position+worldOffset),1.0)+rotatedCorner;
#endif
vPositionW=(invView*viewPosition).xyz;
#endif
#else
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=0.;
rotatedCorner.z=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
vec3 yaxis=normalize(initialDirection);
vPositionW=rotate(yaxis,rotatedCorner);
vec4 viewPosition=view*vec4(vPositionW,1.0);
#endif
gl_Position=projection*viewPosition;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=vec4(vPositionW,1.0);
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}`;Y.ShadersStore[nP]=aP;class _o extends Dr{constructor(e,t,i,s=null,r=!1){if(super(e),this.layerMask=268435455,this._accumulatedCount=0,this._targetIndex=0,this._currentRenderId=-1,this._currentRenderingCameraUniqueId=-1,this._started=!1,this._stopped=!1,this._timeDelta=0,this._actualFrame=0,this._rawTextureWidth=256,this.onDisposeObservable=new X,this.onStoppedObservable=new X,this.forceDepthWrite=!1,this._preWarmDone=!1,this.isLocal=!1,this._onBeforeDrawParticlesObservable=null,!i||i.getClassName()==="Scene"?(this._scene=i||ye.LastCreatedScene,this._engine=this._scene.getEngine(),this.uniqueId=this._scene.getUniqueId(),this._scene.particleSystems.push(this)):(this._engine=i,this.defaultProjectionMatrix=L.PerspectiveFovLH(.8,1,.1,100,this._engine.isNDCHalfZRange)),this._engine.getCaps().supportComputeShaders){if(!Si("BABYLON.ComputeShaderParticleSystem"))throw new Error("The ComputeShaderParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Si("BABYLON.ComputeShaderParticleSystem"))(this,this._engine)}else{if(!Si("BABYLON.WebGL2ParticleSystem"))throw new Error("The WebGL2ParticleSystem class is not available! Make sure you have imported it.");this._platform=new(Si("BABYLON.WebGL2ParticleSystem"))(this,this._engine)}this._customWrappers={0:new Vi(this._engine)},this._customWrappers[0].effect=s,this._drawWrappers={0:new Vi(this._engine)},this._drawWrappers[0].drawContext&&(this._drawWrappers[0].drawContext.useInstancing=!0),this._attachImageProcessingConfiguration(null),t=t!=null?t:{},t.randomTextureSize||delete t.randomTextureSize;const n={capacity:5e4,randomTextureSize:this._engine.getCaps().maxTextureSize,...t},o=t;isFinite(o)&&(n.capacity=o),this._capacity=n.capacity,this._activeCount=n.capacity,this._currentActiveCount=0,this._isAnimationSheetEnabled=r,this.particleEmitterType=new Pa;const l=Math.min(this._engine.getCaps().maxTextureSize,n.randomTextureSize);let h=[];for(let c=0;c<l;++c)h.push(Math.random()),h.push(Math.random()),h.push(Math.random()),h.push(Math.random());this._randomTexture=new Ts(new Float32Array(h),l,1,5,i,!1,!1,1,1),this._randomTexture.name="GPUParticleSystem_random1",this._randomTexture.wrapU=1,this._randomTexture.wrapV=1,h=[];for(let c=0;c<l;++c)h.push(Math.random()),h.push(Math.random()),h.push(Math.random()),h.push(Math.random());this._randomTexture2=new Ts(new Float32Array(h),l,1,5,i,!1,!1,1,1),this._randomTexture2.name="GPUParticleSystem_random2",this._randomTexture2.wrapU=1,this._randomTexture2.wrapV=1,this._randomTextureSize=l}static get IsSupported(){if(!ye.LastCreatedEngine)return!1;const e=ye.LastCreatedEngine.getCaps();return e.supportTransformFeedbacks||e.supportComputeShaders}getCapacity(){return this._capacity}get activeParticleCount(){return this._activeCount}set activeParticleCount(e){this._activeCount=Math.min(e,this._capacity)}isReady(){if(!this.emitter||this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.isReady()||!this.particleTexture||!this.particleTexture.isReady())return!1;if(this.blendMode!==et.BLENDMODE_MULTIPLYADD){if(!this._getWrapper(this.blendMode).effect.isReady())return!1}else if(!this._getWrapper(et.BLENDMODE_MULTIPLY).effect.isReady()||!this._getWrapper(et.BLENDMODE_ADD).effect.isReady())return!1;return this._platform.isUpdateBufferCreated()?this._platform.isUpdateBufferReady():(this._recreateUpdateEffect(),!1)}isStarted(){return this._started}isStopped(){return this._stopped}isStopping(){return!1}getActiveCount(){return this._currentActiveCount}start(e=this.startDelay){if(!this.targetStopDuration&&this._hasTargetStopDurationDependantGradient())throw"Particle system started with a targetStopDuration dependant gradient (eg. startSizeGradients) but no targetStopDuration set";if(e){setTimeout(()=>{this.start(0)},e);return}this._started=!0,this._stopped=!1,this._preWarmDone=!1,this.beginAnimationOnStart&&this.animations&&this.animations.length>0&&this._scene&&this._scene.beginAnimation(this,this.beginAnimationFrom,this.beginAnimationTo,this.beginAnimationLoop)}stop(){this._stopped||(this._stopped=!0)}reset(){this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._currentActiveCount=0,this._targetIndex=0}getClassName(){return"GPUParticleSystem"}getCustomEffect(e=0){var t,i;return(i=(t=this._customWrappers[e])===null||t===void 0?void 0:t.effect)!==null&&i!==void 0?i:this._customWrappers[0].effect}_getCustomDrawWrapper(e=0){var t;return(t=this._customWrappers[e])!==null&&t!==void 0?t:this._customWrappers[0]}setCustomEffect(e,t=0){this._customWrappers[t]=new Vi(this._engine),this._customWrappers[t].effect=e}get onBeforeDrawParticlesObservable(){return this._onBeforeDrawParticlesObservable||(this._onBeforeDrawParticlesObservable=new X),this._onBeforeDrawParticlesObservable}get vertexShaderName(){return"gpuRenderParticles"}_removeGradientAndTexture(e,t,i){return super._removeGradientAndTexture(e,t,i),this._releaseBuffers(),this}addColorGradient(e,t){this._colorGradients||(this._colorGradients=[]);const i=new km(e,t);return this._colorGradients.push(i),this._refreshColorGradient(!0),this._releaseBuffers(),this}_refreshColorGradient(e=!1){this._colorGradients&&(e&&this._colorGradients.sort((t,i)=>t.gradient<i.gradient?-1:t.gradient>i.gradient?1:0),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null))}forceRefreshGradients(){this._refreshColorGradient(),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture"),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture"),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture"),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture"),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture"),this.reset()}removeColorGradient(e){return this._removeGradientAndTexture(e,this._colorGradients,this._colorGradientsTexture),this._colorGradientsTexture=null,this}resetDrawCache(){var e;for(const t in this._drawWrappers)(e=this._drawWrappers[t].drawContext)===null||e===void 0||e.reset()}_addFactorGradient(e,t,i){const s=new Gm(t,i);e.push(s),this._releaseBuffers()}addSizeGradient(e,t){return this._sizeGradients||(this._sizeGradients=[]),this._addFactorGradient(this._sizeGradients,e,t),this._refreshFactorGradient(this._sizeGradients,"_sizeGradientsTexture",!0),this._releaseBuffers(),this}removeSizeGradient(e){return this._removeGradientAndTexture(e,this._sizeGradients,this._sizeGradientsTexture),this._sizeGradientsTexture=null,this}_refreshFactorGradient(e,t,i=!1){if(!e)return;i&&e.sort((r,n)=>r.gradient<n.gradient?-1:r.gradient>n.gradient?1:0);const s=this;s[t]&&(s[t].dispose(),s[t]=null)}addAngularSpeedGradient(e,t){return this._angularSpeedGradients||(this._angularSpeedGradients=[]),this._addFactorGradient(this._angularSpeedGradients,e,t),this._refreshFactorGradient(this._angularSpeedGradients,"_angularSpeedGradientsTexture",!0),this._releaseBuffers(),this}removeAngularSpeedGradient(e){return this._removeGradientAndTexture(e,this._angularSpeedGradients,this._angularSpeedGradientsTexture),this._angularSpeedGradientsTexture=null,this}addVelocityGradient(e,t){return this._velocityGradients||(this._velocityGradients=[]),this._addFactorGradient(this._velocityGradients,e,t),this._refreshFactorGradient(this._velocityGradients,"_velocityGradientsTexture",!0),this._releaseBuffers(),this}removeVelocityGradient(e){return this._removeGradientAndTexture(e,this._velocityGradients,this._velocityGradientsTexture),this._velocityGradientsTexture=null,this}addLimitVelocityGradient(e,t){return this._limitVelocityGradients||(this._limitVelocityGradients=[]),this._addFactorGradient(this._limitVelocityGradients,e,t),this._refreshFactorGradient(this._limitVelocityGradients,"_limitVelocityGradientsTexture",!0),this._releaseBuffers(),this}removeLimitVelocityGradient(e){return this._removeGradientAndTexture(e,this._limitVelocityGradients,this._limitVelocityGradientsTexture),this._limitVelocityGradientsTexture=null,this}addDragGradient(e,t){return this._dragGradients||(this._dragGradients=[]),this._addFactorGradient(this._dragGradients,e,t),this._refreshFactorGradient(this._dragGradients,"_dragGradientsTexture",!0),this._releaseBuffers(),this}removeDragGradient(e){return this._removeGradientAndTexture(e,this._dragGradients,this._dragGradientsTexture),this._dragGradientsTexture=null,this}addEmitRateGradient(){return this}removeEmitRateGradient(){return this}addStartSizeGradient(){return this}removeStartSizeGradient(){return this}addColorRemapGradient(){return this}removeColorRemapGradient(){return this}addAlphaRemapGradient(){return this}removeAlphaRemapGradient(){return this}addRampGradient(){return this}removeRampGradient(){return this}getRampGradients(){return null}get useRampGradients(){return!1}set useRampGradients(e){}addLifeTimeGradient(){return this}removeLifeTimeGradient(){return this}_reset(){this._releaseBuffers()}_createVertexBuffers(e,t,i){const s={};s.position=t.createVertexBuffer("position",0,3,this._attributesStrideSize,!0);let r=3;s.age=t.createVertexBuffer("age",r,1,this._attributesStrideSize,!0),r+=1,s.size=t.createVertexBuffer("size",r,3,this._attributesStrideSize,!0),r+=3,s.life=t.createVertexBuffer("life",r,1,this._attributesStrideSize,!0),r+=1,r+=4,this.billboardMode===et.BILLBOARDMODE_STRETCHED&&(s.direction=t.createVertexBuffer("direction",r,3,this._attributesStrideSize,!0)),r+=3,this._platform.alignDataInBuffer&&(r+=1),this.particleEmitterType instanceof Ma&&(r+=3,this._platform.alignDataInBuffer&&(r+=1)),this._colorGradientsTexture||(s.color=t.createVertexBuffer("color",r,4,this._attributesStrideSize,!0),r+=4),this._isBillboardBased||(s.initialDirection=t.createVertexBuffer("initialDirection",r,3,this._attributesStrideSize,!0),r+=3,this._platform.alignDataInBuffer&&(r+=1)),this.noiseTexture&&(s.noiseCoordinates1=t.createVertexBuffer("noiseCoordinates1",r,3,this._attributesStrideSize,!0),r+=3,this._platform.alignDataInBuffer&&(r+=1),s.noiseCoordinates2=t.createVertexBuffer("noiseCoordinates2",r,3,this._attributesStrideSize,!0),r+=3,this._platform.alignDataInBuffer&&(r+=1)),s.angle=t.createVertexBuffer("angle",r,1,this._attributesStrideSize,!0),this._angularSpeedGradientsTexture?r++:r+=2,this._isAnimationSheetEnabled&&(s.cellIndex=t.createVertexBuffer("cellIndex",r,1,this._attributesStrideSize,!0),r+=1,this.spriteRandomStartCell&&(s.cellStartOffset=t.createVertexBuffer("cellStartOffset",r,1,this._attributesStrideSize,!0),r+=1)),s.offset=i.createVertexBuffer("offset",0,2),s.uv=i.createVertexBuffer("uv",2,2),this._platform.createVertexBuffers(e,s),this.resetDrawCache()}_initialize(e=!1){if(this._buffer0&&!e)return;const t=this._engine,i=new Array;this._attributesStrideSize=21,this._targetIndex=0,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1),this.particleEmitterType instanceof Ma&&(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this.isBillboardBased||(this._attributesStrideSize+=3,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=1)),this._colorGradientsTexture&&(this._attributesStrideSize-=4),this._angularSpeedGradientsTexture&&(this._attributesStrideSize-=1),this._isAnimationSheetEnabled&&(this._attributesStrideSize+=1,this.spriteRandomStartCell&&(this._attributesStrideSize+=1)),this.noiseTexture&&(this._attributesStrideSize+=6,this._platform.alignDataInBuffer&&(this._attributesStrideSize+=2)),this._platform.alignDataInBuffer&&(this._attributesStrideSize+=3-(this._attributesStrideSize+3&3));const s=this.particleEmitterType instanceof Ma,r=G.Vector3[0];let n=0;for(let c=0;c<this._capacity;c++)if(i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),s?(this.particleEmitterType.particleDestinationGenerator(c,null,r),i.push(r.x),i.push(r.y),i.push(r.z)):(i.push(0),i.push(0),i.push(0)),this._platform.alignDataInBuffer&&i.push(0),n+=16,s&&(this.particleEmitterType.particlePositionGenerator(c,null,r),i.push(r.x),i.push(r.y),i.push(r.z),this._platform.alignDataInBuffer&&i.push(0),n+=4),this._colorGradientsTexture||(i.push(0),i.push(0),i.push(0),i.push(0),n+=4),this.isBillboardBased||(i.push(0),i.push(0),i.push(0),this._platform.alignDataInBuffer&&i.push(0),n+=4),this.noiseTexture&&(i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),i.push(Math.random()),i.push(Math.random()),i.push(Math.random()),this._platform.alignDataInBuffer&&i.push(0),n+=8),i.push(0),n+=1,this._angularSpeedGradientsTexture||(i.push(0),n+=1),this._isAnimationSheetEnabled&&(i.push(0),n+=1,this.spriteRandomStartCell&&(i.push(0),n+=1)),this._platform.alignDataInBuffer){let u=3-(n+3&3);for(n+=u;u-- >0;)i.push(0)}const o=new Float32Array([.5,.5,1,1,-.5,.5,0,1,.5,-.5,1,0,-.5,-.5,0,0]),l=this._platform.createParticleBuffer(i),h=this._platform.createParticleBuffer(i);this._buffer0=new Hr(t,l,!1,this._attributesStrideSize),this._buffer1=new Hr(t,h,!1,this._attributesStrideSize),this._spriteBuffer=new Hr(t,o,!1,4),this._createVertexBuffers(this._buffer0,this._buffer1,this._spriteBuffer),this._createVertexBuffers(this._buffer1,this._buffer0,this._spriteBuffer),this._sourceBuffer=this._buffer0,this._targetBuffer=this._buffer1}_recreateUpdateEffect(){let e=this.particleEmitterType?this.particleEmitterType.getEffectDefines():"";this._isBillboardBased&&(e+=`
#define BILLBOARD`),this._colorGradientsTexture&&(e+=`
#define COLORGRADIENTS`),this._sizeGradientsTexture&&(e+=`
#define SIZEGRADIENTS`),this._angularSpeedGradientsTexture&&(e+=`
#define ANGULARSPEEDGRADIENTS`),this._velocityGradientsTexture&&(e+=`
#define VELOCITYGRADIENTS`),this._limitVelocityGradientsTexture&&(e+=`
#define LIMITVELOCITYGRADIENTS`),this._dragGradientsTexture&&(e+=`
#define DRAGGRADIENTS`),this.isAnimationSheetEnabled&&(e+=`
#define ANIMATESHEET`,this.spriteRandomStartCell&&(e+=`
#define ANIMATESHEETRANDOMSTART`)),this.noiseTexture&&(e+=`
#define NOISE`),this.isLocal&&(e+=`
#define LOCAL`),!(this._platform.isUpdateBufferCreated()&&this._cachedUpdateDefines===e)&&(this._cachedUpdateDefines=e,this._updateBuffer=this._platform.createUpdateBuffer(e))}_getWrapper(e){const t=this._getCustomDrawWrapper(e);if(t!=null&&t.effect)return t;const i=[];this.fillDefines(i,e);let s=this._drawWrappers[e];s||(s=new Vi(this._engine),s.drawContext&&(s.drawContext.useInstancing=!0),this._drawWrappers[e]=s);const r=i.join(`
`);if(s.defines!==r){const n=[],o=[],l=[];this.fillUniformsAttributesAndSamplerNames(o,n,l),s.setEffect(this._engine.createEffect("gpuRenderParticles",n,o,l,r),r)}return s}static _GetAttributeNamesOrOptions(e=!1,t=!1,i=!1,s=!1){const r=[y.PositionKind,"age","life","size","angle"];return e||r.push(y.ColorKind),t&&r.push("cellIndex"),i||r.push("initialDirection"),s||r.push("direction"),r.push("offset",y.UVKind),r}static _GetEffectCreationOptions(e=!1,t=!1){const i=["emitterWM","worldOffset","view","projection","colorDead","invView","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6","translationPivot","eyePosition"];return e&&i.push("sheetInfos"),t&&i.push("logarithmicDepthConstant"),i}fillDefines(e,t=0){if(this._scene&&(this._scene.clipPlane&&e.push("#define CLIPPLANE"),this._scene.clipPlane2&&e.push("#define CLIPPLANE2"),this._scene.clipPlane3&&e.push("#define CLIPPLANE3"),this._scene.clipPlane4&&e.push("#define CLIPPLANE4"),this._scene.clipPlane5&&e.push("#define CLIPPLANE5"),this._scene.clipPlane6&&e.push("#define CLIPPLANE6")),t===et.BLENDMODE_MULTIPLY&&e.push("#define BLENDMULTIPLYMODE"),this.isLocal&&e.push("#define LOCAL"),this.useLogarithmicDepth&&e.push("#define LOGARITHMICDEPTH"),this._isBillboardBased)switch(e.push("#define BILLBOARD"),this.billboardMode){case et.BILLBOARDMODE_Y:e.push("#define BILLBOARDY");break;case et.BILLBOARDMODE_STRETCHED:e.push("#define BILLBOARDSTRETCHED");break;case et.BILLBOARDMODE_ALL:e.push("#define BILLBOARDMODE_ALL");break}this._colorGradientsTexture&&e.push("#define COLORGRADIENTS"),this.isAnimationSheetEnabled&&e.push("#define ANIMATESHEET"),this._imageProcessingConfiguration&&(this._imageProcessingConfiguration.prepareDefines(this._imageProcessingConfigurationDefines),e.push(""+this._imageProcessingConfigurationDefines.toString()))}fillUniformsAttributesAndSamplerNames(e,t,i){t.push(..._o._GetAttributeNamesOrOptions(!!this._colorGradientsTexture,this._isAnimationSheetEnabled,this._isBillboardBased,this._isBillboardBased&&this.billboardMode===et.BILLBOARDMODE_STRETCHED)),e.push(..._o._GetEffectCreationOptions(this._isAnimationSheetEnabled,this.useLogarithmicDepth)),i.push("diffuseSampler","colorGradientSampler"),this._imageProcessingConfiguration&&(qe.PrepareUniforms(e,this._imageProcessingConfigurationDefines),qe.PrepareSamplers(i,this._imageProcessingConfigurationDefines))}animate(e=!1){var t;this._timeDelta=this.updateSpeed*(e?this.preWarmStepOffset:((t=this._scene)===null||t===void 0?void 0:t.getAnimationRatio())||1),this._actualFrame+=this._timeDelta,this._stopped||this.targetStopDuration&&this._actualFrame>=this.targetStopDuration&&this.stop()}_createFactorGradientTexture(e,t){const i=this[t];if(!e||!e.length||i)return;const s=new Float32Array(this._rawTextureWidth);for(let r=0;r<this._rawTextureWidth;r++){const n=r/this._rawTextureWidth;Us.GetCurrentGradient(n,e,(o,l,h)=>{s[r]=oe.Lerp(o.factor1,l.factor1,h)})}this[t]=Ts.CreateRTexture(s,this._rawTextureWidth,1,this._scene||this._engine,!1,!1,1)}_createSizeGradientTexture(){this._createFactorGradientTexture(this._sizeGradients,"_sizeGradientsTexture")}_createAngularSpeedGradientTexture(){this._createFactorGradientTexture(this._angularSpeedGradients,"_angularSpeedGradientsTexture")}_createVelocityGradientTexture(){this._createFactorGradientTexture(this._velocityGradients,"_velocityGradientsTexture")}_createLimitVelocityGradientTexture(){this._createFactorGradientTexture(this._limitVelocityGradients,"_limitVelocityGradientsTexture")}_createDragGradientTexture(){this._createFactorGradientTexture(this._dragGradients,"_dragGradientsTexture")}_createColorGradientTexture(){if(!this._colorGradients||!this._colorGradients.length||this._colorGradientsTexture)return;const e=new Uint8Array(this._rawTextureWidth*4),t=ht.Color4[0];for(let i=0;i<this._rawTextureWidth;i++){const s=i/this._rawTextureWidth;Us.GetCurrentGradient(s,this._colorGradients,(r,n,o)=>{J.LerpToRef(r.color1,n.color1,o,t),e[i*4]=t.r*255,e[i*4+1]=t.g*255,e[i*4+2]=t.b*255,e[i*4+3]=t.a*255})}this._colorGradientsTexture=Ts.CreateRGBATexture(e,this._rawTextureWidth,1,this._scene,!1,!1,1)}_render(e,t){var i,s;const r=this._getWrapper(e),n=r.effect;this._engine.enableEffect(r);const o=((i=this._scene)===null||i===void 0?void 0:i.getViewMatrix())||L.IdentityReadOnly;if(n.setMatrix("view",o),n.setMatrix("projection",(s=this.defaultProjectionMatrix)!==null&&s!==void 0?s:this._scene.getProjectionMatrix()),n.setTexture("diffuseSampler",this.particleTexture),n.setVector2("translationPivot",this.translationPivot),n.setVector3("worldOffset",this.worldOffset),this.isLocal&&n.setMatrix("emitterWM",t),this._colorGradientsTexture?n.setTexture("colorGradientSampler",this._colorGradientsTexture):n.setDirectColor4("colorDead",this.colorDead),this._isAnimationSheetEnabled&&this.particleTexture){const h=this.particleTexture.getBaseSize();n.setFloat3("sheetInfos",this.spriteCellWidth/h.width,this.spriteCellHeight/h.height,h.width/this.spriteCellWidth)}if(this._isBillboardBased&&this._scene){const h=this._scene.activeCamera;n.setVector3("eyePosition",h.globalPosition)}const l=n.defines;if(this._scene&&(this._scene.clipPlane||this._scene.clipPlane2||this._scene.clipPlane3||this._scene.clipPlane4||this._scene.clipPlane5||this._scene.clipPlane6)&&se.BindClipPlane(n,this._scene),l.indexOf("#define BILLBOARDMODE_ALL")>=0){const h=o.clone();h.invert(),n.setMatrix("invView",h)}switch(this.useLogarithmicDepth&&this._scene&&se.BindLogDepth(l,n,this._scene),this._imageProcessingConfiguration&&!this._imageProcessingConfiguration.applyByPostProcess&&this._imageProcessingConfiguration.bind(n),e){case et.BLENDMODE_ADD:this._engine.setAlphaMode(1);break;case et.BLENDMODE_ONEONE:this._engine.setAlphaMode(6);break;case et.BLENDMODE_STANDARD:this._engine.setAlphaMode(2);break;case et.BLENDMODE_MULTIPLY:this._engine.setAlphaMode(4);break}return this._platform.bindDrawBuffers(this._targetIndex,n),this._onBeforeDrawParticlesObservable&&this._onBeforeDrawParticlesObservable.notifyObservers(n),this._engine.drawArraysType(7,0,4,this._currentActiveCount),this._engine.setAlphaMode(0),this._currentActiveCount}render(e=!1,t=!1){if(!this._started||(this._createColorGradientTexture(),this._createSizeGradientTexture(),this._createAngularSpeedGradientTexture(),this._createVelocityGradientTexture(),this._createLimitVelocityGradientTexture(),this._createDragGradientTexture(),this._recreateUpdateEffect(),!this.isReady()))return 0;if(!e&&this._scene){if(!this._preWarmDone&&this.preWarmCycles){for(let o=0;o<this.preWarmCycles;o++)this.animate(!0),this.render(!0,!0);this._preWarmDone=!0}if(this._currentRenderId===this._scene.getFrameId()&&(!this._scene.activeCamera||this._scene.activeCamera&&this._currentRenderingCameraUniqueId===this._scene.activeCamera.uniqueId))return 0;this._currentRenderId=this._scene.getFrameId(),this._scene.activeCamera&&(this._currentRenderingCameraUniqueId=this._scene.activeCamera.uniqueId)}if(this._initialize(),this._accumulatedCount+=this.emitRate*this._timeDelta,this._accumulatedCount>1){const o=this._accumulatedCount|0;this._accumulatedCount-=o,this._currentActiveCount=Math.min(this._activeCount,this._currentActiveCount+o)}if(!this._currentActiveCount)return 0;let i;if(this.emitter.position)i=this.emitter.getWorldMatrix();else{const o=this.emitter;i=L.Translation(o.x,o.y,o.z)}const s=this._engine;this._platform.preUpdateParticleBuffer(),this._updateBuffer.setFloat("currentCount",this._currentActiveCount),this._updateBuffer.setFloat("timeDelta",this._timeDelta),this._updateBuffer.setFloat("stopFactor",this._stopped?0:1),this._updateBuffer.setInt("randomTextureSize",this._randomTextureSize),this._updateBuffer.setFloat2("lifeTime",this.minLifeTime,this.maxLifeTime),this._updateBuffer.setFloat2("emitPower",this.minEmitPower,this.maxEmitPower),this._colorGradientsTexture||(this._updateBuffer.setDirectColor4("color1",this.color1),this._updateBuffer.setDirectColor4("color2",this.color2)),this._updateBuffer.setFloat2("sizeRange",this.minSize,this.maxSize),this._updateBuffer.setFloat4("scaleRange",this.minScaleX,this.maxScaleX,this.minScaleY,this.maxScaleY),this._updateBuffer.setFloat4("angleRange",this.minAngularSpeed,this.maxAngularSpeed,this.minInitialRotation,this.maxInitialRotation),this._updateBuffer.setVector3("gravity",this.gravity),this._limitVelocityGradientsTexture&&this._updateBuffer.setFloat("limitVelocityDamping",this.limitVelocityDamping),this.particleEmitterType&&this.particleEmitterType.applyToShader(this._updateBuffer),this._isAnimationSheetEnabled&&this._updateBuffer.setFloat4("cellInfos",this.startSpriteCellID,this.endSpriteCellID,this.spriteCellChangeSpeed,this.spriteCellLoop?1:0),this.noiseTexture&&this._updateBuffer.setVector3("noiseStrength",this.noiseStrength),this.isLocal||this._updateBuffer.setMatrix("emitterWM",i),this._platform.updateParticleBuffer(this._targetIndex,this._targetBuffer,this._currentActiveCount);let r=0;!e&&!t&&(s.setState(!1),this.forceDepthWrite&&s.setDepthWrite(!0),this.blendMode===et.BLENDMODE_MULTIPLYADD?r=this._render(et.BLENDMODE_MULTIPLY,i)+this._render(et.BLENDMODE_ADD,i):r=this._render(this.blendMode,i),this._engine.setAlphaMode(0)),this._targetIndex++,this._targetIndex===2&&(this._targetIndex=0);const n=this._sourceBuffer;return this._sourceBuffer=this._targetBuffer,this._targetBuffer=n,r}rebuild(){this._initialize(!0)}_releaseBuffers(){this._buffer0&&(this._buffer0.dispose(),this._buffer0=null),this._buffer1&&(this._buffer1.dispose(),this._buffer1=null),this._spriteBuffer&&(this._spriteBuffer.dispose(),this._spriteBuffer=null),this._platform.releaseBuffers()}dispose(e=!0){for(const t in this._drawWrappers)this._drawWrappers[t].dispose();if(this._drawWrappers={},this._scene){const t=this._scene.particleSystems.indexOf(this);t>-1&&this._scene.particleSystems.splice(t,1)}this._releaseBuffers(),this._platform.releaseVertexBuffers(),this._colorGradientsTexture&&(this._colorGradientsTexture.dispose(),this._colorGradientsTexture=null),this._sizeGradientsTexture&&(this._sizeGradientsTexture.dispose(),this._sizeGradientsTexture=null),this._angularSpeedGradientsTexture&&(this._angularSpeedGradientsTexture.dispose(),this._angularSpeedGradientsTexture=null),this._velocityGradientsTexture&&(this._velocityGradientsTexture.dispose(),this._velocityGradientsTexture=null),this._limitVelocityGradientsTexture&&(this._limitVelocityGradientsTexture.dispose(),this._limitVelocityGradientsTexture=null),this._dragGradientsTexture&&(this._dragGradientsTexture.dispose(),this._dragGradientsTexture=null),this._randomTexture&&(this._randomTexture.dispose(),this._randomTexture=null),this._randomTexture2&&(this._randomTexture2.dispose(),this._randomTexture2=null),e&&this.particleTexture&&(this.particleTexture.dispose(),this.particleTexture=null),e&&this.noiseTexture&&(this.noiseTexture.dispose(),this.noiseTexture=null),this.onStoppedObservable.clear(),this.onDisposeObservable.notifyObservers(this),this.onDisposeObservable.clear()}clone(e,t){const i={...this._customWrappers};let s=null;const r=this._engine;if(r.createEffectForParticles&&this.customShader!=null){s=this.customShader;const l=s.shaderOptions.defines.length>0?s.shaderOptions.defines.join(`
`):"";i[0]=r.createEffectForParticles(s.shaderPath.fragmentElement,s.shaderOptions.uniforms,s.shaderOptions.samplers,l,void 0,void 0,void 0,this)}const n=this.serialize(),o=_o.Parse(n,this._scene||this._engine,this._rootUrl);return o.name=e,o.customShader=s,o._customWrappers=i,t===void 0&&(t=this.emitter),this.noiseTexture&&(o.noiseTexture=this.noiseTexture.clone()),o.emitter=t,o}serialize(e=!1){const t={};return et._Serialize(t,this,e),t.activeParticleCount=this.activeParticleCount,t.randomTextureSize=this._randomTextureSize,t.customShader=this.customShader,t}static Parse(e,t,i,s=!1,r){const n=e.name;let o,l;t instanceof Te?o=t:(l=t,o=l.getEngine());const h=new _o(n,{capacity:r||e.capacity,randomTextureSize:e.randomTextureSize},t,null,e.isAnimationSheetEnabled);if(h._rootUrl=i,e.customShader&&o.createEffectForParticles){const c=e.customShader,u=c.shaderOptions.defines.length>0?c.shaderOptions.defines.join(`
`):"",d=o.createEffectForParticles(c.shaderPath.fragmentElement,c.shaderOptions.uniforms,c.shaderOptions.samplers,u,void 0,void 0,void 0,h);h.setCustomEffect(d,0),h.customShader=c}return e.id&&(h.id=e.id),e.activeParticleCount&&(h.activeParticleCount=e.activeParticleCount),et._Parse(e,h,t,i),e.preventAutoStart&&(h.preventAutoStart=e.preventAutoStart),!s&&!h.preventAutoStart&&h.start(),h}}li.AddParser(ue.NAME_PARTICLESYSTEM,(a,e,t,i)=>{const s=li.GetIndividualParser(ue.NAME_PARTICLESYSTEM);if(!!s&&a.particleSystems!==void 0&&a.particleSystems!==null)for(let r=0,n=a.particleSystems.length;r<n;r++){const o=a.particleSystems[r];t.particleSystems.push(s(o,e,i))}});li.AddIndividualParser(ue.NAME_PARTICLESYSTEM,(a,e,t)=>a.activeParticleCount?_o.Parse(a,e,t):et.Parse(a,e,t));k.prototype.createEffectForParticles=function(a,e=[],t=[],i="",s,r,n,o){var l;let h=[],c=[];const u=[];return o?o.fillUniformsAttributesAndSamplerNames(c,h,u):(h=et._GetAttributeNamesOrOptions(),c=et._GetEffectCreationOptions()),i.indexOf(" BILLBOARD")===-1&&(i+=`
#define BILLBOARD
`),t.indexOf("diffuseSampler")===-1&&t.push("diffuseSampler"),this.createEffect({vertex:(l=o==null?void 0:o.vertexShaderName)!==null&&l!==void 0?l:"particles",fragmentElement:a},h,c.concat(e),u.concat(t),i,s,r,n)};V.prototype.getEmittedParticleSystems=function(){const a=new Array;for(let e=0;e<this.getScene().particleSystems.length;e++){const t=this.getScene().particleSystems[e];t.emitter===this&&a.push(t)}return a};V.prototype.getHierarchyEmittedParticleSystems=function(){const a=new Array,e=this.getDescendants();e.push(this);for(let t=0;t<this.getScene().particleSystems.length;t++){const i=this.getScene().particleSystems[t],s=i.emitter;s.position&&e.indexOf(s)!==-1&&a.push(i)}return a};class oP{constructor(e,t,i,s,r){this.idx=0,this.color=new J(1,1,1,1),this.position=g.Zero(),this.rotation=g.Zero(),this.uv=new le(0,0),this.velocity=g.Zero(),this.pivot=g.Zero(),this.translateFromPivot=!1,this._pos=0,this._ind=0,this.groupId=0,this.idxInGroup=0,this._stillInvisible=!1,this._rotationMatrix=[1,0,0,0,1,0,0,0,1],this.parentId=null,this._globalPosition=g.Zero(),this.idx=e,this._group=t,this.groupId=i,this.idxInGroup=s,this._pcs=r}get size(){return this.size}set size(e){this.size=e}get quaternion(){return this.rotationQuaternion}set quaternion(e){this.rotationQuaternion=e}intersectsMesh(e,t){if(!e.hasBoundingInfo)return!1;if(!this._pcs.mesh)throw new Error("Point Cloud System doesnt contain the Mesh");if(t)return e.getBoundingInfo().boundingSphere.intersectsPoint(this.position.add(this._pcs.mesh.position));const i=e.getBoundingInfo().boundingBox,s=i.maximumWorld.x,r=i.minimumWorld.x,n=i.maximumWorld.y,o=i.minimumWorld.y,l=i.maximumWorld.z,h=i.minimumWorld.z,c=this.position.x+this._pcs.mesh.position.x,u=this.position.y+this._pcs.mesh.position.y,d=this.position.z+this._pcs.mesh.position.z;return r<=c&&c<=s&&o<=u&&u<=n&&h<=d&&d<=l}getRotationMatrix(e){let t;if(this.rotationQuaternion)t=this.rotationQuaternion;else{t=G.Quaternion[0];const i=this.rotation;Q.RotationYawPitchRollToRef(i.y,i.x,i.z,t)}t.toRotationMatrix(e)}}class Uu{constructor(e,t){this.groupId=e,this._positionFunction=t}get groupID(){return this.groupId}set groupID(e){this.groupId=e}}var gs;(function(a){a[a.Color=2]="Color",a[a.UV=1]="UV",a[a.Random=0]="Random",a[a.Stated=3]="Stated"})(gs||(gs={}));class lP{constructor(e,t,i,s){this.particles=new Array,this.nbParticles=0,this.counter=0,this.vars={},this._promises=[],this._positions=new Array,this._indices=new Array,this._normals=new Array,this._colors=new Array,this._uvs=new Array,this._updatable=!0,this._isVisibilityBoxLocked=!1,this._alwaysVisible=!1,this._groups=new Array,this._groupCounter=0,this._computeParticleColor=!0,this._computeParticleTexture=!0,this._computeParticleRotation=!0,this._computeBoundingBox=!1,this._isReady=!1,this.name=e,this._size=t,this._scene=i||ye.LastCreatedScene,s&&s.updatable!==void 0?this._updatable=s.updatable:this._updatable=!0}get positions(){return this._positions32}get colors(){return this._colors32}get uvs(){return this._uvs32}buildMeshAsync(e){return Promise.all(this._promises).then(()=>(this._isReady=!0,this._buildMesh(e)))}_buildMesh(e){this.nbParticles===0&&this.addPoints(1),this._positions32=new Float32Array(this._positions),this._uvs32=new Float32Array(this._uvs),this._colors32=new Float32Array(this._colors);const t=new de;t.set(this._positions32,y.PositionKind),this._uvs32.length>0&&t.set(this._uvs32,y.UVKind);let i=0;this._colors32.length>0&&(i=1,t.set(this._colors32,y.ColorKind));const s=new V(this.name,this._scene);t.applyToMesh(s,this._updatable),this.mesh=s,this._positions=null,this._uvs=null,this._colors=null,this._updatable||(this.particles.length=0);let r=e;return r||(r=new pe("point cloud material",this._scene),r.emissiveColor=new re(i,i,i),r.disableLighting=!0,r.pointsCloud=!0,r.pointSize=this._size),s.material=r,new Promise(n=>n(s))}_addParticle(e,t,i,s){const r=new oP(e,t,i,s,this);return this.particles.push(r),r}_randomUnitVector(e){e.position=new g(Math.random(),Math.random(),Math.random()),e.color=new J(1,1,1,1)}_getColorIndicesForCoord(e,t,i,s){const r=e._groupImageData,n=i*(s*4)+t*4,o=[n,n+1,n+2,n+3],l=o[0],h=o[1],c=o[2],u=o[3],d=r[l],f=r[h],p=r[c],_=r[u];return new J(d/255,f/255,p/255,_)}_setPointsColorOrUV(e,t,i,s,r,n,o){i&&e.updateFacetData();const l=e.getBoundingInfo(),h=2*l.boundingSphere.radius;let c=e.getVerticesData(y.PositionKind);const u=e.getIndices(),d=e.getVerticesData(y.UVKind),f=e.getVerticesData(y.ColorKind),p=g.Zero();e.computeWorldMatrix();const _=e.getWorldMatrix();if(!_.isIdentity()){c=c.slice(0);for(let ds=0;ds<c.length/3;ds++)g.TransformCoordinatesFromFloatsToRef(c[3*ds],c[3*ds+1],c[3*ds+2],_,p),c[3*ds]=p.x,c[3*ds+1]=p.y,c[3*ds+2]=p.z}let m=0,v=0,x=0,b=0,S=0,C=0,E=0,A=0,M=0,D=0,P=0,O=0,N=0;const $=g.Zero(),W=g.Zero(),K=g.Zero(),te=g.Zero(),ve=g.Zero();let _e=0,j=0,ee=0,F=0,z=0,Z=0;const Ee=le.Zero(),He=le.Zero(),ut=le.Zero(),me=le.Zero(),Se=le.Zero();let it=0,Zt=0,Xe=0,Re=0,rt=0,xt=0,At=0,Ut=0,ms=0,wi=0,Tr=0,jt=0;const Rs=Ge.Zero(),Ls=Ge.Zero(),or=Ge.Zero(),Hs=Ge.Zero(),us=Ge.Zero();let Ni=0,$i=0;o=o||0;let is,br,kt=new Ge(0,0,0,0),_u=g.Zero(),mu=g.Zero(),M0=g.Zero(),qa=0,D0=g.Zero(),O0=0,w0=0;const lh=new $e(g.Zero(),new g(1,0,0));let gu,hh=g.Zero();for(let ds=0;ds<u.length/3;ds++){v=u[3*ds],x=u[3*ds+1],b=u[3*ds+2],S=c[3*v],C=c[3*v+1],E=c[3*v+2],A=c[3*x],M=c[3*x+1],D=c[3*x+2],P=c[3*b],O=c[3*b+1],N=c[3*b+2],$.set(S,C,E),W.set(A,M,D),K.set(P,O,N),W.subtractToRef($,te),K.subtractToRef(W,ve),d&&(_e=d[2*v],j=d[2*v+1],ee=d[2*x],F=d[2*x+1],z=d[2*b],Z=d[2*b+1],Ee.set(_e,j),He.set(ee,F),ut.set(z,Z),He.subtractToRef(Ee,me),ut.subtractToRef(He,Se)),f&&s&&(it=f[4*v],Zt=f[4*v+1],Xe=f[4*v+2],Re=f[4*v+3],rt=f[4*x],xt=f[4*x+1],At=f[4*x+2],Ut=f[4*x+3],ms=f[4*b],wi=f[4*b+1],Tr=f[4*b+2],jt=f[4*b+3],Rs.set(it,Zt,Xe,Re),Ls.set(rt,xt,At,Ut),or.set(ms,wi,Tr,jt),Ls.subtractToRef(Rs,Hs),or.subtractToRef(Ls,us));let vu,N0,F0,L0,B0,Qa,Za,ch;const U0=new re(0,0,0),uh=new re(0,0,0);let Ja,lr;for(let xu=0;xu<t._groupDensity[ds];xu++)m=this.particles.length,this._addParticle(m,t,this._groupCounter,ds+xu),lr=this.particles[m],Ni=oe.RandomRange(0,1),$i=oe.RandomRange(0,1),is=$.add(te.scale(Ni)).add(ve.scale(Ni*$i)),i&&(_u=e.getFacetNormal(ds).normalize().scale(-1),mu=te.clone().normalize(),M0=g.Cross(_u,mu),qa=oe.RandomRange(0,2*Math.PI),D0=mu.scale(Math.cos(qa)).add(M0.scale(Math.sin(qa))),qa=oe.RandomRange(.1,Math.PI/2),hh=D0.scale(Math.cos(qa)).add(_u.scale(Math.sin(qa))),lh.origin=is.add(hh.scale(1e-5)),lh.direction=hh,lh.length=h,gu=lh.intersectsMesh(e),gu.hit&&(w0=gu.pickedPoint.subtract(is).length(),O0=oe.RandomRange(0,1)*w0,is.addInPlace(hh.scale(O0)))),lr.position=is.clone(),this._positions.push(lr.position.x,lr.position.y,lr.position.z),s!==void 0?d&&(br=Ee.add(me.scale(Ni)).add(Se.scale(Ni*$i)),s?r&&t._groupImageData!==null?(vu=t._groupImgWidth,N0=t._groupImgHeight,Ja=this._getColorIndicesForCoord(t,Math.round(br.x*vu),Math.round(br.y*N0),vu),lr.color=Ja,this._colors.push(Ja.r,Ja.g,Ja.b,Ja.a)):f?(kt=Rs.add(Hs.scale(Ni)).add(us.scale(Ni*$i)),lr.color=new J(kt.x,kt.y,kt.z,kt.w),this._colors.push(kt.x,kt.y,kt.z,kt.w)):(kt=Rs.set(Math.random(),Math.random(),Math.random(),1),lr.color=new J(kt.x,kt.y,kt.z,kt.w),this._colors.push(kt.x,kt.y,kt.z,kt.w)):(lr.uv=br.clone(),this._uvs.push(lr.uv.x,lr.uv.y))):(n?(U0.set(n.r,n.g,n.b),F0=oe.RandomRange(-o,o),L0=oe.RandomRange(-o,o),ch=U0.toHSV(),B0=ch.r,Qa=ch.g+F0,Za=ch.b+L0,Qa<0&&(Qa=0),Qa>1&&(Qa=1),Za<0&&(Za=0),Za>1&&(Za=1),re.HSVtoRGBToRef(B0,Qa,Za,uh),kt.set(uh.r,uh.g,uh.b,1)):kt=Rs.set(Math.random(),Math.random(),Math.random(),1),lr.color=new J(kt.x,kt.y,kt.z,kt.w),this._colors.push(kt.x,kt.y,kt.z,kt.w))}}_colorFromTexture(e,t,i){if(e.material===null){B.Warn(e.name+"has no material."),t._groupImageData=null,this._setPointsColorOrUV(e,t,i,!0,!1);return}const r=e.material.getActiveTextures();if(r.length===0){B.Warn(e.name+"has no usable texture."),t._groupImageData=null,this._setPointsColorOrUV(e,t,i,!0,!1);return}const n=e.clone();n.setEnabled(!1),this._promises.push(new Promise(o=>{dt.WhenAllReady(r,()=>{let l=t._textureNb;l<0&&(l=0),l>r.length-1&&(l=r.length-1);const h=()=>{t._groupImgWidth=r[l].getSize().width,t._groupImgHeight=r[l].getSize().height,this._setPointsColorOrUV(n,t,i,!0,!0),n.dispose(),o()};t._groupImageData=null;const c=r[l].readPixels();c?c.then(u=>{t._groupImageData=u,h()}):h()})}))}_calculateDensity(e,t,i){let s=new Array,r,n,o,l,h,c,u,d,f,p,_,m;const v=g.Zero(),x=g.Zero(),b=g.Zero(),S=g.Zero(),C=g.Zero(),E=g.Zero();let A,M,D,P,O;const N=new Array;let $=0;const W=i.length/3;for(let j=0;j<W;j++)r=i[3*j],n=i[3*j+1],o=i[3*j+2],l=t[3*r],h=t[3*r+1],c=t[3*r+2],u=t[3*n],d=t[3*n+1],f=t[3*n+2],p=t[3*o],_=t[3*o+1],m=t[3*o+2],v.set(l,h,c),x.set(u,d,f),b.set(p,_,m),x.subtractToRef(v,S),b.subtractToRef(x,C),b.subtractToRef(v,E),A=S.length(),M=C.length(),D=E.length(),P=(A+M+D)/2,O=Math.sqrt(P*(P-A)*(P-M)*(P-D)),$+=O,N[j]=O;let K=0;for(let j=0;j<W;j++)s[j]=Math.floor(e*N[j]/$),K+=s[j];const te=e-K,ve=Math.floor(te/W),_e=te%W;ve>0&&(s=s.map(j=>j+ve));for(let j=0;j<_e;j++)s[j]+=1;return s}addPoints(e,t=this._randomUnitVector){const i=new Uu(this._groupCounter,t);let s,r=this.nbParticles;for(let n=0;n<e;n++)s=this._addParticle(r,i,this._groupCounter,n),i&&i._positionFunction&&i._positionFunction(s,r,n),this._positions.push(s.position.x,s.position.y,s.position.z),s.color&&this._colors.push(s.color.r,s.color.g,s.color.b,s.color.a),s.uv&&this._uvs.push(s.uv.x,s.uv.y),r++;return this.nbParticles+=e,this._groupCounter++,this._groupCounter}addSurfacePoints(e,t,i,s,r){let n=i||gs.Random;(isNaN(n)||n<0||n>3)&&(n=gs.Random);const o=e.getVerticesData(y.PositionKind),l=e.getIndices();this._groups.push(this._groupCounter);const h=new Uu(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(t,o,l),n===gs.Color?h._textureNb=s||0:s=s||new J(1,1,1,1),n){case gs.Color:this._colorFromTexture(e,h,!1);break;case gs.UV:this._setPointsColorOrUV(e,h,!1,!1,!1);break;case gs.Random:this._setPointsColorOrUV(e,h,!1);break;case gs.Stated:this._setPointsColorOrUV(e,h,!1,void 0,void 0,s,r);break}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}addVolumePoints(e,t,i,s,r){let n=i||gs.Random;(isNaN(n)||n<0||n>3)&&(n=gs.Random);const o=e.getVerticesData(y.PositionKind),l=e.getIndices();this._groups.push(this._groupCounter);const h=new Uu(this._groupCounter,null);switch(h._groupDensity=this._calculateDensity(t,o,l),n===gs.Color?h._textureNb=s||0:s=s||new J(1,1,1,1),n){case gs.Color:this._colorFromTexture(e,h,!0);break;case gs.UV:this._setPointsColorOrUV(e,h,!0,!1,!1);break;case gs.Random:this._setPointsColorOrUV(e,h,!0);break;case gs.Stated:this._setPointsColorOrUV(e,h,!0,void 0,void 0,s,r);break}return this.nbParticles+=t,this._groupCounter++,this._groupCounter-1}setParticles(e=0,t=this.nbParticles-1,i=!0){var s,r;if(!this._updatable||!this._isReady)return this;this.beforeUpdateParticles(e,t,i);const n=G.Matrix[0],o=this.mesh,l=this._colors32,h=this._positions32,c=this._uvs32,u=G.Vector3,d=u[5].copyFromFloats(1,0,0),f=u[6].copyFromFloats(0,1,0),p=u[7].copyFromFloats(0,0,1),_=u[8].setAll(Number.MAX_VALUE),m=u[9].setAll(-Number.MAX_VALUE);L.IdentityToRef(n);let v=0;if(!((s=this.mesh)===null||s===void 0)&&s.isFacetDataEnabled&&(this._computeBoundingBox=!0),t=t>=this.nbParticles?this.nbParticles-1:t,this._computeBoundingBox&&(e!=0||t!=this.nbParticles-1)){const C=(r=this.mesh)===null||r===void 0?void 0:r.getBoundingInfo();C&&(_.copyFrom(C.minimum),m.copyFrom(C.maximum))}v=0;let x=0,b=0,S=0;for(let C=e;C<=t;C++){const E=this.particles[C];v=E.idx,x=3*v,b=4*v,S=2*v,this.updateParticle(E);const A=E._rotationMatrix,M=E.position,D=E._globalPosition;if(this._computeParticleRotation&&E.getRotationMatrix(n),E.parentId!==null){const z=this.particles[E.parentId],Z=z._rotationMatrix,Ee=z._globalPosition,He=M.x*Z[1]+M.y*Z[4]+M.z*Z[7],ut=M.x*Z[0]+M.y*Z[3]+M.z*Z[6],me=M.x*Z[2]+M.y*Z[5]+M.z*Z[8];if(D.x=Ee.x+ut,D.y=Ee.y+He,D.z=Ee.z+me,this._computeParticleRotation){const Se=n.m;A[0]=Se[0]*Z[0]+Se[1]*Z[3]+Se[2]*Z[6],A[1]=Se[0]*Z[1]+Se[1]*Z[4]+Se[2]*Z[7],A[2]=Se[0]*Z[2]+Se[1]*Z[5]+Se[2]*Z[8],A[3]=Se[4]*Z[0]+Se[5]*Z[3]+Se[6]*Z[6],A[4]=Se[4]*Z[1]+Se[5]*Z[4]+Se[6]*Z[7],A[5]=Se[4]*Z[2]+Se[5]*Z[5]+Se[6]*Z[8],A[6]=Se[8]*Z[0]+Se[9]*Z[3]+Se[10]*Z[6],A[7]=Se[8]*Z[1]+Se[9]*Z[4]+Se[10]*Z[7],A[8]=Se[8]*Z[2]+Se[9]*Z[5]+Se[10]*Z[8]}}else if(D.x=0,D.y=0,D.z=0,this._computeParticleRotation){const z=n.m;A[0]=z[0],A[1]=z[1],A[2]=z[2],A[3]=z[4],A[4]=z[5],A[5]=z[6],A[6]=z[8],A[7]=z[9],A[8]=z[10]}const O=u[11];E.translateFromPivot?O.setAll(0):O.copyFrom(E.pivot);const N=u[0];N.copyFrom(E.position);const $=N.x-E.pivot.x,W=N.y-E.pivot.y,K=N.z-E.pivot.z;let te=$*A[0]+W*A[3]+K*A[6],ve=$*A[1]+W*A[4]+K*A[7],_e=$*A[2]+W*A[5]+K*A[8];te+=O.x,ve+=O.y,_e+=O.z;const j=h[x]=D.x+d.x*te+f.x*ve+p.x*_e,ee=h[x+1]=D.y+d.y*te+f.y*ve+p.y*_e,F=h[x+2]=D.z+d.z*te+f.z*ve+p.z*_e;if(this._computeBoundingBox&&(_.minimizeInPlaceFromFloats(j,ee,F),m.maximizeInPlaceFromFloats(j,ee,F)),this._computeParticleColor&&E.color){const z=E.color,Z=this._colors32;Z[b]=z.r,Z[b+1]=z.g,Z[b+2]=z.b,Z[b+3]=z.a}if(this._computeParticleTexture&&E.uv){const z=E.uv,Z=this._uvs32;Z[S]=z.x,Z[S+1]=z.y}}return o&&(i&&(this._computeParticleColor&&o.updateVerticesData(y.ColorKind,l,!1,!1),this._computeParticleTexture&&o.updateVerticesData(y.UVKind,c,!1,!1),o.updateVerticesData(y.PositionKind,h,!1,!1)),this._computeBoundingBox&&(o.hasBoundingInfo?o.getBoundingInfo().reConstruct(_,m,o._worldMatrix):o.buildBoundingInfo(_,m,o._worldMatrix))),this.afterUpdateParticles(e,t,i),this}dispose(){var e;(e=this.mesh)===null||e===void 0||e.dispose(),this.vars=null,this._positions=null,this._indices=null,this._normals=null,this._uvs=null,this._colors=null,this._indices32=null,this._positions32=null,this._uvs32=null,this._colors32=null}refreshVisibleSize(){var e;return this._isVisibilityBoxLocked||(e=this.mesh)===null||e===void 0||e.refreshBoundingInfo(),this}setVisibilityBox(e){if(!this.mesh)return;const t=e/2;this.mesh.buildBoundingInfo(new g(-t,-t,-t),new g(t,t,t))}get isAlwaysVisible(){return this._alwaysVisible}set isAlwaysVisible(e){!this.mesh||(this._alwaysVisible=e,this.mesh.alwaysSelectAsActiveMesh=e)}set computeParticleRotation(e){this._computeParticleRotation=e}set computeParticleColor(e){this._computeParticleColor=e}set computeParticleTexture(e){this._computeParticleTexture=e}get computeParticleColor(){return this._computeParticleColor}get computeParticleTexture(){return this._computeParticleTexture}set computeBoundingBox(e){this._computeBoundingBox=e}get computeBoundingBox(){return this._computeBoundingBox}initParticles(){}recycleParticle(e){return e}updateParticle(e){return e}beforeUpdateParticles(e,t,i){}afterUpdateParticles(e,t,i){}}ge.prototype.getPhysicsEngine=function(){return this._physicsEngine};ge.prototype.enablePhysics=function(a=null,e){if(this._physicsEngine)return!0;let t=this._getComponent(ue.NAME_PHYSICSENGINE);t||(t=new hP(this),this._addComponent(t));try{return this._physicsEngine=new oa(a,e),this._physicsTimeAccumulator=0,!0}catch(i){return B.Error(i.message),!1}};ge.prototype.disablePhysicsEngine=function(){!this._physicsEngine||(this._physicsEngine.dispose(),this._physicsEngine=null)};ge.prototype.isPhysicsEnabled=function(){return this._physicsEngine!==void 0};ge.prototype.deleteCompoundImpostor=function(a){const e=a.parts[0].mesh;e.physicsImpostor&&(e.physicsImpostor.dispose(),e.physicsImpostor=null)};ge.prototype._advancePhysicsEngineStep=function(a){if(this._physicsEngine){const e=this._physicsEngine.getSubTimeStep();if(e>0)for(this._physicsTimeAccumulator+=a;this._physicsTimeAccumulator>e;)this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(e/1e3),this.onAfterPhysicsObservable.notifyObservers(this),this._physicsTimeAccumulator-=e;else this.onBeforePhysicsObservable.notifyObservers(this),this._physicsEngine._step(a/1e3),this.onAfterPhysicsObservable.notifyObservers(this)}};Object.defineProperty(ct.prototype,"physicsImpostor",{get:function(){return this._physicsImpostor},set:function(a){this._physicsImpostor!==a&&(this._disposePhysicsObserver&&this.onDisposeObservable.remove(this._disposePhysicsObserver),this._physicsImpostor=a,a&&(this._disposePhysicsObserver=this.onDisposeObservable.add(()=>{this.physicsImpostor&&(this.physicsImpostor.dispose(),this.physicsImpostor=null)})))},enumerable:!0,configurable:!0});ct.prototype.getPhysicsImpostor=function(){return this.physicsImpostor};ct.prototype.applyImpulse=function(a,e){return this.physicsImpostor?(this.physicsImpostor.applyImpulse(a,e),this):this};ct.prototype.setPhysicsLinkWith=function(a,e,t,i){return!this.physicsImpostor||!a.physicsImpostor?this:(this.physicsImpostor.createJoint(a.physicsImpostor,Nt.HingeJoint,{mainPivot:e,connectedPivot:t,nativeParams:i}),this)};class hP{constructor(e){this.name=ue.NAME_PHYSICSENGINE,this.scene=e,this.scene.onBeforePhysicsObservable=new X,this.scene.onAfterPhysicsObservable=new X,this.scene.getDeterministicFrameTime=()=>this.scene._physicsEngine?this.scene._physicsEngine.getTimeStep()*1e3:1e3/60}register(){}rebuild(){}dispose(){this.scene.onBeforePhysicsObservable.clear(),this.scene.onAfterPhysicsObservable.clear(),this.scene._physicsEngine&&this.scene.disablePhysicsEngine()}}var lp;(function(a){a[a.Constant=0]="Constant",a[a.Linear=1]="Linear"})(lp||(lp={}));var hp;(function(a){a[a.Center=0]="Center",a[a.Perpendicular=1]="Perpendicular"})(hp||(hp={}));const cP="blackAndWhitePixelShader",uP=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float degree;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec3 color=texture2D(textureSampler,vUV).rgb;
float luminance=dot(color,vec3(0.3,0.59,0.11)); 
vec3 blackAndWhite=vec3(luminance,luminance,luminance);
gl_FragColor=vec4(color-((color-blackAndWhite)*degree),1.0);
}`;Y.ShadersStore[cP]=uP;class au extends Fe{constructor(e,t,i,s,r,n){super(e,"blackAndWhite",["degree"],null,t,i,s,r,n),this.degree=1,this.onApplyObservable.add(o=>{o.setFloat("degree",this.degree)})}getClassName(){return"BlackAndWhitePostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new au(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}T([R()],au.prototype,"degree",void 0);he("BABYLON.BlackAndWhitePostProcess",au);class bt{constructor(e,t,i,s){this._name=t,this._singleInstance=s||!0,this._getPostProcesses=i,this._cameras={},this._indicesForCamera={},this._postProcesses={}}get isSupported(){for(const e in this._postProcesses)if(Object.prototype.hasOwnProperty.call(this._postProcesses,e)){const t=this._postProcesses[e];for(let i=0;i<t.length;i++)if(!t[i].isSupported)return!1}return!0}_update(){}_attachCameras(e){let t;const i=q.MakeArray(e||this._cameras);if(!!i)for(let s=0;s<i.length;s++){const r=i[s];if(!r)continue;const n=r.name;if(this._singleInstance?t=0:t=n,!this._postProcesses[t]){const o=this._getPostProcesses();o&&(this._postProcesses[t]=Array.isArray(o)?o:[o])}this._indicesForCamera[n]||(this._indicesForCamera[n]=[]),this._postProcesses[t].forEach(o=>{const l=r.attachPostProcess(o);this._indicesForCamera[n].push(l)}),this._cameras[n]||(this._cameras[n]=r)}}_detachCameras(e){const t=q.MakeArray(e||this._cameras);if(!!t)for(let i=0;i<t.length;i++){const s=t[i],r=s.name,n=this._postProcesses[this._singleInstance?0:r];n&&n.forEach(o=>{s.detachPostProcess(o)}),this._cameras[r]&&(this._cameras[r]=null)}}_enable(e){const t=q.MakeArray(e||this._cameras);if(!!t)for(let i=0;i<t.length;i++){const s=t[i],r=s.name;for(let n=0;n<this._indicesForCamera[r].length;n++)(s._postProcesses[this._indicesForCamera[r][n]]===void 0||s._postProcesses[this._indicesForCamera[r][n]]===null)&&this._postProcesses[this._singleInstance?0:r].forEach(o=>{t[i].attachPostProcess(o,this._indicesForCamera[r][n])})}}_disable(e){const t=q.MakeArray(e||this._cameras);if(!!t)for(let i=0;i<t.length;i++){const s=t[i],r=s.name;this._postProcesses[this._singleInstance?0:r].forEach(n=>{s.detachPostProcess(n)})}}getPostProcesses(e){return this._singleInstance?this._postProcesses[0]:e?this._postProcesses[e.name]:null}}const dP="extractHighlightsPixelShader",fP=`#include<helperFunctions>
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float threshold;
uniform float exposure;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
gl_FragColor=texture2D(textureSampler,vUV);
float luma=dot(LuminanceEncodeApprox,gl_FragColor.rgb*exposure);
gl_FragColor.rgb=step(threshold,luma)*gl_FragColor.rgb;
}`;Y.ShadersStore[dP]=fP;class v0 extends Fe{constructor(e,t,i,s,r,n,o=0,l=!1){super(e,"extractHighlights",["threshold","exposure"],null,t,i,s,r,n,null,o,void 0,null,l),this.threshold=.9,this._exposure=1,this._inputPostProcess=null,this.onApplyObservable.add(h=>{this.externalTextureSamplerBinding=!!this._inputPostProcess,this._inputPostProcess&&h.setTextureFromPostProcess("textureSampler",this._inputPostProcess),h.setFloat("threshold",Math.pow(this.threshold,Wr)),h.setFloat("exposure",this._exposure)})}getClassName(){return"ExtractHighlightsPostProcess"}}T([R()],v0.prototype,"threshold",void 0);he("BABYLON.ExtractHighlightsPostProcess",v0);const pP="bloomMergePixelShader",_P=`uniform sampler2D textureSampler;
uniform sampler2D bloomBlur;
varying vec2 vUV;
uniform float bloomWeight;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec3 blurred=texture2D(bloomBlur,vUV).rgb;
gl_FragColor.rgb=gl_FragColor.rgb+(blurred.rgb*bloomWeight); 
}
`;Y.ShadersStore[pP]=_P;class x0 extends Fe{constructor(e,t,i,s,r,n,o,l,h,c=0,u=!1){super(e,"bloomMerge",["bloomWeight"],["bloomBlur"],r,n,o,l,h,null,c,void 0,null,!0),this.weight=1,this.weight=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("bloomBlur",i),d.setFloat("bloomWeight",this.weight)}),u||this.updateEffect()}getClassName(){return"BloomMergePostProcess"}}T([R()],x0.prototype,"weight",void 0);he("BABYLON.BloomMergePostProcess",x0);class cp extends bt{constructor(e,t,i,s,r=0,n=!1){super(e.getEngine(),"bloom",()=>this._effects,!0),this._bloomScale=t,this._effects=[],this._downscale=new v0("highlights",1,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,n),this._blurX=new Ei("horizontal blur",new le(1,0),10,t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,void 0,n),this._blurX.alwaysForcePOT=!0,this._blurX.autoClear=!1,this._blurY=new Ei("vertical blur",new le(0,1),10,t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,void 0,n),this._blurY.alwaysForcePOT=!0,this._blurY.autoClear=!1,this.kernel=s,this._effects=[this._downscale,this._blurX,this._blurY],this._merge=new x0("bloomMerge",this._downscale,this._blurY,i,t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,r,n),this._merge.autoClear=!1,this._effects.push(this._merge)}get threshold(){return this._downscale.threshold}set threshold(e){this._downscale.threshold=e}get weight(){return this._merge.weight}set weight(e){this._merge.weight=e}get kernel(){return this._blurX.kernel/this._bloomScale}set kernel(e){this._blurX.kernel=e*this._bloomScale,this._blurY.kernel=e*this._bloomScale}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}const mP="chromaticAberrationPixelShader",gP=`uniform sampler2D textureSampler; 
uniform float chromatic_aberration;
uniform float radialIntensity;
uniform vec2 direction;
uniform vec2 centerPosition;
uniform float screen_width;
uniform float screen_height;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 centered_screen_pos=vec2(vUV.x-centerPosition.x,vUV.y-centerPosition.y);
vec2 directionOfEffect=direction;
if(directionOfEffect.x==0. && directionOfEffect.y==0.){
directionOfEffect=normalize(centered_screen_pos);
}
float radius2=centered_screen_pos.x*centered_screen_pos.x
+ centered_screen_pos.y*centered_screen_pos.y;
float radius=sqrt(radius2);
vec4 original=texture2D(textureSampler,vUV);
vec3 ref_indices=vec3(-0.3,0.0,0.3);
float ref_shiftX=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.x/screen_width;
float ref_shiftY=chromatic_aberration*pow(radius,radialIntensity)*directionOfEffect.y/screen_height;
vec2 ref_coords_r=vec2(vUV.x+ref_indices.r*ref_shiftX,vUV.y+ref_indices.r*ref_shiftY*0.5);
vec2 ref_coords_g=vec2(vUV.x+ref_indices.g*ref_shiftX,vUV.y+ref_indices.g*ref_shiftY*0.5);
vec2 ref_coords_b=vec2(vUV.x+ref_indices.b*ref_shiftX,vUV.y+ref_indices.b*ref_shiftY*0.5);
original.r=texture2D(textureSampler,ref_coords_r).r;
original.g=texture2D(textureSampler,ref_coords_g).g;
original.b=texture2D(textureSampler,ref_coords_b).b;
original.a=clamp(texture2D(textureSampler,ref_coords_r).a+texture2D(textureSampler,ref_coords_g).a+texture2D(textureSampler,ref_coords_b).a,0.,1.);
gl_FragColor=original;
}`;Y.ShadersStore[mP]=gP;class tn extends Fe{constructor(e,t,i,s,r,n,o,l,h=0,c=!1){super(e,"chromaticAberration",["chromatic_aberration","screen_width","screen_height","direction","radialIntensity","centerPosition"],[],s,r,n,o,l,null,h,void 0,null,c),this.aberrationAmount=30,this.radialIntensity=0,this.direction=new le(.707,.707),this.centerPosition=new le(.5,.5),this.screenWidth=t,this.screenHeight=i,this.onApplyObservable.add(u=>{u.setFloat("chromatic_aberration",this.aberrationAmount),u.setFloat("screen_width",t),u.setFloat("screen_height",i),u.setFloat("radialIntensity",this.radialIntensity),u.setFloat2("direction",this.direction.x,this.direction.y),u.setFloat2("centerPosition",this.centerPosition.x,this.centerPosition.y)})}getClassName(){return"ChromaticAberrationPostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new tn(e.name,e.screenWidth,e.screenHeight,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,s)}}T([R()],tn.prototype,"aberrationAmount",void 0);T([R()],tn.prototype,"radialIntensity",void 0);T([R()],tn.prototype,"direction",void 0);T([R()],tn.prototype,"centerPosition",void 0);T([R()],tn.prototype,"screenWidth",void 0);T([R()],tn.prototype,"screenHeight",void 0);he("BABYLON.ChromaticAberrationPostProcess",tn);const vP="circleOfConfusionPixelShader",xP=`uniform sampler2D depthSampler;
varying vec2 vUV;
uniform vec2 cameraMinMaxZ;
uniform float focusDistance;
uniform float cocPrecalculation;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float depth=texture2D(depthSampler,vUV).r;
float pixelDistance=(cameraMinMaxZ.x+(cameraMinMaxZ.y-cameraMinMaxZ.x)*depth)*1000.0; 
float coc=abs(cocPrecalculation* ((focusDistance-pixelDistance)/pixelDistance));
coc=clamp(coc,0.0,1.0);
gl_FragColor=vec4(coc,depth,coc,1.0);
}
`;Y.ShadersStore[vP]=xP;class jo extends Fe{constructor(e,t,i,s,r,n,o,l=0,h=!1){super(e,"circleOfConfusion",["cameraMinMaxZ","focusDistance","cocPrecalculation"],["depthSampler"],i,s,r,n,o,null,l,void 0,null,h),this.lensSize=50,this.fStop=1.4,this.focusDistance=2e3,this.focalLength=50,this._depthTexture=null,this._depthTexture=t,this.onApplyObservable.add(c=>{if(!this._depthTexture){B.Warn("No depth texture set on CircleOfConfusionPostProcess");return}c.setTexture("depthSampler",this._depthTexture);const d=this.lensSize/this.fStop*this.focalLength/(this.focusDistance-this.focalLength);c.setFloat("focusDistance",this.focusDistance),c.setFloat("cocPrecalculation",d),c.setFloat2("cameraMinMaxZ",this._depthTexture.activeCamera.minZ,this._depthTexture.activeCamera.maxZ)})}getClassName(){return"CircleOfConfusionPostProcess"}set depthTexture(e){this._depthTexture=e}}T([R()],jo.prototype,"lensSize",void 0);T([R()],jo.prototype,"fStop",void 0);T([R()],jo.prototype,"focusDistance",void 0);T([R()],jo.prototype,"focalLength",void 0);he("BABYLON.CircleOfConfusionPostProcess",jo);const TP="colorCorrectionPixelShader",bP=`uniform sampler2D textureSampler; 
uniform sampler2D colorTable; 
varying vec2 vUV;
const float SLICE_COUNT=16.0; 
vec4 sampleAs3DTexture(sampler2D textureSampler,vec3 uv,float width) {
float sliceSize=1.0/width; 
float slicePixelSize=sliceSize/width; 
float sliceInnerSize=slicePixelSize*(width-1.0); 
float zSlice0=min(floor(uv.z*width),width-1.0);
float zSlice1=min(zSlice0+1.0,width-1.0);
float xOffset=slicePixelSize*0.5+uv.x*sliceInnerSize;
float s0=xOffset+(zSlice0*sliceSize);
float s1=xOffset+(zSlice1*sliceSize);
vec4 slice0Color=texture2D(textureSampler,vec2(s0,uv.y));
vec4 slice1Color=texture2D(textureSampler,vec2(s1,uv.y));
float zOffset=mod(uv.z*width,1.0);
vec4 result=mix(slice0Color,slice1Color,zOffset);
return result;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 screen_color=texture2D(textureSampler,vUV);
gl_FragColor=sampleAs3DTexture(colorTable,screen_color.rgb,SLICE_COUNT);
}`;Y.ShadersStore[TP]=bP;class ou extends Fe{constructor(e,t,i,s,r,n,o){super(e,"colorCorrection",null,["colorTable"],i,s,r,n,o);const l=(s==null?void 0:s.getScene())||null;this._colorTableTexture=new H(t,l,!0,!1,H.TRILINEAR_SAMPLINGMODE),this._colorTableTexture.anisotropicFilteringLevel=1,this._colorTableTexture.wrapU=H.CLAMP_ADDRESSMODE,this._colorTableTexture.wrapV=H.CLAMP_ADDRESSMODE,this.colorTableUrl=t,this.onApply=h=>{h.setTexture("colorTable",this._colorTableTexture)}}getClassName(){return"ColorCorrectionPostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new ou(e.name,e.colorTableUrl,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}T([R()],ou.prototype,"colorTableUrl",void 0);he("BABYLON.ColorCorrectionPostProcess",ou);const SP="convolutionPixelShader",EP=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform float kernel[9];
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 colorSum =
texture2D(textureSampler,vUV+onePixel*vec2(-1,-1))*kernel[0] +
texture2D(textureSampler,vUV+onePixel*vec2(0,-1))*kernel[1] +
texture2D(textureSampler,vUV+onePixel*vec2(1,-1))*kernel[2] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0))*kernel[3] +
texture2D(textureSampler,vUV+onePixel*vec2(0,0))*kernel[4] +
texture2D(textureSampler,vUV+onePixel*vec2(1,0))*kernel[5] +
texture2D(textureSampler,vUV+onePixel*vec2(-1,1))*kernel[6] +
texture2D(textureSampler,vUV+onePixel*vec2(0,1))*kernel[7] +
texture2D(textureSampler,vUV+onePixel*vec2(1,1))*kernel[8];
float kernelWeight =
kernel[0] +
kernel[1] +
kernel[2] +
kernel[3] +
kernel[4] +
kernel[5] +
kernel[6] +
kernel[7] +
kernel[8];
if (kernelWeight<=0.0) {
kernelWeight=1.0;
}
gl_FragColor=vec4((colorSum/kernelWeight).rgb,1);
}`;Y.ShadersStore[SP]=EP;class sn extends Fe{constructor(e,t,i,s,r,n,o,l=0){super(e,"convolution",["kernel","screenSize"],null,i,s,r,n,o,null,l),this.kernel=t,this.onApply=h=>{h.setFloat2("screenSize",this.width,this.height),h.setArray("kernel",this.kernel)}}getClassName(){return"ConvolutionPostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new sn(e.name,e.kernel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType),e,i,s)}}sn.EdgeDetect0Kernel=[1,0,-1,0,0,0,-1,0,1];sn.EdgeDetect1Kernel=[0,1,0,1,-4,1,0,1,0];sn.EdgeDetect2Kernel=[-1,-1,-1,-1,8,-1,-1,-1,-1];sn.SharpenKernel=[0,-1,0,-1,5,-1,0,-1,0];sn.EmbossKernel=[-2,-1,0,-1,1,1,0,1,2];sn.GaussianKernel=[0,1,0,1,1,1,0,1,0];T([R()],sn.prototype,"kernel",void 0);he("BABYLON.ConvolutionPostProcess",sn);class ac extends Ei{constructor(e,t,i,s,r,n,o,l=null,h=H.BILINEAR_SAMPLINGMODE,c,u,d=0,f=!1){super(e,i,s,r,n,h=2,c,u,d,`#define DOF 1\r
`,f),this.direction=i,this.externalTextureSamplerBinding=!!l,this.onApplyObservable.add(p=>{l!=null&&p.setTextureFromPostProcess("textureSampler",l),p.setTextureFromPostProcessOutput("circleOfConfusionSampler",o),t.activeCamera&&p.setFloat2("cameraMinMaxZ",t.activeCamera.minZ,t.activeCamera.maxZ)})}getClassName(){return"DepthOfFieldBlurPostProcess"}}T([R()],ac.prototype,"direction",void 0);he("BABYLON.DepthOfFieldBlurPostProcess",ac);const CP="depthOfFieldMergePixelShader",yP=`uniform sampler2D textureSampler;
varying vec2 vUV;
uniform sampler2D circleOfConfusionSampler;
uniform sampler2D blurStep0;
#if BLUR_LEVEL>0
uniform sampler2D blurStep1;
#endif
#if BLUR_LEVEL>1
uniform sampler2D blurStep2;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
float coc=texture2D(circleOfConfusionSampler,vUV).r;
#if BLUR_LEVEL==0
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred0=texture2D(blurStep0,vUV);
gl_FragColor=mix(original,blurred0,coc);
#endif
#if BLUR_LEVEL==1
if(coc<0.5){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(original,blurred1,coc/0.5);
}else{
vec4 blurred0=texture2D(blurStep0,vUV); 
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.5)/0.5);
}
#endif
#if BLUR_LEVEL==2
if(coc<0.33){
vec4 original=texture2D(textureSampler,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(original,blurred2,coc/0.33);
}else if(coc<0.66){
vec4 blurred1=texture2D(blurStep1,vUV);
vec4 blurred2=texture2D(blurStep2,vUV);
gl_FragColor=mix(blurred2,blurred1,(coc-0.33)/0.33);
}else{
vec4 blurred0=texture2D(blurStep0,vUV);
vec4 blurred1=texture2D(blurStep1,vUV);
gl_FragColor=mix(blurred1,blurred0,(coc-0.66)/0.34);
}
#endif
}
`;Y.ShadersStore[CP]=yP;class AP extends Fe{constructor(e,t,i,s,r,n,o,l,h,c=0,u=!1){super(e,"depthOfFieldMerge",[],["circleOfConfusionSampler","blurStep0","blurStep1","blurStep2"],r,n,o,l,h,null,c,void 0,null,!0),this._blurSteps=s,this.externalTextureSamplerBinding=!0,this.onApplyObservable.add(d=>{d.setTextureFromPostProcess("textureSampler",t),d.setTextureFromPostProcessOutput("circleOfConfusionSampler",i),s.forEach((f,p)=>{d.setTextureFromPostProcessOutput("blurStep"+(s.length-p-1),f)})}),u||this.updateEffect()}getClassName(){return"DepthOfFieldMergePostProcess"}updateEffect(e=null,t=null,i=null,s,r,n){e||(e="",e+="#define BLUR_LEVEL "+(this._blurSteps.length-1)+`
`),super.updateEffect(e,t,i,s,r,n)}}var So;(function(a){a[a.Low=0]="Low",a[a.Medium=1]="Medium",a[a.High=2]="High"})(So||(So={}));class up extends bt{constructor(e,t,i=So.Low,s=0,r=!1){super(e.getEngine(),"depth of field",()=>this._effects,!0),this._effects=[],this._circleOfConfusion=new jo("circleOfConfusion",t,1,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,r),this._depthOfFieldBlurY=[],this._depthOfFieldBlurX=[];let n=1,o=15;switch(i){case So.High:{n=3,o=51;break}case So.Medium:{n=2,o=31;break}default:{o=15,n=1;break}}const l=o/Math.pow(2,n-1);let h=1;for(let c=0;c<n;c++){const u=new ac("vertical blur",e,new le(0,1),l,h,null,this._circleOfConfusion,c==0?this._circleOfConfusion:null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,r);u.autoClear=!1,h=.75/Math.pow(2,c);const d=new ac("horizontal blur",e,new le(1,0),l,h,null,this._circleOfConfusion,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,r);d.autoClear=!1,this._depthOfFieldBlurY.push(u),this._depthOfFieldBlurX.push(d)}this._effects=[this._circleOfConfusion];for(let c=0;c<this._depthOfFieldBlurX.length;c++)this._effects.push(this._depthOfFieldBlurY[c]),this._effects.push(this._depthOfFieldBlurX[c]);this._dofMerge=new AP("dofMerge",this._circleOfConfusion,this._circleOfConfusion,this._depthOfFieldBlurX,h,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,s,r),this._dofMerge.autoClear=!1,this._effects.push(this._dofMerge)}set focalLength(e){this._circleOfConfusion.focalLength=e}get focalLength(){return this._circleOfConfusion.focalLength}set fStop(e){this._circleOfConfusion.fStop=e}get fStop(){return this._circleOfConfusion.fStop}set focusDistance(e){this._circleOfConfusion.focusDistance=e}get focusDistance(){return this._circleOfConfusion.focusDistance}set lensSize(e){this._circleOfConfusion.lensSize=e}get lensSize(){return this._circleOfConfusion.lensSize}getClassName(){return"DepthOfFieldEffect"}set depthTexture(e){this._circleOfConfusion.depthTexture=e}disposeEffects(e){for(let t=0;t<this._effects.length;t++)this._effects[t].dispose(e)}_updateEffects(){for(let e=0;e<this._effects.length;e++)this._effects[e].updateEffect()}_isReady(){for(let e=0;e<this._effects.length;e++)if(!this._effects[e].isReady())return!1;return!0}}const RP="displayPassPixelShader",IP=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D passSampler;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(passSampler,vUV);
}`;Y.ShadersStore[RP]=IP;class T0 extends Fe{getClassName(){return"DisplayPassPostProcess"}constructor(e,t,i,s,r,n){super(e,"displayPass",["passSampler"],["passSampler"],t,i,s,r,n)}static _Parse(e,t,i,s){return xe.Parse(()=>new T0(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}he("BABYLON.DisplayPassPostProcess",T0);const PP="filterPixelShader",MP=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform mat4 kernelMatrix;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec3 baseColor=texture2D(textureSampler,vUV).rgb;
vec3 updatedColor=(kernelMatrix*vec4(baseColor,1.0)).rgb;
gl_FragColor=vec4(updatedColor,1.0);
}`;Y.ShadersStore[PP]=MP;class lu extends Fe{constructor(e,t,i,s,r,n,o){super(e,"filter",["kernelMatrix"],null,i,s,r,n,o),this.kernelMatrix=t,this.onApply=l=>{l.setMatrix("kernelMatrix",this.kernelMatrix)}}getClassName(){return"FilterPostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new lu(e.name,e.kernelMatrix,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}T([f_()],lu.prototype,"kernelMatrix",void 0);he("BABYLON.FilterPostProcess",lu);const DP="fxaaPixelShader",OP=`uniform sampler2D textureSampler;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const float fxaaQualitySubpix=1.0;
const float fxaaQualityEdgeThreshold=0.166;
const float fxaaQualityEdgeThresholdMin=0.0833;
const vec3 kLumaCoefficients=vec3(0.2126,0.7152,0.0722);
#define FxaaLuma(rgba) dot(rgba.rgb,kLumaCoefficients)
void main(){
vec2 posM;
posM.x=vUV.x;
posM.y=vUV.y;
vec4 rgbyM=texture2D(textureSampler,vUV,0.0);
float lumaM=FxaaLuma(rgbyM);
float lumaS=FxaaLuma(texture2D(textureSampler,sampleCoordS,0.0));
float lumaE=FxaaLuma(texture2D(textureSampler,sampleCoordE,0.0));
float lumaN=FxaaLuma(texture2D(textureSampler,sampleCoordN,0.0));
float lumaW=FxaaLuma(texture2D(textureSampler,sampleCoordW,0.0));
float maxSM=max(lumaS,lumaM);
float minSM=min(lumaS,lumaM);
float maxESM=max(lumaE,maxSM);
float minESM=min(lumaE,minSM);
float maxWN=max(lumaN,lumaW);
float minWN=min(lumaN,lumaW);
float rangeMax=max(maxWN,maxESM);
float rangeMin=min(minWN,minESM);
float rangeMaxScaled=rangeMax*fxaaQualityEdgeThreshold;
float range=rangeMax-rangeMin;
float rangeMaxClamped=max(fxaaQualityEdgeThresholdMin,rangeMaxScaled);
#ifndef MALI
if(range<rangeMaxClamped) 
{
gl_FragColor=rgbyM;
return;
}
#endif
float lumaNW=FxaaLuma(texture2D(textureSampler,sampleCoordNW,0.0));
float lumaSE=FxaaLuma(texture2D(textureSampler,sampleCoordSE,0.0));
float lumaNE=FxaaLuma(texture2D(textureSampler,sampleCoordNE,0.0));
float lumaSW=FxaaLuma(texture2D(textureSampler,sampleCoordSW,0.0));
float lumaNS=lumaN+lumaS;
float lumaWE=lumaW+lumaE;
float subpixRcpRange=1.0/range;
float subpixNSWE=lumaNS+lumaWE;
float edgeHorz1=(-2.0*lumaM)+lumaNS;
float edgeVert1=(-2.0*lumaM)+lumaWE;
float lumaNESE=lumaNE+lumaSE;
float lumaNWNE=lumaNW+lumaNE;
float edgeHorz2=(-2.0*lumaE)+lumaNESE;
float edgeVert2=(-2.0*lumaN)+lumaNWNE;
float lumaNWSW=lumaNW+lumaSW;
float lumaSWSE=lumaSW+lumaSE;
float edgeHorz4=(abs(edgeHorz1)*2.0)+abs(edgeHorz2);
float edgeVert4=(abs(edgeVert1)*2.0)+abs(edgeVert2);
float edgeHorz3=(-2.0*lumaW)+lumaNWSW;
float edgeVert3=(-2.0*lumaS)+lumaSWSE;
float edgeHorz=abs(edgeHorz3)+edgeHorz4;
float edgeVert=abs(edgeVert3)+edgeVert4;
float subpixNWSWNESE=lumaNWSW+lumaNESE;
float lengthSign=texelSize.x;
bool horzSpan=edgeHorz>=edgeVert;
float subpixA=subpixNSWE*2.0+subpixNWSWNESE;
if (!horzSpan)
{
lumaN=lumaW;
}
if (!horzSpan) 
{
lumaS=lumaE;
}
if (horzSpan) 
{
lengthSign=texelSize.y;
}
float subpixB=(subpixA*(1.0/12.0))-lumaM;
float gradientN=lumaN-lumaM;
float gradientS=lumaS-lumaM;
float lumaNN=lumaN+lumaM;
float lumaSS=lumaS+lumaM;
bool pairN=abs(gradientN)>=abs(gradientS);
float gradient=max(abs(gradientN),abs(gradientS));
if (pairN)
{
lengthSign=-lengthSign;
}
float subpixC=clamp(abs(subpixB)*subpixRcpRange,0.0,1.0);
vec2 posB;
posB.x=posM.x;
posB.y=posM.y;
vec2 offNP;
offNP.x=(!horzSpan) ? 0.0 : texelSize.x;
offNP.y=(horzSpan) ? 0.0 : texelSize.y;
if (!horzSpan) 
{
posB.x+=lengthSign*0.5;
}
if (horzSpan)
{
posB.y+=lengthSign*0.5;
}
vec2 posN;
posN.x=posB.x-offNP.x*1.5;
posN.y=posB.y-offNP.y*1.5;
vec2 posP;
posP.x=posB.x+offNP.x*1.5;
posP.y=posB.y+offNP.y*1.5;
float subpixD=((-2.0)*subpixC)+3.0;
float lumaEndN=FxaaLuma(texture2D(textureSampler,posN,0.0));
float subpixE=subpixC*subpixC;
float lumaEndP=FxaaLuma(texture2D(textureSampler,posP,0.0));
if (!pairN) 
{
lumaNN=lumaSS;
}
float gradientScaled=gradient*1.0/4.0;
float lumaMM=lumaM-lumaNN*0.5;
float subpixF=subpixD*subpixE;
bool lumaMLTZero=lumaMM<0.0;
lumaEndN-=lumaNN*0.5;
lumaEndP-=lumaNN*0.5;
bool doneN=abs(lumaEndN)>=gradientScaled;
bool doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) 
{
posN.x-=offNP.x*3.0;
}
if (!doneN) 
{
posN.y-=offNP.y*3.0;
}
bool doneNP=(!doneN) || (!doneP);
if (!doneP) 
{
posP.x+=offNP.x*3.0;
}
if (!doneP)
{
posP.y+=offNP.y*3.0;
}
if (doneNP)
{
if (!doneN) lumaEndN=FxaaLuma(texture2D(textureSampler,posN.xy,0.0));
if (!doneP) lumaEndP=FxaaLuma(texture2D(textureSampler,posP.xy,0.0));
if (!doneN) lumaEndN=lumaEndN-lumaNN*0.5;
if (!doneP) lumaEndP=lumaEndP-lumaNN*0.5;
doneN=abs(lumaEndN)>=gradientScaled;
doneP=abs(lumaEndP)>=gradientScaled;
if (!doneN) posN.x-=offNP.x*12.0;
if (!doneN) posN.y-=offNP.y*12.0;
doneNP=(!doneN) || (!doneP);
if (!doneP) posP.x+=offNP.x*12.0;
if (!doneP) posP.y+=offNP.y*12.0;
}
float dstN=posM.x-posN.x;
float dstP=posP.x-posM.x;
if (!horzSpan)
{
dstN=posM.y-posN.y;
}
if (!horzSpan) 
{
dstP=posP.y-posM.y;
}
bool goodSpanN=(lumaEndN<0.0) != lumaMLTZero;
float spanLength=(dstP+dstN);
bool goodSpanP=(lumaEndP<0.0) != lumaMLTZero;
float spanLengthRcp=1.0/spanLength;
bool directionN=dstN<dstP;
float dst=min(dstN,dstP);
bool goodSpan=directionN ? goodSpanN : goodSpanP;
float subpixG=subpixF*subpixF;
float pixelOffset=(dst*(-spanLengthRcp))+0.5;
float subpixH=subpixG*fxaaQualitySubpix;
float pixelOffsetGood=goodSpan ? pixelOffset : 0.0;
float pixelOffsetSubpix=max(pixelOffsetGood,subpixH);
if (!horzSpan)
{
posM.x+=pixelOffsetSubpix*lengthSign;
}
if (horzSpan)
{
posM.y+=pixelOffsetSubpix*lengthSign;
}
#ifdef MALI
if(range<rangeMaxClamped) 
{
gl_FragColor=rgbyM;
}
else
{
gl_FragColor=texture2D(textureSampler,posM,0.0);
}
#else
gl_FragColor=texture2D(textureSampler,posM,0.0);
#endif
}`;Y.ShadersStore[DP]=OP;const wP="fxaaVertexShader",NP=`attribute vec2 position;
uniform vec2 texelSize;
varying vec2 vUV;
varying vec2 sampleCoordS;
varying vec2 sampleCoordE;
varying vec2 sampleCoordN;
varying vec2 sampleCoordW;
varying vec2 sampleCoordNW;
varying vec2 sampleCoordSE;
varying vec2 sampleCoordNE;
varying vec2 sampleCoordSW;
const vec2 madd=vec2(0.5,0.5);
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vUV=(position*madd+madd);
sampleCoordS=vUV+vec2( 0.0,1.0)*texelSize;
sampleCoordE=vUV+vec2( 1.0,0.0)*texelSize;
sampleCoordN=vUV+vec2( 0.0,-1.0)*texelSize;
sampleCoordW=vUV+vec2(-1.0,0.0)*texelSize;
sampleCoordNW=vUV+vec2(-1.0,-1.0)*texelSize;
sampleCoordSE=vUV+vec2( 1.0,1.0)*texelSize;
sampleCoordNE=vUV+vec2( 1.0,-1.0)*texelSize;
sampleCoordSW=vUV+vec2(-1.0,1.0)*texelSize;
gl_Position=vec4(position,0.0,1.0);
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[wP]=NP;class qo extends Fe{getClassName(){return"FxaaPostProcess"}constructor(e,t,i=null,s,r,n,o=0){super(e,"fxaa",["texelSize"],null,t,i,s||H.BILINEAR_SAMPLINGMODE,r,n,null,o,"fxaa",void 0,!0);const l=this._getDefines();this.updateEffect(l),this.onApplyObservable.add(h=>{const c=this.texelSize;h.setFloat2("texelSize",c.x,c.y)})}_getDefines(){const e=this.getEngine();if(!e)return null;const t=e.getGlInfo();return t&&t.renderer&&t.renderer.toLowerCase().indexOf("mali")>-1?`#define MALI 1
`:null}static _Parse(e,t,i,s){return xe.Parse(()=>new qo(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}he("BABYLON.FxaaPostProcess",qo);const FP="grainPixelShader",LP=`#include<helperFunctions>
uniform sampler2D textureSampler; 
uniform float intensity;
uniform float animatedSeed;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
gl_FragColor=texture2D(textureSampler,vUV);
vec2 seed=vUV*(animatedSeed);
float grain=dither(seed,intensity);
float lum=getLuminance(gl_FragColor.rgb);
float grainAmount=(cos(-PI+(lum*PI*2.))+1.)/2.;
gl_FragColor.rgb+=grain*grainAmount;
gl_FragColor.rgb=max(gl_FragColor.rgb,0.0);
}`;Y.ShadersStore[FP]=LP;class Qo extends Fe{constructor(e,t,i,s,r,n,o=0,l=!1){super(e,"grain",["intensity","animatedSeed"],[],t,i,s,r,n,null,o,void 0,null,l),this.intensity=30,this.animated=!1,this.onApplyObservable.add(h=>{h.setFloat("intensity",this.intensity),h.setFloat("animatedSeed",this.animated?Math.random()+1:1)})}getClassName(){return"GrainPostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new Qo(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}T([R()],Qo.prototype,"intensity",void 0);T([R()],Qo.prototype,"animated",void 0);he("BABYLON.GrainPostProcess",Qo);const BP="highlightsPixelShader",UP=`varying vec2 vUV;
uniform sampler2D textureSampler;
const vec3 RGBLuminanceCoefficients=vec3(0.2126,0.7152,0.0722);
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec4 tex=texture2D(textureSampler,vUV);
vec3 c=tex.rgb;
float luma=dot(c.rgb,RGBLuminanceCoefficients);
gl_FragColor=vec4(pow(c,vec3(25.0-luma*15.0)),tex.a); 
}`;Y.ShadersStore[BP]=UP;const VP="mrtFragmentDeclaration",kP=`#if defined(WEBGL2) || defined(WEBGPU)
layout(location=0) out vec4 glFragData[{X}];
#endif
`;Y.IncludesShadersStore[VP]=kP;const GP="geometryPixelShader",zP=`#extension GL_EXT_draw_buffers : require
#if defined(BUMP) || !defined(NORMAL)
#extension GL_OES_standard_derivatives : enable
#endif
precision highp float;
#ifdef BUMP
varying mat4 vWorldView;
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#ifdef NEED_UV
varying vec2 vUV;
#endif
#ifdef BUMP
uniform vec3 vBumpInfos;
uniform vec2 vTangentSpaceParams;
#endif
#if defined(REFLECTIVITY)
#if defined(ORMTEXTURE) || defined(SPECULARGLOSSINESSTEXTURE) || defined(REFLECTIVITYTEXTURE)
uniform sampler2D reflectivitySampler;
varying vec2 vReflectivityUV;
#endif
#ifdef ALBEDOTEXTURE
varying vec2 vAlbedoUV;
uniform sampler2D albedoSampler;
#endif
#ifdef REFLECTIVITYCOLOR
uniform vec3 reflectivityColor;
#endif
#ifdef ALBEDOCOLOR
uniform vec3 albedoColor;
#endif
#ifdef METALLIC
uniform float metallic;
#endif
#ifdef ROUGHNESS
uniform float glossiness;
#endif
#endif
#ifdef ALPHATEST
uniform sampler2D diffuseSampler;
#endif
#include<mrtFragmentDeclaration>[RENDER_TARGET_COUNT]
#include<bumpFragmentMainFunctions>
#include<bumpFragmentFunctions>
#include<helperFunctions>
void main() {
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
vec3 normalOutput;
#ifdef BUMP
vec3 normalW=normalize(vNormalW);
#include<bumpFragment>
normalOutput=normalize(vec3(vWorldView*vec4(normalW,0.0)));
#else
normalOutput=normalize(vNormalV);
#endif
#ifdef PREPASS
#ifdef PREPASS_DEPTH
gl_FragData[DEPTH_INDEX]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
#endif
#ifdef PREPASS_NORMAL
gl_FragData[NORMAL_INDEX]=vec4(normalOutput,1.0);
#endif
#else
gl_FragData[0]=vec4(vViewPos.z/vViewPos.w,0.0,0.0,1.0);
gl_FragData[1]=vec4(normalOutput,1.0);
#endif
#ifdef POSITION
gl_FragData[POSITION_INDEX]=vec4(vPositionW,1.0);
#endif
#ifdef VELOCITY
vec2 a=(vCurrentPosition.xy/vCurrentPosition.w)*0.5+0.5;
vec2 b=(vPreviousPosition.xy/vPreviousPosition.w)*0.5+0.5;
vec2 velocity=abs(a-b);
velocity=vec2(pow(velocity.x,1.0/3.0),pow(velocity.y,1.0/3.0))*sign(a-b)*0.5+0.5;
gl_FragData[VELOCITY_INDEX]=vec4(velocity,0.0,1.0);
#endif
#ifdef REFLECTIVITY
vec4 reflectivity=vec4(1.0,1.0,1.0,1.0);
#ifdef METALLICWORKFLOW
float metal=1.0;
float roughness=1.0;
#ifdef ORMTEXTURE
metal*=texture2D(reflectivitySampler,vReflectivityUV).b;
roughness*=texture2D(reflectivitySampler,vReflectivityUV).g;
#endif
#ifdef METALLIC
metal*=metallic;
#endif
#ifdef ROUGHNESS
roughness*=(1.0-glossiness); 
#endif
reflectivity.a-=roughness;
vec3 color=vec3(1.0);
#ifdef ALBEDOTEXTURE
color=texture2D(albedoSampler,vAlbedoUV).rgb;
#ifdef GAMMAALBEDO
color=toLinearSpace(color);
#endif
#endif
#ifdef ALBEDOCOLOR
color*=albedoColor.xyz;
#endif
reflectivity.rgb=mix(vec3(0.04),color,metal);
#else
#ifdef SPECULARGLOSSINESSTEXTURE
reflectivity=texture2D(reflectivitySampler,vReflectivityUV);
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#ifdef GLOSSINESSS
reflectivity.a*=glossiness;
#endif
#else 
#ifdef REFLECTIVITYTEXTURE
reflectivity.rbg=texture2D(reflectivitySampler,vReflectivityUV).rbg;
#ifdef GAMMAREFLECTIVITYTEXTURE
reflectivity.rgb=toLinearSpace(reflectivity.rgb);
#endif
#else
#ifdef REFLECTIVITYCOLOR
reflectivity.rgb=reflectivityColor.xyz;
reflectivity.a=1.0;
#endif
#endif 
#ifdef GLOSSINESSS
reflectivity.a=glossiness; 
#else
reflectivity.a=1.0; 
#endif
#endif
#endif
reflectivity.rgb=toGammaSpace(reflectivity.rgb); 
gl_FragData[REFLECTIVITY_INDEX]=reflectivity;
#endif
}
`;Y.ShadersStore[GP]=zP;const WP="geometryVertexDeclaration",HP=`uniform mat4 viewProjection;
uniform mat4 view;`;Y.IncludesShadersStore[WP]=HP;const XP="geometryUboDeclaration",YP=`#include<sceneUboDeclaration>
`;Y.IncludesShadersStore[XP]=YP;const KP="geometryVertexShader",$P=`precision highp float;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
#include<__decl__geometryVertex>
attribute vec3 position;
attribute vec3 normal;
#ifdef NEED_UV
varying vec2 vUV;
#ifdef ALPHATEST
uniform mat4 diffuseMatrix;
#endif
#ifdef BUMP
uniform mat4 bumpMatrix;
varying vec2 vBumpUV;
#endif
#ifdef REFLECTIVITY
uniform mat4 reflectivityMatrix;
uniform mat4 albedoMatrix;
varying vec2 vReflectivityUV;
varying vec2 vAlbedoUV;
#endif
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#ifdef BUMP
varying mat4 vWorldView;
#endif
#ifdef BUMP
varying vec3 vNormalW;
#else
varying vec3 vNormalV;
#endif
varying vec4 vViewPos;
#if defined(POSITION) || defined(BUMP)
varying vec3 vPositionW;
#endif
#ifdef VELOCITY
uniform mat4 previousViewProjection;
varying vec4 vCurrentPosition;
varying vec4 vPreviousPosition;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#if defined(VELOCITY) && !defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 pos=vec4(finalWorld*vec4(positionUpdated,1.0));
#ifdef BUMP
vWorldView=view*finalWorld;
vNormalW=normalUpdated;
#else
vNormalV=normalize(vec3((view*finalWorld)*vec4(normalUpdated,0.0)));
#endif
vViewPos=view*pos;
#if defined(VELOCITY) && defined(BONES_VELOCITY_ENABLED)
vCurrentPosition=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if NUM_BONE_INFLUENCERS>0
mat4 previousInfluence;
previousInfluence=mPreviousBones[int(matricesIndices[0])]*matricesWeights[0];
#if NUM_BONE_INFLUENCERS>1
previousInfluence+=mPreviousBones[int(matricesIndices[1])]*matricesWeights[1];
#endif
#if NUM_BONE_INFLUENCERS>2
previousInfluence+=mPreviousBones[int(matricesIndices[2])]*matricesWeights[2];
#endif
#if NUM_BONE_INFLUENCERS>3
previousInfluence+=mPreviousBones[int(matricesIndices[3])]*matricesWeights[3];
#endif
#if NUM_BONE_INFLUENCERS>4
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[0])]*matricesWeightsExtra[0];
#endif
#if NUM_BONE_INFLUENCERS>5
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[1])]*matricesWeightsExtra[1];
#endif
#if NUM_BONE_INFLUENCERS>6
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[2])]*matricesWeightsExtra[2];
#endif
#if NUM_BONE_INFLUENCERS>7
previousInfluence+=mPreviousBones[int(matricesIndicesExtra[3])]*matricesWeightsExtra[3];
#endif
vPreviousPosition=previousViewProjection*finalPreviousWorld*previousInfluence*vec4(positionUpdated,1.0);
#else
vPreviousPosition=previousViewProjection*finalPreviousWorld*vec4(positionUpdated,1.0);
#endif
#endif
#if defined(POSITION) || defined(BUMP)
vPositionW=pos.xyz/pos.w;
#endif
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#ifdef NEED_UV
#ifdef UV1
#if defined(ALPHATEST) && defined(ALPHATEST_UV1)
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#else
vUV=uv;
#endif
#ifdef BUMP_UV1
vBumpUV=vec2(bumpMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV1
vReflectivityUV=vec2(reflectivityMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef ALBEDO_UV1
vAlbedoUV=vec2(albedoMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#endif
#ifdef UV2
#if defined(ALPHATEST) && defined(ALPHATEST_UV2)
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#else
vUV=uv2;
#endif
#ifdef BUMP_UV2
vBumpUV=vec2(bumpMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef REFLECTIVITY_UV2
vReflectivityUV=vec2(reflectivityMatrix*vec4(uv2,1.0,0.0));
#endif
#ifdef ALBEDO_UV2
vAlbedoUV=vec2(albedoMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#endif
#include<bumpVertex>
}
`;Y.ShadersStore[KP]=$P;class ei{constructor(e,t=1,i=15){this._previousTransformationMatrices={},this._previousBonesTransformationMatrices={},this.excludedSkinnedMeshesFromVelocity=[],this.renderTransparentMeshes=!0,this._resizeObserver=null,this._enablePosition=!1,this._enableVelocity=!1,this._enableReflectivity=!1,this._positionIndex=-1,this._velocityIndex=-1,this._reflectivityIndex=-1,this._depthIndex=-1,this._normalIndex=-1,this._linkedWithPrePass=!1,this._scene=e,this._ratio=t,this._useUbo=e.getEngine().supportsUniformBuffers,this._depthFormat=i,ei._SceneComponentInitialization(this._scene),this._createRenderTargets()}_linkPrePassRenderer(e){this._linkedWithPrePass=!0,this._prePassRenderer=e,this._multiRenderTarget&&(this._multiRenderTarget.onClearObservable.clear(),this._multiRenderTarget.onClearObservable.add(()=>{}))}_unlinkPrePassRenderer(){this._linkedWithPrePass=!1,this._createRenderTargets()}_resetLayout(){this._enablePosition=!1,this._enableReflectivity=!1,this._enableVelocity=!1,this._attachments=[]}_forceTextureType(e,t){e===ei.POSITION_TEXTURE_TYPE?(this._positionIndex=t,this._enablePosition=!0):e===ei.VELOCITY_TEXTURE_TYPE?(this._velocityIndex=t,this._enableVelocity=!0):e===ei.REFLECTIVITY_TEXTURE_TYPE?(this._reflectivityIndex=t,this._enableReflectivity=!0):e===ei.DEPTH_TEXTURE_TYPE?this._depthIndex=t:e===ei.NORMAL_TEXTURE_TYPE&&(this._normalIndex=t)}_setAttachments(e){this._attachments=e}_linkInternalTexture(e){this._multiRenderTarget.setInternalTexture(e,0,!1)}get renderList(){return this._multiRenderTarget.renderList}set renderList(e){this._multiRenderTarget.renderList=e}get isSupported(){return this._multiRenderTarget.isSupported}getTextureIndex(e){switch(e){case ei.POSITION_TEXTURE_TYPE:return this._positionIndex;case ei.VELOCITY_TEXTURE_TYPE:return this._velocityIndex;case ei.REFLECTIVITY_TEXTURE_TYPE:return this._reflectivityIndex;default:return-1}}get enablePosition(){return this._enablePosition}set enablePosition(e){this._enablePosition=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get enableVelocity(){return this._enableVelocity}set enableVelocity(e){this._enableVelocity=e,e||(this._previousTransformationMatrices={}),this._linkedWithPrePass||(this.dispose(),this._createRenderTargets()),this._scene.needsPreviousWorldMatrices=e}get enableReflectivity(){return this._enableReflectivity}set enableReflectivity(e){this._enableReflectivity=e,this._linkedWithPrePass||(this.dispose(),this._createRenderTargets())}get scene(){return this._scene}get ratio(){return this._ratio}isReady(e,t){const i=e.getMaterial();if(i&&i.disableDepthWrite)return!1;const s=[],r=[y.PositionKind,y.NormalKind],n=e.getMesh();if(i){let f=!1;if(i.needAlphaTesting()&&i.getAlphaTestTexture()&&(s.push("#define ALPHATEST"),s.push(`#define ALPHATEST_UV${i.getAlphaTestTexture().coordinatesIndex+1}`),f=!0),i.bumpTexture&&ce.BumpTextureEnabled&&(s.push("#define BUMP"),s.push(`#define BUMP_UV${i.bumpTexture.coordinatesIndex+1}`),f=!0),this._enableReflectivity){let p=!1;i.getClassName()==="PBRMetallicRoughnessMaterial"?(i.metallicRoughnessTexture!==null&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicRoughnessTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),f=!0,p=!0),i.metallic!==null&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),p=!0),i.roughness!==null&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),p=!0),p&&(i.baseTexture!==null&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.baseTexture.coordinatesIndex+1}`),i.baseTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),f=!0),i.baseColor!==null&&s.push("#define ALBEDOCOLOR"))):i.getClassName()==="PBRSpecularGlossinessMaterial"?(i.specularGlossinessTexture!==null?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularGlossinessTexture.coordinatesIndex+1}`),f=!0,i.specularGlossinessTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE")):i.specularColor!==null&&s.push("#define REFLECTIVITYCOLOR"),i.glossiness!==null&&s.push("#define GLOSSINESSS")):i.getClassName()==="PBRMaterial"?(i.metallicTexture!==null&&(s.push("#define ORMTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.metallicTexture.coordinatesIndex+1}`),s.push("#define METALLICWORKFLOW"),f=!0,p=!0),i.metallic!==null&&(s.push("#define METALLIC"),s.push("#define METALLICWORKFLOW"),p=!0),i.roughness!==null&&(s.push("#define ROUGHNESS"),s.push("#define METALLICWORKFLOW"),p=!0),p?(i.albedoTexture!==null&&(s.push("#define ALBEDOTEXTURE"),s.push(`#define ALBEDO_UV${i.albedoTexture.coordinatesIndex+1}`),i.albedoTexture.gammaSpace&&s.push("#define GAMMAALBEDO"),f=!0),i.albedoColor!==null&&s.push("#define ALBEDOCOLOR")):(i.reflectivityTexture!==null?(s.push("#define SPECULARGLOSSINESSTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.reflectivityTexture.coordinatesIndex+1}`),i.reflectivityTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0):i.reflectivityColor!==null&&s.push("#define REFLECTIVITYCOLOR"),i.microSurface!==null&&s.push("#define GLOSSINESSS"))):i.getClassName()==="StandardMaterial"&&(i.specularTexture!==null&&(s.push("#define REFLECTIVITYTEXTURE"),s.push(`#define REFLECTIVITY_UV${i.specularTexture.coordinatesIndex+1}`),i.specularTexture.gammaSpace&&s.push("#define GAMMAREFLECTIVITYTEXTURE"),f=!0),i.specularColor!==null&&s.push("#define REFLECTIVITYCOLOR"))}f&&(s.push("#define NEED_UV"),n.isVerticesDataPresent(y.UVKind)&&(r.push(y.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(y.UV2Kind)&&(r.push(y.UV2Kind),s.push("#define UV2")))}this._linkedWithPrePass&&(s.push("#define PREPASS"),this._depthIndex!==-1&&(s.push("#define DEPTH_INDEX "+this._depthIndex),s.push("#define PREPASS_DEPTH")),this._normalIndex!==-1&&(s.push("#define NORMAL_INDEX "+this._normalIndex),s.push("#define PREPASS_NORMAL"))),this._enablePosition&&(s.push("#define POSITION"),s.push("#define POSITION_INDEX "+this._positionIndex)),this._enableVelocity&&(s.push("#define VELOCITY"),s.push("#define VELOCITY_INDEX "+this._velocityIndex),this.excludedSkinnedMeshesFromVelocity.indexOf(n)===-1&&s.push("#define BONES_VELOCITY_ENABLED")),this._enableReflectivity&&(s.push("#define REFLECTIVITY"),s.push("#define REFLECTIVITY_INDEX "+this._reflectivityIndex)),n.useBones&&n.computeBonesUsingShaders?(r.push(y.MatricesIndicesKind),r.push(y.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(y.MatricesIndicesExtraKind),r.push(y.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const o=n.morphTargetManager;let l=0;o&&o.numInfluencers>0&&(l=o.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+l),o.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(r,n,l)),t&&(s.push("#define INSTANCES"),se.PushAttributesForInstances(r,this._enableVelocity),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),this._linkedWithPrePass?s.push("#define RENDER_TARGET_COUNT "+this._attachments.length):s.push("#define RENDER_TARGET_COUNT "+this._multiRenderTarget.textures.length);const h=this._scene.getEngine(),c=e._getDrawWrapper(void 0,!0),u=c.defines,d=s.join(`
`);return u!==d&&c.setEffect(h.createEffect("geometry",{attributes:r,uniformsNames:["world","mBones","viewProjection","diffuseMatrix","view","previousWorld","previousViewProjection","mPreviousBones","bumpMatrix","reflectivityMatrix","albedoMatrix","reflectivityColor","albedoColor","metallic","glossiness","vTangentSpaceParams","vBumpInfos","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices"],samplers:["diffuseSampler","bumpSampler","reflectivitySampler","albedoSampler","morphTargets"],defines:d,onCompiled:null,fallbacks:null,onError:null,uniformBuffersNames:["Scene"],indexParameters:{buffersCount:this._multiRenderTarget.textures.length-1,maxSimultaneousMorphTargets:l}},h),d),c.effect.isReady()}getGBuffer(){return this._multiRenderTarget}get samples(){return this._multiRenderTarget.samples}set samples(e){this._multiRenderTarget.samples=e}dispose(){this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this.getGBuffer().dispose()}_assignRenderTargetIndices(){const e=[];let t=2;return e.push("gBuffer_Depth","gBuffer_Normal"),this._enablePosition&&(this._positionIndex=t,t++,e.push("gBuffer_Position")),this._enableVelocity&&(this._velocityIndex=t,t++,e.push("gBuffer_Velocity")),this._enableReflectivity&&(this._reflectivityIndex=t,t++,e.push("gBuffer_Reflectivity")),[t,e]}_createRenderTargets(){const e=this._scene.getEngine(),[t,i]=this._assignRenderTargetIndices();let s=0;if(e._caps.textureFloat&&e._caps.textureFloatLinearFiltering?s=1:e._caps.textureHalfFloat&&e._caps.textureHalfFloatLinearFiltering&&(s=2),this._multiRenderTarget=new Sa("gBuffer",{width:e.getRenderWidth()*this._ratio,height:e.getRenderHeight()*this._ratio},t,this._scene,{generateMipMaps:!1,generateDepthTexture:!0,defaultType:s,depthTextureFormat:this._depthFormat},i.concat("gBuffer_DepthBuffer")),!this.isSupported)return;this._multiRenderTarget.wrapU=H.CLAMP_ADDRESSMODE,this._multiRenderTarget.wrapV=H.CLAMP_ADDRESSMODE,this._multiRenderTarget.refreshRate=1,this._multiRenderTarget.renderParticles=!1,this._multiRenderTarget.renderList=null,this._multiRenderTarget.onClearObservable.add(n=>{n.clear(new J(0,0,0,0),!0,!0,!0)}),this._resizeObserver=e.onResizeObservable.add(()=>{this._multiRenderTarget&&this._multiRenderTarget.resize({width:e.getRenderWidth()*this._ratio,height:e.getRenderHeight()*this._ratio})});const r=n=>{const o=n.getRenderingMesh(),l=n.getEffectiveMesh(),h=this._scene,c=h.getEngine(),u=n.getMaterial();if(!u)return;if(l._internalAbstractMeshDataInfo._isActiveIntermediate=!1,this._enableVelocity&&!this._previousTransformationMatrices[l.uniqueId]&&(this._previousTransformationMatrices[l.uniqueId]={world:L.Identity(),viewProjection:h.getTransformMatrix()},o.skeleton)){const _=o.skeleton.getTransformMatrices(o);this._previousBonesTransformationMatrices[o.uniqueId]=this._copyBonesTransformationMatrices(_,new Float32Array(_.length))}const d=o._getInstancesRenderList(n._id,!!n.getReplacementMesh());if(d.mustReturn)return;const f=c.getCaps().instancedArrays&&(d.visibleInstances[n._id]!==null||o.hasThinInstances),p=l.getWorldMatrix();if(this.isReady(n,f)){const _=n._getDrawWrapper();if(!_)return;const m=_.effect;if(c.enableEffect(_),f||o._bind(n,m,u.fillMode),this._useUbo?(se.BindSceneUniformBuffer(m,this._scene.getSceneUniformBuffer()),this._scene.finalizeSceneUbo()):(m.setMatrix("viewProjection",h.getTransformMatrix()),m.setMatrix("view",h.getViewMatrix())),u){let v;const x=o._instanceDataStorage;if(!x.isFrozen&&(u.backFaceCulling||o.overrideMaterialSideOrientation!==null)){const b=l._getWorldMatrixDeterminant();v=o.overrideMaterialSideOrientation,v===null&&(v=u.sideOrientation),b<0&&(v=v===ne.ClockWiseSideOrientation?ne.CounterClockWiseSideOrientation:ne.ClockWiseSideOrientation)}else v=x.sideOrientation;if(u._preBind(_,v),u.needAlphaTesting()){const b=u.getAlphaTestTexture();b&&(m.setTexture("diffuseSampler",b),m.setMatrix("diffuseMatrix",b.getTextureMatrix()))}u.bumpTexture&&h.getEngine().getCaps().standardDerivatives&&ce.BumpTextureEnabled&&(m.setFloat3("vBumpInfos",u.bumpTexture.coordinatesIndex,1/u.bumpTexture.level,u.parallaxScaleBias),m.setMatrix("bumpMatrix",u.bumpTexture.getTextureMatrix()),m.setTexture("bumpSampler",u.bumpTexture),m.setFloat2("vTangentSpaceParams",u.invertNormalMapX?-1:1,u.invertNormalMapY?-1:1)),this._enableReflectivity&&(u.getClassName()==="PBRMetallicRoughnessMaterial"?(u.metallicRoughnessTexture!==null&&(m.setTexture("reflectivitySampler",u.metallicRoughnessTexture),m.setMatrix("reflectivityMatrix",u.metallicRoughnessTexture.getTextureMatrix())),u.metallic!==null&&m.setFloat("metallic",u.metallic),u.roughness!==null&&m.setFloat("glossiness",1-u.roughness),u.baseTexture!==null&&(m.setTexture("albedoSampler",u.baseTexture),m.setMatrix("albedoMatrix",u.baseTexture.getTextureMatrix())),u.baseColor!==null&&m.setColor3("albedoColor",u.baseColor)):u.getClassName()==="PBRSpecularGlossinessMaterial"?(u.specularGlossinessTexture!==null?(m.setTexture("reflectivitySampler",u.specularGlossinessTexture),m.setMatrix("reflectivityMatrix",u.specularGlossinessTexture.getTextureMatrix())):u.specularColor!==null&&m.setColor3("reflectivityColor",u.specularColor),u.glossiness!==null&&m.setFloat("glossiness",u.glossiness)):u.getClassName()==="PBRMaterial"?(u.metallicTexture!==null&&(m.setTexture("reflectivitySampler",u.metallicTexture),m.setMatrix("reflectivityMatrix",u.metallicTexture.getTextureMatrix())),u.metallic!==null&&m.setFloat("metallic",u.metallic),u.roughness!==null&&m.setFloat("glossiness",1-u.roughness),u.roughness!==null||u.metallic!==null||u.metallicTexture!==null?(u.albedoTexture!==null&&(m.setTexture("albedoSampler",u.albedoTexture),m.setMatrix("albedoMatrix",u.albedoTexture.getTextureMatrix())),u.albedoColor!==null&&m.setColor3("albedoColor",u.albedoColor)):(u.reflectivityTexture!==null?(m.setTexture("reflectivitySampler",u.reflectivityTexture),m.setMatrix("reflectivityMatrix",u.reflectivityTexture.getTextureMatrix())):u.reflectivityColor!==null&&m.setColor3("reflectivityColor",u.reflectivityColor),u.microSurface!==null&&m.setFloat("glossiness",u.microSurface))):u.getClassName()==="StandardMaterial"&&(u.specularTexture!==null&&(m.setTexture("reflectivitySampler",u.specularTexture),m.setMatrix("reflectivityMatrix",u.specularTexture.getTextureMatrix())),u.specularColor!==null&&m.setColor3("reflectivityColor",u.specularColor)))}o.useBones&&o.computeBonesUsingShaders&&o.skeleton&&(m.setMatrices("mBones",o.skeleton.getTransformMatrices(o)),this._enableVelocity&&m.setMatrices("mPreviousBones",this._previousBonesTransformationMatrices[o.uniqueId])),se.BindMorphTargetParameters(o,m),o.morphTargetManager&&o.morphTargetManager.isUsingTextureForTargets&&o.morphTargetManager._bind(m),this._enableVelocity&&(m.setMatrix("previousWorld",this._previousTransformationMatrices[l.uniqueId].world),m.setMatrix("previousViewProjection",this._previousTransformationMatrices[l.uniqueId].viewProjection)),f&&o.hasThinInstances&&m.setMatrix("world",p),o._processRendering(l,n,m,u.fillMode,d,f,(v,x)=>{v||m.setMatrix("world",x)})}this._enableVelocity&&(this._previousTransformationMatrices[l.uniqueId].world=p.clone(),this._previousTransformationMatrices[l.uniqueId].viewProjection=this._scene.getTransformMatrix().clone(),o.skeleton&&this._copyBonesTransformationMatrices(o.skeleton.getTransformMatrices(o),this._previousBonesTransformationMatrices[l.uniqueId]))};this._multiRenderTarget.customIsReadyFunction=(n,o)=>{if(!n.isReady(!1))return!1;if(o===0&&n.subMeshes)for(let l=0;l<n.subMeshes.length;++l){const h=n.subMeshes[l],c=h.getMaterial(),u=h.getRenderingMesh();if(!c)continue;const d=u._getInstancesRenderList(h._id,!!h.getReplacementMesh()),f=e.getCaps().instancedArrays&&(d.visibleInstances[h._id]!==null||u.hasThinInstances);if(!this.isReady(h,f))return!1}return!0},this._multiRenderTarget.customRenderFunction=(n,o,l,h)=>{let c;if(this._linkedWithPrePass){if(!this._prePassRenderer.enabled)return;this._scene.getEngine().bindAttachments(this._attachments)}if(h.length){for(e.setColorWrite(!1),c=0;c<h.length;c++)r(h.data[c]);e.setColorWrite(!0)}for(c=0;c<n.length;c++)r(n.data[c]);for(e.setDepthWrite(!1),c=0;c<o.length;c++)r(o.data[c]);if(this.renderTransparentMeshes)for(c=0;c<l.length;c++)r(l.data[c]);e.setDepthWrite(!0)}}_copyBonesTransformationMatrices(e,t){for(let i=0;i<e.length;i++)t[i]=e[i];return t}}ei.DEPTH_TEXTURE_TYPE=0;ei.NORMAL_TEXTURE_TYPE=1;ei.POSITION_TEXTURE_TYPE=2;ei.VELOCITY_TEXTURE_TYPE=3;ei.REFLECTIVITY_TEXTURE_TYPE=4;ei._SceneComponentInitialization=a=>{throw Ve("GeometryBufferRendererSceneComponent")};class jP{constructor(){this.enabled=!1,this.name="motionBlur",this.texturesRequired=[2]}}Object.defineProperty(ge.prototype,"geometryBufferRenderer",{get:function(){return this._geometryBufferRenderer},set:function(a){a&&a.isSupported&&(this._geometryBufferRenderer=a)},enumerable:!0,configurable:!0});ge.prototype.enableGeometryBufferRenderer=function(a=1,e=15){return this._geometryBufferRenderer?this._geometryBufferRenderer:(this._geometryBufferRenderer=new ei(this,a,e),this._geometryBufferRenderer.isSupported||(this._geometryBufferRenderer=null),this._geometryBufferRenderer)};ge.prototype.disableGeometryBufferRenderer=function(){!this._geometryBufferRenderer||(this._geometryBufferRenderer.dispose(),this._geometryBufferRenderer=null)};class qP{constructor(e){this.name=ue.NAME_GEOMETRYBUFFERRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ue.STEP_GATHERRENDERTARGETS_GEOMETRYBUFFERRENDERER,this,this._gatherRenderTargets)}rebuild(){}dispose(){}_gatherRenderTargets(e){this.scene._geometryBufferRenderer&&e.push(this.scene._geometryBufferRenderer.getGBuffer())}}ei._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_GEOMETRYBUFFERRENDERER);e||(e=new qP(a),a._addComponent(e))};const QP="motionBlurPixelShader",ZP=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float motionStrength;
uniform float motionScale;
uniform vec2 screenSize;
#ifdef OBJECT_BASED
uniform sampler2D velocitySampler;
#else
uniform sampler2D depthSampler;
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#ifdef GEOMETRY_SUPPORTED
#ifdef OBJECT_BASED
vec2 texelSize=1.0/screenSize;
vec4 velocityColor=texture2D(velocitySampler,vUV);
velocityColor.rg=velocityColor.rg*2.0-vec2(1.0);
vec2 velocity=vec2(pow(velocityColor.r,3.0),pow(velocityColor.g,3.0))*velocityColor.a;
velocity*=motionScale*motionStrength;
float speed=length(velocity/texelSize);
int samplesCount=int(clamp(speed,1.0,SAMPLES));
velocity=normalize(velocity)*texelSize;
float hlim=float(-samplesCount)*0.5+0.5;
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i)
{
if (i>=samplesCount)
break;
vec2 offset=vUV+velocity*(hlim+float(i));
result+=texture2D(textureSampler,offset);
}
gl_FragColor=result/float(samplesCount);
gl_FragColor.a=1.0;
#else
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
#endif
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;Y.ShadersStore[QP]=ZP;class $a extends Fe{constructor(e,t,i,s,r,n,o,l=0,h=!1,c=!1){super(e,"motionBlur",["motionStrength","motionScale","screenSize","inverseViewProjection","prevViewProjection"],["velocitySampler"],i,s,r,n,o,`#define GEOMETRY_SUPPORTED
#define SAMPLES 64.0
#define OBJECT_BASED`,l,void 0,null,h),this.motionStrength=1,this._motionBlurSamples=32,this._isObjectBased=!0,this._forceGeometryBuffer=!1,this._invViewProjection=null,this._previousViewProjection=null,this._forceGeometryBuffer=c,this._forceGeometryBuffer?(t.enableGeometryBufferRenderer(),this._geometryBufferRenderer&&(this._geometryBufferRenderer.enableVelocity=!0)):(t.enablePrePassRenderer(),this._prePassRenderer&&(this._prePassRenderer.markAsDirty(),this._prePassEffectConfiguration=new jP)),this._applyMode()}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this._motionBlurSamples=e,this._updateEffect()}get isObjectBased(){return this._isObjectBased}set isObjectBased(e){this._isObjectBased!==e&&(this._isObjectBased=e,this._applyMode())}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"MotionBlurPostProcess"}excludeSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;t.push(e)}}removeExcludedSkinnedMesh(e){if(e.skeleton){let t;if(this._geometryBufferRenderer)t=this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity;else if(this._prePassRenderer)t=this._prePassRenderer.excludedSkinnedMesh;else return;const i=t.indexOf(e);i!==-1&&t.splice(i,1)}}dispose(e){this._geometryBufferRenderer&&(this._geometryBufferRenderer._previousTransformationMatrices={},this._geometryBufferRenderer._previousBonesTransformationMatrices={},this._geometryBufferRenderer.excludedSkinnedMeshesFromVelocity=[]),super.dispose(e)}_applyMode(){if(!this._geometryBufferRenderer&&!this._prePassRenderer)return B.Warn("Multiple Render Target support needed to compute object based motion blur"),this.updateEffect();this._updateEffect(),this._invViewProjection=null,this._previousViewProjection=null,this.isObjectBased?(this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=2),this.onApply=e=>this._onApplyObjectBased(e)):(this._invViewProjection=L.Identity(),this._previousViewProjection=L.Identity(),this._prePassRenderer&&this._prePassEffectConfiguration&&(this._prePassEffectConfiguration.texturesRequired[0]=5),this.onApply=e=>this._onApplyScreenBased(e))}_onApplyObjectBased(e){if(e.setVector2("screenSize",new le(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const t=this._geometryBufferRenderer.getTextureIndex(ei.VELOCITY_TEXTURE_TYPE);e.setTexture("velocitySampler",this._geometryBufferRenderer.getGBuffer().textures[t])}else if(this._prePassRenderer){const t=this._prePassRenderer.getIndex(2);e.setTexture("velocitySampler",this._prePassRenderer.getRenderTarget().textures[t])}}_onApplyScreenBased(e){const t=this._scene.getProjectionMatrix().multiply(this._scene.getViewMatrix());if(t.invertToRef(this._invViewProjection),e.setMatrix("inverseViewProjection",this._invViewProjection),e.setMatrix("prevViewProjection",this._previousViewProjection),this._previousViewProjection=t,e.setVector2("screenSize",new le(this.width,this.height)),e.setFloat("motionScale",this._scene.getAnimationRatio()),e.setFloat("motionStrength",this.motionStrength),this._geometryBufferRenderer){const i=this._geometryBufferRenderer.getTextureIndex(ei.DEPTH_TEXTURE_TYPE);e.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[i])}else if(this._prePassRenderer){const i=this._prePassRenderer.getIndex(5);e.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[i])}}_updateEffect(){if(this._geometryBufferRenderer||this._prePassRenderer){const e=["#define GEOMETRY_SUPPORTED","#define SAMPLES "+this._motionBlurSamples.toFixed(1),this._isObjectBased?"#define OBJECT_BASED":"#define SCREEN_BASED"];this.updateEffect(e.join(`
`))}}static _Parse(e,t,i,s){return xe.Parse(()=>new $a(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable,e.textureType,!1),e,i,s)}}T([R()],$a.prototype,"motionStrength",void 0);T([R()],$a.prototype,"motionBlurSamples",null);T([R()],$a.prototype,"isObjectBased",null);he("BABYLON.MotionBlurPostProcess",$a);const JP="refractionPixelShader",e2=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D refractionSampler;
uniform vec3 baseColor;
uniform float depth;
uniform float colorLevel;
void main() {
float ref=1.0-texture2D(refractionSampler,vUV).r;
vec2 uv=vUV-vec2(0.5);
vec2 offset=uv*depth*ref;
vec3 sourceColor=texture2D(textureSampler,vUV-offset).rgb;
gl_FragColor=vec4(sourceColor+sourceColor*ref*colorLevel,1.0);
}`;Y.ShadersStore[JP]=e2;class ja extends Fe{constructor(e,t,i,s,r,n,o,l,h,c){super(e,"refraction",["baseColor","depth","colorLevel"],["refractionSampler"],n,o,l,h,c),this._ownRefractionTexture=!0,this.color=i,this.depth=s,this.colorLevel=r,this.refractionTextureUrl=t,this.onActivateObservable.add(u=>{this._refTexture=this._refTexture||new H(t,u.getScene())}),this.onApplyObservable.add(u=>{u.setColor3("baseColor",this.color),u.setFloat("depth",this.depth),u.setFloat("colorLevel",this.colorLevel),u.setTexture("refractionSampler",this._refTexture)})}get refractionTexture(){return this._refTexture}set refractionTexture(e){this._refTexture&&this._ownRefractionTexture&&this._refTexture.dispose(),this._refTexture=e,this._ownRefractionTexture=!1}getClassName(){return"RefractionPostProcess"}dispose(e){this._refTexture&&this._ownRefractionTexture&&(this._refTexture.dispose(),this._refTexture=null),super.dispose(e)}static _Parse(e,t,i,s){return xe.Parse(()=>new ja(e.name,e.refractionTextureUrl,e.color,e.depth,e.colorLevel,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.reusable),e,i,s)}}T([R()],ja.prototype,"color",void 0);T([R()],ja.prototype,"depth",void 0);T([R()],ja.prototype,"colorLevel",void 0);T([R()],ja.prototype,"refractionTextureUrl",void 0);he("BABYLON.RefractionPostProcess",ja);const t2="sharpenPixelShader",i2=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform vec2 screenSize;
uniform vec2 sharpnessAmounts;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec2 onePixel=vec2(1.0,1.0)/screenSize;
vec4 color=texture2D(textureSampler,vUV);
vec4 edgeDetection=texture2D(textureSampler,vUV+onePixel*vec2(0,-1)) +
texture2D(textureSampler,vUV+onePixel*vec2(-1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(1,0)) +
texture2D(textureSampler,vUV+onePixel*vec2(0,1)) -
color*4.0;
gl_FragColor=max(vec4(color.rgb*sharpnessAmounts.y,color.a)-(sharpnessAmounts.x*vec4(edgeDetection.rgb,0)),0.);
}`;Y.ShadersStore[t2]=i2;class Zo extends Fe{constructor(e,t,i,s,r,n,o=0,l=!1){super(e,"sharpen",["sharpnessAmounts","screenSize"],null,t,i,s,r,n,null,o,void 0,null,l),this.colorAmount=1,this.edgeAmount=.3,this.onApply=h=>{h.setFloat2("screenSize",this.width,this.height),h.setFloat2("sharpnessAmounts",this.edgeAmount,this.colorAmount)}}getClassName(){return"SharpenPostProcess"}static _Parse(e,t,i,s){return xe.Parse(()=>new Zo(e.name,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,s)}}T([R()],Zo.prototype,"colorAmount",void 0);T([R()],Zo.prototype,"edgeAmount",void 0);he("BABYLON.SharpenPostProcess",Zo);class ih{constructor(e,t){this._engine=e,this._name=t,this._renderEffects={},this._renderEffectsForIsolatedPass=new Array,this._cameras=[]}get name(){return this._name}get cameras(){return this._cameras}getClassName(){return"PostProcessRenderPipeline"}get isSupported(){for(const e in this._renderEffects)if(Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&!this._renderEffects[e].isSupported)return!1;return!0}addEffect(e){this._renderEffects[e._name]=e}_rebuild(){}_enableEffect(e,t){const i=this._renderEffects[e];!i||i._enable(q.MakeArray(t||this._cameras))}_disableEffect(e,t){const i=this._renderEffects[e];!i||i._disable(q.MakeArray(t||this._cameras))}_attachCameras(e,t){const i=q.MakeArray(e||this._cameras);if(!i)return;const s=[];let r;for(r=0;r<i.length;r++){const n=i[r];!n||(this._cameras.indexOf(n)===-1?this._cameras.push(n):t&&s.push(r))}for(r=0;r<s.length;r++)i.splice(s[r],1);for(const n in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,n)&&this._renderEffects[n]._attachCameras(i)}_detachCameras(e){const t=q.MakeArray(e||this._cameras);if(!!t){for(const i in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,i)&&this._renderEffects[i]._detachCameras(t);for(let i=0;i<t.length;i++)this._cameras.splice(this._cameras.indexOf(t[i]),1)}}_update(){for(const e in this._renderEffects)Object.prototype.hasOwnProperty.call(this._renderEffects,e)&&this._renderEffects[e]._update();for(let e=0;e<this._cameras.length;e++){if(!this._cameras[e])continue;const t=this._cameras[e].name;this._renderEffectsForIsolatedPass[t]&&this._renderEffectsForIsolatedPass[t]._update()}}_reset(){this._renderEffects={},this._renderEffectsForIsolatedPass=new Array}_enableMSAAOnFirstPostProcess(e){if(!this._engine._features.supportMSAA)return!1;const t=Object.keys(this._renderEffects);if(t.length>0){const i=this._renderEffects[t[0]].getPostProcesses();i&&(i[0].samples=e)}return!0}setPrePassRenderer(e){return!1}dispose(){}}T([R()],ih.prototype,"_name",void 0);class s2{constructor(){this._renderPipelines={}}get supportedPipelines(){const e=[];for(const t in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,t)){const i=this._renderPipelines[t];i.isSupported&&e.push(i)}return e}addPipeline(e){this._renderPipelines[e._name]=e}attachCamerasToRenderPipeline(e,t,i=!1){const s=this._renderPipelines[e];!s||s._attachCameras(t,i)}detachCamerasFromRenderPipeline(e,t){const i=this._renderPipelines[e];!i||i._detachCameras(t)}enableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];!s||s._enableEffect(t,i)}disableEffectInPipeline(e,t,i){const s=this._renderPipelines[e];!s||s._disableEffect(t,i)}update(){for(const e in this._renderPipelines)if(Object.prototype.hasOwnProperty.call(this._renderPipelines,e)){const t=this._renderPipelines[e];t.isSupported?t._update():(t.dispose(),delete this._renderPipelines[e])}}_rebuild(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e]._rebuild()}dispose(){for(const e in this._renderPipelines)Object.prototype.hasOwnProperty.call(this._renderPipelines,e)&&this._renderPipelines[e].dispose()}}Object.defineProperty(ge.prototype,"postProcessRenderPipelineManager",{get:function(){if(!this._postProcessRenderPipelineManager){let a=this._getComponent(ue.NAME_POSTPROCESSRENDERPIPELINEMANAGER);a||(a=new r2(this),this._addComponent(a)),this._postProcessRenderPipelineManager=new s2}return this._postProcessRenderPipelineManager},enumerable:!0,configurable:!0});class r2{constructor(e){this.name=ue.NAME_POSTPROCESSRENDERPIPELINEMANAGER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ue.STEP_GATHERRENDERTARGETS_POSTPROCESSRENDERPIPELINEMANAGER,this,this._gatherRenderTargets)}rebuild(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager._rebuild()}dispose(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.dispose()}_gatherRenderTargets(){this.scene._postProcessRenderPipelineManager&&this.scene._postProcessRenderPipelineManager.update()}}class Ki extends ih{constructor(e="",t=!0,i=ye.LastCreatedScene,s,r=!0){super(i.getEngine(),e),this._camerasToBeAttached=[],this.SharpenPostProcessId="SharpenPostProcessEffect",this.ImageProcessingPostProcessId="ImageProcessingPostProcessEffect",this.FxaaPostProcessId="FxaaPostProcessEffect",this.ChromaticAberrationPostProcessId="ChromaticAberrationPostProcessEffect",this.GrainPostProcessId="GrainPostProcessEffect",this._glowLayer=null,this.animations=[],this._imageProcessingConfigurationObserver=null,this._sharpenEnabled=!1,this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._depthOfFieldBlurLevel=So.Low,this._fxaaEnabled=!1,this._imageProcessingEnabled=!0,this._bloomScale=.5,this._chromaticAberrationEnabled=!1,this._grainEnabled=!1,this._buildAllowed=!0,this.onBuildObservable=new X,this._resizeObserver=null,this._hardwareScaleLevel=1,this._bloomKernel=64,this._bloomWeight=.15,this._bloomThreshold=.9,this._samples=1,this._hasCleared=!1,this._prevPostProcess=null,this._prevPrevPostProcess=null,this._depthOfFieldSceneObserver=null,this._activeCameraChangedObserver=null,this._activeCamerasChangedObserver=null,this._cameras=s||i.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._buildAllowed=r,this._scene=i;const n=this._scene.getEngine().getCaps();this._hdr=t&&(n.textureHalfFloatRender||n.textureFloatRender),this._hdr?n.textureHalfFloatRender?this._defaultPipelineTextureType=2:n.textureFloatRender&&(this._defaultPipelineTextureType=1):this._defaultPipelineTextureType=0,i.postProcessRenderPipelineManager.addPipeline(this);const o=this._scene.getEngine();this.sharpen=new Zo("sharpen",1,null,H.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._sharpenEffect=new bt(o,this.SharpenPostProcessId,()=>this.sharpen,!0),this.depthOfField=new up(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!0),this.bloom=new cp(this._scene,this._bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!0),this.chromaticAberration=new tn("ChromaticAberration",o.getRenderWidth(),o.getRenderHeight(),1,null,H.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._chromaticAberrationEffect=new bt(o,this.ChromaticAberrationPostProcessId,()=>this.chromaticAberration,!0),this.grain=new Qo("Grain",1,null,H.BILINEAR_SAMPLINGMODE,o,!1,this._defaultPipelineTextureType,!0),this._grainEffect=new bt(o,this.GrainPostProcessId,()=>this.grain,!0),this._resizeObserver=o.onResizeObservable.add(()=>{this._hardwareScaleLevel=o.getHardwareScalingLevel(),this.bloomKernel=this._bloomKernel}),this._imageProcessingConfigurationObserver=this._scene.imageProcessingConfiguration.onUpdateParameters.add(()=>{this.bloom._downscale._exposure=this._scene.imageProcessingConfiguration.exposure,this.imageProcessingEnabled!==this._scene.imageProcessingConfiguration.isEnabled&&(this._imageProcessingEnabled=this._scene.imageProcessingConfiguration.isEnabled,this._buildPipeline())}),this._buildPipeline()}get scene(){return this._scene}set sharpenEnabled(e){this._sharpenEnabled!==e&&(this._sharpenEnabled=e,this._buildPipeline())}get sharpenEnabled(){return this._sharpenEnabled}get bloomKernel(){return this._bloomKernel}set bloomKernel(e){this._bloomKernel=e,this.bloom.kernel=e/this._hardwareScaleLevel}set bloomWeight(e){this._bloomWeight!==e&&(this.bloom.weight=e,this._bloomWeight=e)}get bloomWeight(){return this._bloomWeight}set bloomThreshold(e){this._bloomThreshold!==e&&(this.bloom.threshold=e,this._bloomThreshold=e)}get bloomThreshold(){return this._bloomThreshold}set bloomScale(e){this._bloomScale!==e&&(this._bloomScale=e,this._rebuildBloom(),this._buildPipeline())}get bloomScale(){return this._bloomScale}set bloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get bloomEnabled(){return this._bloomEnabled}_rebuildBloom(){const e=this.bloom;this.bloom=new cp(this._scene,this.bloomScale,this._bloomWeight,this.bloomKernel,this._defaultPipelineTextureType,!1),this.bloom.threshold=e.threshold;for(let t=0;t<this._cameras.length;t++)e.disposeEffects(this._cameras[t])}get depthOfFieldEnabled(){return this._depthOfFieldEnabled}set depthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get depthOfFieldBlurLevel(){return this._depthOfFieldBlurLevel}set depthOfFieldBlurLevel(e){if(this._depthOfFieldBlurLevel===e)return;this._depthOfFieldBlurLevel=e;const t=this.depthOfField;this.depthOfField=new up(this._scene,null,this._depthOfFieldBlurLevel,this._defaultPipelineTextureType,!1),this.depthOfField.focalLength=t.focalLength,this.depthOfField.focusDistance=t.focusDistance,this.depthOfField.fStop=t.fStop,this.depthOfField.lensSize=t.lensSize;for(let i=0;i<this._cameras.length;i++)t.disposeEffects(this._cameras[i]);this._buildPipeline()}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}get samples(){return this._samples}set imageProcessingEnabled(e){this._imageProcessingEnabled!==e&&(this._scene.imageProcessingConfiguration.isEnabled=e)}get imageProcessingEnabled(){return this._imageProcessingEnabled}set glowLayerEnabled(e){e&&!this._glowLayer?this._glowLayer=new er("",this._scene):!e&&this._glowLayer&&(this._glowLayer.dispose(),this._glowLayer=null)}get glowLayerEnabled(){return this._glowLayer!=null}get glowLayer(){return this._glowLayer}set chromaticAberrationEnabled(e){this._chromaticAberrationEnabled!==e&&(this._chromaticAberrationEnabled=e,this._buildPipeline())}get chromaticAberrationEnabled(){return this._chromaticAberrationEnabled}set grainEnabled(e){this._grainEnabled!==e&&(this._grainEnabled=e,this._buildPipeline())}get grainEnabled(){return this._grainEnabled}getClassName(){return"DefaultRenderingPipeline"}prepare(){const e=this._buildAllowed;this._buildAllowed=!0,this._buildPipeline(),this._buildAllowed=e}_setAutoClearAndTextureSharing(e,t=!1){this._hasCleared?e.autoClear=!1:(e.autoClear=!0,this._scene.autoClear=!1,this._hasCleared=!0),t||(this._prevPrevPostProcess?e.shareOutputWith(this._prevPrevPostProcess):e.useOwnOutput(),this._prevPostProcess&&(this._prevPrevPostProcess=this._prevPostProcess),this._prevPostProcess=e)}_buildPipeline(){if(!this._buildAllowed)return;this._scene.autoClear=!0;const e=this._scene.getEngine();if(this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._prevPostProcess=null,this._prevPrevPostProcess=null,this._hasCleared=!1,this.depthOfFieldEnabled){if(this._cameras.length>1){for(const t of this._cameras){const i=this._scene.enableDepthRenderer(t);i.useOnlyInActiveCamera=!0}this._depthOfFieldSceneObserver=this._scene.onAfterRenderTargetsRenderObservable.add(t=>{this._cameras.indexOf(t.activeCamera)>-1&&(this.depthOfField.depthTexture=t.enableDepthRenderer(t.activeCamera).getDepthMap())})}else{this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);const t=this._scene.enableDepthRenderer(this._cameras[0]);this.depthOfField.depthTexture=t.getDepthMap()}this.depthOfField._isReady()||this.depthOfField._updateEffects(),this.addEffect(this.depthOfField),this._setAutoClearAndTextureSharing(this.depthOfField._effects[0],!0)}else this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver);this.bloomEnabled&&(this.bloom._isReady()||this.bloom._updateEffects(),this.addEffect(this.bloom),this._setAutoClearAndTextureSharing(this.bloom._effects[0],!0)),this._imageProcessingEnabled&&(this.imageProcessing=new kc("imageProcessing",1,null,H.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType,this.scene.imageProcessingConfiguration),this._hdr?(this.addEffect(new bt(e,this.ImageProcessingPostProcessId,()=>this.imageProcessing,!0)),this._setAutoClearAndTextureSharing(this.imageProcessing)):this._scene.imageProcessingConfiguration.applyByPostProcess=!1,(!this._cameras||this._cameras.length===0)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!1),this.imageProcessing.getEffect()||this.imageProcessing._updateParameters()),this.sharpenEnabled&&(this.sharpen.isReady()||this.sharpen.updateEffect(),this.addEffect(this._sharpenEffect),this._setAutoClearAndTextureSharing(this.sharpen)),this.grainEnabled&&(this.grain.isReady()||this.grain.updateEffect(),this.addEffect(this._grainEffect),this._setAutoClearAndTextureSharing(this.grain)),this.chromaticAberrationEnabled&&(this.chromaticAberration.isReady()||this.chromaticAberration.updateEffect(),this.addEffect(this._chromaticAberrationEffect),this._setAutoClearAndTextureSharing(this.chromaticAberration)),this.fxaaEnabled&&(this.fxaa=new qo("fxaa",1,null,H.BILINEAR_SAMPLINGMODE,e,!1,this._defaultPipelineTextureType),this.addEffect(new bt(e,this.FxaaPostProcessId,()=>this.fxaa,!0)),this._setAutoClearAndTextureSharing(this.fxaa,!0)),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),(this._scene.activeCameras&&this._scene.activeCameras.length>1||this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1)&&(this._scene.autoClear=!0),this._activeCameraChangedObserver||(this._activeCameraChangedObserver=this._scene.onActiveCameraChanged.add(()=>{this._scene.activeCamera&&this._cameras.indexOf(this._scene.activeCamera)===-1&&(this._scene.autoClear=!0)})),this._activeCamerasChangedObserver||(this._activeCamerasChangedObserver=this._scene.onActiveCamerasChanged.add(()=>{this._scene.activeCameras&&this._scene.activeCameras.length>1&&(this._scene.autoClear=!0)})),!this._enableMSAAOnFirstPostProcess(this.samples)&&this.samples>1&&B.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0"),this.onBuildObservable.notifyObservers(this)}_disposePostProcesses(e=!1){for(let t=0;t<this._cameras.length;t++){const i=this._cameras[t];this.imageProcessing&&this.imageProcessing.dispose(i),this.fxaa&&this.fxaa.dispose(i),e&&(this.sharpen&&this.sharpen.dispose(i),this.depthOfField&&(this._scene.onAfterRenderTargetsRenderObservable.remove(this._depthOfFieldSceneObserver),this.depthOfField.disposeEffects(i)),this.bloom&&this.bloom.disposeEffects(i),this.chromaticAberration&&this.chromaticAberration.dispose(i),this.grain&&this.grain.dispose(i),this._glowLayer&&this._glowLayer.dispose())}this.imageProcessing=null,this.fxaa=null,e&&(this.sharpen=null,this._sharpenEffect=null,this.depthOfField=null,this.bloom=null,this.chromaticAberration=null,this._chromaticAberrationEffect=null,this.grain=null,this._grainEffect=null,this._glowLayer=null)}addCamera(e){this._camerasToBeAttached.push(e),this._buildPipeline()}removeCamera(e){const t=this._camerasToBeAttached.indexOf(e);this._camerasToBeAttached.splice(t,1),this._buildPipeline()}dispose(){this.onBuildObservable.clear(),this._disposePostProcesses(!0),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._scene.autoClear=!0,this._resizeObserver&&(this._scene.getEngine().onResizeObservable.remove(this._resizeObserver),this._resizeObserver=null),this._scene.onActiveCameraChanged.remove(this._activeCameraChangedObserver),this._scene.onActiveCamerasChanged.remove(this._activeCamerasChangedObserver),this._scene.imageProcessingConfiguration.onUpdateParameters.remove(this._imageProcessingConfigurationObserver),super.dispose()}serialize(){const e=xe.Serialize(this);return e.customType="DefaultRenderingPipeline",e}static Parse(e,t,i){return xe.Parse(()=>new Ki(e._name,e._name._hdr,t),e,t,i)}}T([R()],Ki.prototype,"sharpenEnabled",null);T([R()],Ki.prototype,"bloomKernel",null);T([R()],Ki.prototype,"_bloomWeight",void 0);T([R()],Ki.prototype,"_bloomThreshold",void 0);T([R()],Ki.prototype,"_hdr",void 0);T([R()],Ki.prototype,"bloomWeight",null);T([R()],Ki.prototype,"bloomThreshold",null);T([R()],Ki.prototype,"bloomScale",null);T([R()],Ki.prototype,"bloomEnabled",null);T([R()],Ki.prototype,"depthOfFieldEnabled",null);T([R()],Ki.prototype,"depthOfFieldBlurLevel",null);T([R()],Ki.prototype,"fxaaEnabled",null);T([R()],Ki.prototype,"samples",null);T([R()],Ki.prototype,"imageProcessingEnabled",null);T([R()],Ki.prototype,"glowLayerEnabled",null);T([R()],Ki.prototype,"chromaticAberrationEnabled",null);T([R()],Ki.prototype,"grainEnabled",null);he("BABYLON.DefaultRenderingPipeline",Ki);const n2="lensHighlightsPixelShader",a2=`uniform sampler2D textureSampler; 
uniform float gain;
uniform float threshold;
uniform float screen_width;
uniform float screen_height;
varying vec2 vUV;
vec4 highlightColor(vec4 color) {
vec4 highlight=color;
float luminance=dot(highlight.rgb,vec3(0.2125,0.7154,0.0721));
float lum_threshold;
if (threshold>1.0) { lum_threshold=0.94+0.01*threshold; }
else { lum_threshold=0.5+0.44*threshold; }
luminance=clamp((luminance-lum_threshold)*(1.0/(1.0-lum_threshold)),0.0,1.0);
highlight*=luminance*gain;
highlight.a=1.0;
return highlight;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
vec4 original=texture2D(textureSampler,vUV);
if (gain==-1.0) {
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
return;
}
float w=2.0/screen_width;
float h=2.0/screen_height;
float weight=1.0;
vec4 blurred=vec4(0.0,0.0,0.0,0.0);
#ifdef PENTAGON
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.84*w,0.43*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.48*w,-1.29*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.61*w,1.51*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.55*w,-0.74*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.71*w,-0.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.94*w,1.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.40*w,-1.87*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.62*w,1.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.09*w,0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.46*w,-1.71*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.08*w,2.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.85*w,-1.89*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.89*w,0.16*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.29*w,1.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.40*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.54*w,2.26*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.60*w,-0.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.31*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.83*w,2.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.12*w,-2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.60*w,1.11*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.99*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.50*w,-2.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.85*w,3.33*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.94*w,-1.92*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.27*w,-0.53*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.95*w,2.48*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.23*w,-3.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.17*w,2.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.97*w,-0.04*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.25*w,-2.00*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.31*w,3.08*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.94*w,-2.59*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.37*w,0.64*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.13*w,1.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.03*w,-3.65*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.60*w,3.17*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.14*w,-1.19*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.00*w,-1.19*h)));
#else
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.85*w,0.36*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.52*w,-1.14*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.46*w,1.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.46*w,-0.83*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.79*w,-0.42*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.11*w,1.62*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.29*w,-2.07*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.69*w,1.39*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.28*w,0.12*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.65*w,-1.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.08*w,2.44*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.63*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.55*w,0.31*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.13*w,1.52*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.56*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.38*w,2.34*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.64*w,-0.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.53*w,-1.21*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.06*w,2.63*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.00*w,-2.69*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.59*w,1.32*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.82*w,0.78*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.57*w,-2.50*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(0.54*w,2.93*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.39*w,-1.81*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,-0.28*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.04*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.02*w,-3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.09*w,2.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-3.07*w,-0.25*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.44*w,-1.90*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-0.52*w,3.05*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-1.68*w,-2.61*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(3.01*w,0.79*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.76*w,1.46*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.05*w,-2.94*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(1.21*w,2.88*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(-2.84*w,-1.30*h)));
blurred+=highlightColor(texture2D(textureSampler,vUV+vec2(2.98*w,-0.96*h)));
#endif
blurred/=39.0;
gl_FragColor=blurred;
}`;Y.ShadersStore[n2]=a2;const o2="depthOfFieldPixelShader",l2=`uniform sampler2D textureSampler;
uniform sampler2D highlightsSampler;
uniform sampler2D depthSampler;
uniform sampler2D grainSampler;
uniform float grain_amount;
uniform bool blur_noise;
uniform float screen_width;
uniform float screen_height;
uniform float distortion;
uniform bool dof_enabled;
uniform float screen_distance; 
uniform float aperture;
uniform float darken;
uniform float edge_blur;
uniform bool highlights;
uniform float near;
uniform float far;
varying vec2 vUV;
#define PI 3.14159265
#define TWOPI 6.28318530
#define inverse_focal_length 0.1 
vec2 centered_screen_pos;
vec2 distorted_coords;
float radius2;
float radius;
vec2 rand(vec2 co)
{
float noise1=(fract(sin(dot(co,vec2(12.9898,78.233)))*43758.5453));
float noise2=(fract(sin(dot(co,vec2(12.9898,78.233)*2.0))*43758.5453));
return clamp(vec2(noise1,noise2),0.0,1.0);
}
vec2 getDistortedCoords(vec2 coords) {
if (distortion==0.0) { return coords; }
vec2 direction=1.0*normalize(centered_screen_pos);
vec2 dist_coords=vec2(0.5,0.5);
dist_coords.x=0.5+direction.x*radius2*1.0;
dist_coords.y=0.5+direction.y*radius2*1.0;
float dist_amount=clamp(distortion*0.23,0.0,1.0);
dist_coords=mix(coords,dist_coords,dist_amount);
return dist_coords;
}
float sampleScreen(inout vec4 color,in vec2 offset,in float weight) {
vec2 coords=distorted_coords;
float angle=rand(coords*100.0).x*TWOPI;
coords+=vec2(offset.x*cos(angle)-offset.y*sin(angle),offset.x*sin(angle)+offset.y*cos(angle));
color+=texture2D(textureSampler,coords)*weight;
return weight;
}
float getBlurLevel(float size) {
return min(3.0,ceil(size/1.0));
}
vec4 getBlurColor(float size) {
vec4 col=texture2D(textureSampler,distorted_coords);
float blur_level=getBlurLevel(size);
float w=(size/screen_width);
float h=(size/screen_height);
float total_weight=1.0;
vec2 sample_coords;
total_weight+=sampleScreen(col,vec2(-0.50*w,0.24*h),0.93);
total_weight+=sampleScreen(col,vec2(0.30*w,-0.75*h),0.90);
total_weight+=sampleScreen(col,vec2(0.36*w,0.96*h),0.87);
total_weight+=sampleScreen(col,vec2(-1.08*w,-0.55*h),0.85);
total_weight+=sampleScreen(col,vec2(1.33*w,-0.37*h),0.83);
total_weight+=sampleScreen(col,vec2(-0.82*w,1.31*h),0.80);
total_weight+=sampleScreen(col,vec2(-0.31*w,-1.67*h),0.78);
total_weight+=sampleScreen(col,vec2(1.47*w,1.11*h),0.76);
total_weight+=sampleScreen(col,vec2(-1.97*w,0.19*h),0.74);
total_weight+=sampleScreen(col,vec2(1.42*w,-1.57*h),0.72);
if (blur_level>1.0) {
total_weight+=sampleScreen(col,vec2(0.01*w,2.25*h),0.70);
total_weight+=sampleScreen(col,vec2(-1.62*w,-1.74*h),0.67);
total_weight+=sampleScreen(col,vec2(2.49*w,0.20*h),0.65);
total_weight+=sampleScreen(col,vec2(-2.07*w,1.61*h),0.63);
total_weight+=sampleScreen(col,vec2(0.46*w,-2.70*h),0.61);
total_weight+=sampleScreen(col,vec2(1.55*w,2.40*h),0.59);
total_weight+=sampleScreen(col,vec2(-2.88*w,-0.75*h),0.56);
total_weight+=sampleScreen(col,vec2(2.73*w,-1.44*h),0.54);
total_weight+=sampleScreen(col,vec2(-1.08*w,3.02*h),0.52);
total_weight+=sampleScreen(col,vec2(-1.28*w,-3.05*h),0.49);
}
if (blur_level>2.0) {
total_weight+=sampleScreen(col,vec2(3.11*w,1.43*h),0.46);
total_weight+=sampleScreen(col,vec2(-3.36*w,1.08*h),0.44);
total_weight+=sampleScreen(col,vec2(1.80*w,-3.16*h),0.41);
total_weight+=sampleScreen(col,vec2(0.83*w,3.65*h),0.38);
total_weight+=sampleScreen(col,vec2(-3.16*w,-2.19*h),0.34);
total_weight+=sampleScreen(col,vec2(3.92*w,-0.53*h),0.31);
total_weight+=sampleScreen(col,vec2(-2.59*w,3.12*h),0.26);
total_weight+=sampleScreen(col,vec2(-0.20*w,-4.15*h),0.22);
total_weight+=sampleScreen(col,vec2(3.02*w,3.00*h),0.15);
}
col/=total_weight; 
if (darken>0.0) {
col.rgb*=clamp(0.3,1.0,1.05-size*0.5*darken);
}
return col;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
centered_screen_pos=vec2(vUV.x-0.5,vUV.y-0.5);
radius2=centered_screen_pos.x*centered_screen_pos.x+centered_screen_pos.y*centered_screen_pos.y;
radius=sqrt(radius2);
distorted_coords=getDistortedCoords(vUV); 
vec2 texels_coords=vec2(vUV.x*screen_width,vUV.y*screen_height); 
float depth=texture2D(depthSampler,distorted_coords).r; 
float distance=near+(far-near)*depth; 
vec4 color=texture2D(textureSampler,vUV); 
float coc=abs(aperture*(screen_distance*(inverse_focal_length-1.0/distance)-1.0));
if (dof_enabled==false || coc<0.07) { coc=0.0; }
float edge_blur_amount=0.0;
if (edge_blur>0.0) {
edge_blur_amount=clamp((radius*2.0-1.0+0.15*edge_blur)*1.5,0.0,1.0)*1.3;
}
float blur_amount=max(edge_blur_amount,coc);
if (blur_amount==0.0) {
gl_FragColor=texture2D(textureSampler,distorted_coords);
}
else {
gl_FragColor=getBlurColor(blur_amount*1.7);
if (highlights) {
gl_FragColor.rgb+=clamp(coc,0.0,1.0)*texture2D(highlightsSampler,distorted_coords).rgb;
}
if (blur_noise) {
vec2 noise=rand(distorted_coords)*0.01*blur_amount;
vec2 blurred_coord=vec2(distorted_coords.x+noise.x,distorted_coords.y+noise.y);
gl_FragColor=0.04*texture2D(textureSampler,blurred_coord)+0.96*gl_FragColor;
}
}
if (grain_amount>0.0) {
vec4 grain_color=texture2D(grainSampler,texels_coords*0.003);
gl_FragColor.rgb+=(-0.5+grain_color.rgb)*0.30*grain_amount;
}
}
`;Y.ShadersStore[o2]=l2;class h2{constructor(){this.enabled=!1,this.name="ssao2",this.texturesRequired=[6,5]}}const c2="ssao2PixelShader",u2=`precision highp float;
uniform sampler2D textureSampler;
uniform float near;
uniform float far;
uniform float radius;
float scales[16]=float[16](
0.1,
0.11406250000000001,
0.131640625,
0.15625,
0.187890625,
0.2265625,
0.272265625,
0.325,
0.384765625,
0.4515625,
0.525390625,
0.60625,
0.694140625,
0.7890625,
0.891015625,
1.0
);
varying vec2 vUV;
float perspectiveDepthToViewZ(in float invClipZ,in float near,in float far ) {
return ( near*far )/( ( far-near )*invClipZ-far );
}
float viewZToPerspectiveDepth( in float viewZ,in float near,in float far ) {
return ( near*far/viewZ+far)/( far-near );
}
float viewZToOrthographicDepth( in float viewZ,in float near,in float far ) {
return ( viewZ+near )/( near-far );
}
#ifdef SSAO
uniform sampler2D randomSampler;
uniform sampler2D depthSampler;
uniform sampler2D normalSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float base;
uniform float xViewport;
uniform float yViewport;
uniform mat3 depthProjection;
uniform float maxZ;
uniform float minZAspect;
uniform vec2 texelSize;
uniform mat4 projection;
void main()
{
vec3 random=texture2D(randomSampler,vUV*randTextureTiles).rgb;
float depth=texture2D(depthSampler,vUV).r;
float depthSign=depth/abs(depth);
depth=depth*depthSign;
vec3 normal=texture2D(normalSampler,vUV).rgb;
float occlusion=0.0;
float correctedRadius=min(radius,minZAspect*depth/near);
vec3 vViewRay=vec3((vUV.x*2.0-1.0)*xViewport,(vUV.y*2.0-1.0)*yViewport,depthSign);
vec3 vDepthFactor=depthProjection*vec3(1.0,1.0,depth);
vec3 origin=vViewRay*vDepthFactor;
vec3 rvec=random*2.0-1.0;
rvec.z=0.0;
float dotProduct=dot(rvec,normal);
rvec=1.0-abs(dotProduct)>1e-2 ? rvec : vec3(-rvec.y,0.0,rvec.x);
vec3 tangent=normalize(rvec-normal*dot(rvec,normal));
vec3 bitangent=cross(normal,tangent);
mat3 tbn=mat3(tangent,bitangent,normal);
float difference;
for (int i=0; i<SAMPLES; ++i) {
vec3 samplePosition=scales[(i+int(random.x*16.0)) % 16]*tbn*sampleSphere[(i+int(random.y*16.0)) % 16];
samplePosition=samplePosition*correctedRadius+origin;
vec4 offset=vec4(samplePosition,1.0);
offset=projection*offset;
offset.xyz/=offset.w;
offset.xy=offset.xy*0.5+0.5;
if (offset.x<0.0 || offset.y<0.0 || offset.x>1.0 || offset.y>1.0) {
continue;
}
float sampleDepth=abs(texture2D(depthSampler,offset.xy).r);
difference=depthSign*samplePosition.z-sampleDepth;
float rangeCheck=1.0-smoothstep(correctedRadius*0.5,correctedRadius,difference);
occlusion+=(difference>=0.0 ? 1.0 : 0.0)*rangeCheck;
}
occlusion=occlusion*(1.0-smoothstep(maxZ*0.75,maxZ,depth));
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor=vec4(vec3(result),1.0);
}
#endif
#ifdef BILATERAL_BLUR
uniform sampler2D depthSampler;
uniform float outSize;
uniform float samplerOffsets[SAMPLES];
vec4 blur9(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.3846153846)*direction;
vec2 off2=vec2(3.2307692308)*direction;
color+=texture2D(image,uv)*0.2270270270;
color+=texture2D(image,uv+(off1/resolution))*0.3162162162;
color+=texture2D(image,uv-(off1/resolution))*0.3162162162;
color+=texture2D(image,uv+(off2/resolution))*0.0702702703;
color+=texture2D(image,uv-(off2/resolution))*0.0702702703;
return color;
}
vec4 blur13(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
color+=texture2D(image,uv)*0.1964825501511404;
color+=texture2D(image,uv+(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv-(off1/resolution))*0.2969069646728344;
color+=texture2D(image,uv+(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv-(off2/resolution))*0.09447039785044732;
color+=texture2D(image,uv+(off3/resolution))*0.010381362401148057;
color+=texture2D(image,uv-(off3/resolution))*0.010381362401148057;
return color;
}
vec4 blur13Bilateral(sampler2D image,vec2 uv,float resolution,vec2 direction) {
vec4 color=vec4(0.0);
vec2 off1=vec2(1.411764705882353)*direction;
vec2 off2=vec2(3.2941176470588234)*direction;
vec2 off3=vec2(5.176470588235294)*direction;
float compareDepth=abs(texture2D(depthSampler,uv).r);
float sampleDepth;
float weight;
float weightSum=30.0;
color+=texture2D(image,uv)*30.0;
sampleDepth=abs(texture2D(depthSampler,uv+(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+= weight;
color+=texture2D(image,uv+(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off1/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+= weight;
color+=texture2D(image,uv-(off1/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off2/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off2/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv+(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv+(off3/resolution))*weight;
sampleDepth=abs(texture2D(depthSampler,uv-(off3/resolution)).r);
weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30.0);
weightSum+=weight;
color+=texture2D(image,uv-(off3/resolution))*weight;
return color/weightSum;
}
void main()
{
#if EXPENSIVE
float compareDepth=abs(texture2D(depthSampler,vUV).r);
float texelsize=1.0/outSize;
float result=0.0;
float weightSum=0.0;
for (int i=0; i<SAMPLES; ++i)
{
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
vec2 sampleOffset=vec2(texelsize*samplerOffsets[i],0.0);
#else
vec2 direction=vec2(0.0,1.0);
vec2 sampleOffset=vec2(0.0,texelsize*samplerOffsets[i]);
#endif
vec2 samplePos=vUV+sampleOffset;
float sampleDepth=abs(texture2D(depthSampler,samplePos).r);
float weight=clamp(1.0/( 0.003+abs(compareDepth-sampleDepth)),0.0,30000.0);
result+=texture2D(textureSampler,samplePos).r*weight;
weightSum+=weight;
}
result/=weightSum;
gl_FragColor.rgb=vec3(result);
gl_FragColor.a=1.0;
#else
vec4 color;
#ifdef BILATERAL_BLUR_H
vec2 direction=vec2(1.0,0.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#else
vec2 direction=vec2(0.0,1.0);
color=blur13Bilateral(textureSampler,vUV,outSize,direction);
#endif
gl_FragColor.rgb=vec3(color.r);
gl_FragColor.a=1.0;
#endif
}
#endif
`;Y.ShadersStore[c2]=u2;const d2="ssaoCombinePixelShader",f2=`uniform sampler2D textureSampler;
uniform sampler2D originalColor;
uniform vec4 viewport;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 ssaoColor=texture2D(textureSampler,viewport.xy+vUV*viewport.zw);
vec4 sceneColor=texture2D(originalColor,vUV);
gl_FragColor=sceneColor*ssaoColor;
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Y.ShadersStore[d2]=f2;class Ss extends ih{constructor(e,t,i,s,r=!1,n=0){if(super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.maxZ=100,this.minZAspect=.2,this._samples=8,this._textureSamples=1,this._forceGeometryBuffer=!1,this._expensiveBlur=!0,this.radius=2,this.base=0,this._bits=new Uint32Array(1),this._scene=t,this._ratio=i,this._forceGeometryBuffer=r,!this.isSupported){B.Error("The current engine does not support SSAO 2.");return}const o=this._ratio.ssaoRatio||i,l=this._ratio.blurRatio||i;this._forceGeometryBuffer?t.enableGeometryBufferRenderer():t.enablePrePassRenderer(),this._createRandomTexture(),this._originalColorPostProcess=new Sn("SSAOOriginalSceneColor",1,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),void 0,n),this._originalColorPostProcess.samples=this.textureSamples,this._createSSAOPostProcess(1,n),this._createBlurPostProcess(o,l,n),this._createSSAOCombinePostProcess(l,n),this.addEffect(new bt(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}set samples(e){this._samples=e,this._ssaoPostProcess.updateEffect(this._getDefinesForSSAO()),this._sampleSphere=this._generateHemisphere()}get samples(){return this._samples}set textureSamples(e){this._textureSamples=e,this._prePassRenderer?this._prePassRenderer.samples=e:this._originalColorPostProcess.samples=e}get textureSamples(){return this._textureSamples}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}set expensiveBlur(e){this._blurHPostProcess.updateEffect(`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(e?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._blurVPostProcess.updateEffect(`#define BILATERAL_BLUR
#define SAMPLES 16
#define EXPENSIVE `+(e?"1":"0")+`
`,null,["textureSampler","depthSampler"]),this._expensiveBlur=e}get expensiveBlur(){return this._expensiveBlur}static get IsSupported(){const e=ye.LastCreatedEngine;return e?e._features.supportSSAO2:!1}get scene(){return this._scene}getClassName(){return"SSAO2RenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableGeometryBufferRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e,t,i){this._samplerOffsets=[];const s=this.expensiveBlur;for(let r=-8;r<8;r++)this._samplerOffsets.push(r*2+.5);this._blurHPostProcess=new Fe("BlurH","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],e,null,H.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_H
#define SAMPLES 16
#define EXPENSIVE `+(s?"1":"0")+`
`,i),this._blurHPostProcess.onApply=r=>{!this._scene.activeCamera||(r.setFloat("outSize",this._ssaoCombinePostProcess.width>0?this._ssaoCombinePostProcess.width:this._originalColorPostProcess.width),r.setFloat("near",this._scene.activeCamera.minZ),r.setFloat("far",this._scene.activeCamera.maxZ),r.setFloat("radius",this.radius),this._geometryBufferRenderer?r.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&r.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),r.setArray("samplerOffsets",this._samplerOffsets))},this._blurVPostProcess=new Fe("BlurV","ssao2",["outSize","samplerOffsets","near","far","radius"],["depthSampler"],t,null,H.TRILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,`#define BILATERAL_BLUR
#define BILATERAL_BLUR_V
#define SAMPLES 16
#define EXPENSIVE `+(s?"1":"0")+`
`,i),this._blurVPostProcess.onApply=r=>{!this._scene.activeCamera||(r.setFloat("outSize",this._ssaoCombinePostProcess.height>0?this._ssaoCombinePostProcess.height:this._originalColorPostProcess.height),r.setFloat("near",this._scene.activeCamera.minZ),r.setFloat("far",this._scene.activeCamera.maxZ),r.setFloat("radius",this.radius),this._geometryBufferRenderer?r.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]):this._prePassRenderer&&r.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),r.setArray("samplerOffsets",this._samplerOffsets))},this._blurHPostProcess.samples=this.textureSamples,this._blurVPostProcess.samples=this.textureSamples}_rebuild(){super._rebuild()}_radicalInverse_VdC(e){return this._bits[0]=e,this._bits[0]=(this._bits[0]<<16|this._bits[0]>>16)>>>0,this._bits[0]=(this._bits[0]&1431655765)<<1|(this._bits[0]&2863311530)>>>1>>>0,this._bits[0]=(this._bits[0]&858993459)<<2|(this._bits[0]&3435973836)>>>2>>>0,this._bits[0]=(this._bits[0]&252645135)<<4|(this._bits[0]&4042322160)>>>4>>>0,this._bits[0]=(this._bits[0]&16711935)<<8|(this._bits[0]&4278255360)>>>8>>>0,this._bits[0]*23283064365386963e-26}_hammersley(e,t){return[e/t,this._radicalInverse_VdC(e)]}_hemisphereSample_uniform(e,t){const i=t*2*Math.PI,s=1-e*.85,r=Math.sqrt(1-s*s);return new g(Math.cos(i)*r,Math.sin(i)*r,s)}_generateHemisphere(){const e=this.samples,t=[];let i,s=0;for(;s<e;){if(e<16)i=this._hemisphereSample_uniform(Math.random(),Math.random());else{const r=this._hammersley(s,e);i=this._hemisphereSample_uniform(r[0],r[1])}t.push(i.x,i.y,i.z),s++}return t}_getDefinesForSSAO(){return"#define SAMPLES "+this.samples+`
#define SSAO`}_createSSAOPostProcess(e,t){this._sampleSphere=this._generateHemisphere();const i=this._getDefinesForSSAO(),s=["randomSampler","depthSampler","normalSampler"];this._ssaoPostProcess=new Fe("ssao2","ssao2",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","base","range","projection","near","far","texelSize","xViewport","yViewport","maxZ","minZAspect","depthProjection"],s,e,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,i,t),this._ssaoPostProcess.onApply=r=>{var n,o,l,h;if(!!this._scene.activeCamera){if(r.setArray3("sampleSphere",this._sampleSphere),r.setFloat("randTextureTiles",32),r.setFloat("samplesFactor",1/this.samples),r.setFloat("totalStrength",this.totalStrength),r.setFloat2("texelSize",1/this._ssaoPostProcess.width,1/this._ssaoPostProcess.height),r.setFloat("radius",this.radius),r.setFloat("maxZ",this.maxZ),r.setFloat("minZAspect",this.minZAspect),r.setFloat("base",this.base),r.setFloat("near",this._scene.activeCamera.minZ),r.setFloat("far",this._scene.activeCamera.maxZ),this._scene.activeCamera.mode===be.PERSPECTIVE_CAMERA)r.setMatrix3x3("depthProjection",Ss.PERSPECTIVE_DEPTH_PROJECTION),r.setFloat("xViewport",Math.tan(this._scene.activeCamera.fov/2)*this._scene.getEngine().getAspectRatio(this._scene.activeCamera,!0)),r.setFloat("yViewport",Math.tan(this._scene.activeCamera.fov/2));else{const c=this._scene.getEngine().getRenderWidth()/2,u=this._scene.getEngine().getRenderHeight()/2,d=(n=this._scene.activeCamera.orthoLeft)!==null&&n!==void 0?n:-c,f=(o=this._scene.activeCamera.orthoRight)!==null&&o!==void 0?o:c,p=(l=this._scene.activeCamera.orthoBottom)!==null&&l!==void 0?l:-u,_=(h=this._scene.activeCamera.orthoTop)!==null&&h!==void 0?h:u;r.setMatrix3x3("depthProjection",Ss.ORTHO_DEPTH_PROJECTION),r.setFloat("xViewport",(f-d)*.5),r.setFloat("yViewport",(_-p)*.5)}r.setMatrix("projection",this._scene.getProjectionMatrix()),this._geometryBufferRenderer?(r.setTexture("depthSampler",this._geometryBufferRenderer.getGBuffer().textures[0]),r.setTexture("normalSampler",this._geometryBufferRenderer.getGBuffer().textures[1])):this._prePassRenderer&&(r.setTexture("depthSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(5)]),r.setTexture("normalSampler",this._prePassRenderer.getRenderTarget().textures[this._prePassRenderer.getIndex(6)])),r.setTexture("randomSampler",this._randomTexture)}},this._ssaoPostProcess.samples=this.textureSamples,this._forceGeometryBuffer||(this._ssaoPostProcess._prePassEffectConfiguration=new h2)}_createSSAOCombinePostProcess(e,t){this._ssaoCombinePostProcess=new Fe("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,void 0,t),this._ssaoCombinePostProcess.onApply=i=>{const s=this._scene.activeCamera.viewport;i.setVector4("viewport",G.Vector4[0].copyFromFloats(s.x,s.y,s.width,s.height)),i.setTextureFromPostProcessOutput("originalColor",this._originalColorPostProcess)},this._ssaoCombinePostProcess.samples=this.textureSamples}_createRandomTexture(){this._randomTexture=new ta("SSAORandomTexture",128,this._scene,!1,H.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=H.WRAP_ADDRESSMODE,this._randomTexture.wrapV=H.WRAP_ADDRESSMODE;const t=this._randomTexture.getContext(),i=(r,n)=>Math.random()*(n-r)+r,s=g.Zero();for(let r=0;r<128;r++)for(let n=0;n<128;n++)s.x=i(0,1),s.y=i(0,1),s.z=0,s.normalize(),s.scaleInPlace(255),s.x=Math.floor(s.x),s.y=Math.floor(s.y),t.fillStyle="rgb("+s.x+", "+s.y+", "+s.z+")",t.fillRect(r,n,1,1);this._randomTexture.update(!1)}serialize(){const e=xe.Serialize(this);return e.customType="SSAO2RenderingPipeline",e}static Parse(e,t,i){return xe.Parse(()=>new Ss(e._name,t,e._ratio),e,t,i)}}Ss.ORTHO_DEPTH_PROJECTION=[1,0,0,0,1,0,0,0,1];Ss.PERSPECTIVE_DEPTH_PROJECTION=[0,0,0,0,0,0,1,1,1];T([R()],Ss.prototype,"totalStrength",void 0);T([R()],Ss.prototype,"maxZ",void 0);T([R()],Ss.prototype,"minZAspect",void 0);T([R("samples")],Ss.prototype,"_samples",void 0);T([R("textureSamples")],Ss.prototype,"_textureSamples",void 0);T([R()],Ss.prototype,"_ratio",void 0);T([R("expensiveBlur")],Ss.prototype,"_expensiveBlur",void 0);T([R()],Ss.prototype,"radius",void 0);T([R()],Ss.prototype,"base",void 0);he("BABYLON.SSAO2RenderingPipeline",Ss);const p2="ssaoPixelShader",_2=`uniform sampler2D textureSampler;
varying vec2 vUV;
#ifdef SSAO
uniform sampler2D randomSampler;
uniform float randTextureTiles;
uniform float samplesFactor;
uniform vec3 sampleSphere[SAMPLES];
uniform float totalStrength;
uniform float radius;
uniform float area;
uniform float fallOff;
uniform float base;
vec3 normalFromDepth(float depth,vec2 coords)
{
vec2 offset1=vec2(0.0,radius);
vec2 offset2=vec2(radius,0.0);
float depth1=texture2D(textureSampler,coords+offset1).r;
float depth2=texture2D(textureSampler,coords+offset2).r;
vec3 p1=vec3(offset1,depth1-depth);
vec3 p2=vec3(offset2,depth2-depth);
vec3 normal=cross(p1,p2);
normal.z=-normal.z;
return normalize(normal);
}
void main()
{
vec3 random=normalize(texture2D(randomSampler,vUV*randTextureTiles).rgb);
float depth=texture2D(textureSampler,vUV).r;
vec3 position=vec3(vUV,depth);
vec3 normal=normalFromDepth(depth,vUV);
float radiusDepth=radius/depth;
float occlusion=0.0;
vec3 ray;
vec3 hemiRay;
float occlusionDepth;
float difference;
for (int i=0; i<SAMPLES; i++)
{
ray=radiusDepth*reflect(sampleSphere[i],random);
hemiRay=position+sign(dot(ray,normal))*ray;
occlusionDepth=texture2D(textureSampler,clamp(hemiRay.xy,vec2(0.001,0.001),vec2(0.999,0.999))).r;
difference=depth-occlusionDepth;
occlusion+=step(fallOff,difference)*(1.0-smoothstep(fallOff,area,difference));
}
float ao=1.0-totalStrength*occlusion*samplesFactor;
float result=clamp(ao+base,0.0,1.0);
gl_FragColor.r=result;
gl_FragColor.g=result;
gl_FragColor.b=result;
gl_FragColor.a=1.0;
}
#endif
`;Y.ShadersStore[p2]=_2;class sh extends ih{constructor(e,t,i,s){super(t.getEngine(),e),this.SSAOOriginalSceneColorEffect="SSAOOriginalSceneColorEffect",this.SSAORenderEffect="SSAORenderEffect",this.SSAOBlurHRenderEffect="SSAOBlurHRenderEffect",this.SSAOBlurVRenderEffect="SSAOBlurVRenderEffect",this.SSAOCombineRenderEffect="SSAOCombineRenderEffect",this.totalStrength=1,this.radius=1e-4,this.area=.0075,this.fallOff=1e-6,this.base=.5,this._firstUpdate=!0,this._scene=t,this._createRandomTexture();const r=i.ssaoRatio||i,n=i.combineRatio||i;this._originalColorPostProcess=new Sn("SSAOOriginalSceneColor",n,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1),this._createSSAOPostProcess(r),this._createBlurPostProcess(r),this._createSSAOCombinePostProcess(n),this.addEffect(new bt(t.getEngine(),this.SSAOOriginalSceneColorEffect,()=>this._originalColorPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAORenderEffect,()=>this._ssaoPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAOBlurHRenderEffect,()=>this._blurHPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAOBlurVRenderEffect,()=>this._blurVPostProcess,!0)),this.addEffect(new bt(t.getEngine(),this.SSAOCombineRenderEffect,()=>this._ssaoCombinePostProcess,!0)),t.postProcessRenderPipelineManager.addPipeline(this),s&&t.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(e,s)}get scene(){return this._scene}_attachCameras(e,t){super._attachCameras(e,t);for(const i of this._cameras)this._scene.enableDepthRenderer(i).getDepthMap()}getClassName(){return"SSAORenderingPipeline"}dispose(e=!1){for(let t=0;t<this._scene.cameras.length;t++){const i=this._scene.cameras[t];this._originalColorPostProcess.dispose(i),this._ssaoPostProcess.dispose(i),this._blurHPostProcess.dispose(i),this._blurVPostProcess.dispose(i),this._ssaoCombinePostProcess.dispose(i)}this._randomTexture.dispose(),e&&this._scene.disableDepthRenderer(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._scene.cameras),super.dispose()}_createBlurPostProcess(e){this._blurHPostProcess=new Ei("BlurH",new le(1,0),16,e,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurVPostProcess=new Ei("BlurV",new le(0,1),16,e,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,0),this._blurHPostProcess.onActivateObservable.add(()=>{const i=this._blurHPostProcess.width/this._scene.getEngine().getRenderWidth();this._blurHPostProcess.kernel=16*i}),this._blurVPostProcess.onActivateObservable.add(()=>{const i=this._blurVPostProcess.height/this._scene.getEngine().getRenderHeight();this._blurVPostProcess.kernel=16*i})}_rebuild(){this._firstUpdate=!0,super._rebuild()}_createSSAOPostProcess(e){const i=[.5381,.1856,-.4319,.1379,.2486,.443,.3371,.5679,-.0057,-.6999,-.0451,-.0019,.0689,-.1598,-.8547,.056,.0069,-.1843,-.0146,.1402,.0762,.01,-.1924,-.0344,-.3577,-.5301,-.4358,-.3169,.1063,.0158,.0103,-.5869,.0046,-.0897,-.494,.3287,.7119,-.0154,-.0918,-.0533,.0596,-.5411,.0352,-.0631,.546,-.4776,.2847,-.0271],s=1/16;this._ssaoPostProcess=new Fe("ssao","ssao",["sampleSphere","samplesFactor","randTextureTiles","totalStrength","radius","area","fallOff","base","range","viewport"],["randomSampler"],e,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1,"#define SAMPLES "+16+`
#define SSAO`),this._ssaoPostProcess.externalTextureSamplerBinding=!0,this._ssaoPostProcess.onApply=r=>{this._firstUpdate&&(r.setArray3("sampleSphere",i),r.setFloat("samplesFactor",s),r.setFloat("randTextureTiles",4)),r.setFloat("totalStrength",this.totalStrength),r.setFloat("radius",this.radius),r.setFloat("area",this.area),r.setFloat("fallOff",this.fallOff),r.setFloat("base",this.base),r.setTexture("textureSampler",this._scene.enableDepthRenderer(this._scene.activeCamera).getDepthMap()),r.setTexture("randomSampler",this._randomTexture)}}_createSSAOCombinePostProcess(e){this._ssaoCombinePostProcess=new Fe("ssaoCombine","ssaoCombine",[],["originalColor","viewport"],e,null,H.BILINEAR_SAMPLINGMODE,this._scene.getEngine(),!1),this._ssaoCombinePostProcess.onApply=t=>{t.setVector4("viewport",G.Vector4[0].copyFromFloats(0,0,1,1)),t.setTextureFromPostProcess("originalColor",this._originalColorPostProcess)}}_createRandomTexture(){this._randomTexture=new ta("SSAORandomTexture",512,this._scene,!1,H.TRILINEAR_SAMPLINGMODE),this._randomTexture.wrapU=H.WRAP_ADDRESSMODE,this._randomTexture.wrapV=H.WRAP_ADDRESSMODE;const t=this._randomTexture.getContext(),i=(r,n)=>Math.random()*(n-r)+r,s=g.Zero();for(let r=0;r<512;r++)for(let n=0;n<512;n++)s.x=Math.floor(Math.max(0,i(-1,1))*255),s.y=Math.floor(Math.max(0,i(-1,1))*255),s.z=Math.floor(Math.max(0,i(-1,1))*255),t.fillStyle="rgb("+s.x+", "+s.y+", "+s.z+")",t.fillRect(r,n,1,1);this._randomTexture.update(!1)}}T([R()],sh.prototype,"totalStrength",void 0);T([R()],sh.prototype,"radius",void 0);T([R()],sh.prototype,"area",void 0);T([R()],sh.prototype,"fallOff",void 0);T([R()],sh.prototype,"base",void 0);class m2{constructor(){this.enabled=!1,this.name="screenSpaceReflections",this.texturesRequired=[6,3,1]}}const g2="screenSpaceReflectionPixelShader",v2=`uniform sampler2D textureSampler;
#ifdef SSR_SUPPORTED
uniform sampler2D reflectivitySampler;
uniform sampler2D normalSampler;
uniform sampler2D positionSampler;
#endif
uniform mat4 view;
uniform mat4 projection;
uniform float stepSize;
uniform float strength;
uniform float threshold;
uniform float roughnessFactor;
uniform float reflectionSpecularFalloffExponent;
varying vec2 vUV;
#ifdef SSR_SUPPORTED
struct ReflectionInfo {
vec3 color;
vec4 coords;
};
/**
* According to specular,see https:
*/
vec3 fresnelSchlick(float cosTheta,vec3 F0)
{
return F0+(1.0-F0)*pow(1.0-cosTheta,5.0);
}
/**
* Once the pixel's coordinates has been found,let's adjust (smooth) a little bit
* by sampling multiple reflection pixels.
*/
ReflectionInfo smoothReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
info.color=vec3(0.0);
vec4 projectedCoord;
float sampledDepth;
for(int i=0; i<SMOOTH_STEPS; i++)
{
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
dir*=0.5;
if(depth>0.0)
hitCoord-=dir;
else
hitCoord+=dir;
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
}
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
info.coords=vec4(projectedCoord.xy,sampledDepth,1.0);
info.color+=texture2D(textureSampler,projectedCoord.xy).rgb;
info.color/=float(SMOOTH_STEPS+1);
return info;
}
/**
* Tests the given world position (hitCoord) according to the given reflection vector (dir)
* until it finds a collision (means that depth is enough close to say "it's the pixel to sample!").
*/
ReflectionInfo getReflectionInfo(vec3 dir,vec3 hitCoord)
{
ReflectionInfo info;
vec4 projectedCoord;
float sampledDepth;
dir*=stepSize;
for(int i=0; i<REFLECTION_SAMPLES; i++)
{
hitCoord+=dir;
projectedCoord=projection*vec4(hitCoord,1.0);
projectedCoord.xy/=projectedCoord.w;
projectedCoord.xy=0.5*projectedCoord.xy+vec2(0.5);
sampledDepth=(view*texture2D(positionSampler,projectedCoord.xy)).z;
float depth=sampledDepth-hitCoord.z;
#ifdef RIGHT_HANDED_SCENE
depth*=-1.0;
#endif
if(((depth-dir.z)<threshold) && depth<=0.0)
{
#ifdef ENABLE_SMOOTH_REFLECTIONS
return smoothReflectionInfo(dir,hitCoord);
#else
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
#endif
}
}
info.color=texture2D(textureSampler,projectedCoord.xy).rgb;
info.coords=vec4(projectedCoord.xy,sampledDepth,0.0);
return info;
}
vec3 hash(vec3 a)
{
a=fract(a*0.8);
a+=dot(a,a.yxz+19.19);
return fract((a.xxy+a.yxx)*a.zyx);
}
#endif
void main()
{
#ifdef SSR_SUPPORTED
vec4 albedoFull=texture2D(textureSampler,vUV);
vec3 albedo=albedoFull.rgb;
float spec=texture2D(reflectivitySampler,vUV).r;
if (spec==0.0) {
gl_FragColor=albedoFull;
return;
}
vec3 normal=(texture2D(normalSampler,vUV)).xyz;
vec3 position=(view*texture2D(positionSampler,vUV)).xyz;
vec3 reflected=normalize(reflect(normalize(position),normalize(normal)));
float roughness=1.0-texture2D(reflectivitySampler,vUV).a;
vec3 jitt=mix(vec3(0.0),hash(position),roughness)*roughnessFactor;
ReflectionInfo info=getReflectionInfo(jitt+reflected,position);
vec2 dCoords=smoothstep(0.2,0.6,abs(vec2(0.5,0.5)-info.coords.xy));
float screenEdgefactor=clamp(1.0-(dCoords.x+dCoords.y),0.0,1.0);
vec3 F0=vec3(0.04);
F0 =mix(F0,albedo,spec);
vec3 fresnel=fresnelSchlick(max(dot(normalize(normal),normalize(position)),0.0),F0);
#ifdef RIGHT_HANDED_SCENE
reflected.z*=-1.0;
#endif
float reflectionMultiplier=clamp(pow(spec*strength,reflectionSpecularFalloffExponent)*screenEdgefactor*reflected.z,0.0,0.9);
float albedoMultiplier=1.0-reflectionMultiplier;
vec3 SSR=info.color*fresnel;
gl_FragColor=vec4((albedo*albedoMultiplier)+(SSR*reflectionMultiplier),albedoFull.a);
#else
gl_FragColor=texture2D(textureSampler,vUV);
#endif
}
`;Y.ShadersStore[g2]=v2;class vr extends Fe{constructor(e,t,i,s,r,n,o,l=0,h=!1,c=!1){if(super(e,"screenSpaceReflection",["projection","view","threshold","reflectionSpecularFalloffExponent","strength","stepSize","roughnessFactor"],["textureSampler","normalSampler","positionSampler","reflectivitySampler"],i,s,r,n,o,`#define SSR_SUPPORTED
#define REFLECTION_SAMPLES 64
#define SMOOTH_STEPS 5
`,l,void 0,null,h),this.threshold=1.2,this.strength=1,this.reflectionSpecularFalloffExponent=3,this.step=1,this.roughnessFactor=.2,this._forceGeometryBuffer=!1,this._enableSmoothReflections=!1,this._reflectionSamples=64,this._smoothSteps=5,this._forceGeometryBuffer=c,this._forceGeometryBuffer){const u=t.enableGeometryBufferRenderer();u&&u.isSupported&&(u.enablePosition=!0,u.enableReflectivity=!0)}else{const u=t.enablePrePassRenderer();u==null||u.markAsDirty(),this._prePassEffectConfiguration=new m2}this._updateEffectDefines(),this.onApply=u=>{const d=this._geometryBufferRenderer,f=this._prePassRenderer;if(!f&&!d)return;if(d){const v=d.getTextureIndex(ei.POSITION_TEXTURE_TYPE),x=d.getTextureIndex(ei.REFLECTIVITY_TEXTURE_TYPE);u.setTexture("normalSampler",d.getGBuffer().textures[1]),u.setTexture("positionSampler",d.getGBuffer().textures[v]),u.setTexture("reflectivitySampler",d.getGBuffer().textures[x])}else if(f){const v=f.getIndex(1),x=f.getIndex(3),b=f.getIndex(6);u.setTexture("normalSampler",f.getRenderTarget().textures[b]),u.setTexture("positionSampler",f.getRenderTarget().textures[v]),u.setTexture("reflectivitySampler",f.getRenderTarget().textures[x])}const p=t.activeCamera;if(!p)return;const _=p.getViewMatrix(!0),m=p.getProjectionMatrix(!0);u.setMatrix("projection",m),u.setMatrix("view",_),u.setFloat("threshold",this.threshold),u.setFloat("reflectionSpecularFalloffExponent",this.reflectionSpecularFalloffExponent),u.setFloat("strength",this.strength),u.setFloat("stepSize",this.step),u.setFloat("roughnessFactor",this.roughnessFactor)},this._isSceneRightHanded=t.useRightHandedSystem}get _geometryBufferRenderer(){return this._forceGeometryBuffer?this._scene.geometryBufferRenderer:null}get _prePassRenderer(){return this._forceGeometryBuffer?null:this._scene.prePassRenderer}getClassName(){return"ScreenSpaceReflectionPostProcess"}get enableSmoothReflections(){return this._enableSmoothReflections}set enableSmoothReflections(e){e!==this._enableSmoothReflections&&(this._enableSmoothReflections=e,this._updateEffectDefines())}get reflectionSamples(){return this._reflectionSamples}set reflectionSamples(e){e!==this._reflectionSamples&&(this._reflectionSamples=e,this._updateEffectDefines())}get smoothSteps(){return this._smoothSteps}set smoothSteps(e){e!==this._smoothSteps&&(this._smoothSteps=e,this._updateEffectDefines())}_updateEffectDefines(){const e=[];(this._geometryBufferRenderer||this._prePassRenderer)&&e.push("#define SSR_SUPPORTED"),this._enableSmoothReflections&&e.push("#define ENABLE_SMOOTH_REFLECTIONS"),this._isSceneRightHanded&&e.push("#define RIGHT_HANDED_SCENE"),e.push("#define REFLECTION_SAMPLES "+(this._reflectionSamples>>0)),e.push("#define SMOOTH_STEPS "+(this._smoothSteps>>0)),this.updateEffect(e.join(`
`))}static _Parse(e,t,i,s){return xe.Parse(()=>new vr(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,s)}}T([R()],vr.prototype,"threshold",void 0);T([R()],vr.prototype,"strength",void 0);T([R()],vr.prototype,"reflectionSpecularFalloffExponent",void 0);T([R()],vr.prototype,"step",void 0);T([R()],vr.prototype,"roughnessFactor",void 0);T([R()],vr.prototype,"enableSmoothReflections",null);T([R()],vr.prototype,"reflectionSamples",null);T([R()],vr.prototype,"smoothSteps",null);he("BABYLON.ScreenSpaceReflectionPostProcess",vr);const x2="standardPixelShader",T2=`uniform sampler2D textureSampler;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
#if defined(PASS_POST_PROCESS)
void main(void)
{
vec4 color=texture2D(textureSampler,vUV);
gl_FragColor=color;
}
#endif
#if defined(DOWN_SAMPLE_X4)
uniform vec2 dsOffsets[16];
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+dsOffsets[0]);
average+=texture2D(textureSampler,vUV+dsOffsets[1]);
average+=texture2D(textureSampler,vUV+dsOffsets[2]);
average+=texture2D(textureSampler,vUV+dsOffsets[3]);
average+=texture2D(textureSampler,vUV+dsOffsets[4]);
average+=texture2D(textureSampler,vUV+dsOffsets[5]);
average+=texture2D(textureSampler,vUV+dsOffsets[6]);
average+=texture2D(textureSampler,vUV+dsOffsets[7]);
average+=texture2D(textureSampler,vUV+dsOffsets[8]);
average+=texture2D(textureSampler,vUV+dsOffsets[9]);
average+=texture2D(textureSampler,vUV+dsOffsets[10]);
average+=texture2D(textureSampler,vUV+dsOffsets[11]);
average+=texture2D(textureSampler,vUV+dsOffsets[12]);
average+=texture2D(textureSampler,vUV+dsOffsets[13]);
average+=texture2D(textureSampler,vUV+dsOffsets[14]);
average+=texture2D(textureSampler,vUV+dsOffsets[15]);
average/=16.0;
gl_FragColor=average;
}
#endif
#if defined(BRIGHT_PASS)
uniform vec2 dsOffsets[4];
uniform float brightThreshold;
void main(void)
{
vec4 average=vec4(0.0,0.0,0.0,0.0);
average=texture2D(textureSampler,vUV+vec2(dsOffsets[0].x,dsOffsets[0].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[1].x,dsOffsets[1].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[2].x,dsOffsets[2].y));
average+=texture2D(textureSampler,vUV+vec2(dsOffsets[3].x,dsOffsets[3].y));
average*=0.25;
float luminance=length(average.rgb);
if (luminance<brightThreshold) {
average=vec4(0.0,0.0,0.0,1.0);
}
gl_FragColor=average;
}
#endif
#if defined(TEXTURE_ADDER)
uniform sampler2D otherSampler;
uniform sampler2D lensSampler;
uniform float exposure;
void main(void)
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
colour*=exposure;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
colour+=colour*texture2D(lensSampler,vUV).rgb;
vec4 finalColor=vec4(colour.rgb,1.0)+texture2D(otherSampler,vUV);
gl_FragColor=finalColor;
}
#endif
#if defined(VLS)
#define PI 3.1415926535897932384626433832795
uniform mat4 shadowViewProjection;
uniform mat4 lightWorld;
uniform vec3 cameraPosition;
uniform vec3 sunDirection;
uniform vec3 sunColor;
uniform vec2 depthValues;
uniform float scatteringCoefficient;
uniform float scatteringPower;
uniform sampler2D shadowMapSampler;
uniform sampler2D positionSampler;
float computeScattering(float lightDotView)
{
float result=1.0-scatteringCoefficient*scatteringCoefficient;
result/=(4.0*PI*pow(1.0+scatteringCoefficient*scatteringCoefficient-(2.0*scatteringCoefficient)*lightDotView,1.5));
return result;
}
void main(void)
{
vec3 worldPos=texture2D(positionSampler,vUV).rgb;
vec3 startPosition=cameraPosition;
vec3 rayVector=worldPos-startPosition;
float rayLength=length(rayVector);
vec3 rayDirection=rayVector/rayLength;
float stepLength=rayLength/NB_STEPS;
vec3 stepL=rayDirection*stepLength;
vec3 currentPosition=startPosition;
vec3 accumFog=vec3(0.0);
for (int i=0; i<int(NB_STEPS); i++)
{
vec4 worldInShadowCameraSpace=shadowViewProjection*vec4(currentPosition,1.0);
float depthMetric= (worldInShadowCameraSpace.z+depthValues.x)/(depthValues.y);
float shadowPixelDepth=clamp(depthMetric,0.0,1.0);
worldInShadowCameraSpace.xyz/=worldInShadowCameraSpace.w;
worldInShadowCameraSpace.xyz=0.5*worldInShadowCameraSpace.xyz+vec3(0.5);
float shadowMapValue=texture2D(shadowMapSampler,worldInShadowCameraSpace.xy).r;
if (shadowMapValue>shadowPixelDepth)
accumFog+=sunColor*computeScattering(dot(rayDirection,sunDirection));
currentPosition+=stepL;
}
accumFog/=NB_STEPS;
vec3 color=accumFog*scatteringPower;
gl_FragColor=vec4(color*exp(color) ,1.0);
}
#endif
#if defined(VLSMERGE)
uniform sampler2D originalSampler;
void main(void)
{
gl_FragColor=texture2D(originalSampler,vUV)+texture2D(textureSampler,vUV);
}
#endif
#if defined(LUMINANCE)
uniform vec2 lumOffsets[4];
void main()
{
float average=0.0;
vec4 color=vec4(0.0);
float maximum=-1e20;
vec3 weight=vec3(0.299,0.587,0.114);
for (int i=0; i<4; i++)
{
color=texture2D(textureSampler,vUV+ lumOffsets[i]);
float GreyValue=dot(color.rgb,vec3(0.33,0.33,0.33));
#ifdef WEIGHTED_AVERAGE
float GreyValue=dot(color.rgb,weight);
#endif
#ifdef BRIGHTNESS
float GreyValue=max(color.r,max(color.g,color.b));
#endif
#ifdef HSL_COMPONENT
float GreyValue=0.5*(max(color.r,max(color.g,color.b))+min(color.r,min(color.g,color.b)));
#endif
#ifdef MAGNITUDE
float GreyValue=length(color.rgb);
#endif
maximum=max(maximum,GreyValue);
average+=(0.25*log(1e-5+GreyValue));
}
average=exp(average);
gl_FragColor=vec4(average,maximum,0.0,1.0);
}
#endif
#if defined(LUMINANCE_DOWN_SAMPLE)
uniform vec2 dsOffsets[9];
uniform float halfDestPixelSize;
#ifdef FINAL_DOWN_SAMPLER
#include<packingFunctions>
#endif
void main()
{
vec4 color=vec4(0.0);
float average=0.0;
for (int i=0; i<9; i++)
{
color=texture2D(textureSampler,vUV+vec2(halfDestPixelSize,halfDestPixelSize)+dsOffsets[i]);
average+=color.r;
}
average/=9.0;
#ifdef FINAL_DOWN_SAMPLER
gl_FragColor=pack(average);
#else
gl_FragColor=vec4(average,average,0.0,1.0);
#endif
}
#endif
#if defined(HDR)
uniform sampler2D textureAdderSampler;
uniform float averageLuminance;
void main()
{
vec4 color=texture2D(textureAdderSampler,vUV);
#ifndef AUTO_EXPOSURE
vec4 adjustedColor=color/averageLuminance;
color=adjustedColor;
color.a=1.0;
#endif
gl_FragColor=color;
}
#endif
#if defined(LENS_FLARE)
#define GHOSTS 3
uniform sampler2D lensColorSampler;
uniform float strength;
uniform float ghostDispersal;
uniform float haloWidth;
uniform vec2 resolution;
uniform float distortionStrength;
float hash(vec2 p)
{
float h=dot(p,vec2(127.1,311.7));
return -1.0+2.0*fract(sin(h)*43758.5453123);
}
float noise(in vec2 p)
{
vec2 i=floor(p);
vec2 f=fract(p);
vec2 u=f*f*(3.0-2.0*f);
return mix(mix(hash(i+vec2(0.0,0.0)),
hash(i+vec2(1.0,0.0)),u.x),
mix(hash(i+vec2(0.0,1.0)),
hash(i+vec2(1.0,1.0)),u.x),u.y);
}
float fbm(vec2 p)
{
float f=0.0;
f+=0.5000*noise(p); p*=2.02;
f+=0.2500*noise(p); p*=2.03;
f+=0.1250*noise(p); p*=2.01;
f+=0.0625*noise(p); p*=2.04;
f/=0.9375;
return f;
}
vec3 pattern(vec2 uv)
{
vec2 p=-1.0+2.0*uv;
float p2=dot(p,p);
float f=fbm(vec2(15.0*p2))/2.0;
float r=0.2+0.6*sin(12.5*length(uv-vec2(0.5)));
float g=0.2+0.6*sin(20.5*length(uv-vec2(0.5)));
float b=0.2+0.6*sin(17.2*length(uv-vec2(0.5)));
return (1.0-f)*vec3(r,g,b);
}
float luminance(vec3 color)
{
return dot(color.rgb,vec3(0.2126,0.7152,0.0722));
}
vec4 textureDistorted(sampler2D tex,vec2 texcoord,vec2 direction,vec3 distortion)
{
return vec4(
texture2D(tex,texcoord+direction*distortion.r).r,
texture2D(tex,texcoord+direction*distortion.g).g,
texture2D(tex,texcoord+direction*distortion.b).b,
1.0
);
}
void main(void)
{
vec2 uv=-vUV+vec2(1.0);
vec2 ghostDir=(vec2(0.5)-uv)*ghostDispersal;
vec2 texelSize=1.0/resolution;
vec3 distortion=vec3(-texelSize.x*distortionStrength,0.0,texelSize.x*distortionStrength);
vec4 result=vec4(0.0);
float ghostIndice=1.0;
for (int i=0; i<GHOSTS; ++i)
{
vec2 offset=fract(uv+ghostDir*ghostIndice);
float weight=length(vec2(0.5)-offset)/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,offset,normalize(ghostDir),distortion)*weight*strength;
ghostIndice+=1.0;
}
vec2 haloVec=normalize(ghostDir)*haloWidth;
float weight=length(vec2(0.5)-fract(uv+haloVec))/length(vec2(0.5));
weight=pow(1.0-weight,10.0);
result+=textureDistorted(textureSampler,fract(uv+haloVec),normalize(ghostDir),distortion)*weight*strength;
result*=texture2D(lensColorSampler,vec2(length(vec2(0.5)-uv)/length(vec2(0.5))));
gl_FragColor=result;
}
#endif
#if defined(LENS_FLARE_COMPOSE)
uniform sampler2D otherSampler;
uniform sampler2D lensDirtSampler;
uniform sampler2D lensStarSampler;
uniform mat4 lensStarMatrix;
void main(void)
{
vec2 lensFlareCoords=(lensStarMatrix*vec4(vUV,1.0,1.0)).xy;
vec4 lensMod=texture2D(lensDirtSampler,vUV);
lensMod+=texture2D(lensStarSampler,vUV/*lensFlareCoords*/);
vec4 result=texture2D(textureSampler,vUV)*lensMod;
gl_FragColor=texture2D(otherSampler,vUV)+result;
}
#endif
#if defined(DEPTH_OF_FIELD)
uniform sampler2D otherSampler;
uniform sampler2D depthSampler;
uniform float distance;
void main(void)
{
vec4 sharp=texture2D(otherSampler,vUV);
vec4 blur=texture2D(textureSampler,vUV);
float dist=clamp(texture2D(depthSampler,vUV).r*distance,0.0,1.0);
float factor=0.0;
if (dist<0.05)
factor=1.0;
else if (dist<0.1)
factor=20.0*(0.1-dist);
else if (dist<0.5)
factor=0.0;
else
factor=2.0*(dist-0.5);
factor=clamp(factor,0.0,0.90);
gl_FragColor=mix(sharp,blur,factor);
}
#endif
#if defined(MOTION_BLUR)
uniform mat4 inverseViewProjection;
uniform mat4 prevViewProjection;
uniform vec2 screenSize;
uniform float motionScale;
uniform float motionStrength;
uniform sampler2D depthSampler;
void main(void)
{
vec2 texelSize=1.0/screenSize;
float depth=texture2D(depthSampler,vUV).r;
vec4 cpos=vec4(vUV*2.0-1.0,depth,1.0);
cpos=cpos*inverseViewProjection;
vec4 ppos=cpos*prevViewProjection;
ppos.xyz/=ppos.w;
ppos.xy=ppos.xy*0.5+0.5;
vec2 velocity=(ppos.xy-vUV)*motionScale*motionStrength;
float speed=length(velocity/texelSize);
int nSamples=int(clamp(speed,1.0,MAX_MOTION_SAMPLES));
vec4 result=texture2D(textureSampler,vUV);
for (int i=1; i<int(MAX_MOTION_SAMPLES); ++i) {
if (i>=nSamples)
break;
vec2 offset1=vUV+velocity*(float(i)/float(nSamples-1)-0.5);
result+=texture2D(textureSampler,offset1);
}
gl_FragColor=result/float(nSamples);
}
#endif
`;Y.ShadersStore[x2]=T2;class _t extends ih{constructor(e,t,i,s=null,r){super(t.getEngine(),e),this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.blurHPostProcesses=[],this.blurVPostProcesses=[],this.textureAdderPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.luminancePostProcess=null,this.luminanceDownSamplePostProcesses=[],this.hdrPostProcess=null,this.textureAdderFinalPostProcess=null,this.lensFlareFinalPostProcess=null,this.hdrFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.motionBlurPostProcess=null,this.depthOfFieldPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.brightThreshold=1,this.blurWidth=512,this.horizontalBlur=!1,this.lensTexture=null,this.volumetricLightCoefficient=.2,this.volumetricLightPower=4,this.volumetricLightBlurScale=64,this.sourceLight=null,this.hdrMinimumLuminance=1,this.hdrDecreaseRate=.5,this.hdrIncreaseRate=.5,this.lensColorTexture=null,this.lensFlareStrength=20,this.lensFlareGhostDispersal=1.4,this.lensFlareHaloWidth=.7,this.lensFlareDistortionStrength=16,this.lensFlareBlurWidth=512,this.lensStarTexture=null,this.lensFlareDirtTexture=null,this.depthOfFieldDistance=10,this.depthOfFieldBlurWidth=64,this.animations=[],this._currentDepthOfFieldSource=null,this._fixedExposure=1,this._currentExposure=1,this._hdrAutoExposure=!1,this._hdrCurrentLuminance=1,this._motionStrength=1,this._isObjectBasedMotionBlur=!1,this._camerasToBeAttached=[],this._bloomEnabled=!1,this._depthOfFieldEnabled=!1,this._vlsEnabled=!1,this._lensFlareEnabled=!1,this._hdrEnabled=!1,this._motionBlurEnabled=!1,this._fxaaEnabled=!1,this._screenSpaceReflectionsEnabled=!1,this._motionBlurSamples=64,this._volumetricLightStepsCount=50,this._samples=1,this._cameras=r||t.cameras,this._cameras=this._cameras.slice(),this._camerasToBeAttached=this._cameras.slice(),this._scene=t,this._basePostProcess=s,this._ratio=i,this._floatTextureType=t.getEngine().getCaps().textureFloatRender?1:2,t.postProcessRenderPipelineManager.addPipeline(this),this._buildPipeline()}get exposure(){return this._fixedExposure}set exposure(e){this._fixedExposure=e,this._currentExposure=e}get hdrAutoExposure(){return this._hdrAutoExposure}set hdrAutoExposure(e){if(this._hdrAutoExposure=e,this.hdrPostProcess){const t=["#define HDR"];e&&t.push("#define AUTO_EXPOSURE"),this.hdrPostProcess.updateEffect(t.join(`
`))}}get motionStrength(){return this._motionStrength}set motionStrength(e){this._motionStrength=e,this._isObjectBasedMotionBlur&&this.motionBlurPostProcess&&(this.motionBlurPostProcess.motionStrength=e)}get objectBasedMotionBlur(){return this._isObjectBasedMotionBlur}set objectBasedMotionBlur(e){const t=this._isObjectBasedMotionBlur!==e;this._isObjectBasedMotionBlur=e,t&&this._buildPipeline()}get BloomEnabled(){return this._bloomEnabled}set BloomEnabled(e){this._bloomEnabled!==e&&(this._bloomEnabled=e,this._buildPipeline())}get DepthOfFieldEnabled(){return this._depthOfFieldEnabled}set DepthOfFieldEnabled(e){this._depthOfFieldEnabled!==e&&(this._depthOfFieldEnabled=e,this._buildPipeline())}get LensFlareEnabled(){return this._lensFlareEnabled}set LensFlareEnabled(e){this._lensFlareEnabled!==e&&(this._lensFlareEnabled=e,this._buildPipeline())}get HDREnabled(){return this._hdrEnabled}set HDREnabled(e){this._hdrEnabled!==e&&(this._hdrEnabled=e,this._buildPipeline())}get VLSEnabled(){return this._vlsEnabled}set VLSEnabled(e){if(this._vlsEnabled!==e){if(e&&!this._scene.enableGeometryBufferRenderer()){B.Warn("Geometry renderer is not supported, cannot create volumetric lights in Standard Rendering Pipeline");return}this._vlsEnabled=e,this._buildPipeline()}}get MotionBlurEnabled(){return this._motionBlurEnabled}set MotionBlurEnabled(e){this._motionBlurEnabled!==e&&(this._motionBlurEnabled=e,this._buildPipeline())}get fxaaEnabled(){return this._fxaaEnabled}set fxaaEnabled(e){this._fxaaEnabled!==e&&(this._fxaaEnabled=e,this._buildPipeline())}get screenSpaceReflectionsEnabled(){return this._screenSpaceReflectionsEnabled}set screenSpaceReflectionsEnabled(e){this._screenSpaceReflectionsEnabled!==e&&(this._screenSpaceReflectionsEnabled=e,this._buildPipeline())}get volumetricLightStepsCount(){return this._volumetricLightStepsCount}set volumetricLightStepsCount(e){this.volumetricLightPostProcess&&this.volumetricLightPostProcess.updateEffect(`#define VLS
#define NB_STEPS `+e.toFixed(1)),this._volumetricLightStepsCount=e}get motionBlurSamples(){return this._motionBlurSamples}set motionBlurSamples(e){this.motionBlurPostProcess&&(this._isObjectBasedMotionBlur?this.motionBlurPostProcess.motionBlurSamples=e:this.motionBlurPostProcess.updateEffect(`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+e.toFixed(1))),this._motionBlurSamples=e}get samples(){return this._samples}set samples(e){this._samples!==e&&(this._samples=e,this._buildPipeline())}_buildPipeline(){const e=this._ratio,t=this._scene;this._disposePostProcesses(),this._cameras!==null&&(this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),this._cameras=this._camerasToBeAttached.slice()),this._reset(),this._screenSpaceReflectionsEnabled&&(this.screenSpaceReflectionPostProcess=new vr("HDRPass",t,e,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,this._floatTextureType),this.screenSpaceReflectionPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.screenSpaceReflectionPostProcess}),this.addEffect(new bt(t.getEngine(),"HDRScreenSpaceReflections",()=>this.screenSpaceReflectionPostProcess,!0))),this._basePostProcess?this.originalPostProcess=this._basePostProcess:this.originalPostProcess=new Fe("HDRPass","standard",[],[],e,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",this._floatTextureType),this.originalPostProcess.autoClear=!this.screenSpaceReflectionPostProcess,this.originalPostProcess.onApplyObservable.add(()=>{this._currentDepthOfFieldSource=this.originalPostProcess}),this.addEffect(new bt(t.getEngine(),"HDRPassPostProcess",()=>this.originalPostProcess,!0)),this._bloomEnabled&&(this._createDownSampleX4PostProcess(t,e/4),this._createBrightPassPostProcess(t,e/4),this._createBlurPostProcesses(t,e/4,1),this._createTextureAdderPostProcess(t,e),this.textureAdderFinalPostProcess=new Fe("HDRDepthOfFieldSource","standard",[],[],e,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new bt(t.getEngine(),"HDRBaseDepthOfFieldSource",()=>this.textureAdderFinalPostProcess,!0))),this._vlsEnabled&&(this._createVolumetricLightPostProcess(t,e),this.volumetricLightFinalPostProcess=new Fe("HDRVLSFinal","standard",[],[],e,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new bt(t.getEngine(),"HDRVLSFinal",()=>this.volumetricLightFinalPostProcess,!0))),this._lensFlareEnabled&&(this._createLensFlarePostProcess(t,e),this.lensFlareFinalPostProcess=new Fe("HDRPostLensFlareDepthOfFieldSource","standard",[],[],e,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new bt(t.getEngine(),"HDRPostLensFlareDepthOfFieldSource",()=>this.lensFlareFinalPostProcess,!0))),this._hdrEnabled&&(this._createLuminancePostProcesses(t,this._floatTextureType),this._createHdrPostProcess(t,e),this.hdrFinalPostProcess=new Fe("HDRPostHDReDepthOfFieldSource","standard",[],[],e,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,"#define PASS_POST_PROCESS",0),this.addEffect(new bt(t.getEngine(),"HDRPostHDReDepthOfFieldSource",()=>this.hdrFinalPostProcess,!0))),this._depthOfFieldEnabled&&(this._createBlurPostProcesses(t,e/2,3,"depthOfFieldBlurWidth"),this._createDepthOfFieldPostProcess(t,e)),this._motionBlurEnabled&&this._createMotionBlurPostProcess(t,e),this._fxaaEnabled&&(this.fxaaPostProcess=new qo("fxaa",1,null,H.BILINEAR_SAMPLINGMODE,t.getEngine(),!1,0),this.addEffect(new bt(t.getEngine(),"HDRFxaa",()=>this.fxaaPostProcess,!0))),this._cameras!==null&&this._scene.postProcessRenderPipelineManager.attachCamerasToRenderPipeline(this._name,this._cameras),!this._enableMSAAOnFirstPostProcess(this._samples)&&this._samples>1&&B.Warn("MSAA failed to enable, MSAA is only supported in browsers that support webGL >= 2.0")}_createDownSampleX4PostProcess(e,t){const i=new Array(32);this.downSampleX4PostProcess=new Fe("HDRDownSampleX4","standard",["dsOffsets"],[],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DOWN_SAMPLE_X4",this._floatTextureType),this.downSampleX4PostProcess.onApply=s=>{let r=0;const n=this.downSampleX4PostProcess.width,o=this.downSampleX4PostProcess.height;for(let l=-2;l<2;l++)for(let h=-2;h<2;h++)i[r]=(l+.5)*(1/n),i[r+1]=(h+.5)*(1/o),r+=2;s.setArray2("dsOffsets",i)},this.addEffect(new bt(e.getEngine(),"HDRDownSampleX4",()=>this.downSampleX4PostProcess,!0))}_createBrightPassPostProcess(e,t){const i=new Array(8);this.brightPassPostProcess=new Fe("HDRBrightPass","standard",["dsOffsets","brightThreshold"],[],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define BRIGHT_PASS",this._floatTextureType),this.brightPassPostProcess.onApply=s=>{const r=1/this.brightPassPostProcess.width,n=1/this.brightPassPostProcess.height;i[0]=-.5*r,i[1]=.5*n,i[2]=.5*r,i[3]=.5*n,i[4]=-.5*r,i[5]=-.5*n,i[6]=.5*r,i[7]=-.5*n,s.setArray2("dsOffsets",i),s.setFloat("brightThreshold",this.brightThreshold)},this.addEffect(new bt(e.getEngine(),"HDRBrightPass",()=>this.brightPassPostProcess,!0))}_createBlurPostProcesses(e,t,i,s="blurWidth"){const r=e.getEngine(),n=new Ei("HDRBlurH_"+i,new le(1,0),this[s],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType),o=new Ei("HDRBlurV_"+i,new le(0,1),this[s],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,this._floatTextureType);n.onActivateObservable.add(()=>{const l=n.width/r.getRenderWidth();n.kernel=this[s]*l}),o.onActivateObservable.add(()=>{const l=o.height/r.getRenderHeight();o.kernel=this.horizontalBlur?64*l:this[s]*l}),this.addEffect(new bt(e.getEngine(),"HDRBlurH"+i,()=>n,!0)),this.addEffect(new bt(e.getEngine(),"HDRBlurV"+i,()=>o,!0)),this.blurHPostProcesses.push(n),this.blurVPostProcesses.push(o)}_createTextureAdderPostProcess(e,t){this.textureAdderPostProcess=new Fe("HDRTextureAdder","standard",["exposure"],["otherSampler","lensSampler"],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define TEXTURE_ADDER",this._floatTextureType),this.textureAdderPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._vlsEnabled?this._currentDepthOfFieldSource:this.originalPostProcess),i.setTexture("lensSampler",this.lensTexture),i.setFloat("exposure",this._currentExposure),this._currentDepthOfFieldSource=this.textureAdderFinalPostProcess},this.addEffect(new bt(e.getEngine(),"HDRTextureAdder",()=>this.textureAdderPostProcess,!0))}_createVolumetricLightPostProcess(e,t){const i=e.enableGeometryBufferRenderer();i.enablePosition=!0;const s=i.getGBuffer();this.volumetricLightPostProcess=new Fe("HDRVLS","standard",["shadowViewProjection","cameraPosition","sunDirection","sunColor","scatteringCoefficient","scatteringPower","depthValues"],["shadowMapSampler","positionSampler"],t/8,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define VLS
#define NB_STEPS `+this._volumetricLightStepsCount.toFixed(1));const r=le.Zero();this.volumetricLightPostProcess.onApply=n=>{if(this.sourceLight&&this.sourceLight.getShadowGenerator()&&this._scene.activeCamera){const o=this.sourceLight.getShadowGenerator();n.setTexture("shadowMapSampler",o.getShadowMap()),n.setTexture("positionSampler",s.textures[2]),n.setColor3("sunColor",this.sourceLight.diffuse),n.setVector3("sunDirection",this.sourceLight.getShadowDirection()),n.setVector3("cameraPosition",this._scene.activeCamera.globalPosition),n.setMatrix("shadowViewProjection",o.getTransformMatrix()),n.setFloat("scatteringCoefficient",this.volumetricLightCoefficient),n.setFloat("scatteringPower",this.volumetricLightPower),r.x=this.sourceLight.getDepthMinZ(this._scene.activeCamera),r.y=this.sourceLight.getDepthMaxZ(this._scene.activeCamera),n.setVector2("depthValues",r)}},this.addEffect(new bt(e.getEngine(),"HDRVLS",()=>this.volumetricLightPostProcess,!0)),this._createBlurPostProcesses(e,t/4,0,"volumetricLightBlurScale"),this.volumetricLightMergePostProces=new Fe("HDRVLSMerge","standard",[],["originalSampler"],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define VLSMERGE"),this.volumetricLightMergePostProces.onApply=n=>{n.setTextureFromPostProcess("originalSampler",this._bloomEnabled?this.textureAdderFinalPostProcess:this.originalPostProcess),this._currentDepthOfFieldSource=this.volumetricLightFinalPostProcess},this.addEffect(new bt(e.getEngine(),"HDRVLSMerge",()=>this.volumetricLightMergePostProces,!0))}_createLuminancePostProcesses(e,t){let i=Math.pow(3,_t.LuminanceSteps);this.luminancePostProcess=new Fe("HDRLuminance","standard",["lumOffsets"],[],{width:i,height:i},null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LUMINANCE",t);const s=[];this.luminancePostProcess.onApply=n=>{const o=1/this.luminancePostProcess.width,l=1/this.luminancePostProcess.height;s[0]=-.5*o,s[1]=.5*l,s[2]=.5*o,s[3]=.5*l,s[4]=-.5*o,s[5]=-.5*l,s[6]=.5*o,s[7]=-.5*l,n.setArray2("lumOffsets",s)},this.addEffect(new bt(e.getEngine(),"HDRLuminance",()=>this.luminancePostProcess,!0));for(let n=_t.LuminanceSteps-1;n>=0;n--){i=Math.pow(3,n);let o=`#define LUMINANCE_DOWN_SAMPLE
`;n===0&&(o+="#define FINAL_DOWN_SAMPLER");const l=new Fe("HDRLuminanceDownSample"+n,"standard",["dsOffsets","halfDestPixelSize"],[],{width:i,height:i},null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,o,t);this.luminanceDownSamplePostProcesses.push(l)}let r=this.luminancePostProcess;this.luminanceDownSamplePostProcesses.forEach((n,o)=>{const l=new Array(18);n.onApply=h=>{if(!r)return;let c=0;for(let u=-1;u<2;u++)for(let d=-1;d<2;d++)l[c]=u/r.width,l[c+1]=d/r.height,c+=2;h.setArray2("dsOffsets",l),h.setFloat("halfDestPixelSize",.5/r.width),o===this.luminanceDownSamplePostProcesses.length-1?r=this.luminancePostProcess:r=n},o===this.luminanceDownSamplePostProcesses.length-1&&(n.onAfterRender=()=>{const h=e.getEngine().readPixels(0,0,1,1),c=new Ge(1/(255*255*255),1/(255*255),1/255,1);h.then(u=>{const d=new Uint8Array(u.buffer);this._hdrCurrentLuminance=(d[0]*c.x+d[1]*c.y+d[2]*c.z+d[3]*c.w)/100})}),this.addEffect(new bt(e.getEngine(),"HDRLuminanceDownSample"+o,()=>n,!0))})}_createHdrPostProcess(e,t){const i=["#define HDR"];this._hdrAutoExposure&&i.push("#define AUTO_EXPOSURE"),this.hdrPostProcess=new Fe("HDR","standard",["averageLuminance"],["textureAdderSampler"],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,i.join(`
`),0);let s=1,r=0,n=0;this.hdrPostProcess.onApply=o=>{if(o.setTextureFromPostProcess("textureAdderSampler",this._currentDepthOfFieldSource),r+=e.getEngine().getDeltaTime(),s<0)s=this._hdrCurrentLuminance;else{const l=(n-r)/1e3;this._hdrCurrentLuminance<s+this.hdrDecreaseRate*l?s+=this.hdrDecreaseRate*l:this._hdrCurrentLuminance>s-this.hdrIncreaseRate*l?s-=this.hdrIncreaseRate*l:s=this._hdrCurrentLuminance}this.hdrAutoExposure?this._currentExposure=this._fixedExposure/s:(s=oe.Clamp(s,this.hdrMinimumLuminance,1e20),o.setFloat("averageLuminance",s)),n=r,this._currentDepthOfFieldSource=this.hdrFinalPostProcess},this.addEffect(new bt(e.getEngine(),"HDR",()=>this.hdrPostProcess,!0))}_createLensFlarePostProcess(e,t){this.lensFlarePostProcess=new Fe("HDRLensFlare","standard",["strength","ghostDispersal","haloWidth","resolution","distortionStrength"],["lensColorSampler"],t/2,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE",0),this.addEffect(new bt(e.getEngine(),"HDRLensFlare",()=>this.lensFlarePostProcess,!0)),this._createBlurPostProcesses(e,t/4,2,"lensFlareBlurWidth"),this.lensFlareComposePostProcess=new Fe("HDRLensFlareCompose","standard",["lensStarMatrix"],["otherSampler","lensDirtSampler","lensStarSampler"],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define LENS_FLARE_COMPOSE",0),this.addEffect(new bt(e.getEngine(),"HDRLensFlareCompose",()=>this.lensFlareComposePostProcess,!0));const i=new le(0,0);this.lensFlarePostProcess.externalTextureSamplerBinding=!0,this.lensFlarePostProcess.onApply=n=>{n.setTextureFromPostProcess("textureSampler",this._bloomEnabled?this.blurHPostProcesses[0]:this.originalPostProcess),n.setTexture("lensColorSampler",this.lensColorTexture),n.setFloat("strength",this.lensFlareStrength),n.setFloat("ghostDispersal",this.lensFlareGhostDispersal),n.setFloat("haloWidth",this.lensFlareHaloWidth),i.x=this.lensFlarePostProcess.width,i.y=this.lensFlarePostProcess.height,n.setVector2("resolution",i),n.setFloat("distortionStrength",this.lensFlareDistortionStrength)};const s=L.FromValues(2,0,-1,0,0,2,-1,0,0,0,1,0,0,0,0,1),r=L.FromValues(.5,0,.5,0,0,.5,.5,0,0,0,1,0,0,0,0,1);this.lensFlareComposePostProcess.onApply=n=>{if(!this._scene.activeCamera)return;n.setTextureFromPostProcess("otherSampler",this.lensFlarePostProcess),n.setTexture("lensDirtSampler",this.lensFlareDirtTexture),n.setTexture("lensStarSampler",this.lensStarTexture);const o=this._scene.activeCamera.getViewMatrix().getRow(0),l=this._scene.activeCamera.getViewMatrix().getRow(2);let h=g.Dot(o.toVector3(),new g(1,0,0))+g.Dot(l.toVector3(),new g(0,0,1));h*=4;const c=L.FromValues(Math.cos(h)*.5,-Math.sin(h),0,0,Math.sin(h),Math.cos(h)*.5,0,0,0,0,1,0,0,0,0,1),u=r.multiply(c).multiply(s);n.setMatrix("lensStarMatrix",u),this._currentDepthOfFieldSource=this.lensFlareFinalPostProcess}}_createDepthOfFieldPostProcess(e,t){this.depthOfFieldPostProcess=new Fe("HDRDepthOfField","standard",["distance"],["otherSampler","depthSampler"],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,"#define DEPTH_OF_FIELD",0),this.depthOfFieldPostProcess.onApply=i=>{i.setTextureFromPostProcess("otherSampler",this._currentDepthOfFieldSource),i.setTexture("depthSampler",this._getDepthTexture()),i.setFloat("distance",this.depthOfFieldDistance)},this.addEffect(new bt(e.getEngine(),"HDRDepthOfField",()=>this.depthOfFieldPostProcess,!0))}_createMotionBlurPostProcess(e,t){if(this._isObjectBasedMotionBlur){const i=new $a("HDRMotionBlur",e,t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,0);i.motionStrength=this.motionStrength,i.motionBlurSamples=this.motionBlurSamples,this.motionBlurPostProcess=i}else{this.motionBlurPostProcess=new Fe("HDRMotionBlur","standard",["inverseViewProjection","prevViewProjection","screenSize","motionScale","motionStrength"],["depthSampler"],t,null,H.BILINEAR_SAMPLINGMODE,e.getEngine(),!1,`#define MOTION_BLUR
#define MAX_MOTION_SAMPLES `+this.motionBlurSamples.toFixed(1),0);let i=0,s=L.Identity();const r=L.Identity();let n=L.Identity();const o=le.Zero();this.motionBlurPostProcess.onApply=l=>{n=e.getProjectionMatrix().multiply(e.getViewMatrix()),n.invertToRef(r),l.setMatrix("inverseViewProjection",r),l.setMatrix("prevViewProjection",s),s=n,o.x=this.motionBlurPostProcess.width,o.y=this.motionBlurPostProcess.height,l.setVector2("screenSize",o),i=e.getEngine().getFps()/60,l.setFloat("motionScale",i),l.setFloat("motionStrength",this.motionStrength),l.setTexture("depthSampler",this._getDepthTexture())}}this.addEffect(new bt(e.getEngine(),"HDRMotionBlur",()=>this.motionBlurPostProcess,!0))}_getDepthTexture(){return this._scene.getEngine().getCaps().drawBuffersExtension?this._scene.enableGeometryBufferRenderer().getGBuffer().textures[0]:this._scene.enableDepthRenderer().getDepthMap()}_disposePostProcesses(){for(let e=0;e<this._cameras.length;e++){const t=this._cameras[e];this.originalPostProcess&&this.originalPostProcess.dispose(t),this.screenSpaceReflectionPostProcess&&this.screenSpaceReflectionPostProcess.dispose(t),this.downSampleX4PostProcess&&this.downSampleX4PostProcess.dispose(t),this.brightPassPostProcess&&this.brightPassPostProcess.dispose(t),this.textureAdderPostProcess&&this.textureAdderPostProcess.dispose(t),this.volumetricLightPostProcess&&this.volumetricLightPostProcess.dispose(t),this.volumetricLightSmoothXPostProcess&&this.volumetricLightSmoothXPostProcess.dispose(t),this.volumetricLightSmoothYPostProcess&&this.volumetricLightSmoothYPostProcess.dispose(t),this.volumetricLightMergePostProces&&this.volumetricLightMergePostProces.dispose(t),this.volumetricLightFinalPostProcess&&this.volumetricLightFinalPostProcess.dispose(t),this.lensFlarePostProcess&&this.lensFlarePostProcess.dispose(t),this.lensFlareComposePostProcess&&this.lensFlareComposePostProcess.dispose(t);for(let i=0;i<this.luminanceDownSamplePostProcesses.length;i++)this.luminanceDownSamplePostProcesses[i].dispose(t);this.luminancePostProcess&&this.luminancePostProcess.dispose(t),this.hdrPostProcess&&this.hdrPostProcess.dispose(t),this.hdrFinalPostProcess&&this.hdrFinalPostProcess.dispose(t),this.depthOfFieldPostProcess&&this.depthOfFieldPostProcess.dispose(t),this.motionBlurPostProcess&&this.motionBlurPostProcess.dispose(t),this.fxaaPostProcess&&this.fxaaPostProcess.dispose(t);for(let i=0;i<this.blurHPostProcesses.length;i++)this.blurHPostProcesses[i].dispose(t);for(let i=0;i<this.blurVPostProcesses.length;i++)this.blurVPostProcesses[i].dispose(t)}this.originalPostProcess=null,this.downSampleX4PostProcess=null,this.brightPassPostProcess=null,this.textureAdderPostProcess=null,this.textureAdderFinalPostProcess=null,this.volumetricLightPostProcess=null,this.volumetricLightSmoothXPostProcess=null,this.volumetricLightSmoothYPostProcess=null,this.volumetricLightMergePostProces=null,this.volumetricLightFinalPostProcess=null,this.lensFlarePostProcess=null,this.lensFlareComposePostProcess=null,this.luminancePostProcess=null,this.hdrPostProcess=null,this.hdrFinalPostProcess=null,this.depthOfFieldPostProcess=null,this.motionBlurPostProcess=null,this.fxaaPostProcess=null,this.screenSpaceReflectionPostProcess=null,this.luminanceDownSamplePostProcesses.length=0,this.blurHPostProcesses.length=0,this.blurVPostProcesses.length=0}dispose(){this._disposePostProcesses(),this._scene.postProcessRenderPipelineManager.detachCamerasFromRenderPipeline(this._name,this._cameras),super.dispose()}serialize(){const e=xe.Serialize(this);return this.sourceLight&&(e.sourceLightId=this.sourceLight.id),this.screenSpaceReflectionPostProcess&&(e.screenSpaceReflectionPostProcess=xe.Serialize(this.screenSpaceReflectionPostProcess)),e.customType="StandardRenderingPipeline",e}static Parse(e,t,i){const s=xe.Parse(()=>new _t(e._name,t,e._ratio),e,t,i);return e.sourceLightId&&(s.sourceLight=t.getLightById(e.sourceLightId)),e.screenSpaceReflectionPostProcess&&xe.Parse(()=>s.screenSpaceReflectionPostProcess,e.screenSpaceReflectionPostProcess,t,i),s}}_t.LuminanceSteps=6;T([R()],_t.prototype,"brightThreshold",void 0);T([R()],_t.prototype,"blurWidth",void 0);T([R()],_t.prototype,"horizontalBlur",void 0);T([R()],_t.prototype,"exposure",null);T([Qe("lensTexture")],_t.prototype,"lensTexture",void 0);T([R()],_t.prototype,"volumetricLightCoefficient",void 0);T([R()],_t.prototype,"volumetricLightPower",void 0);T([R()],_t.prototype,"volumetricLightBlurScale",void 0);T([R()],_t.prototype,"hdrMinimumLuminance",void 0);T([R()],_t.prototype,"hdrDecreaseRate",void 0);T([R()],_t.prototype,"hdrIncreaseRate",void 0);T([R()],_t.prototype,"hdrAutoExposure",null);T([Qe("lensColorTexture")],_t.prototype,"lensColorTexture",void 0);T([R()],_t.prototype,"lensFlareStrength",void 0);T([R()],_t.prototype,"lensFlareGhostDispersal",void 0);T([R()],_t.prototype,"lensFlareHaloWidth",void 0);T([R()],_t.prototype,"lensFlareDistortionStrength",void 0);T([R()],_t.prototype,"lensFlareBlurWidth",void 0);T([Qe("lensStarTexture")],_t.prototype,"lensStarTexture",void 0);T([Qe("lensFlareDirtTexture")],_t.prototype,"lensFlareDirtTexture",void 0);T([R()],_t.prototype,"depthOfFieldDistance",void 0);T([R()],_t.prototype,"depthOfFieldBlurWidth",void 0);T([R()],_t.prototype,"motionStrength",null);T([R()],_t.prototype,"objectBasedMotionBlur",null);T([R()],_t.prototype,"_ratio",void 0);T([R()],_t.prototype,"BloomEnabled",null);T([R()],_t.prototype,"DepthOfFieldEnabled",null);T([R()],_t.prototype,"LensFlareEnabled",null);T([R()],_t.prototype,"HDREnabled",null);T([R()],_t.prototype,"VLSEnabled",null);T([R()],_t.prototype,"MotionBlurEnabled",null);T([R()],_t.prototype,"fxaaEnabled",null);T([R()],_t.prototype,"screenSpaceReflectionsEnabled",null);T([R()],_t.prototype,"volumetricLightStepsCount",null);T([R()],_t.prototype,"motionBlurSamples",null);T([R()],_t.prototype,"samples",null);he("BABYLON.StandardRenderingPipeline",_t);const b2="tonemapPixelShader",S2=`varying vec2 vUV;
uniform sampler2D textureSampler;
uniform float _ExposureAdjustment;
#if defined(HABLE_TONEMAPPING)
const float A=0.15;
const float B=0.50;
const float C=0.10;
const float D=0.20;
const float E=0.02;
const float F=0.30;
const float W=11.2;
#endif
float Luminance(vec3 c)
{
return dot(c,vec3(0.22,0.707,0.071));
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec3 colour=texture2D(textureSampler,vUV).rgb;
#if defined(REINHARD_TONEMAPPING)
float lum=Luminance(colour.rgb); 
float lumTm=lum*_ExposureAdjustment;
float scale=lumTm/(1.0+lumTm); 
colour*=scale/lum;
#elif defined(HABLE_TONEMAPPING)
colour*=_ExposureAdjustment;
const float ExposureBias=2.0;
vec3 x=ExposureBias*colour;
vec3 curr=((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;
x=vec3(W,W,W);
vec3 whiteScale=1.0/(((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F);
colour=curr*whiteScale;
#elif defined(OPTIMIZED_HEJIDAWSON_TONEMAPPING)
colour*=_ExposureAdjustment;
vec3 X=max(vec3(0.0,0.0,0.0),colour-0.004);
vec3 retColor=(X*(6.2*X+0.5))/(X*(6.2*X+1.7)+0.06);
colour=retColor*retColor;
#elif defined(PHOTOGRAPHIC_TONEMAPPING)
colour= vec3(1.0,1.0,1.0)-exp2(-_ExposureAdjustment*colour);
#endif
gl_FragColor=vec4(colour.rgb,1.0);
}`;Y.ShadersStore[b2]=S2;var dp;(function(a){a[a.Hable=0]="Hable",a[a.Reinhard=1]="Reinhard",a[a.HejiDawson=2]="HejiDawson",a[a.Photographic=3]="Photographic"})(dp||(dp={}));const E2="volumetricLightScatteringPixelShader",C2=`uniform sampler2D textureSampler;
uniform sampler2D lightScatteringSampler;
uniform float decay;
uniform float exposure;
uniform float weight;
uniform float density;
uniform vec2 meshPositionOnScreen;
varying vec2 vUV;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec2 tc=vUV;
vec2 deltaTexCoord=(tc-meshPositionOnScreen.xy);
deltaTexCoord*=1.0/float(NUM_SAMPLES)*density;
float illuminationDecay=1.0;
vec4 color=texture2D(lightScatteringSampler,tc)*0.4;
for(int i=0; i<NUM_SAMPLES; i++) {
tc-=deltaTexCoord;
vec4 dataSample=texture2D(lightScatteringSampler,tc)*0.4;
dataSample*=illuminationDecay*weight;
color+=dataSample;
illuminationDecay*=decay;
}
vec4 realColor=texture2D(textureSampler,vUV);
gl_FragColor=((vec4((vec3(color.r,color.g,color.b)*exposure),1))+(realColor*(1.5-0.4)));
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Y.ShadersStore[E2]=C2;const y2="volumetricLightScatteringPassVertexShader",A2=`attribute vec3 position;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<instancesDeclaration>
uniform mat4 viewProjection;
uniform vec2 depthValues;
#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
#if (defined(ALPHATEST) || defined(NEED_UV)) && defined(UV1)
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
gl_Position=viewProjection*finalWorld*vec4(positionUpdated,1.0);
#if defined(ALPHATEST) || defined(BASIC_RENDER)
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
}
`;Y.ShadersStore[y2]=A2;const R2="volumetricLightScatteringPassPixelShader",I2=`#if defined(ALPHATEST) || defined(NEED_UV)
varying vec2 vUV;
#endif
#if defined(ALPHATEST)
uniform sampler2D diffuseSampler;
#endif
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void)
{
#if defined(ALPHATEST)
vec4 diffuseColor=texture2D(diffuseSampler,vUV);
if (diffuseColor.a<0.4)
discard;
#endif
gl_FragColor=vec4(0.0,0.0,0.0,1.0);
}
`;Y.ShadersStore[R2]=I2;class xr extends Fe{constructor(e,t,i,s,r=100,n=H.BILINEAR_SAMPLINGMODE,o,l,h){var c,u;super(e,"volumetricLightScattering",["decay","exposure","weight","meshPositionOnScreen","density"],["lightScatteringSampler"],t.postProcessRatio||t,i,n,o,l,"#define NUM_SAMPLES "+r),this._screenCoordinates=le.Zero(),this.customMeshPosition=g.Zero(),this.useCustomMeshPosition=!1,this.invert=!0,this.excludedMeshes=new Array,this.exposure=.3,this.decay=.96815,this.weight=.58767,this.density=.926,h=(u=(c=i==null?void 0:i.getScene())!==null&&c!==void 0?c:h)!==null&&u!==void 0?u:this._scene,o=h.getEngine(),this._viewPort=new Es(0,0,1,1).toGlobal(o.getRenderWidth(),o.getRenderHeight()),this.mesh=s!=null?s:xr.CreateDefaultMesh("VolumetricLightScatteringMesh",h),this._createPass(h,t.passRatio||t),this.onActivate=d=>{this.isSupported||this.dispose(d),this.onActivate=null},this.onApplyObservable.add(d=>{this._updateMeshScreenCoordinates(h),d.setTexture("lightScatteringSampler",this._volumetricLightScatteringRTT),d.setFloat("exposure",this.exposure),d.setFloat("decay",this.decay),d.setFloat("weight",this.weight),d.setFloat("density",this.density),d.setVector2("meshPositionOnScreen",this._screenCoordinates)})}get useDiffuseColor(){return B.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead"),!1}set useDiffuseColor(e){B.Warn("VolumetricLightScatteringPostProcess.useDiffuseColor is no longer used, use the mesh material directly instead")}getClassName(){return"VolumetricLightScatteringPostProcess"}_isReady(e,t){var i;const s=e.getMesh();if(s===this.mesh&&s.material)return s.material.isReady(s);const r=(i=s._internalAbstractMeshDataInfo._materialForRenderPass)===null||i===void 0?void 0:i[this._scene.getEngine().currentRenderPassId];if(r)return r.isReadyForSubMesh(s,e,t);const n=[],o=[y.PositionKind],l=e.getMaterial();l&&(l.needAlphaTesting()&&n.push("#define ALPHATEST"),s.isVerticesDataPresent(y.UVKind)&&(o.push(y.UVKind),n.push("#define UV1")),s.isVerticesDataPresent(y.UV2Kind)&&(o.push(y.UV2Kind),n.push("#define UV2"))),s.useBones&&s.computeBonesUsingShaders?(o.push(y.MatricesIndicesKind),o.push(y.MatricesWeightsKind),n.push("#define NUM_BONE_INFLUENCERS "+s.numBoneInfluencers),n.push("#define BonesPerMesh "+(s.skeleton?s.skeleton.bones.length+1:0))):n.push("#define NUM_BONE_INFLUENCERS 0"),t&&(n.push("#define INSTANCES"),se.PushAttributesForInstances(o),e.getRenderingMesh().hasThinInstances&&n.push("#define THIN_INSTANCES"));const h=e._getDrawWrapper(void 0,!0),c=h.defines,u=n.join(`
`);return c!==u&&h.setEffect(s.getScene().getEngine().createEffect("volumetricLightScatteringPass",o,["world","mBones","viewProjection","diffuseMatrix"],["diffuseSampler"],u,void 0,void 0,void 0,{maxSimultaneousMorphTargets:s.numBoneInfluencers}),u),h.effect.isReady()}setCustomMeshPosition(e){this.customMeshPosition=e}getCustomMeshPosition(){return this.customMeshPosition}dispose(e){const t=e.getScene().customRenderTargets.indexOf(this._volumetricLightScatteringRTT);t!==-1&&e.getScene().customRenderTargets.splice(t,1),this._volumetricLightScatteringRTT.dispose(),super.dispose(e)}getPass(){return this._volumetricLightScatteringRTT}_meshExcluded(e){return this.excludedMeshes.length>0&&this.excludedMeshes.indexOf(e)!==-1}_createPass(e,t){const i=e.getEngine();this._volumetricLightScatteringRTT=new si("volumetricLightScatteringMap",{width:i.getRenderWidth()*t,height:i.getRenderHeight()*t},e,!1,!0,0),this._volumetricLightScatteringRTT.wrapU=H.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.wrapV=H.CLAMP_ADDRESSMODE,this._volumetricLightScatteringRTT.renderList=null,this._volumetricLightScatteringRTT.renderParticles=!1,this._volumetricLightScatteringRTT.ignoreCameraViewport=!0;const s=this.getCamera();s?s.customRenderTargets.push(this._volumetricLightScatteringRTT):e.customRenderTargets.push(this._volumetricLightScatteringRTT);const r=l=>{var h;const c=l.getRenderingMesh(),u=l.getEffectiveMesh();if(this._meshExcluded(c))return;u._internalAbstractMeshDataInfo._isActiveIntermediate=!1;const d=l.getMaterial();if(!d)return;const f=c.getScene(),p=f.getEngine();p.setState(d.backFaceCulling,void 0,void 0,void 0,d.cullBackFaces);const _=c._getInstancesRenderList(l._id,!!l.getReplacementMesh());if(_.mustReturn)return;const m=p.getCaps().instancedArrays&&(_.visibleInstances[l._id]!==null||c.hasThinInstances);if(this._isReady(l,m)){const v=(h=u._internalAbstractMeshDataInfo._materialForRenderPass)===null||h===void 0?void 0:h[p.currentRenderPassId];let x=l._getDrawWrapper();if(c===this.mesh&&!x&&(x=d._getDrawWrapper()),!x)return;const b=x.effect;if(p.enableEffect(x),m||c._bind(l,b,d.fillMode),c===this.mesh)d.bind(u.getWorldMatrix(),c);else if(v)v.bindForSubMesh(u.getWorldMatrix(),u,l);else{if(b.setMatrix("viewProjection",f.getTransformMatrix()),d&&d.needAlphaTesting()){const S=d.getAlphaTestTexture();b.setTexture("diffuseSampler",S),S&&b.setMatrix("diffuseMatrix",S.getTextureMatrix())}c.useBones&&c.computeBonesUsingShaders&&c.skeleton&&b.setMatrices("mBones",c.skeleton.getTransformMatrices(c))}m&&c.hasThinInstances&&b.setMatrix("world",u.getWorldMatrix()),c._processRendering(u,l,b,ne.TriangleFillMode,_,m,(S,C)=>{S||b.setMatrix("world",C)})}};let n;const o=new J(0,0,0,1);this._volumetricLightScatteringRTT.onBeforeRenderObservable.add(()=>{n=e.clearColor,e.clearColor=o}),this._volumetricLightScatteringRTT.onAfterRenderObservable.add(()=>{e.clearColor=n}),this._volumetricLightScatteringRTT.customIsReadyFunction=(l,h)=>{if(!l.isReady(!1))return!1;if(h===0&&l.subMeshes)for(let c=0;c<l.subMeshes.length;++c){const u=l.subMeshes[c],d=u.getMaterial(),f=u.getRenderingMesh();if(!d)continue;const p=f._getInstancesRenderList(u._id,!!u.getReplacementMesh()),_=i.getCaps().instancedArrays&&(p.visibleInstances[u._id]!==null||f.hasThinInstances);if(!this._isReady(u,_))return!1}return!0},this._volumetricLightScatteringRTT.customRenderFunction=(l,h,c,u)=>{const d=e.getEngine();let f;if(u.length){for(d.setColorWrite(!1),f=0;f<u.length;f++)r(u.data[f]);d.setColorWrite(!0)}for(f=0;f<l.length;f++)r(l.data[f]);for(f=0;f<h.length;f++)r(h.data[f]);if(c.length){for(f=0;f<c.length;f++){const _=c.data[f],m=_.getBoundingInfo();m&&e.activeCamera&&(_._alphaIndex=_.getMesh().alphaIndex,_._distanceToCamera=m.boundingSphere.centerWorld.subtract(e.activeCamera.position).length())}const p=c.data.slice(0,c.length);for(p.sort((_,m)=>_._alphaIndex>m._alphaIndex?1:_._alphaIndex<m._alphaIndex?-1:_._distanceToCamera<m._distanceToCamera?1:_._distanceToCamera>m._distanceToCamera?-1:0),d.setAlphaMode(2),f=0;f<p.length;f++)r(p[f]);d.setAlphaMode(0)}}}_updateMeshScreenCoordinates(e){const t=e.getTransformMatrix();let i;this.useCustomMeshPosition?i=this.customMeshPosition:this.attachedNode?i=this.attachedNode.position:i=this.mesh.parent?this.mesh.getAbsolutePosition():this.mesh.position;const s=g.Project(i,L.Identity(),t,this._viewPort);this._screenCoordinates.x=s.x/this._viewPort.width,this._screenCoordinates.y=s.y/this._viewPort.height,this.invert&&(this._screenCoordinates.y=1-this._screenCoordinates.y)}static CreateDefaultMesh(e,t){const i=Ec(e,{size:1},t);i.billboardMode=ct.BILLBOARDMODE_ALL;const s=new pe(e+"Material",t);return s.emissiveColor=new re(1,1,1),i.material=s,i}}T([Zi()],xr.prototype,"customMeshPosition",void 0);T([R()],xr.prototype,"useCustomMeshPosition",void 0);T([R()],xr.prototype,"invert",void 0);T([Xl()],xr.prototype,"mesh",void 0);T([R()],xr.prototype,"excludedMeshes",void 0);T([R()],xr.prototype,"exposure",void 0);T([R()],xr.prototype,"decay",void 0);T([R()],xr.prototype,"weight",void 0);T([R()],xr.prototype,"density",void 0);he("BABYLON.VolumetricLightScatteringPostProcess",xr);const P2="screenSpaceCurvaturePixelShader",M2=`precision highp float;
varying vec2 vUV;
uniform sampler2D textureSampler;
uniform sampler2D normalSampler;
uniform float curvature_ridge;
uniform float curvature_valley;
#ifndef CURVATURE_OFFSET
#define CURVATURE_OFFSET 1
#endif
float curvature_soft_clamp(float curvature,float control)
{
if (curvature<0.5/control)
return curvature*(1.0-curvature*control);
return 0.25/control;
}
float calculate_curvature(ivec2 texel,float ridge,float valley)
{
vec2 normal_up =texelFetch(normalSampler,texel+ivec2(0, CURVATURE_OFFSET),0).rb;
vec2 normal_down =texelFetch(normalSampler,texel+ivec2(0,-CURVATURE_OFFSET),0).rb;
vec2 normal_left =texelFetch(normalSampler,texel+ivec2(-CURVATURE_OFFSET,0),0).rb;
vec2 normal_right=texelFetch(normalSampler,texel+ivec2( CURVATURE_OFFSET,0),0).rb;
float normal_diff=((normal_up.g-normal_down.g)+(normal_right.r-normal_left.r));
if (normal_diff<0.0)
return -2.0*curvature_soft_clamp(-normal_diff,valley);
return 2.0*curvature_soft_clamp(normal_diff,ridge);
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
ivec2 texel=ivec2(gl_FragCoord.xy);
vec4 baseColor=texture2D(textureSampler,vUV);
float curvature=calculate_curvature(texel,curvature_ridge,curvature_valley);
baseColor.rgb*=curvature+1.0;
gl_FragColor=baseColor;
}`;Y.ShadersStore[P2]=M2;class rh extends Fe{constructor(e,t,i,s,r,n,o,l=0,h=!1){super(e,"screenSpaceCurvature",["curvature_ridge","curvature_valley"],["textureSampler","normalSampler"],i,s,r,n,o,void 0,l,void 0,null,h),this.ridge=1,this.valley=1,this._geometryBufferRenderer=t.enableGeometryBufferRenderer(),this._geometryBufferRenderer?this.onApply=c=>{c.setFloat("curvature_ridge",.5/Math.max(this.ridge*this.ridge,1e-4)),c.setFloat("curvature_valley",.7/Math.max(this.valley*this.valley,1e-4));const u=this._geometryBufferRenderer.getGBuffer().textures[1];c.setTexture("normalSampler",u)}:B.Error("Multiple Render Target support needed for screen space curvature post process. Please use IsSupported test first.")}getClassName(){return"ScreenSpaceCurvaturePostProcess"}static get IsSupported(){const e=ye.LastCreatedEngine;return e?e.getCaps().drawBuffersExtension:!1}static _Parse(e,t,i,s){return xe.Parse(()=>new rh(e.name,i,e.options,t,e.renderTargetSamplingMode,i.getEngine(),e.textureType,e.reusable),e,i,s)}}T([R()],rh.prototype,"ridge",void 0);T([R()],rh.prototype,"valley",void 0);he("BABYLON.ScreenSpaceCurvaturePostProcess",rh);const D2="boundingBoxRendererFragmentDeclaration",O2=`uniform vec4 color;
`;Y.IncludesShadersStore[D2]=O2;const w2="boundingBoxRendererUboDeclaration",N2=`#ifdef WEBGL2
uniform vec4 color;
uniform mat4 world;
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
#else
layout(std140,column_major) uniform;
uniform BoundingBoxRenderer {
vec4 color;
mat4 world;
mat4 viewProjection;
mat4 viewProjectionR;
};
#endif
`;Y.IncludesShadersStore[w2]=N2;const F2="boundingBoxRendererPixelShader",L2=`#include<__decl__boundingBoxRendererFragment>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[F2]=L2;const B2="boundingBoxRendererVertexDeclaration",U2=`uniform mat4 world;
uniform mat4 viewProjection;
#ifdef MULTIVIEW
uniform mat4 viewProjectionR;
#endif
`;Y.IncludesShadersStore[B2]=U2;const V2="boundingBoxRendererVertexShader",k2=`attribute vec3 position;
#include<__decl__boundingBoxRendererVertex>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec4 worldPos=world*vec4(position,1.0);
#ifdef MULTIVIEW
if (gl_ViewID_OVR==0u) {
gl_Position=viewProjection*worldPos;
} else {
gl_Position=viewProjectionR*worldPos;
}
#else
gl_Position=viewProjection*worldPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}
`;Y.ShadersStore[V2]=k2;Object.defineProperty(ge.prototype,"forceShowBoundingBoxes",{get:function(){return this._forceShowBoundingBoxes||!1},set:function(a){this._forceShowBoundingBoxes=a,a&&this.getBoundingBoxRenderer()},enumerable:!0,configurable:!0});ge.prototype.getBoundingBoxRenderer=function(){return this._boundingBoxRenderer||(this._boundingBoxRenderer=new G2(this)),this._boundingBoxRenderer};Object.defineProperty(ct.prototype,"showBoundingBox",{get:function(){return this._showBoundingBox||!1},set:function(a){this._showBoundingBox=a,a&&this.getScene().getBoundingBoxRenderer()},enumerable:!0,configurable:!0});class G2{constructor(e){this.name=ue.NAME_BOUNDINGBOXRENDERER,this.frontColor=new re(1,1,1),this.backColor=new re(.1,.1,.1),this.showBackLines=!0,this.onBeforeBoxRenderingObservable=new X,this.onAfterBoxRenderingObservable=new X,this.onResourcesReadyObservable=new X,this.enabled=!0,this.renderList=new mi(32),this._vertexBuffers={},this._fillIndexBuffer=null,this._fillIndexData=null,this.scene=e,e._addComponent(this),this._uniformBufferFront=new Pe(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererFront",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferFront),this._uniformBufferBack=new Pe(this.scene.getEngine(),void 0,void 0,"BoundingBoxRendererBack",!this.scene.getEngine().isWebGPU),this._buildUniformLayout(this._uniformBufferBack)}_buildUniformLayout(e){e.addUniform("color",4),e.addUniform("world",16),e.addUniform("viewProjection",16),e.addUniform("viewProjectionR",16),e.create()}register(){this.scene._beforeEvaluateActiveMeshStage.registerStep(ue.STEP_BEFOREEVALUATEACTIVEMESH_BOUNDINGBOXRENDERER,this,this.reset),this.scene._preActiveMeshStage.registerStep(ue.STEP_PREACTIVEMESH_BOUNDINGBOXRENDERER,this,this._preActiveMesh),this.scene._evaluateSubMeshStage.registerStep(ue.STEP_EVALUATESUBMESH_BOUNDINGBOXRENDERER,this,this._evaluateSubMesh),this.scene._afterRenderingGroupDrawStage.registerStep(ue.STEP_AFTERRENDERINGGROUPDRAW_BOUNDINGBOXRENDERER,this,this.render)}_evaluateSubMesh(e,t){if(e.showSubMeshesBoundingBox){const i=t.getBoundingInfo();i!=null&&(i.boundingBox._tag=e.renderingGroupId,this.renderList.push(i.boundingBox))}}_preActiveMesh(e){if(e.showBoundingBox||this.scene.forceShowBoundingBoxes){const t=e.getBoundingInfo();t.boundingBox._tag=e.renderingGroupId,this.renderList.push(t.boundingBox)}}_prepareResources(){if(this._colorShader)return;this._colorShader=new Or("colorShader",this.scene,"boundingBoxRenderer",{attributes:[y.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!1),this._colorShader.reservedDataStore={hidden:!0},this._colorShaderForOcclusionQuery=new Or("colorShaderOccQuery",this.scene,"boundingBoxRenderer",{attributes:[y.PositionKind],uniforms:["world","viewProjection","viewProjectionR","color"],uniformBuffers:["BoundingBoxRenderer"]},!0),this._colorShaderForOcclusionQuery.reservedDataStore={hidden:!0};const e=this.scene.getEngine(),t=Jd({size:1});this._vertexBuffers[y.PositionKind]=new y(e,t.positions,y.PositionKind,!1),this._createIndexBuffer(),this._fillIndexData=t.indices,this.onResourcesReadyObservable.notifyObservers(this)}_createIndexBuffer(){const e=this.scene.getEngine();this._indexBuffer=e.createIndexBuffer([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,7,1,6,2,5,3,4])}rebuild(){const e=this._vertexBuffers[y.PositionKind];e&&e._rebuild(),this._createIndexBuffer()}reset(){this.renderList.reset()}render(e){var t,i;if(this.renderList.length===0||!this.enabled||(this._prepareResources(),!this._colorShader.isReady()))return;const s=this.scene.getEngine();s.setDepthWrite(!1);const r=this.frontColor.toColor4(),n=this.backColor.toColor4(),o=this.scene.getTransformMatrix();for(let l=0;l<this.renderList.length;l++){const h=this.renderList.data[l];if(h._tag!==e)continue;this._createWrappersForBoundingBox(h),this.onBeforeBoxRenderingObservable.notifyObservers(h);const c=h.minimum,d=h.maximum.subtract(c),f=c.add(d.scale(.5)),p=L.Scaling(d.x,d.y,d.z).multiply(L.Translation(f.x,f.y,f.z)).multiply(h.getWorldMatrix()),_=s.useReverseDepthBuffer;if(this.showBackLines){const v=(t=h._drawWrapperBack)!==null&&t!==void 0?t:this._colorShader._getDrawWrapper();this._colorShader._preBind(v),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),_?s.setDepthFunctionToLessOrEqual():s.setDepthFunctionToGreaterOrEqual(),this._uniformBufferBack.bindToEffect(v.effect,"BoundingBoxRenderer"),this._uniformBufferBack.updateDirectColor4("color",n),this._uniformBufferBack.updateMatrix("world",p),this._uniformBufferBack.updateMatrix("viewProjection",o),this._uniformBufferBack.update(),s.drawElementsType(ne.LineListDrawMode,0,24)}const m=(i=h._drawWrapperFront)!==null&&i!==void 0?i:this._colorShader._getDrawWrapper();this._colorShader._preBind(m),s.bindBuffers(this._vertexBuffers,this._indexBuffer,this._colorShader.getEffect()),_?s.setDepthFunctionToGreater():s.setDepthFunctionToLess(),this._uniformBufferFront.bindToEffect(m.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateDirectColor4("color",r),this._uniformBufferFront.updateMatrix("world",p),this._uniformBufferFront.updateMatrix("viewProjection",o),this._uniformBufferFront.update(),s.drawElementsType(ne.LineListDrawMode,0,24),this.onAfterBoxRenderingObservable.notifyObservers(h)}this._colorShader.unbind(),s.setDepthFunctionToLessOrEqual(),s.setDepthWrite(!0)}_createWrappersForBoundingBox(e){if(!e._drawWrapperFront){const t=this.scene.getEngine();e._drawWrapperFront=new Vi(t),e._drawWrapperBack=new Vi(t),e._drawWrapperFront.setEffect(this._colorShader.getEffect()),e._drawWrapperBack.setEffect(this._colorShader.getEffect())}}renderOcclusionBoundingBox(e){const t=this.scene.getEngine();this._renderPassIdForOcclusionQuery===void 0&&(this._renderPassIdForOcclusionQuery=t.createRenderPassId("Render pass for occlusion query"));const i=t.currentRenderPassId;t.currentRenderPassId=this._renderPassIdForOcclusionQuery,this._prepareResources();const s=e.subMeshes[0];if(!this._colorShaderForOcclusionQuery.isReady(e,void 0,s)||!e.hasBoundingInfo){t.currentRenderPassId=i;return}this._fillIndexBuffer||(this._fillIndexBuffer=t.createIndexBuffer(this._fillIndexData));const r=t.useReverseDepthBuffer;t.setDepthWrite(!1),t.setColorWrite(!1);const n=e.getBoundingInfo().boundingBox,o=n.minimum,h=n.maximum.subtract(o),c=o.add(h.scale(.5)),u=L.Scaling(h.x,h.y,h.z).multiply(L.Translation(c.x,c.y,c.z)).multiply(n.getWorldMatrix()),d=s._drawWrapper;this._colorShaderForOcclusionQuery._preBind(d),t.bindBuffers(this._vertexBuffers,this._fillIndexBuffer,d.effect),r?t.setDepthFunctionToGreater():t.setDepthFunctionToLess(),this.scene.resetCachedMaterial(),this._uniformBufferFront.bindToEffect(d.effect,"BoundingBoxRenderer"),this._uniformBufferFront.updateMatrix("world",u),this._uniformBufferFront.updateMatrix("viewProjection",this.scene.getTransformMatrix()),this._uniformBufferFront.update(),t.drawElementsType(ne.TriangleFillMode,0,36),this._colorShaderForOcclusionQuery.unbind(),t.setDepthFunctionToLessOrEqual(),t.setDepthWrite(!0),t.setColorWrite(!0),t.currentRenderPassId=i}dispose(){if(this._renderPassIdForOcclusionQuery!==void 0&&(this.scene.getEngine().releaseRenderPassId(this._renderPassIdForOcclusionQuery),this._renderPassIdForOcclusionQuery=void 0),!this._colorShader)return;this.onBeforeBoxRenderingObservable.clear(),this.onAfterBoxRenderingObservable.clear(),this.onResourcesReadyObservable.clear(),this.renderList.dispose(),this._colorShader.dispose(),this._colorShaderForOcclusionQuery.dispose(),this._uniformBufferFront.dispose(),this._uniformBufferBack.dispose();const e=this._vertexBuffers[y.PositionKind];e&&(e.dispose(),this._vertexBuffers[y.PositionKind]=null),this.scene.getEngine()._releaseBuffer(this._indexBuffer),this._fillIndexBuffer&&(this.scene.getEngine()._releaseBuffer(this._fillIndexBuffer),this._fillIndexBuffer=null)}}ge.prototype.enableDepthRenderer=function(a,e=!1,t=!1){if(a=a||this.activeCamera,!a)throw"No camera available to enable depth renderer";if(this._depthRenderer||(this._depthRenderer={}),!this._depthRenderer[a.id]){const i=!!this.getEngine().getCaps().textureFloatRender;let s=0;this.getEngine().getCaps().textureHalfFloatRender&&(!t||!i)?s=2:i?s=1:s=0,this._depthRenderer[a.id]=new Xo(this,s,a,e)}return this._depthRenderer[a.id]};ge.prototype.disableDepthRenderer=function(a){a=a||this.activeCamera,!(!a||!this._depthRenderer||!this._depthRenderer[a.id])&&this._depthRenderer[a.id].dispose()};class z2{constructor(e){this.name=ue.NAME_DEPTHRENDERER,this.scene=e}register(){this.scene._gatherRenderTargetsStage.registerStep(ue.STEP_GATHERRENDERTARGETS_DEPTHRENDERER,this,this._gatherRenderTargets),this.scene._gatherActiveCameraRenderTargetsStage.registerStep(ue.STEP_GATHERACTIVECAMERARENDERTARGETS_DEPTHRENDERER,this,this._gatherActiveCameraRenderTargets)}rebuild(){}dispose(){for(const e in this.scene._depthRenderer)this.scene._depthRenderer[e].dispose()}_gatherRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&!i.useOnlyInActiveCamera&&e.push(i.getDepthMap())}}_gatherActiveCameraRenderTargets(e){if(this.scene._depthRenderer)for(const t in this.scene._depthRenderer){const i=this.scene._depthRenderer[t];i.enabled&&i.useOnlyInActiveCamera&&this.scene.activeCamera.id===t&&e.push(i.getDepthMap())}}}Xo._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_DEPTHRENDERER);e||(e=new z2(a),a._addComponent(e))};const W2="oitFinalPixelShader",H2=`precision highp float;
uniform sampler2D uFrontColor;
uniform sampler2D uBackColor;
void main() {
ivec2 fragCoord=ivec2(gl_FragCoord.xy);
vec4 frontColor=texelFetch(uFrontColor,fragCoord,0);
vec4 backColor=texelFetch(uBackColor,fragCoord,0);
float alphaMultiplier=1.0-frontColor.a;
glFragColor=vec4(
frontColor.rgb+alphaMultiplier*backColor.rgb,
frontColor.a+backColor.a
);
}`;Y.ShadersStore[W2]=H2;const X2="oitBackBlendPixelShader",Y2=`precision highp float;
uniform sampler2D uBackColor;
void main() {
glFragColor=texelFetch(uBackColor,ivec2(gl_FragCoord.xy),0);
if (glFragColor.a==0.0) { 
discard;
}
}`;Y.ShadersStore[X2]=Y2;class K2{constructor(){this.enabled=!0,this.name="depthPeeling",this.texturesRequired=[4]}}class mn{constructor(e,t=5){if(this._thinTextures=[],this._currentPingPongState=0,this._layoutCacheFormat=[[!0],[!0,!0],[!0,!0,!0]],this._layoutCache=[],this._candidateSubMeshes=new mi(10),this._excludedSubMeshes=new mi(10),this._excludedMeshes=[],this._colorCache=[new J(mn._DEPTH_CLEAR_VALUE,mn._DEPTH_CLEAR_VALUE,0,0),new J(-mn._MIN_DEPTH,mn._MAX_DEPTH,0,0),new J(0,0,0,0)],this._scene=e,this._engine=e.getEngine(),this._passCount=t,!e.enablePrePassRenderer()){B.Warn("Depth peeling for order independant transparency could not enable PrePass, aborting.");return}for(let i=0;i<this._layoutCacheFormat.length;++i)this._layoutCache[i]=this._engine.buildTextureLayout(this._layoutCacheFormat[i]);this._renderPassIds=[],this.useRenderPasses=!1,this._prePassEffectConfiguration=new K2,this._createTextures(),this._createEffects()}get passCount(){return this._passCount}set passCount(e){this._passCount!==e&&(this._passCount=e,this._createRenderPassIds())}get useRenderPasses(){return this._useRenderPasses}set useRenderPasses(e){this._useRenderPasses!==e&&(this._useRenderPasses=e,this._createRenderPassIds())}addExcludedMesh(e){this._excludedMeshes.indexOf(e.uniqueId)===-1&&this._excludedMeshes.push(e.uniqueId)}removeExcludedMesh(e){const t=this._excludedMeshes.indexOf(e.uniqueId);t!==-1&&this._excludedMeshes.splice(t,1)}_createRenderPassIds(){if(this._releaseRenderPassIds(),this._useRenderPasses)for(let e=0;e<this._passCount+1;++e)this._renderPassIds[e]||(this._renderPassIds[e]=this._engine.createRenderPassId(`DepthPeelingRenderer - pass #${e}`))}_releaseRenderPassIds(){for(let e=0;e<this._renderPassIds.length;++e)this._engine.releaseRenderPassId(this._renderPassIds[e]);this._renderPassIds=[]}_createTextures(){const e={width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()};this._depthMrts=[new Sa("depthPeelingDepth0",e,3,this._scene),new Sa("depthPeelingDepth1",e,3,this._scene)],this._colorMrts=[new Sa("depthPeelingColor0",e,2,this._scene,{generateDepthBuffer:!1}),new Sa("depthPeelingColor1",e,2,this._scene,{generateDepthBuffer:!1})],this._blendBackMrt=new Sa("depthPeelingBack",e,1,this._scene,{generateDepthBuffer:!1}),this._outputRT=new si("depthPeelingOutput",e,this._scene,!1);const t=[{format:7,samplingMode:1,type:this._engine.getCaps().textureFloatLinearFiltering?1:2},{format:5,samplingMode:1,type:2}];for(let i=0;i<2;i++){const s=this._engine._createInternalTexture(e,t[0],!1),r=this._engine._createInternalTexture(e,t[1],!1),n=this._engine._createInternalTexture(e,t[1],!1);this._depthMrts[i].setInternalTexture(s,0),this._depthMrts[i].setInternalTexture(r,1),this._depthMrts[i].setInternalTexture(n,2),this._colorMrts[i].setInternalTexture(r,0),this._colorMrts[i].setInternalTexture(n,1),this._thinTextures.push(new tl(s),new tl(r),new tl(n))}}_disposeTextures(){for(let e=0;e<this._thinTextures.length;e++)e!==6&&this._thinTextures[e].dispose();for(let e=0;e<2;e++)this._depthMrts[e].dispose(!0),this._colorMrts[e].dispose(!0),this._blendBackMrt.dispose(!0);this._outputRT.dispose(),this._thinTextures=[],this._colorMrts=[],this._depthMrts=[]}_updateTextures(){return(this._depthMrts[0].getSize().width!==this._engine.getRenderWidth()||this._depthMrts[0].getSize().height!==this._engine.getRenderHeight())&&(this._disposeTextures(),this._createTextures()),this._updateTextureReferences()}_updateTextureReferences(){var e;const t=this._scene.prePassRenderer;if(!t)return!1;const i=t.getIndex(4),s=!((e=t.defaultRT.textures)===null||e===void 0)&&e.length?t.defaultRT.textures[i].getInternalTexture():null;return s?(this._blendBackTexture!==s&&(this._blendBackTexture=s,this._blendBackMrt.setInternalTexture(this._blendBackTexture,0),this._thinTextures[6]&&this._thinTextures[6].dispose(),this._thinTextures[6]=new tl(this._blendBackTexture),t.defaultRT.renderTarget._shareDepth(this._depthMrts[0].renderTarget)),!0):!1}_createEffects(){this._blendBackEffectWrapper=new Oh({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._blendBackEffectWrapperPingPong=new Oh({fragmentShader:"oitBackBlend",useShaderStore:!0,engine:this._engine,samplerNames:["uBackColor"],uniformNames:[]}),this._finalEffectWrapper=new Oh({fragmentShader:"oitFinal",useShaderStore:!0,engine:this._engine,samplerNames:["uFrontColor","uBackColor"],uniformNames:[]}),this._effectRenderer=new Fo(this._engine)}setPrePassRenderer(e){e.addEffectConfiguration(this._prePassEffectConfiguration)}bind(e){e.setTexture("oitDepthSampler",this._thinTextures[this._currentPingPongState*3]),e.setTexture("oitFrontColorSampler",this._thinTextures[this._currentPingPongState*3+1])}_renderSubMeshes(e){let t;this._useRenderPasses&&(t={});for(let i=0;i<e.length;i++){const s=e.data[i].getMaterial();let r=!0,n=!1;const o=e.data[i];let l,h=!1;if(this._useRenderPasses&&(l=o._getDrawWrapper(),h=!l),s&&(r=s.allowShaderHotSwapping,n=s.backFaceCulling,s.allowShaderHotSwapping=!1,s.backFaceCulling=!1),o.render(!1),h&&(l=o._getDrawWrapper(),l.materialContext)){let c=t[l.materialContext.uniqueId];c||(c=t[l.materialContext.uniqueId]=this._engine.createMaterialContext()),o._getDrawWrapper().materialContext=c}s&&(s.allowShaderHotSwapping=r,s.backFaceCulling=n)}}_finalCompose(e){var t;((t=this._scene.prePassRenderer)===null||t===void 0?void 0:t.setCustomOutput(this._outputRT))?this._engine.bindFramebuffer(this._outputRT.renderTarget):this._engine.restoreDefaultFramebuffer(),this._engine.setAlphaMode(0),this._engine.applyStates(),this._engine.enableEffect(this._finalEffectWrapper._drawWrapper),this._finalEffectWrapper.effect.setTexture("uFrontColor",this._thinTextures[e*3+1]),this._finalEffectWrapper.effect.setTexture("uBackColor",this._thinTextures[6]),this._effectRenderer.render(this._finalEffectWrapper)}render(e){if(this._candidateSubMeshes.length=0,this._excludedSubMeshes.length=0,!this._blendBackEffectWrapper.effect.isReady()||!this._blendBackEffectWrapperPingPong.effect.isReady()||!this._finalEffectWrapper.effect.isReady()||!this._updateTextures())return this._excludedSubMeshes;for(let r=0;r<e.length;r++){const n=e.data[r],o=n.getMaterial();o&&(o.fillMode===ne.TriangleFanDrawMode||o.fillMode===ne.TriangleFillMode||o.fillMode===ne.TriangleStripDrawMode)&&this._excludedMeshes.indexOf(n.getMesh().uniqueId)===-1?this._candidateSubMeshes.push(n):this._excludedSubMeshes.push(n)}if(!this._candidateSubMeshes.length)return this._finalCompose(1),this._excludedSubMeshes;const t=this._engine.currentRenderPassId;this._scene.prePassRenderer._enabled=!1,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[0]),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[1],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[1].renderTarget),this._engine.bindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[0].renderTarget),this._engine.bindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[1].renderTarget),this._engine.bindFramebuffer(this._depthMrts[0].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthMask=!1,this._engine.depthCullingState.depthTest=!0,this._engine.applyStates(),this._currentPingPongState=1,this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[0].renderTarget),this._scene.resetCachedMaterial();let i=0,s=0;for(let r=0;r<this._passCount;r++){i=r%2,s=1-i,this._currentPingPongState=i,this._useRenderPasses&&(this._engine.currentRenderPassId=this._renderPassIds[r+1]),this._engine.bindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.clear(this._colorCache[0],!0,!1,!1),this._engine.unBindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindFramebuffer(this._colorMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[1]),this._engine.clear(this._colorCache[2],!0,!1,!1),this._engine.unBindFramebuffer(this._colorMrts[s].renderTarget),this._engine.bindFramebuffer(this._depthMrts[s].renderTarget),this._engine.bindAttachments(this._layoutCache[2]),this._engine.setAlphaMode(11),this._engine.setAlphaEquation(3),this._engine.depthCullingState.depthTest=!1,this._engine.applyStates(),this._renderSubMeshes(this._candidateSubMeshes),this._engine.unBindFramebuffer(this._depthMrts[s].renderTarget),this._scene.resetCachedMaterial(),this._engine.bindFramebuffer(this._blendBackMrt.renderTarget),this._engine.bindAttachments(this._layoutCache[0]),this._engine.setAlphaEquation(0),this._engine.setAlphaMode(17),this._engine.applyStates();const n=s===0||!this._useRenderPasses?this._blendBackEffectWrapper:this._blendBackEffectWrapperPingPong;this._engine.enableEffect(n._drawWrapper),n.effect.setTexture("uBackColor",this._thinTextures[s*3+2]),this._effectRenderer.render(n),this._engine.unBindFramebuffer(this._blendBackMrt.renderTarget)}return this._engine.currentRenderPassId=t,this._finalCompose(s),this._scene.prePassRenderer._enabled=!0,this._engine.depthCullingState.depthMask=!0,this._engine.depthCullingState.depthTest=!0,this._excludedSubMeshes}dispose(){this._disposeTextures(),this._blendBackEffectWrapper.dispose(),this._finalEffectWrapper.dispose(),this._effectRenderer.dispose(),this._releaseRenderPassIds()}}mn._DEPTH_CLEAR_VALUE=-99999;mn._MIN_DEPTH=0;mn._MAX_DEPTH=1;Object.defineProperty(ge.prototype,"depthPeelingRenderer",{get:function(){if(!this._depthPeelingRenderer){let a=this._getComponent(ue.NAME_DEPTHPEELINGRENDERER);a||(a=new $2(this),this._addComponent(a))}return this._depthPeelingRenderer},set:function(a){this._depthPeelingRenderer=a},enumerable:!0,configurable:!0});Object.defineProperty(ge.prototype,"useOrderIndependentTransparency",{get:function(){return this._useOrderIndependentTransparency},set:function(a){var e;this._useOrderIndependentTransparency!==a&&(this._useOrderIndependentTransparency=a,this.markAllMaterialsAsDirty(63),(e=this.prePassRenderer)===null||e===void 0||e.markAsDirty())},enumerable:!0,configurable:!0});class $2{constructor(e){this.name=ue.NAME_DEPTHPEELINGRENDERER,this.scene=e,e.depthPeelingRenderer=new mn(e)}register(){}rebuild(){}dispose(){var e;(e=this.scene.depthPeelingRenderer)===null||e===void 0||e.dispose(),this.scene.depthPeelingRenderer=null}}const j2="linePixelShader",q2=`#include<clipPlaneFragmentDeclaration>
uniform vec4 color;
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[j2]=q2;const Q2="lineVertexShader",Z2=`#include<instancesDeclaration>
#include<clipPlaneVertexDeclaration>
attribute vec3 position;
attribute vec4 normal;
uniform mat4 viewProjection;
uniform float width;
uniform float aspectRatio;
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
mat4 worldViewProjection=viewProjection*finalWorld;
vec4 viewPosition=worldViewProjection*vec4(position,1.0);
vec4 viewPositionNext=worldViewProjection*vec4(normal.xyz,1.0);
vec2 currentScreen=viewPosition.xy/viewPosition.w;
vec2 nextScreen=viewPositionNext.xy/viewPositionNext.w;
currentScreen.x*=aspectRatio;
nextScreen.x*=aspectRatio;
vec2 dir=normalize(nextScreen-currentScreen);
vec2 normalDir=vec2(-dir.y,dir.x);
normalDir*=width/2.0;
normalDir.x/=aspectRatio;
vec4 offset=vec4(normalDir*normal.w,0.0,0.0);
gl_Position=viewPosition+offset;
#if defined(CLIPPLANE) || defined(CLIPPLANE2) || defined(CLIPPLANE3) || defined(CLIPPLANE4) || defined(CLIPPLANE5) || defined(CLIPPLANE6)
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<clipPlaneVertex>
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[Q2]=Z2;ct.prototype.disableEdgesRendering=function(){return this._edgesRenderer&&(this._edgesRenderer.dispose(),this._edgesRenderer=null),this};ct.prototype.enableEdgesRendering=function(a=.95,e=!1,t){return this.disableEdgesRendering(),this._edgesRenderer=new hu(this,a,e,!0,t),this};Object.defineProperty(ct.prototype,"edgesRenderer",{get:function(){return this._edgesRenderer},enumerable:!0,configurable:!0});ia.prototype.enableEdgesRendering=function(a=.95,e=!1){return this.disableEdgesRendering(),this._edgesRenderer=new eM(this,a,e),this};nm.prototype.enableEdgesRendering=function(a=.95,e=!1){return ia.prototype.enableEdgesRendering.apply(this,arguments),this};class J2{constructor(){this.edges=new Array,this.edgesConnectedCount=0}}class hu{constructor(e,t=.95,i=!1,s=!0,r){var n;this.edgesWidthScalerForOrthographic=1e3,this.edgesWidthScalerForPerspective=50,this._linesPositions=new Array,this._linesNormals=new Array,this._linesIndices=new Array,this._buffers={},this._buffersForInstances={},this._checkVerticesInsteadOfIndices=!1,this.isEnabled=!0,this.customInstances=new mi(32),this._source=e,this._checkVerticesInsteadOfIndices=i,this._options=r!=null?r:null,this._epsilon=t,this._source.getScene().getEngine().isWebGPU&&(this._drawWrapper=new Vi(e.getEngine())),this._prepareRessources(),s&&(!((n=r==null?void 0:r.useAlternateEdgeFinder)!==null&&n!==void 0)||n?this._generateEdgesLinesAlternate():this._generateEdgesLines()),this._meshRebuildObserver=this._source.onRebuildObservable.add(()=>{this._rebuild()}),this._meshDisposeObserver=this._source.onDisposeObservable.add(()=>{this.dispose()})}get linesPositions(){return this._linesPositions}get linesNormals(){return this._linesNormals}get linesIndices(){return this._linesIndices}get lineShader(){return this._lineShader}set lineShader(e){this._lineShader=e}static _GetShader(e){if(!e._edgeRenderLineShader){const t=new Or("lineShader",e,"line",{attributes:["position","normal"],uniforms:["world","viewProjection","color","width","aspectRatio"]},!1);t.disableDepthWrite=!0,t.backFaceCulling=!1,t.checkReadyOnEveryCall=e.getEngine().isWebGPU,e._edgeRenderLineShader=t}return e._edgeRenderLineShader}_prepareRessources(){this._lineShader||(this._lineShader=hu._GetShader(this._source.getScene()))}_rebuild(){let e=this._buffers[y.PositionKind];e&&e._rebuild(),e=this._buffers[y.NormalKind],e&&e._rebuild();const i=this._source.getScene().getEngine();this._ib=i.createIndexBuffer(this._linesIndices)}dispose(){var e;this._source.onRebuildObservable.remove(this._meshRebuildObserver),this._source.onDisposeObservable.remove(this._meshDisposeObserver);let t=this._buffers[y.PositionKind];t&&(t.dispose(),this._buffers[y.PositionKind]=null),t=this._buffers[y.NormalKind],t&&(t.dispose(),this._buffers[y.NormalKind]=null),this._ib&&this._source.getScene().getEngine()._releaseBuffer(this._ib),this._lineShader.dispose(),(e=this._drawWrapper)===null||e===void 0||e.dispose()}_processEdgeForAdjacencies(e,t,i,s,r){return e===i&&t===s||e===s&&t===i?0:e===s&&t===r||e===r&&t===s?1:e===r&&t===i||e===i&&t===r?2:-1}_processEdgeForAdjacenciesWithVertices(e,t,i,s,r){return e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(s,1e-10)||e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(i,1e-10)?0:e.equalsWithEpsilon(s,1e-10)&&t.equalsWithEpsilon(r,1e-10)||e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(s,1e-10)?1:e.equalsWithEpsilon(r,1e-10)&&t.equalsWithEpsilon(i,1e-10)||e.equalsWithEpsilon(i,1e-10)&&t.equalsWithEpsilon(r,1e-10)?2:-1}_checkEdge(e,t,i,s,r){let n;t===void 0?n=!0:n=g.Dot(i[e],i[t])<this._epsilon,n&&this.createLine(s,r,this._linesPositions.length/3)}createLine(e,t,i){this._linesPositions.push(e.x,e.y,e.z,e.x,e.y,e.z,t.x,t.y,t.z,t.x,t.y,t.z),this._linesNormals.push(t.x,t.y,t.z,-1,t.x,t.y,t.z,1,e.x,e.y,e.z,-1,e.x,e.y,e.z,1),this._linesIndices.push(i,i+1,i+2,i,i+2,i+3)}_tessellateTriangle(e,t,i,s){const r=(M,D,P)=>{P>=0&&D.push(P);for(let O=0;O<M.length;++O)D.push(M[O][0])};let n=0;e[1].length>=e[0].length&&e[1].length>=e[2].length?n=1:e[2].length>=e[0].length&&e[2].length>=e[1].length&&(n=2);for(let M=0;M<3;++M)M===n?e[M].sort((D,P)=>D[1]<P[1]?-1:D[1]>P[1]?1:0):e[M].sort((D,P)=>D[1]>P[1]?-1:D[1]<P[1]?1:0);const o=[],l=[];r(e[n],o,-1);const h=o.length;for(let M=n+2;M>=n+1;--M)r(e[M%3],l,M!==n+2?s[i[t+(M+1)%3]]:-1);const c=l.length,u=0,d=0;i.push(s[i[t+n]],o[0],l[0]),i.push(s[i[t+(n+1)%3]],l[c-1],o[h-1]);const f=h<=c,p=f?h:c,_=f?c:h,m=f?h-1:c-1,v=f?0:1;let x=h+c-2,b=f?u:d,S=f?d:u;const C=f?o:l,E=f?l:o;let A=0;for(;x-- >0;){v?i.push(C[b],E[S]):i.push(E[S],C[b]),A+=p;let M;A>=_&&b<m?(M=C[++b],A-=_):M=E[++S],i.push(M)}i[t+0]=i[i.length-3],i[t+1]=i[i.length-2],i[t+2]=i[i.length-1],i.length=i.length-3}_generateEdgesLinesAlternate(){var e,t,i,s,r,n,o,l,h,c;const u=this._source.getVerticesData(y.PositionKind);let d=this._source.getIndices();if(!d||!u)return;Array.isArray(d)||(d=Array.from(d));const f=(t=(e=this._options)===null||e===void 0?void 0:e.useFastVertexMerger)!==null&&t!==void 0?t:!0,p=f?Math.round(-Math.log((s=(i=this._options)===null||i===void 0?void 0:i.epsilonVertexMerge)!==null&&s!==void 0?s:1e-6)/Math.log(10)):(n=(r=this._options)===null||r===void 0?void 0:r.epsilonVertexMerge)!==null&&n!==void 0?n:1e-6,_=[],m=[];if(f){const b={};for(let S=0;S<u.length;S+=3){const C=u[S+0],E=u[S+1],A=u[S+2],M=C.toFixed(p)+"|"+E.toFixed(p)+"|"+A.toFixed(p);if(b[M]!==void 0)_.push(b[M]);else{const D=S/3;b[M]=D,_.push(D),m.push(D)}}}else for(let b=0;b<u.length;b+=3){const S=u[b+0],C=u[b+1],E=u[b+2];let A=!1;for(let M=0;M<b&&!A;M+=3){const D=u[M+0],P=u[M+1],O=u[M+2];if(Math.abs(S-D)<p&&Math.abs(C-P)<p&&Math.abs(E-O)<p){_.push(M/3),A=!0;break}}A||(_.push(b/3),m.push(b/3))}if(!((o=this._options)===null||o===void 0)&&o.applyTessellation){const b=(h=(l=this._options)===null||l===void 0?void 0:l.epsilonVertexAligned)!==null&&h!==void 0?h:1e-6,S=[];for(let C=0;C<d.length;C+=3){let E;for(let A=0;A<3;++A){const M=_[d[C+A]],D=_[d[C+(A+1)%3]],P=_[d[C+(A+2)%3]];if(M===D)continue;const O=u[M*3+0],N=u[M*3+1],$=u[M*3+2],W=u[D*3+0],K=u[D*3+1],te=u[D*3+2],ve=Math.sqrt((W-O)*(W-O)+(K-N)*(K-N)+(te-$)*(te-$));for(let _e=0;_e<m.length-1;_e++){const j=m[_e];if(j===M||j===D||j===P)continue;const ee=u[j*3+0],F=u[j*3+1],z=u[j*3+2],Z=Math.sqrt((ee-O)*(ee-O)+(F-N)*(F-N)+(z-$)*(z-$)),Ee=Math.sqrt((ee-W)*(ee-W)+(F-K)*(F-K)+(z-te)*(z-te));Math.abs(Z+Ee-ve)<b&&(E||(E={index:C,edgesPoints:[[],[],[]]},S.push(E)),E.edgesPoints[A].push([j,Z]))}}}for(let C=0;C<S.length;++C){const E=S[C];this._tessellateTriangle(E.edgesPoints,E.index,d,_)}S.length=0}const v={};for(let b=0;b<d.length;b+=3){let S;for(let C=0;C<3;++C){let E=_[d[b+C]],A=_[d[b+(C+1)%3]];const M=_[d[b+(C+2)%3]];if(E===A||(E===M||A===M)&&((c=this._options)===null||c===void 0?void 0:c.removeDegeneratedTriangles))continue;if(G.Vector3[0].copyFromFloats(u[E*3+0],u[E*3+1],u[E*3+2]),G.Vector3[1].copyFromFloats(u[A*3+0],u[A*3+1],u[A*3+2]),G.Vector3[2].copyFromFloats(u[M*3+0],u[M*3+1],u[M*3+2]),S||(G.Vector3[1].subtractToRef(G.Vector3[0],G.Vector3[3]),G.Vector3[2].subtractToRef(G.Vector3[1],G.Vector3[4]),S=g.Cross(G.Vector3[3],G.Vector3[4]),S.normalize()),E>A){const O=E;E=A,A=O}const D=E+"_"+A,P=v[D];P?P.done||(g.Dot(S,P.normal)<this._epsilon&&this.createLine(G.Vector3[0],G.Vector3[1],this._linesPositions.length/3),P.done=!0):v[D]={normal:S,done:!1,index:b,i:C}}}for(const b in v){const S=v[b];if(!S.done){const C=_[d[S.index+S.i]],E=_[d[S.index+(S.i+1)%3]];G.Vector3[0].copyFromFloats(u[C*3+0],u[C*3+1],u[C*3+2]),G.Vector3[1].copyFromFloats(u[E*3+0],u[E*3+1],u[E*3+2]),this.createLine(G.Vector3[0],G.Vector3[1],this._linesPositions.length/3)}}const x=this._source.getScene().getEngine();this._buffers[y.PositionKind]=new y(x,this._linesPositions,y.PositionKind,!1),this._buffers[y.NormalKind]=new y(x,this._linesNormals,y.NormalKind,!1,!1,4),this._buffersForInstances[y.PositionKind]=this._buffers[y.PositionKind],this._buffersForInstances[y.NormalKind]=this._buffers[y.NormalKind],this._ib=x.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}_generateEdgesLines(){const e=this._source.getVerticesData(y.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=new Array,s=new Array;let r,n;for(r=0;r<t.length;r+=3){n=new J2;const l=t[r],h=t[r+1],c=t[r+2];n.p0=new g(e[l*3],e[l*3+1],e[l*3+2]),n.p1=new g(e[h*3],e[h*3+1],e[h*3+2]),n.p2=new g(e[c*3],e[c*3+1],e[c*3+2]);const u=g.Cross(n.p1.subtract(n.p0),n.p2.subtract(n.p1));u.normalize(),s.push(u),i.push(n)}for(r=0;r<i.length;r++){n=i[r];for(let l=r+1;l<i.length;l++){const h=i[l];if(n.edgesConnectedCount===3)break;if(h.edgesConnectedCount===3)continue;const c=t[l*3],u=t[l*3+1],d=t[l*3+2];for(let f=0;f<3;f++){let p=0;if(n.edges[f]===void 0){switch(f){case 0:this._checkVerticesInsteadOfIndices?p=this._processEdgeForAdjacenciesWithVertices(n.p0,n.p1,h.p0,h.p1,h.p2):p=this._processEdgeForAdjacencies(t[r*3],t[r*3+1],c,u,d);break;case 1:this._checkVerticesInsteadOfIndices?p=this._processEdgeForAdjacenciesWithVertices(n.p1,n.p2,h.p0,h.p1,h.p2):p=this._processEdgeForAdjacencies(t[r*3+1],t[r*3+2],c,u,d);break;case 2:this._checkVerticesInsteadOfIndices?p=this._processEdgeForAdjacenciesWithVertices(n.p2,n.p0,h.p0,h.p1,h.p2):p=this._processEdgeForAdjacencies(t[r*3+2],t[r*3],c,u,d);break}if(p!==-1&&(n.edges[f]=l,h.edges[p]=r,n.edgesConnectedCount++,h.edgesConnectedCount++,n.edgesConnectedCount===3))break}}}}for(r=0;r<i.length;r++){const l=i[r];this._checkEdge(r,l.edges[0],s,l.p0,l.p1),this._checkEdge(r,l.edges[1],s,l.p1,l.p2),this._checkEdge(r,l.edges[2],s,l.p2,l.p0)}const o=this._source.getScene().getEngine();this._buffers[y.PositionKind]=new y(o,this._linesPositions,y.PositionKind,!1),this._buffers[y.NormalKind]=new y(o,this._linesNormals,y.NormalKind,!1,!1,4),this._buffersForInstances[y.PositionKind]=this._buffers[y.PositionKind],this._buffersForInstances[y.NormalKind]=this._buffers[y.NormalKind],this._ib=o.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}isReady(){return this._lineShader.isReady(this._source,this._source.hasInstances&&this.customInstances.length>0||this._source.hasThinInstances)}render(){const e=this._source.getScene(),t=this._lineShader._getDrawWrapper();if(this._drawWrapper&&this._lineShader._setDrawWrapper(this._drawWrapper),!this.isReady()||!e.activeCamera){this._lineShader._setDrawWrapper(t);return}const i=this._source.hasInstances&&this.customInstances.length>0,s=i||this._source.hasThinInstances;let r=0;if(s)if(this._buffersForInstances.world0=this._source.getVertexBuffer("world0"),this._buffersForInstances.world1=this._source.getVertexBuffer("world1"),this._buffersForInstances.world2=this._source.getVertexBuffer("world2"),this._buffersForInstances.world3=this._source.getVertexBuffer("world3"),i){const o=this._source._instanceDataStorage;if(r=this.customInstances.length,!o.instancesData){this._source.getScene()._activeMeshesFrozen||this.customInstances.reset();return}if(!o.isFrozen){let l=0;for(let h=0;h<r;++h)this.customInstances.data[h].copyToArray(o.instancesData,l),l+=16;o.instancesBuffer.updateDirectly(o.instancesData,0,r)}}else r=this._source.thinInstanceCount;const n=e.getEngine();this._lineShader._preBind(),this._source.edgesColor.a!==1?n.setAlphaMode(2):n.setAlphaMode(0),n.bindBuffers(s?this._buffersForInstances:this._buffers,this._ib,this._lineShader.getEffect()),e.resetCachedMaterial(),this._lineShader.setColor4("color",this._source.edgesColor),e.activeCamera.mode===be.ORTHOGRAPHIC_CAMERA?this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForOrthographic):this._lineShader.setFloat("width",this._source.edgesWidth/this.edgesWidthScalerForPerspective),this._lineShader.setFloat("aspectRatio",n.getAspectRatio(e.activeCamera)),this._lineShader.bind(this._source.getWorldMatrix()),n.drawElementsType(ne.TriangleFillMode,0,this._indicesCount,r),this._lineShader.unbind(),s&&n.unbindInstanceAttributes(),this._source.getScene()._activeMeshesFrozen||this.customInstances.reset(),this._lineShader._setDrawWrapper(t)}}class eM extends hu{constructor(e,t=.95,i=!1){super(e,t,i,!1),this._generateEdgesLines()}_generateEdgesLines(){const e=this._source.getVerticesData(y.PositionKind),t=this._source.getIndices();if(!t||!e)return;const i=G.Vector3[0],s=G.Vector3[1],r=t.length-1;for(let o=0,l=0;o<r;o+=2,l+=4)g.FromArrayToRef(e,3*t[o],i),g.FromArrayToRef(e,3*t[o+1],s),this.createLine(i,s,l);const n=this._source.getScene().getEngine();this._buffers[y.PositionKind]=new y(n,this._linesPositions,y.PositionKind,!1),this._buffers[y.NormalKind]=new y(n,this._linesNormals,y.NormalKind,!1,!1,4),this._ib=n.createIndexBuffer(this._linesIndices),this._indicesCount=this._linesIndices.length}}class tM extends Sa{constructor(e,t,i,s,r,n){super(e,i,s,r,n),this._beforeCompositionPostProcesses=[],this._internalTextureDirty=!1,this.enabled=!1,this.renderTargetTexture=null,this.renderTargetTexture=t}_createCompositionEffect(){this.imageProcessingPostProcess=new kc("prePassComposition",1,null,void 0,this._engine),this.imageProcessingPostProcess._updateParameters()}_checkSize(){const e=this._engine.getRenderWidth(!0),t=this._engine.getRenderHeight(!0),i=this.getRenderWidth(),s=this.getRenderHeight();(i!==e||s!==t)&&(this.resize({width:e,height:t}),this._internalTextureDirty=!0)}updateCount(e,t,i){super.updateCount(e,t,i),this._internalTextureDirty=!0}_resetPostProcessChain(){this._beforeCompositionPostProcesses.length=0}dispose(){const e=this._scene;if(super.dispose(),e&&e.prePassRenderer){const t=e.prePassRenderer.renderTargets.indexOf(this);t!==-1&&e.prePassRenderer.renderTargets.splice(t,1)}this.imageProcessingPostProcess&&this.imageProcessingPostProcess.dispose(),this.renderTargetTexture&&(this.renderTargetTexture._prePassRenderTarget=null),this._outputPostProcess&&(this._outputPostProcess.autoClear=!0,this._outputPostProcess.restoreDefaultInputTexture())}}class pr{constructor(e){this.excludedSkinnedMesh=[],this.excludedMaterials=[],this.mrtCount=0,this._mrtFormats=[],this._mrtLayout=[],this._mrtNames=[],this._textureIndices=[],this._isDirty=!0,this._effectConfigurations=[],this.doNotUseGeometryRendererFallback=!0,this.renderTargets=[],this._clearColor=new J(0,0,0,0),this._enabled=!1,this._needsCompositionForThisPass=!1,this.disableGammaTransform=!1,this._scene=e,this._engine=e.getEngine(),pr._SceneComponentInitialization(this._scene),this.defaultRT=this._createRenderTarget("sceneprePassRT",null),this._currentTarget=this.defaultRT}getIndex(e){return this._textureIndices[e]}get samples(){return this.defaultRT.samples}set samples(e){this.defaultRT.samples=e}getRenderTarget(){return this._currentTarget}_setRenderTarget(e){e?this._currentTarget=e:(this._currentTarget=this.defaultRT,this._engine.currentRenderPassId=this._currentTarget.renderPassId)}get currentRTisSceneRT(){return this._currentTarget===this.defaultRT}_refreshGeometryBufferRendererLink(){if(this.doNotUseGeometryRendererFallback)this._geometryBuffer&&this._geometryBuffer._unlinkPrePassRenderer(),this._geometryBuffer=null,this._scene.disableGeometryBufferRenderer();else{if(this._geometryBuffer=this._scene.enableGeometryBufferRenderer(),!this._geometryBuffer){this.doNotUseGeometryRendererFallback=!0;return}this._geometryBuffer._linkPrePassRenderer(this)}}get enabled(){return this._enabled}_createRenderTarget(e,t){const i=new tM(e,t,{width:this._engine.getRenderWidth(),height:this._engine.getRenderHeight()},0,this._scene,{generateMipMaps:!1,generateStencilBuffer:this._engine.isStencilEnable,defaultType:0,types:[],drawOnlyOnFirstAttachmentByDefault:!0});return this.renderTargets.push(i),i}get isSupported(){return this._scene.getEngine().getCaps().drawBuffersExtension}bindAttachmentsForEffect(e,t){const i=t.getMaterial(),s=i&&i.isPrePassCapable,r=i&&this.excludedMaterials.indexOf(i)!==-1;this.enabled&&this._currentTarget.enabled&&(e._multiTarget&&s&&!r?this._engine.bindAttachments(this._multiRenderAttachments):(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment(),this._geometryBuffer&&this.currentRTisSceneRT&&!r&&this._geometryBuffer.renderList.push(t.getRenderingMesh())))}_reinitializeAttachments(){const e=[],t=[!1],i=[!0];for(let s=0;s<this.mrtCount;s++)e.push(!0),s>0&&(t.push(!0),i.push(!1));this._multiRenderAttachments=this._engine.buildTextureLayout(e),this._clearAttachments=this._engine.buildTextureLayout(t),this._defaultAttachments=this._engine.buildTextureLayout(i)}_resetLayout(){for(let e=0;e<pr._TextureFormats.length;e++)this._textureIndices[pr._TextureFormats[e].type]=-1;this._textureIndices[4]=0,this._mrtLayout=[4],this._mrtFormats=[pr._TextureFormats[4].format],this._mrtNames=[pr._TextureFormats[4].name],this.mrtCount=1}_updateGeometryBufferLayout(){if(this._refreshGeometryBufferRendererLink(),this._geometryBuffer){this._geometryBuffer._resetLayout();const e=[];for(let i=0;i<this._mrtLayout.length;i++)e.push(!1);this._geometryBuffer._linkInternalTexture(this.defaultRT.getInternalTexture());const t=[{prePassConstant:5,geometryBufferConstant:ei.DEPTH_TEXTURE_TYPE},{prePassConstant:6,geometryBufferConstant:ei.NORMAL_TEXTURE_TYPE},{prePassConstant:1,geometryBufferConstant:ei.POSITION_TEXTURE_TYPE},{prePassConstant:3,geometryBufferConstant:ei.REFLECTIVITY_TEXTURE_TYPE},{prePassConstant:2,geometryBufferConstant:ei.VELOCITY_TEXTURE_TYPE}];for(let i=0;i<t.length;i++){const s=this._mrtLayout.indexOf(t[i].prePassConstant);s!==-1&&(this._geometryBuffer._forceTextureType(t[i].geometryBufferConstant,s),e[s]=!0)}this._geometryBuffer._setAttachments(this._engine.buildTextureLayout(e))}}restoreAttachments(){this.enabled&&this._currentTarget.enabled&&this._defaultAttachments&&(this._engine._currentRenderTarget?this._engine.bindAttachments(this._defaultAttachments):this._engine.restoreSingleAttachment())}_beforeDraw(e,t,i){this._isDirty&&this._update(),!(!this._enabled||!this._currentTarget.enabled)&&(this._geometryBuffer&&(this._geometryBuffer.renderList=[]),this._setupOutputForThisPass(this._currentTarget,e))}_prepareFrame(e,t,i){e.renderTargetTexture?e.renderTargetTexture._prepareFrame(this._scene,t,i,e.renderTargetTexture.useCameraPostProcesses):this._postProcessesSourceForThisPass.length?this._scene.postProcessManager._prepareFrame():this._engine.restoreDefaultFramebuffer()}setCustomOutput(e){const t=this._postProcessesSourceForThisPass[0];return t?(t.inputTexture=e.renderTarget,!0):!1}_renderPostProcesses(e,t){var i;const s=this._postProcessesSourceForThisPass[0],r=s?s.inputTexture:e.renderTargetTexture?e.renderTargetTexture.renderTarget:null;let n=this._currentTarget._beforeCompositionPostProcesses;this._needsCompositionForThisPass&&(n=n.concat([this._currentTarget.imageProcessingPostProcess])),n.length&&(this._scene.postProcessManager._prepareFrame((i=this._currentTarget.renderTarget)===null||i===void 0?void 0:i.texture,n),this._scene.postProcessManager.directRender(n,r,!1,t))}_afterDraw(e,t){this._enabled&&this._currentTarget.enabled&&(this._prepareFrame(this._currentTarget,e,t),this._renderPostProcesses(this._currentTarget,e))}_clear(){this._enabled&&this._currentTarget.enabled&&(this._bindFrameBuffer(this._currentTarget),this._engine.bindAttachments(this._clearAttachments),this._engine.clear(this._clearColor,!0,!1,!1),this._engine.bindAttachments(this._defaultAttachments))}_bindFrameBuffer(e){if(this._enabled&&this._currentTarget.enabled){this._currentTarget._checkSize();const t=this._currentTarget.renderTarget;t&&this._engine.bindFramebuffer(t)}}_setEnabled(e){this._enabled=e}_setRenderTargetEnabled(e,t){e.enabled=t,t||this._unlinkInternalTexture(e)}addEffectConfiguration(e){for(let t=0;t<this._effectConfigurations.length;t++)if(this._effectConfigurations[t].name===e.name)return this._effectConfigurations[t];return this._effectConfigurations.push(e),e}_enable(){const e=this.mrtCount;for(let t=0;t<this._effectConfigurations.length;t++)this._effectConfigurations[t].enabled&&this._enableTextures(this._effectConfigurations[t].texturesRequired);for(let t=0;t<this.renderTargets.length;t++){(this.mrtCount!==e||this.renderTargets[t].count!==this.mrtCount)&&this.renderTargets[t].updateCount(this.mrtCount,{types:this._mrtFormats},this._mrtNames.concat("prePass_DepthBuffer")),this.renderTargets[t]._resetPostProcessChain();for(let i=0;i<this._effectConfigurations.length;i++)this._effectConfigurations[i].enabled&&(!this._effectConfigurations[i].postProcess&&this._effectConfigurations[i].createPostProcess&&this._effectConfigurations[i].createPostProcess(),this._effectConfigurations[i].postProcess&&this.renderTargets[t]._beforeCompositionPostProcesses.push(this._effectConfigurations[i].postProcess))}this._reinitializeAttachments(),this._setEnabled(!0),this._updateGeometryBufferLayout()}_disable(){this._setEnabled(!1);for(let e=0;e<this.renderTargets.length;e++)this._setRenderTargetEnabled(this.renderTargets[e],!1);this._resetLayout();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].enabled=!1}_getPostProcessesSource(e,t){if(t)return t._postProcesses;if(e.renderTargetTexture)if(e.renderTargetTexture.useCameraPostProcesses){const i=e.renderTargetTexture.activeCamera?e.renderTargetTexture.activeCamera:this._scene.activeCamera;return i?i._postProcesses:[]}else return e.renderTargetTexture.postProcesses?e.renderTargetTexture.postProcesses:[];else return this._scene.activeCamera?this._scene.activeCamera._postProcesses:[]}_setupOutputForThisPass(e,t){const i=t&&this._scene.activeCameras&&!!this._scene.activeCameras.length&&this._scene.activeCameras.indexOf(t)!==0;this._postProcessesSourceForThisPass=this._getPostProcessesSource(e,t),this._postProcessesSourceForThisPass=this._postProcessesSourceForThisPass.filter(l=>l!=null),this._scene.autoClear=!0;const s=this._hasImageProcessing(this._postProcessesSourceForThisPass);this._needsCompositionForThisPass=!s&&!this.disableGammaTransform&&this._needsImageProcessing()&&!i;const r=this._getFirstPostProcess(this._postProcessesSourceForThisPass),n=e._beforeCompositionPostProcesses&&e._beforeCompositionPostProcesses[0];let o=null;this._scene.imageProcessingConfiguration.applyByPostProcess=this._needsCompositionForThisPass||s,this._needsCompositionForThisPass&&!e.imageProcessingPostProcess&&e._createCompositionEffect(),n?o=n:this._needsCompositionForThisPass?o=e.imageProcessingPostProcess:r&&(o=r),this._bindFrameBuffer(e),this._linkInternalTexture(e,o)}_linkInternalTexture(e,t){t&&(t.autoClear=!1,t.inputTexture=e.renderTarget),e._outputPostProcess!==t&&(e._outputPostProcess&&this._unlinkInternalTexture(e),e._outputPostProcess=t),e._internalTextureDirty&&(this._updateGeometryBufferLayout(),e._internalTextureDirty=!1)}_unlinkInternalTexture(e){e._outputPostProcess&&(e._outputPostProcess.autoClear=!0,e._outputPostProcess.restoreDefaultInputTexture(),e._outputPostProcess=null)}_needsImageProcessing(){for(let e=0;e<this._effectConfigurations.length;e++)if(this._effectConfigurations[e].enabled&&this._effectConfigurations[e].needsImageProcessing)return!0;return!1}_hasImageProcessing(e){var t;let i=!1;if(e){for(let s=0;s<e.length;s++)if(((t=e[s])===null||t===void 0?void 0:t.getClassName())==="ImageProcessingPostProcess"){i=!0;break}}return i}_getFirstPostProcess(e){for(let t=0;t<e.length;t++)if(e[t]!==null)return e[t];return null}markAsDirty(){this._isDirty=!0}_enableTextures(e){this._scene.needsPreviousWorldMatrices=!1;for(let t=0;t<e.length;t++){const i=e[t];this._textureIndices[i]===-1&&(this._textureIndices[i]=this._mrtLayout.length,this._mrtLayout.push(i),this._mrtFormats.push(pr._TextureFormats[i].format),this._mrtNames.push(pr._TextureFormats[i].name),this.mrtCount++),i===2&&(this._scene.needsPreviousWorldMatrices=!0)}}_update(){this._disable();let e=!1;this._scene.imageProcessingConfiguration.applyByPostProcess=!1,this._scene._depthPeelingRenderer&&this._scene.useOrderIndependentTransparency&&(this._scene._depthPeelingRenderer.setPrePassRenderer(this),e=!0);for(let i=0;i<this._scene.materials.length;i++)this._scene.materials[i].setPrePassRenderer(this)&&(e=!0);e&&this._setRenderTargetEnabled(this.defaultRT,!0);let t;for(let i=0;i<this.renderTargets.length;i++){if(this.renderTargets[i].renderTargetTexture)t=this._getPostProcessesSource(this.renderTargets[i]);else{const s=this._scene.activeCamera;if(!s)continue;t=s._postProcesses}if(!!t&&(t=t.filter(s=>s!=null),t)){for(let s=0;s<t.length;s++)t[s].setPrePassRenderer(this)&&(this._setRenderTargetEnabled(this.renderTargets[i],!0),e=!0);this._hasImageProcessing(t)&&(this._scene.imageProcessingConfiguration.applyByPostProcess=!0)}}this._markAllMaterialsAsPrePassDirty(),this._isDirty=!1,e&&this._enable()}_markAllMaterialsAsPrePassDirty(){const e=this._scene.materials;for(let t=0;t<e.length;t++)e[t].markAsDirty(ne.PrePassDirtyFlag)}dispose(){for(let e=this.renderTargets.length-1;e>=0;e--)this.renderTargets[e].dispose();for(let e=0;e<this._effectConfigurations.length;e++)this._effectConfigurations[e].dispose&&this._effectConfigurations[e].dispose()}}pr._SceneComponentInitialization=a=>{throw Ve("PrePassRendererSceneComponent")};pr._TextureFormats=[{type:0,format:2,name:"prePass_Irradiance"},{type:1,format:2,name:"prePass_Position"},{type:2,format:0,name:"prePass_Velocity"},{type:3,format:0,name:"prePass_Reflectivity"},{type:4,format:2,name:"prePass_Color"},{type:5,format:2,name:"prePass_Depth"},{type:6,format:2,name:"prePass_Normal"},{type:7,format:0,name:"prePass_Albedo"}];Object.defineProperty(ge.prototype,"prePassRenderer",{get:function(){return this._prePassRenderer},set:function(a){a&&a.isSupported&&(this._prePassRenderer=a)},enumerable:!0,configurable:!0});ge.prototype.enablePrePassRenderer=function(){return this._prePassRenderer?this._prePassRenderer:(this._prePassRenderer=new pr(this),this._prePassRenderer.isSupported||(this._prePassRenderer=null,B.Error(`PrePassRenderer needs WebGL 2 support.
Maybe you tried to use the following features that need the PrePassRenderer :
 + Subsurface Scattering`)),this._prePassRenderer)};ge.prototype.disablePrePassRenderer=function(){!this._prePassRenderer||(this._prePassRenderer.dispose(),this._prePassRenderer=null)};class iM{constructor(e){this.name=ue.NAME_PREPASSRENDERER,this.scene=e}register(){this.scene._beforeCameraDrawStage.registerStep(ue.STEP_BEFORECAMERADRAW_PREPASS,this,this._beforeCameraDraw),this.scene._afterCameraDrawStage.registerStep(ue.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterCameraDraw),this.scene._beforeRenderTargetDrawStage.registerStep(ue.STEP_BEFORERENDERTARGETDRAW_PREPASS,this,this._beforeRenderTargetDraw),this.scene._afterRenderTargetDrawStage.registerStep(ue.STEP_AFTERCAMERADRAW_PREPASS,this,this._afterRenderTargetDraw),this.scene._beforeClearStage.registerStep(ue.STEP_BEFORECLEAR_PREPASS,this,this._beforeClearStage),this.scene._beforeRenderTargetClearStage.registerStep(ue.STEP_BEFORERENDERTARGETCLEAR_PREPASS,this,this._beforeRenderTargetClearStage),this.scene._beforeRenderingMeshStage.registerStep(ue.STEP_BEFORERENDERINGMESH_PREPASS,this,this._beforeRenderingMeshStage),this.scene._afterRenderingMeshStage.registerStep(ue.STEP_AFTERRENDERINGMESH_PREPASS,this,this._afterRenderingMeshStage)}_beforeRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._beforeDraw(void 0,t,i))}_afterRenderTargetDraw(e,t,i){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw(t,i)}_beforeRenderTargetClearStage(e){this.scene.prePassRenderer&&(e._prePassRenderTarget||(e._prePassRenderTarget=this.scene.prePassRenderer._createRenderTarget(e.name+"_prePassRTT",e)),this.scene.prePassRenderer._setRenderTarget(e._prePassRenderTarget),this.scene.prePassRenderer._clear())}_beforeCameraDraw(e){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._beforeDraw(e))}_afterCameraDraw(){this.scene.prePassRenderer&&this.scene.prePassRenderer._afterDraw()}_beforeClearStage(){this.scene.prePassRenderer&&(this.scene.prePassRenderer._setRenderTarget(null),this.scene.prePassRenderer._clear())}_beforeRenderingMeshStage(e,t,i,s){if(!s)return;const r=e.getScene();r.prePassRenderer&&r.prePassRenderer.bindAttachmentsForEffect(s,t)}_afterRenderingMeshStage(e){const t=e.getScene();t.prePassRenderer&&t.prePassRenderer.restoreAttachments()}rebuild(){this.scene.disablePrePassRenderer(),this.scene.enablePrePassRenderer()}dispose(){this.scene.disablePrePassRenderer()}}pr._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_PREPASSRENDERER);e||(e=new iM(a),a._addComponent(e))};const sM="fibonacci",rM=`#define rcp(x) 1./x
#define GOLDEN_RATIO 1.618033988749895
#define TWO_PI 6.2831855
vec2 Golden2dSeq(int i,float n)
{
return vec2(float(i)/n+(0.5/n),fract(float(i)*rcp(GOLDEN_RATIO)));
}
vec2 SampleDiskGolden(int i,int sampleCount)
{
vec2 f=Golden2dSeq(i,float(sampleCount));
return vec2(sqrt(f.x),TWO_PI*f.y);
}`;Y.IncludesShadersStore[sM]=rM;const nM="diffusionProfile",aM=`uniform vec3 diffusionS[5];
uniform float diffusionD[5];
uniform float filterRadii[5];`;Y.IncludesShadersStore[nM]=aM;const oM="subSurfaceScatteringPixelShader",lM=`#include<fibonacci>
#include<helperFunctions>
#include<subSurfaceScatteringFunctions>
#include<diffusionProfile>
varying vec2 vUV;
uniform vec2 texelSize;
uniform sampler2D textureSampler;
uniform sampler2D irradianceSampler;
uniform sampler2D depthSampler;
uniform sampler2D albedoSampler;
uniform vec2 viewportSize;
uniform float metersPerUnit;
const float LOG2_E=1.4426950408889634;
const float SSS_PIXELS_PER_SAMPLE=4.;
const int _SssSampleBudget=40;
#define rcp(x) 1./x
#define Sq(x) x*x
#define SSS_BILATERAL_FILTER true
vec3 EvalBurleyDiffusionProfile(float r,vec3 S)
{
vec3 exp_13=exp2(((LOG2_E*(-1.0/3.0))*r)*S); 
vec3 expSum=exp_13*(1.+exp_13*exp_13); 
return (S*rcp(8.*PI))*expSum; 
}
vec2 SampleBurleyDiffusionProfile(float u,float rcpS)
{
u=1.-u; 
float g=1.+(4.*u)*(2.*u+sqrt(1.+(4.*u)*u));
float n=exp2(log2(g)*(-1.0/3.0)); 
float p=(g*n)*n; 
float c=1.+p+n; 
float d=(3./LOG2_E*2.)+(3./LOG2_E)*log2(u); 
float x=(3./LOG2_E)*log2(c)-d; 
float rcpExp=((c*c)*c)*rcp((4.*u)*((c*c)+(4.*u)*(4.*u)));
float r=x*rcpS;
float rcpPdf=(8.*PI*rcpS)*rcpExp; 
return vec2(r,rcpPdf);
}
vec3 ComputeBilateralWeight(float xy2,float z,float mmPerUnit,vec3 S,float rcpPdf)
{
#ifndef SSS_BILATERAL_FILTER
z=0.;
#endif
float r=sqrt(xy2+(z*mmPerUnit)*(z*mmPerUnit));
float area=rcpPdf;
#if SSS_CLAMP_ARTIFACT
return clamp(EvalBurleyDiffusionProfile(r,S)*area,0.0,1.0);
#else
return EvalBurleyDiffusionProfile(r,S)*area;
#endif
}
void EvaluateSample(int i,int n,vec3 S,float d,vec3 centerPosVS,float mmPerUnit,float pixelsPerMm,
float phase,inout vec3 totalIrradiance,inout vec3 totalWeight)
{
float scale =rcp(float(n));
float offset=rcp(float(n))*0.5;
float sinPhase,cosPhase;
sinPhase=sin(phase);
cosPhase=cos(phase);
vec2 bdp=SampleBurleyDiffusionProfile(float(i)*scale+offset,d);
float r=bdp.x;
float rcpPdf=bdp.y;
float phi=SampleDiskGolden(i,n).y;
float sinPhi,cosPhi;
sinPhi=sin(phi);
cosPhi=cos(phi);
float sinPsi=cosPhase*sinPhi+sinPhase*cosPhi; 
float cosPsi=cosPhase*cosPhi-sinPhase*sinPhi; 
vec2 vec=r*vec2(cosPsi,sinPsi);
vec2 position; 
float xy2;
position=vUV+round((pixelsPerMm*r)*vec2(cosPsi,sinPsi))*texelSize;
xy2 =r*r;
vec4 textureSample=texture2D(irradianceSampler,position);
float viewZ=texture2D(depthSampler,position).r;
vec3 irradiance =textureSample.rgb;
if (testLightingForSSS(textureSample.a))
{
float relZ=viewZ-centerPosVS.z;
vec3 weight=ComputeBilateralWeight(xy2,relZ,mmPerUnit,S,rcpPdf);
totalIrradiance+=weight*irradiance;
totalWeight +=weight;
}
else
{
}
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) 
{
vec4 irradianceAndDiffusionProfile =texture2D(irradianceSampler,vUV);
vec3 centerIrradiance=irradianceAndDiffusionProfile.rgb;
int diffusionProfileIndex=int(round(irradianceAndDiffusionProfile.a*255.));
float centerDepth =0.;
vec4 inputColor=texture2D(textureSampler,vUV);
bool passedStencilTest=testLightingForSSS(irradianceAndDiffusionProfile.a);
if (passedStencilTest)
{
centerDepth=texture2D(depthSampler,vUV).r;
}
if (!passedStencilTest) { 
gl_FragColor=inputColor;
return;
}
float distScale =1.;
vec3 S =diffusionS[diffusionProfileIndex];
float d =diffusionD[diffusionProfileIndex];
float filterRadius=filterRadii[diffusionProfileIndex];
vec2 centerPosNDC=vUV;
vec2 cornerPosNDC=vUV+0.5*texelSize;
vec3 centerPosVS =vec3(centerPosNDC*viewportSize,1.0)*centerDepth; 
vec3 cornerPosVS =vec3(cornerPosNDC*viewportSize,1.0)*centerDepth; 
float mmPerUnit =1000.*(metersPerUnit*rcp(distScale));
float unitsPerMm=rcp(mmPerUnit);
float unitsPerPixel=2.*abs(cornerPosVS.x-centerPosVS.x);
float pixelsPerMm =rcp(unitsPerPixel)*unitsPerMm;
float filterArea =PI*Sq(filterRadius*pixelsPerMm);
int sampleCount =int(filterArea*rcp(SSS_PIXELS_PER_SAMPLE));
int sampleBudget=_SssSampleBudget;
int texturingMode=0;
vec3 albedo =texture2D(albedoSampler,vUV).rgb;
if (distScale==0. || sampleCount<1)
{
#ifdef DEBUG_SSS_SAMPLES
vec3 green=vec3(0.,1.,0.);
gl_FragColor=vec4(green,1.0);
return;
#endif
gl_FragColor=vec4(inputColor.rgb+albedo*centerIrradiance,1.0);
return;
}
#ifdef DEBUG_SSS_SAMPLES
vec3 red =vec3(1.,0.,0.);
vec3 blue=vec3(0.,0.,1.);
gl_FragColor=vec4(mix(blue,red,clamp(float(sampleCount)/float(sampleBudget),0.0,1.0)),1.0);
return;
#endif
float phase=0.;
int n=min(sampleCount,sampleBudget);
vec3 centerWeight =vec3(0.); 
vec3 totalIrradiance=vec3(0.);
vec3 totalWeight =vec3(0.);
for (int i=0; i<n; i++)
{
EvaluateSample(i,n,S,d,centerPosVS,mmPerUnit,pixelsPerMm,
phase,totalIrradiance,totalWeight);
}
totalWeight=max(totalWeight,HALF_MIN);
gl_FragColor=vec4(inputColor.rgb+albedo*max(totalIrradiance/totalWeight,vec3(0.0)),1.);
}`;Y.ShadersStore[oM]=lM;class hM extends Fe{getClassName(){return"SubSurfaceScatteringPostProcess"}constructor(e,t,i,s=null,r,n,o,l=0){super(e,"subSurfaceScattering",["texelSize","viewportSize","metersPerUnit"],["diffusionS","diffusionD","filterRadii","irradianceSampler","depthSampler","albedoSampler"],i,s,r||H.BILINEAR_SAMPLINGMODE,n,o,null,l,"postprocess",void 0,!0),this._scene=t,this.updateEffect(),this.onApplyObservable.add(h=>{if(!t.prePassRenderer||!t.subSurfaceConfiguration){B.Error("PrePass and subsurface configuration needs to be enabled for subsurface scattering.");return}const c=this.texelSize;h.setFloat("metersPerUnit",t.subSurfaceConfiguration.metersPerUnit),h.setFloat2("texelSize",c.x,c.y),h.setTexture("irradianceSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(0)]),h.setTexture("depthSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(5)]),h.setTexture("albedoSampler",t.prePassRenderer.getRenderTarget().textures[t.prePassRenderer.getIndex(7)]),h.setFloat2("viewportSize",Math.tan(t.activeCamera.fov/2)*t.getEngine().getAspectRatio(t.activeCamera,!0),Math.tan(t.activeCamera.fov/2)),h.setArray3("diffusionS",t.subSurfaceConfiguration.ssDiffusionS),h.setArray("diffusionD",t.subSurfaceConfiguration.ssDiffusionD),h.setArray("filterRadii",t.subSurfaceConfiguration.ssFilterRadii)})}}class nh{constructor(e){this._ssDiffusionS=[],this._ssFilterRadii=[],this._ssDiffusionD=[],this.enabled=!1,this.needsImageProcessing=!0,this.name=ue.NAME_SUBSURFACE,this.ssDiffusionProfileColors=[],this.metersPerUnit=1,this.texturesRequired=[5,7,4,0],this.addDiffusionProfile(new re(1,1,1)),this._scene=e,nh._SceneComponentInitialization(this._scene)}get ssDiffusionS(){return this._ssDiffusionS}get ssDiffusionD(){return this._ssDiffusionD}get ssFilterRadii(){return this._ssFilterRadii}addDiffusionProfile(e){if(this.ssDiffusionD.length>=5)return B.Error("You already reached the maximum number of diffusion profiles."),0;for(let t=0;t<this._ssDiffusionS.length/3;t++)if(this._ssDiffusionS[t*3]===e.r&&this._ssDiffusionS[t*3+1]===e.g&&this._ssDiffusionS[t*3+2]===e.b)return t;return this._ssDiffusionS.push(e.r,e.b,e.g),this._ssDiffusionD.push(Math.max(Math.max(e.r,e.b),e.g)),this._ssFilterRadii.push(this.getDiffusionProfileParameters(e)),this.ssDiffusionProfileColors.push(e),this._ssDiffusionD.length-1}createPostProcess(){return this.postProcess=new hM("subSurfaceScattering",this._scene,1,null,void 0,this._scene.getEngine()),this.postProcess.autoClear=!1,this.postProcess}clearAllDiffusionProfiles(){this._ssDiffusionD=[],this._ssDiffusionS=[],this._ssFilterRadii=[],this.ssDiffusionProfileColors=[]}dispose(){this.clearAllDiffusionProfiles(),this.postProcess&&this.postProcess.dispose()}getDiffusionProfileParameters(e){const i=Math.max(e.r,e.g,e.b);return this._sampleBurleyDiffusionProfile(.997,i)}_sampleBurleyDiffusionProfile(e,t){e=1-e;const i=1+4*e*(2*e+Math.sqrt(1+4*e*e)),s=Math.pow(i,-1/3),r=i*s*s,n=1+r+s;return 3*Math.log(n/(4*e))*t}}nh._SceneComponentInitialization=a=>{throw Ve("SubSurfaceSceneComponent")};li.AddParser(ue.NAME_SUBSURFACE,(a,e)=>{if(a.ssDiffusionProfileColors!==void 0&&a.ssDiffusionProfileColors!==null&&(e.enableSubSurfaceForPrePass(),e.subSurfaceConfiguration))for(let t=0,i=a.ssDiffusionProfileColors.length;t<i;t++){const s=a.ssDiffusionProfileColors[t];e.subSurfaceConfiguration.addDiffusionProfile(new re(s.r,s.g,s.b))}});Object.defineProperty(ge.prototype,"subSurfaceConfiguration",{get:function(){return this._subSurfaceConfiguration},set:function(a){a&&this.enablePrePassRenderer()&&(this._subSurfaceConfiguration=a)},enumerable:!0,configurable:!0});ge.prototype.enableSubSurfaceForPrePass=function(){if(this._subSurfaceConfiguration)return this._subSurfaceConfiguration;const a=this.enablePrePassRenderer();return a?(this._subSurfaceConfiguration=new nh(this),a.addEffectConfiguration(this._subSurfaceConfiguration),this._subSurfaceConfiguration):null};ge.prototype.disableSubSurfaceForPrePass=function(){!this._subSurfaceConfiguration||(this._subSurfaceConfiguration.dispose(),this._subSurfaceConfiguration=null)};class cM{constructor(e){this.name=ue.NAME_PREPASSRENDERER,this.scene=e}register(){}serialize(e){if(!this.scene.subSurfaceConfiguration)return;const t=this.scene.subSurfaceConfiguration.ssDiffusionProfileColors;e.ssDiffusionProfileColors=[];for(let i=0;i<t.length;i++)e.ssDiffusionProfileColors.push({r:t[i].r,g:t[i].g,b:t[i].b})}addFromContainer(){}removeFromContainer(){!this.scene.prePassRenderer||this.scene.subSurfaceConfiguration&&this.scene.subSurfaceConfiguration.clearAllDiffusionProfiles()}rebuild(){}dispose(){}}nh._SceneComponentInitialization=a=>{let e=a._getComponent(ue.NAME_SUBSURFACE);e||(e=new cM(a),a._addComponent(e))};const uM="outlinePixelShader",dM=`#ifdef LOGARITHMICDEPTH
#extension GL_EXT_frag_depth : enable
#endif
uniform vec4 color;
#ifdef ALPHATEST
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#endif
#include<clipPlaneFragmentDeclaration>
#include<logDepthDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
#include<clipPlaneFragment>
#ifdef ALPHATEST
if (texture2D(diffuseSampler,vUV).a<0.4)
discard;
#endif
#include<logDepthFragment>
gl_FragColor=color;
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[uM]=dM;const fM="outlineVertexShader",pM=`attribute vec3 position;
attribute vec3 normal;
#include<bonesDeclaration>
#include<bakedVertexAnimationDeclaration>
#include<morphTargetsVertexGlobalDeclaration>
#include<morphTargetsVertexDeclaration>[0..maxSimultaneousMorphTargets]
#include<clipPlaneVertexDeclaration>
uniform float offset;
#include<instancesDeclaration>
uniform mat4 viewProjection;
#ifdef ALPHATEST
varying vec2 vUV;
uniform mat4 diffuseMatrix;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#endif
#include<logDepthDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void)
{
vec3 positionUpdated=position;
vec3 normalUpdated=normal;
#ifdef UV1
vec2 uvUpdated=uv;
#endif
#include<morphTargetsVertexGlobal>
#include<morphTargetsVertex>[0..maxSimultaneousMorphTargets]
vec3 offsetPosition=positionUpdated+(normalUpdated*offset);
#include<instancesVertex>
#include<bonesVertex>
#include<bakedVertexAnimation>
vec4 worldPos=finalWorld*vec4(offsetPosition,1.0);
gl_Position=viewProjection*worldPos;
#ifdef ALPHATEST
#ifdef UV1
vUV=vec2(diffuseMatrix*vec4(uvUpdated,1.0,0.0));
#endif
#ifdef UV2
vUV=vec2(diffuseMatrix*vec4(uv2,1.0,0.0));
#endif
#endif
#include<clipPlaneVertex>
#include<logDepthVertex>
}
`;Y.ShadersStore[fM]=pM;ge.prototype.getOutlineRenderer=function(){return this._outlineRenderer||(this._outlineRenderer=new Bl(this)),this._outlineRenderer};Object.defineProperty(V.prototype,"renderOutline",{get:function(){return this._renderOutline},set:function(a){a&&this.getScene().getOutlineRenderer(),this._renderOutline=a},enumerable:!0,configurable:!0});Object.defineProperty(V.prototype,"renderOverlay",{get:function(){return this._renderOverlay},set:function(a){a&&this.getScene().getOutlineRenderer(),this._renderOverlay=a},enumerable:!0,configurable:!0});class Bl{constructor(e){this.name=ue.NAME_OUTLINERENDERER,this.zOffset=1,this.zOffsetUnits=4,this.scene=e,this._engine=e.getEngine(),this.scene._addComponent(this),this._passIdForDrawWrapper=[];for(let t=0;t<4;++t)this._passIdForDrawWrapper[t]=this._engine.createRenderPassId(`Outline Renderer (${t})`)}register(){this.scene._beforeRenderingMeshStage.registerStep(ue.STEP_BEFORERENDERINGMESH_OUTLINE,this,this._beforeRenderingMesh),this.scene._afterRenderingMeshStage.registerStep(ue.STEP_AFTERRENDERINGMESH_OUTLINE,this,this._afterRenderingMesh)}rebuild(){}dispose(){for(let e=0;e<this._passIdForDrawWrapper.length;++e)this._engine.releaseRenderPassId(this._passIdForDrawWrapper[e])}render(e,t,i=!1,s){s=s!=null?s:this._passIdForDrawWrapper[0];const r=this.scene,n=r.getEngine(),o=n.getCaps().instancedArrays&&(t.visibleInstances[e._id]!==null&&t.visibleInstances[e._id]!==void 0||e.getRenderingMesh().hasThinInstances);if(!this.isReady(e,o,s))return;const l=e.getMesh(),h=l._internalAbstractMeshDataInfo._actAsRegularMesh?l:null,c=e.getRenderingMesh(),u=h||c,d=e.getMaterial();if(!d||!r.activeCamera)return;const f=e._getDrawWrapper(s),p=Vi.GetEffect(f);if(n.enableEffect(f),d.useLogarithmicDepth&&p.setFloat("logarithmicDepthConstant",2/(Math.log(r.activeCamera.maxZ+1)/Math.LN2)),p.setFloat("offset",i?0:c.outlineWidth),p.setColor4("color",i?c.overlayColor:c.outlineColor,i?c.overlayAlpha:d.alpha),p.setMatrix("viewProjection",r.getTransformMatrix()),p.setMatrix("world",u.getWorldMatrix()),c.useBones&&c.computeBonesUsingShaders&&c.skeleton&&p.setMatrices("mBones",c.skeleton.getTransformMatrices(c)),c.morphTargetManager&&c.morphTargetManager.isUsingTextureForTargets&&c.morphTargetManager._bind(p),se.BindMorphTargetParameters(c,p),o||c._bind(e,p,d.fillMode),d&&d.needAlphaTesting()){const _=d.getAlphaTestTexture();_&&(p.setTexture("diffuseSampler",_),p.setMatrix("diffuseMatrix",_.getTextureMatrix()))}se.BindClipPlane(p,r),n.setZOffset(-this.zOffset),n.setZOffsetUnits(-this.zOffsetUnits),c._processRendering(u,e,p,d.fillMode,t,o,(_,m)=>{p.setMatrix("world",m)}),n.setZOffset(0),n.setZOffsetUnits(0)}isReady(e,t,i){i=i!=null?i:this._passIdForDrawWrapper[0];const s=[],r=[y.PositionKind,y.NormalKind],n=e.getMesh(),o=e.getMaterial(),l=n.getScene();o&&(o.needAlphaTesting()&&(s.push("#define ALPHATEST"),n.isVerticesDataPresent(y.UVKind)&&(r.push(y.UVKind),s.push("#define UV1")),n.isVerticesDataPresent(y.UV2Kind)&&(r.push(y.UV2Kind),s.push("#define UV2"))),o.useLogarithmicDepth&&s.push("#define LOGARITHMICDEPTH")),n.useBones&&n.computeBonesUsingShaders?(r.push(y.MatricesIndicesKind),r.push(y.MatricesWeightsKind),n.numBoneInfluencers>4&&(r.push(y.MatricesIndicesExtraKind),r.push(y.MatricesWeightsExtraKind)),s.push("#define NUM_BONE_INFLUENCERS "+n.numBoneInfluencers),s.push("#define BonesPerMesh "+(n.skeleton?n.skeleton.bones.length+1:0))):s.push("#define NUM_BONE_INFLUENCERS 0");const h=n.morphTargetManager;let c=0;h&&h.numInfluencers>0&&(c=h.numInfluencers,s.push("#define MORPHTARGETS"),s.push("#define NUM_MORPH_INFLUENCERS "+c),h.isUsingTextureForTargets&&s.push("#define MORPHTARGETS_TEXTURE"),se.PrepareAttributesForMorphTargetsInfluencers(r,n,c)),t&&(s.push("#define INSTANCES"),se.PushAttributesForInstances(r),e.getRenderingMesh().hasThinInstances&&s.push("#define THIN_INSTANCES")),l.clipPlane&&s.push("#define CLIPPLANE"),l.clipPlane2&&s.push("#define CLIPPLANE2"),l.clipPlane3&&s.push("#define CLIPPLANE3"),l.clipPlane4&&s.push("#define CLIPPLANE4"),l.clipPlane5&&s.push("#define CLIPPLANE5"),l.clipPlane6&&s.push("#define CLIPPLANE6");const u=e._getDrawWrapper(i,!0),d=u.defines,f=s.join(`
`);return d!==f&&u.setEffect(this.scene.getEngine().createEffect("outline",r,["world","mBones","viewProjection","diffuseMatrix","offset","color","logarithmicDepthConstant","morphTargetInfluences","morphTargetTextureInfo","morphTargetTextureIndices","vClipPlane","vClipPlane2","vClipPlane3","vClipPlane4","vClipPlane5","vClipPlane6"],["diffuseSampler","morphTargets"],f,void 0,void 0,void 0,{maxSimultaneousMorphTargets:c}),f),u.effect.isReady()}_beforeRenderingMesh(e,t,i){if(this._savedDepthWrite=this._engine.getDepthWrite(),e.renderOutline){const s=t.getMaterial();s&&s.needAlphaBlendingForMesh(e)&&(this._engine.cacheStencilState(),this._engine.setDepthWrite(!1),this._engine.setColorWrite(!1),this._engine.setStencilBuffer(!0),this._engine.setStencilOperationPass(7681),this._engine.setStencilFunction(519),this._engine.setStencilMask(Bl._StencilReference),this._engine.setStencilFunctionReference(Bl._StencilReference),this._engine.stencilStateComposer.useStencilGlobalOnly=!0,this.render(t,i,!0,this._passIdForDrawWrapper[1]),this._engine.setColorWrite(!0),this._engine.setStencilFunction(517)),this._engine.setDepthWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[0]),this._engine.setDepthWrite(this._savedDepthWrite),s&&s.needAlphaBlendingForMesh(e)&&(this._engine.stencilStateComposer.useStencilGlobalOnly=!1,this._engine.restoreStencilState())}}_afterRenderingMesh(e,t,i){if(e.renderOverlay){const s=this._engine.getAlphaMode(),r=this._engine.alphaState.alphaBlend;this._engine.setAlphaMode(2),this.render(t,i,!0,this._passIdForDrawWrapper[3]),this._engine.setAlphaMode(s),this._engine.setDepthWrite(this._savedDepthWrite),this._engine.alphaState.alphaBlend=r}e.renderOutline&&this._savedDepthWrite&&(this._engine.setDepthWrite(!0),this._engine.setColorWrite(!1),this.render(t,i,!1,this._passIdForDrawWrapper[2]),this._engine.setColorWrite(!0))}}Bl._StencilReference=4;ge.prototype._internalPickSprites=function(a,e,t,i){if(!ki)return null;let s=null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}if(this.spriteManagers.length>0)for(let r=0;r<this.spriteManagers.length;r++){const n=this.spriteManagers[r];if(!n.isPickable)continue;const o=n.intersects(a,i,e,t);if(!(!o||!o.hit)&&!(!t&&s!=null&&o.distance>=s.distance)&&(s=o,t))break}return s||new ki};ge.prototype._internalMultiPickSprites=function(a,e,t){if(!ki)return null;let i=new Array;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}if(this.spriteManagers.length>0)for(let s=0;s<this.spriteManagers.length;s++){const r=this.spriteManagers[s];if(!r.isPickable)continue;const n=r.multiIntersects(a,t,e);n!==null&&(i=i.concat(n))}return i};ge.prototype.pickSprite=function(a,e,t,i,s){if(!this._tempSpritePickingRay)return null;this.createPickingRayInCameraSpaceToRef(a,e,this._tempSpritePickingRay,s);const r=this._internalPickSprites(this._tempSpritePickingRay,t,i,s);return r&&(r.ray=this.createPickingRayInCameraSpace(a,e,s)),r};ge.prototype.pickSpriteWithRay=function(a,e,t,i){if(!this._tempSpritePickingRay)return null;if(!i){if(!this.activeCamera)return null;i=this.activeCamera}$e.TransformToRef(a,i.getViewMatrix(),this._tempSpritePickingRay);const s=this._internalPickSprites(this._tempSpritePickingRay,e,t,i);return s&&(s.ray=a),s};ge.prototype.multiPickSprite=function(a,e,t,i){return this.createPickingRayInCameraSpaceToRef(a,e,this._tempSpritePickingRay,i),this._internalMultiPickSprites(this._tempSpritePickingRay,t,i)};ge.prototype.multiPickSpriteWithRay=function(a,e,t){if(!this._tempSpritePickingRay)return null;if(!t){if(!this.activeCamera)return null;t=this.activeCamera}return $e.TransformToRef(a,t.getViewMatrix(),this._tempSpritePickingRay),this._internalMultiPickSprites(this._tempSpritePickingRay,e,t)};ge.prototype.setPointerOverSprite=function(a){this._pointerOverSprite!==a&&(this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(10,Ri.CreateNewFromSprite(this._pointerOverSprite,this)),this._pointerOverSprite=a,this._pointerOverSprite&&this._pointerOverSprite.actionManager&&this._pointerOverSprite.actionManager.processTrigger(9,Ri.CreateNewFromSprite(this._pointerOverSprite,this)))};ge.prototype.getPointerOverSprite=function(){return this._pointerOverSprite};const _M="imageProcessingCompatibility",mM=`#ifdef IMAGEPROCESSINGPOSTPROCESS
gl_FragColor.rgb=pow(gl_FragColor.rgb,vec3(2.2));
#endif
`;Y.IncludesShadersStore[_M]=mM;const gM="spritesPixelShader",vM=`uniform bool alphaTest;
varying vec4 vColor;
varying vec2 vUV;
uniform sampler2D diffuseSampler;
#include<fogFragmentDeclaration>
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
vec4 color=texture2D(diffuseSampler,vUV);
if (float(alphaTest) != 0.)
{
if (color.a<0.95)
discard;
}
color*=vColor;
#include<fogFragment>
gl_FragColor=color;
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}`;Y.ShadersStore[gM]=vM;const xM="spritesVertexShader",TM=`attribute vec4 position;
attribute vec2 options;
attribute vec2 offsets;
attribute vec2 inverts;
attribute vec4 cellInfo;
attribute vec4 color;
uniform mat4 view;
uniform mat4 projection;
varying vec2 vUV;
varying vec4 vColor;
#include<fogVertexDeclaration>
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
vec3 viewPos=(view*vec4(position.xyz,1.0)).xyz; 
vec2 cornerPos;
float angle=position.w;
vec2 size=vec2(options.x,options.y);
vec2 offset=offsets.xy;
cornerPos=vec2(offset.x-0.5,offset.y -0.5)*size;
vec3 rotatedCorner;
rotatedCorner.x=cornerPos.x*cos(angle)-cornerPos.y*sin(angle);
rotatedCorner.y=cornerPos.x*sin(angle)+cornerPos.y*cos(angle);
rotatedCorner.z=0.;
viewPos+=rotatedCorner;
gl_Position=projection*vec4(viewPos,1.0); 
vColor=color;
vec2 uvOffset=vec2(abs(offset.x-inverts.x),abs(1.0-offset.y-inverts.y));
vec2 uvPlace=cellInfo.xy;
vec2 uvSize=cellInfo.zw;
vUV.x=uvPlace.x+uvSize.x*uvOffset.x;
vUV.y=uvPlace.y+uvSize.y*uvOffset.y;
#ifdef FOG
vFogDistance=viewPos;
#endif
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[xM]=TM;const bM="spriteMapPixelShader",SM=`precision highp float;
varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
uniform float time;
uniform float spriteCount;
uniform sampler2D spriteSheet;
uniform vec2 spriteMapSize;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform sampler2D frameMap;
uniform sampler2D tileMaps[LAYERS];
uniform sampler2D animationMap;
uniform vec3 colorMul;
float mt;
const float fdStep=1./4.;
const float aFrameSteps=1./MAX_ANIMATION_FRAMES;
mat4 getFrameData(float frameID){
float fX=frameID/spriteCount;
return mat4(
texture2D(frameMap,vec2(fX,0.),0.),
texture2D(frameMap,vec2(fX,fdStep*1.),0.),
texture2D(frameMap,vec2(fX,fdStep*2.),0.),
vec4(0.)
);
}
void main(){
vec4 color=vec4(0.);
vec2 tileUV=fract(tUV);
#ifdef FLIPU
tileUV.y=1.0-tileUV.y;
#endif
vec2 tileID=floor(tUV);
vec2 sheetUnits=1./spriteMapSize;
float spriteUnits=1./spriteCount;
vec2 stageUnits=1./stageSize;
for(int i=0; i<LAYERS; i++) {
float frameID;
#define LAYER_ID_SWITCH
vec4 animationData=texture2D(animationMap,vec2((frameID+0.5)/spriteCount,0.),0.);
if(animationData.y>0.) {
mt=mod(time*animationData.z,1.0);
for(float f=0.; f<MAX_ANIMATION_FRAMES; f++){
if(animationData.y>mt){
frameID=animationData.x;
break;
}
animationData=texture2D(animationMap,vec2((frameID+0.5)/spriteCount,aFrameSteps*f),0.);
}
}
mat4 frameData=getFrameData(frameID+0.5);
vec2 frameSize=(frameData[0].zw)/spriteMapSize;
vec2 offset=frameData[0].xy*sheetUnits;
vec2 ratio=frameData[2].xy/frameData[0].zw;
if (frameData[2].z==1.){
tileUV.xy=tileUV.yx;
}
if (i==0){
color=texture2D(spriteSheet,tileUV*frameSize+offset);
} else {
vec4 nc=texture2D(spriteSheet,tileUV*frameSize+offset);
float alpha=min(color.a+nc.a,1.0);
vec3 mixed=mix(color.xyz,nc.xyz,nc.a);
color=vec4(mixed,alpha);
}
}
color.xyz*=colorMul;
gl_FragColor=color;
}`;Y.ShadersStore[bM]=SM;const EM="spriteMapVertexShader",CM=`precision highp float;
attribute vec3 position;
attribute vec3 normal;
attribute vec2 uv;
varying vec3 vPosition;
varying vec2 vUV;
varying vec2 tUV;
varying vec2 stageUnits;
varying vec2 levelUnits;
varying vec2 tileID;
uniform float time;
uniform mat4 worldViewProjection;
uniform vec2 outputSize;
uniform vec2 stageSize;
uniform vec2 spriteMapSize;
uniform float stageScale;
void main() {
vec4 p=vec4( position,1. );
vPosition=p.xyz;
vUV=uv;
tUV=uv*stageSize; 
gl_Position=worldViewProjection*p;
}`;Y.ShadersStore[EM]=CM;var fp;(function(a){a[a.INIT=0]="INIT",a[a.RUNNING=1]="RUNNING",a[a.DONE=2]="DONE",a[a.ERROR=3]="ERROR"})(fp||(fp={}));X.prototype.notifyObserversWithPromise=async function(a,e=-1,t,i,s){let r=Promise.resolve(a);if(!this.observers.length)return r;const n=this._eventState;return n.mask=e,n.target=t,n.currentTarget=i,n.skipNextObservers=!1,n.userInfo=s,this.observers.forEach(o=>{n.skipNextObservers||o._willBeUnregistered||o.mask&e&&(o.scope?r=r.then(l=>(n.lastReturnValue=l,o.callback.apply(o.scope,[a,n]))):r=r.then(l=>(n.lastReturnValue=l,o.callback(a,n))),o.unregisterOnNextCall&&this._deferUnregister(o))}),await r,a};function zm(a,e,t,i,s="image/png",r=!1){const{height:n,width:o}=Wm(a,e,t);if(!(n&&o)){B.Error("Invalid 'size' parameter !");return}q._ScreenshotCanvas||(q._ScreenshotCanvas=document.createElement("canvas")),q._ScreenshotCanvas.width=o,q._ScreenshotCanvas.height=n;const l=q._ScreenshotCanvas.getContext("2d"),h=a.getRenderWidth()/a.getRenderHeight();let c=o,u=c/h;u>n&&(u=n,c=u*h);const d=Math.max(0,o-c)/2,f=Math.max(0,n-u)/2;e.getScene().activeCamera!==e?b0(a,e,t,_=>{if(r){const m=new Blob([_]);q.DownloadBlob(m),i&&i("")}else i&&i(_)},s,1,a.getCreationOptions().antialias):a.onEndFrameObservable.addOnce(()=>{const _=a.getRenderingCanvas();l&&_&&l.drawImage(_,d,f,c,u),r?(q.EncodeScreenshotCanvasData(void 0,s),i&&i("")):q.EncodeScreenshotCanvasData(i,s)})}function yM(a,e,t,i="image/png"){return new Promise((s,r)=>{zm(a,e,t,n=>{typeof n<"u"?s(n):r(new Error("Data is undefined"))},i)})}function b0(a,e,t,i,s="image/png",r=1,n=!1,o,l=!1,h=!1){const{height:c,width:u}=Wm(a,e,t),d={width:u,height:c};if(!(c&&u)){B.Error("Invalid 'size' parameter !");return}const f={width:a.getRenderWidth(),height:a.getRenderHeight()};a.setSize(u,c);const p=e.getScene();p.render();const _=new si("screenShot",d,p,!1,!1,0,!1,H.NEAREST_SAMPLINGMODE,void 0,h,void 0,void 0,void 0,r);_.renderList=p.meshes.slice(),_.samples=r,_.renderSprites=l,_.activeCamera=e;const m=()=>{a.onEndFrameObservable.addOnce(()=>{_.readPixels(void 0,void 0,void 0,!1).then(v=>{q.DumpData(u,c,v,i,s,o,!0),_.dispose()})}),p.incrementRenderId(),p.resetCachedMaterial(),_.render(!0),p.incrementRenderId(),p.resetCachedMaterial(),a.setSize(f.width,f.height),e.getProjectionMatrix(!0),p.render()};if(n){const v=new qo("antialiasing",1,p.activeCamera);_.addPostProcess(v),v.getEffect().isReady()?m():v.getEffect().onCompiled=()=>{m()}}else m()}function AM(a,e,t,i="image/png",s=1,r=!1,n,o=!1){return new Promise((l,h)=>{b0(a,e,t,c=>{typeof c<"u"?l(c):h(new Error("Data is undefined"))},i,s,r,n,o)})}function Wm(a,e,t){let i=0,s=0;if(typeof t=="object"){const r=t.precision?Math.abs(t.precision):1;t.width&&t.height?(i=t.height*r,s=t.width*r):t.width&&!t.height?(s=t.width*r,i=Math.round(s/a.getAspectRatio(e))):t.height&&!t.width?(i=t.height*r,s=Math.round(i*a.getAspectRatio(e))):(s=Math.round(a.getRenderWidth()*r),i=Math.round(s/a.getAspectRatio(e)))}else isNaN(t)||(i=t,s=t);return s&&(s=Math.floor(s)),i&&(i=Math.floor(i)),{height:i|0,width:s|0}}const RM=()=>{q.CreateScreenshot=zm,q.CreateScreenshotAsync=yM,q.CreateScreenshotUsingRenderTarget=b0,q.CreateScreenshotUsingRenderTargetAsync=AM};RM();var pp;(function(a){a[a.Checkbox=0]="Checkbox",a[a.Slider=1]="Slider",a[a.Vector3=2]="Vector3",a[a.Quaternion=3]="Quaternion",a[a.Color3=4]="Color3",a[a.String=5]="String",a[a.Button=6]="Button",a[a.Options=7]="Options",a[a.Tab=8]="Tab",a[a.FileButton=9]="FileButton"})(pp||(pp={}));class _p{static _GetStorage(){try{return localStorage.setItem("test",""),localStorage.removeItem("test"),localStorage}catch{const t={};return{getItem:i=>{const s=t[i];return s===void 0?null:s},setItem:(i,s)=>{t[i]=s}}}}static ReadString(e,t){const i=this._Storage.getItem(e);return i!==null?i:t}static WriteString(e,t){this._Storage.setItem(e,t)}static ReadBoolean(e,t){const i=this._Storage.getItem(e);return i!==null?i==="true":t}static WriteBoolean(e,t){this._Storage.setItem(e,t?"true":"false")}static ReadNumber(e,t){const i=this._Storage.getItem(e);return i!==null?parseFloat(i):t}static WriteNumber(e,t){this._Storage.setItem(e,t.toString())}}_p._Storage=_p._GetStorage();var mp;(function(a){class e{constructor(s,r=null,n=null,o=null){r=r!=null?r:()=>1,n=n!=null?n:()=>1,o=o!=null?o:(h,c)=>h===c?0:1,this._characterToIdx=new Map,this._insertionCosts=new Array(s.length),this._deletionCosts=new Array(s.length),this._substitutionCosts=new Array(s.length);let l;for(let h=0;h<s.length;++h){l=s[h],this._characterToIdx.set(l,h),this._insertionCosts[h]=r(l),this._deletionCosts[h]=n(l),this._substitutionCosts[h]=new Array(s.length);for(let c=h;c<s.length;++c)this._substitutionCosts[h][c]=o(l,s[c])}}serialize(){const s={},r=new Array(this._characterToIdx.size);return this._characterToIdx.forEach((n,o)=>{r[n]=o}),s.characters=r,s.insertionCosts=this._insertionCosts,s.deletionCosts=this._deletionCosts,s.substitutionCosts=this._substitutionCosts,JSON.stringify(s)}static Deserialize(s){const r=JSON.parse(s),n=new e(r.characters);return n._insertionCosts=r.insertionCosts,n._deletionCosts=r.deletionCosts,n._substitutionCosts=r.substitutionCosts,n}getCharacterIdx(s){return this._characterToIdx.get(s)}getInsertionCost(s){return this._insertionCosts[s]}getDeletionCost(s){return this._deletionCosts[s]}getSubstitutionCost(s,r){const n=Math.min(s,r),o=Math.max(s,r);return this._substitutionCosts[n][o]}}a.Alphabet=e;class t{constructor(s,r){if(s.length>t._MAX_SEQUENCE_LENGTH)throw new Error("Sequences longer than "+t._MAX_SEQUENCE_LENGTH+" not supported.");this._alphabet=r,this._characters=s.map(n=>this._alphabet.getCharacterIdx(n))}serialize(){return JSON.stringify(this._characters)}static Deserialize(s,r){const n=new t([],r);return n._characters=JSON.parse(s),n}distance(s){return t._Distance(this,s)}static _Distance(s,r){const n=s._alphabet;if(n!==r._alphabet)throw new Error("Cannot Levenshtein compare Sequences built from different alphabets.");const o=s._characters,l=r._characters,h=o.length,c=l.length,u=t._CostMatrix;u[0][0]=0;for(let d=0;d<h;++d)u[d+1][0]=u[d][0]+n.getInsertionCost(o[d]);for(let d=0;d<c;++d)u[0][d+1]=u[0][d]+n.getInsertionCost(l[d]);for(let d=0;d<h;++d)for(let f=0;f<c;++f)t._InsertionCost=u[d+1][f]+n.getInsertionCost(l[f]),t._DeletionCost=u[d][f+1]+n.getDeletionCost(o[d]),t._SubstitutionCost=u[d][f]+n.getSubstitutionCost(o[d],l[f]),u[d+1][f+1]=Math.min(t._InsertionCost,t._DeletionCost,t._SubstitutionCost);return u[h][c]}}t._MAX_SEQUENCE_LENGTH=256,t._CostMatrix=[...Array(t._MAX_SEQUENCE_LENGTH+1)].map(()=>new Array(t._MAX_SEQUENCE_LENGTH+1)),a.Sequence=t})(mp||(mp={}));new g;new g;new g;new g;new L;const IM=1.5;class In{constructor(e){this._view=new Float32Array(e),this._itemLength=0}get itemLength(){return this._itemLength}at(e){return e<0||e>=this._itemLength?NaN:this._view[e]}subarray(e,t){return e>=t||e<0?new Float32Array(0):(t>this._itemLength&&(t=this._itemLength),this._view.subarray(e,t))}push(e){this._view[this._itemLength]=e,this._itemLength++,this._itemLength>=this._view.length&&this._growArray()}_growArray(){const e=Math.floor(this._view.length*IM),t=new Float32Array(e);t.set(this._view),this._view=t}}const Pn=1800,PM=24,MM="0",gp="timestamp",vp="numPoints",DM=/\r/g,Vu="@";class yr{constructor(e,t){this._scene=e,this._collectDataAtFrame=()=>{const i=ps.Now-this._startingTimestamp,s=this.datasets.ids.length,r=this.datasets.startingIndices.itemLength;let n=0;if(r>0){const o=this.datasets.startingIndices.at(r-1);n=o+this.datasets.data.at(o+yr.NumberOfPointsOffset)+yr.SliceDataOffset}if(this.datasets.startingIndices.push(n),this.datasets.data.push(i),this.datasets.data.push(s),this.datasets.ids.forEach(o=>{const l=this._strategies.get(o);!l||this.datasets.data.push(l.getData())}),this.datasetObservable.hasObservers()){const o=[i,s];for(let l=0;l<s;l++)o.push(this.datasets.data.at(n+yr.SliceDataOffset+l));this.datasetObservable.notifyObservers(o)}},this.datasets={ids:[],data:new In(Pn),startingIndices:new In(Pn)},this._strategies=new Map,this._datasetMeta=new Map,this._eventRestoreSet=new Set,this._customEventObservable=new X,this.datasetObservable=new X,this.metadataObservable=new X(i=>i.callback(this._datasetMeta,new Qp(0))),t&&this.addCollectionStrategies(...t)}static get SliceDataOffset(){return 2}static get NumberOfPointsOffset(){return 1}registerEvent(e,t,i){var s;if(this._strategies.has(e)&&!t)return;this._strategies.has(e)&&t&&((s=this._strategies.get(e))===null||s===void 0||s.dispose(),this._strategies.delete(e));const r=o=>{let l=0,h=0;const c=o.onAfterRenderObservable.add(()=>{h=l,l=0}),u=this._customEventObservable.add(d=>{e===d.name&&(d.value!==void 0?l=d.value:l++)});return{id:e,getData:()=>h,dispose:()=>{o.onAfterRenderObservable.remove(c),this._customEventObservable.remove(u)}}},n={name:e};return this._eventRestoreSet.add(e),this.addCollectionStrategies({strategyCallback:r,category:i}),n}sendEvent(e){this._customEventObservable.notifyObservers(e)}_restoreStringEvents(){this._eventRestoreSet.size!==this._customEventObservable.observers.length&&this._eventRestoreSet.forEach(e=>{this.registerEvent(e,!0)})}addCollectionStrategies(...e){for(let{strategyCallback:t,category:i,hidden:s}of e){const r=t(this._scene);if(this._strategies.has(r.id)){r.dispose();continue}this.datasets.ids.push(r.id),i&&(i=i.replace(new RegExp(Vu,"g"),"")),this._datasetMeta.set(r.id,{color:this._getHexColorFromId(r.id),category:i,hidden:s}),this._strategies.set(r.id,r)}this.metadataObservable.notifyObservers(this._datasetMeta)}_getHexColorFromId(e){let t=0;for(let s=0;s<e.length;s++)t=e.charCodeAt(s)+((t<<5)-t);let i="#";for(let s=0;s<PM;s+=8){const r=t>>s&255;i+=(MM+r.toString(16)).substr(-2)}return i}getCurrentSlice(){const e=ps.Now-this._startingTimestamp,t=this.datasets.ids.length,i=[e,t];this.datasets.ids.forEach(s=>{const r=this._strategies.get(s);!r||this.datasetObservable.hasObservers()&&i.push(r.getData())}),this.datasetObservable.hasObservers()&&this.datasetObservable.notifyObservers(i)}updateMetadata(e,t,i){const s=this._datasetMeta.get(e);!s||(s[t]=i,this.metadataObservable.notifyObservers(this._datasetMeta))}clear(e){this.datasets.data=new In(Pn),this.datasets.ids.length=0,this.datasets.startingIndices=new In(Pn),this._datasetMeta.clear(),this._strategies.forEach(t=>t.dispose()),this._strategies.clear(),e||this._eventRestoreSet.clear(),this._hasLoadedData=!1}get hasLoadedData(){return this._hasLoadedData}loadFromFileData(e,t){const i=e.replace(DM,"").split(`
`).map(u=>u.split(",").filter(d=>d.length>0)).filter(u=>u.length>0),s=0,r=yr.NumberOfPointsOffset;if(i.length<2)return!1;const n={ids:[],data:new In(Pn),startingIndices:new In(Pn)},[o,...l]=i;if(o.length<2||o[s]!==gp||o[r]!==vp)return!1;const h=new Map;for(let u=yr.SliceDataOffset;u<o.length;u++){const[d,f]=o[u].split(Vu);n.ids.push(d),h.set(d,f)}let c=0;for(const u of l){if(u.length<2)return!1;const d=parseFloat(u[s]),f=parseInt(u[r]);if(isNaN(f)||isNaN(d)||(n.data.push(d),n.data.push(f),f+yr.SliceDataOffset!==u.length))return!1;for(let p=yr.SliceDataOffset;p<u.length;p++){const _=parseFloat(u[p]);if(isNaN(_))return!1;n.data.push(_)}n.startingIndices.push(c),c+=u.length}if(this.datasets.ids=n.ids,this.datasets.data=n.data,this.datasets.startingIndices=n.startingIndices,t||this._datasetMeta.clear(),this._strategies.forEach(u=>u.dispose()),this._strategies.clear(),!t)for(const u of this.datasets.ids){const d=h.get(u);this._datasetMeta.set(u,{category:d,color:this._getHexColorFromId(u)})}return this.metadataObservable.notifyObservers(this._datasetMeta),this._hasLoadedData=!0,!0}exportDataToCsv(){let e="";e+=`${gp},${vp}`;for(let i=0;i<this.datasets.ids.length;i++)if(e+=`,${this.datasets.ids[i]}`,this._datasetMeta){const s=this._datasetMeta.get(this.datasets.ids[i]);s!=null&&s.category&&(e+=`${Vu}${s.category}`)}e+=`
`;for(let i=0;i<this.datasets.startingIndices.itemLength;i++){const s=this.datasets.startingIndices.at(i),r=this.datasets.data.at(s),n=this.datasets.data.at(s+yr.NumberOfPointsOffset);e+=`${r},${n}`;for(let o=0;o<n;o++)e+=`,${this.datasets.data.at(s+yr.SliceDataOffset+o)}`;for(let o=0;o<this.datasets.ids.length-n;o++)e+=",";e+=`
`}const t=`${new Date().toISOString()}-perfdata.csv`;q.Download(new Blob([e],{type:"text/csv"}),t)}start(e){e?this._startingTimestamp===void 0&&(this._startingTimestamp=ps.Now):(this.datasets.data=new In(Pn),this.datasets.startingIndices=new In(Pn),this._startingTimestamp=ps.Now),this._scene.onAfterRenderObservable.add(this._collectDataAtFrame),this._restoreStringEvents(),this._isStarted=!0}stop(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._isStarted=!1}get isStarted(){return this._isStarted}dispose(){this._scene.onAfterRenderObservable.removeCallback(this._collectDataAtFrame),this._datasetMeta.clear(),this._strategies.forEach(e=>{e.dispose()}),this.datasetObservable.clear(),this.metadataObservable.clear(),this._isStarted=!1,this.datasets=null}}ge.prototype.getPerfCollector=function(){return this._perfCollector||(this._perfCollector=new yr(this)),this._perfCollector};function OM(a){const e=new Array,t=new Array,i=new Array,s=a.add(()=>{const n=e.length;for(let o=0;o<n;o++)qh(e.shift(),t.shift(),i.shift())});return{scheduler:(n,o,l)=>{e.push(n),t.push(o),i.push(l)},dispose:()=>{a.remove(s)}}}X.prototype.runCoroutineAsync=function(a){if(!this._coroutineScheduler){const e=OM(this);this._coroutineScheduler=e.scheduler,this._coroutineSchedulerDispose=e.dispose}return T_(a,this._coroutineScheduler)};X.prototype.cancelAllCoroutines=function(){this._coroutineSchedulerDispose&&this._coroutineSchedulerDispose(),this._coroutineScheduler=void 0,this._coroutineSchedulerDispose=void 0};class Yn extends Ji{constructor(e,t={}){super(e),this.options=t,this._direction=new g(0,0,-1),this._mat=new L,this._onSelectEnabled=!1,this._origin=new g(0,0,0),this.lastNativeXRHitResults=[],this.onHitTestResultObservable=new X,this._onHitTestResults=i=>{const s=i.map(r=>{const n=L.FromArray(r.hitMatrix);return this._xrSessionManager.scene.useRightHandedSystem||n.toggleModelMatrixHandInPlace(),this.options.worldParentNode&&n.multiplyToRef(this.options.worldParentNode.getWorldMatrix(),n),{xrHitResult:r,transformationMatrix:n}});this.lastNativeXRHitResults=i,this.onHitTestResultObservable.notifyObservers(s)},this._onSelect=i=>{!this._onSelectEnabled||Yn.XRHitTestWithSelectEvent(i,this._xrSessionManager.referenceSpace)},this.xrNativeFeatureName="hit-test",q.Warn("A newer version of this plugin is available")}static XRHitTestWithRay(e,t,i,s){return e.requestHitTest(t,i).then(r=>{const n=s||(o=>!!o.hitMatrix);return r.filter(n)})}static XRHitTestWithSelectEvent(e,t){const i=e.frame.getPose(e.inputSource.targetRaySpace,t);if(!i)return Promise.resolve([]);const s=new XRRay(i.transform);return this.XRHitTestWithRay(e.frame.session,s,t)}attach(){return super.attach()?(this.options.testOnPointerDownOnly&&this._xrSessionManager.session.addEventListener("select",this._onSelect,!1),!0):!1}detach(){return super.detach()?(this._onSelectEnabled=!1,this._xrSessionManager.session.removeEventListener("select",this._onSelect),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!this.attached||this.options.testOnPointerDownOnly)return;const t=e.getViewerPose(this._xrSessionManager.referenceSpace);if(!t)return;L.FromArrayToRef(t.transform.matrix,0,this._mat),g.TransformCoordinatesFromFloatsToRef(0,0,0,this._mat,this._origin),g.TransformCoordinatesFromFloatsToRef(0,0,-1,this._mat,this._direction),this._direction.subtractInPlace(this._origin),this._direction.normalize();const i=new XRRay({x:this._origin.x,y:this._origin.y,z:this._origin.z,w:0},{x:this._direction.x,y:this._direction.y,z:this._direction.z,w:0});Yn.XRHitTestWithRay(this._xrSessionManager.session,i,this._xrSessionManager.referenceSpace).then(this._onHitTestResults)}}Yn.Name=pt.HIT_TEST;Yn.Version=1;ii.AddWebXRFeature(Yn.Name,(a,e)=>()=>new Yn(a,e),Yn.Version,!1);let wM=0;class dl extends Ji{constructor(e,t={}){super(e),this._options=t,this._lastFrameDetected=new Set,this._trackedAnchors=[],this._futureAnchors=[],this.onAnchorAddedObservable=new X,this.onAnchorRemovedObservable=new X,this.onAnchorUpdatedObservable=new X,this._tmpVector=new g,this._tmpQuaternion=new Q,this.xrNativeFeatureName="anchors"}set referenceSpaceForFrameAnchors(e){this._referenceSpaceForFrameAnchors=e}_populateTmpTransformation(e,t){return this._tmpVector.copyFrom(e),this._tmpQuaternion.copyFrom(t),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpVector.z*=-1,this._tmpQuaternion.z*=-1,this._tmpQuaternion.w*=-1),{position:this._tmpVector,rotationQuaternion:this._tmpQuaternion}}async addAnchorPointUsingHitTestResultAsync(e,t=new g,i=new Q){this._populateTmpTransformation(t,i);const s=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w});if(e.xrHitResult.createAnchor)try{const r=await e.xrHitResult.createAnchor(s);return new Promise((n,o)=>{this._futureAnchors.push({nativeAnchor:r,resolved:!1,submitted:!0,xrTransformation:s,resolve:n,reject:o})})}catch(r){throw new Error(r)}else throw this.detach(),new Error("Anchors not enabled in this environment/browser")}async addAnchorAtPositionAndRotationAsync(e,t=new Q,i=!1){this._populateTmpTransformation(e,t);const s=new XRRigidTransform({x:this._tmpVector.x,y:this._tmpVector.y,z:this._tmpVector.z},{x:this._tmpQuaternion.x,y:this._tmpQuaternion.y,z:this._tmpQuaternion.z,w:this._tmpQuaternion.w}),r=i&&this.attached&&this._xrSessionManager.currentFrame?await this._createAnchorAtTransformation(s,this._xrSessionManager.currentFrame):void 0;return new Promise((n,o)=>{this._futureAnchors.push({nativeAnchor:r,resolved:!1,submitted:!1,xrTransformation:s,resolve:n,reject:o})})}get anchors(){return this._trackedAnchors}detach(){if(!super.detach())return!1;if(!this._options.doNotRemoveAnchorsOnSessionEnded)for(;this._trackedAnchors.length;){const e=this._trackedAnchors.pop();if(e){try{e.remove()}catch{}this.onAnchorRemovedObservable.notifyObservers(e)}}return!0}dispose(){this._futureAnchors.length=0,super.dispose(),this.onAnchorAddedObservable.clear(),this.onAnchorRemovedObservable.clear(),this.onAnchorUpdatedObservable.clear()}_onXRFrame(e){if(!this.attached||!e)return;const t=e.trackedAnchors;if(t){const i=this._trackedAnchors.filter(r=>!t.has(r.xrAnchor)).map(r=>this._trackedAnchors.indexOf(r));let s=0;i.forEach(r=>{const n=this._trackedAnchors.splice(r-s,1)[0];this.onAnchorRemovedObservable.notifyObservers(n),s++}),t.forEach(r=>{if(this._lastFrameDetected.has(r)){const n=this._findIndexInAnchorArray(r),o=this._trackedAnchors[n];try{this._updateAnchorWithXRFrame(r,o,e),o.attachedNode&&(o.attachedNode.rotationQuaternion=o.attachedNode.rotationQuaternion||new Q,o.transformationMatrix.decompose(o.attachedNode.scaling,o.attachedNode.rotationQuaternion,o.attachedNode.position)),this.onAnchorUpdatedObservable.notifyObservers(o)}catch{q.Warn("Anchor could not be updated")}}else{const n={id:wM++,xrAnchor:r,remove:()=>r.delete()},o=this._updateAnchorWithXRFrame(r,n,e);this._trackedAnchors.push(o),this.onAnchorAddedObservable.notifyObservers(o);const h=this._futureAnchors.filter(c=>c.nativeAnchor===r)[0];h&&(h.resolve(o),h.resolved=!0)}}),this._lastFrameDetected=t}this._futureAnchors.forEach(i=>{!i.resolved&&!i.submitted&&(this._createAnchorAtTransformation(i.xrTransformation,e).then(s=>{i.nativeAnchor=s},s=>{i.resolved=!0,i.reject(s)}),i.submitted=!0)})}_findIndexInAnchorArray(e){for(let t=0;t<this._trackedAnchors.length;++t)if(this._trackedAnchors[t].xrAnchor===e)return t;return-1}_updateAnchorWithXRFrame(e,t,i){const s=i.getPose(e.anchorSpace,this._xrSessionManager.referenceSpace);if(s){const r=t.transformationMatrix||new L;L.FromArrayToRef(s.transform.matrix,0,r),this._xrSessionManager.scene.useRightHandedSystem||r.toggleModelMatrixHandInPlace(),t.transformationMatrix=r,this._options.worldParentNode&&r.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),r)}return t}async _createAnchorAtTransformation(e,t){var i;if(t.createAnchor)try{return t.createAnchor(e,(i=this._referenceSpaceForFrameAnchors)!==null&&i!==void 0?i:this._xrSessionManager.referenceSpace)}catch(s){throw new Error(s)}else throw this.detach(),new Error("Anchors are not enabled in your browser")}}dl.Name=pt.ANCHOR_SYSTEM;dl.Version=1;ii.AddWebXRFeature(dl.Name,(a,e)=>()=>new dl(a,e),dl.Version);let NM=0;class fl extends Ji{constructor(e,t={}){super(e),this._options=t,this._detectedPlanes=[],this._enabled=!1,this._lastFrameDetected=new Set,this.onPlaneAddedObservable=new X,this.onPlaneRemovedObservable=new X,this.onPlaneUpdatedObservable=new X,this.xrNativeFeatureName="plane-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){if(!super.detach())return!1;if(!this._options.doNotRemovePlanesOnSessionEnded)for(;this._detectedPlanes.length;){const e=this._detectedPlanes.pop();e&&this.onPlaneRemovedObservable.notifyObservers(e)}return!0}dispose(){super.dispose(),this.onPlaneAddedObservable.clear(),this.onPlaneRemovedObservable.clear(),this.onPlaneUpdatedObservable.clear()}isCompatible(){return typeof XRPlane<"u"}_onXRFrame(e){var t;if(!this.attached||!this._enabled||!e)return;const i=e.detectedPlanes||((t=e.worldInformation)===null||t===void 0?void 0:t.detectedPlanes);if(i){for(let s=0;s<this._detectedPlanes.length;s++){const r=this._detectedPlanes[s];i.has(r.xrPlane)||(this._detectedPlanes.splice(s--,1),this.onPlaneRemovedObservable.notifyObservers(r))}i.forEach(s=>{if(this._lastFrameDetected.has(s)){if(s.lastChangedTime===this._xrSessionManager.currentTimestamp){const r=this._findIndexInPlaneArray(s),n=this._detectedPlanes[r];this._updatePlaneWithXRPlane(s,n,e),this.onPlaneUpdatedObservable.notifyObservers(n)}}else{const r={id:NM++,xrPlane:s,polygonDefinition:[]},n=this._updatePlaneWithXRPlane(s,r,e);this._detectedPlanes.push(n),this.onPlaneAddedObservable.notifyObservers(n)}}),this._lastFrameDetected=i}}_init(){const e=()=>{this._enabled=!0,this._detectedPlanes.length&&(this._detectedPlanes.length=0)};if(!!this._xrSessionManager.isNative&&!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions&&this._xrSessionManager.session.trySetPreferredPlaneDetectorOptions(this._options.preferredDetectorOptions),!this._xrSessionManager.session.updateWorldTrackingState){e();return}this._xrSessionManager.session.updateWorldTrackingState({planeDetectionState:{enabled:!0}}),e()}_updatePlaneWithXRPlane(e,t,i){t.polygonDefinition=e.polygon.map(r=>{const n=this._xrSessionManager.scene.useRightHandedSystem?1:-1;return new g(r.x,r.y,r.z*n)});const s=i.getPose(e.planeSpace,this._xrSessionManager.referenceSpace);if(s){const r=t.transformationMatrix||new L;L.FromArrayToRef(s.transform.matrix,0,r),this._xrSessionManager.scene.useRightHandedSystem||r.toggleModelMatrixHandInPlace(),t.transformationMatrix=r,this._options.worldParentNode&&r.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),r)}return t}_findIndexInPlaneArray(e){for(let t=0;t<this._detectedPlanes.length;++t)if(this._detectedPlanes[t].xrPlane===e)return t;return-1}}fl.Name=pt.PLANE_DETECTION;fl.Version=1;ii.AddWebXRFeature(fl.Name,(a,e)=>()=>new fl(a,e),fl.Version);class pl extends Ji{constructor(e,t={}){super(e),this.options=t,this.onBackgroundStateChangedObservable=new X}attach(){return this._setBackgroundState(!1),super.attach()}detach(){return this._setBackgroundState(!0),super.detach()}dispose(){super.dispose(),this.onBackgroundStateChangedObservable.clear()}_onXRFrame(e){}_setBackgroundState(e){const t=this._xrSessionManager.scene;if(!this.options.ignoreEnvironmentHelper)if(this.options.environmentHelperRemovalFlags){if(this.options.environmentHelperRemovalFlags.skyBox){const i=t.getMeshByName("BackgroundSkybox");i&&i.setEnabled(e)}if(this.options.environmentHelperRemovalFlags.ground){const i=t.getMeshByName("BackgroundPlane");i&&i.setEnabled(e)}}else{const i=t.getMeshByName("BackgroundHelper");i&&i.setEnabled(e)}this.options.backgroundMeshes&&this.options.backgroundMeshes.forEach(i=>i.setEnabled(e)),this.onBackgroundStateChangedObservable.notifyObservers(e)}}pl.Name=pt.BACKGROUND_REMOVER;pl.Version=1;ii.AddWebXRFeature(pl.Name,(a,e)=>()=>new pl(a,e),pl.Version,!0);class _l extends Ji{constructor(e,t){super(e),this._options=t,this._attachController=i=>{this._controllers[i.uniqueId]||(this._xrSessionManager.scene.isPhysicsEnabled()||B.Warn("physics engine not enabled, skipped. Please add this controller manually."),this._options.physicsProperties.useControllerMesh&&i.inputSource.gamepad?i.onMotionControllerInitObservable.addOnce(s=>{s._doNotLoadControllerMesh?this._createPhysicsImpostor(i):s.onModelLoadedObservable.addOnce(()=>{const r=new Oe(s.rootMesh,Oe.MeshImpostor,{mass:0,...this._options.physicsProperties}),n=i.grip||i.pointer;this._controllers[i.uniqueId]={xrController:i,impostor:r,oldPos:n.position.clone(),oldRotation:n.rotationQuaternion.clone()}})}):this._createPhysicsImpostor(i))},this._controllers={},this._debugMode=!1,this._delta=0,this._lastTimestamp=0,this._tmpQuaternion=new Q,this._tmpVector=new g,this._options.physicsProperties||(this._options.physicsProperties={})}_createPhysicsImpostor(e){const t=this._options.physicsProperties.impostorType||Oe.SphereImpostor,i=this._options.physicsProperties.impostorSize||.1,s=qr("impostor-mesh-"+e.uniqueId,{diameterX:typeof i=="number"?i:i.width,diameterY:typeof i=="number"?i:i.height,diameterZ:typeof i=="number"?i:i.depth});s.isVisible=this._debugMode,s.isPickable=!1,s.rotationQuaternion=new Q;const r=e.grip||e.pointer;s.position.copyFrom(r.position),s.rotationQuaternion.copyFrom(r.rotationQuaternion);const n=new Oe(s,t,{mass:0,...this._options.physicsProperties});this._controllers[e.uniqueId]={xrController:e,impostor:n,impostorMesh:s}}_enablePhysicsDebug(){this._debugMode=!0,Object.keys(this._controllers).forEach(e=>{const t=this._controllers[e];t.impostorMesh&&(t.impostorMesh.isVisible=!0)})}addController(e){this._attachController(e)}attach(){if(!super.attach())return!1;if(!this._options.xrInput)return!0;if(this._options.xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._options.xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),this._options.enableHeadsetImpostor){const e=this._options.headsetImpostorParams||{impostorType:Oe.SphereImpostor,restitution:.8,impostorSize:.3},t=e.impostorSize||.3;this._headsetMesh=qr("headset-mesh",{diameterX:typeof t=="number"?t:t.width,diameterY:typeof t=="number"?t:t.height,diameterZ:typeof t=="number"?t:t.depth}),this._headsetMesh.rotationQuaternion=new Q,this._headsetMesh.isVisible=!1,this._headsetImpostor=new Oe(this._headsetMesh,e.impostorType,{mass:0,...e})}return!0}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._headsetMesh&&this._headsetMesh.dispose(),!0):!1}getHeadsetImpostor(){return this._headsetImpostor}getImpostorForController(e){const t=typeof e=="string"?e:e.uniqueId;return this._controllers[t]?this._controllers[t].impostor:null}setPhysicsProperties(e){this._options.physicsProperties={...this._options.physicsProperties,...e}}_onXRFrame(e){var t,i;if(this._delta=this._xrSessionManager.currentTimestamp-this._lastTimestamp,this._lastTimestamp=this._xrSessionManager.currentTimestamp,this._headsetMesh&&this._headsetImpostor){if(this._headsetMesh.position.copyFrom(this._options.xrInput.xrCamera.globalPosition),this._headsetMesh.rotationQuaternion.copyFrom(this._options.xrInput.xrCamera.absoluteRotation),!((t=this._options.xrInput.xrCamera._lastXRViewerPose)===null||t===void 0)&&t.linearVelocity){const s=this._options.xrInput.xrCamera._lastXRViewerPose.linearVelocity;this._tmpVector.set(s.x,s.y,s.z),this._headsetImpostor.setLinearVelocity(this._tmpVector)}if(!((i=this._options.xrInput.xrCamera._lastXRViewerPose)===null||i===void 0)&&i.angularVelocity){const s=this._options.xrInput.xrCamera._lastXRViewerPose.angularVelocity;this._tmpVector.set(s.x,s.y,s.z),this._headsetImpostor.setAngularVelocity(this._tmpVector)}}Object.keys(this._controllers).forEach(s=>{var r,n;const o=this._controllers[s],l=o.xrController.grip||o.xrController.pointer,h=o.oldPos||o.impostorMesh.position;if(!((r=o.xrController._lastXRPose)===null||r===void 0)&&r.linearVelocity){const u=o.xrController._lastXRPose.linearVelocity;this._tmpVector.set(u.x,u.y,u.z),o.impostor.setLinearVelocity(this._tmpVector)}else l.position.subtractToRef(h,this._tmpVector),this._tmpVector.scaleInPlace(1e3/this._delta),o.impostor.setLinearVelocity(this._tmpVector);h.copyFrom(l.position),this._debugMode&&console.log(this._tmpVector,"linear");const c=o.oldRotation||o.impostorMesh.rotationQuaternion;if(!((n=o.xrController._lastXRPose)===null||n===void 0)&&n.angularVelocity){const u=o.xrController._lastXRPose.angularVelocity;this._tmpVector.set(u.x,u.y,u.z),o.impostor.setAngularVelocity(this._tmpVector)}else if(!c.equalsWithEpsilon(l.rotationQuaternion)){c.conjugateInPlace().multiplyToRef(l.rotationQuaternion,this._tmpQuaternion);const u=Math.sqrt(this._tmpQuaternion.x*this._tmpQuaternion.x+this._tmpQuaternion.y*this._tmpQuaternion.y+this._tmpQuaternion.z*this._tmpQuaternion.z);if(this._tmpVector.set(this._tmpQuaternion.x,this._tmpQuaternion.y,this._tmpQuaternion.z),u<.001)this._tmpVector.scaleInPlace(2);else{const d=2*Math.atan2(u,this._tmpQuaternion.w);this._tmpVector.scaleInPlace(d/(u*(this._delta/1e3)))}o.impostor.setAngularVelocity(this._tmpVector)}c.copyFrom(l.rotationQuaternion),this._debugMode&&console.log(this._tmpVector,this._tmpQuaternion,"angular")})}_detachController(e){const t=this._controllers[e];!t||(t.impostorMesh&&t.impostorMesh.dispose(),delete this._controllers[e])}}_l.Name=pt.PHYSICS_CONTROLLERS;_l.Version=1;ii.AddWebXRFeature(_l.Name,(a,e)=>()=>new _l(a,e),_l.Version,!0);class ml extends Ji{constructor(e,t={}){super(e),this.options=t,this._tmpMat=new L,this._tmpPos=new g,this._tmpQuat=new Q,this._initHitTestSource=i=>{if(!i)return;const s=new XRRay(this.options.offsetRay||{}),r={space:this.options.useReferenceSpace?i:this._xrSessionManager.viewerReferenceSpace,offsetRay:s};if(this.options.entityTypes&&(r.entityTypes=this.options.entityTypes),!r.space){q.Warn("waiting for viewer reference space to initialize");return}this._xrSessionManager.session.requestHitTestSource(r).then(n=>{this._xrHitTestSource&&this._xrHitTestSource.cancel(),this._xrHitTestSource=n})},this.autoCloneTransformation=!1,this.onHitTestResultObservable=new X,this.paused=!1,this.xrNativeFeatureName="hit-test",q.Warn("Hit test is an experimental and unstable feature.")}attach(){if(!super.attach()||!this._xrSessionManager.session.requestHitTestSource)return!1;if(this.options.disablePermanentHitTest||(this._xrSessionManager.referenceSpace&&this._initHitTestSource(this._xrSessionManager.referenceSpace),this._xrSessionManager.onXRReferenceSpaceChanged.add(this._initHitTestSource)),this.options.enableTransientHitTest){const e=new XRRay(this.options.transientOffsetRay||{});this._xrSessionManager.session.requestHitTestSourceForTransientInput({profile:this.options.transientHitTestProfile||"generic-touchscreen",offsetRay:e,entityTypes:this.options.entityTypes}).then(t=>{this._transientXrHitTestSource=t})}return!0}detach(){return super.detach()?(this._xrHitTestSource&&(this._xrHitTestSource.cancel(),this._xrHitTestSource=null),this._xrSessionManager.onXRReferenceSpaceChanged.removeCallback(this._initHitTestSource),this._transientXrHitTestSource&&(this._transientXrHitTestSource.cancel(),this._transientXrHitTestSource=null),!0):!1}dispose(){super.dispose(),this.onHitTestResultObservable.clear()}_onXRFrame(e){if(!(!this.attached||this.paused)){if(this._xrHitTestSource){const t=e.getHitTestResults(this._xrHitTestSource);this._processWebXRHitTestResult(t)}this._transientXrHitTestSource&&e.getHitTestResultsForTransientInput(this._transientXrHitTestSource).forEach(i=>{this._processWebXRHitTestResult(i.results,i.inputSource)})}}_processWebXRHitTestResult(e,t){const i=[];e.forEach(s=>{const r=s.getPose(this._xrSessionManager.referenceSpace);if(!r)return;const n=r.transform.position,o=r.transform.orientation;this._tmpPos.set(n.x,n.y,n.z),this._tmpQuat.set(o.x,o.y,o.z,o.w),L.FromFloat32ArrayToRefScaled(r.transform.matrix,0,1,this._tmpMat),this._xrSessionManager.scene.useRightHandedSystem||(this._tmpPos.z*=-1,this._tmpQuat.z*=-1,this._tmpQuat.w*=-1,this._tmpMat.toggleModelMatrixHandInPlace());const l={position:this.autoCloneTransformation?this._tmpPos.clone():this._tmpPos,rotationQuaternion:this.autoCloneTransformation?this._tmpQuat.clone():this._tmpQuat,transformationMatrix:this.autoCloneTransformation?this._tmpMat.clone():this._tmpMat,inputSource:t,isTransient:!!t,xrHitResult:s};i.push(l)}),this.onHitTestResultObservable.notifyObservers(i)}}ml.Name=pt.HIT_TEST;ml.Version=2;ii.AddWebXRFeature(ml.Name,(a,e)=>()=>new ml(a,e),ml.Version,!1);class gl extends Ji{constructor(e){super(e),this._enabled=!1,this._featurePointCloud=[],this.onFeaturePointsAddedObservable=new X,this.onFeaturePointsUpdatedObservable=new X,this.xrNativeFeatureName="bjsfeature-points",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}get featurePointCloud(){return this._featurePointCloud}detach(){return super.detach()?(this.featurePointCloud.length=0,!0):!1}dispose(){super.dispose(),this._featurePointCloud.length=0,this.onFeaturePointsUpdatedObservable.clear(),this.onFeaturePointsAddedObservable.clear()}_onXRFrame(e){if(!this.attached||!this._enabled||!e)return;const t=e.featurePointCloud;if(!(!t||t.length===0)){if(t.length%5!==0)throw new Error("Received malformed feature point cloud of length: "+t.length);const i=t.length/5,s=new Array,r=new Array;for(let n=0;n<i;n++){const o=n*5,l=t[o+4];this._featurePointCloud[l]?s.push(l):(this._featurePointCloud[l]={position:new g,confidenceValue:0},r.push(l)),this._featurePointCloud[l].position.x=t[o],this._featurePointCloud[l].position.y=t[o+1],this._featurePointCloud[l].position.z=t[o+2],this._featurePointCloud[l].confidenceValue=t[o+3]}r.length>0&&this.onFeaturePointsAddedObservable.notifyObservers(r),s.length>0&&this.onFeaturePointsUpdatedObservable.notifyObservers(s)}}_init(){!this._xrSessionManager.session.trySetFeaturePointCloudEnabled||!this._xrSessionManager.session.trySetFeaturePointCloudEnabled(!0)||(this._enabled=!0)}}gl.Name=pt.FEATURE_POINTS;gl.Version=1;ii.AddWebXRFeature(gl.Name,a=>()=>new gl(a),gl.Version);let FM=0;class vl extends Ji{constructor(e,t={}){super(e),this._options=t,this._detectedMeshes=new Map,this.onMeshAddedObservable=new X,this.onMeshRemovedObservable=new X,this.onMeshUpdatedObservable=new X,this.xrNativeFeatureName="mesh-detection",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}detach(){return super.detach()?(!!this._xrSessionManager.isNative&&!!this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!1),this._options.doNotRemoveMeshesOnSessionEnded||(this._detectedMeshes.forEach(e=>{this.onMeshRemovedObservable.notifyObservers(e)}),this._detectedMeshes.clear()),!0):!1}dispose(){super.dispose(),this.onMeshAddedObservable.clear(),this.onMeshRemovedObservable.clear(),this.onMeshUpdatedObservable.clear()}_onXRFrame(e){var t;try{if(!this.attached||!e)return;const i=(t=e.worldInformation)===null||t===void 0?void 0:t.detectedMeshes;if(i){const s=new Set;this._detectedMeshes.forEach((r,n)=>{i.has(n)||s.add(n)}),s.forEach(r=>{const n=this._detectedMeshes.get(r);n&&(this.onMeshRemovedObservable.notifyObservers(n),this._detectedMeshes.delete(r))}),i.forEach(r=>{if(this._detectedMeshes.has(r)){if(r.lastChangedTime===this._xrSessionManager.currentTimestamp){const n=this._detectedMeshes.get(r);n&&(this._updateVertexDataWithXRMesh(r,n,e),this.onMeshUpdatedObservable.notifyObservers(n))}}else{const n={id:FM++,xrMesh:r},o=this._updateVertexDataWithXRMesh(r,n,e);this._detectedMeshes.set(r,o),this.onMeshAddedObservable.notifyObservers(o)}})}}catch(i){console.log(i.stack)}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.trySetMeshDetectorEnabled&&this._xrSessionManager.session.trySetMeshDetectorEnabled(!0),!!this._options.preferredDetectorOptions&&!!this._xrSessionManager.session.trySetPreferredMeshDetectorOptions&&this._xrSessionManager.session.trySetPreferredMeshDetectorOptions(this._options.preferredDetectorOptions))}_updateVertexDataWithXRMesh(e,t,i){if(t.xrMesh=e,t.worldParentNode=this._options.worldParentNode,this._options.convertCoordinateSystems){if(this._xrSessionManager.scene.useRightHandedSystem)t.positions=e.positions,t.normals=e.normals;else{t.positions=new Float32Array(e.positions.length);for(let r=0;r<e.positions.length;r+=3)t.positions[r]=e.positions[r],t.positions[r+1]=e.positions[r+1],t.positions[r+2]=-1*e.positions[r+2];if(e.normals){t.normals=new Float32Array(e.normals.length);for(let r=0;r<e.normals.length;r+=3)t.normals[r]=e.normals[r],t.normals[r+1]=e.normals[r+1],t.normals[r+2]=-1*e.normals[r+2]}}t.indices=e.indices;const s=i.getPose(e.meshSpace,this._xrSessionManager.referenceSpace);if(s){const r=t.transformationMatrix||new L;L.FromArrayToRef(s.transform.matrix,0,r),this._xrSessionManager.scene.useRightHandedSystem||r.toggleModelMatrixHandInPlace(),t.transformationMatrix=r,this._options.worldParentNode&&r.multiplyToRef(this._options.worldParentNode.getWorldMatrix(),r)}}return t}}vl.Name=pt.MESH_DETECTION;vl.Version=1;ii.AddWebXRFeature(vl.Name,(a,e)=>()=>new vl(a,e),vl.Version,!1);var Ur;(function(a){a[a.NotReceived=0]="NotReceived",a[a.Waiting=1]="Waiting",a[a.Received=2]="Received"})(Ur||(Ur={}));class xl extends Ji{constructor(e,t){super(e),this.options=t,this.onUntrackableImageFoundObservable=new X,this.onTrackableImageFoundObservable=new X,this.onTrackedImageUpdatedObservable=new X,this._trackableScoreStatus=Ur.NotReceived,this._trackedImages=[],this.xrNativeFeatureName="image-tracking"}attach(){return super.attach()}detach(){return super.detach()}getTrackedImageById(e){return this._trackedImages[e]||null}dispose(){super.dispose(),this._trackedImages.forEach(e=>{e.originalBitmap.close()}),this._trackedImages.length=0,this.onTrackableImageFoundObservable.clear(),this.onUntrackableImageFoundObservable.clear(),this.onTrackedImageUpdatedObservable.clear()}async getXRSessionInitExtension(){if(!this.options.images||!this.options.images.length)return{};const e=this.options.images.map(t=>typeof t.src=="string"?this._xrSessionManager.scene.getEngine()._createImageBitmapFromSource(t.src):Promise.resolve(t.src));try{const t=await Promise.all(e);return this._originalTrackingRequest=t.map((i,s)=>({image:i,widthInMeters:this.options.images[s].estimatedRealWorldWidth})),{trackedImages:this._originalTrackingRequest}}catch{return q.Error("Error loading images for tracking, WebXRImageTracking disabled for this session."),{}}}_onXRFrame(e){if(!e.getImageTrackingResults||this._trackableScoreStatus===Ur.Waiting)return;if(this._trackableScoreStatus===Ur.NotReceived){this._checkScoresAsync();return}const t=e.getImageTrackingResults();for(const i of t){let s=!1;const r=i.index,n=this._trackedImages[r];if(!n)continue;n.xrTrackingResult=i,n.realWorldWidth!==i.measuredWidthInMeters&&(n.realWorldWidth=i.measuredWidthInMeters,s=!0);const o=e.getPose(i.imageSpace,this._xrSessionManager.referenceSpace);if(o){const c=n.transformationMatrix;L.FromArrayToRef(o.transform.matrix,0,c),this._xrSessionManager.scene.useRightHandedSystem||c.toggleModelMatrixHandInPlace(),s=!0}const h=i.trackingState==="emulated";n.emulated!==h&&(n.emulated=h,s=!0),s&&this.onTrackedImageUpdatedObservable.notifyObservers(n)}}async _checkScoresAsync(){if(!this._xrSessionManager.session.getTrackedImageScores||this._trackableScoreStatus!==Ur.NotReceived)return;this._trackableScoreStatus=Ur.Waiting;const e=await this._xrSessionManager.session.getTrackedImageScores();if(!e||e.length===0){this._trackableScoreStatus=Ur.NotReceived;return}for(let t=0;t<e.length;++t)if(e[t]=="untrackable")this.onUntrackableImageFoundObservable.notifyObservers(t);else{const i=this._originalTrackingRequest[t].image,s={id:t,originalBitmap:i,transformationMatrix:new L,ratio:i.width/i.height};this._trackedImages[t]=s,this.onTrackableImageFoundObservable.notifyObservers(s)}this._trackableScoreStatus=e.length>0?Ur.Received:Ur.NotReceived}}xl.Name=pt.IMAGE_TRACKING;xl.Version=1;ii.AddWebXRFeature(xl.Name,(a,e)=>()=>new xl(a,e),xl.Version,!1);class Tl extends Ji{constructor(e,t){super(e),this.options=t,this._domOverlayType=null,this._beforeXRSelectListener=null,this._element=null,this.xrNativeFeatureName="dom-overlay",q.Warn("dom-overlay is an experimental and unstable feature.")}attach(){return!super.attach()||!this._xrSessionManager.session.domOverlayState||this._xrSessionManager.session.domOverlayState.type===null?!1:(this._domOverlayType=this._xrSessionManager.session.domOverlayState.type,this._element!==null&&this.options.supressXRSelectEvents===!0&&(this._beforeXRSelectListener=e=>{e.preventDefault()},this._element.addEventListener("beforexrselect",this._beforeXRSelectListener)),!0)}get domOverlayType(){return this._domOverlayType}dispose(){super.dispose(),this._element!==null&&this._beforeXRSelectListener&&this._element.removeEventListener("beforexrselect",this._beforeXRSelectListener)}_onXRFrame(e){}async getXRSessionInitExtension(){if(this.options.element===void 0)return q.Warn('"element" option must be provided to attach xr-dom-overlay feature.'),{};if(typeof this.options.element=="string"){const e=document.querySelector(this.options.element);if(e===null)return q.Warn(`element not found '${this.options.element}' (not requesting xr-dom-overlay)`),{};this._element=e}else this._element=this.options.element;return{domOverlay:{root:this._element}}}}Tl.Name=pt.DOM_OVERLAY;Tl.Version=1;ii.AddWebXRFeature(Tl.Name,(a,e)=>()=>new Tl(a,e),Tl.Version,!1);class Kn extends Ji{constructor(e,t){var i,s,r,n,o,l;if(super(e),this._controllers={},this._currentRegistrationConfigurations=[],this._movementDirection=null,this._tmpRotationMatrix=L.Identity(),this._tmpTranslationDirection=new g,this._tmpMovementTranslation=new g,this._attachController=h=>{if(this._controllers[h.uniqueId])return;this._controllers[h.uniqueId]={xrController:h,registeredComponents:[]};const c=this._controllers[h.uniqueId];if(c.xrController.inputSource.targetRayMode==="tracked-pointer"&&c.xrController.inputSource.gamepad){const u=()=>{if(h.motionController)for(const d of this._currentRegistrationConfigurations){let f=null;if(d.allowedComponentTypes)for(const _ of d.allowedComponentTypes){const m=h.motionController.getComponentOfType(_);if(m!==null){f=m;break}}if(d.mainComponentOnly){const _=h.motionController.getMainComponent();if(_===null)continue;f=_}if(typeof d.componentSelectionPredicate=="function"&&(f=d.componentSelectionPredicate(h)),f&&d.forceHandedness&&h.inputSource.handedness!==d.forceHandedness||f===null)continue;const p={registrationConfiguration:d,component:f};c.registeredComponents.push(p),"axisChangedHandler"in d&&(p.onAxisChangedObserver=f.onAxisValueChangedObservable.add(_=>{d.axisChangedHandler(_,this._movementState,this._featureContext,this._xrInput)})),"buttonChangedhandler"in d&&(p.onButtonChangedObserver=f.onButtonStateChangedObservable.add(()=>{f.changes.pressed&&d.buttonChangedhandler(f.changes.pressed,this._movementState,this._featureContext,this._xrInput)}))}};h.motionController?u():h.onMotionControllerInitObservable.addOnce(()=>{u()})}},!t||t.xrInput===void 0){q.Error('WebXRControllerMovement feature requires "xrInput" option.');return}Array.isArray(t.customRegistrationConfigurations)?this._currentRegistrationConfigurations=t.customRegistrationConfigurations:this._currentRegistrationConfigurations=Kn.REGISTRATIONS.default,this._featureContext={movementEnabled:t.movementEnabled||!0,movementOrientationFollowsViewerPose:(i=t.movementOrientationFollowsViewerPose)!==null&&i!==void 0?i:!0,movementSpeed:(s=t.movementSpeed)!==null&&s!==void 0?s:1,movementThreshold:(r=t.movementThreshold)!==null&&r!==void 0?r:.25,rotationEnabled:(n=t.rotationEnabled)!==null&&n!==void 0?n:!0,rotationSpeed:(o=t.rotationSpeed)!==null&&o!==void 0?o:1,rotationThreshold:(l=t.rotationThreshold)!==null&&l!==void 0?l:.25},this._movementState={moveX:0,moveY:0,rotateX:0,rotateY:0},this._xrInput=t.xrInput}get movementDirection(){return this._movementDirection}get movementEnabled(){return this._featureContext.movementEnabled}set movementEnabled(e){this._featureContext.movementEnabled=e}get movementOrientationFollowsViewerPose(){return this._featureContext.movementOrientationFollowsViewerPose}set movementOrientationFollowsViewerPose(e){this._featureContext.movementOrientationFollowsViewerPose=e}get movementSpeed(){return this._featureContext.movementSpeed}set movementSpeed(e){this._featureContext.movementSpeed=e}get movementThreshold(){return this._featureContext.movementThreshold}set movementThreshold(e){this._featureContext.movementThreshold=e}get rotationEnabled(){return this._featureContext.rotationEnabled}set rotationEnabled(e){this._featureContext.rotationEnabled=e}get rotationSpeed(){return this._featureContext.rotationSpeed}set rotationSpeed(e){this._featureContext.rotationSpeed=e}get rotationThreshold(){return this._featureContext.rotationThreshold}set rotationThreshold(e){this._featureContext.rotationThreshold=e}attach(){return super.attach()?(this._xrInput.controllers.forEach(this._attachController),this._addNewAttachObserver(this._xrInput.onControllerAddedObservable,this._attachController),this._addNewAttachObserver(this._xrInput.onControllerRemovedObservable,e=>{this._detachController(e.uniqueId)}),!0):!1}detach(){return super.detach()?(Object.keys(this._controllers).forEach(e=>{this._detachController(e)}),this._controllers={},!0):!1}_onXRFrame(e){if(!!this.attach){if(this._movementDirection===null&&(this._movementDirection=this._xrInput.xrCamera.rotationQuaternion.clone()),this._movementState.rotateX!==0&&this._featureContext.rotationEnabled){const i=this._xrSessionManager.scene.getEngine().getDeltaTime()*.001*this._featureContext.rotationSpeed*this._movementState.rotateX*(this._xrSessionManager.scene.useRightHandedSystem?-1:1);this._featureContext.movementOrientationFollowsViewerPose===!0?(this._xrInput.xrCamera.cameraRotation.y+=i,this._movementDirection=this._xrInput.xrCamera.rotationQuaternion.multiply(Q.RotationYawPitchRoll(i,0,0))):this._movementDirection.multiplyInPlace(Q.RotationYawPitchRoll(i*3,0,0))}else this._featureContext.movementOrientationFollowsViewerPose===!0&&this._movementDirection.copyFrom(this._xrInput.xrCamera.rotationQuaternion);(this._movementState.moveX!==0||this._movementState.moveY!==0)&&this._featureContext.movementEnabled&&(L.FromQuaternionToRef(this._movementDirection,this._tmpRotationMatrix),this._tmpTranslationDirection.set(this._movementState.moveX,0,this._movementState.moveY*(this._xrSessionManager.scene.useRightHandedSystem?1:-1)),g.TransformCoordinatesToRef(this._tmpTranslationDirection,this._tmpRotationMatrix,this._tmpMovementTranslation),this._tmpMovementTranslation.scaleInPlace(this._xrInput.xrCamera._computeLocalCameraSpeed()*this._featureContext.movementSpeed),this._xrInput.xrCamera.cameraDirection.addInPlace(this._tmpMovementTranslation))}}_detachController(e){const t=this._controllers[e];if(!!t){for(const i of t.registeredComponents)i.onAxisChangedObserver&&i.component.onAxisValueChangedObservable.remove(i.onAxisChangedObserver),i.onButtonChangedObserver&&i.component.onButtonStateChangedObservable.remove(i.onButtonChangedObserver);delete this._controllers[e]}}}Kn.Name=pt.MOVEMENT;Kn.REGISTRATIONS={default:[{allowedComponentTypes:[zs.THUMBSTICK_TYPE,zs.TOUCHPAD_TYPE],forceHandedness:"left",axisChangedHandler:(a,e,t)=>{e.rotateX=Math.abs(a.x)>t.rotationThreshold?a.x:0,e.rotateY=Math.abs(a.y)>t.rotationThreshold?a.y:0}},{allowedComponentTypes:[zs.THUMBSTICK_TYPE,zs.TOUCHPAD_TYPE],forceHandedness:"right",axisChangedHandler:(a,e,t)=>{e.moveX=Math.abs(a.x)>t.movementThreshold?a.x:0,e.moveY=Math.abs(a.y)>t.movementThreshold?a.y:0}}]};Kn.Version=1;ii.AddWebXRFeature(Kn.Name,(a,e)=>()=>new Kn(a,e),Kn.Version,!0);class bl extends Ji{constructor(e,t){super(e),this.options=t,this._canvasContext=null,this._reflectionCubeMap=null,this._xrLightEstimate=null,this._xrLightProbe=null,this._xrWebGLBinding=null,this._lightDirection=g.Up().negateInPlace(),this._lightColor=re.White(),this._intensity=1,this._sphericalHarmonics=new Do,this._cubeMapPollTime=Date.now(),this._lightEstimationPollTime=Date.now(),this._reflectionCubeMapTextureSize=16,this.directionalLight=null,this.onReflectionCubeMapUpdatedObservable=new X,this._updateReflectionCubeMap=()=>{var i;if(!this._xrLightProbe)return;if(this.options.cubeMapPollInterval){const r=Date.now();if(r-this._cubeMapPollTime<this.options.cubeMapPollInterval)return;this._cubeMapPollTime=r}const s=this._getXRGLBinding().getReflectionCubeMap(this._xrLightProbe);if(s&&this._reflectionCubeMap){if(this._reflectionCubeMap._texture)(i=this._reflectionCubeMap._texture._hardwareTexture)===null||i===void 0||i.set(s),this._reflectionCubeMap._texture.getEngine().resetTextureCache();else{const r=new gt(this._xrSessionManager.scene.getEngine(),We.Unknown);r.isCube=!0,r.invertY=!1,r._useSRGBBuffer=this.options.reflectionFormat==="srgba8",r.format=5,r.generateMipMaps=!0,r.type=this.options.reflectionFormat!=="srgba8"?2:0,r.samplingMode=3,r.width=this._reflectionCubeMapTextureSize,r.height=this._reflectionCubeMapTextureSize,r._cachedWrapU=1,r._cachedWrapV=1,r._hardwareTexture=new zl(s,this._getCanvasContext()),this._reflectionCubeMap._texture=r}this._reflectionCubeMap._texture.isReady=!0,this._xrSessionManager.scene.markAllMaterialsAsDirty(1),this.onReflectionCubeMapUpdatedObservable.notifyObservers(this._reflectionCubeMap)}},this.xrNativeFeatureName="light-estimation",this.options.createDirectionalLightSource&&(this.directionalLight=new Jr("light estimation directional",this._lightDirection,this._xrSessionManager.scene),this.directionalLight.position=new g(0,8,0),this.directionalLight.intensity=0,this.directionalLight.falloffType=Tt.FALLOFF_GLTF),q.Warn("light-estimation is an experimental and unstable feature.")}get reflectionCubeMapTexture(){return this._reflectionCubeMap}get xrLightingEstimate(){return this._xrLightEstimate?{lightColor:this._lightColor,lightDirection:this._lightDirection,lightIntensity:this._intensity,sphericalHarmonics:this._sphericalHarmonics}:this._xrLightEstimate}_getCanvasContext(){return this._canvasContext===null&&(this._canvasContext=this._xrSessionManager.scene.getEngine()._gl),this._canvasContext}_getXRGLBinding(){if(this._xrWebGLBinding===null){const e=this._getCanvasContext();this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,e)}return this._xrWebGLBinding}attach(){var e;if(!super.attach())return!1;const t=(e=this.options.reflectionFormat)!==null&&e!==void 0?e:this._xrSessionManager.session.preferredReflectionFormat||"srgba8";return this.options.reflectionFormat=t,this._xrSessionManager.session.requestLightProbe({reflectionFormat:t}).then(i=>{this._xrLightProbe=i,this.options.disableCubeMapReflection||(this._reflectionCubeMap||(this._reflectionCubeMap=new dt(this._xrSessionManager.scene),this._reflectionCubeMap._isCube=!0,this._reflectionCubeMap.coordinatesMode=3,this.options.setSceneEnvironmentTexture&&(this._xrSessionManager.scene.environmentTexture=this._reflectionCubeMap)),this._xrLightProbe.addEventListener("reflectionchange",this._updateReflectionCubeMap))}),!0}detach(){const e=super.detach();return this._xrLightProbe!==null&&!this.options.disableCubeMapReflection&&(this._xrLightProbe.removeEventListener("reflectionchange",this._updateReflectionCubeMap),this._xrLightProbe=null),this._canvasContext=null,this._xrLightEstimate=null,this._xrWebGLBinding=null,e}dispose(){super.dispose(),this.onReflectionCubeMapUpdatedObservable.clear(),this.directionalLight&&(this.directionalLight.dispose(),this.directionalLight=null),this._reflectionCubeMap!==null&&(this._reflectionCubeMap._texture&&this._reflectionCubeMap._texture.dispose(),this._reflectionCubeMap.dispose(),this._reflectionCubeMap=null)}_onXRFrame(e){var t;if(this._xrLightProbe!==null){if(this.options.lightEstimationPollInterval){const i=Date.now();if(i-this._lightEstimationPollTime<this.options.lightEstimationPollInterval)return;this._lightEstimationPollTime=i}if(this._xrLightEstimate=e.getLightEstimate(this._xrLightProbe),this._xrLightEstimate){this._intensity=Math.max(1,this._xrLightEstimate.primaryLightIntensity.x,this._xrLightEstimate.primaryLightIntensity.y,this._xrLightEstimate.primaryLightIntensity.z);const i=this._xrSessionManager.scene.useRightHandedSystem?1:-1;this.options.disableVectorReuse&&(this._lightDirection=new g,this._lightColor=new re,this.directionalLight&&(this.directionalLight.direction=this._lightDirection,this.directionalLight.diffuse=this._lightColor)),this._lightDirection.copyFromFloats(this._xrLightEstimate.primaryLightDirection.x,this._xrLightEstimate.primaryLightDirection.y,this._xrLightEstimate.primaryLightDirection.z*i),this._lightColor.copyFromFloats(this._xrLightEstimate.primaryLightIntensity.x/this._intensity,this._xrLightEstimate.primaryLightIntensity.y/this._intensity,this._xrLightEstimate.primaryLightIntensity.z/this._intensity),this._sphericalHarmonics.updateFromFloatsArray(this._xrLightEstimate.sphericalHarmonicsCoefficients),this._reflectionCubeMap&&!this.options.disableSphericalPolynomial&&(this._reflectionCubeMap.sphericalPolynomial=this._reflectionCubeMap.sphericalPolynomial||new sa,(t=this._reflectionCubeMap.sphericalPolynomial)===null||t===void 0||t.updateFromHarmonics(this._sphericalHarmonics)),this._lightDirection.negateInPlace(),this.directionalLight&&(this.directionalLight.direction.copyFrom(this._lightDirection),this.directionalLight.intensity=Math.min(this._intensity,1),this.directionalLight.diffuse.copyFrom(this._lightColor))}}}}bl.Name=pt.LIGHT_ESTIMATION;bl.Version=1;ii.AddWebXRFeature(bl.Name,(a,e)=>()=>new bl(a,e),bl.Version,!1);class Sl extends Ji{constructor(e){super(e),this.onEyeTrackingStartedObservable=new X,this.onEyeTrackingEndedObservable=new X,this.onEyeTrackingFrameUpdateObservable=new X,this._eyeTrackingStartListener=t=>{this._latestEyeSpace=t.gazeSpace,this._gazeRay=new $e(g.Zero(),g.Forward()),this.onEyeTrackingStartedObservable.notifyObservers(this._gazeRay)},this._eyeTrackingEndListener=()=>{this._latestEyeSpace=null,this._gazeRay=null,this.onEyeTrackingEndedObservable.notifyObservers()},this.xrNativeFeatureName="eye-tracking",this._xrSessionManager.session?this._init():this._xrSessionManager.onXRSessionInit.addOnce(()=>{this._init()})}dispose(){super.dispose(),this._xrSessionManager.session.removeEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.removeEventListener("eyetrackingend",this._eyeTrackingEndListener),this.onEyeTrackingStartedObservable.clear(),this.onEyeTrackingEndedObservable.clear(),this.onEyeTrackingFrameUpdateObservable.clear()}get isEyeGazeValid(){return!!this._gazeRay}getEyeGaze(){return this._gazeRay}_onXRFrame(e){if(!(!this.attached||!e)&&this._latestEyeSpace&&this._gazeRay){const t=e.getPose(this._latestEyeSpace,this._xrSessionManager.referenceSpace);if(t){this._gazeRay.origin.set(t.transform.position.x,t.transform.position.y,t.transform.position.z);const i=t.transform.orientation;G.Quaternion[0].set(i.x,i.y,i.z,i.w),this._xrSessionManager.scene.useRightHandedSystem?g.RightHandedForwardReadOnly.rotateByQuaternionToRef(G.Quaternion[0],this._gazeRay.direction):(this._gazeRay.origin.z*=-1,G.Quaternion[0].z*=-1,G.Quaternion[0].w*=-1,g.LeftHandedForwardReadOnly.rotateByQuaternionToRef(G.Quaternion[0],this._gazeRay.direction)),this.onEyeTrackingFrameUpdateObservable.notifyObservers(this._gazeRay)}}}_init(){this._xrSessionManager.isNative&&(this._xrSessionManager.session.addEventListener("eyetrackingstart",this._eyeTrackingStartListener),this._xrSessionManager.session.addEventListener("eyetrackingend",this._eyeTrackingEndListener))}}Sl.Name=pt.EYE_TRACKING;Sl.Version=1;ii.AddWebXRFeature(Sl.Name,a=>()=>new Sl(a),Sl.Version,!1);class LM{constructor(e,t){this._samples=[],this._idx=0;for(let i=0;i<e;++i)this._samples.push(t?t():le.Zero())}get length(){return this._samples.length}push(e,t){this._idx=(this._idx+this._samples.length-1)%this._samples.length,this.at(0).copyFromFloats(e,t)}at(e){if(e>=this._samples.length)throw new Error("Index out of bounds");return this._samples[(this._idx+e)%this._samples.length]}}class BM{constructor(){this._samples=new LM(20),this._entropy=0,this.onFirstStepDetected=new X}update(e,t,i,s){this._samples.push(e,t);const r=this._samples.at(0);if(this._entropy*=this._entropyDecayFactor,this._entropy+=le.Distance(r,this._samples.at(1)),this._entropy>this._entropyThreshold)return;let n;for(n=this._samePointCheckStartIdx;n<this._samples.length&&!(le.DistanceSquared(r,this._samples.at(n))<this._samePointSquaredDistanceThreshold);++n);if(n===this._samples.length)return;let o=-1,l=0;for(let S,C=1;C<n;++C)S=le.DistanceSquared(r,this._samples.at(C)),S>o&&(l=C,o=S);if(o<this._apexSquaredDistanceThreshold)return;const h=this._samples.at(l),c=h.subtract(r);c.normalize();const u=G.Vector2[0];let d,f,p=0;for(let S=1;S<n;++S)f=this._samples.at(S),f.subtractToRef(r,u),d=le.Dot(c,u),p+=u.lengthSquared()-d*d;if(p>n*this._squaredProjectionDistanceThreshold)return;const _=G.Vector3[0];_.set(i,s,0);const m=G.Vector3[1];m.set(c.x,c.y,0);const v=g.Cross(_,m).z>0,x=r.clone(),b=r.clone();h.subtractToRef(r,c),v?(c.scaleAndAddToRef(this._axisToApexShrinkFactor,x),c.scaleAndAddToRef(this._axisToApexExtendFactor,b)):(c.scaleAndAddToRef(this._axisToApexExtendFactor,x),c.scaleAndAddToRef(this._axisToApexShrinkFactor,b)),this.onFirstStepDetected.notifyObservers({leftApex:x,rightApex:b,currentPosition:r,currentStepDirection:v?"right":"left"})}reset(){for(let e=0;e<this._samples.length;++e)this._samples.at(e).copyFromFloats(0,0)}get _samePointCheckStartIdx(){return Math.floor(this._samples.length/3)}get _samePointSquaredDistanceThreshold(){return .03*.03}get _apexSquaredDistanceThreshold(){return .09*.09}get _squaredProjectionDistanceThreshold(){return .03*.03}get _axisToApexShrinkFactor(){return .8}get _axisToApexExtendFactor(){return-1.6}get _entropyDecayFactor(){return .93}get _entropyThreshold(){return .4}}class UM{constructor(e,t,i,s){this._leftApex=new le,this._rightApex=new le,this._currentPosition=new le,this._axis=new le,this._axisLength=-1,this._forward=new le,this._steppingLeft=!1,this._t=-1,this._maxT=-1,this._maxTPosition=new le,this._vitality=0,this.onMovement=new X,this.onFootfall=new X,this._reset(e,t,i,s==="left")}_reset(e,t,i,s){this._leftApex.copyFrom(e),this._rightApex.copyFrom(t),this._steppingLeft=s,this._steppingLeft?(this._leftApex.subtractToRef(this._rightApex,this._axis),this._forward.copyFromFloats(-this._axis.y,this._axis.x)):(this._rightApex.subtractToRef(this._leftApex,this._axis),this._forward.copyFromFloats(this._axis.y,-this._axis.x)),this._axisLength=this._axis.length(),this._forward.scaleInPlace(1/this._axisLength),this._updateTAndVitality(i.x,i.y),this._maxT=this._t,this._maxTPosition.copyFrom(i),this._vitality=1}_updateTAndVitality(e,t){this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._currentPosition.subtractInPlace(this._rightApex):this._currentPosition.subtractInPlace(this._leftApex);const i=this._t,s=le.Dot(this._currentPosition,this._axis);this._t=s/(this._axisLength*this._axisLength);const r=this._currentPosition.lengthSquared()-s/this._axisLength*(s/this._axisLength);this._vitality*=.92-100*Math.max(r-.0016,0)+Math.max(this._t-i,0)}update(e,t){if(this._vitality<this._vitalityThreshold)return!1;const i=this._t;return this._updateTAndVitality(e,t),this._t>this._maxT&&(this._maxT=this._t,this._maxTPosition.copyFromFloats(e,t)),!(this._vitality<this._vitalityThreshold||(this._t>i&&(this.onMovement.notifyObservers({deltaT:this._t-i}),i<.5&&this._t>=.5&&this.onFootfall.notifyObservers({foot:this._steppingLeft?"left":"right"})),this._t<.95*this._maxT&&(this._currentPosition.copyFromFloats(e,t),this._steppingLeft?this._leftApex.copyFrom(this._maxTPosition):this._rightApex.copyFrom(this._maxTPosition),this._reset(this._leftApex,this._rightApex,this._currentPosition,!this._steppingLeft)),this._axisLength<.03))}get _vitalityThreshold(){return .1}get forward(){return this._forward}}class El{constructor(e){this._detector=new BM,this._walker=null,this._movement=new le,this._millisecondsSinceLastUpdate=El._MillisecondsPerUpdate,this.movementThisFrame=g.Zero(),this._engine=e,this._detector.onFirstStepDetected.add(t=>{this._walker||(this._walker=new UM(t.leftApex,t.rightApex,t.currentPosition,t.currentStepDirection),this._walker.onFootfall.add(()=>{console.log("Footfall!")}),this._walker.onMovement.add(i=>{this._walker.forward.scaleAndAddToRef(.024*i.deltaT,this._movement)}))})}static get _MillisecondsPerUpdate(){return 1e3/15}update(e,t){t.y=0,t.normalize(),this._millisecondsSinceLastUpdate+=this._engine.getDeltaTime(),this._millisecondsSinceLastUpdate>=El._MillisecondsPerUpdate&&(this._millisecondsSinceLastUpdate-=El._MillisecondsPerUpdate,this._detector.update(e.x,e.z,t.x,t.z),this._walker&&(this._walker.update(e.x,e.z)||(this._walker=null)),this._movement.scaleInPlace(.85)),this.movementThisFrame.set(this._movement.x,0,this._movement.y)}}class ku extends Ji{constructor(e,t){super(e),this._up=new g,this._forward=new g,this._position=new g,this._movement=new g,this._sessionManager=e,this.locomotionTarget=t.locomotionTarget,this._isLocomotionTargetWebXRCamera&&B.Warn("Using walking locomotion directly on a WebXRCamera may have unintended interactions with other XR techniques. Using an XR space parent is highly recommended")}static get Name(){return pt.WALKING_LOCOMOTION}static get Version(){return 1}get locomotionTarget(){return this._locomotionTarget}set locomotionTarget(e){this._locomotionTarget=e,this._isLocomotionTargetWebXRCamera=this._locomotionTarget.getClassName()==="WebXRCamera"}isCompatible(){return this._sessionManager.sessionMode===void 0||this._sessionManager.sessionMode==="immersive-vr"}attach(){return!this.isCompatible||!super.attach()?!1:(this._walker=new El(this._sessionManager.scene.getEngine()),!0)}detach(){return super.detach()?(this._walker=null,!0):!1}_onXRFrame(e){const t=e.getViewerPose(this._sessionManager.baseReferenceSpace);if(!t)return;const i=this.locomotionTarget.getScene().useRightHandedSystem?1:-1,s=t.transform.matrix;this._up.copyFromFloats(s[4],s[5],i*s[6]),this._forward.copyFromFloats(s[8],s[9],i*s[10]),this._position.copyFromFloats(s[12],s[13],i*s[14]),this._forward.scaleAndAddToRef(.05,this._position),this._up.scaleAndAddToRef(-.05,this._position),this._walker.update(this._position,this._forward),this._movement.copyFrom(this._walker.movementThisFrame),this._isLocomotionTargetWebXRCamera||g.TransformNormalToRef(this._movement,this.locomotionTarget.getWorldMatrix(),this._movement),this.locomotionTarget.position.addInPlace(this._movement)}}ii.AddWebXRFeature(ku.Name,(a,e)=>()=>new ku(a,e),ku.Version,!1);class VM extends qd{constructor(e,t,i,s,r,n){super(e,t,i,s,n),this.getWidth=e,this.getHeight=t,this.layer=i,this.layerType=s,this.isMultiview=r,this.createRTTProvider=n}}class kM extends Qd{constructor(e,t,i){super(e.scene,i),this._xrSessionManager=e,this._xrWebGLBinding=t,this.layerWrapper=i,this._lastSubImages=new Map,this._compositionLayer=i.layer}_getRenderTargetForSubImage(e,t){const i=this._lastSubImages.get(t),s=t=="left"?0:1;return(!this._renderTargetTextures[s]||(i==null?void 0:i.textureWidth)!==e.textureWidth||(i==null?void 0:i.textureHeight)!=e.textureHeight)&&(this._renderTargetTextures[s]=this._createRenderTargetTexture(e.textureWidth,e.textureHeight,null,e.colorTexture,e.depthStencilTexture,this.layerWrapper.isMultiview),this._framebufferDimensions={framebufferWidth:e.textureWidth,framebufferHeight:e.textureHeight}),this._lastSubImages.set(t,e),this._renderTargetTextures[s]}_getSubImageForEye(e){const t=this._xrSessionManager.currentFrame;return t?this._xrWebGLBinding.getSubImage(this._compositionLayer,t,e):null}getRenderTargetTextureForEye(e){const t=this._getSubImageForEye(e);return t?this._getRenderTargetForSubImage(t,e):null}getRenderTargetTextureForView(e){return this.getRenderTargetTextureForEye(e.eye)}_setViewportForSubImage(e,t){const i=t.textureWidth,s=t.textureHeight,r=t.viewport;e.x=r.x/i,e.y=r.y/s,e.width=r.width/i,e.height=r.height/s}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForEye(t.eye);return i?(this._setViewportForSubImage(e,i),!0):!1}}class GM extends VM{constructor(e,t,i){super(()=>e.textureWidth,()=>e.textureHeight,e,"XRProjectionLayer",t,s=>new zM(s,i,this)),this.layer=e}}class zM extends kM{constructor(e,t,i){super(e,t,i),this.layerWrapper=i,this._projectionLayer=i.layer}_getSubImageForView(e){return this._xrWebGLBinding.getViewSubImage(this._projectionLayer,e)}getRenderTargetTextureForView(e){return this._getRenderTargetForSubImage(this._getSubImageForView(e),e.eye)}getRenderTargetTextureForEye(e){const t=this._lastSubImages.get(e);return t?this._getRenderTargetForSubImage(t,e):null}trySetViewportForView(e,t){const i=this._lastSubImages.get(t.eye)||this._getSubImageForView(t);return i?(this._setViewportForSubImage(e,i),!0):!1}}const WM={},xp={textureType:"texture",colorFormat:6408,depthFormat:35056,scaleFactor:1};class Cl extends Ji{constructor(e,t={}){super(e),this._options=t,this._existingLayers=[],this.xrNativeFeatureName="layers"}attach(){if(!super.attach())return!1;const e=this._xrSessionManager.scene.getEngine();this._glContext=e._gl,this._xrWebGLBinding=new XRWebGLBinding(this._xrSessionManager.session,this._glContext),this._existingLayers.length=0;const t={...xp},i=this._options.preferMultiviewOnInit&&e.getCaps().multiview;return i&&(t.textureType="texture-array"),this.addXRSessionLayer(this.createProjectionLayer(t,i)),!0}detach(){return super.detach()?(this._existingLayers.length=0,!0):!1}createXRWebGLLayer(e=WM){const t=new XRWebGLLayer(this._xrSessionManager.session,this._glContext,e);return new Zd(t)}createProjectionLayer(e=xp,t=!1){if(t&&e.textureType!=="texture-array")throw new Error("Projection layers can only be made multiview if they use texture arrays. Set the textureType parameter to 'texture-array'.");if(!t&&e.textureType==="texture-array")throw new Error("We currently only support multiview rendering when the textureType parameter is set to 'texture-array'.");const i=this._xrWebGLBinding.createProjectionLayer(e);return new GM(i,t,this._xrWebGLBinding)}addXRSessionLayer(e){this.setXRSessionLayers([...this._existingLayers,e])}setXRSessionLayers(e){this._existingLayers=e;const t={...this._xrSessionManager.session.renderState};t.baseLayer=void 0,t.layers=e.map(i=>i.layer),this._xrSessionManager.updateRenderState(t),this._xrSessionManager._setBaseLayerWrapper(e.length>0?e[0]:null)}isCompatible(){return!this._xrSessionManager.isNative&&typeof XRWebGLBinding<"u"&&!!XRWebGLBinding.prototype.createProjectionLayer}dispose(){super.dispose()}_onXRFrame(e){}}Cl.Name=pt.LAYERS;Cl.Version=1;ii.AddWebXRFeature(Cl.Name,(a,e)=>()=>new Cl(a,e),Cl.Version,!1);class HM extends Ho{constructor(e,t,i){super(e,XM[i],t,i,!0),this.profileId="generic-hand-select-grasp"}_getFilenameAndPath(){return{filename:"generic.babylon",path:"https://controllers.babylonjs.com/generic/"}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){}_setRootMesh(e){}_updateModel(){}}Mi.RegisterController("generic-hand-select-grasp",(a,e)=>new HM(e,a.gamepad,a.handedness));const XM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-right",assetPath:"right.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr-standard-trigger",visualResponses:{}},grasp:{type:"trigger",gamepadIndices:{button:4},rootNodeName:"grasp",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"generic-hand-select-grasp-none",assetPath:"none.glb"}};class $n extends Ho{constructor(e,t,i){super(e,YM["left-right"],t,i),this._mapping={defaultButton:{valueNodeName:"VALUE",unpressedNodeName:"UNPRESSED",pressedNodeName:"PRESSED"},defaultAxis:{valueNodeName:"VALUE",minNodeName:"MIN",maxNodeName:"MAX"},buttons:{"xr-standard-trigger":{rootNodeName:"SELECT",componentProperty:"button",states:["default","touched","pressed"]},"xr-standard-squeeze":{rootNodeName:"GRASP",componentProperty:"state",states:["pressed"]},"xr-standard-touchpad":{rootNodeName:"TOUCHPAD_PRESS",labelAnchorNodeName:"squeeze-label",touchPointNodeName:"TOUCH"},"xr-standard-thumbstick":{rootNodeName:"THUMBSTICK_PRESS",componentProperty:"state",states:["pressed"]}},axes:{"xr-standard-touchpad":{"x-axis":{rootNodeName:"TOUCHPAD_TOUCH_X"},"y-axis":{rootNodeName:"TOUCHPAD_TOUCH_Y"}},"xr-standard-thumbstick":{"x-axis":{rootNodeName:"THUMBSTICK_X"},"y-axis":{rootNodeName:"THUMBSTICK_Y"}}}},this.profileId="microsoft-mixed-reality"}_getFilenameAndPath(){let e="";this.handedness==="left"?e=$n.MODEL_LEFT_FILENAME:e=$n.MODEL_RIGHT_FILENAME;const t="default",i=$n.MODEL_BASE_URL+t+"/";return{filename:e,path:i}}_getModelLoadingConstraints(){const e=Be.IsPluginForExtensionAvailable(".glb");return e||B.Warn("glTF / glb loaded was not registered, using generic controller instead"),e}_processLoadedModel(e){!this.rootMesh||(this.getComponentIds().forEach((t,i)=>{if(!this.disableAnimation&&t&&this.rootMesh){const s=this._mapping.buttons[t],r=s.rootNodeName;if(!r){B.Log("Skipping unknown button at index: "+i+" with mapped name: "+t);return}const n=this._getChildByName(this.rootMesh,r);if(!n){B.Warn("Missing button mesh with name: "+r);return}if(s.valueMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.valueNodeName),s.pressedMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.pressedNodeName),s.unpressedMesh=this._getImmediateChildByName(n,this._mapping.defaultButton.unpressedNodeName),s.valueMesh&&s.pressedMesh&&s.unpressedMesh){const o=this.getComponent(t);o&&o.onButtonStateChangedObservable.add(l=>{this._lerpTransform(s,l.value)},void 0,!0)}else B.Warn("Missing button submesh under mesh with name: "+r)}}),this.getComponentIds().forEach(t=>{const i=this.getComponent(t);!i.isAxes()||["x-axis","y-axis"].forEach(s=>{if(!this.rootMesh)return;const r=this._mapping.axes[t][s],n=this._getChildByName(this.rootMesh,r.rootNodeName);if(!n){B.Warn("Missing axis mesh with name: "+r.rootNodeName);return}r.valueMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.valueNodeName),r.minMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.minNodeName),r.maxMesh=this._getImmediateChildByName(n,this._mapping.defaultAxis.maxNodeName),r.valueMesh&&r.minMesh&&r.maxMesh?i&&i.onAxisValueChangedObservable.add(o=>{const l=s==="x-axis"?o.x:o.y;this._lerpTransform(r,l,!0)},void 0,!0):B.Warn("Missing axis submesh under mesh with name: "+r.rootNodeName)})}))}_setRootMesh(e){this.rootMesh=new V(this.profileId+" "+this.handedness,this.scene),this.rootMesh.isPickable=!1;let t;for(let i=0;i<e.length;i++){const s=e[i];s.isPickable=!1,s.parent||(t=s)}t&&t.setParent(this.rootMesh),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}$n.MODEL_BASE_URL="https://controllers.babylonjs.com/microsoft/";$n.MODEL_LEFT_FILENAME="left.glb";$n.MODEL_RIGHT_FILENAME="right.glb";Mi.RegisterController("windows-mixed-reality",(a,e)=>new $n(e,a.gamepad,a.handedness));const YM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{xr_standard_trigger_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_trigger_pressed_value",minNodeName:"xr_standard_trigger_pressed_min",maxNodeName:"xr_standard_trigger_pressed_max"}}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{xr_standard_squeeze_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_squeeze_pressed_value",minNodeName:"xr_standard_squeeze_pressed_min",maxNodeName:"xr_standard_squeeze_pressed_max"}}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{xr_standard_touchpad_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_pressed_value",minNodeName:"xr_standard_touchpad_pressed_min",maxNodeName:"xr_standard_touchpad_pressed_max"},xr_standard_touchpad_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_pressed_value",minNodeName:"xr_standard_touchpad_xaxis_pressed_min",maxNodeName:"xr_standard_touchpad_xaxis_pressed_max"},xr_standard_touchpad_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_pressed_value",minNodeName:"xr_standard_touchpad_yaxis_pressed_min",maxNodeName:"xr_standard_touchpad_yaxis_pressed_max"},xr_standard_touchpad_xaxis_touched:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_xaxis_touched_value",minNodeName:"xr_standard_touchpad_xaxis_touched_min",maxNodeName:"xr_standard_touchpad_xaxis_touched_max"},xr_standard_touchpad_yaxis_touched:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_touchpad_yaxis_touched_value",minNodeName:"xr_standard_touchpad_yaxis_touched_min",maxNodeName:"xr_standard_touchpad_yaxis_touched_max"},xr_standard_touchpad_axes_touched:{componentProperty:"state",states:["touched","pressed"],valueNodeProperty:"visibility",valueNodeName:"xr_standard_touchpad_axes_touched_value"}},touchPointNodeName:"xr_standard_touchpad_axes_touched_value"},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{xr_standard_thumbstick_pressed:{componentProperty:"button",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_pressed_value",minNodeName:"xr_standard_thumbstick_pressed_min",maxNodeName:"xr_standard_thumbstick_pressed_max"},xr_standard_thumbstick_xaxis_pressed:{componentProperty:"xAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_xaxis_pressed_value",minNodeName:"xr_standard_thumbstick_xaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_xaxis_pressed_max"},xr_standard_thumbstick_yaxis_pressed:{componentProperty:"yAxis",states:["default","touched","pressed"],valueNodeProperty:"transform",valueNodeName:"xr_standard_thumbstick_yaxis_pressed_value",minNodeName:"xr_standard_thumbstick_yaxis_pressed_min",maxNodeName:"xr_standard_thumbstick_yaxis_pressed_max"}}}},gamepadMapping:"xr-standard",rootNodeName:"microsoft-mixed-reality-right",assetPath:"right.glb"}};class Mr extends Ho{constructor(e,t,i,s=!1,r=!1){super(e,KM[i],t,i),this._forceLegacyControllers=r,this.profileId="oculus-touch"}_getFilenameAndPath(){let e="";this.handedness==="left"?e=Mr.MODEL_LEFT_FILENAME:e=Mr.MODEL_RIGHT_FILENAME;const t=this._isQuest()?Mr.QUEST_MODEL_BASE_URL:Mr.MODEL_BASE_URL;return{filename:e,path:t}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){const t=this._isQuest(),i=this.handedness==="right"?-1:1;this.getComponentIds().forEach(s=>{const r=s&&this.getComponent(s);r&&r.onButtonStateChangedObservable.add(n=>{if(!(!this.rootMesh||this.disableAnimation))switch(s){case"xr-standard-trigger":t||(this._modelRootNode.getChildren()[3].rotation.x=-n.value*.2,this._modelRootNode.getChildren()[3].position.y=-n.value*.005,this._modelRootNode.getChildren()[3].position.z=-n.value*.005);return;case"xr-standard-squeeze":t||(this._modelRootNode.getChildren()[4].position.x=i*n.value*.0035);return;case"xr-standard-thumbstick":return;case"a-button":case"x-button":t||(n.pressed?this._modelRootNode.getChildren()[1].position.y=-.001:this._modelRootNode.getChildren()[1].position.y=0);return;case"b-button":case"y-button":t||(n.pressed?this._modelRootNode.getChildren()[2].position.y=-.001:this._modelRootNode.getChildren()[2].position.y=0);return}},void 0,!0)})}_setRootMesh(e){this.rootMesh=new V(this.profileId+" "+this.handedness,this.scene),this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0)),e.forEach(t=>{t.isPickable=!1}),this._isQuest()?this._modelRootNode=e[0]:(this._modelRootNode=e[1],this.rootMesh.position.y=.034,this.rootMesh.position.z=.052),this._modelRootNode.parent=this.rootMesh}_updateModel(){}_isQuest(){return!!navigator.userAgent.match(/Quest/gi)&&!this._forceLegacyControllers}}Mr.MODEL_BASE_URL="https://controllers.babylonjs.com/oculus/";Mr.MODEL_LEFT_FILENAME="left.babylon";Mr.MODEL_RIGHT_FILENAME="right.babylon";Mr.QUEST_MODEL_BASE_URL="https://controllers.babylonjs.com/oculusQuest/";Mi.RegisterController("oculus-touch",(a,e)=>new Mr(e,a.gamepad,a.handedness));Mi.RegisterController("oculus-touch-legacy",(a,e)=>new Mr(e,a.gamepad,a.handedness,!0));const KM={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"x-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"x_button",visualResponses:{}},"y-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"y_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-left",assetPath:"left.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-thumbstick":{type:"thumbstick",gamepadIndices:{button:3,xAxis:2,yAxis:3},rootNodeName:"xr_standard_thumbstick",visualResponses:{}},"a-button":{type:"button",gamepadIndices:{button:4},rootNodeName:"a_button",visualResponses:{}},"b-button":{type:"button",gamepadIndices:{button:5},rootNodeName:"b_button",visualResponses:{}},thumbrest:{type:"button",gamepadIndices:{button:6},rootNodeName:"thumbrest",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"oculus-touch-v2-right",assetPath:"right.glb"}};class Bo extends Ho{constructor(e,t,i){super(e,$M[i],t,i),this.profileId="htc-vive"}_getFilenameAndPath(){const e=Bo.MODEL_FILENAME,t=Bo.MODEL_BASE_URL;return{filename:e,path:t}}_getModelLoadingConstraints(){return!0}_processLoadedModel(e){this.getComponentIds().forEach(t=>{const i=t&&this.getComponent(t);i&&i.onButtonStateChangedObservable.add(s=>{if(!(!this.rootMesh||this.disableAnimation))switch(t){case"xr-standard-trigger":this._modelRootNode.getChildren()[6].rotation.x=-s.value*.15;return;case"xr-standard-touchpad":return;case"xr-standard-squeeze":return}},void 0,!0)})}_setRootMesh(e){this.rootMesh=new V(this.profileId+" "+this.handedness,this.scene),e.forEach(t=>{t.isPickable=!1}),this._modelRootNode=e[1],this._modelRootNode.parent=this.rootMesh,this.scene.useRightHandedSystem||(this.rootMesh.rotationQuaternion=Q.FromEulerAngles(0,Math.PI,0))}_updateModel(){}}Bo.MODEL_BASE_URL="https://controllers.babylonjs.com/vive/";Bo.MODEL_FILENAME="wand.babylon";Mi.RegisterController("htc-vive",(a,e)=>new Bo(e,a.gamepad,a.handedness));const $M={left:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},right:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc_vive_none",assetPath:"none.glb"},none:{selectComponentId:"xr-standard-trigger",components:{"xr-standard-trigger":{type:"trigger",gamepadIndices:{button:0},rootNodeName:"xr_standard_trigger",visualResponses:{}},"xr-standard-squeeze":{type:"squeeze",gamepadIndices:{button:1},rootNodeName:"xr_standard_squeeze",visualResponses:{}},"xr-standard-touchpad":{type:"touchpad",gamepadIndices:{button:2,xAxis:0,yAxis:1},rootNodeName:"xr_standard_touchpad",visualResponses:{}},menu:{type:"button",gamepadIndices:{button:4},rootNodeName:"menu",visualResponses:{}}},gamepadMapping:"xr-standard",rootNodeName:"htc-vive-none",assetPath:"none.glb"}};class jM{constructor(e){this._nativeImpl=e,this._xrTransform=new XRRigidTransform,this._xrPose={transform:this._xrTransform,emulatedPosition:!1},this._xrPoseVectorData=new Float32Array(4+4),this.fillPoses=this._nativeImpl.fillPoses.bind(this._nativeImpl),this.getViewerPose=this._nativeImpl.getViewerPose.bind(this._nativeImpl),this.getHitTestResults=this._nativeImpl.getHitTestResults.bind(this._nativeImpl),this.getHitTestResultsForTransientInput=()=>{throw new Error("XRFrame.getHitTestResultsForTransientInput not supported on native.")},this.createAnchor=this._nativeImpl.createAnchor.bind(this._nativeImpl),this.getJointPose=this._nativeImpl.getJointPose.bind(this._nativeImpl),this.fillJointRadii=this._nativeImpl.fillJointRadii.bind(this._nativeImpl),this.getLightEstimate=()=>{throw new Error("XRFrame.getLightEstimate not supported on native.")},this.getImageTrackingResults=()=>{var t;return(t=this._nativeImpl._imageTrackingResults)!==null&&t!==void 0?t:[]}}get session(){return this._nativeImpl.session}getPose(e,t){if(!this._nativeImpl.getPoseData(e,t,this._xrPoseVectorData.buffer,this._xrTransform.matrix.buffer))return;const i=this._xrTransform.position;i.x=this._xrPoseVectorData[0],i.y=this._xrPoseVectorData[1],i.z=this._xrPoseVectorData[2],i.w=this._xrPoseVectorData[3];const s=this._xrTransform.orientation;return s.x=this._xrPoseVectorData[4],s.y=this._xrPoseVectorData[5],s.z=this._xrPoseVectorData[6],s.w=this._xrPoseVectorData[7],this._xrPose}get trackedAnchors(){return this._nativeImpl.trackedAnchors}get worldInformation(){return this._nativeImpl.worldInformation}get detectedPlanes(){return this._nativeImpl.detectedPlanes}get featurePointCloud(){return this._nativeImpl.featurePointCloud}}tE("NativeXRFrame",jM);class Rr{constructor(){this.materials=[]}parseMTL(e,t,i,s){if(t instanceof ArrayBuffer)return;const r=t.split(`
`),n=/\s+/;let o,l=null;for(let h=0;h<r.length;h++){const c=r[h].trim();if(c.length===0||c.charAt(0)==="#")continue;const u=c.indexOf(" ");let d=u>=0?c.substring(0,u):c;d=d.toLowerCase();const f=u>=0?c.substring(u+1).trim():"";if(d==="newmtl")l&&this.materials.push(l),e._blockEntityCollection=!!s,l=new pe(f,e),l._parentContainer=s,e._blockEntityCollection=!1;else if(d==="kd"&&l)o=f.split(n,3).map(parseFloat),l.diffuseColor=re.FromArray(o);else if(d==="ka"&&l)o=f.split(n,3).map(parseFloat),l.ambientColor=re.FromArray(o);else if(d==="ks"&&l)o=f.split(n,3).map(parseFloat),l.specularColor=re.FromArray(o);else if(d==="ke"&&l)o=f.split(n,3).map(parseFloat),l.emissiveColor=re.FromArray(o);else if(d==="ns"&&l)l.specularPower=parseFloat(f);else if(d==="d"&&l)l.alpha=parseFloat(f);else if(d==="map_ka"&&l)l.ambientTexture=Rr._GetTexture(i,f,e);else if(d==="map_kd"&&l)l.diffuseTexture=Rr._GetTexture(i,f,e);else if(d==="map_ks"&&l)l.specularTexture=Rr._GetTexture(i,f,e);else if(d!=="map_ns")if(d==="map_bump"&&l){const p=f.split(n),_=p.indexOf("-bm");let m=null;_>=0&&(m=p[_+1],p.splice(_,2)),l.bumpTexture=Rr._GetTexture(i,p.join(" "),e),l.bumpTexture&&m!==null&&(l.bumpTexture.level=parseFloat(m))}else d==="map_d"&&l&&(l.opacityTexture=Rr._GetTexture(i,f,e))}l&&this.materials.push(l)}static _GetTexture(e,t,i){if(!t)return null;let s=e;if(e==="file:"){let r=t.lastIndexOf("\\");r===-1&&(r=t.lastIndexOf("/")),r>-1?s+=t.substr(r+1):s+=t}else s+=t;return new H(s,i,!1,Rr.INVERT_TEXTURE_Y)}}Rr.INVERT_TEXTURE_Y=!0;class Qt{constructor(e,t,i){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new J(.5,.5,.5,1),this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=i}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const i=e[t[0]].normals.indexOf(t[1]);return i===-1?-1:e[t[0]].idx[i]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const i=e[t[0]].normals.indexOf(t[1]);return i!=1&&t[2]===e[t[0]].uv[i]?e[t[0]].idx[i]:-1}_setData(e,t,i,s,r,n,o){let l;this._loadingOptions.optimizeWithUV?l=this._isInArrayUV(this._tuplePosNorm,[e,i,t]):l=this._isInArray(this._tuplePosNorm,[e,i]),l===-1?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(s),this._wrappedUvsForBabylon.push(r),this._wrappedNormalsForBabylon.push(n),o!==void 0&&this._wrappedColorsForBabylon.push(o),this._tuplePosNorm[e].normals.push(i),this._tuplePosNorm[e].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e].uv.push(t)):this._indicesForBabylon.push(l)}_unwrapData(){for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._loadingOptions.importVertexColors&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}_getTriangles(e,t){for(let i=t;i<e.length-1;i++)this._triangles.push(e[0],e[i],e[i+1])}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){const s=parseInt(this._triangles[i])-1;this._setData(s,0,0,this._positions[s],le.Zero(),g.Up(),this._loadingOptions.importVertexColors?this._colors[s]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){const s=this._triangles[i].split("/"),r=parseInt(s[0])-1,n=parseInt(s[1])-1;this._setData(r,n,0,this._positions[r],this._uvs[n],g.Up(),this._loadingOptions.importVertexColors?this._colors[r]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){const s=this._triangles[i].split("/"),r=parseInt(s[0])-1,n=parseInt(s[1])-1,o=parseInt(s[2])-1;this._setData(r,n,o,this._positions[r],this._uvs[n],this._normals[o])}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){const s=this._triangles[i].split("//"),r=parseInt(s[0])-1,n=parseInt(s[1])-1;this._setData(r,1,n,this._positions[r],le.Zero(),this._normals[n],this._loadingOptions.importVertexColors?this._colors[r]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let i=0;i<this._triangles.length;i++){const s=this._triangles[i].split("/"),r=this._positions.length+parseInt(s[0]),n=this._uvs.length+parseInt(s[1]),o=this._normals.length+parseInt(s[2]);this._setData(r,n,o,this._positions[r],this._uvs[n],this._normals[o],this._loadingOptions.importVertexColors?this._colors[r]:void 0)}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice(),this._handledMesh.uvs=this._unwrappedUVForBabylon.slice(),this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0)}_optimizeNormals(e){const t=e.getVerticesData(y.PositionKind),i=e.getVerticesData(y.NormalKind),s={};if(!t||!i)return;for(let n=0;n<t.length/3;n++){const o=t[n*3+0],l=t[n*3+1],h=t[n*3+2],c=o+"_"+l+"_"+h;let u=s[c];u||(u=[],s[c]=u),u.push(n)}const r=new g;for(const n in s){const o=s[n];if(o.length<2)continue;const l=o[0];for(let h=1;h<o.length;++h){const c=o[h];i[l*3+0]+=i[c*3+0],i[l*3+1]+=i[c*3+1],i[l*3+2]+=i[c*3+2]}r.copyFromFloats(i[l*3+0],i[l*3+1],i[l*3+2]),r.normalize();for(let h=0;h<o.length;++h){const c=o[h];i[c*3+0]=r.x,i[c*3+1]=r.y,i[c*3+2]=r.z}}e.setVerticesData(y.NormalKind,i)}parse(e,t,i,s,r){var n;const o=t.split(`
`);for(let l=0;l<o.length;l++){const h=o[l].trim().replace(/\s\s/g," ");let c;if(!(h.length===0||h.charAt(0)==="#"))if(Qt.VertexPattern.test(h)){if(c=h.match(/[^ ]+/g),this._positions.push(new g(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3]))),this._loadingOptions.importVertexColors)if(c.length>=7){const u=parseFloat(c[4]),d=parseFloat(c[5]),f=parseFloat(c[6]);this._colors.push(new J(u>1?u/255:u,d>1?d/255:d,f>1?f/255:f,c.length===7||c[7]===void 0?1:parseFloat(c[7])))}else this._colors.push(this._grayColor)}else if((c=Qt.NormalPattern.exec(h))!==null)this._normals.push(new g(parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3])));else if((c=Qt.UVPattern.exec(h))!==null)this._uvs.push(new le(parseFloat(c[1])*this._loadingOptions.UVScaling.x,parseFloat(c[2])*this._loadingOptions.UVScaling.y));else if((c=Qt.FacePattern3.exec(h))!==null)this._setDataForCurrentFaceWithPattern3(c[1].trim().split(" "),1);else if((c=Qt.FacePattern4.exec(h))!==null)this._setDataForCurrentFaceWithPattern4(c[1].trim().split(" "),1);else if((c=Qt.FacePattern5.exec(h))!==null)this._setDataForCurrentFaceWithPattern5(c[1].trim().split(" "),1);else if((c=Qt.FacePattern2.exec(h))!==null)this._setDataForCurrentFaceWithPattern2(c[1].trim().split(" "),1);else if((c=Qt.FacePattern1.exec(h))!==null)this._setDataForCurrentFaceWithPattern1(c[1].trim().split(" "),1);else if(Qt.GroupDescriptor.test(h)||Qt.ObjectDescriptor.test(h)){const u={name:h.substring(2).trim(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj};this._addPreviousObjMesh(),this._meshesFromObj.push(u),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(Qt.UseMtlDescriptor.test(h)){if(this._materialNameFromObj=h.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const u={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj};this._increment++,this._meshesFromObj.push(u),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else Qt.MtlLibGroupDescriptor.test(h)?r(h.substring(7).trim()):Qt.SmoothDescriptor.test(h)||console.log("Unhandled expression at line : "+h)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._handledMesh.normals=this._unwrappedNormalsForBabylon,this._handledMesh.uvs=this._unwrappedUVForBabylon,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon)),!this._hasMeshes){let l=null;if(this._indicesForBabylon.length)this._indicesForBabylon.reverse(),this._unwrapData();else{for(const h of this._positions)this._unwrappedPositionsForBabylon.push(h.x,h.y,h.z);if(this._normals.length)for(const h of this._normals)this._unwrappedNormalsForBabylon.push(h.x,h.y,h.z);if(this._uvs.length)for(const h of this._uvs)this._unwrappedUVForBabylon.push(h.x,h.y);if(this._colors.length)for(const h of this._colors)this._unwrappedColorsForBabylon.push(h.r,h.g,h.b,h.a);this._materialNameFromObj||(l=new pe(os.RandomId(),i),l.pointsCloud=!0,this._materialNameFromObj=l.name,this._normals.length||(l.disableLighting=!0,l.emissiveColor=re.White()))}this._meshesFromObj.push({name:os.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:l})}for(let l=0;l<this._meshesFromObj.length;l++){if(e&&this._meshesFromObj[l].name){if(e instanceof Array){if(e.indexOf(this._meshesFromObj[l].name)===-1)continue}else if(this._meshesFromObj[l].name!==e)continue}this._handledMesh=this._meshesFromObj[l],i._blockEntityCollection=!!s;const h=new V(this._meshesFromObj[l].name,i);if(h._parentContainer=s,i._blockEntityCollection=!1,this._materialToUse.push(this._meshesFromObj[l].materialName),((n=this._handledMesh.positions)===null||n===void 0?void 0:n.length)===0){this._babylonMeshesArray.push(h);continue}const c=new de;if(c.uvs=this._handledMesh.uvs,c.indices=this._handledMesh.indices,c.positions=this._handledMesh.positions,this._loadingOptions.computeNormals){const u=new Array;de.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,u),c.normals=u}else c.normals=this._handledMesh.normals;this._loadingOptions.importVertexColors&&(c.colors=this._handledMesh.colors),c.applyToMesh(h),this._loadingOptions.invertY&&(h.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(h),this._babylonMeshesArray.push(h),this._handledMesh.directMaterial&&(h.material=this._handledMesh.directMaterial)}}}Qt.ObjectDescriptor=/^o/;Qt.GroupDescriptor=/^g/;Qt.MtlLibGroupDescriptor=/^mtllib /;Qt.UseMtlDescriptor=/^usemtl /;Qt.SmoothDescriptor=/^s /;Qt.VertexPattern=/v(\s+[\d|.|+|\-|e|E]+){3,7}/;Qt.NormalPattern=/vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;Qt.UVPattern=/vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;Qt.FacePattern1=/f\s+(([\d]{1,}[\s]?){3,})+/;Qt.FacePattern2=/f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;Qt.FacePattern3=/f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;Qt.FacePattern4=/f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;Qt.FacePattern5=/f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;class Ii{constructor(e){this.name="obj",this.extensions=".obj",this._assetContainer=null,this._loadingOptions=e||Ii._DefaultLoadingOptions}static get INVERT_TEXTURE_Y(){return Rr.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){Rr.INVERT_TEXTURE_Y=e}static get _DefaultLoadingOptions(){return{computeNormals:Ii.COMPUTE_NORMALS,optimizeNormals:Ii.OPTIMIZE_NORMALS,importVertexColors:Ii.IMPORT_VERTEX_COLORS,invertY:Ii.INVERT_Y,invertTextureY:Ii.INVERT_TEXTURE_Y,UVScaling:Ii.UV_SCALING,materialLoadingFailsSilently:Ii.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:Ii.OPTIMIZE_WITH_UV,skipMaterials:Ii.SKIP_MATERIALS}}_loadMTL(e,t,i,s){const r=t+e;q.LoadFile(r,i,void 0,void 0,!1,(n,o)=>{s(r,o)})}createPlugin(){return new Ii(Ii._DefaultLoadingOptions)}canDirectLoad(){return!1}importMeshAsync(e,t,i,s){return this._parseSolid(e,t,i,s).then(r=>({meshes:r,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[]}))}loadAsync(e,t,i){return this.importMeshAsync(null,e,t,i).then(()=>{})}loadAssetContainerAsync(e,t,i){const s=new I_(e);return this._assetContainer=s,this.importMeshAsync(null,e,t,i).then(r=>(r.meshes.forEach(n=>s.meshes.push(n)),r.meshes.forEach(n=>{const o=n.material;o&&s.materials.indexOf(o)==-1&&(s.materials.push(o),o.getActiveTextures().forEach(h=>{s.textures.indexOf(h)==-1&&s.textures.push(h)}))}),this._assetContainer=null,s)).catch(r=>{throw this._assetContainer=null,r})}_parseSolid(e,t,i,s){let r="";const n=new Rr,o=new Array,l=[];new Qt(o,l,this._loadingOptions).parse(e,i,t,this._assetContainer,u=>{r=u});const c=[];return r!==""&&!this._loadingOptions.skipMaterials&&c.push(new Promise((u,d)=>{this._loadMTL(r,s,f=>{try{n.parseMTL(t,f,s,this._assetContainer);for(let p=0;p<n.materials.length;p++){let _=0;const m=[];let v;for(;(v=o.indexOf(n.materials[p].name,_))>-1;)m.push(v),_=v+1;if(v===-1&&m.length===0)n.materials[p].dispose();else for(let x=0;x<m.length;x++){const b=l[m[x]],S=n.materials[p];b.material=S,b.getTotalIndices()||(S.pointsCloud=!0)}}u()}catch(p){q.Warn(`Error processing MTL file: '${r}'`),this._loadingOptions.materialLoadingFailsSilently?u():d(p)}},(f,p)=>{q.Warn(`Error downloading MTL file: '${r}'`),this._loadingOptions.materialLoadingFailsSilently?u():d(p)})})),Promise.all(c).then(()=>l)}}Ii.OPTIMIZE_WITH_UV=!0;Ii.INVERT_Y=!1;Ii.IMPORT_VERTEX_COLORS=!1;Ii.COMPUTE_NORMALS=!1;Ii.OPTIMIZE_NORMALS=!1;Ii.UV_SCALING=new le(1,1);Ii.SKIP_MATERIALS=!1;Ii.MATERIAL_LOADING_FAILS_SILENTLY=!0;Be&&Be.RegisterPlugin(new Ii);var qM={value:()=>{}};function Hm(){for(var a=0,e=arguments.length,t={},i;a<e;++a){if(!(i=arguments[a]+"")||i in t||/[\s.]/.test(i))throw new Error("illegal type: "+i);t[i]=[]}return new Nh(t)}function Nh(a){this._=a}function QM(a,e){return a.trim().split(/^|\s+/).map(function(t){var i="",s=t.indexOf(".");if(s>=0&&(i=t.slice(s+1),t=t.slice(0,s)),t&&!e.hasOwnProperty(t))throw new Error("unknown type: "+t);return{type:t,name:i}})}Nh.prototype=Hm.prototype={constructor:Nh,on:function(a,e){var t=this._,i=QM(a+"",t),s,r=-1,n=i.length;if(arguments.length<2){for(;++r<n;)if((s=(a=i[r]).type)&&(s=ZM(t[s],a.name)))return s;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++r<n;)if(s=(a=i[r]).type)t[s]=Tp(t[s],a.name,e);else if(e==null)for(s in t)t[s]=Tp(t[s],a.name,null);return this},copy:function(){var a={},e=this._;for(var t in e)a[t]=e[t].slice();return new Nh(a)},call:function(a,e){if((s=arguments.length-2)>0)for(var t=new Array(s),i=0,s,r;i<s;++i)t[i]=arguments[i+2];if(!this._.hasOwnProperty(a))throw new Error("unknown type: "+a);for(r=this._[a],i=0,s=r.length;i<s;++i)r[i].value.apply(e,t)},apply:function(a,e,t){if(!this._.hasOwnProperty(a))throw new Error("unknown type: "+a);for(var i=this._[a],s=0,r=i.length;s<r;++s)i[s].value.apply(e,t)}};function ZM(a,e){for(var t=0,i=a.length,s;t<i;++t)if((s=a[t]).name===e)return s.value}function Tp(a,e,t){for(var i=0,s=a.length;i<s;++i)if(a[i].name===e){a[i]=qM,a=a.slice(0,i).concat(a.slice(i+1));break}return t!=null&&a.push({name:e,value:t}),a}var cd="http://www.w3.org/1999/xhtml";const bp={svg:"http://www.w3.org/2000/svg",xhtml:cd,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function cu(a){var e=a+="",t=e.indexOf(":");return t>=0&&(e=a.slice(0,t))!=="xmlns"&&(a=a.slice(t+1)),bp.hasOwnProperty(e)?{space:bp[e],local:a}:a}function JM(a){return function(){var e=this.ownerDocument,t=this.namespaceURI;return t===cd&&e.documentElement.namespaceURI===cd?e.createElement(a):e.createElementNS(t,a)}}function eD(a){return function(){return this.ownerDocument.createElementNS(a.space,a.local)}}function S0(a){var e=cu(a);return(e.local?eD:JM)(e)}function tD(){}function E0(a){return a==null?tD:function(){return this.querySelector(a)}}function iD(a){typeof a!="function"&&(a=E0(a));for(var e=this._groups,t=e.length,i=new Array(t),s=0;s<t;++s)for(var r=e[s],n=r.length,o=i[s]=new Array(n),l,h,c=0;c<n;++c)(l=r[c])&&(h=a.call(l,l.__data__,c,r))&&("__data__"in l&&(h.__data__=l.__data__),o[c]=h);return new ir(i,this._parents)}function sD(a){return a==null?[]:Array.isArray(a)?a:Array.from(a)}function rD(){return[]}function Xm(a){return a==null?rD:function(){return this.querySelectorAll(a)}}function nD(a){return function(){return sD(a.apply(this,arguments))}}function aD(a){typeof a=="function"?a=nD(a):a=Xm(a);for(var e=this._groups,t=e.length,i=[],s=[],r=0;r<t;++r)for(var n=e[r],o=n.length,l,h=0;h<o;++h)(l=n[h])&&(i.push(a.call(l,l.__data__,h,n)),s.push(l));return new ir(i,s)}function Ym(a){return function(){return this.matches(a)}}function Km(a){return function(e){return e.matches(a)}}var oD=Array.prototype.find;function lD(a){return function(){return oD.call(this.children,a)}}function hD(){return this.firstElementChild}function cD(a){return this.select(a==null?hD:lD(typeof a=="function"?a:Km(a)))}var uD=Array.prototype.filter;function dD(){return Array.from(this.children)}function fD(a){return function(){return uD.call(this.children,a)}}function pD(a){return this.selectAll(a==null?dD:fD(typeof a=="function"?a:Km(a)))}function _D(a){typeof a!="function"&&(a=Ym(a));for(var e=this._groups,t=e.length,i=new Array(t),s=0;s<t;++s)for(var r=e[s],n=r.length,o=i[s]=[],l,h=0;h<n;++h)(l=r[h])&&a.call(l,l.__data__,h,r)&&o.push(l);return new ir(i,this._parents)}function $m(a){return new Array(a.length)}function mD(){return new ir(this._enter||this._groups.map($m),this._parents)}function oc(a,e){this.ownerDocument=a.ownerDocument,this.namespaceURI=a.namespaceURI,this._next=null,this._parent=a,this.__data__=e}oc.prototype={constructor:oc,appendChild:function(a){return this._parent.insertBefore(a,this._next)},insertBefore:function(a,e){return this._parent.insertBefore(a,e)},querySelector:function(a){return this._parent.querySelector(a)},querySelectorAll:function(a){return this._parent.querySelectorAll(a)}};function gD(a){return function(){return a}}function vD(a,e,t,i,s,r){for(var n=0,o,l=e.length,h=r.length;n<h;++n)(o=e[n])?(o.__data__=r[n],i[n]=o):t[n]=new oc(a,r[n]);for(;n<l;++n)(o=e[n])&&(s[n]=o)}function xD(a,e,t,i,s,r,n){var o,l,h=new Map,c=e.length,u=r.length,d=new Array(c),f;for(o=0;o<c;++o)(l=e[o])&&(d[o]=f=n.call(l,l.__data__,o,e)+"",h.has(f)?s[o]=l:h.set(f,l));for(o=0;o<u;++o)f=n.call(a,r[o],o,r)+"",(l=h.get(f))?(i[o]=l,l.__data__=r[o],h.delete(f)):t[o]=new oc(a,r[o]);for(o=0;o<c;++o)(l=e[o])&&h.get(d[o])===l&&(s[o]=l)}function TD(a){return a.__data__}function bD(a,e){if(!arguments.length)return Array.from(this,TD);var t=e?xD:vD,i=this._parents,s=this._groups;typeof a!="function"&&(a=gD(a));for(var r=s.length,n=new Array(r),o=new Array(r),l=new Array(r),h=0;h<r;++h){var c=i[h],u=s[h],d=u.length,f=SD(a.call(c,c&&c.__data__,h,i)),p=f.length,_=o[h]=new Array(p),m=n[h]=new Array(p),v=l[h]=new Array(d);t(c,u,_,m,v,f,e);for(var x=0,b=0,S,C;x<p;++x)if(S=_[x]){for(x>=b&&(b=x+1);!(C=m[b])&&++b<p;);S._next=C||null}}return n=new ir(n,i),n._enter=o,n._exit=l,n}function SD(a){return typeof a=="object"&&"length"in a?a:Array.from(a)}function ED(){return new ir(this._exit||this._groups.map($m),this._parents)}function CD(a,e,t){var i=this.enter(),s=this,r=this.exit();return typeof a=="function"?(i=a(i),i&&(i=i.selection())):i=i.append(a+""),e!=null&&(s=e(s),s&&(s=s.selection())),t==null?r.remove():t(r),i&&s?i.merge(s).order():s}function yD(a){for(var e=a.selection?a.selection():a,t=this._groups,i=e._groups,s=t.length,r=i.length,n=Math.min(s,r),o=new Array(s),l=0;l<n;++l)for(var h=t[l],c=i[l],u=h.length,d=o[l]=new Array(u),f,p=0;p<u;++p)(f=h[p]||c[p])&&(d[p]=f);for(;l<s;++l)o[l]=t[l];return new ir(o,this._parents)}function AD(){for(var a=this._groups,e=-1,t=a.length;++e<t;)for(var i=a[e],s=i.length-1,r=i[s],n;--s>=0;)(n=i[s])&&(r&&n.compareDocumentPosition(r)^4&&r.parentNode.insertBefore(n,r),r=n);return this}function RD(a){a||(a=ID);function e(u,d){return u&&d?a(u.__data__,d.__data__):!u-!d}for(var t=this._groups,i=t.length,s=new Array(i),r=0;r<i;++r){for(var n=t[r],o=n.length,l=s[r]=new Array(o),h,c=0;c<o;++c)(h=n[c])&&(l[c]=h);l.sort(e)}return new ir(s,this._parents).order()}function ID(a,e){return a<e?-1:a>e?1:a>=e?0:NaN}function PD(){var a=arguments[0];return arguments[0]=this,a.apply(null,arguments),this}function MD(){return Array.from(this)}function DD(){for(var a=this._groups,e=0,t=a.length;e<t;++e)for(var i=a[e],s=0,r=i.length;s<r;++s){var n=i[s];if(n)return n}return null}function OD(){let a=0;for(const e of this)++a;return a}function wD(){return!this.node()}function ND(a){for(var e=this._groups,t=0,i=e.length;t<i;++t)for(var s=e[t],r=0,n=s.length,o;r<n;++r)(o=s[r])&&a.call(o,o.__data__,r,s);return this}function FD(a){return function(){this.removeAttribute(a)}}function LD(a){return function(){this.removeAttributeNS(a.space,a.local)}}function BD(a,e){return function(){this.setAttribute(a,e)}}function UD(a,e){return function(){this.setAttributeNS(a.space,a.local,e)}}function VD(a,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttribute(a):this.setAttribute(a,t)}}function kD(a,e){return function(){var t=e.apply(this,arguments);t==null?this.removeAttributeNS(a.space,a.local):this.setAttributeNS(a.space,a.local,t)}}function GD(a,e){var t=cu(a);if(arguments.length<2){var i=this.node();return t.local?i.getAttributeNS(t.space,t.local):i.getAttribute(t)}return this.each((e==null?t.local?LD:FD:typeof e=="function"?t.local?kD:VD:t.local?UD:BD)(t,e))}function jm(a){return a.ownerDocument&&a.ownerDocument.defaultView||a.document&&a||a.defaultView}function zD(a){return function(){this.style.removeProperty(a)}}function WD(a,e,t){return function(){this.style.setProperty(a,e,t)}}function HD(a,e,t){return function(){var i=e.apply(this,arguments);i==null?this.style.removeProperty(a):this.style.setProperty(a,i,t)}}function XD(a,e,t){return arguments.length>1?this.each((e==null?zD:typeof e=="function"?HD:WD)(a,e,t==null?"":t)):Uo(this.node(),a)}function Uo(a,e){return a.style.getPropertyValue(e)||jm(a).getComputedStyle(a,null).getPropertyValue(e)}function YD(a){return function(){delete this[a]}}function KD(a,e){return function(){this[a]=e}}function $D(a,e){return function(){var t=e.apply(this,arguments);t==null?delete this[a]:this[a]=t}}function jD(a,e){return arguments.length>1?this.each((e==null?YD:typeof e=="function"?$D:KD)(a,e)):this.node()[a]}function qm(a){return a.trim().split(/^|\s+/)}function C0(a){return a.classList||new Qm(a)}function Qm(a){this._node=a,this._names=qm(a.getAttribute("class")||"")}Qm.prototype={add:function(a){var e=this._names.indexOf(a);e<0&&(this._names.push(a),this._node.setAttribute("class",this._names.join(" ")))},remove:function(a){var e=this._names.indexOf(a);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(a){return this._names.indexOf(a)>=0}};function Zm(a,e){for(var t=C0(a),i=-1,s=e.length;++i<s;)t.add(e[i])}function Jm(a,e){for(var t=C0(a),i=-1,s=e.length;++i<s;)t.remove(e[i])}function qD(a){return function(){Zm(this,a)}}function QD(a){return function(){Jm(this,a)}}function ZD(a,e){return function(){(e.apply(this,arguments)?Zm:Jm)(this,a)}}function JD(a,e){var t=qm(a+"");if(arguments.length<2){for(var i=C0(this.node()),s=-1,r=t.length;++s<r;)if(!i.contains(t[s]))return!1;return!0}return this.each((typeof e=="function"?ZD:e?qD:QD)(t,e))}function e3(){this.textContent=""}function t3(a){return function(){this.textContent=a}}function i3(a){return function(){var e=a.apply(this,arguments);this.textContent=e==null?"":e}}function s3(a){return arguments.length?this.each(a==null?e3:(typeof a=="function"?i3:t3)(a)):this.node().textContent}function r3(){this.innerHTML=""}function n3(a){return function(){this.innerHTML=a}}function a3(a){return function(){var e=a.apply(this,arguments);this.innerHTML=e==null?"":e}}function o3(a){return arguments.length?this.each(a==null?r3:(typeof a=="function"?a3:n3)(a)):this.node().innerHTML}function l3(){this.nextSibling&&this.parentNode.appendChild(this)}function h3(){return this.each(l3)}function c3(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function u3(){return this.each(c3)}function d3(a){var e=typeof a=="function"?a:S0(a);return this.select(function(){return this.appendChild(e.apply(this,arguments))})}function f3(){return null}function p3(a,e){var t=typeof a=="function"?a:S0(a),i=e==null?f3:typeof e=="function"?e:E0(e);return this.select(function(){return this.insertBefore(t.apply(this,arguments),i.apply(this,arguments)||null)})}function _3(){var a=this.parentNode;a&&a.removeChild(this)}function m3(){return this.each(_3)}function g3(){var a=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(a,this.nextSibling):a}function v3(){var a=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(a,this.nextSibling):a}function x3(a){return this.select(a?v3:g3)}function T3(a){return arguments.length?this.property("__data__",a):this.node().__data__}function b3(a){return function(e){a.call(this,e,this.__data__)}}function S3(a){return a.trim().split(/^|\s+/).map(function(e){var t="",i=e.indexOf(".");return i>=0&&(t=e.slice(i+1),e=e.slice(0,i)),{type:e,name:t}})}function E3(a){return function(){var e=this.__on;if(!!e){for(var t=0,i=-1,s=e.length,r;t<s;++t)r=e[t],(!a.type||r.type===a.type)&&r.name===a.name?this.removeEventListener(r.type,r.listener,r.options):e[++i]=r;++i?e.length=i:delete this.__on}}}function C3(a,e,t){return function(){var i=this.__on,s,r=b3(e);if(i){for(var n=0,o=i.length;n<o;++n)if((s=i[n]).type===a.type&&s.name===a.name){this.removeEventListener(s.type,s.listener,s.options),this.addEventListener(s.type,s.listener=r,s.options=t),s.value=e;return}}this.addEventListener(a.type,r,t),s={type:a.type,name:a.name,value:e,listener:r,options:t},i?i.push(s):this.__on=[s]}}function y3(a,e,t){var i=S3(a+""),s,r=i.length,n;if(arguments.length<2){var o=this.node().__on;if(o){for(var l=0,h=o.length,c;l<h;++l)for(s=0,c=o[l];s<r;++s)if((n=i[s]).type===c.type&&n.name===c.name)return c.value}return}for(o=e?C3:E3,s=0;s<r;++s)this.each(o(i[s],e,t));return this}function eg(a,e,t){var i=jm(a),s=i.CustomEvent;typeof s=="function"?s=new s(e,t):(s=i.document.createEvent("Event"),t?(s.initEvent(e,t.bubbles,t.cancelable),s.detail=t.detail):s.initEvent(e,!1,!1)),a.dispatchEvent(s)}function A3(a,e){return function(){return eg(this,a,e)}}function R3(a,e){return function(){return eg(this,a,e.apply(this,arguments))}}function I3(a,e){return this.each((typeof e=="function"?R3:A3)(a,e))}function*P3(){for(var a=this._groups,e=0,t=a.length;e<t;++e)for(var i=a[e],s=0,r=i.length,n;s<r;++s)(n=i[s])&&(yield n)}var tg=[null];function ir(a,e){this._groups=a,this._parents=e}function ah(){return new ir([[document.documentElement]],tg)}function M3(){return this}ir.prototype=ah.prototype={constructor:ir,select:iD,selectAll:aD,selectChild:cD,selectChildren:pD,filter:_D,data:bD,enter:mD,exit:ED,join:CD,merge:yD,selection:M3,order:AD,sort:RD,call:PD,nodes:MD,node:DD,size:OD,empty:wD,each:ND,attr:GD,style:XD,property:jD,classed:JD,text:s3,html:o3,raise:h3,lower:u3,append:d3,insert:p3,remove:m3,clone:x3,datum:T3,on:y3,dispatch:I3,[Symbol.iterator]:P3};function D3(a){return typeof a=="string"?new ir([[document.querySelector(a)]],[document.documentElement]):new ir([[a]],tg)}function ig(a){return D3(S0(a).call(document.documentElement))}function y0(a,e,t){a.prototype=e.prototype=t,t.constructor=a}function sg(a,e){var t=Object.create(a.prototype);for(var i in e)t[i]=e[i];return t}function oh(){}var Ul=.7,lc=1/Ul,Eo="\\s*([+-]?\\d+)\\s*",Vl="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",$r="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",O3=/^#([0-9a-f]{3,8})$/,w3=new RegExp(`^rgb\\(${Eo},${Eo},${Eo}\\)$`),N3=new RegExp(`^rgb\\(${$r},${$r},${$r}\\)$`),F3=new RegExp(`^rgba\\(${Eo},${Eo},${Eo},${Vl}\\)$`),L3=new RegExp(`^rgba\\(${$r},${$r},${$r},${Vl}\\)$`),B3=new RegExp(`^hsl\\(${Vl},${$r},${$r}\\)$`),U3=new RegExp(`^hsla\\(${Vl},${$r},${$r},${Vl}\\)$`),Sp={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};y0(oh,kl,{copy(a){return Object.assign(new this.constructor,this,a)},displayable(){return this.rgb().displayable()},hex:Ep,formatHex:Ep,formatHex8:V3,formatHsl:k3,formatRgb:Cp,toString:Cp});function Ep(){return this.rgb().formatHex()}function V3(){return this.rgb().formatHex8()}function k3(){return rg(this).formatHsl()}function Cp(){return this.rgb().formatRgb()}function kl(a){var e,t;return a=(a+"").trim().toLowerCase(),(e=O3.exec(a))?(t=e[1].length,e=parseInt(e[1],16),t===6?yp(e):t===3?new Ws(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):t===8?Eh(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):t===4?Eh(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=w3.exec(a))?new Ws(e[1],e[2],e[3],1):(e=N3.exec(a))?new Ws(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=F3.exec(a))?Eh(e[1],e[2],e[3],e[4]):(e=L3.exec(a))?Eh(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=B3.exec(a))?Ip(e[1],e[2]/100,e[3]/100,1):(e=U3.exec(a))?Ip(e[1],e[2]/100,e[3]/100,e[4]):Sp.hasOwnProperty(a)?yp(Sp[a]):a==="transparent"?new Ws(NaN,NaN,NaN,0):null}function yp(a){return new Ws(a>>16&255,a>>8&255,a&255,1)}function Eh(a,e,t,i){return i<=0&&(a=e=t=NaN),new Ws(a,e,t,i)}function G3(a){return a instanceof oh||(a=kl(a)),a?(a=a.rgb(),new Ws(a.r,a.g,a.b,a.opacity)):new Ws}function ud(a,e,t,i){return arguments.length===1?G3(a):new Ws(a,e,t,i==null?1:i)}function Ws(a,e,t,i){this.r=+a,this.g=+e,this.b=+t,this.opacity=+i}y0(Ws,ud,sg(oh,{brighter(a){return a=a==null?lc:Math.pow(lc,a),new Ws(this.r*a,this.g*a,this.b*a,this.opacity)},darker(a){return a=a==null?Ul:Math.pow(Ul,a),new Ws(this.r*a,this.g*a,this.b*a,this.opacity)},rgb(){return this},clamp(){return new Ws(Na(this.r),Na(this.g),Na(this.b),hc(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Ap,formatHex:Ap,formatHex8:z3,formatRgb:Rp,toString:Rp}));function Ap(){return`#${ya(this.r)}${ya(this.g)}${ya(this.b)}`}function z3(){return`#${ya(this.r)}${ya(this.g)}${ya(this.b)}${ya((isNaN(this.opacity)?1:this.opacity)*255)}`}function Rp(){const a=hc(this.opacity);return`${a===1?"rgb(":"rgba("}${Na(this.r)}, ${Na(this.g)}, ${Na(this.b)}${a===1?")":`, ${a})`}`}function hc(a){return isNaN(a)?1:Math.max(0,Math.min(1,a))}function Na(a){return Math.max(0,Math.min(255,Math.round(a)||0))}function ya(a){return a=Na(a),(a<16?"0":"")+a.toString(16)}function Ip(a,e,t,i){return i<=0?a=e=t=NaN:t<=0||t>=1?a=e=NaN:e<=0&&(a=NaN),new Pr(a,e,t,i)}function rg(a){if(a instanceof Pr)return new Pr(a.h,a.s,a.l,a.opacity);if(a instanceof oh||(a=kl(a)),!a)return new Pr;if(a instanceof Pr)return a;a=a.rgb();var e=a.r/255,t=a.g/255,i=a.b/255,s=Math.min(e,t,i),r=Math.max(e,t,i),n=NaN,o=r-s,l=(r+s)/2;return o?(e===r?n=(t-i)/o+(t<i)*6:t===r?n=(i-e)/o+2:n=(e-t)/o+4,o/=l<.5?r+s:2-r-s,n*=60):o=l>0&&l<1?0:n,new Pr(n,o,l,a.opacity)}function W3(a,e,t,i){return arguments.length===1?rg(a):new Pr(a,e,t,i==null?1:i)}function Pr(a,e,t,i){this.h=+a,this.s=+e,this.l=+t,this.opacity=+i}y0(Pr,W3,sg(oh,{brighter(a){return a=a==null?lc:Math.pow(lc,a),new Pr(this.h,this.s,this.l*a,this.opacity)},darker(a){return a=a==null?Ul:Math.pow(Ul,a),new Pr(this.h,this.s,this.l*a,this.opacity)},rgb(){var a=this.h%360+(this.h<0)*360,e=isNaN(a)||isNaN(this.s)?0:this.s,t=this.l,i=t+(t<.5?t:1-t)*e,s=2*t-i;return new Ws(Gu(a>=240?a-240:a+120,s,i),Gu(a,s,i),Gu(a<120?a+240:a-120,s,i),this.opacity)},clamp(){return new Pr(Pp(this.h),Ch(this.s),Ch(this.l),hc(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const a=hc(this.opacity);return`${a===1?"hsl(":"hsla("}${Pp(this.h)}, ${Ch(this.s)*100}%, ${Ch(this.l)*100}%${a===1?")":`, ${a})`}`}}));function Pp(a){return a=(a||0)%360,a<0?a+360:a}function Ch(a){return Math.max(0,Math.min(1,a||0))}function Gu(a,e,t){return(a<60?e+(t-e)*a/60:a<180?t:a<240?e+(t-e)*(240-a)/60:e)*255}const ng=a=>()=>a;function H3(a,e){return function(t){return a+t*e}}function X3(a,e,t){return a=Math.pow(a,t),e=Math.pow(e,t)-a,t=1/t,function(i){return Math.pow(a+i*e,t)}}function Y3(a){return(a=+a)==1?ag:function(e,t){return t-e?X3(e,t,a):ng(isNaN(e)?t:e)}}function ag(a,e){var t=e-a;return t?H3(a,t):ng(isNaN(a)?e:a)}const Mp=function a(e){var t=Y3(e);function i(s,r){var n=t((s=ud(s)).r,(r=ud(r)).r),o=t(s.g,r.g),l=t(s.b,r.b),h=ag(s.opacity,r.opacity);return function(c){return s.r=n(c),s.g=o(c),s.b=l(c),s.opacity=h(c),s+""}}return i.gamma=a,i}(1);function Ln(a,e){return a=+a,e=+e,function(t){return a*(1-t)+e*t}}var dd=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,zu=new RegExp(dd.source,"g");function K3(a){return function(){return a}}function $3(a){return function(e){return a(e)+""}}function j3(a,e){var t=dd.lastIndex=zu.lastIndex=0,i,s,r,n=-1,o=[],l=[];for(a=a+"",e=e+"";(i=dd.exec(a))&&(s=zu.exec(e));)(r=s.index)>t&&(r=e.slice(t,r),o[n]?o[n]+=r:o[++n]=r),(i=i[0])===(s=s[0])?o[n]?o[n]+=s:o[++n]=s:(o[++n]=null,l.push({i:n,x:Ln(i,s)})),t=zu.lastIndex;return t<e.length&&(r=e.slice(t),o[n]?o[n]+=r:o[++n]=r),o.length<2?l[0]?$3(l[0].x):K3(e):(e=l.length,function(h){for(var c=0,u;c<e;++c)o[(u=l[c]).i]=u.x(h);return o.join("")})}var Dp=180/Math.PI,fd={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function og(a,e,t,i,s,r){var n,o,l;return(n=Math.sqrt(a*a+e*e))&&(a/=n,e/=n),(l=a*t+e*i)&&(t-=a*l,i-=e*l),(o=Math.sqrt(t*t+i*i))&&(t/=o,i/=o,l/=o),a*i<e*t&&(a=-a,e=-e,l=-l,n=-n),{translateX:s,translateY:r,rotate:Math.atan2(e,a)*Dp,skewX:Math.atan(l)*Dp,scaleX:n,scaleY:o}}var yh;function q3(a){const e=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(a+"");return e.isIdentity?fd:og(e.a,e.b,e.c,e.d,e.e,e.f)}function Q3(a){return a==null||(yh||(yh=document.createElementNS("http://www.w3.org/2000/svg","g")),yh.setAttribute("transform",a),!(a=yh.transform.baseVal.consolidate()))?fd:(a=a.matrix,og(a.a,a.b,a.c,a.d,a.e,a.f))}function lg(a,e,t,i){function s(h){return h.length?h.pop()+" ":""}function r(h,c,u,d,f,p){if(h!==u||c!==d){var _=f.push("translate(",null,e,null,t);p.push({i:_-4,x:Ln(h,u)},{i:_-2,x:Ln(c,d)})}else(u||d)&&f.push("translate("+u+e+d+t)}function n(h,c,u,d){h!==c?(h-c>180?c+=360:c-h>180&&(h+=360),d.push({i:u.push(s(u)+"rotate(",null,i)-2,x:Ln(h,c)})):c&&u.push(s(u)+"rotate("+c+i)}function o(h,c,u,d){h!==c?d.push({i:u.push(s(u)+"skewX(",null,i)-2,x:Ln(h,c)}):c&&u.push(s(u)+"skewX("+c+i)}function l(h,c,u,d,f,p){if(h!==u||c!==d){var _=f.push(s(f)+"scale(",null,",",null,")");p.push({i:_-4,x:Ln(h,u)},{i:_-2,x:Ln(c,d)})}else(u!==1||d!==1)&&f.push(s(f)+"scale("+u+","+d+")")}return function(h,c){var u=[],d=[];return h=a(h),c=a(c),r(h.translateX,h.translateY,c.translateX,c.translateY,u,d),n(h.rotate,c.rotate,u,d),o(h.skewX,c.skewX,u,d),l(h.scaleX,h.scaleY,c.scaleX,c.scaleY,u,d),h=c=null,function(f){for(var p=-1,_=d.length,m;++p<_;)u[(m=d[p]).i]=m.x(f);return u.join("")}}}var Z3=lg(q3,"px, ","px)","deg)"),J3=lg(Q3,", ",")",")"),Vo=0,il=0,el=0,hg=1e3,cc,sl,uc=0,ka=0,uu=0,Gl=typeof performance=="object"&&performance.now?performance:Date,cg=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(a){setTimeout(a,17)};function A0(){return ka||(cg(eO),ka=Gl.now()+uu)}function eO(){ka=0}function dc(){this._call=this._time=this._next=null}dc.prototype=ug.prototype={constructor:dc,restart:function(a,e,t){if(typeof a!="function")throw new TypeError("callback is not a function");t=(t==null?A0():+t)+(e==null?0:+e),!this._next&&sl!==this&&(sl?sl._next=this:cc=this,sl=this),this._call=a,this._time=t,pd()},stop:function(){this._call&&(this._call=null,this._time=1/0,pd())}};function ug(a,e,t){var i=new dc;return i.restart(a,e,t),i}function tO(){A0(),++Vo;for(var a=cc,e;a;)(e=ka-a._time)>=0&&a._call.call(void 0,e),a=a._next;--Vo}function Op(){ka=(uc=Gl.now())+uu,Vo=il=0;try{tO()}finally{Vo=0,sO(),ka=0}}function iO(){var a=Gl.now(),e=a-uc;e>hg&&(uu-=e,uc=a)}function sO(){for(var a,e=cc,t,i=1/0;e;)e._call?(i>e._time&&(i=e._time),a=e,e=e._next):(t=e._next,e._next=null,e=a?a._next=t:cc=t);sl=a,pd(i)}function pd(a){if(!Vo){il&&(il=clearTimeout(il));var e=a-ka;e>24?(a<1/0&&(il=setTimeout(Op,a-Gl.now()-uu)),el&&(el=clearInterval(el))):(el||(uc=Gl.now(),el=setInterval(iO,hg)),Vo=1,cg(Op))}}function wp(a,e,t){var i=new dc;return e=e==null?0:+e,i.restart(s=>{i.stop(),a(s+e)},e,t),i}var rO=Hm("start","end","cancel","interrupt"),nO=[],dg=0,Np=1,_d=2,Fh=3,Fp=4,md=5,Lh=6;function du(a,e,t,i,s,r){var n=a.__transition;if(!n)a.__transition={};else if(t in n)return;aO(a,t,{name:e,index:i,group:s,on:rO,tween:nO,time:r.time,delay:r.delay,duration:r.duration,ease:r.ease,timer:null,state:dg})}function R0(a,e){var t=Lr(a,e);if(t.state>dg)throw new Error("too late; already scheduled");return t}function rn(a,e){var t=Lr(a,e);if(t.state>Fh)throw new Error("too late; already running");return t}function Lr(a,e){var t=a.__transition;if(!t||!(t=t[e]))throw new Error("transition not found");return t}function aO(a,e,t){var i=a.__transition,s;i[e]=t,t.timer=ug(r,0,t.time);function r(h){t.state=Np,t.timer.restart(n,t.delay,t.time),t.delay<=h&&n(h-t.delay)}function n(h){var c,u,d,f;if(t.state!==Np)return l();for(c in i)if(f=i[c],f.name===t.name){if(f.state===Fh)return wp(n);f.state===Fp?(f.state=Lh,f.timer.stop(),f.on.call("interrupt",a,a.__data__,f.index,f.group),delete i[c]):+c<e&&(f.state=Lh,f.timer.stop(),f.on.call("cancel",a,a.__data__,f.index,f.group),delete i[c])}if(wp(function(){t.state===Fh&&(t.state=Fp,t.timer.restart(o,t.delay,t.time),o(h))}),t.state=_d,t.on.call("start",a,a.__data__,t.index,t.group),t.state===_d){for(t.state=Fh,s=new Array(d=t.tween.length),c=0,u=-1;c<d;++c)(f=t.tween[c].value.call(a,a.__data__,t.index,t.group))&&(s[++u]=f);s.length=u+1}}function o(h){for(var c=h<t.duration?t.ease.call(null,h/t.duration):(t.timer.restart(l),t.state=md,1),u=-1,d=s.length;++u<d;)s[u].call(a,c);t.state===md&&(t.on.call("end",a,a.__data__,t.index,t.group),l())}function l(){t.state=Lh,t.timer.stop(),delete i[e];for(var h in i)return;delete a.__transition}}function oO(a,e){var t=a.__transition,i,s,r=!0,n;if(!!t){e=e==null?null:e+"";for(n in t){if((i=t[n]).name!==e){r=!1;continue}s=i.state>_d&&i.state<md,i.state=Lh,i.timer.stop(),i.on.call(s?"interrupt":"cancel",a,a.__data__,i.index,i.group),delete t[n]}r&&delete a.__transition}}function lO(a){return this.each(function(){oO(this,a)})}function hO(a,e){var t,i;return function(){var s=rn(this,a),r=s.tween;if(r!==t){i=t=r;for(var n=0,o=i.length;n<o;++n)if(i[n].name===e){i=i.slice(),i.splice(n,1);break}}s.tween=i}}function cO(a,e,t){var i,s;if(typeof t!="function")throw new Error;return function(){var r=rn(this,a),n=r.tween;if(n!==i){s=(i=n).slice();for(var o={name:e,value:t},l=0,h=s.length;l<h;++l)if(s[l].name===e){s[l]=o;break}l===h&&s.push(o)}r.tween=s}}function uO(a,e){var t=this._id;if(a+="",arguments.length<2){for(var i=Lr(this.node(),t).tween,s=0,r=i.length,n;s<r;++s)if((n=i[s]).name===a)return n.value;return null}return this.each((e==null?hO:cO)(t,a,e))}function I0(a,e,t){var i=a._id;return a.each(function(){var s=rn(this,i);(s.value||(s.value={}))[e]=t.apply(this,arguments)}),function(s){return Lr(s,i).value[e]}}function fg(a,e){var t;return(typeof e=="number"?Ln:e instanceof kl?Mp:(t=kl(e))?(e=t,Mp):j3)(a,e)}function dO(a){return function(){this.removeAttribute(a)}}function fO(a){return function(){this.removeAttributeNS(a.space,a.local)}}function pO(a,e,t){var i,s=t+"",r;return function(){var n=this.getAttribute(a);return n===s?null:n===i?r:r=e(i=n,t)}}function _O(a,e,t){var i,s=t+"",r;return function(){var n=this.getAttributeNS(a.space,a.local);return n===s?null:n===i?r:r=e(i=n,t)}}function mO(a,e,t){var i,s,r;return function(){var n,o=t(this),l;return o==null?void this.removeAttribute(a):(n=this.getAttribute(a),l=o+"",n===l?null:n===i&&l===s?r:(s=l,r=e(i=n,o)))}}function gO(a,e,t){var i,s,r;return function(){var n,o=t(this),l;return o==null?void this.removeAttributeNS(a.space,a.local):(n=this.getAttributeNS(a.space,a.local),l=o+"",n===l?null:n===i&&l===s?r:(s=l,r=e(i=n,o)))}}function vO(a,e){var t=cu(a),i=t==="transform"?J3:fg;return this.attrTween(a,typeof e=="function"?(t.local?gO:mO)(t,i,I0(this,"attr."+a,e)):e==null?(t.local?fO:dO)(t):(t.local?_O:pO)(t,i,e))}function xO(a,e){return function(t){this.setAttribute(a,e.call(this,t))}}function TO(a,e){return function(t){this.setAttributeNS(a.space,a.local,e.call(this,t))}}function bO(a,e){var t,i;function s(){var r=e.apply(this,arguments);return r!==i&&(t=(i=r)&&TO(a,r)),t}return s._value=e,s}function SO(a,e){var t,i;function s(){var r=e.apply(this,arguments);return r!==i&&(t=(i=r)&&xO(a,r)),t}return s._value=e,s}function EO(a,e){var t="attr."+a;if(arguments.length<2)return(t=this.tween(t))&&t._value;if(e==null)return this.tween(t,null);if(typeof e!="function")throw new Error;var i=cu(a);return this.tween(t,(i.local?bO:SO)(i,e))}function CO(a,e){return function(){R0(this,a).delay=+e.apply(this,arguments)}}function yO(a,e){return e=+e,function(){R0(this,a).delay=e}}function AO(a){var e=this._id;return arguments.length?this.each((typeof a=="function"?CO:yO)(e,a)):Lr(this.node(),e).delay}function RO(a,e){return function(){rn(this,a).duration=+e.apply(this,arguments)}}function IO(a,e){return e=+e,function(){rn(this,a).duration=e}}function PO(a){var e=this._id;return arguments.length?this.each((typeof a=="function"?RO:IO)(e,a)):Lr(this.node(),e).duration}function MO(a,e){if(typeof e!="function")throw new Error;return function(){rn(this,a).ease=e}}function DO(a){var e=this._id;return arguments.length?this.each(MO(e,a)):Lr(this.node(),e).ease}function OO(a,e){return function(){var t=e.apply(this,arguments);if(typeof t!="function")throw new Error;rn(this,a).ease=t}}function wO(a){if(typeof a!="function")throw new Error;return this.each(OO(this._id,a))}function NO(a){typeof a!="function"&&(a=Ym(a));for(var e=this._groups,t=e.length,i=new Array(t),s=0;s<t;++s)for(var r=e[s],n=r.length,o=i[s]=[],l,h=0;h<n;++h)(l=r[h])&&a.call(l,l.__data__,h,r)&&o.push(l);return new bn(i,this._parents,this._name,this._id)}function FO(a){if(a._id!==this._id)throw new Error;for(var e=this._groups,t=a._groups,i=e.length,s=t.length,r=Math.min(i,s),n=new Array(i),o=0;o<r;++o)for(var l=e[o],h=t[o],c=l.length,u=n[o]=new Array(c),d,f=0;f<c;++f)(d=l[f]||h[f])&&(u[f]=d);for(;o<i;++o)n[o]=e[o];return new bn(n,this._parents,this._name,this._id)}function LO(a){return(a+"").trim().split(/^|\s+/).every(function(e){var t=e.indexOf(".");return t>=0&&(e=e.slice(0,t)),!e||e==="start"})}function BO(a,e,t){var i,s,r=LO(e)?R0:rn;return function(){var n=r(this,a),o=n.on;o!==i&&(s=(i=o).copy()).on(e,t),n.on=s}}function UO(a,e){var t=this._id;return arguments.length<2?Lr(this.node(),t).on.on(a):this.each(BO(t,a,e))}function VO(a){return function(){var e=this.parentNode;for(var t in this.__transition)if(+t!==a)return;e&&e.removeChild(this)}}function kO(){return this.on("end.remove",VO(this._id))}function GO(a){var e=this._name,t=this._id;typeof a!="function"&&(a=E0(a));for(var i=this._groups,s=i.length,r=new Array(s),n=0;n<s;++n)for(var o=i[n],l=o.length,h=r[n]=new Array(l),c,u,d=0;d<l;++d)(c=o[d])&&(u=a.call(c,c.__data__,d,o))&&("__data__"in c&&(u.__data__=c.__data__),h[d]=u,du(h[d],e,t,d,h,Lr(c,t)));return new bn(r,this._parents,e,t)}function zO(a){var e=this._name,t=this._id;typeof a!="function"&&(a=Xm(a));for(var i=this._groups,s=i.length,r=[],n=[],o=0;o<s;++o)for(var l=i[o],h=l.length,c,u=0;u<h;++u)if(c=l[u]){for(var d=a.call(c,c.__data__,u,l),f,p=Lr(c,t),_=0,m=d.length;_<m;++_)(f=d[_])&&du(f,e,t,_,d,p);r.push(d),n.push(c)}return new bn(r,n,e,t)}var WO=ah.prototype.constructor;function HO(){return new WO(this._groups,this._parents)}function XO(a,e){var t,i,s;return function(){var r=Uo(this,a),n=(this.style.removeProperty(a),Uo(this,a));return r===n?null:r===t&&n===i?s:s=e(t=r,i=n)}}function pg(a){return function(){this.style.removeProperty(a)}}function YO(a,e,t){var i,s=t+"",r;return function(){var n=Uo(this,a);return n===s?null:n===i?r:r=e(i=n,t)}}function KO(a,e,t){var i,s,r;return function(){var n=Uo(this,a),o=t(this),l=o+"";return o==null&&(l=o=(this.style.removeProperty(a),Uo(this,a))),n===l?null:n===i&&l===s?r:(s=l,r=e(i=n,o))}}function $O(a,e){var t,i,s,r="style."+e,n="end."+r,o;return function(){var l=rn(this,a),h=l.on,c=l.value[r]==null?o||(o=pg(e)):void 0;(h!==t||s!==c)&&(i=(t=h).copy()).on(n,s=c),l.on=i}}function jO(a,e,t){var i=(a+="")=="transform"?Z3:fg;return e==null?this.styleTween(a,XO(a,i)).on("end.style."+a,pg(a)):typeof e=="function"?this.styleTween(a,KO(a,i,I0(this,"style."+a,e))).each($O(this._id,a)):this.styleTween(a,YO(a,i,e),t).on("end.style."+a,null)}function qO(a,e,t){return function(i){this.style.setProperty(a,e.call(this,i),t)}}function QO(a,e,t){var i,s;function r(){var n=e.apply(this,arguments);return n!==s&&(i=(s=n)&&qO(a,n,t)),i}return r._value=e,r}function ZO(a,e,t){var i="style."+(a+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(e==null)return this.tween(i,null);if(typeof e!="function")throw new Error;return this.tween(i,QO(a,e,t==null?"":t))}function JO(a){return function(){this.textContent=a}}function ew(a){return function(){var e=a(this);this.textContent=e==null?"":e}}function tw(a){return this.tween("text",typeof a=="function"?ew(I0(this,"text",a)):JO(a==null?"":a+""))}function iw(a){return function(e){this.textContent=a.call(this,e)}}function sw(a){var e,t;function i(){var s=a.apply(this,arguments);return s!==t&&(e=(t=s)&&iw(s)),e}return i._value=a,i}function rw(a){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(a==null)return this.tween(e,null);if(typeof a!="function")throw new Error;return this.tween(e,sw(a))}function nw(){for(var a=this._name,e=this._id,t=_g(),i=this._groups,s=i.length,r=0;r<s;++r)for(var n=i[r],o=n.length,l,h=0;h<o;++h)if(l=n[h]){var c=Lr(l,e);du(l,a,t,h,n,{time:c.time+c.delay+c.duration,delay:0,duration:c.duration,ease:c.ease})}return new bn(i,this._parents,a,t)}function aw(){var a,e,t=this,i=t._id,s=t.size();return new Promise(function(r,n){var o={value:n},l={value:function(){--s===0&&r()}};t.each(function(){var h=rn(this,i),c=h.on;c!==a&&(e=(a=c).copy(),e._.cancel.push(o),e._.interrupt.push(o),e._.end.push(l)),h.on=e}),s===0&&r()})}var ow=0;function bn(a,e,t,i){this._groups=a,this._parents=e,this._name=t,this._id=i}function _g(){return++ow}var on=ah.prototype;bn.prototype={constructor:bn,select:GO,selectAll:zO,selectChild:on.selectChild,selectChildren:on.selectChildren,filter:NO,merge:FO,selection:HO,transition:nw,call:on.call,nodes:on.nodes,node:on.node,size:on.size,empty:on.empty,each:on.each,on:UO,attr:vO,attrTween:EO,style:jO,styleTween:ZO,text:tw,textTween:rw,remove:kO,tween:uO,delay:AO,duration:PO,ease:DO,easeVarying:wO,end:aw,[Symbol.iterator]:on[Symbol.iterator]};function lw(a){return((a*=2)<=1?a*a*a:(a-=2)*a*a+2)/2}var hw={time:null,delay:0,duration:250,ease:lw};function cw(a,e){for(var t;!(t=a.__transition)||!(t=t[e]);)if(!(a=a.parentNode))throw new Error(`transition ${e} not found`);return t}function uw(a){var e,t;a instanceof bn?(e=a._id,a=a._name):(e=_g(),(t=hw).time=A0(),a=a==null?null:a+"");for(var i=this._groups,s=i.length,r=0;r<s;++r)for(var n=i[r],o=n.length,l,h=0;h<o;++h)(l=n[h])&&du(l,a,e,h,n,t||cw(l,e));return new bn(i,this._parents,a,e)}ah.prototype.interrupt=lO;ah.prototype.transition=uw;function mo(a,e,t){this.k=a,this.x=e,this.y=t}mo.prototype={constructor:mo,scale:function(a){return a===1?this:new mo(this.k*a,this.x,this.y)},translate:function(a,e){return a===0&e===0?this:new mo(this.k,this.x+this.k*a,this.y+this.k*e)},apply:function(a){return[a[0]*this.k+this.x,a[1]*this.k+this.y]},applyX:function(a){return a*this.k+this.x},applyY:function(a){return a*this.k+this.y},invert:function(a){return[(a[0]-this.x)/this.k,(a[1]-this.y)/this.k]},invertX:function(a){return(a-this.x)/this.k},invertY:function(a){return(a-this.y)/this.k},rescaleX:function(a){return a.copy().domain(a.range().map(this.invertX,this).map(a.invert,a))},rescaleY:function(a){return a.copy().domain(a.range().map(this.invertY,this).map(a.invert,a))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};new mo(1,0,0);mo.prototype;const dw="gridPixelShader",fw=`#extension GL_OES_standard_derivatives : enable
#define SQRT2 1.41421356
#define PI 3.14159
precision highp float;
uniform float visibility;
uniform vec3 mainColor;
uniform vec3 lineColor;
uniform vec4 gridControl;
uniform vec3 gridOffset;
varying vec3 vPosition;
varying vec3 vNormal;
#include<fogFragmentDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;
uniform sampler2D opacitySampler;
uniform vec2 vOpacityInfos;
#endif
float getDynamicVisibility(float position) {
float majorGridFrequency=gridControl.y;
if (floor(position+0.5)==floor(position/majorGridFrequency+0.5)*majorGridFrequency)
{
return 1.0;
} 
return gridControl.z;
}
float getAnisotropicAttenuation(float differentialLength) {
const float maxNumberOfLines=10.0;
return clamp(1.0/(differentialLength+1.0)-1.0/maxNumberOfLines,0.0,1.0);
}
float isPointOnLine(float position,float differentialLength) {
float fractionPartOfPosition=position-floor(position+0.5); 
fractionPartOfPosition/=differentialLength; 
fractionPartOfPosition=clamp(fractionPartOfPosition,-1.,1.);
float result=0.5+0.5*cos(fractionPartOfPosition*PI); 
return result; 
}
float contributionOnAxis(float position) {
float differentialLength=length(vec2(dFdx(position),dFdy(position)));
differentialLength*=SQRT2; 
float result=isPointOnLine(position,differentialLength);
float dynamicVisibility=getDynamicVisibility(position);
result*=dynamicVisibility;
float anisotropicAttenuation=getAnisotropicAttenuation(differentialLength);
result*=anisotropicAttenuation;
return result;
}
float normalImpactOnAxis(float x) {
float normalImpact=clamp(1.0-3.0*abs(x*x*x),0.0,1.0);
return normalImpact;
}
#define CUSTOM_FRAGMENT_DEFINITIONS
void main(void) {
#define CUSTOM_FRAGMENT_MAIN_BEGIN
float gridRatio=gridControl.x;
vec3 gridPos=(vPosition+gridOffset.xyz)/gridRatio;
float x=contributionOnAxis(gridPos.x);
float y=contributionOnAxis(gridPos.y);
float z=contributionOnAxis(gridPos.z);
vec3 normal=normalize(vNormal);
x*=normalImpactOnAxis(normal.x);
y*=normalImpactOnAxis(normal.y);
z*=normalImpactOnAxis(normal.z);
#ifdef MAX_LINE 
float grid=clamp(max(max(x,y),z),0.,1.);
#else
float grid=clamp(x+y+z,0.,1.);
#endif
vec3 color=mix(mainColor,lineColor,grid);
#ifdef FOG
#include<fogFragment>
#endif
float opacity=1.0;
#ifdef TRANSPARENT
opacity=clamp(grid,0.08,gridControl.w*grid);
#endif 
#ifdef OPACITY
opacity*=texture2D(opacitySampler,vOpacityUV).a;
#endif 
gl_FragColor=vec4(color.rgb,opacity*visibility);
#ifdef TRANSPARENT
#ifdef PREMULTIPLYALPHA
gl_FragColor.rgb*=opacity;
#endif
#else 
#endif
#include<imageProcessingCompatibility>
#define CUSTOM_FRAGMENT_MAIN_END
}
`;Y.ShadersStore[dw]=fw;const pw="gridVertexShader",_w=`precision highp float;
attribute vec3 position;
attribute vec3 normal;
#ifdef UV1
attribute vec2 uv;
#endif
#ifdef UV2
attribute vec2 uv2;
#endif
#include<instancesDeclaration>
uniform mat4 projection;
uniform mat4 view;
varying vec3 vPosition;
varying vec3 vNormal;
#include<fogVertexDeclaration>
#ifdef OPACITY
varying vec2 vOpacityUV;
uniform mat4 opacityMatrix;
uniform vec2 vOpacityInfos;
#endif
#define CUSTOM_VERTEX_DEFINITIONS
void main(void) {
#define CUSTOM_VERTEX_MAIN_BEGIN
#include<instancesVertex>
vec4 worldPos=finalWorld*vec4(position,1.0);
#include<fogVertex>
vec4 cameraSpacePosition=view*worldPos;
gl_Position=projection*cameraSpacePosition;
#ifdef OPACITY
#ifndef UV1
vec2 uv=vec2(0.,0.);
#endif
#ifndef UV2
vec2 uv2=vec2(0.,0.);
#endif
if (vOpacityInfos.x==0.)
{
vOpacityUV=vec2(opacityMatrix*vec4(uv,1.0,0.0));
}
else
{
vOpacityUV=vec2(opacityMatrix*vec4(uv2,1.0,0.0));
}
#endif 
vPosition=position;
vNormal=normal;
#define CUSTOM_VERTEX_MAIN_END
}`;Y.ShadersStore[pw]=_w;class mw extends rr{constructor(){super(),this.OPACITY=!1,this.TRANSPARENT=!1,this.FOG=!1,this.PREMULTIPLYALPHA=!1,this.MAX_LINE=!1,this.UV1=!1,this.UV2=!1,this.INSTANCES=!1,this.THIN_INSTANCES=!1,this.IMAGEPROCESSINGPOSTPROCESS=!1,this.SKIPFINALCOLORCLAMP=!1,this.rebuild()}}class Cs extends zo{constructor(e,t){super(e,t),this.mainColor=re.Black(),this.lineColor=re.Teal(),this.gridRatio=1,this.gridOffset=g.Zero(),this.majorUnitFrequency=10,this.minorUnitVisibility=.33,this.opacity=1,this.preMultiplyAlpha=!1,this.useMaxLine=!1,this._gridControl=new Ge(this.gridRatio,this.majorUnitFrequency,this.minorUnitVisibility,this.opacity)}needAlphaBlending(){return this.opacity<1||this._opacityTexture&&this._opacityTexture.isReady()}needAlphaBlendingForMesh(e){return e.visibility<1||this.needAlphaBlending()}isReadyForSubMesh(e,t,i){if(this.isFrozen&&t.effect&&t.effect._wasPreviouslyReady&&t.effect._wasPreviouslyUsingInstances===i)return!0;t.materialDefines||(t.materialDefines=new mw);const s=t.materialDefines,r=this.getScene();if(this._isReadyForSubMesh(t))return!0;if(s.TRANSPARENT!==this.opacity<1&&(s.TRANSPARENT=!s.TRANSPARENT,s.markAsUnprocessed()),s.PREMULTIPLYALPHA!=this.preMultiplyAlpha&&(s.PREMULTIPLYALPHA=!s.PREMULTIPLYALPHA,s.markAsUnprocessed()),s.MAX_LINE!==this.useMaxLine&&(s.MAX_LINE=!s.MAX_LINE,s.markAsUnprocessed()),s._areTexturesDirty&&(s._needUVs=!1,r.texturesEnabled&&this._opacityTexture&&ce.OpacityTextureEnabled))if(this._opacityTexture.isReady())s._needUVs=!0,s.OPACITY=!0;else return!1;if(se.PrepareDefinesForMisc(e,r,!1,!1,this.fogEnabled,!1,s),se.PrepareDefinesForFrameBoundValues(r,r.getEngine(),s,!!i),s.isDirty){s.markAsProcessed(),r.resetCachedMaterial(),se.PrepareDefinesForAttributes(e,s,!1,!1);const n=[y.PositionKind,y.NormalKind];s.UV1&&n.push(y.UVKind),s.UV2&&n.push(y.UV2Kind),s.IMAGEPROCESSINGPOSTPROCESS=r.imageProcessingConfiguration.applyByPostProcess,se.PrepareAttributesForInstances(n,s);const o=s.toString();t.setEffect(r.getEngine().createEffect("grid",n,["projection","mainColor","lineColor","gridControl","gridOffset","vFogInfos","vFogColor","world","view","opacityMatrix","vOpacityInfos","visibility"],["opacitySampler"],o,void 0,this.onCompiled,this.onError),s,this._materialContext)}return!t.effect||!t.effect.isReady()?!1:(s._renderId=r.getRenderId(),t.effect._wasPreviouslyReady=!0,t.effect._wasPreviouslyUsingInstances=!!i,!0)}bindForSubMesh(e,t,i){const s=this.getScene(),r=i.materialDefines;if(!r)return;const n=i.effect;!n||(this._activeEffect=n,this._activeEffect.setFloat("visibility",t.visibility),(!r.INSTANCES||r.THIN_INSTANCE)&&this.bindOnlyWorldMatrix(e),this._activeEffect.setMatrix("view",s.getViewMatrix()),this._activeEffect.setMatrix("projection",s.getProjectionMatrix()),this._mustRebind(s,n)&&(this._activeEffect.setColor3("mainColor",this.mainColor),this._activeEffect.setColor3("lineColor",this.lineColor),this._activeEffect.setVector3("gridOffset",this.gridOffset),this._gridControl.x=this.gridRatio,this._gridControl.y=Math.round(this.majorUnitFrequency),this._gridControl.z=this.minorUnitVisibility,this._gridControl.w=this.opacity,this._activeEffect.setVector4("gridControl",this._gridControl),this._opacityTexture&&ce.OpacityTextureEnabled&&(this._activeEffect.setTexture("opacitySampler",this._opacityTexture),this._activeEffect.setFloat2("vOpacityInfos",this._opacityTexture.coordinatesIndex,this._opacityTexture.level),this._activeEffect.setMatrix("opacityMatrix",this._opacityTexture.getTextureMatrix()))),se.BindFogParameters(s,t,this._activeEffect),this._afterBind(t,this._activeEffect))}dispose(e){super.dispose(e)}clone(e){return xe.Clone(()=>new Cs(e,this.getScene()),this)}serialize(){const e=super.serialize();return e.customType="BABYLON.GridMaterial",e}getClassName(){return"GridMaterial"}static Parse(e,t,i){return xe.Parse(()=>new Cs(e.name,t),e,t,i)}}T([pi()],Cs.prototype,"mainColor",void 0);T([pi()],Cs.prototype,"lineColor",void 0);T([R()],Cs.prototype,"gridRatio",void 0);T([Zi()],Cs.prototype,"gridOffset",void 0);T([R()],Cs.prototype,"majorUnitFrequency",void 0);T([R()],Cs.prototype,"minorUnitVisibility",void 0);T([R()],Cs.prototype,"opacity",void 0);T([R()],Cs.prototype,"preMultiplyAlpha",void 0);T([R()],Cs.prototype,"useMaxLine",void 0);T([Qe("opacityTexture")],Cs.prototype,"_opacityTexture",void 0);T([ie("_markAllSubMeshesAsTexturesDirty")],Cs.prototype,"opacityTexture",void 0);he("BABYLON.GridMaterial",Cs);function Bi(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Bi=()=>a;var a={},e=Object.prototype,t=e.hasOwnProperty,i=typeof Symbol=="function"?Symbol:{},s=i.iterator||"@@iterator",r=i.asyncIterator||"@@asyncIterator",n=i.toStringTag||"@@toStringTag";function o(P,O,N){return Object.defineProperty(P,O,{value:N,enumerable:!0,configurable:!0,writable:!0}),P[O]}try{o({},"")}catch{o=(O,N,$)=>O[N]=$}function l(P,O,N,$){var W=O&&O.prototype instanceof u?O:u,K=Object.create(W.prototype),te=new A($||[]);return K._invoke=((ve,_e,j)=>{var ee="suspendedStart";return(F,z)=>{if(ee==="executing")throw new Error("Generator is already running");if(ee==="completed"){if(F==="throw")throw z;return D()}for(j.method=F,j.arg=z;;){var Z=j.delegate;if(Z){var Ee=S(Z,j);if(Ee){if(Ee===c)continue;return Ee}}if(j.method==="next")j.sent=j._sent=j.arg;else if(j.method==="throw"){if(ee==="suspendedStart")throw ee="completed",j.arg;j.dispatchException(j.arg)}else j.method==="return"&&j.abrupt("return",j.arg);ee="executing";var He=h(ve,_e,j);if(He.type==="normal"){if(ee=j.done?"completed":"suspendedYield",He.arg===c)continue;return{value:He.arg,done:j.done}}He.type==="throw"&&(ee="completed",j.method="throw",j.arg=He.arg)}}})(P,N,te),K}function h(P,O,N){try{return{type:"normal",arg:P.call(O,N)}}catch($){return{type:"throw",arg:$}}}a.wrap=l;var c={};function u(){}function d(){}function f(){}var p={};o(p,s,function(){return this});var _=Object.getPrototypeOf,m=_&&_(_(M([])));m&&m!==e&&t.call(m,s)&&(p=m);var v=f.prototype=u.prototype=Object.create(p);function x(P){["next","throw","return"].forEach(function(O){o(P,O,function(N){return this._invoke(O,N)})})}function b(P,O){function N(W,K,te,ve){var _e=h(P[W],P,K);if(_e.type!=="throw"){var j=_e.arg,ee=j.value;return ee&&typeof ee=="object"&&t.call(ee,"__await")?O.resolve(ee.__await).then(F=>{N("next",F,te,ve)},F=>{N("throw",F,te,ve)}):O.resolve(ee).then(F=>{j.value=F,te(j)},F=>N("throw",F,te,ve))}ve(_e.arg)}var $;this._invoke=(W,K)=>{function te(){return new O((ve,_e)=>{N(W,K,ve,_e)})}return $=$?$.then(te,te):te()}}function S(P,O){var N=P.iterator[O.method];if(N===void 0){if(O.delegate=null,O.method==="throw"){if(P.iterator.return&&(O.method="return",O.arg=void 0,S(P,O),O.method==="throw"))return c;O.method="throw",O.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var $=h(N,P.iterator,O.arg);if($.type==="throw")return O.method="throw",O.arg=$.arg,O.delegate=null,c;var W=$.arg;return W?W.done?(O[P.resultName]=W.value,O.next=P.nextLoc,O.method!=="return"&&(O.method="next",O.arg=void 0),O.delegate=null,c):W:(O.method="throw",O.arg=new TypeError("iterator result is not an object"),O.delegate=null,c)}function C(P){var O={tryLoc:P[0]};1 in P&&(O.catchLoc=P[1]),2 in P&&(O.finallyLoc=P[2],O.afterLoc=P[3]),this.tryEntries.push(O)}function E(P){var O=P.completion||{};O.type="normal",delete O.arg,P.completion=O}function A(P){this.tryEntries=[{tryLoc:"root"}],P.forEach(C,this),this.reset(!0)}function M(P){if(P){var O=P[s];if(O)return O.call(P);if(typeof P.next=="function")return P;if(!isNaN(P.length)){var N=-1,$=function W(){for(;++N<P.length;)if(t.call(P,N))return W.value=P[N],W.done=!1,W;return W.value=void 0,W.done=!0,W};return $.next=$}}return{next:D}}function D(){return{value:void 0,done:!0}}return d.prototype=f,o(v,"constructor",f),o(f,"constructor",d),d.displayName=o(f,n,"GeneratorFunction"),a.isGeneratorFunction=P=>{var O=typeof P=="function"&&P.constructor;return!!O&&(O===d||(O.displayName||O.name)==="GeneratorFunction")},a.mark=P=>(Object.setPrototypeOf?Object.setPrototypeOf(P,f):(P.__proto__=f,o(P,n,"GeneratorFunction")),P.prototype=Object.create(v),P),a.awrap=P=>({__await:P}),x(b.prototype),o(b.prototype,r,function(){return this}),a.AsyncIterator=b,a.async=(P,O,N,$,W)=>{W===void 0&&(W=Promise);var K=new b(l(P,O,N,$),W);return a.isGeneratorFunction(O)?K:K.next().then(te=>te.done?te.value:K.next())},x(v),o(v,n,"Generator"),o(v,s,function(){return this}),o(v,"toString",()=>"[object Generator]"),a.keys=P=>{var O=[];for(var N in P)O.push(N);return O.reverse(),function $(){for(;O.length;){var W=O.pop();if(W in P)return $.value=W,$.done=!1,$}return $.done=!0,$}},a.values=M,A.prototype={constructor:A,reset:function(P){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(E),!P)for(var O in this)O.charAt(0)==="t"&&t.call(this,O)&&!isNaN(+O.slice(1))&&(this[O]=void 0)},stop:function(){this.done=!0;var P=this.tryEntries[0].completion;if(P.type==="throw")throw P.arg;return this.rval},dispatchException:function(P){if(this.done)throw P;var O=this;function N(_e,j){return K.type="throw",K.arg=P,O.next=_e,j&&(O.method="next",O.arg=void 0),!!j}for(var $=this.tryEntries.length-1;$>=0;--$){var W=this.tryEntries[$],K=W.completion;if(W.tryLoc==="root")return N("end");if(W.tryLoc<=this.prev){var te=t.call(W,"catchLoc"),ve=t.call(W,"finallyLoc");if(te&&ve){if(this.prev<W.catchLoc)return N(W.catchLoc,!0);if(this.prev<W.finallyLoc)return N(W.finallyLoc)}else if(te){if(this.prev<W.catchLoc)return N(W.catchLoc,!0)}else{if(!ve)throw new Error("try statement without catch or finally");if(this.prev<W.finallyLoc)return N(W.finallyLoc)}}}},abrupt:function(P,O){for(var N=this.tryEntries.length-1;N>=0;--N){var $=this.tryEntries[N];if($.tryLoc<=this.prev&&t.call($,"finallyLoc")&&this.prev<$.finallyLoc){var W=$;break}}W&&(P==="break"||P==="continue")&&W.tryLoc<=O&&O<=W.finallyLoc&&(W=null);var K=W?W.completion:{};return K.type=P,K.arg=O,W?(this.method="next",this.next=W.finallyLoc,c):this.complete(K)},complete:function(P,O){if(P.type==="throw")throw P.arg;return P.type==="break"||P.type==="continue"?this.next=P.arg:P.type==="return"?(this.rval=this.arg=P.arg,this.method="return",this.next="end"):P.type==="normal"&&O&&(this.next=O),c},finish:function(P){for(var O=this.tryEntries.length-1;O>=0;--O){var N=this.tryEntries[O];if(N.finallyLoc===P)return this.complete(N.completion,N.afterLoc),E(N),c}},catch:function(P){for(var O=this.tryEntries.length-1;O>=0;--O){var N=this.tryEntries[O];if(N.tryLoc===P){var $=N.completion;if($.type==="throw"){var W=$.arg;E(N)}return W}}throw new Error("illegal catch attempt")},delegateYield:function(P,O,N){return this.delegate={iterator:M(P),resultName:O,nextLoc:N},this.method==="next"&&(this.arg=void 0),c}},a}function gd(a){return gd=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?e=>typeof e:e=>e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e,gd(a)}function Lp(a,e,t,i,s,r,n){try{var o=a[r](n),l=o.value}catch(h){return void t(h)}o.done?e(l):Promise.resolve(l).then(i,s)}function fn(a){return function(){var e=this,t=arguments;return new Promise((i,s)=>{var r=a.apply(e,t);function n(l){Lp(r,i,s,n,o,"next",l)}function o(l){Lp(r,i,s,n,o,"throw",l)}n(void 0)})}}function es(a,e){if(!(a instanceof e))throw new TypeError("Cannot call a class as a function")}function Bp(a,e){for(var t=0;t<e.length;t++){var i=e[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(a,i.key,i)}}function ts(a,e,t){return e&&Bp(a.prototype,e),t&&Bp(a,t),Object.defineProperty(a,"prototype",{writable:!1}),a}function da(a,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(e&&e.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),Object.defineProperty(a,"prototype",{writable:!1}),e&&vd(a,e)}function fc(a){return fc=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},fc(a)}function vd(a,e){return vd=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},vd(a,e)}function gw(a,e){if(e&&(typeof e=="object"||typeof e=="function"))return e;if(e!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(t===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(a)}function fa(a){var e=function(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],()=>{})),!0}catch{return!1}}();return function(){var t,i=fc(a);if(e){var s=fc(this).constructor;t=Reflect.construct(i,arguments,s)}else t=i.apply(this,arguments);return gw(this,t)}}function Up(a,e){return function(t){if(Array.isArray(t))return t}(a)||function(t,i){var s=t==null?null:typeof Symbol<"u"&&t[Symbol.iterator]||t["@@iterator"];if(s!=null){var r,n,o=[],l=!0,h=!1;try{for(s=s.call(t);!(l=(r=s.next()).done)&&(o.push(r.value),!i||o.length!==i);l=!0);}catch(c){h=!0,n=c}finally{try{l||s.return==null||s.return()}finally{if(h)throw n}}return o}}(a,e)||P0(a,e)||function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function xd(a){return function(e){if(Array.isArray(e))return Td(e)}(a)||function(e){if(typeof Symbol<"u"&&e[Symbol.iterator]!=null||e["@@iterator"]!=null)return Array.from(e)}(a)||P0(a)||function(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}()}function P0(a,e){if(a){if(typeof a=="string")return Td(a,e);var t=Object.prototype.toString.call(a).slice(8,-1);return t==="Object"&&a.constructor&&(t=a.constructor.name),t==="Map"||t==="Set"?Array.from(a):t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?Td(a,e):void 0}}function Td(a,e){(e==null||e>a.length)&&(e=a.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=a[t];return i}function no(a,e,t){var i=Number(a.substring(1)),s=i||0;return t?s+e:s}function vw(a,e,t,i){for(var s=e.x,r=e.z,n=e.y,o=s,l=r,h=n,c=0,u=0,d=0,f=a.some(F=>F.includes("G2")),p=0;p<a.length;p++){var _=a[p];switch(_[0]){case"X":o=no(_,o,t);break;case"Y":l=no(_,l,t);break;case"Z":h=no(_,h,t);break;case"I":c=no(_,c,!1);break;case"J":u=no(_,u,!1);break;case"R":d=no(_,d,!1)}}if(d){var m=o-s,v=l-r,x=Math.pow(m,2)+Math.pow(v,2),b=Math.pow(d,2)-x/4;if(x==0||b<0)return{position:{x:o,y:h,z:l},points:[]};var S=Math.sqrt(b/x);(f&&d<0||!f&&d>0)&&(S=-S),c=m/2+v*S,u=v/2-m*S}else if(c==0&&u==0)return{position:{x:o,y:l,z:h},points:[]};var C,E=s==c&&r==l,A=s+c,M=r+u,D=Math.sqrt(c*c+u*u),P=Math.atan2(-u,-c),O=Math.atan2(l-M,o-A);E?C=2*Math.PI:(C=f?P-O:O-P)<0&&(C+=2*Math.PI);var N=D*C/i+.8;N<1&&(N=1);var $=C/N;$*=f?-1:1;for(var W=new Array,K=(n-h)/N,te=s,ve=r,_e=n,j=P,ee=0;ee<N-1;ee++)j+=$,te=A+D*Math.cos(j),ve=M+D*Math.sin(j),_e+=K,W.push({x:te,y:_e,z:ve});return W.push({x:o,y:h,z:l}),{position:{x:o,y:h,z:l},points:W}}function pc(){return new Promise(a=>setTimeout(a)).then(()=>Date.now())}var Vp=function(){function a(){es(this,a),this.tool=0,this.start,this.end,this.extruding=!1,this.gcodeLineNumber=0,this.gcodeFilePosition=0,this.color,this.feedRate=0,this.layerHeight=0}return ts(a,[{key:"length",value:function(){return this.distanceVector(this.start,this.end)}},{key:"renderLine",value:function(e){var t=[this.start,this.end],i=Os.CreateLines("lines",t,e);i.enableEdgesRendering(),i.edgesWidth=10,i.edgesColor=new J(1,1,0,1)}},{key:"renderLineV2",value:function(){var e=Os.CreateTube("tube",{path:[this.start,this.end],radius:.2,tesselation:4,sideOrientation:V.FRONTSIDE,updatable:!1});return e.doNotSyncBoundingInfo=!0,e}},{key:"distanceVector",value:function(e,t){var i=e.x-t.x,s=e.y-t.y,r=e.z-t.z;return Math.sqrt(i*i+s*s+r*r)}},{key:"renderLineV3",value:function(e,t){var i=this.distanceVector(this.start,this.end),s=Math.atan2(this.end.z-this.start.z,this.end.x-this.start.x);e.scaling.x=i,e.scaling.y=this.layerHeight,e.scaling.z=2*this.layerHeight,e.rotation.y=-s,e.position.x=this.start.x+i/2*Math.cos(s),e.position.y=this.start.y,e.position.z=this.start.z+i/2*Math.sin(s),e.color=this.color,e.materialIndex=t?1:0,e.props={gcodeLineNumber:this.gcodeLineNumber,gcodeFilePosition:this.gcodeFilePosition,originalColor:this.color}}},{key:"renderLinev4",value:function(){var e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:.4,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;this.layerHeight===0&&(this.layerHeight=this.start.y);var i={},s=this.distanceVector(this.start,this.end),r=Math.atan2(this.end.z-this.start.z,this.end.x-this.start.x),n=s+t;return i.matrix=L.Compose(new g(n,this.layerHeight,e),Q.FromEulerAngles(0,-r,0),new g(this.start.x+n/2*Math.cos(r),this.start.y,this.start.z+n/2*Math.sin(r))),i.color=this.color,i.props={gcodeLineNumber:this.gcodeLineNumber,gcodeFilePosition:this.gcodeFilePosition,originalColor:this.color},i}},{key:"renderParticle",value:function(e){e.position.x=this.start.x,e.position.y=this.start.y,e.position.z=this.start.z,e.color=this.color}},{key:"getPoints",value:function(){return{points:[this.start,this.end],colors:[this.color,this.color]}}},{key:"getColor",value:function(){return this.extruding?new J(1,1,1,1):new J(1,0,0,1)}},{key:"getVoxelSegments",value:function(e,t){var i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,s=arguments.length>3?arguments[3]:void 0,r=new Array,n=this.distanceVector(this.start,this.end);if(!(n<.1)){var o=Math.round(100*(n/(e/2)-1))/100,l=Math.atan2(this.end.z-this.start.z,this.end.x-this.start.x);s&&(this.start.y-=e/2,this.end.y-=e/2);var h=this.start.clone(),c=0;r.push(h.clone());var u=e/2*Math.cos(l),d=e/2*Math.sin(l),f=0;for(o!==0&&(f=(this.end.y-this.start.y)/o);c<o;){if(h.x+=u,h.y+=f,h.z+=d,r.push(h.clone()),i>e)for(var p=h.x-i;p<=h.x+i;p+=e)for(var _=h.z-i;_<h.z+i;_+=e)r.push(new g(p,h.y,_));c++}if(r.push(this.end.clone()),this.layerHeight>t&&s){for(var m=[],v=0;v<r.length;v++)for(var x=r[v],b=1;b<Math.ceil(this.layerHeight/t);b++)m.push(new g(x.x,x.y-b*t,x.z));r.push.apply(r,m)}return r}}}]),a}(),Ah=function(){function a(){es(this,a),this.name="",this.color=new J(0,0,1,1),this.diameter=.4,this.toolType=bd.Extruder}return ts(a,[{key:"colorString",get:function(){return this.color.toHexString()},set:function(e){this.color=J.FromHexString(e+"FF")}},{key:"isAdditive",value:function(){return this.toolType===bd.Extruder}},{key:"getDiameter",value:function(){return this.diameter}},{key:"toJson",value:function(){return JSON.stringify(this)}}],[{key:"fromJson",value:function(e){var t;t=gd(e)==="object"?e:JSON.parse(e);var i=new a;return i.name=t.name,i.color=new J(t.color.r,t.color.g,t.color.b,t.color.a),i.diameter=parseFloat(t.diameter),i.toolType=t.toolType,i}}]),a}(),bd={Extruder:"Extruder",Endmill:"Endmill"};new Array;var Wu,Hu,Xu,fu=function(){function a(e,t,i,s,r){es(this,a),this.scene=e,this.specularColor=t,this.loadingProgressCallback=i,this.renderFuncs=s,this.solidMat,this.transparentMat,this.previousFilePosition=0,this.currentFilePosition=0,this.tools=r,this.scrubDistance=3e4,this.progressColor=new J(0,1,0,1),this.isLoading=!0,this.vertexAlpha=!1,this.forceRedraw=!1,this.material=null,this.fadeRate=.2}return ts(a,[{key:"updateFilePosition",value:function(e){this.previousFilePosition=this.currentFilePosition,this.currentFilePosition=e}},{key:"updateLiveTrackingShowSolid",value:function(e){this.liveTrackingShowSolid=e}},{key:"lerp",value:function(e,t,i){return e+(t-e)*i}}]),a}(),xw=function(a){da(t,fu);var e=fa(t);function t(i,s,r,n,o,l){var h;return es(this,t),(h=e.call(this,i,s,r,n,o)).meshIndex=l!=null?l:0,h.lostInSpace=L.Identity().setTranslation(new g(1e4,1e4,1e4)),h.additiveColor=new J(0,1,0,.8),h}return ts(t,[{key:"buildBox",value:function(){if(this.solidMat)try{this.solidMat.dispose(),this.solidMat=null}catch{console.warn("nothing to dispose")}if(this.transparentMat)try{this.transparentMat.dispose(),this.transparentMat=null}catch{console.warn("nothing to dispose")}var i=Os.CreateBox("box",{width:1,height:1,depth:1,sideOrientation:V.FRONTSIDE},this.scene);return this.material=new pe("mat",this.scene),this.material.specularColor=this.specularColor,i.material=this.material,this.vertexAlpha&&(i.hasVertexAlpha=!0,i.material.forceDepthWrite=!0,i.material.alpha=.99),i}},{key:"render",value:function(i){for(var s=this,r=new Array,n=new Array,o=this.vertexAlpha?.05:0,l=0;l<i.length;l++){var h=i[l],c=this.tools[h.tool];if(h.extruding){var u=h.renderLinev4(c.getDiameter(),.1),d={};d.matrix=u.matrix,d.color=u.color,r.push(d),n.push(u.props.gcodeFilePosition)}}for(var f=new Float32Array(16*r.length),p=new Float32Array(4*r.length),_=new Array,m=0;m<r.length;m++){var v=r[m];v.matrix.copyToArray(f,16*m),v.color.toArray(p,4*m),p[4*m+3]=o,_.push(!1)}var x=this.buildBox();x.alphaIndex=this.meshIndex,x.renderingGroupId=2,x.thinInstanceSetBuffer("matrix",f,16),x.thinInstanceSetBuffer("color",p,4),x.thinInstanceRefreshBoundingInfo();var b=function(){for(var P=A,O=A,N=0;N<r.length;N++){var $=16*N,W=4*N;if(A)n[N]<s.currentFilePosition?(r[N].color.toArray(p,W),r[N].matrix.copyToArray(f,16*N),p[W+3]=1,_[N]=!0):(o==0?s.lostInSpace.copyToArray(f,16*N):r[N].matrix.copyToArray(f,16*N),p[W+3]=o,_[N]=!1);else if(!_[N])if(n[N]<s.currentFilePosition&&p[W+3]<.5)s.progressColor.toArray(p,W),p[W+3]=.9,P=!0,r[N].matrix.copyToArray(f,$),O=!0;else{if(p[W+3]>.5&&p[W+3]<1){p[W+3]+=.02;var K=10*(p[W+3]-.9);p[W]=s.lerp(s.progressColor.r,r[N].color.r,K),p[W+1]=s.lerp(s.progressColor.g,r[N].color.g,K),p[W+2]=s.lerp(s.progressColor.b,r[N].color.b,K),P=!0}p[W+3]>=1&&!_[N]&&(r[N].color.toArray(p,W),p[W+3]=1,_[N]=!0,P=!0)}}P&&x.thinInstanceBufferUpdated("color"),O&&(x.thinInstanceBufferUpdated("matrix"),x.thinInstanceRefreshBoundingInfo())};if(i.length!=0){var S=i[0].gcodeFilePosition,C=i.slice(-1)[0].gcodeFilePosition,E=0,A=!1,M=Date.now(),D=function(){if(!(s.isLoading||Date.now()-M<200)){if(M=Date.now(),Math.abs(E-s.currentFilePosition)>s.scrubDistance||s.forceRedraw){A=!0,s.forceRedraw=!1,E=0;for(var P=0;P<_.length;P++)_[P]=!1;b()}else s.currentFilePosition>=S-3e4&&s.currentFilePosition<=C+3e4&&(A=!1,b());E=s.currentFilePosition}};this.renderFuncs.push(D),this.scene.registerBeforeRender(D)}}}]),t}(),Tw=function(a){da(t,fu);var e=fa(t);function t(i,s,r,n,o,l){var h;return es(this,t),(h=e.call(this,i,s,r,n,o)).meshIndex=l!=null?l:0,h.lostInSpace=L.Identity().setTranslation(new g(1e4,1e4,1e4)),h.additiveColor=new J(0,1,0,.8),h}return ts(t,[{key:"buildCylinder",value:function(){if(this.solidMat)try{this.solidMat.dispose(),this.solidMat=null}catch{console.warn("nothing to dispose")}if(this.transparentMat)try{this.transparentMat.dispose(),this.transparentMat=null}catch{console.warn("nothing to dispose")}var i=Os.CreateCylinder("box",{height:1,diameter:1},this.scene);return i.locallyTranslate(new g(0,0,0)),i.rotate(new g(0,0,1),Math.PI/2,Ze.WORLD),i.bakeCurrentTransformIntoVertices(),this.material=new pe("mat",this.scene),this.material.specularColor=this.specularColor,i.material=this.material,this.vertexAlpha&&(i.hasVertexAlpha=!0,i.material.forceDepthWrite=!0,i.material.alpha=.99),i}},{key:"render",value:function(i){for(var s=this,r=new Array,n=new Array,o=this.vertexAlpha?.05:0,l=0;l<i.length;l++){var h=i[l],c=this.tools[h.tool];if(h.extruding){var u=h.renderLinev4(c.getDiameter(),.1),d={};d.matrix=u.matrix,d.color=u.color,r.push(d),n.push(u.props.gcodeFilePosition)}}for(var f=new Float32Array(16*r.length),p=new Float32Array(4*r.length),_=new Array,m=0;m<r.length;m++){var v=r[m];v.matrix.copyToArray(f,16*m),v.color.toArray(p,4*m),p[4*m+3]=o,_.push(!1)}var x=this.buildCylinder();x.thinInstanceSetBuffer("matrix",f,16),x.thinInstanceSetBuffer("color",p,4),x.thinInstanceRefreshBoundingInfo(),x.alphaIndex=this.meshIndex,x.renderingGroupId=2;var b=function(){for(var P=A,O=A,N=0;N<r.length;N++){var $=16*N,W=4*N;if(A)n[N]<s.currentFilePosition?(r[N].color.toArray(p,W),r[N].matrix.copyToArray(f,$),p[W+3]=1,_[N]=!0):(o==0?s.lostInSpace.copyToArray(f,$):r[N].matrix.copyToArray(f,$),p[W+3]=o,_[N]=!1);else if(!_[N])if(n[N]<s.currentFilePosition&&p[W+3]<.5)s.progressColor.toArray(p,W),p[W+3]=.9,P=!0,r[N].matrix.copyToArray(f,$),O=!0;else{if(p[W+3]>.5&&p[W+3]<1){p[W+3]+=.02;var K=10*(p[W+3]-.9);p[W]=s.lerp(s.progressColor.r,r[N].color.r,K),p[W+1]=s.lerp(s.progressColor.g,r[N].color.g,K),p[W+2]=s.lerp(s.progressColor.b,r[N].color.b,K)}p[W+3]>=1&&!_[N]&&(r[N].color.toArray(p,W),p[W+3]=1,_[N]=!0,P=!0)}}P&&x.thinInstanceBufferUpdated("color"),O&&(x.thinInstanceBufferUpdated("matrix"),x.thinInstanceRefreshBoundingInfo())};if(i.length!=0){var S=i[0].gcodeFilePosition,C=i.slice(-1)[0].gcodeFilePosition,E=0,A=!1,M=Date.now(),D=function(){if(!(s.isLoading||Date.now()-M<200)){if(M=Date.now(),Math.abs(E-s.currentFilePosition)>s.scrubDistance||s.forceRedraw){A=!0,s.forceRedraw=!1,E=0;for(var P=0;P<_.length;P++)_[P]=!1;b()}else s.currentFilePosition>=S-3e4&&s.currentFilePosition<=C+3e4&&(A=!1,b());E=s.currentFilePosition}};this.renderFuncs.push(D),this.scene.registerBeforeRender(D)}}}]),t}(),bw=ts(function a(e,t){es(this,a),this.filePosition=e,this.add=t,this.complete=!1}),mg=function(a){da(i,fu);var e,t=fa(i);function i(s,r,n,o,l,h,c){var u;return es(this,i),(u=t.call(this,s,r,n,o,l)).voxelWidth=parseFloat(h),u.voxelHeight=parseFloat(c),u.solidMat,u.transparentMat,u.hasSubtractive=!1,u.lostInSpace=L.Identity().setTranslation(new g(1e4,1e4,1e4)),u.clearColor=new J(1,0,0,0),u.additiveColor=new J(0,1,0,.8),u.subtractiveColor=new J(1,0,0,.8),u}return ts(i,[{key:"buildBox",value:function(){if(this.solidMat)try{this.solidMat.dispose(),this.solidMat=null}catch{}if(this.transparentMat)try{this.transparentMat.dispose(),this.transparentMat=null}catch{}var s=Os.CreateBox("box",{width:this.voxelWidth,height:this.voxelHeight,depth:this.voxelWidth},this.scene);return s.hasVertexAlpha=!0,s.updateFacetData=!0,this.material=new pe("mat",this.scene),this.material.needDepthPrePass=!0,this.material.forceDepthWrite=!0,this.material.backFaceCulling=!1,s.material=this.material,s}},{key:"render",value:(e=fn(Bi().mark(function s(r){var n,o,l,h,c,u,d,f,p,_,m,v,x,b,S,C,E,A,M,D,P,O=this;return Bi().wrap(function(N){for(;;)switch(N.prev=N.next){case 0:for(this.isLoading=!0,n=parseInt(300/this.voxelWidth)+1,o=n,l=parseInt(300/this.voxelHeight)+1,h=new Array(o),c=0;c<=l;c++)h[c]=new Object;u=0,d=new Date,f=0;case 10:if(!(f<r.length)){N.next=60;break}if(p=r[f],_=this.tools[p.tool],p.extruding){N.next=15;break}return N.abrupt("continue",57);case 15:if((m=p.getVoxelSegments(this.voxelWidth,this.voxelHeight,_.getDiameter()/2,_.isAdditive()))!==void 0&&m.length!==0){N.next=18;break}return N.abrupt("continue",57);case 18:v=new bw(p.gcodeFilePosition,_.isAdditive()),x=0;case 20:if(!(x<m.length)){N.next=51;break}if(b=m[x],S=Math.floor(b.x/this.voxelWidth),C=Math.floor(b.y/this.voxelHeight),E=Math.floor(b.z/this.voxelWidth),C<0&&(C=0),C!=u&&_.isAdditive()&&(u=C),_.toolType!=="Extruder"){N.next=32;break}try{A=h[C][S][E]}catch{A=null}if(A)A.voxelEvents.push(v);else try{h[C].hasOwnProperty(S)||(h[C][S]={}),h[C][S][E]={color:p.color,voxelEvents:[v]}}catch($){console.log($),console.log("".concat(S,"  ").concat(C," ").concat(E))}N.next=48;break;case 32:this.hasSubtractive=!0,M=C;case 34:if(!(M<=u+1)){N.next=48;break}N.prev=35,h[M][S][E]?h[M][S][E].voxelEvents.push(v):(h[M].hasOwnProperty(S)||(h[M][S]={}),h[M][S][E]={color:p.color,voxelEvents:[v]}),N.next=45;break;case 39:if(N.prev=39,N.t0=N.catch(35),!(M<0)){N.next=43;break}return N.abrupt("continue",45);case 43:h[M].hasOwnProperty(S)||(h[M][S]={}),h[M][S][E]={color:p.color,voxelEvents:[v]};case 45:M++,N.next=34;break;case 48:x++,N.next=20;break;case 51:if(r[f]=null,!(f%1e4==0||new Date-d>5e3)){N.next=57;break}return d=new Date,this.loadingProgressCallback(f/r.length,"Generating Voxel Map..."),N.next=57,pc();case 57:f++,N.next=10;break;case 60:this.loadingProgressCallback(f/r.length,"Rendering Voxel..."),D=Bi().mark(function $(W){var K,te,ve,_e,j,ee,F,z,Z,Ee,He,ut,me,Se,it,Zt,Xe,Re,rt,xt,At,Ut,ms,wi,Tr,jt,Rs,Ls,or;return Bi().wrap(Hs=>{for(;;)switch(Hs.prev=Hs.next){case 0:if(K=[],h[W]!==void 0){Hs.next=3;break}return Hs.abrupt("return","continue");case 3:for(te=999999999999,ve=-999999999999,_e=[],j=0,ee=Object.entries(h[W]);j<ee.length;j++)for(F=Up(ee[j],2),z=F[0],Z=F[1],Ee=0,He=Object.entries(Z);Ee<He.length;Ee++)me=Up(He[Ee],2),Se=me[0],(it=me[1]).voxelEvents[0].filePosition<te&&(te=it.voxelEvents[0].filePosition),it.voxelEvents.slice()[0].filePosition>ve&&(ve=it.voxelEvents[0].filePosition),(ut=_e).push.apply(ut,xd(it.voxelEvents.map(us=>us.filePosition))),it.color.a=1,(Zt={matrix:L.Identity(),color:it.color.clone(),voxelEvents:it.voxelEvents,lastDrawnCount:0}).matrix.setTranslation(new g(z*O.voxelWidth,W*O.voxelHeight,Se*O.voxelWidth)),K.push(Zt);for(Xe=0,_e=_e.sort((us,Ni)=>us-Ni),_e=xd(new Set(_e)),K.length,h[W]=null,(Re=O.buildBox()).alphaIndex=W,Re.renderingGroupId=1,rt=new Float32Array(16*K.length),xt=new Float32Array(4*K.length),At=0;At<K.length;At++){Ut=K[At];try{Ut&&(Ut.matrix.copyToArray(rt,16*At),Ut.color.toArray(xt,4*At),O.hasSubtractive||delete Ut.matrix)}catch(us){console.log(us)}}if(Re.thinInstanceSetBuffer("matrix",rt,16),Re.thinInstanceSetBuffer("color",xt,4),Re.thinInstanceRefreshBoundingInfo(),ms=()=>{for(var us=!1,Ni=!1,$i=0;$i<K.length;$i++){var is=K[$i];jt&&(O.clearColor.toArray(xt,4*$i),O.hasSubtractive&&O.lostInSpace.copyToArray(rt,16*$i));var br=is.voxelEvents.filter(kt=>kt.filePosition<O.currentFilePosition).slice(-1)[0];br!=null&&(br.add?(br.filePosition>wi&&br.filePosition<=O.currentFilePosition&&(is.lastDrawnCount=0,O.hasSubtractive&&is.matrix.copyToArray(rt,16*$i)),jt&&(is.lastDrawnCount=i.drawDelay),is.lastDrawnCount<i.drawDelay?(O.additiveColor.toArray(xt,4*$i),is.lastDrawnCount++):(is.color.toArray(xt,4*$i),O.hasSubtractive&&is.matrix.copyToArray(rt,16*$i))):(br.filePosition>=wi&&br.filePosition<=O.currentFilePosition&&(is.lastDrawnCount=0),jt&&(is.lastDrawnCount=i.drawDelay),is.lastDrawnCount<i.drawDelay?(O.subtractiveColor.toArray(xt,4*$i),is.lastDrawnCount++):(us=!0,O.clearColor.toArray(xt,4*$i),O.hasSubtractive&&O.lostInSpace.copyToArray(rt,16*$i),Ni=!0)))}Re.thinInstanceBufferUpdated("color"),us&&Re.thinInstanceRefreshBoundingInfo(),Ni&&(Re.thinInstanceRefreshBoundingInfo(),Re.thinInstanceBufferUpdated("matrix"))},wi=0,Tr=!0,jt=!1,Rs=Number.MAX_VALUE,Ls=Date.now(),or=()=>{if(!(O.isLoading||Date.now()-Ls<200)){if(Ls=Date.now(),Math.abs(wi-O.currentFilePosition)>O.scrubDistance||Tr||O.forceRedraw){Xe=0,jt=!0,O.forceRedraw=!1;for(var us=0;us<K.length;us++)K[us].voxelEvents.forEach($i=>$i.complete=!1);ms(),Tr=!1}else if(Xe<_e.length-1&&_e[Xe]<O.currentFilePosition){jt=!1,Rs=0,ms();for(var Ni=Xe;Ni<_e.length&&(Xe=Ni,!(_e[Ni]>O.currentFilePosition));Ni++);}else Rs<10&&(Rs++,ms());wi=O.currentFilePosition}},O.loadingProgressCallback&&O.loadingProgressCallback(W/u,"Rendering Voxels..."),O.renderFuncs.push(or),O.scene.registerBeforeRender(or),!(new Date-d>1e3)){Hs.next=36;break}return d=new Date,Hs.next=36,pc();case 36:case"end":return Hs.stop()}},$,this)}),P=0;case 64:if(!(P<u)){N.next=72;break}return N.delegateYield(D(P),"t1",66);case 66:if(N.t1!=="continue"){N.next=69;break}return N.abrupt("continue",69);case 69:P++,N.next=64;break;case 72:this.isLoading=!1,this.loadingProgressCallback(1),h=null;case 75:case"end":return N.stop()}},s,this,[[35,39]])})),function(s){return e.apply(this,arguments)})}]),i}();Xu=5,(Hu="drawDelay")in(Wu=mg)?Object.defineProperty(Wu,Hu,{value:Xu,enumerable:!0,configurable:!0,writable:!0}):Wu[Hu]=Xu;var kp=function(a){da(t,fu);var e=fa(t);function t(i,s,r,n,o,l){var h;return es(this,t),(h=e.call(this,i,s,r,n,o)).meshIndex=l!=null?l:0,h.additiveColor=new J(0,1,0,.8),h.travels=!1,h}return ts(t,[{key:"render",value:function(i){var s=this,r=new Array;this.renderMode="Line Rendering";for(var n=[],o=[],l=[],h=[],c=this.vertexAlpha?.25:0,u=0;u<i.length;u++){var d=i[u],f=this.tools[d.tool];r.push(d.gcodeFilePosition);var p=d.getPoints(this.scene);n.push(p.points),o.push(p.colors),l.push(f.isAdditive()&&!this.travels),h.push(!1)}var _=Os.CreateLineSystem(this.travels?"travels":"lineMesh",{lines:n,colors:o,updatable:!0},this.scene);n=null,_.isVisible=!0,_.isPickable=!1,_.markVerticesDataAsUpdatable(y.ColorKind),_.material.backFaceCulling=!1,_.material.forceDepthWrite=!0,_.material.specularColor=this.specularColor,_.alphaIndex=this.meshIndex,_.renderingGroupId=2;var m=r[0],v=r.slice(-1)[0],x=0,b=!1,S=0,C=function(){var M=_.getVerticesData(y.ColorKind);if(M){var D=-1,P=-1;if(b){for(var O=0;O<r.length;O++){var N=8*O;s.travels?(M[N+3]=0,M[N+7]=0,h[O]=r[O]<s.currentFilePosition):r[O]<s.currentFilePosition?(o[O][0].toArray(M,N),o[O][1].toArray(M,N+4),M[N+3]=l[O]?1:0,M[N+7]=l[O]?1:0,h[O]=!0):(M[N+3]=l[O]?c:0,M[N+7]=l[O]?c:0,h[O]=!1)}S=0,_.updateVerticesData(y.ColorKind,M,!0)}for(var $=S;$<r.length;$++)r[$]<=s.currentFilePosition&&(D=$),r[$]<=s.currentFilePosition+s.lookAheadLength&&(P=$);for(var W=h.findIndex(_e=>_e==0);W<D;W++){var K=8*W;if(l[W]){if(h[W])continue;M[K+3]<=.5?(M[K]=s.progressColor.r,M[K+1]=s.progressColor.g,M[K+2]=s.progressColor.b,M[K+3]=.9,M[K+4]=s.progressColor.r,M[K+5]=s.progressColor.g,M[K+6]=s.progressColor.b,M[K+7]=.9):M[K+3]<1?(M[K+3]+=.02,M[K+7]+=.02):M[K+3]>=1&&(M[K]=o[W][0].r,M[K+1]=o[W][0].g,M[K+2]=o[W][0].b,M[K+3]=1,M[K+4]=o[W][1].r,M[K+5]=o[W][1].g,M[K+6]=o[W][1].b,M[K+7]=1,h[W]=!0)}else{if(h[W])continue;M[K+3]===0?(M[K]=1,M[K+1]=0,M[K+2]=0,M[K+3]=.9,M[K+4]=1,M[K+5]=0,M[K+6]=0,M[K+7]=.9):M[K+3]<1?(M[K+3]+=.02,M[K+7]+=.02):(M[K+3]=1e-4,M[K+7]=1e-4,h[W]=!0)}S=W}for(var te=D;te<P;te++){var ve=8*te;M[ve+3]=1,M[ve+7]=1}_.updateVerticesData(y.ColorKind,M,!0)}else console.log("Error")},E=Date.now(),A=function(){if(!(s.isLoading||Date.now()-E<200)){if(E=Date.now(),Math.abs(x-s.currentFilePosition)>s.scrubDistance||s.forceRedraw){s.forceRedraw=!1,b=!0;for(var M=0;M<h.length;M++)h[M]=!1;S=0,x=0,C()}else s.currentFilePosition>=m-3e4&&s.currentFilePosition<=v+3e4&&(b=!1,C());x=s.currentFilePosition}};this.renderFuncs.push(A),this.scene.registerBeforeRender(A)}}]),t}(),pu=function(){function a(){es(this,a),this.feature=null,this.perimeter=!0,this.support=!1,this.missingFeatures=[]}return ts(a,[{key:"isTypeComment",value:function(e){}},{key:"getFeatureColor",value:function(e){}},{key:"isPerimeter",value:function(){return this.perimeter}},{key:"isSupport",value:function(){return this.support}},{key:"reportMissingFeature",value:function(e){this.missingFeatures.includes(e)||(console.error("Missing feature ".concat(e)),this.missingFeatures.push(e))}}]),a}(),Sw=function(a){da(t,pu);var e=fa(t);function t(){var i;return es(this,t),(i=e.call(this)).featureList={Perimeter:{color:new J(1,.9,.3,1),perimeter:!0,support:!1},"External perimeter":{color:new J(1,.5,.2,1),perimeter:!0,support:!1},"Internal infill":{color:new J(.59,.19,.16,1),perimeter:!1,support:!1},"Solid infill":{color:new J(.59,.19,.8,1),perimeter:!0,support:!1},"Top solid infill":{color:new J(.95,.25,.25,1),perimeter:!0,support:!1},"Bridge infill":{color:new J(.3,.5,.73,1),perimeter:!1,support:!1},"Gap fill":{color:new J(1,1,1,1),perimeter:!1,support:!1},Skirt:{color:new J(0,.53,.43,1),perimeter:!1,support:!1},"Skirt/Brim":{color:new J(0,.53,.43,1),perimeter:!1,support:!1},"Supported material":{color:new J(0,1,0,1),perimeter:!1,support:!0},"Supported material interface":{color:new J(0,.5,0,1),perimeter:!1,support:!0},Custom:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1},Unknown:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1},"Support material":{color:new J(.5,.5,.5,1),perimeter:!1,support:!0},"Support material interface":{color:new J(.5,.5,.5,1),perimeter:!1,support:!0},"Overhang perimeter":{color:new J(.5,.5,.5,1),perimeter:!0,support:!1},"Wipe tower":{color:new J(.5,.5,.5,1),perimeter:!0,support:!1}},i}return ts(t,[{key:"isTypeComment",value:function(i){return!!i.trim().startsWith(";TYPE:")&&(this.feature=i.substring(6).trim(),!0)}},{key:"getFeatureColor",value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch{this.reportMissingFeature(this.feature)}return this.featureList.Unknown.color}},{key:"isPerimeter",value:function(){try{return this.featureList[this.feature].perimeter}catch{return this.reportMissingFeature(this.feature),!0}}},{key:"isSupport",value:function(){try{return this.featureList[this.feature].support}catch{return this.reportMissingFeature(this.feature),!1}}}]),t}(),Ew=function(a){da(t,pu);var e=fa(t);function t(){var i;return es(this,t),(i=e.call(this)).featureList={SKIN:{color:new J(1,.9,.3,1),perimeter:!0,support:!1},"WALL-OUTER":{color:new J(1,.5,.2,1),perimeter:!0,support:!1},"WALL-INNER":{color:new J(.59,.19,.16,1),perimeter:!1,support:!1},FILL:{color:new J(.95,.25,.25,1),perimeter:!1,support:!1},SKIRT:{color:new J(0,.53,.43,1),perimeter:!1,support:!1},SUPPORT:{color:new J(0,.53,.43,1),perimeter:!1,support:!0},CUSTOM:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1},UNKNOWN:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1}},i}return ts(t,[{key:"isTypeComment",value:function(i){return!!i.trim().startsWith(";TYPE:")&&(this.feature=i.substring(6).trim(),!0)}},{key:"getFeatureColor",value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch{this.reportMissingFeature(this.feature)}return this.featureList.UNKNOWN}},{key:"isPerimeter",value:function(){try{return this.featureList[this.feature].perimeter}catch{return this.reportMissingFeature(this.feature),!0}}},{key:"isSupport",value:function(){try{return this.featureList[this.feature].support}catch{return this.reportMissingFeature(this.feature),!1}}}]),t}(),Cw=function(a){da(t,pu);var e=fa(t);function t(){var i;return es(this,t),(i=e.call(this)).featureList={Perimeter:{color:new J(1,.9,.3,1),perimeter:!0,support:!1},"External perimeter":{color:new J(1,.5,.2,1),perimeter:!0,support:!1},"Internal infill":{color:new J(.59,.19,.16,1),perimeter:!1,support:!1},"Solid infill":{color:new J(.59,.19,.8,1),perimeter:!0,support:!1},"Top solid infill":{color:new J(.95,.25,.25,1),perimeter:!0,support:!1},"Bridge infill":{color:new J(.3,.5,.73,1),perimeter:!1,support:!1},"Gap fill":{color:new J(1,1,1,1),perimeter:!1,support:!1},Skirt:{color:new J(0,.53,.43,1),perimeter:!1,support:!1},"Skirt/Brim":{color:new J(0,.53,.43,1),perimeter:!1,support:!1},"Supported material":{color:new J(0,1,0,1),perimeter:!1,support:!0},"Supported material interface":{color:new J(0,.5,0,1),perimeter:!1,support:!0},Custom:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1},Unknown:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1},"Support material":{color:new J(.5,.5,.5,1),perimeter:!1,support:!0},"Support material interface":{color:new J(.5,.5,.5,1),perimeter:!1,support:!0},"Overhang perimeter":{color:new J(.5,.5,.5,1),perimeter:!0,support:!1},"Wipe tower":{color:new J(.5,.5,.5,1),perimeter:!0,support:!1}},i}return ts(t,[{key:"isTypeComment",value:function(i){return!!i.trim().startsWith(";TYPE:")&&(this.feature=i.substring(6).trim(),!0)}},{key:"getFeatureColor",value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch{this.reportMissingFeature(this.feature)}return this.featureList.Unknown.color}},{key:"isPerimeter",value:function(){try{return this.featureList[this.feature].perimeter}catch{return this.reportMissingFeature(this.feature),!0}}},{key:"isSupport",value:function(){try{return this.featureList[this.feature].support}catch{return this.reportMissingFeature(this.feature),!1}}}]),t}(),yw=function(a){da(t,pu);var e=fa(t);function t(){var i;return es(this,t),(i=e.call(this)).featureList={"WALL-OUTER":{color:new J(.47,.18,.18,1),perimeter:!0,support:!1},"WALL-INNER":{color:new J(0,.55,0,1),perimeter:!1,support:!1},FILL:{color:new J(.9,.2,.2,1),perimeter:!1,support:!1},"SOLID-FILL":{color:new J(.95,.25,.25,1),perimeter:!1,support:!1},BRIDGE:{color:new J(.9,.15,.195,1),perimeter:!1,support:!1},SKIRT:{color:new J(.31,.12,.33,1),perimeter:!1,support:!1},SUPPORT:{color:new J(0,.53,.43,1),perimeter:!1,support:!0},"DENSE-SUPPORT":{color:new J(0,.28,.55,1),perimeter:!1,support:!0},RAFT:{color:new J(.59,.49,.2,1),perimeter:!1,support:!1},CUSTOM:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1},UNKNOWN:{color:new J(.5,.5,.5,1),perimeter:!1,support:!1}},i}return ts(t,[{key:"isTypeComment",value:function(i){return!!i.trim().startsWith(";TYPE:")&&(this.feature=i.substring(6).trim(),!0)}},{key:"getFeatureColor",value:function(){if(Object.prototype.hasOwnProperty.call(this.featureList,this.feature))try{return this.featureList[this.feature].color}catch{this.reportMissingFeature(this.feature)}return this.featureList.UNKNOWN.color}},{key:"isPerimeter",value:function(){try{return this.featureList[this.feature].perimeter}catch{return this.reportMissingFeature(this.feature),!0}}},{key:"isSupport",value:function(){try{return this.featureList[this.feature].support}catch{return this.reportMissingFeature(this.feature),!1}}}]),t}(),Aw=function(){function a(){es(this,a)}return ts(a,null,[{key:"getSlicer",value:function(e){if(!e)return null;var t=e.substring(0,1e4);return t.includes("; generated by PrusaSlicer")?new Sw:t.includes(";Generated with Cura_SteamEngine")?new Ew:t.includes("; generated by SuperSlicer")?new Cw:t.includes("Sliced by ideaMaker")?new yw:null}}]),a}(),_a={Block:1,Line:2,Point:3,Max:4,Voxel:5},ma={Color:0,Feed:1,Feature:2},Rw=function(){function a(){es(this,a),this.currentPosition=new g(0,0,0),this.currentColor=new J(.25,.25,.25,1),this.currentTool=0,this.renderVersion=_a.Line,this.absolute=!0,this.lines=[],this.renderedLines=[],this.currentLineNumber=0,this.lastFilePositionIndex=0,this.travels=[],this.sps,this.maxHeight=0,this.minHeight=0,this.lineCount=0,this.renderMode="",this.extruderCount=10,this.layerDictionary=[],this.previousLayerHeight=0,this.currentLayerHeight=0,this.liveTracking=!1,this.liveTrackingShowSolid=localStorage.getItem("showSolid")==="true",this.materialTransparency=.3,this.gcodeLineIndex=[],this.gcodeFilePosition=0,this.refreshTime=200,this.timeStamp,this.lineLengthTolerance=.05,this.tools=new Array;for(var n=["#00FFFF","#FF00FF","#FFFF00","#000000","#FFFFFF"],o=0;o<5;o++){var l=new Ah;l.color=J.FromHexString(n[o]),l.diameter=.4,this.tools.push(l)}this.progressColor=new J(0,1,0,1),this.lineMeshIndex=0,this.scene,this.renderFuncs=new Array,this.meshBreakPoint=2e4,this.feedRateTrimming=!1,this.currentFeedRate=0,this.feedValues=0,this.numChanges=0,this.avgFeed=0,this.maxFeedRate=0,this.minFeedRate=Number.MAX_VALUE,this.underspeedPercent=1,this.colorMode=Number.parseInt(localStorage.getItem("processorColorMode")),this.colorMode||this.setColorMode(ma.Color),this.minColorRate=Number.parseInt(localStorage.getItem("minColorRate")),this.minColorRate||(this.minColorRate=1200,localStorage.setItem("minColorRate",this.minColorRate)),this.maxColorRate=Number.parseInt(localStorage.getItem("maxColorRate")),this.maxColorRate||(this.maxColorRate=3600,localStorage.setItem("maxColorRate",this.maxColorRate)),this.minFeedColorString=localStorage.getItem("minFeedColor"),this.minFeedColorString||(this.minFeedColorString="#0000FF"),this.minFeedColor=J.FromHexString(this.minFeedColorString.padEnd(9,"F")),this.maxFeedColorString=localStorage.getItem("maxFeedColor"),this.maxFeedColorString||(this.maxFeedColorString="#FF0000"),this.maxFeedColor=J.FromHexString(this.maxFeedColorString.padEnd(9,"F")),this.everyNthRow=0,this.currentRowIdx=-1,this.currentZ=0,this.renderTravels=!0,this.vertexAlpha=!1,this.forceWireMode=localStorage.getItem("forceWireMode")==="true",this.spreadLines=!1,this.spreadLineAmount=10,this.debug=!1,this.specularColor=new re(0,0,0),this.lookAheadLength=500,this.cancelLoad=!1,this.loadingProgressCallback,this.hasSpindle=!1,this.voxelWidth=1,this.voxelHeight=1,this.forceVoxels=!1,this.renderInstances=new Array,this.meshIndex=0,this.highQualityExtrusion=!1,this.perimeterOnly=!1,this.lastUpdate=Date.now(),this.g1AsExtrusion=!1,this.firstGCodeByte=0,this.lastGCodeByte=0,this.zBelt=!1,this.hyp=1/Math.cos(55/180*Math.PI),this.adj=Math.tan(55/180*Math.PI),this.currentOffset=0,this.nozzlePosition=new g(0,0,0),this.firmwareRetraction=!1}var e,t,i,s,r;return ts(a,[{key:"doUpdate",value:function(){this.lastUpdate=Date.now()}},{key:"setProgressColor",value:function(n){var o=this;this.progressColor=J.FromHexString(n.padEnd(9,"F")),this.renderInstances.forEach(l=>l.progressColor=o.progressColor)}},{key:"getMaxHeight",value:function(){return this.maxHeight+1}},{key:"getMinHeight",value:function(){return this.minHeight}},{key:"setRenderQualitySettings",value:function(n,o){if(this.forceVoxels)return this.renderVersion=_a.Voxel,void(this.meshBreakPoint=Number.MAX_VALUE);o===void 0&&(o=1);var l=0,h=this.forceWireMode?2:1,c=2;switch(this.refreshTime=5e3,this.everyNthRow=1,this.renderTravels=!0,o){case 1:h=2,this.refreshTime=3e4,l=25e3,c=50,this.renderTravels=!1;break;case 2:h=2,this.refreshTime=3e4,l=5e5,c=10,this.renderTravels=!1;break;case 3:l=1e6,c=3;break;case 4:l=15e6,c=2;break;case 5:l=25e6;break;default:return this.renderVersion=_a.Block,void(this.everyNthRow=1)}for(var u=h;u<4;u++){var d=void 0;switch(u){case 1:d=24;break;case 2:d=2;break;case 3:d=1}for(var f=this.everyNthRow;f<=c;f++)if(this.debug&&console.log("Mode: "+u+"  NRow: "+f+"   vertexcount: "+n*d/f),n*d/f<l)return this.renderVersion=u,void(this.everyNthRow=f)}}},{key:"initVariables",value:function(){this.currentPosition=new g(0,0,0),this.cancelLoad=!1,this.absolute=!0,this.currentZ=0,this.currentRowIdx=-1,this.gcodeLineIndex=[],this.lineMeshIndex=0,this.lastExtrudedZHeight=0,this.previousLayerHeight=0,this.currentLayerHeight=0,this.minFeedRate=Number.MAX_VALUE,this.maxFeedRate=0,this.hasSpindle=!1,this.currentColor=new J(1,1,1,1),this.slicer=null,this.skip=!1,this.isSupport=!1,this.currentTool=0,this.firstGCodeByte=0,this.lastGCodeByte=0,this.layerDictionary=[],this.renderedLines=[]}},{key:"processGcodeFile",value:(r=fn(Bi().mark(function n(o,l,h){var c,u,d,f,p;return Bi().wrap(function(_){for(;;)switch(_.prev=_.next){case 0:if(this.initVariables(),this.slicer=Aw.getSlicer(o),this.meshIndex=0,this.currentTool=0,l==null&&(l=4),o&&o.length!==0){_.next=7;break}return _.abrupt("return");case 7:u=o.split(`
`),typeof h=="function"&&h(),this.lineCount=u.length,this.debug&&console.info("Line Count : ".concat(this.lineCount)),this.setRenderQualitySettings(this.lineCount,l),this.tools.length==0&&this.tools.push(new Ah),this.currentColor=(c=this.tools[0].color)!==null&&c!==void 0?c:new Ah().color,u.reverse(),d=0,f=0,this.timeStamp=Date.now();case 18:if(!u.length){_.next=36;break}if(!this.cancelLoad){_.next=22;break}return this.cancelLoad=!1,_.abrupt("return");case 22:if(p=u.pop(),d+=p.length+1,f++,p.trim(),this.perimeterOnly&&this.slicer&&this.slicer.isTypeComment(p)&&this.slicer.isPerimeter()&&(this.currentColor=this.slicer.getFeatureColor()),p.startsWith(";")?this.slicer&&this.slicer.isTypeComment(p)&&(this.isSupport=this.slicer.isSupport(),this.colorMode===ma.Feature&&(this.currentColor=this.slicer.getFeatureColor())):(this.firstGCodeByte===0&&p.length>0&&(this.firstGCodeByte=d),this.lastGCodeByte=d,this.processLine(p,f,d)),!(Date.now()-this.timeStamp>10)){_.next=33;break}return this.loadingProgressCallback&&this.loadingProgressCallback(d/o.length,"Loading File..."),_.next=32,pc();case 32:this.timeStamp=_.sent;case 33:this.doUpdate(),_.next=18;break;case 36:if(!this.renderTravels){_.next=39;break}return _.next=39,this.createTravelLines(this.scene);case 39:this.loadingProgressCallback&&this.loadingProgressCallback(1),o={};case 41:case"end":return _.stop()}},n,this)})),function(n,o,l){return r.apply(this,arguments)})},{key:"loadingComplete",value:function(){this.renderInstances.forEach(n=>n.isLoading=!1)}},{key:"processLine",value:(s=fn(Bi().mark(function n(o,l,h){var c,u,d,f,p,_,m,v,x,b,S,C,E,A,M,D,P,O,N,$,W,K,te,ve,_e,j,ee,F=this;return Bi().wrap(function(z){for(;;)switch(z.prev=z.next){case 0:if((c=o.indexOf(";"))>-1&&(o=o.substring(0,c-1).trim()),o=o.toUpperCase(),(d=o.match(/[GM]+[0-9.]+/))==null){z.next=103;break}d=d.filter(Z=>Z.startsWith("G")||Z.startsWith("M")),z.t0=d[0],z.next=z.t0==="G0"||z.t0==="G1"?9:z.t0==="G2"||z.t0==="G3"?53:z.t0==="G10"?62:z.t0==="G11"?64:z.t0==="G28"?66:z.t0==="G90"?69:z.t0==="G91"?71:z.t0==="G92"?73:z.t0==="S"?74:z.t0==="M3"||z.t0==="M4"?76:z.t0==="M567"?81:z.t0==="M600"?99:101;break;case 9:u=o.split(/(?=[GXYZEFUV])/),(f=new Vp).tool=this.currentTool,f.gcodeLineNumber=l,f.gcodeFilePosition=h,f.start=this.currentPosition.clone(),f.layerHeight=this.currentLayerHeight-this.previousLayerHeight,d[0]==="G1"&&this.g1AsExtrusion&&(f.extruding=!0,f.color=(p=(_=this.tools[this.currentTool])===null||_===void 0?void 0:_.color.clone())!==null&&p!==void 0?p:this.tools[0].color.clone(),this.maxHeight=this.currentPosition.y,console.log("EH ".concat(this.g1AsExtrusion))),m=1;case 18:if(!(m<u.length)){z.next=39;break}v=u[m],z.t1=v[0],z.next=z.t1==="X"?23:z.t1==="Y"?25:z.t1==="Z"?27:z.t1==="E"?29:z.t1==="F"?31:36;break;case 23:return this.currentPosition.x=this.absolute?Number(v.substring(1)):this.currentPosition.x+Number(v.substring(1)),z.abrupt("break",36);case 25:return this.zBelt?(this.currentPosition.z=Number(v.substring(1))+Number(v.substring(1))*Math.cos(35*Math.PI/180),console.log(this.currentPosition.z)):this.currentPosition.z=this.absolute?Number(v.substring(1)):this.currentPosition.z+Number(v.substring(1)),z.abrupt("break",36);case 27:return this.zBelt?(this.currentPosition.y=Number(v.substring(1)+Number(v.substring(1))*Math.sin(35*Math.PI/180)),console.log(this.currentPosition.y)):(this.currentPosition.y=this.absolute?Number(v.substring(1)):this.currentPosition.y+Number(v.substring(1)),this.lastY&&this.lastY==this.currentPosition.y||(this.lastY=this.currentPosition.y,this.lastY==null&&(this.lastY=0)),this.currentPosition.y<this.minHeight&&(this.minHeight=this.currentPosition.y),this.spreadLines&&(this.currentPosition.y*=this.spreadLineAmount)),z.abrupt("break",36);case 29:return Number(v.substring(1))>0&&(f.extruding=!0,this.maxHeight=this.currentPosition.y),z.abrupt("break",36);case 31:return this.currentFeedRate=Number(v.substring(1)),this.currentFeedRate>this.maxFeedRate&&(this.maxFeedRate=this.currentFeedRate),this.currentFeedRate<this.minFeedRate&&(this.minFeedRate=this.currentFeedRate),this.colorMode===ma.Feed&&(x=(this.currentFeedRate-this.minColorRate)/(this.maxColorRate-this.minColorRate),this.currentColor=x>=1?this.maxFeedColor:x<=0?this.minFeedColor:J.Lerp(this.minFeedColor,this.maxFeedColor,x)),z.abrupt("break",36);case 36:m++,z.next=18;break;case 39:if(this.zBelt)try{this.currentOffset===0&&(this.currentOffset=.2*this.adj),this.currentPosition.y,this.adj,this.currentOffset}catch(Z){console.log(Z)}if(!f.extruding||!this.skip){z.next=42;break}return z.abrupt("return");case 42:if(f.end=this.currentPosition.clone(),this.debug,this.feedRateTrimming&&(this.feedValues+=this.currentFeedRate,this.numChanges++,this.avgFeed=this.feedValues/this.numChanges*this.underspeedPercent),!(this.everyNthRow>1&&f.extruding)){z.next=49;break}if(this.currentPosition.y>this.currentZ&&(this.currentRowIdx++,this.currentRowIdx%3==0&&this.currentRowIdx++,this.currentZ=this.currentPosition.y),!(this.currentRowIdx%this.everyNthRow==0&&this.currentRowIdx>2)){z.next=49;break}return z.abrupt("return");case 49:return b=this.hasSpindle&&d[0]==="G1",S=f.length()>=this.lineLengthTolerance,b||S&&f.extruding?(this.currentColor==null&&(this.currentColor=new J(1,1,1,1)),f.color=this.currentColor.clone(),this.lines.push(f),this.currentPosition.y>this.currentLayerHeight&&!this.isSupport&&(this.previousLayerHeight=this.currentLayerHeight,this.currentLayerHeight=this.currentPosition.y)):this.renderTravels&&!f.extruding&&(f.color=new J(1,0,0,1),this.travels.push(f)),z.abrupt("break",101);case 53:return u=o.split(/(?=[GXYZIJFRE])/),C=o.indexOf("E")>0,E=u.filter(Z=>Z==="G2"),A=vw(u,this.currentPosition,!this.absolute,1),M=this.currentPosition.clone(),A.points.forEach((Z,Ee)=>{var He=new Vp;He.tool=F.currentTool,He.gcodeLineNumber=l,He.gcodeFilePosition=h,He.layerHeight=F.currentLayerHeight-F.previousLayerHeight,He.start=M.clone(),He.end=new g(Z.x,Z.y,Z.z),He.color=F.currentColor.clone(),He.extruding=C,F.debug&&(He.color=E?new J(0,1,1,1):new J(1,1,0,1),Ee==0&&(He.color=new J(0,1,0,1))),M=He.end.clone(),F.debug&&console.log(He),F.lines.push(He)}),this.currentPosition=new g(M.x,M.y,M.z),this.currentPosition.y>this.currentLayerHeight&&!this.isSupport&&(this.previousLayerHeight=this.currentLayerHeight,this.currentLayerHeight=this.currentPosition.y),z.abrupt("break",101);case 62:return this.firmwareRetraction=!0,z.abrupt("break",101);case 64:return this.firmwareRetraction=!1,z.abrupt("break",101);case 66:return(u=o.split(/(?=[GXYZ])/)).length==1?this.currentPosition=new g(0,0,0):(u.some(Z=>Z.trim()==="X")&&(this.currentPosition.x=0),u.some(Z=>Z.trim()==="Y")&&(this.currentPosition.z=0),u.some(Z=>Z.trim()==="Z")&&(this.currentPosition.y=0)),z.abrupt("break",101);case 69:return this.absolute=!0,z.abrupt("break",101);case 71:return this.absolute=!1,z.abrupt("break",101);case 73:return z.abrupt("break",101);case 74:return this.hasSpindle=!0,z.abrupt("break",101);case 76:return D=o.split(/(?=[SM])/),(P=(P=D.filter(Z=>Z.startsWith("S")))[0]?Number(P[0].substring(1)):0)>0&&(this.hasSpindle=!0),z.abrupt("break",101);case 81:if(O=o.split(/(?=[PE])/),this.colorMode!==ma.Feed){z.next=84;break}return z.abrupt("break",101);case 84:N=1;case 85:if(!(N<O.length)){z.next=96;break}$=O[N],W=[1,1,1],z.t2=$[0],z.next=z.t2==="E"?91:93;break;case 91:return this.extruderPercentage=$.substring(1).split(":"),z.abrupt("break",93);case 93:N++,z.next=85;break;case 96:for(K=0;K<this.extruderPercentage.length;K++)W[0]-=(1-this.tools[K].color.r)*this.extruderPercentage[K],W[1]-=(1-this.tools[K].color.g)*this.extruderPercentage[K],W[2]-=(1-this.tools[K].color.b)*this.extruderPercentage[K];return this.currentColor=new J(W[0],W[1],W[2],.1),z.abrupt("break",101);case 99:try{this.currentTool++,this.currentTool>=this.tools.length&&(this.currentTool=0),this.colorMode!==ma.Feed&&(this.currentColor=this.tools[this.currentTool].color.clone())}catch(Z){console.log(Z)}return z.abrupt("break",101);case 101:z.next=105;break;case 103:o.startsWith("T")&&(te=Number.parseInt(o.substring(1)),isNaN(te)||(this.currentPosition.z+=10,this.currentTool=te,this.currentTool>=this.tools.length?this.currentTool=this.currentTool%this.tools.length:te<0&&(this.currentTool=0,ee=0),this.colorMode!==ma.Feed&&(ee=Number(o.substring(1))%this.extruderCount,this.currentColor=(ve=(_e=this.tools[ee])===null||_e===void 0||(j=_e.color)===null||j===void 0?void 0:j.clone())!==null&&ve!==void 0?ve:new re(1,0,0)))),this.debug&&console.log(o);case 105:if(!(this.lines.length>=this.meshBreakPoint)){z.next=112;break}return z.next=108,this.createMesh(this.scene);case 108:return z.next=110,pc();case 110:this.doUpdate(),this.meshIndex++;case 112:case"end":return z.stop()}},n,this)})),function(n,o,l){return s.apply(this,arguments)})},{key:"renderPointMode",value:function(n){var o=this.lineMeshIndex;this.gcodeLineIndex.push(new Array),this.sps=new lP("pcs"+o,1,n);var l=this.lines;this.sps.addPoints(this.lines.length,function(h,c,u){l[u].renderParticle(h)}),this.sps.buildMeshAsync().then(h=>{h.material.pointSize=2})}},{key:"createMesh",value:(i=fn(Bi().mark(function n(o){var l,h;return Bi().wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return this.renderVersion===_a.Line||this.renderVersion===_a.Point?h=new kp(o,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex):this.renderVersion===_a.Block?h=this.highQualityExtrusion?new Tw(o,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex):new xw(o,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex):this.renderVersion===_a.Voxel&&(h=new mg(o,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.voxelWidth,this.voxelHeight)),h.progressColor=this.progressColor,h.vertexAlpha=this.vertexAlpha,this.renderInstances.push(h),(l=this.renderedLines).push.apply(l,xd(this.lines)),c.next=7,h.render(this.lines);case 7:this.lines=[],this.scene.render();case 9:case"end":return c.stop()}},n,this)})),function(n){return i.apply(this,arguments)})},{key:"chunk",value:function(n,o){for(var l=[],h=0,c=n.length;h<c;h+=o)l.push(n.slice(h,h+o));return l}},{key:"createTravelLines",value:(t=fn(Bi().mark(function n(o){var l,h,c;return Bi().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:l=this.chunk(this.travels,2e4),h=0;case 2:if(!(h<l.length)){u.next=12;break}return(c=new kp(o,this.specularColor,this.loadingProgressCallback,this.renderFuncs,this.tools,this.meshIndex)).travels=!0,c.meshIndex=this.meshIndex+1e3,u.next=8,c.render(l[h]);case 8:this.renderInstances.push(c);case 9:h++,u.next=2;break;case 12:this.travels=[];case 13:case"end":return u.stop()}},n,this)})),function(n){return t.apply(this,arguments)})},{key:"updateFilePosition",value:function(n){this.renderInstances.forEach(l=>l.updateFilePosition(n));try{n<this.renderedLines[this.lastFilePositionIndex].gcodeFilePosition&&(this.lastFilePositionIndex=0,this.currentLineNumber=0)}catch{this.lastFilePositionIndex=0,this.currentLineNumber=0}for(var o=this.lastFilePositionIndex;o<this.renderedLines.length&&!(this.renderedLines[o].gcodeFilePosition>n);o++)this.currentLineNumber=this.renderedLines[o].gcodeLineNumber,this.nozzlePosition=this.renderedLines[o].end,this.lastFilePositionIndex=o;this.doUpdate()}},{key:"doFinalPass",value:function(){var n=this;this.liveTracking=!0,this.gcodeFilePosition=Number.MAX_VALUE,setTimeout(()=>{n.liveTracking=!1},this.refreshTime+200)}},{key:"updateMesh",value:function(){this.renderVersion===1?console.log("Version 1"):this.renderVersion===2&&console.log("Version 2")}},{key:"unregisterEvents",value:function(){for(var n=0;n<this.renderFuncs.length;n++)this.scene.unregisterBeforeRender(this.renderFuncs[n]),delete this.renderFuncs[n];this.renderFuncs=[];for(var o=0;o<this.renderInstances.length;o++)delete this.renderInstances[o];this.renderInstances=[]}},{key:"setLiveTracking",value:function(n){this.liveTracking=n}},{key:"setColorMode",value:function(n){n||(this.colorMode=ma.Color),localStorage.setItem("processorColorMode",n),this.colorMode=n}},{key:"updateMinFeedColor",value:function(n){localStorage.setItem("minFeedColor",n),this.minFeedColorString=n,this.minFeedColor=J.FromHexString(n.padEnd(9,"F"))}},{key:"updateMaxFeedColor",value:function(n){localStorage.setItem("maxFeedColor",n),this.maxFeedColorString=n,this.maxFeedColor=J.FromHexString(n.padEnd(9,"F"))}},{key:"updateColorRate",value:function(n,o){localStorage.setItem("minColorRate",n),localStorage.setItem("maxColorRate",o),this.minColorRate=n,this.maxColorRate=o}},{key:"updateForceWireMode",value:function(n){this.forceWireMode=n,localStorage.setItem("forceWireMode",n)}},{key:"setLiveTrackingShowSolid",value:function(n){this.liveTrackingShowSolid=n,localStorage.setItem("showSolid",n)}},{key:"setAlpha",value:function(n){this.vertexAlpha=n}},{key:"resetTools",value:function(){this.tools=new Array}},{key:"addTool",value:function(n,o){var l=arguments.length>2&&arguments[2]!==void 0?arguments[2]:bd.Extruder,h=new Ah;h.color=J.FromHexString(n.padEnd(9,"F")),h.diameter=o,h.toolType=l,this.tools.push(h)}},{key:"updateTool",value:function(n,o,l){l<this.tools.length&&(this.tools[l].color=J.FromHexString(n.padEnd(9,"F")),this.tools[l].diameter=o)}},{key:"forceRedraw",value:function(){for(var n=0;n<this.renderInstances.length;n++)this.renderInstances[n].forceRedraw=!0;this.doUpdate()}},{key:"useHighQualityExtrusion",value:function(n){this.highQualityExtrusion=n}},{key:"setVoxelMode",value:function(n){this.forceVoxels=n}},{key:"useSpecularColor",value:function(n){var o=n?new re(.4,.4,.4):new re(0,0,0);this.specularColor=o,this.renderInstances.forEach(l=>{if(l.material!=null&&l.material.hasOwnProperty("specularColor"))try{l.material.specularColor=o}catch{}}),this.scene&&this.scene.render(!0,!0)}},{key:"g1AsExtrusion",value:function(n){this.g1AsExtrusion=n}},{key:"cancel",value:(e=fn(Bi().mark(function n(){return Bi().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return this.cancelLoad=!0,o.next=3,this.pauseProcessing();case 3:case"end":return o.stop()}},n,this)})),function(){return e.apply(this,arguments)})}]),a}(),Gp=0,Iw=1,Pw=function(){function a(e){es(this,a),this.buildVolume={x:{min:0,max:100},y:{min:0,max:100},z:{min:0,max:100}};var t=localStorage.getItem("buildVolume");t!==null&&(this.buildVolume=JSON.parse(t)),this.renderMode=Number.parseInt(localStorage.getItem("renderBedMode")),this.renderMode||(this.renderMode=Gp),this.bedMesh,this.isDelta=!1,this.scene=e,this.registerClipIgnore=()=>{},this.bedLineColor="#0000FF",this.getBedColor()||this.setBedColor("#0000FF"),this.planeMaterial=this.buildGridMaterial(),this.boxMaterial=new pe("bedBoxMaterial",this.scene),this.boxMaterial.alpha=0,this.debug=!1}return ts(a,[{key:"setRenderMode",value:function(e){this.renderMode=e,localStorage.setItem("renderBedMode",this.renderMode),this.bedMesh&&(this.scene.removeMesh(this.bedMesh),this.bedMesh.dispose(!1,!0)),this.buildBed(),this.scene.render()}},{key:"buildBed",value:function(){if(!this.debug){if(this.bedMesh&&this.bedMesh.isDisposed()&&(this.bedMesh=null),this.bedMesh)return this.bedMesh;switch(this.renderMode){case Gp:this.buildFlatBed();break;case Iw:this.buildBox()}return this.bedMesh}}},{key:"setDelta",value:function(e){this.isDelta=e,this.setRenderMode(this.renderMode)}},{key:"buildFlatBed",value:function(){var e=this.getCenter(),t=this.getSize();if(this.isDelta){var i=Math.abs(this.buildVolume.x.max-this.buildVolume.x.min)/2;this.bedMesh=Os.CreateDisc("BuildPlate",{radius:i},this.scene),this.bedMesh.rotationQuaternion=Q.RotationAxis(new g(1,0,0),Math.PI/2),this.bedMesh.material=this.planeMaterial}else{var s=t.x,r=t.y;this.bedMesh=Os.CreatePlane("BuildPlate",{width:s,height:r},this.scene),this.bedMesh.material=this.planeMaterial,this.bedMesh.rotationQuaternion=Q.RotationAxis(new g(1,0,0),Math.PI/2),this.bedMesh.translate(new g(e.x,0,e.y),1,Ze.WORLD)}this.registerClipIgnore(this.bedMesh)}},{key:"getCenter",value:function(){return{x:(this.buildVolume.x.max+this.buildVolume.x.min)/2,y:(this.buildVolume.y.max+this.buildVolume.y.min)/2,z:(this.buildVolume.z.max+this.buildVolume.z.min)/2}}},{key:"getSize",value:function(){return{x:Math.abs(this.buildVolume.x.max-this.buildVolume.x.min),y:Math.abs(this.buildVolume.y.max-this.buildVolume.y.min),z:Math.abs(this.buildVolume.z.max-this.buildVolume.z.min)}}},{key:"buildBox",value:function(){var e=this,t=this.getSize(),i=this.getCenter();if(this.isDelta)this.bedMesh=Os.CreateCylinder("bed",{diameterTop:t.x,diameterBottom:t.x,height:t.z},this.scene),this.bedMesh.position.x=i.x,this.bedMesh.position.y=i.z,this.bedMesh.position.z=i.x,this.bedMesh.alpha=0,this.bedMesh.diffuseColor=new J(0,0,0,0),this.bedMesh.isPickable=!1,this.bedMesh.enableEdgesRendering(void 0,!0),this.bedMesh.renderingGroupId=2,this.scene.setRenderingAutoClearDepthStencil(2,!1,!1,!1),new hs("hl",this.scene,{isStroke:!0,blurTextureSizeRatio:3}).addMesh(this.bedMesh,this.getBedColor4()),this.bedMesh.onBeforeRenderObservable.add(()=>{e.scene.getEngine().setColorWrite(!1)}),this.bedMesh.onAfterRenderObservable.add(()=>{e.scene.getEngine().setColorWrite(!0)}),this.registerClipIgnore(this.bedMesh);else{this.bedMesh=Os.CreateBox("bed",{width:t.x,depth:t.y,height:t.z},this.scene);var s=this.getCenter();this.bedMesh.position.x=s.x-this.buildVolume.x.min,this.bedMesh.position.y=s.z-this.buildVolume.z.min,this.bedMesh.position.z=s.y-this.buildVolume.y.min,this.bedMesh.diffuseColor=new J(0,0,0,0),this.bedMesh.enableEdgesRendering(),this.bedMesh.edgesWidth=100,this.bedMesh.material=this.boxMaterial,this.bedMesh.isPickable=!1,this.bedMesh.edgesColor=this.getBedColor4(),this.registerClipIgnore(this.bedMesh)}}},{key:"setVisibility",value:function(e){this.bedMesh&&this.bedMesh.setEnabled(e)}},{key:"commitBedSize",value:function(){localStorage.setItem("buildVolume",JSON.stringify(this.buildVolume)),this.setRenderMode(this.renderMode)}},{key:"buildGridMaterial",value:function(){var e=new Cs("bedMaterial",this.scene);return e.mainColor=new J(0,0,0,0),e.lineColor=re.FromHexString(this.getBedColor()),e.gridRatio=5,e.opacity=.8,e.majorUnitFrequency=10,e.minorUnitVisibility=.6,e.gridOffset=new g(0,0,0),e}},{key:"getBedColor",value:function(){return localStorage.getItem("bedLineColor")}},{key:"setBedColor",value:function(e){localStorage.setItem("bedLineColor",e),this.planeMaterial&&(this.planeMaterial=this.buildGridMaterial(),this.dispose(),this.buildBed(),this.scene.render())}},{key:"getBedColor4",value:function(){return J.FromHexString(this.getBedColor().padEnd(9,"F"))}},{key:"dispose",value:function(){this.bedMesh.dispose(!1,!0)}}]),a}(),Mw=function(){function a(e){es(this,a),this.scene=e,this.checkerBoard="iVBORw0KGgoAAAANSUhEUgAAAQEAAAEBCAIAAAD3joeqAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAALnSURBVHhe7dZBEYQwFAVBWBtogAv+IhIEsZd4yGG6L/lPwFRl31jqPM/neeZghd98oUoD1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjTAHUaoE4D1GmAOg1QpwHqNECdBqjb7/ueJyscxzHGmIMV9u/75skK7/te1zUHK/gLUacB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA9RpgDoNUKcB6jRAnQao0wB1GqBOA7Rt2x+drw1hSNi5LQAAAABJRU5ErkJggg==",this.xmark="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAPQAAADPCAMAAAD1TAyiAAAAkFBMVEX39/eZAAD8//+TAACWAACRAAD4+vr5/PyaAAD39fX18vLy6enr29v18PDm0dG1Y2PewMDYtbWuUFDkzc2jLy+iKSnLlpbRpKS/enrIjo6hJCTbu7u8dHSxWFi4a2vEh4eoOzudEhKdEBDPn5+pQUHq2dmsSUmnODjUqqqhJye0YGCeGRnIk5OrTEy6b2+fHh7/wUBWAAAIiElEQVR4nO2d2ULbOhRF4yNFijNAQiCBMoShhBTo7f//3bUc2kLIIOnsI6ut90v7hLS8ZCVWZJ1Op02bNm3atGnTps0fGGOsizGm6Z4kiiHqDMeT+Wo1vxwPS6IGwI2lqt3qqlf/WPH2DZnpYqnVz3SL5cXUpuWumnucL66Xp1WW14v5UUlWsDlDw0VPaV28i9aqWAyTYRsqJ8fVRdfrXlT/VP9/nvTFOkDDY/UB+Be4uhmSUKMbXRgsis990EqfD0Q6YMvz7cjrZs9Ledm2v7MLVQdG+EFO07udyC7q5UhaNk2KPV3QxSW6A/TQ3Yfs0n0QpTblsTrQgRvsRyhdHWiwln0lSG0Hp3tHWi37dASkpkMX+Y36WIzaDvVBZjeZD2HUXp5r6nMhajPw64C+R7mmC09mMeqK2cNzTX2HoaaJN7MQtRn0PJkr6q+ITy4zCGAWmc2st2dYB2gZ0GIhMJvZR3/PdQcu2a7tKkg0nrqatwM70Otz2yx7gU2Cqe1jcPuaO6/QLFQ0ljrcs2t/wJvBTXiTSGr7GMHMVW0uI0TjqKM8u+ZHnFbpOK5VDHWcZ9f6ijWBxzVaU7MXr2I9V+N7ybjk5ihudNfUJ8wHPZrGMlfUjPFt5/HQheZRc5gLNY5vmv5jNMyjpinjehf6Nf6mpu8c6Io6+r5mea5afo6/qc0Lp2WGa57nKreMmYzXcrRrpucqvXjmzsHVwMPUEa7Znqt2m4SOoeZ7Lopuo9CFvg38GYDGbM88aP4ld9SdEGoIc6HimeOesTYT5JrGgNFVJR6aviJUF/rJ2zXGc1F8Y3w5iX3I2oi3a5RnfR3/OW0fMNC+rlGeC71gfCPjf2D+7IXPbAZjLtSE8UBdgkx7ucYx81bJ6BpHfdrf3xGKXJraljPOuk3sGtm26LO9s1nQr0eHmprx1vvDl713d+V0DzVdYubtOsw1YHrFXf/K9c4RThMgM+dpuk4fdlMXe1wj7+dK9BFzTZI4y2SfssM11DPrm8lb7OG9HiEd2uYa67lQ/D0YZgjt0RbXWM+FmiF+oF5B+6RfNqZWCv4xeP/f5yyPvevVObZXdx+oaQ69pkXB/MnyV7+usdTvXWMnSjdzo3ZLWjD1b9doz2qM2xBgT2So0Z670P2hMq7hnsF7YiVc5+25pvbbH+qbajbL3bML3YBd++++9IqaSmzRBFOHbAP0iAwznhoZKeacqeWY86WWZM6VWpY5T2ppZrf5JjdqeWb4kyY7WvyFsJra9z2WJNGwZ8kD1Bm5TsWck2vcmoEHdSau03muqbNwndJzTZ2B67Se86BO7bmmvgCv3YZmmJ456B3Mv4a5YdcNMTfpWjfG3KDrBpkbc90oc0OuG2ZuwLVuntnrNBAo8/2geWZHndB1xZzHeWAJXWfDnNB1RszJXGfFnMj1xm6V5pPAtdaZMeN3Unxmzs2zC3gP3CfmL8gjqGARpd6zg7jZCFLrL5kyC1Jn69kF+U7Ce+Z8PbuIuM7as4uA68w9u9AEu2uoKJ6yZ+4Yc4Zl1qs0p88yYvpPaNMqd2pTQl/5WEf4GFZuTAn37AJ5LUMqIp5dMnYt5NlF5Upt+kKeXbp5jnCxsb1Olq7N6Ickc5auTf+LLHOGrsU9u2TmOoFnF/WaEXUSzzX1RTbUiTzX1Lm4Tua5ps7DdVLmTKjNwKeEwN9F7X+cPo666fvaDO5TMzfuOqSEAJKacQgVgLkBzzW1VMEPH+ZGPDdK3ZjnBqltc54bo7bD5J9VjVPHH7P+51JXnptPYuoMPLskpc7Cs4u6SUadiWcXwWJsm8xNo75LItfRJUFkksQ1HWXFnMR1dswJXGfILO46S2Zh15ky1+WL/jlmV75IiJoYNZXEo05E9l0hymN86Cb2cVzENU3BR6bNRi9garhrQOmXD+nOCL3cpNGu8Z4Jv0kF/Mkl4Nn9WTP6hqVG/gpgJTyvqbGuu2PYCDfg5+d32yjQrgvU2y2mDzy4v9jY9Ai+rzXqtgbWpXDZ2C5jRmfIP9/lHl3/xow9f/vTRmasa1Ydz9+BlioouvNPncK6ZlcpcKFz6OjbtmHdjDAlquog7urAkvIHssVz3UgJpOaVJK5Dr0DRWz3X1B0cNauC0jr2HtWZnZ5rapxr/vjGVcza47luCOeaU8izDi1ww27/Szc46i63+AjdYjriccw6jJpTh7lOH1ag7fAx6yhq9cCbyWC3tNdx+qZzC6keytxwZUGvi3oep286iK/5mvmrtcV8SnuXTTB0wm+QC42ZvEPKJli+azY04ot3WHkMvuscoEPLY7Af37kTGQC6G1zih+tazXkfWfx7OqasEbNUFffLiZ0xoeNKOfEK+XSZx/1YZkm+2PJVLNcvzG+hzG9k8SW76Dm6Yf6jZcmB5pQpi6fmLyJwCqzzSrNFU6s+k5kzfWtmOTqKK9AFWBiMv6k1uyRIHDViCZheIpkBJUFiRjigUG3V8CxukEHKoES4hqz1d0YxN7UClX4Jdq2vMEVbIw44xpW7CS3adM+eutcpg5lRnl3CCn50p6Af5W1otXdsWaOQ0hfAoyLoJui2Rpdy8neNfaUj6K1w+JHjvq6xm4HNwB9aomwCLXxuMPSrO/bRc4QJHS3vc+Qu/vVi67f/V/eEjtOn8YEzCLREoVo79Dj5QP8QO6LY9vcuK6jlQGKbux08HRpiail47KOhy7tdHVB6RTItG7P/o0OrC6GW32JpdaY+Dzet7mcduXoNNL7fja1u5SstWju90kr/vtG0Vur6siPasDUPxVZsrV6kBtjHGLJHDzdf77RL7/Z6Ni7l26Vy/qQ2prTqai8nJllBEGOJyr5LSWTTnB1r6XH2vVBK1RdbqW7veT6gHGqgiKa61J3H8fzi9fX1YjIedFJd7sZjjF3H/CPAbdq0adOmTZs2bbD5H8lJpKRvNiuNAAAAAElFTkSuQmCC",this.buildObjectMeshes=new Array,this.labels=new Array,this.labelSVGS=new Array,this.baseMaterial,this.highlightMaterial,this.cancelledMaterial,this.cancelledHighlightMaterial,this.showCancelObjects=!1,this.objectCallback,this.renderFailedCallback,this.labelCallback,this.registerClipIgnore,this.getMaxHeight,this.alphaLevel=.5,this.observableControls=null,this.showLabel=localStorage.getItem("showObjectLabels"),this.showLabel===null?this.showLabel=!0:this.showLabel=JSON.parse(this.showLabel),this.rebuildMaterials()}return ts(a,[{key:"setBuildMaterial",value:function(e,t,i){i||(i=this.alphaLevel);var s=new pe(e,this.scene);return s.diffuseColor=t,s.specularColor=new re(0,0,0),s.alpha=i,s.needAlphaTesting=()=>!0,s.separateCullingPass=!0,s.backFaceCulling=!0,s}},{key:"rebuildMaterials",value:function(){this.baseMaterial=this.setBuildMaterial("BuildObjectBaseMaterial",new J(.1,.5,.1),.25),this.highlightMaterial=this.setBuildMaterial("BuildObjectHighlightMateria",new re(.8,.8,.8)),this.cancelledMaterial=this.setBuildMaterial("BuildObjectHighlightMateria",new re(1,0,0),.4),this.cancelledHighlightMaterial=this.setBuildMaterial("BuildObjectHighlightMateria",new re(1,1,0),.6);var e=H.CreateFromBase64String(this.xmark,"checkerboard",this.scene);this.cancelledMaterial.diffuseTexture=e,this.cancelledHighlightMaterial.diffuseTexture=e}},{key:"loadObjectBoundaries",value:function(e){if(this.rebuildMaterials(),this.buildObjectMeshes.length>0){for(var t=0;t<this.buildObjectMeshes.length;t++)this.buildObjectMeshes[t].dispose();this.labelSVGS.forEach(o=>window.URL.revokeObjectURL(o)),this.buildObjectMeshes=new Array,this.labels=new Array}if(e)for(var i=0;i<e.length;i++){var s=e[i],r=Os.CreateTiledBox("OBJECTMESH:"+s.name,{pattern:V.CAP_ALL,alignVertical:V.TOP,alignHorizontal:V.LEFT,tileHeight:4,tileWidth:4,width:Math.abs(s.x[1]-s.x[0]),height:this.getMaxHeight()+10,depth:Math.abs(s.y[1]-s.y[0]),sideOrientation:V.FRONTSIDE},this.scene);r.position.x=(s.x[1]+s.x[0])/2,r.position.y=this.getMaxHeight()/2-4,r.position.z=(s.y[1]+s.y[0])/2,r.alphaIndex=5e6,s.index=i,r.metadata=s,r.enablePointerMoveEvents=!0,r.renderingGroupId=3,this.setObjectTexture(r),r.setEnabled(this.showCancelObjects),this.registerClipIgnore(r),this.buildObjectMeshes.push(r);var n=this.makeTextPlane(s.name,s.cancelled?"yellow":"white",20);n.position=new g(0,this.getMaxHeight()/2+10,0),n.isPickable=!1,n.metadata=s,n.parent=r,n.setEnabled(this.showLabel),this.labels.push(n)}}},{key:"makeTextPlane",value:function(e,t,i){var s=ig("svg").attr("width",800).attr("height",200).attr("fill","none");s.append("text").attr("x",400).attr("y",100).attr("font-family","Verdana").attr("font-size","50px").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("fill","black").attr("stroke",t).attr("stroke-width",2).attr("text-rendering","optimizeLegibility").text(e);var r=s.attr("title","test2").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node(),n=new XMLSerializer().serializeToString(r),o=new Blob(['<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+n],{type:"image/svg+xml"}),l=window.URL.createObjectURL(o);this.labelSVGS.push(l);var h=Os.CreatePlane("TextPlane",{width:i,height:8},this.scene);return h.material=new pe("TextPlaneMaterial",this.scene),h.material.backFaceCulling=!1,h.material.specularColor=new re(0,0,0),h.material.diffuseTexture=new H(l,this.scene),h.material.diffuseTexture.hasAlpha=!0,h.billboardMode=7,this.registerClipIgnore(h),h}},{key:"buildObservables",value:function(){var e=this;if(!this.observableControls){var t=0,i=!1,s=0;this.observableControls=this.scene.onPointerObservable.add(r=>{var n=r.pickInfo;switch(r.type){case Ce.POINTERDOWN:i=!0,s=Date.now();break;case Ce.POINTERUP:if(i=!1,Date.now()-s>200)return;e.handleClick(n);break;case Ce.POINTERMOVE:if(i||Date.now()-t<100)return;t=Date.now(),e.handlePointerMove(n)}})}}},{key:"clearObservables",value:function(){this.observableControls&&(this.scene.onPointerObservable.remove(this.observableControls),this.observableControls=null)}},{key:"showObjectSelection",value:function(e){this.showCancelObjects=e,this.buildObjectMeshes.forEach(t=>t.setEnabled(e)),e?this.buildObservables():this.clearObservables()}},{key:"setObjectTexture",value:function(e){e.metadata.cancelled?(e.material=this.cancelledMaterial,e.enableEdgesRendering(),e.edgesWidth=15,e.edgesColor=new J(1,0,0,1)):(e.material=this.baseMaterial,e.enableEdgesRendering(),e.edgesWidth=15,e.edgesColor=new J(0,1,0,1))}},{key:"handleClick",value:function(e){this.showCancelObjects&&e.hit&&e.pickedMesh&&e.pickedMesh.name.includes("OBJECTMESH")&&this.objectCallback&&this.objectCallback(e.pickedMesh.metadata)}},{key:"handlePointerMove",value:function(e){var t=this;this.showCancelObjects&&(this.buildObjectMeshes.forEach(i=>t.setObjectTexture(i)),e.hit&&e.pickedMesh&&e.pickedMesh.name.includes("OBJECTMESH")?(e.pickedMesh.material=e.pickedMesh.metadata.cancelled?this.cancelledHighlightMaterial:this.highlightMaterial,this.labelCallback&&this.labelCallback(e.pickedMesh.metadata.name)):this.labelCallback&&this.labelCallback(""))}},{key:"showLabels",value:function(e){localStorage.setItem("showObjectLabels",e),this.showLabel=e,this.labels.forEach(t=>t.setEnabled(e))}}]),a}(),Dw=function(){function a(e){es(this,a),this.visible=localStorage.getItem("axesVisible"),this.visible===null?this.visible=!0:this.visible=JSON.parse(this.visible),this.scene=e,this.registerClipIgnore=()=>{},this.axesMesh,this.axesMeshPosition,this.size=50,this.debug=!1}return ts(a,[{key:"show",value:function(e){localStorage.setItem("axesVisible",e),this.axesMesh&&this.axesMesh.setEnabled(e),this.scene.render()}},{key:"makeTextPlane",value:function(e,t,i){var s=new ta("DynamicTexture",50,this.scene,!0);s.hasAlpha=!0,s.drawText(e,5,40,"bold 36px Arial",t,"transparent",!0);var r=V.CreatePlane("TextPlane",i,this.scene,!0);return r.material=new pe("TextPlaneMaterial",this.scene),r.material.backFaceCulling=!1,r.material.specularColor=new re(0,0,0),r.material.diffuseTexture=s,r}},{key:"resize",value:function(e){this.size=e,this.axesMesh.dispose(!1,!0),this.render()}},{key:"render",value:function(e){var t=this;if(!this.debug)if(!this.axesMesh||this.axesMesh.isDisposed()){this.axesMesh=new V("axis"),this.registerClipIgnore(this.axesMesh);var i=V.CreateLines("axisX",[g.Zero(),new g(this.size,0,0),new g(.95*this.size,.05*this.size,0),new g(this.size,0,0),new g(.95*this.size,-.05*this.size,0)],this.scene);i.color=new re(1,0,0),i.parent=this.axesMesh;var s=this.makeTextPlane("X","red",this.size/10);s.position=new g(.9*this.size,.05*this.size,0),s.parent=this.axesMesh;var r=V.CreateLines("axisZ",[g.Zero(),new g(0,0,this.size),new g(0,-.05*this.size,.95*this.size),new g(0,0,this.size),new g(0,.05*this.size,.95*this.size)],this.scene);r.color=new re(0,1,0),r.parent=this.axesMesh;var n=this.makeTextPlane("Y","green",this.size/10);n.position=new g(0,.05*this.size,.9*this.size),n.parent=this.axesMesh;var o=V.CreateLines("axisY",[g.Zero(),new g(0,this.size,0),new g(-.05*this.size,.95*this.size,0),new g(0,this.size,0),new g(.05*this.size,.95*this.size,0)],this.scene);o.color=new re(0,0,1),o.parent=this.axesMesh;var l=this.makeTextPlane("Z","blue",this.size/10);l.position=new g(0,.9*this.size,-.05*this.size),l.parent=this.axesMesh,this.axesMesh.setEnabled(this.visible),this.axesMesh.getChildren().forEach(h=>t.registerClipIgnore(h)),e&&(this.axesMesh.position=e)}else e&&(this.axesMesh.position=e)}},{key:"dispose",value:function(){this.axesMesh&&this.axesMesh.dispose(!1,!0)}}]),a}(),wt=null;function ao(a,e,t){var i=function(s,r,n,o,l,h){var c=arguments.length>6&&arguments[6]!==void 0?arguments[6]:75,u=ig("svg").attr("width",400).attr("height",300);u.append("rect").attr("x",0).attr("y",0).attr("width",400).attr("height",300).attr("fill","#333333"),u.append("text").attr("x",200).attr("y",150).attr("font-family","Roboto").attr("font-size",c+"px").attr("text-anchor","middle").attr("alignment-baseline","middle").attr("fill",o).attr("stroke",n).attr("stroke-width",2).attr("text-rendering","optimizeLegibility").text(r);var d=u.attr("title","test2").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").node(),f='<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">',p=new XMLSerializer().serializeToString(d),_=new Blob([f+p],{type:"image/svg+xml"}),m=window.URL.createObjectURL(_),v=Os.CreatePlane("TextPlane",{width:l,height:h},s);return v.material=new pe("TextPlaneMaterial",s),v.material.backFaceCulling=!1,v.material.specularColor=new re(0,0,0),v.material.diffuseTexture=new H(m,s),v.material.diffuseTexture.hasAlpha=!1,v}(a,e,"white","white",6,6,90);i.name=e,i.lookAt(t),i.position=t.scale(-3),e==="Top"&&i.rotate(ti.Z,Math.PI/2,Ze.LOCAL),e==="Bottom"&&i.rotate(ti.Z,-Math.PI/2,Ze.LOCAL),i.metadata={x:Math.sign(t.x),y:Math.sign(t.y),z:Math.sign(t.z)},i.isPickable=!0}function Mn(a,e,t){var i=Os.CreateSphere(e,{diameter:1.1},a),s=g.Zero();s.x=t.x-.25*Math.sign(t.x),s.y=t.y-.1*Math.sign(t.y),s.z=t.z-.25*Math.sign(t.z),i.metadata={x:-1*Math.sign(t.x),y:-1*Math.sign(t.y),z:-1*Math.sign(t.z)},i.position=s,i.isPickable=!0}var Sd,Yu=null;function hr(a,e,t){Yu||((Yu=new pe("edgematerial",a)).diffuseColor=new re(.5,.5,.5));var i=Os.CreateBox(e,{width:.35,height:5.8,depth:.35},a),s=g.Zero();t.y!==0&&(i.rotate(ti.Z,Math.PI/2,Ze.WORLD),t.x!==0&&i.rotate(ti.Y,Math.PI/2,Ze.WORLD),i.bakeCurrentTransformIntoVertices()),s.x=t.x-1*Math.sign(t.x),s.y=t.y-1*Math.sign(t.y),s.z=t.z-1*Math.sign(t.z),i.metadata={x:-1*Math.sign(t.x),y:-1*Math.sign(t.y),z:-1*Math.sign(t.z)},i.position=s,i.material=Yu}function Ow(a,e,t){(wt=new ge(a)).autoClear=!1;var i=new yt("camera1",5*Math.PI/8,5*Math.PI/8,13,new g(0,0,0),wt);i.viewport=new Es(.85,.85,.15,.15),i.viewport.toGlobal(200,200),e.afterRender=()=>{wt.render(),i.alpha=t.alpha,i.beta=t.beta,i.radius=15},new ea("light1",new g(0,1,0),wt).intensity=.8,new ea("light2",new g(-1,-.5,0),wt).intensity=.8;var s=3.9;hr(wt,"FrontLeft",new g(-s,0,-s)),hr(wt,"BackLeft",new g(-s,0,s)),hr(wt,"BackRight",new g(s,0,s)),hr(wt,"FrontRight",new g(s,0,-s)),hr(wt,"TopFront",new g(0,s,-s)),hr(wt,"TopBack",new g(0,s,s)),hr(wt,"TopLeft",new g(-s,s,0)),hr(wt,"TopRight",new g(s,s,0)),hr(wt,"BottomFront",new g(0,-s,-s)),hr(wt,"BottomBack",new g(0,-s,s)),hr(wt,"BottomLeft",new g(-s,-s,0)),hr(wt,"BottomRight",new g(s,-s,0)),Mn(wt,"FrontTopLeft",new g(-3,3,-3)),Mn(wt,"FrontTopRight",new g(3,3,-3)),Mn(wt,"BackTopLeft",new g(-3,3,3)),Mn(wt,"BackTopRight",new g(3,3,3)),Mn(wt,"FrontBottomLeft",new g(-3,-3,-3)),Mn(wt,"FrontBottomRight",new g(3,-3,-3)),Mn(wt,"BackBottomLeft",new g(-3,-3,3)),Mn(wt,"BackBottomRight",new g(3,-3,3)),ao(wt,"Front",new g(0,0,1)),ao(wt,"Right",new g(-1,0,0)),ao(wt,"Back",new g(0,0,-1)),ao(wt,"Left",new g(1,0,0)),ao(wt,"Top",new g(0,-1,0)),ao(wt,"Bottom",new g(0,1,0)),wt.onPointerDown=(r,n)=>{n.distance>0&&Sd&&(Sd(n.pickedMesh.metadata),wt.render(!0))}}var ww=function(){function a(s){es(this,a),this.lastLoadKey="lastLoadFailed",this.fileData,this.fileDataArray,this.fileSize=0,this.gcodeProcessor=new Rw,this.maxHeight=0,this.minHeight=0,this.sceneBackgroundColor="#000000",this.canvas=s,this.scene={},this.loading=!1,this.toolVisible=!1,this.travelVisible=!1,this.debug=!1,this.zTopClipValue,this.zBottomClipValue,this.cancelHitTimer=0,this.pause=!1,this.hqNozzle=!0,this.cameraInertia=localStorage.getItem("cameraInertia")==="true",this.bed,this.buildObjects,this.axes,this.renderQuality=Number(localStorage.getItem("renderQuality")),this.renderQuality!==void 0&&this.renderQuality!==null||(this.renderQuality=1),this.renderTimeout=1e3}var e,t,i;return ts(a,[{key:"getMaxHeight",value:function(){return this.maxHeight}},{key:"getMinHeight",value:function(){return this.minHeight}},{key:"setCameraType",value:function(s){this.scene.activeCamera=s?this.orbitCamera:this.flyCamera}},{key:"setZClipPlane",value:function(s,r){this.zTopClipValue=-s,this.zBottomClipValue=r,r>s&&(this.zTopClipValue=r+1),this.scene.clipPlane=new Hi(0,1,0,this.zTopClipValue),this.scene.clipPlane2=new Hi(0,-1,0,this.zBottomClipValue),this.scene.render()}},{key:"isArcRotateCameraStopped",value:function(s){return s.inertialAlphaOffset===0&&s.inertialBetaOffset===0&&s.inertialRadiusOffset===0&&s.inertialPanningX===0&&s.inertialPanningY===0}},{key:"init",value:(i=fn(Bi().mark(function s(r){var n,o,l=this;return Bi().wrap(function(h){for(;;)switch(h.prev=h.next){case 0:return r===void 0&&(r=!1),console.info("GCode Viewer - Sindarius - ".concat("3.1.4"," ")),h.next=4,Le.IsSupportedAsync;case 4:if(!h.sent||!r){h.next=13;break}return console.log("WebGPU Supported"),this.engine=new Le(this.canvas,{doNotHandleContextLost:!0}),h.next=10,this.engine.initAsync();case 10:console.log(this.engine),h.next=15;break;case 13:console.log("WebGPU Not Supported"),this.engine=new k(this.canvas,!0,{doNotHandleContextLost:!0});case 15:this.engine.enableOfflineSupport=!1,this.scene=new ge(this.engine),this.debug,this.scene.clearColor=re.FromHexString(this.getBackgroundColor()),this.bed=new Pw(this.scene),this.bed.registerClipIgnore=c=>{l.registerClipIgnore(c)},n=this.bed.getCenter(),this.orbitCamera=new yt("Camera",Math.PI/2,2.356194,250,new g(n.x,-2,n.y),this.scene),this.orbitCamera.attachControl(!1),this.orbitCamera.invertRotation=!1,this.orbitCamera.attachControl(this.canvas,!1),this.orbitCamera.maxZ=1e5,this.orbitCamera.lowerRadiusLimit=5,this.updateCameraInertiaProperties(),(o=new Sc("light2",new g(0,1,-1),this.scene)).diffuse=new re(1,1,1),o.specular=new re(1,1,1),this.engine.runRenderLoop(()=>{l.pause||Date.now()-l.gcodeProcessor.lastUpdate>l.renderTimeout&&l.isArcRotateCameraStopped(l.orbitCamera)||(l.scene.render(!0),o.position=l.scene.cameras[0].position)}),this.buildObjects=new Mw(this.scene),this.buildObjects.getMaxHeight=()=>l.gcodeProcessor.getMaxHeight(),this.buildObjects.registerClipIgnore=c=>{l.registerClipIgnore(c)},this.bed.buildBed(),this.axes=new Dw(this.scene),this.axes.registerClipIgnore=c=>{l.registerClipIgnore(c)},this.axes.render(),this.resetCamera(),Ow(this.engine,this.scene,this.orbitCamera),Sd=c=>{l.setCameraPosition(c)},setTimeout(()=>{l.forceRender()},1e3);case 44:case"end":return h.stop()}},s,this)})),function(s){return i.apply(this,arguments)})},{key:"setCameraPosition",value:function(s){var r=this.bed.getCenter(),n=this.bed.getSize();this.scene.activeCamera.radius=1.5*n.x,this.scene.activeCamera.target=new g(r.x,r.z,r.y);var o=g.Zero(),l=(s.x==0?1:0)+(s.y==0?1:0)+(s.z==0?1:0)==2?1.75:1.35;switch(s.x){case 1:o.x=r.x-n.x*l;break;case 0:o.x=r.x;break;case-1:o.x=r.x+n.x*l}switch(s.y){case 1:o.y=r.z-n.z*l;break;case 0:o.y=r.z;break;case-1:o.y=r.z+n.z*l}switch(s.z){case 1:o.z=r.y-n.y*l;break;case 0:o.z=r.y;break;case-1:o.z=r.y+n.y*l}s.x===0&&s.z===0?(this.scene.activeCamera.target=new g(r.x,0,r.y),this.scene.activeCamera.position=o,this.scene.activeCamera.alpha=3*Math.PI/2):this.scene.activeCamera.position=o,this.scene.render(!0),this.scene.render(!0)}},{key:"resize",value:function(){this.engine.resize(),this.scene.render(!0)}},{key:"refreshUI",value:function(){setTimeout(()=>{},0)}},{key:"resetCamera",value:function(){var s=this.bed.getCenter(),r=this.bed.getSize();this.bed.isDelta?(this.scene.activeCamera.radius=s.x,this.scene.activeCamera.target=new g(s.x,-2,s.y),this.scene.activeCamera.position=new g(-r.x,r.z,-r.x)):(this.scene.activeCamera.radius=3*s.x,this.scene.activeCamera.target=new g(s.x,-2,s.y),this.scene.activeCamera.position=new g(-r.x/2,r.z,-r.y/2)),this.scene.render(!0),this.scene.render(!0)}},{key:"lastLoadFailed",value:function(){return!!localStorage&&localStorage.getItem(this.lastLoadKey)==="true"}},{key:"setLoadFlag",value:function(){localStorage&&localStorage.setItem(this.lastLoadKey,"true")}},{key:"clearLoadFlag",value:function(){localStorage&&(localStorage.setItem(this.lastLoadKey,""),localStorage.removeItem(this.lastLoadKey))}},{key:"processFile",value:(t=fn(Bi().mark(function s(r){return Bi().wrap(function(n){for(;;)switch(n.prev=n.next){case 0:return this.clearScene(),this.refreshUI(),r?(this.fileData=r,this.fileSize=r.length):(this.fileData=0,this.fileSize=0),this.fileDataArray=this.fileData.split(`
`),this.gcodeProcessor.setProgressColor(this.getProgressColor()),this.gcodeProcessor.scene=this.scene,this.lastLoadFailed()&&(console.error("Last rendering failed dropping to SBC quality"),this.updateRenderQuality(1),this.clearLoadFlag()),this.setLoadFlag(),n.next=10,this.gcodeProcessor.processGcodeFile(r,this.renderQuality);case 10:return this.clearLoadFlag(),n.next=13,this.gcodeProcessor.createMesh(this.scene);case 13:this.gcodeProcessor.loadingComplete(),this.maxHeight=this.gcodeProcessor.getMaxHeight(),this.minHeight=this.gcodeProcessor.getMinHeight(),this.toggleTravels(this.travelVisible),this.setCursorVisiblity(this.toolCursorVisible);case 18:case"end":return n.stop()}},s,this)})),function(s){return t.apply(this,arguments)})},{key:"toggleTravels",value:function(s){var r,n=function(l,h){var c=typeof Symbol<"u"&&l[Symbol.iterator]||l["@@iterator"];if(!c){if(Array.isArray(l)||(c=P0(l))||h&&l&&typeof l.length=="number"){c&&(l=c);var u=0,d=()=>{};return{s:d,n:()=>u>=l.length?{done:!0}:{done:!1,value:l[u++]},e:m=>{throw m},f:d}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var f,p=!0,_=!1;return{s:()=>{c=c.call(l)},n:()=>{var m=c.next();return p=m.done,m},e:m=>{_=!0,f=m},f:()=>{try{p||c.return==null||c.return()}finally{if(_)throw f}}}}(this.scene.meshes);try{for(n.s();!(r=n.n()).done;){var o=r.value;o.name==="travels"&&(o.isVisible=s)}}catch(l){n.e(l)}finally{n.f()}this.travelVisible=s,this.scene.render(!0)}},{key:"getProgressColor",value:function(){var s=localStorage.getItem("progressColor");return s===null&&(s="#FFFFFF"),s}},{key:"setProgressColor",value:function(s){localStorage.setItem("progressColor",s),this.gcodeProcessor.setProgressColor(s)}},{key:"getBackgroundColor",value:function(){var s=localStorage.getItem("sceneBackgroundColor");return s===null&&(s="#000000"),s}},{key:"setBackgroundColor",value:function(s){this.scene!==null&&this.scene!==void 0&&(s.length>7&&(s=s.substring(0,7)),this.scene.clearColor=re.FromHexString(s),this.scene.render()),localStorage.setItem("sceneBackgroundColor",s)}},{key:"clearScene",value:function(s){this.fileData&&s&&(this.fileData=""),this.gcodeProcessor.unregisterEvents();for(var r=this.scene.meshes.length-1;r>=0;r--){var n=this.scene.meshes[r];n&&this.debug&&console.log("Disposing ".concat(n.name)),this.scene.removeMesh(n),n&&typeof n.dispose=="function"&&n.dispose(!1,!0)}for(var o=this.scene.materials.length-1;o>=0;o--){var l=this.scene.materials[o];l.name==="solidMaterial"&&(l&&this.debug&&console.log("Disposing ".concat(l.name)),this.scene.removeMaterial(l),l&&typeof l.dispose=="function"&&l.dispose(!1,!0))}this.toolCursor&&(this.toolCursor.dispose(!1,!0),this.toolCursor=void 0),this.buildtoolCursor(),this.bed.buildBed(),this.axes.render()}},{key:"reload",value:(e=fn(Bi().mark(function s(){return Bi().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return this.clearScene(),r.next=3,this.processFile(this.fileData);case 3:case"end":return r.stop()}},s,this)})),function(){return e.apply(this,arguments)})},{key:"getRenderMode",value:function(){return this.gcodeProcessor.renderMode}},{key:"setCursorVisiblity",value:function(s){this.scene!==void 0&&(this.toolCursor===void 0&&this.buildtoolCursor(),this.toolCursorMesh.isVisible=s,this.toolCursorVisible=s,this.scene.render())}},{key:"updateToolPosition",value:function(s){var r=0,n=0,o=0;if(this.buildtoolCursor(),s instanceof g)r=s.x,n=s.z,o=s.y;else for(var l=0;l<s.length;l++)switch(s[l].axes){case"X":r=s[l].position;break;case"Y":n=s[l].position;break;case"Z":o=s[l].position*(this.gcodeProcessor.spreadLines?this.gcodeProcessor.spreadLineAmount:1)}this.toolCursor.setAbsolutePosition(new g(r,o,n)),this.toolCursorMesh.isVisible&&this.scene.render()}},{key:"buildtoolCursor",value:function(){if(this.toolCursor===void 0){this.toolCursor=new ke("toolCursorContainer"),Be.ShowLoadingScreen=!1,Be.Append("",`data:# WaveFront *.obj file (generated by Autodesk ATF)

g JRNozzle

v 0.429187 -3.010668 2.826259
v 0.421210 -3.010485 2.813202
v 0.412190 -3.010277 2.801026
v 0.401522 -3.010032 2.790242
v 0.389909 -3.009764 2.780255
v 0.392210 -2.909791 2.780255
v 0.403822 -2.910058 2.790242
v 0.414490 -2.910303 2.801026
v 0.423510 -2.910511 2.813202
v 0.431487 -2.910695 2.826259
v 0.373704 -3.009392 2.770250
v 0.356792 -3.009002 2.762005
v 0.338760 -3.008588 2.756557
v 0.320082 -3.008158 2.752720
v 0.322382 -2.908184 2.752720
v 0.341060 -2.908614 2.756557
v 0.359093 -2.909029 2.762005
v 0.376004 -2.909418 2.770250
v 0.294312 -3.007565 2.749930
v 0.268495 -3.006971 2.747890
v 0.242609 -3.006376 2.746972
v 0.216685 -3.005779 2.746676
v 0.218985 -2.905806 2.746676
v 0.244909 -2.906402 2.746972
v 0.270795 -2.906998 2.747890
v 0.296612 -2.907591 2.749930
v 0.137458 -3.003956 2.746676
v 0.139758 -2.903983 2.746676
v 0.137458 -3.003956 3.015984
v 0.139758 -2.903983 3.015984
v 0.230784 -3.006103 3.015984
v 0.233084 -2.906130 3.015984
v 0.251108 -3.006571 3.015850
v 0.271425 -3.007038 3.015480
v 0.291729 -3.007506 3.014692
v 0.312025 -3.007973 3.013633
v 0.314326 -2.907999 3.013633
v 0.294029 -2.907532 3.014692
v 0.273725 -2.907065 3.015480
v 0.253408 -2.906598 3.015850
v 0.327664 -3.008332 3.012024
v 0.343112 -3.008688 3.009541
v 0.358225 -3.009035 3.005526
v 0.373124 -3.009378 3.000537
v 0.375424 -2.909405 3.000537
v 0.360525 -2.909062 3.005526
v 0.345412 -2.908714 3.009541
v 0.329964 -2.908359 3.012024
v 0.388822 -3.009739 2.992940
v 0.403254 -3.010071 2.983797
v 0.415441 -3.010352 2.971906
v 0.426166 -3.010599 2.958227
v 0.428466 -2.910625 2.958227
v 0.417742 -2.910378 2.971906
v 0.405555 -2.910098 2.983797
v 0.391122 -2.909766 2.992940
v 0.432998 -3.010756 2.942842
v 0.438146 -3.010874 2.927042
v 0.440638 -3.010932 2.910586
v 0.441608 -3.010954 2.893754
v 0.443908 -2.910980 2.893754
v 0.442938 -2.910958 2.910586
v 0.440446 -2.910901 2.927042
v 0.435298 -2.910782 2.942842
v 0.441038 -3.010941 2.876383
v 0.439178 -3.010898 2.859264
v 0.434976 -3.010801 2.842606
v 0.437276 -2.910828 2.842606
v 0.441478 -2.910924 2.859264
v 0.443338 -2.910967 2.876383
v 0.510093 -3.012529 2.628475
v 0.551628 -3.013485 2.651463
v 0.590608 -3.014382 2.677637
v 0.625121 -3.015176 2.709380
v 0.656797 -3.015905 2.744661
v 0.659097 -2.915931 2.744661
v 0.627421 -2.915202 2.709380
v 0.592908 -2.914408 2.677637
v 0.553928 -2.913511 2.651463
v 0.512393 -2.912556 2.628475
v 0.679846 -3.016435 2.786804
v 0.697041 -3.016831 2.830679
v 0.705168 -3.017017 2.877239
v 0.708160 -3.017086 2.925319
v 0.710460 -2.917113 2.925319
v 0.707468 -2.917044 2.877239
v 0.699341 -2.916857 2.830679
v 0.682146 -2.916461 2.786804
v 0.706219 -3.017042 2.960458
v 0.700958 -3.016921 2.994740
v 0.689832 -3.016665 3.027509
v 0.674925 -3.016322 3.059302
v 0.677225 -2.916348 3.059302
v 0.692133 -2.916691 3.027509
v 0.703258 -2.916947 2.994740
v 0.708519 -2.917068 2.960458
v 0.656164 -3.015890 3.084796
v 0.635398 -3.015412 3.108227
v 0.611325 -3.014858 3.128259
v 0.585291 -3.014260 3.146273
v 0.587591 -2.914286 3.146273
v 0.613625 -2.914885 3.128259
v 0.637698 -2.915439 3.108227
v 0.658464 -2.915917 3.084796
v 0.556876 -3.013606 3.161195
v 0.527664 -3.012934 3.173934
v 0.497122 -3.012231 3.183026
v 0.465779 -3.011510 3.189926
v 0.468079 -2.911536 3.189926
v 0.499422 -2.912257 3.183026
v 0.529964 -2.912960 3.173934
v 0.559176 -2.913632 3.161195
v 0.427819 -3.010637 3.194504
v 0.389776 -3.009761 3.197889
v 0.351607 -3.008883 3.199454
v 0.313368 -3.008003 3.200000
v 0.315668 -2.908030 3.200000
v 0.353907 -2.908910 3.199454
v 0.392076 -2.909788 3.197889
v 0.430119 -2.910663 3.194504
v -0.119022 -2.998056 3.200000
v -0.116722 -2.898082 3.200000
v -0.119022 -2.998056 2.200000
v -0.116722 -2.898082 2.200000
v 0.137458 -3.003956 2.200000
v 0.139758 -2.903983 2.200000
v 0.137458 -3.003956 2.566689
v 0.139758 -2.903983 2.566689
v 0.256907 -3.006704 2.566689
v 0.259207 -2.906731 2.566689
v 0.528882 -3.012962 2.200000
v 0.531182 -2.912988 2.200000
v 0.843786 -3.020207 2.200000
v 0.846086 -2.920233 2.200000
v -0.361403 -2.992479 3.200000
v -0.848178 -2.981280 3.200000
v -0.845878 -2.881306 3.200000
v -0.359103 -2.892506 3.200000
v -0.848178 -2.981280 3.015984
v -0.845878 -2.881306 3.015984
v -0.619226 -2.986547 3.015984
v -0.616926 -2.886574 3.015984
v -0.619226 -2.986547 2.617310
v -0.616926 -2.886574 2.617310
v -0.619316 -2.986545 2.592175
v -0.619616 -2.986539 2.567043
v -0.620298 -2.986523 2.541920
v -0.621240 -2.986501 2.516802
v -0.618940 -2.886528 2.516802
v -0.617998 -2.886549 2.541920
v -0.617316 -2.886565 2.567043
v -0.617016 -2.886572 2.592175
v -0.623187 -2.986456 2.498146
v -0.626433 -2.986382 2.479806
v -0.631888 -2.986256 2.462004
v -0.638697 -2.986100 2.444533
v -0.636397 -2.886126 2.444533
v -0.629588 -2.886283 2.462004
v -0.624133 -2.886408 2.479806
v -0.620887 -2.886483 2.498146
v -0.649070 -2.985861 2.428224
v -0.661200 -2.985582 2.413707
v -0.676153 -2.985238 2.402066
v -0.692746 -2.984856 2.392096
v -0.690446 -2.884882 2.392096
v -0.673853 -2.885264 2.402066
v -0.658900 -2.885608 2.413707
v -0.646770 -2.885887 2.428224
v -0.719047 -2.984251 2.383107
v -0.745835 -2.983635 2.376701
v -0.773318 -2.983002 2.373986
v -0.801179 -2.982361 2.373271
v -0.798879 -2.882388 2.373271
v -0.771018 -2.883029 2.373986
v -0.743535 -2.883661 2.376701
v -0.716747 -2.884277 2.383107
v -0.823764 -2.981842 2.373764
v -0.846217 -2.981325 2.375333
v -0.868428 -2.980814 2.378851
v -0.890477 -2.980307 2.383680
v -0.888177 -2.880333 2.383680
v -0.866128 -2.880841 2.378851
v -0.843917 -2.881352 2.375333
v -0.821464 -2.881868 2.373764
v -0.907395 -2.979918 2.388908
v -0.924242 -2.979530 2.394350
v -0.940967 -2.979145 2.400154
v -0.957618 -2.978762 2.406179
v -0.955318 -2.878789 2.406179
v -0.938667 -2.879172 2.400154
v -0.921942 -2.879557 2.394350
v -0.905095 -2.879944 2.388908
v -0.981789 -2.978206 2.406179
v -0.979489 -2.878233 2.406179
v -0.981789 -2.978206 2.203967
v -0.979489 -2.878233 2.203967
v -0.955081 -2.978821 2.199277
v -0.928288 -2.979437 2.195213
v -0.901363 -2.980056 2.192119
v -0.874363 -2.980678 2.189575
v -0.872063 -2.880704 2.189575
v -0.899063 -2.880083 2.192119
v -0.925988 -2.879463 2.195213
v -0.952781 -2.878847 2.199277
v -0.841836 -2.981426 2.187396
v -0.809288 -2.982175 2.185732
v -0.776708 -2.982924 2.184901
v -0.744109 -2.983674 2.184553
v -0.741809 -2.883701 2.184553
v -0.774408 -2.882951 2.184901
v -0.806988 -2.882201 2.185732
v -0.839536 -2.881452 2.187396
v -0.700655 -2.984674 2.185766
v -0.657537 -2.985666 2.189337
v -0.615019 -2.986644 2.197134
v -0.572898 -2.987613 2.207723
v -0.570598 -2.887640 2.207723
v -0.612719 -2.886671 2.197134
v -0.655237 -2.885693 2.189337
v -0.698355 -2.884701 2.185766
v -0.541154 -2.988344 2.220145
v -0.510585 -2.989047 2.234674
v -0.482032 -2.989704 2.252818
v -0.454729 -2.990332 2.273203
v -0.452429 -2.890358 2.273203
v -0.479732 -2.889730 2.252818
v -0.508284 -2.889073 2.234674
v -0.538854 -2.888370 2.220145
v -0.433234 -2.990827 2.294554
v -0.413950 -2.991270 2.317498
v -0.398331 -2.991630 2.343084
v -0.384902 -2.991939 2.370248
v -0.382602 -2.891965 2.370248
v -0.396031 -2.891656 2.343084
v -0.411649 -2.891297 2.317498
v -0.430934 -2.890853 2.294554
v -0.374848 -2.992170 2.400254
v -0.367099 -2.992348 2.430703
v -0.363132 -2.992439 2.461879
v -0.361403 -2.992479 2.493486
v -0.359103 -2.892506 2.493486
v -0.360832 -2.892466 2.461879
v -0.364799 -2.892375 2.430703
v -0.372548 -2.892196 2.400254
v -1.800595 -2.959368 1.700000
v 1.662591 -3.039045 1.700000
v 1.662591 -3.039045 3.700000
v -1.800595 -2.959368 3.700000
v 0.500000 0.000000 7.700000
v 0.492808 0.084500 7.700000
v 0.471439 0.166570 7.700000
v 0.436507 0.243847 7.700000
v 0.389018 0.314110 7.700000
v 0.330337 0.375336 7.700000
v 0.262154 0.425765 7.700000
v 0.186428 0.463945 7.700000
v 0.105340 0.488778 7.700000
v 0.021221 0.499549 7.700000
v -0.063509 0.495950 7.700000
v -0.146411 0.478083 7.700000
v -0.225102 0.446463 7.700000
v -0.297317 0.401999 7.700000
v -0.360978 0.345969 7.700000
v -0.414255 0.279987 7.700000
v -0.455614 0.205951 7.700000
v -0.483866 0.125989 7.700000
v -0.498199 0.042403 7.700000
v -0.498199 -0.042403 7.700000
v -0.483866 -0.125989 7.700000
v -0.455614 -0.205951 7.700000
v -0.414255 -0.279987 7.700000
v -0.360978 -0.345969 7.700000
v -0.297317 -0.401999 7.700000
v -0.225102 -0.446463 7.700000
v -0.146411 -0.478083 7.700000
v -0.063509 -0.495950 7.700000
v 0.021221 -0.499549 7.700000
v 0.105340 -0.488778 7.700000
v 0.186428 -0.463945 7.700000
v 0.262154 -0.425765 7.700000
v 0.330337 -0.375336 7.700000
v 0.389018 -0.314110 7.700000
v 0.436507 -0.243847 7.700000
v 0.471439 -0.166570 7.700000
v 0.492808 -0.084500 7.700000
v 0.500000 0.000000 3.700000
v 0.492808 -0.084500 3.700000
v 0.471439 -0.166570 3.700000
v 0.436507 -0.243847 3.700000
v 0.389018 -0.314110 3.700000
v 0.330337 -0.375336 3.700000
v 0.262154 -0.425765 3.700000
v 0.186428 -0.463945 3.700000
v 0.105340 -0.488778 3.700000
v 0.021221 -0.499549 3.700000
v -0.063509 -0.495950 3.700000
v -0.146411 -0.478083 3.700000
v -0.225102 -0.446463 3.700000
v -0.297317 -0.401999 3.700000
v -0.360978 -0.345969 3.700000
v -0.414255 -0.279987 3.700000
v -0.455614 -0.205951 3.700000
v -0.483866 -0.125989 3.700000
v -0.498199 -0.042403 3.700000
v -0.498199 0.042403 3.700000
v -0.483866 0.125989 3.700000
v -0.455614 0.205951 3.700000
v -0.414255 0.279987 3.700000
v -0.360978 0.345969 3.700000
v -0.297317 0.401999 3.700000
v -0.225102 0.446463 3.700000
v -0.146411 0.478083 3.700000
v -0.063509 0.495950 3.700000
v 0.021221 0.499549 3.700000
v 0.105340 0.488778 3.700000
v 0.186428 0.463945 3.700000
v 0.262154 0.425765 3.700000
v 0.330337 0.375336 3.700000
v 0.389018 0.314110 3.700000
v 0.436507 0.243847 3.700000
v 0.471439 0.166570 3.700000
v 0.492808 0.084500 3.700000
v 0.500000 -0.000000 6.366667
v 0.500000 -0.000000 5.033333
v 0.492404 0.086824 6.366667
v 0.492404 0.086824 5.033333
v 0.469846 0.171010 6.366667
v 0.469846 0.171010 5.033333
v 0.433013 0.250000 6.366667
v 0.433013 0.250000 5.033333
v 0.383022 0.321394 6.366667
v 0.383022 0.321394 5.033333
v 0.321394 0.383022 6.366667
v 0.321394 0.383022 5.033333
v 0.250000 0.433013 6.366667
v 0.250000 0.433013 5.033333
v 0.171010 0.469846 6.366667
v 0.171010 0.469846 5.033333
v 0.086824 0.492404 6.366667
v 0.086824 0.492404 5.033333
v -0.000000 0.500000 6.366667
v -0.000000 0.500000 5.033333
v -0.086824 0.492404 6.366667
v -0.086824 0.492404 5.033333
v -0.171010 0.469846 6.366667
v -0.171010 0.469846 5.033333
v -0.250000 0.433013 6.366667
v -0.250000 0.433013 5.033333
v -0.321394 0.383022 6.366667
v -0.321394 0.383022 5.033333
v -0.383022 0.321394 6.366667
v -0.383022 0.321394 5.033333
v -0.433013 0.250000 6.366667
v -0.433013 0.250000 5.033333
v -0.469846 0.171010 6.366667
v -0.469846 0.171010 5.033333
v -0.492404 0.086824 6.366667
v -0.492404 0.086824 5.033333
v -0.500000 0.000000 6.366667
v -0.500000 0.000000 5.033333
v -0.492404 -0.086824 6.366667
v -0.492404 -0.086824 5.033333
v -0.469846 -0.171010 6.366667
v -0.469846 -0.171010 5.033333
v -0.433013 -0.250000 6.366667
v -0.433013 -0.250000 5.033333
v -0.383022 -0.321394 6.366667
v -0.383022 -0.321394 5.033333
v -0.321394 -0.383022 6.366667
v -0.321394 -0.383022 5.033333
v -0.250000 -0.433013 6.366667
v -0.250000 -0.433013 5.033333
v -0.171010 -0.469846 6.366667
v -0.171010 -0.469846 5.033333
v -0.086824 -0.492404 6.366667
v -0.086824 -0.492404 5.033333
v -0.000000 -0.500000 6.366667
v -0.000000 -0.500000 5.033333
v 0.086824 -0.492404 6.366667
v 0.086824 -0.492404 5.033333
v 0.171010 -0.469846 6.366667
v 0.171010 -0.469846 5.033333
v 0.250000 -0.433013 6.366667
v 0.250000 -0.433013 5.033333
v 0.321394 -0.383022 6.366667
v 0.321394 -0.383022 5.033333
v 0.383022 -0.321394 6.366667
v 0.383022 -0.321394 5.033333
v 0.433013 -0.250000 6.366667
v 0.433013 -0.250000 5.033333
v 0.469846 -0.171010 6.366667
v 0.469846 -0.171010 5.033333
v 0.492404 -0.086824 6.366667
v 0.492404 -0.086824 5.033333
v 1.292723 0.000000 7.700000
v 1.285145 -0.139768 7.700000
v 1.262500 -0.277897 7.700000
v 1.225053 -0.412768 7.700000
v 1.173244 -0.542800 7.700000
v 1.107679 -0.666468 7.700000
v 1.029128 -0.782323 7.700000
v 0.938511 -0.889005 7.700000
v 0.836891 -0.985264 7.700000
v 0.725459 -1.069973 7.700000
v 0.605522 -1.142136 7.700000
v 0.478486 -1.200910 7.700000
v 0.345840 -1.245603 7.700000
v 0.209139 -1.275693 7.700000
v 0.069987 -1.290827 7.700000
v -0.069987 -1.290827 7.700000
v -0.209139 -1.275693 7.700000
v -0.345840 -1.245603 7.700000
v -0.478486 -1.200910 7.700000
v -0.605522 -1.142136 7.700000
v -0.725459 -1.069973 7.700000
v -0.836891 -0.985264 7.700000
v -0.938511 -0.889005 7.700000
v -1.029128 -0.782323 7.700000
v -1.107679 -0.666468 7.700000
v -1.173244 -0.542800 7.700000
v -1.225053 -0.412768 7.700000
v -1.262500 -0.277897 7.700000
v -1.285145 -0.139768 7.700000
v -1.292723 0.000000 7.700000
v -1.285145 0.139768 7.700000
v -1.262500 0.277897 7.700000
v -1.225053 0.412768 7.700000
v -1.173244 0.542800 7.700000
v -1.107679 0.666468 7.700000
v -1.029128 0.782323 7.700000
v -0.938511 0.889005 7.700000
v -0.836891 0.985264 7.700000
v -0.725459 1.069973 7.700000
v -0.605522 1.142136 7.700000
v -0.478486 1.200910 7.700000
v -0.345840 1.245603 7.700000
v -0.209139 1.275693 7.700000
v -0.069987 1.290827 7.700000
v 0.069987 1.290827 7.700000
v 0.209139 1.275693 7.700000
v 0.345840 1.245603 7.700000
v 0.478486 1.200910 7.700000
v 0.605522 1.142136 7.700000
v 0.725459 1.069973 7.700000
v 0.836891 0.985264 7.700000
v 0.938511 0.889005 7.700000
v 1.029128 0.782323 7.700000
v 1.107679 0.666468 7.700000
v 1.173244 0.542800 7.700000
v 1.225053 0.412768 7.700000
v 1.262500 0.277897 7.700000
v 1.285145 0.139768 7.700000
v 1.292723 0.000000 3.700000
v 1.285145 0.139768 3.700000
v 1.262500 0.277897 3.700000
v 1.225053 0.412768 3.700000
v 1.173244 0.542800 3.700000
v 1.107679 0.666468 3.700000
v 1.029128 0.782323 3.700000
v 0.938511 0.889005 3.700000
v 0.836891 0.985264 3.700000
v 0.725459 1.069973 3.700000
v 0.605522 1.142136 3.700000
v 0.478486 1.200910 3.700000
v 0.345840 1.245603 3.700000
v 0.209139 1.275693 3.700000
v 0.069987 1.290827 3.700000
v -0.069987 1.290827 3.700000
v -0.209139 1.275693 3.700000
v -0.345840 1.245603 3.700000
v -0.478486 1.200910 3.700000
v -0.605522 1.142136 3.700000
v -0.725459 1.069973 3.700000
v -0.836891 0.985264 3.700000
v -0.938511 0.889005 3.700000
v -1.029128 0.782323 3.700000
v -1.107679 0.666468 3.700000
v -1.173244 0.542800 3.700000
v -1.225053 0.412768 3.700000
v -1.262500 0.277897 3.700000
v -1.285145 0.139768 3.700000
v -1.292723 0.000000 3.700000
v -1.285145 -0.139768 3.700000
v -1.262500 -0.277897 3.700000
v -1.225053 -0.412768 3.700000
v -1.173244 -0.542800 3.700000
v -1.107679 -0.666468 3.700000
v -1.029128 -0.782323 3.700000
v -0.938511 -0.889005 3.700000
v -0.836891 -0.985264 3.700000
v -0.725459 -1.069973 3.700000
v -0.605522 -1.142136 3.700000
v -0.478486 -1.200910 3.700000
v -0.345840 -1.245603 3.700000
v -0.209139 -1.275693 3.700000
v -0.069987 -1.290827 3.700000
v 0.069987 -1.290827 3.700000
v 0.209139 -1.275693 3.700000
v 0.345840 -1.245603 3.700000
v 0.478486 -1.200910 3.700000
v 0.605522 -1.142136 3.700000
v 0.725459 -1.069973 3.700000
v 0.836891 -0.985264 3.700000
v 0.938511 -0.889005 3.700000
v 1.029128 -0.782323 3.700000
v 1.107679 -0.666468 3.700000
v 1.173244 -0.542800 3.700000
v 1.225053 -0.412768 3.700000
v 1.262500 -0.277897 3.700000
v 1.285145 -0.139768 3.700000
v 1.292723 0.000000 5.700000
v 1.285145 -0.139768 5.700000
v 1.262500 -0.277897 5.700000
v 1.225053 -0.412768 5.700000
v 1.173244 -0.542800 5.700000
v 1.107679 -0.666468 5.700000
v 1.029128 -0.782323 5.700000
v 0.938511 -0.889005 5.700000
v 0.836891 -0.985264 5.700000
v 0.725459 -1.069973 5.700000
v 0.605522 -1.142136 5.700000
v 0.478486 -1.200910 5.700000
v 0.345840 -1.245603 5.700000
v 0.209139 -1.275693 5.700000
v 0.069987 -1.290827 5.700000
v -0.069987 -1.290827 5.700000
v -0.209139 -1.275693 5.700000
v -0.345840 -1.245603 5.700000
v -0.478486 -1.200910 5.700000
v -0.605522 -1.142136 5.700000
v -0.725459 -1.069973 5.700000
v -0.836891 -0.985264 5.700000
v -0.938511 -0.889005 5.700000
v -1.029128 -0.782323 5.700000
v -1.107679 -0.666468 5.700000
v -1.173244 -0.542800 5.700000
v -1.225053 -0.412768 5.700000
v -1.262500 -0.277897 5.700000
v -1.285145 -0.139768 5.700000
v -1.292723 0.000000 5.700000
v -1.285145 0.139768 5.700000
v -1.262500 0.277897 5.700000
v -1.225053 0.412768 5.700000
v -1.173244 0.542800 5.700000
v -1.107679 0.666468 5.700000
v -1.029128 0.782323 5.700000
v -0.938511 0.889005 5.700000
v -0.836891 0.985264 5.700000
v -0.725459 1.069973 5.700000
v -0.605522 1.142136 5.700000
v -0.478486 1.200910 5.700000
v -0.345840 1.245603 5.700000
v -0.209139 1.275693 5.700000
v -0.069987 1.290827 5.700000
v 0.069987 1.290827 5.700000
v 0.209139 1.275693 5.700000
v 0.345840 1.245603 5.700000
v 0.478486 1.200910 5.700000
v 0.605522 1.142136 5.700000
v 0.725459 1.069973 5.700000
v 0.836891 0.985264 5.700000
v 0.938511 0.889005 5.700000
v 1.029128 0.782323 5.700000
v 1.107679 0.666468 5.700000
v 1.173244 0.542800 5.700000
v 1.225053 0.412768 5.700000
v 1.262500 0.277897 5.700000
v 1.285145 0.139768 5.700000
v 3.463185 -0.079677 3.700000
v 1.800595 2.959368 3.700000
v -1.662591 3.039045 3.700000
v -3.463185 0.079677 3.700000
v 1.800595 2.959368 1.700000
v 3.463185 -0.079677 1.700000
v -3.463185 0.079677 1.700000
v -1.662591 3.039045 1.700000
v -1.292723 -0.000000 1.700000
v -1.285145 -0.139768 1.700000
v -1.262500 -0.277897 1.700000
v -1.225053 -0.412768 1.700000
v -1.173244 -0.542800 1.700000
v -1.107679 -0.666468 1.700000
v -1.029128 -0.782323 1.700000
v -0.938511 -0.889005 1.700000
v -0.836891 -0.985264 1.700000
v -0.725459 -1.069973 1.700000
v -0.605522 -1.142136 1.700000
v -0.478486 -1.200910 1.700000
v -0.345840 -1.245603 1.700000
v -0.209139 -1.275693 1.700000
v -0.069987 -1.290827 1.700000
v 0.069987 -1.290827 1.700000
v 0.209139 -1.275693 1.700000
v 0.345840 -1.245603 1.700000
v 0.478486 -1.200910 1.700000
v 0.605522 -1.142136 1.700000
v 0.725459 -1.069973 1.700000
v 0.836891 -0.985264 1.700000
v 0.938511 -0.889005 1.700000
v 1.029128 -0.782323 1.700000
v 1.107679 -0.666468 1.700000
v 1.173244 -0.542800 1.700000
v 1.225053 -0.412768 1.700000
v 1.262500 -0.277897 1.700000
v 1.285145 -0.139768 1.700000
v 1.292723 0.000000 1.700000
v 1.285145 0.139768 1.700000
v 1.262500 0.277897 1.700000
v 1.225053 0.412768 1.700000
v 1.173244 0.542800 1.700000
v 1.107679 0.666468 1.700000
v 1.029128 0.782323 1.700000
v 0.938511 0.889005 1.700000
v 0.836891 0.985264 1.700000
v 0.725459 1.069973 1.700000
v 0.605522 1.142136 1.700000
v 0.478486 1.200910 1.700000
v 0.345840 1.245603 1.700000
v 0.209139 1.275693 1.700000
v 0.069987 1.290827 1.700000
v -0.069987 1.290827 1.700000
v -0.209139 1.275693 1.700000
v -0.345840 1.245603 1.700000
v -0.478486 1.200910 1.700000
v -0.605522 1.142136 1.700000
v -0.725459 1.069973 1.700000
v -0.836891 0.985264 1.700000
v -0.938511 0.889005 1.700000
v -1.029128 0.782323 1.700000
v -1.107679 0.666468 1.700000
v -1.173244 0.542800 1.700000
v -1.225053 0.412768 1.700000
v -1.262500 0.277897 1.700000
v -1.285145 0.139768 1.700000
v -0.200000 -0.000000 0.000000
v -0.193185 0.051764 0.000000
v -0.173205 0.100000 0.000000
v -0.141421 0.141421 0.000000
v -0.100000 0.173205 0.000000
v -0.051764 0.193185 0.000000
v 0.000000 0.200000 0.000000
v 0.051764 0.193185 0.000000
v 0.100000 0.173205 0.000000
v 0.141421 0.141421 0.000000
v 0.173205 0.100000 0.000000
v 0.193185 0.051764 0.000000
v 0.200000 0.000000 0.000000
v 0.193185 -0.051764 0.000000
v 0.173205 -0.100000 0.000000
v 0.141421 -0.141421 0.000000
v 0.100000 -0.173205 0.000000
v 0.051764 -0.193185 0.000000
v 0.000000 -0.200000 0.000000
v -0.051764 -0.193185 0.000000
v -0.100000 -0.173205 0.000000
v -0.141421 -0.141421 0.000000
v -0.173205 -0.100000 0.000000
v -0.193185 -0.051764 0.000000
v 0.000000 0.000000 0.428901
v -0.500000 -0.000000 0.000000
v -0.492808 -0.084500 0.000000
v -0.471439 -0.166570 0.000000
v -0.436507 -0.243847 0.000000
v -0.389018 -0.314110 0.000000
v -0.330337 -0.375336 0.000000
v -0.262154 -0.425765 0.000000
v -0.186428 -0.463945 0.000000
v -0.105340 -0.488778 0.000000
v -0.021221 -0.499549 0.000000
v 0.063509 -0.495950 0.000000
v 0.146411 -0.478083 0.000000
v 0.225102 -0.446463 0.000000
v 0.297317 -0.401999 0.000000
v 0.360978 -0.345969 0.000000
v 0.414255 -0.279987 0.000000
v 0.455614 -0.205951 0.000000
v 0.483866 -0.125989 0.000000
v 0.498199 -0.042403 0.000000
v 0.498199 0.042403 0.000000
v 0.483866 0.125989 0.000000
v 0.455614 0.205951 0.000000
v 0.414255 0.279987 0.000000
v 0.360978 0.345969 0.000000
v 0.297317 0.401999 0.000000
v 0.225102 0.446463 0.000000
v 0.146411 0.478083 0.000000
v 0.063509 0.495950 0.000000
v -0.021221 0.499549 0.000000
v -0.105340 0.488778 0.000000
v -0.186428 0.463945 0.000000
v -0.262154 0.425765 0.000000
v -0.330337 0.375336 0.000000
v -0.389018 0.314110 0.000000
v -0.436507 0.243847 0.000000
v -0.471439 0.166570 0.000000
v -0.492808 0.084500 0.000000
vt -0.006050 0.000000 0.000000
vt -0.004537 0.000000 0.000000
vt -0.006050 0.010000 0.000000
vt -0.004537 0.010000 0.000000
vt -0.003025 0.000000 0.000000
vt -0.003025 0.010000 0.000000
vt -0.001512 0.000000 0.000000
vt -0.001512 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.007508 0.000000 0.000000
vt -0.005631 0.000000 0.000000
vt -0.007508 0.010000 0.000000
vt -0.005631 0.010000 0.000000
vt -0.003754 0.000000 0.000000
vt -0.003754 0.010000 0.000000
vt -0.001877 0.000000 0.000000
vt -0.001877 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.010360 0.000000 0.000000
vt -0.007770 0.000000 0.000000
vt -0.010360 0.010000 0.000000
vt -0.007770 0.010000 0.000000
vt -0.005180 0.000000 0.000000
vt -0.005180 0.010000 0.000000
vt -0.002590 0.000000 0.000000
vt -0.002590 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.007925 -0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.007925 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.026931 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.026931 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.009335 -0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.009335 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.008130 0.000000 0.000000
vt -0.006097 0.000000 0.000000
vt -0.008130 0.010000 0.000000
vt -0.006097 0.010000 0.000000
vt -0.004065 0.000000 0.000000
vt -0.004065 0.010000 0.000000
vt -0.002032 0.000000 0.000000
vt -0.002032 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.006251 0.000000 0.000000
vt -0.004688 0.000000 0.000000
vt -0.006251 0.010000 0.000000
vt -0.004688 0.010000 0.000000
vt -0.003125 0.000000 0.000000
vt -0.003125 0.010000 0.000000
vt -0.001563 0.000000 0.000000
vt -0.001563 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.006789 0.000000 0.000000
vt -0.005091 0.000000 0.000000
vt -0.006789 0.010000 0.000000
vt -0.005091 0.010000 0.000000
vt -0.003394 0.000000 0.000000
vt -0.003394 0.010000 0.000000
vt -0.001697 0.000000 0.000000
vt -0.001697 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.006630 0.000000 0.000000
vt -0.004972 0.000000 0.000000
vt -0.006630 0.010000 0.000000
vt -0.004972 0.010000 0.000000
vt -0.003315 0.000000 0.000000
vt -0.003315 0.010000 0.000000
vt -0.001657 0.000000 0.000000
vt -0.001657 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.006865 0.000000 0.000000
vt -0.005149 0.000000 0.000000
vt -0.006865 0.010000 0.000000
vt -0.005149 0.010000 0.000000
vt -0.003432 0.000000 0.000000
vt -0.003432 0.010000 0.000000
vt -0.001716 0.000000 0.000000
vt -0.001716 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.018718 0.000000 0.000000
vt -0.014039 0.000000 0.000000
vt -0.018718 0.010000 0.000000
vt -0.014039 0.010000 0.000000
vt -0.009359 0.000000 0.000000
vt -0.009359 0.010000 0.000000
vt -0.004680 0.000000 0.000000
vt -0.004680 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.018784 0.000000 0.000000
vt -0.014088 0.000000 0.000000
vt -0.018784 0.010000 0.000000
vt -0.014088 0.010000 0.000000
vt -0.009392 0.000000 0.000000
vt -0.009392 0.010000 0.000000
vt -0.004696 0.000000 0.000000
vt -0.004696 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.013807 0.000000 0.000000
vt -0.010355 0.000000 0.000000
vt -0.013807 0.010000 0.000000
vt -0.010355 0.010000 0.000000
vt -0.006903 0.000000 0.000000
vt -0.006903 0.010000 0.000000
vt -0.003452 0.000000 0.000000
vt -0.003452 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.012491 0.000000 0.000000
vt -0.009368 0.000000 0.000000
vt -0.012491 0.010000 0.000000
vt -0.009368 0.010000 0.000000
vt -0.006245 0.000000 0.000000
vt -0.006245 0.010000 0.000000
vt -0.003123 0.000000 0.000000
vt -0.003123 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.012726 0.000000 0.000000
vt -0.009545 0.000000 0.000000
vt -0.012726 0.010000 0.000000
vt -0.009545 0.010000 0.000000
vt -0.006363 0.000000 0.000000
vt -0.006363 0.010000 0.000000
vt -0.003182 0.000000 0.000000
vt -0.003182 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.015278 0.000000 0.000000
vt -0.011459 0.000000 0.000000
vt -0.015278 0.010000 0.000000
vt -0.011459 0.010000 0.000000
vt -0.007639 0.000000 0.000000
vt -0.007639 0.010000 0.000000
vt -0.003820 0.000000 0.000000
vt -0.003820 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.043251 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.043251 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.100000 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.100000 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.025655 -0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.025655 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.036669 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.036669 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.011948 -0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.011948 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.045659 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.045659 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.031499 -0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.031499 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.054314 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.054314 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt 0.091303 -0.049228 0.000000
vt 0.057925 -0.006380 0.000000
vt 0.059804 -0.049228 0.000000
vt 0.032599 -0.012559 0.000000
vt 0.033759 0.005561 0.000000
vt 0.031169 0.005470 0.000000
vt 0.062079 -0.004081 0.000000
vt 0.036341 0.005765 0.000000
vt 0.038919 0.006044 0.000000
vt 0.040787 0.006428 0.000000
vt 0.042591 0.006973 0.000000
vt 0.044282 0.007797 0.000000
vt 0.045903 0.008798 0.000000
vt 0.047065 0.009796 0.000000
vt 0.048132 0.010875 0.000000
vt 0.049034 0.012093 0.000000
vt 0.065978 -0.001464 0.000000
vt 0.049832 0.013398 0.000000
vt 0.069431 0.001710 0.000000
vt 0.050411 0.015033 0.000000
vt 0.072599 0.005238 0.000000
vt 0.050831 0.016699 0.000000
vt 0.074905 0.009453 0.000000
vt 0.051017 0.018411 0.000000
vt 0.076625 0.013840 0.000000
vt 0.077437 0.018496 0.000000
vt 0.051075 0.020148 0.000000
vt 0.077737 0.023304 0.000000
vt 0.050977 0.021831 0.000000
vt 0.077543 0.026818 0.000000
vt 0.050728 0.023476 0.000000
vt 0.077016 0.030246 0.000000
vt 0.075904 0.033523 0.000000
vt 0.050213 0.025057 0.000000
vt 0.074412 0.036702 0.000000
vt 0.072536 0.039252 0.000000
vt 0.070459 0.041595 0.000000
vt 0.049530 0.026595 0.000000
vt 0.068051 0.043598 0.000000
vt 0.065447 0.045400 0.000000
vt 0.062604 0.046892 0.000000
vt 0.048457 0.027963 0.000000
vt 0.059682 0.048166 0.000000
vt 0.047238 0.029152 0.000000
vt 0.056627 0.049075 0.000000
vt 0.053492 0.049765 0.000000
vt 0.045794 0.030066 0.000000
vt 0.049695 0.050223 0.000000
vt 0.044224 0.030826 0.000000
vt 0.045890 0.050561 0.000000
vt 0.042734 0.031325 0.000000
vt 0.041222 0.031726 0.000000
vt 0.042072 0.050718 0.000000
vt 0.039677 0.031975 0.000000
vt 0.038247 0.050772 0.000000
vt 0.038113 0.032136 0.000000
vt 0.036083 0.032242 0.000000
vt 0.034052 0.032320 0.000000
vt 0.032019 0.032357 0.000000
vt 0.029987 0.032371 0.000000
vt 0.020651 0.032371 0.000000
vt -0.005003 0.050772 0.000000
vt 0.020651 0.005440 0.000000
vt -0.005003 -0.049228 0.000000
vt 0.020651 -0.012559 0.000000
vt 0.020651 -0.049228 0.000000
vt 0.028576 0.005440 0.000000
vt -0.048690 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.048690 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.018402 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.018402 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.022901 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.022901 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.039867 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.039867 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.010053 0.000000 0.000000
vt -0.007540 0.000000 0.000000
vt -0.010053 0.010000 0.000000
vt -0.007540 0.010000 0.000000
vt -0.005026 0.000000 0.000000
vt -0.005026 0.010000 0.000000
vt -0.002513 0.000000 0.000000
vt -0.002513 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.007435 0.000000 0.000000
vt -0.005576 0.000000 0.000000
vt -0.007435 0.010000 0.000000
vt -0.005576 0.010000 0.000000
vt -0.003718 0.000000 0.000000
vt -0.003718 0.010000 0.000000
vt -0.001859 0.000000 0.000000
vt -0.001859 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.007532 0.000000 0.000000
vt -0.005649 0.000000 0.000000
vt -0.007532 0.010000 0.000000
vt -0.005649 0.010000 0.000000
vt -0.003766 0.000000 0.000000
vt -0.003766 0.010000 0.000000
vt -0.001883 0.000000 0.000000
vt -0.001883 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.011010 0.000000 0.000000
vt -0.008258 0.000000 0.000000
vt -0.011010 0.010000 0.000000
vt -0.008258 0.010000 0.000000
vt -0.005505 0.000000 0.000000
vt -0.005505 0.010000 0.000000
vt -0.002753 0.000000 0.000000
vt -0.002753 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.008993 0.000000 0.000000
vt -0.006745 0.000000 0.000000
vt -0.008993 0.010000 0.000000
vt -0.006745 0.010000 0.000000
vt -0.004497 0.000000 0.000000
vt -0.004497 0.010000 0.000000
vt -0.002248 0.000000 0.000000
vt -0.002248 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.007083 0.000000 0.000000
vt -0.005312 0.000000 0.000000
vt -0.007083 0.010000 0.000000
vt -0.005312 0.010000 0.000000
vt -0.003541 0.000000 0.000000
vt -0.003541 0.010000 0.000000
vt -0.001771 0.000000 0.000000
vt -0.001771 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.002418 -0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.002418 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.020221 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.020221 0.010000 0.000000
vt 0.000000 0.010000 0.000000
vt -0.010841 0.000000 0.000000
vt -0.008131 0.000000 0.000000
vt -0.010841 0.010000 0.000000
vt -0.008131 0.010000 0.000000
vt -0.005421 0.000000 0.000000
vt -0.005421 0.010000 0.000000
vt -0.002710 0.000000 0.000000
vt -0.002710 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.013039 0.000000 0.000000
vt -0.009779 0.000000 0.000000
vt -0.013039 0.010000 0.000000
vt -0.009779 0.010000 0.000000
vt -0.006519 0.000000 0.000000
vt -0.006519 0.010000 0.000000
vt -0.003260 0.000000 0.000000
vt -0.003260 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.017283 0.000000 0.000000
vt -0.012962 0.000000 0.000000
vt -0.017283 0.010000 0.000000
vt -0.012962 0.010000 0.000000
vt -0.008641 0.000000 0.000000
vt -0.008641 0.010000 0.000000
vt -0.004321 0.000000 0.000000
vt -0.004321 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.013513 0.000000 0.000000
vt -0.010135 0.000000 0.000000
vt -0.013513 0.010000 0.000000
vt -0.010135 0.010000 0.000000
vt -0.006756 0.000000 0.000000
vt -0.006756 0.010000 0.000000
vt -0.003378 0.000000 0.000000
vt -0.003378 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.011957 0.000000 0.000000
vt -0.008967 0.000000 0.000000
vt -0.011957 0.010000 0.000000
vt -0.008967 0.010000 0.000000
vt -0.005978 0.000000 0.000000
vt -0.005978 0.010000 0.000000
vt -0.002989 0.000000 0.000000
vt -0.002989 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.012546 0.000000 0.000000
vt -0.009409 0.000000 0.000000
vt -0.012546 0.010000 0.000000
vt -0.009409 0.010000 0.000000
vt -0.006273 0.000000 0.000000
vt -0.006273 0.010000 0.000000
vt -0.003136 0.000000 0.000000
vt -0.003136 0.010000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.070651 0.000000 0.000000
vt -0.000000 0.000000 0.000000
vt -0.070651 0.010000 0.000000
vt -0.000000 0.010000 0.000000
vt -0.029248 0.050772 0.000000
vt -0.055037 0.032371 0.000000
vt -0.029248 -0.019879 0.000000
vt -0.055037 -0.007497 0.000000
vt -0.055046 -0.010010 0.000000
vt -0.077938 0.050772 0.000000
vt -0.077938 0.032371 0.000000
vt -0.055076 -0.012523 0.000000
vt -0.055144 -0.015036 0.000000
vt -0.055238 -0.017547 0.000000
vt -0.055433 -0.019413 0.000000
vt -0.034504 -0.037478 0.000000
vt -0.032942 -0.034919 0.000000
vt -0.031598 -0.032203 0.000000
vt -0.055758 -0.021247 0.000000
vt -0.038583 -0.041907 0.000000
vt -0.036433 -0.039772 0.000000
vt -0.056304 -0.023027 0.000000
vt -0.044170 -0.045760 0.000000
vt -0.041314 -0.043946 0.000000
vt -0.047228 -0.047213 0.000000
vt -0.056985 -0.024774 0.000000
vt -0.050403 -0.048455 0.000000
vt -0.058022 -0.026405 0.000000
vt -0.054616 -0.049514 0.000000
vt -0.059235 -0.027857 0.000000
vt -0.060731 -0.029021 0.000000
vt -0.058869 -0.050294 0.000000
vt -0.062391 -0.030018 0.000000
vt -0.063182 -0.050651 0.000000
vt -0.065022 -0.030917 0.000000
vt -0.067701 -0.031558 0.000000
vt -0.067529 -0.050772 0.000000
vt -0.070450 -0.031829 0.000000
vt -0.070789 -0.050738 0.000000
vt -0.073237 -0.031901 0.000000
vt -0.074048 -0.050654 0.000000
vt -0.075496 -0.031851 0.000000
vt -0.077304 -0.050488 0.000000
vt -0.077742 -0.031694 0.000000
vt -0.080557 -0.050270 0.000000
vt -0.079964 -0.031343 0.000000
vt -0.083258 -0.050016 0.000000
vt -0.082169 -0.030860 0.000000
vt -0.083862 -0.030337 0.000000
vt -0.085951 -0.049706 0.000000
vt -0.085547 -0.029793 0.000000
vt -0.088631 -0.049300 0.000000
vt -0.087220 -0.029212 0.000000
vt -0.091303 -0.048831 0.000000
vt -0.088885 -0.028610 0.000000
vt -0.091303 -0.028610 0.000000
vt -0.030593 -0.029202 0.000000
vt -0.029818 -0.026157 0.000000
vt -0.029421 -0.023040 0.000000
vt 0.346410 0.000000 0.000000
vt 0.168202 0.050000 0.000000
vt 0.000000 0.000000 0.000000
vt 0.114336 0.048934 0.000000
vt 0.110023 0.048577 0.000000
vt 0.346410 0.200000 0.000000
vt 0.264508 0.050000 0.000000
vt 0.233009 0.050000 0.000000
vt 0.193857 0.050000 0.000000
vt 0.205805 0.086669 0.000000
vt 0.193857 0.086669 0.000000
vt 0.000000 0.200000 0.000000
vt 0.168202 0.150000 0.000000
vt 0.211452 0.150000 0.000000
vt 0.215277 0.149945 0.000000
vt 0.081902 0.070618 0.000000
vt 0.095267 0.131598 0.000000
vt 0.095267 0.150000 0.000000
vt 0.143957 0.150000 0.000000
vt 0.143957 0.079349 0.000000
vt 0.143784 0.076188 0.000000
vt 0.143388 0.073070 0.000000
vt 0.142612 0.070025 0.000000
vt 0.141607 0.067025 0.000000
vt 0.140263 0.064308 0.000000
vt 0.138701 0.061750 0.000000
vt 0.136772 0.059455 0.000000
vt 0.134622 0.057320 0.000000
vt 0.131891 0.055282 0.000000
vt 0.129035 0.053467 0.000000
vt 0.125977 0.052014 0.000000
vt 0.122802 0.050772 0.000000
vt 0.118589 0.049713 0.000000
vt 0.105677 0.048455 0.000000
vt 0.102416 0.048490 0.000000
vt 0.099157 0.048573 0.000000
vt 0.095901 0.048740 0.000000
vt 0.092648 0.048957 0.000000
vt 0.089947 0.049212 0.000000
vt 0.087254 0.049521 0.000000
vt 0.084574 0.049928 0.000000
vt 0.081902 0.050397 0.000000
vt 0.118168 0.091731 0.000000
vt 0.084320 0.070618 0.000000
vt 0.118159 0.089217 0.000000
vt 0.118129 0.086704 0.000000
vt 0.118061 0.084192 0.000000
vt 0.117967 0.081680 0.000000
vt 0.117772 0.079815 0.000000
vt 0.085985 0.070015 0.000000
vt 0.117447 0.077981 0.000000
vt 0.087658 0.069435 0.000000
vt 0.116902 0.076200 0.000000
vt 0.089344 0.068891 0.000000
vt 0.091036 0.068368 0.000000
vt 0.093241 0.067885 0.000000
vt 0.095463 0.067533 0.000000
vt 0.097709 0.067376 0.000000
vt 0.116221 0.074453 0.000000
vt 0.099968 0.067327 0.000000
vt 0.115183 0.072822 0.000000
vt 0.102755 0.067399 0.000000
vt 0.113970 0.071371 0.000000
vt 0.105504 0.067670 0.000000
vt 0.108183 0.068311 0.000000
vt 0.110814 0.069210 0.000000
vt 0.112474 0.070207 0.000000
vt 0.118168 0.131598 0.000000
vt 0.248110 0.108680 0.000000
vt 0.245804 0.104466 0.000000
vt 0.242636 0.100938 0.000000
vt 0.239184 0.097764 0.000000
vt 0.235285 0.095146 0.000000
vt 0.231130 0.092848 0.000000
vt 0.219095 0.149789 0.000000
vt 0.222900 0.149450 0.000000
vt 0.226697 0.148993 0.000000
vt 0.229832 0.148303 0.000000
vt 0.232887 0.147393 0.000000
vt 0.235809 0.146120 0.000000
vt 0.238652 0.144627 0.000000
vt 0.241256 0.142826 0.000000
vt 0.243664 0.140823 0.000000
vt 0.245741 0.138480 0.000000
vt 0.247617 0.135930 0.000000
vt 0.249109 0.132751 0.000000
vt 0.250221 0.129474 0.000000
vt 0.250748 0.126046 0.000000
vt 0.250942 0.122532 0.000000
vt 0.250643 0.117724 0.000000
vt 0.249830 0.113068 0.000000
vt 0.400000 0.148589 0.000000
vt 0.400000 0.157080 0.000000
vt 0.266667 0.157080 0.000000
vt 0.266667 -0.157080 0.000000
vt 0.400000 -0.157080 0.000000
vt 0.400000 -0.148589 0.000000
vt 0.266667 -0.148353 0.000000
vt 0.400000 -0.140098 0.000000
vt 0.266667 -0.139626 0.000000
vt 0.400000 -0.131607 0.000000
vt 0.266667 -0.130900 0.000000
vt 0.400000 -0.123116 0.000000
vt 0.266667 -0.122173 0.000000
vt 0.400000 -0.114626 0.000000
vt 0.266667 -0.113446 0.000000
vt 0.400000 -0.106135 0.000000
vt 0.266667 -0.104720 0.000000
vt 0.400000 -0.097644 0.000000
vt 0.266667 -0.095993 0.000000
vt 0.400000 -0.089153 0.000000
vt 0.266667 -0.087266 0.000000
vt 0.400000 -0.080663 0.000000
vt 0.266667 -0.078540 0.000000
vt 0.400000 -0.072172 0.000000
vt 0.266667 -0.069813 0.000000
vt 0.400000 -0.063681 0.000000
vt 0.266667 -0.061087 0.000000
vt 0.400000 -0.055190 0.000000
vt 0.266667 -0.052360 0.000000
vt 0.400000 -0.046699 0.000000
vt 0.266667 -0.043633 0.000000
vt 0.400000 -0.038209 0.000000
vt 0.266667 -0.034907 0.000000
vt 0.400000 -0.029718 0.000000
vt 0.266667 -0.026180 0.000000
vt 0.400000 -0.021227 0.000000
vt 0.266667 -0.017453 0.000000
vt 0.400000 -0.012736 0.000000
vt 0.266667 -0.008727 0.000000
vt 0.400000 -0.004245 0.000000
vt 0.266667 0.000000 0.000000
vt 0.400000 0.004245 0.000000
vt 0.266667 0.008727 0.000000
vt 0.400000 0.012736 0.000000
vt 0.266667 0.017453 0.000000
vt 0.400000 0.021227 0.000000
vt 0.266667 0.026180 0.000000
vt 0.400000 0.029718 0.000000
vt 0.266667 0.034907 0.000000
vt 0.400000 0.038209 0.000000
vt 0.266667 0.043633 0.000000
vt 0.400000 0.046699 0.000000
vt 0.266667 0.052360 0.000000
vt 0.400000 0.055190 0.000000
vt 0.266667 0.061087 0.000000
vt 0.400000 0.063681 0.000000
vt 0.266667 0.069813 0.000000
vt 0.400000 0.072172 0.000000
vt 0.266667 0.078540 0.000000
vt 0.400000 0.080663 0.000000
vt 0.266667 0.087266 0.000000
vt 0.400000 0.089153 0.000000
vt 0.266667 0.095993 0.000000
vt 0.400000 0.097644 0.000000
vt 0.266667 0.104720 0.000000
vt 0.400000 0.106135 0.000000
vt 0.266667 0.113446 0.000000
vt 0.400000 0.114626 0.000000
vt 0.266667 0.122173 0.000000
vt 0.400000 0.123116 0.000000
vt 0.266667 0.130900 0.000000
vt 0.400000 0.131607 0.000000
vt 0.266667 0.139626 0.000000
vt 0.400000 0.140098 0.000000
vt 0.266667 0.148353 0.000000
vt 0.000000 -0.148589 0.000000
vt 0.000000 -0.157080 0.000000
vt 0.133333 -0.157080 0.000000
vt 0.133333 0.157080 0.000000
vt 0.000000 0.157080 0.000000
vt 0.000000 0.148589 0.000000
vt 0.133333 0.148353 0.000000
vt 0.000000 0.140098 0.000000
vt 0.133333 0.139626 0.000000
vt 0.000000 0.131607 0.000000
vt 0.133333 0.130900 0.000000
vt 0.000000 0.123116 0.000000
vt 0.133333 0.122173 0.000000
vt 0.000000 0.114626 0.000000
vt 0.133333 0.113446 0.000000
vt 0.000000 0.106135 0.000000
vt 0.133333 0.104720 0.000000
vt 0.000000 0.097644 0.000000
vt 0.133333 0.095993 0.000000
vt 0.000000 0.089153 0.000000
vt 0.133333 0.087266 0.000000
vt 0.000000 0.080663 0.000000
vt 0.133333 0.078540 0.000000
vt 0.000000 0.072172 0.000000
vt 0.133333 0.069813 0.000000
vt 0.000000 0.063681 0.000000
vt 0.133333 0.061087 0.000000
vt 0.000000 0.055190 0.000000
vt 0.133333 0.052360 0.000000
vt 0.000000 0.046699 0.000000
vt 0.133333 0.043633 0.000000
vt 0.000000 0.038209 0.000000
vt 0.133333 0.034907 0.000000
vt 0.000000 0.029718 0.000000
vt 0.133333 0.026180 0.000000
vt 0.000000 0.021227 0.000000
vt 0.133333 0.017453 0.000000
vt 0.000000 0.012736 0.000000
vt 0.133333 0.008727 0.000000
vt 0.000000 0.004245 0.000000
vt 0.133333 0.000000 0.000000
vt 0.000000 -0.004245 0.000000
vt 0.133333 -0.008727 0.000000
vt 0.000000 -0.012736 0.000000
vt 0.133333 -0.017453 0.000000
vt 0.000000 -0.021227 0.000000
vt 0.133333 -0.026180 0.000000
vt 0.000000 -0.029718 0.000000
vt 0.133333 -0.034907 0.000000
vt 0.000000 -0.038209 0.000000
vt 0.133333 -0.043633 0.000000
vt 0.000000 -0.046699 0.000000
vt 0.133333 -0.052360 0.000000
vt 0.000000 -0.055190 0.000000
vt 0.133333 -0.061087 0.000000
vt -0.000000 -0.063681 0.000000
vt 0.133333 -0.069813 0.000000
vt 0.000000 -0.072172 0.000000
vt 0.133333 -0.078540 0.000000
vt 0.000000 -0.080663 0.000000
vt 0.133333 -0.087266 0.000000
vt 0.000000 -0.089153 0.000000
vt 0.133333 -0.095993 0.000000
vt 0.000000 -0.097644 0.000000
vt 0.133333 -0.104720 0.000000
vt 0.000000 -0.106135 0.000000
vt 0.133333 -0.113446 0.000000
vt 0.000000 -0.114626 0.000000
vt 0.133333 -0.122173 0.000000
vt 0.000000 -0.123116 0.000000
vt 0.133333 -0.130900 0.000000
vt 0.000000 -0.131607 0.000000
vt 0.133333 -0.139626 0.000000
vt 0.000000 -0.140098 0.000000
vt 0.133333 -0.148353 0.000000
vt -0.400000 0.392117 0.000000
vt -0.200000 0.392117 0.000000
vt -0.400000 0.406121 0.000000
vt -0.200000 0.406121 0.000000
vt -0.400000 -0.406121 0.000000
vt -0.200000 -0.406121 0.000000
vt -0.400000 -0.392117 0.000000
vt -0.200000 -0.392117 0.000000
vt -0.400000 -0.378113 0.000000
vt -0.200000 -0.378113 0.000000
vt -0.400000 -0.364108 0.000000
vt -0.200000 -0.364108 0.000000
vt -0.400000 -0.350104 0.000000
vt -0.200000 -0.350104 0.000000
vt -0.400000 -0.336100 0.000000
vt -0.200000 -0.336100 0.000000
vt -0.400000 -0.322096 0.000000
vt -0.200000 -0.322096 0.000000
vt -0.400000 -0.308092 0.000000
vt -0.200000 -0.308092 0.000000
vt -0.400000 -0.294088 0.000000
vt -0.200000 -0.294088 0.000000
vt -0.400000 -0.280083 0.000000
vt -0.200000 -0.280083 0.000000
vt -0.400000 -0.266079 0.000000
vt -0.200000 -0.266079 0.000000
vt -0.400000 -0.252075 0.000000
vt -0.200000 -0.252075 0.000000
vt -0.400000 -0.238071 0.000000
vt -0.200000 -0.238071 0.000000
vt -0.400000 -0.224067 0.000000
vt -0.200000 -0.224067 0.000000
vt -0.400000 -0.210063 0.000000
vt -0.200000 -0.210063 0.000000
vt -0.400000 -0.196058 0.000000
vt -0.200000 -0.196058 0.000000
vt -0.400000 -0.182054 0.000000
vt -0.200000 -0.182054 0.000000
vt -0.400000 -0.168050 0.000000
vt -0.200000 -0.168050 0.000000
vt -0.400000 -0.154046 0.000000
vt -0.200000 -0.154046 0.000000
vt -0.400000 -0.140042 0.000000
vt -0.200000 -0.140042 0.000000
vt -0.400000 -0.126038 0.000000
vt -0.200000 -0.126038 0.000000
vt -0.400000 -0.112033 0.000000
vt -0.200000 -0.112033 0.000000
vt -0.400000 -0.098029 0.000000
vt -0.200000 -0.098029 0.000000
vt -0.400000 -0.084025 0.000000
vt -0.200000 -0.084025 0.000000
vt -0.400000 -0.070021 0.000000
vt -0.200000 -0.070021 0.000000
vt -0.400000 -0.056017 0.000000
vt -0.200000 -0.056017 0.000000
vt -0.400000 -0.042013 0.000000
vt -0.200000 -0.042013 0.000000
vt -0.400000 -0.028008 0.000000
vt -0.200000 -0.028008 0.000000
vt -0.400000 -0.014004 0.000000
vt -0.200000 -0.014004 0.000000
vt -0.400000 0.000000 0.000000
vt -0.200000 0.000000 0.000000
vt -0.400000 0.014004 0.000000
vt -0.200000 0.014004 0.000000
vt -0.400000 0.028008 0.000000
vt -0.200000 0.028008 0.000000
vt -0.400000 0.042013 0.000000
vt -0.200000 0.042013 0.000000
vt -0.400000 0.056017 0.000000
vt -0.200000 0.056017 0.000000
vt -0.400000 0.070021 0.000000
vt -0.200000 0.070021 0.000000
vt -0.400000 0.084025 0.000000
vt -0.200000 0.084025 0.000000
vt -0.400000 0.098029 0.000000
vt -0.200000 0.098029 0.000000
vt -0.400000 0.112033 0.000000
vt -0.200000 0.112033 0.000000
vt -0.400000 0.126038 0.000000
vt -0.200000 0.126038 0.000000
vt -0.400000 0.140042 0.000000
vt -0.200000 0.140042 0.000000
vt -0.400000 0.154046 0.000000
vt -0.200000 0.154046 0.000000
vt -0.400000 0.168050 0.000000
vt -0.200000 0.168050 0.000000
vt -0.400000 0.182054 0.000000
vt -0.200000 0.182054 0.000000
vt -0.400000 0.196058 0.000000
vt -0.200000 0.196058 0.000000
vt -0.400000 0.210063 0.000000
vt -0.200000 0.210063 0.000000
vt -0.400000 0.224067 0.000000
vt -0.200000 0.224067 0.000000
vt -0.400000 0.238071 0.000000
vt -0.200000 0.238071 0.000000
vt -0.400000 0.252075 0.000000
vt -0.200000 0.252075 0.000000
vt -0.400000 0.266079 0.000000
vt -0.200000 0.266079 0.000000
vt -0.400000 0.280083 0.000000
vt -0.200000 0.280083 0.000000
vt -0.400000 0.294088 0.000000
vt -0.200000 0.294088 0.000000
vt -0.400000 0.308092 0.000000
vt -0.200000 0.308092 0.000000
vt -0.400000 0.322096 0.000000
vt -0.200000 0.322096 0.000000
vt -0.400000 0.336100 0.000000
vt -0.200000 0.336100 0.000000
vt -0.400000 0.350104 0.000000
vt -0.200000 0.350104 0.000000
vt -0.400000 0.364108 0.000000
vt -0.200000 0.364108 0.000000
vt -0.400000 0.378113 0.000000
vt -0.200000 0.378113 0.000000
vt -0.000000 -0.392117 0.000000
vt -0.000000 -0.406121 0.000000
vt -0.000000 0.406121 0.000000
vt -0.000000 0.392117 0.000000
vt -0.000000 0.378113 0.000000
vt -0.000000 0.364108 0.000000
vt -0.000000 0.350104 0.000000
vt -0.000000 0.336100 0.000000
vt -0.000000 0.322096 0.000000
vt -0.000000 0.308092 0.000000
vt -0.000000 0.294088 0.000000
vt -0.000000 0.280083 0.000000
vt -0.000000 0.266079 0.000000
vt -0.000000 0.252075 0.000000
vt -0.000000 0.238071 0.000000
vt -0.000000 0.224067 0.000000
vt -0.000000 0.210063 0.000000
vt -0.000000 0.196058 0.000000
vt -0.000000 0.182054 0.000000
vt -0.000000 0.168050 0.000000
vt -0.000000 0.154046 0.000000
vt -0.000000 0.140042 0.000000
vt -0.000000 0.126038 0.000000
vt -0.000000 0.112033 0.000000
vt -0.000000 0.098029 0.000000
vt -0.000000 0.084025 0.000000
vt -0.000000 0.070021 0.000000
vt -0.000000 0.056017 0.000000
vt -0.000000 0.042013 0.000000
vt -0.000000 0.028008 0.000000
vt -0.000000 0.014004 0.000000
vt -0.000000 0.000000 0.000000
vt -0.000000 -0.014004 0.000000
vt -0.000000 -0.028008 0.000000
vt -0.000000 -0.042013 0.000000
vt -0.000000 -0.056017 0.000000
vt -0.000000 -0.070021 0.000000
vt -0.000000 -0.084025 0.000000
vt -0.000000 -0.098029 0.000000
vt -0.000000 -0.112033 0.000000
vt -0.000000 -0.126038 0.000000
vt -0.000000 -0.140042 0.000000
vt -0.000000 -0.154046 0.000000
vt -0.000000 -0.168050 0.000000
vt -0.000000 -0.182054 0.000000
vt -0.000000 -0.196058 0.000000
vt -0.000000 -0.210063 0.000000
vt -0.000000 -0.224067 0.000000
vt -0.000000 -0.238071 0.000000
vt -0.000000 -0.252075 0.000000
vt -0.000000 -0.266079 0.000000
vt -0.000000 -0.280083 0.000000
vt -0.000000 -0.294088 0.000000
vt -0.000000 -0.308092 0.000000
vt -0.000000 -0.322096 0.000000
vt -0.000000 -0.336100 0.000000
vt -0.000000 -0.350104 0.000000
vt -0.000000 -0.364108 0.000000
vt -0.000000 -0.378113 0.000000
vt -0.049281 0.008450 0.000000
vt -0.128515 0.013977 0.000000
vt -0.050000 -0.000000 0.000000
vt -0.129272 -0.000000 0.000000
vt -0.128515 -0.013977 0.000000
vt -0.126250 0.027790 0.000000
vt -0.047144 0.016657 0.000000
vt -0.122505 0.041277 0.000000
vt -0.117324 0.054280 0.000000
vt -0.043651 0.024385 0.000000
vt -0.110768 0.066647 0.000000
vt -0.038902 0.031411 0.000000
vt -0.102913 0.078232 0.000000
vt -0.093851 0.088900 0.000000
vt -0.033034 0.037534 0.000000
vt -0.083689 0.098526 0.000000
vt -0.072546 0.106997 0.000000
vt -0.026215 0.042576 0.000000
vt -0.060552 0.114214 0.000000
vt -0.018643 0.046394 0.000000
vt -0.047849 0.120091 0.000000
vt -0.034584 0.124560 0.000000
vt -0.010534 0.048878 0.000000
vt -0.020914 0.127569 0.000000
vt -0.002122 0.049955 0.000000
vt -0.006999 0.129083 0.000000
vt 0.006999 0.129083 0.000000
vt 0.006351 0.049595 0.000000
vt 0.020914 0.127569 0.000000
vt 0.014641 0.047808 0.000000
vt 0.034584 0.124560 0.000000
vt 0.047849 0.120091 0.000000
vt 0.022510 0.044646 0.000000
vt 0.060552 0.114214 0.000000
vt 0.072546 0.106997 0.000000
vt 0.029732 0.040200 0.000000
vt 0.083689 0.098526 0.000000
vt 0.036098 0.034597 0.000000
vt 0.093851 0.088900 0.000000
vt 0.102913 0.078232 0.000000
vt 0.041425 0.027999 0.000000
vt 0.110768 0.066647 0.000000
vt 0.045561 0.020595 0.000000
vt 0.117324 0.054280 0.000000
vt 0.122505 0.041277 0.000000
vt 0.048387 0.012599 0.000000
vt 0.126250 0.027790 0.000000
vt 0.049820 0.004240 0.000000
vt 0.128515 0.013977 0.000000
vt 0.129272 0.000000 0.000000
vt 0.049820 -0.004240 0.000000
vt 0.128515 -0.013977 0.000000
vt 0.126250 -0.027790 0.000000
vt 0.048387 -0.012599 0.000000
vt 0.122505 -0.041277 0.000000
vt 0.045561 -0.020595 0.000000
vt 0.117324 -0.054280 0.000000
vt 0.110768 -0.066647 0.000000
vt 0.041425 -0.027999 0.000000
vt 0.102913 -0.078232 0.000000
vt 0.036098 -0.034597 0.000000
vt 0.093851 -0.088900 0.000000
vt 0.083689 -0.098526 0.000000
vt 0.029732 -0.040200 0.000000
vt 0.072546 -0.106997 0.000000
vt 0.022510 -0.044646 0.000000
vt 0.060552 -0.114214 0.000000
vt 0.047849 -0.120091 0.000000
vt 0.014641 -0.047808 0.000000
vt 0.034584 -0.124560 0.000000
vt 0.020914 -0.127569 0.000000
vt 0.006351 -0.049595 0.000000
vt 0.006999 -0.129083 0.000000
vt -0.002122 -0.049955 0.000000
vt -0.006999 -0.129083 0.000000
vt -0.020914 -0.127569 0.000000
vt -0.010534 -0.048878 0.000000
vt -0.034584 -0.124560 0.000000
vt -0.018643 -0.046394 0.000000
vt -0.047849 -0.120091 0.000000
vt -0.060552 -0.114214 0.000000
vt -0.026215 -0.042576 0.000000
vt -0.072546 -0.106997 0.000000
vt -0.033034 -0.037534 0.000000
vt -0.083689 -0.098526 0.000000
vt -0.093851 -0.088900 0.000000
vt -0.038902 -0.031411 0.000000
vt -0.102913 -0.078232 0.000000
vt -0.110768 -0.066647 0.000000
vt -0.043651 -0.024385 0.000000
vt -0.117324 -0.054280 0.000000
vt -0.047144 -0.016657 0.000000
vt -0.122505 -0.041277 0.000000
vt -0.126250 -0.027790 0.000000
vt -0.049281 -0.008450 0.000000
vt 0.180059 0.295937 0.000000
vt 0.110768 0.066647 0.000000
vt 0.346319 -0.007968 0.000000
vt 0.117324 0.054280 0.000000
vt 0.122505 0.041277 0.000000
vt -0.166259 0.303904 0.000000
vt 0.006999 0.129083 0.000000
vt 0.020914 0.127569 0.000000
vt 0.034584 0.124560 0.000000
vt -0.346319 0.007968 0.000000
vt -0.102913 0.078232 0.000000
vt -0.093851 0.088900 0.000000
vt -0.083689 0.098526 0.000000
vt -0.180059 -0.295937 0.000000
vt -0.110768 -0.066647 0.000000
vt -0.117324 -0.054280 0.000000
vt -0.122505 -0.041277 0.000000
vt 0.166259 -0.303904 0.000000
vt -0.006999 -0.129083 0.000000
vt -0.020914 -0.127569 0.000000
vt -0.034584 -0.124560 0.000000
vt 0.102913 -0.078232 0.000000
vt 0.093851 -0.088900 0.000000
vt 0.083689 -0.098526 0.000000
vt 0.128515 0.013977 0.000000
vt 0.129272 0.000000 0.000000
vt 0.128515 -0.013977 0.000000
vt 0.126250 -0.027790 0.000000
vt 0.122505 -0.041277 0.000000
vt 0.117324 -0.054280 0.000000
vt 0.110768 -0.066647 0.000000
vt 0.072546 -0.106997 0.000000
vt 0.060552 -0.114214 0.000000
vt 0.047849 -0.120091 0.000000
vt 0.034584 -0.124560 0.000000
vt 0.020914 -0.127569 0.000000
vt 0.006999 -0.129083 0.000000
vt -0.047849 -0.120091 0.000000
vt -0.060552 -0.114214 0.000000
vt -0.072546 -0.106997 0.000000
vt -0.083689 -0.098526 0.000000
vt -0.093851 -0.088900 0.000000
vt -0.102913 -0.078232 0.000000
vt -0.126250 -0.027790 0.000000
vt -0.128515 -0.013977 0.000000
vt -0.129272 0.000000 0.000000
vt -0.128515 0.013977 0.000000
vt -0.126250 0.027790 0.000000
vt -0.122505 0.041277 0.000000
vt -0.117324 0.054280 0.000000
vt -0.110768 0.066647 0.000000
vt -0.072546 0.106997 0.000000
vt -0.060552 0.114214 0.000000
vt -0.047849 0.120091 0.000000
vt -0.034584 0.124560 0.000000
vt -0.020914 0.127569 0.000000
vt -0.006999 0.129083 0.000000
vt 0.047849 0.120091 0.000000
vt 0.060552 0.114214 0.000000
vt 0.072546 0.106997 0.000000
vt 0.083689 0.098526 0.000000
vt 0.093851 0.088900 0.000000
vt 0.102913 0.078232 0.000000
vt 0.126250 0.027790 0.000000
vt 0.346319 0.007968 0.000000
vt 0.110768 -0.066647 0.000000
vt 0.180059 -0.295937 0.000000
vt 0.102913 -0.078232 0.000000
vt 0.093851 -0.088900 0.000000
vt 0.166259 0.303904 0.000000
vt 0.102913 0.078232 0.000000
vt 0.110768 0.066647 0.000000
vt 0.117324 0.054280 0.000000
vt -0.180059 0.295937 0.000000
vt -0.006999 0.129083 0.000000
vt 0.006999 0.129083 0.000000
vt 0.020914 0.127569 0.000000
vt -0.346319 -0.007968 0.000000
vt -0.110768 0.066647 0.000000
vt -0.102913 0.078232 0.000000
vt -0.093851 0.088900 0.000000
vt -0.166259 -0.303904 0.000000
vt -0.102913 -0.078232 0.000000
vt -0.110768 -0.066647 0.000000
vt -0.117324 -0.054280 0.000000
vt 0.006999 -0.129083 0.000000
vt -0.006999 -0.129083 0.000000
vt -0.020914 -0.127569 0.000000
vt -0.128515 -0.013977 0.000000
vt -0.129272 -0.000000 0.000000
vt -0.128515 0.013977 0.000000
vt -0.126250 0.027790 0.000000
vt -0.122505 0.041277 0.000000
vt -0.117324 0.054280 0.000000
vt -0.083689 0.098526 0.000000
vt -0.072546 0.106997 0.000000
vt -0.060552 0.114214 0.000000
vt -0.047849 0.120091 0.000000
vt -0.034584 0.124560 0.000000
vt -0.020914 0.127569 0.000000
vt 0.034584 0.124560 0.000000
vt 0.047849 0.120091 0.000000
vt 0.060552 0.114214 0.000000
vt 0.072546 0.106997 0.000000
vt 0.083689 0.098526 0.000000
vt 0.093851 0.088900 0.000000
vt 0.122505 0.041277 0.000000
vt 0.126250 0.027790 0.000000
vt 0.128515 0.013977 0.000000
vt 0.129272 -0.000000 0.000000
vt 0.128515 -0.013977 0.000000
vt 0.126250 -0.027790 0.000000
vt 0.122505 -0.041277 0.000000
vt 0.117324 -0.054280 0.000000
vt 0.083689 -0.098526 0.000000
vt 0.072546 -0.106997 0.000000
vt 0.060552 -0.114214 0.000000
vt 0.047849 -0.120091 0.000000
vt 0.034584 -0.124560 0.000000
vt 0.020914 -0.127569 0.000000
vt -0.034584 -0.124560 0.000000
vt -0.047849 -0.120091 0.000000
vt -0.060552 -0.114214 0.000000
vt -0.072546 -0.106997 0.000000
vt -0.083689 -0.098526 0.000000
vt -0.093851 -0.088900 0.000000
vt -0.122505 -0.041277 0.000000
vt -0.126250 -0.027790 0.000000
vt 0.000000 0.000000 0.000000
vt 0.346410 0.000000 0.000000
vt 0.000000 0.200000 0.000000
vt 0.346410 0.200000 0.000000
vt 0.217487 0.107025 0.000000
vt 0.219108 0.108026 0.000000
vt 0.209288 0.131469 0.000000
vt 0.220270 0.109024 0.000000
vt 0.221337 0.110103 0.000000
vt 0.222239 0.111320 0.000000
vt 0.223616 0.114261 0.000000
vt 0.224037 0.115926 0.000000
vt 0.223037 0.112626 0.000000
vt 0.224223 0.117638 0.000000
vt 0.211318 0.131363 0.000000
vt 0.224280 0.119375 0.000000
vt 0.212882 0.131202 0.000000
vt 0.224183 0.121059 0.000000
vt 0.214427 0.130954 0.000000
vt 0.215939 0.130553 0.000000
vt 0.223933 0.122704 0.000000
vt 0.217429 0.130054 0.000000
vt 0.223418 0.124284 0.000000
vt 0.219000 0.129294 0.000000
vt 0.221662 0.127191 0.000000
vt 0.220443 0.128380 0.000000
vt 0.222735 0.125823 0.000000
vt 0.207257 0.131548 0.000000
vt 0.209546 0.104993 0.000000
vt 0.212124 0.105272 0.000000
vt 0.213992 0.105656 0.000000
vt 0.206964 0.104789 0.000000
vt 0.205225 0.131585 0.000000
vt 0.204374 0.104697 0.000000
vt 0.203192 0.131598 0.000000
vt 0.201781 0.104668 0.000000
vt 0.193857 0.131598 0.000000
vt 0.193857 0.104668 0.000000
vt 0.215796 0.106201 0.000000
vt 0.000000 0.000000 0.000000
vt 0.346410 0.000000 0.000000
vt 0.000000 0.200000 0.000000
vt 0.346410 0.200000 0.000000
vt 0.000000 0.000000 0.000000
vt 0.346410 0.000000 0.000000
vt 0.000000 0.200000 0.000000
vt 0.346410 0.200000 0.000000
vt 0.000000 0.000000 0.000000
vt 0.346410 0.000000 0.000000
vt 0.000000 0.200000 0.000000
vt 0.346410 0.200000 0.000000
vt 0.000000 0.000000 0.000000
vt 0.346410 0.000000 0.000000
vt 0.000000 0.200000 0.000000
vt 0.346410 0.200000 0.000000
vt 0.049281 -0.008450 0.000000
vt 0.050000 0.000000 0.000000
vt -0.041425 -0.027999 0.000000
vt 0.049281 0.008450 0.000000
vt 0.047144 0.016657 0.000000
vt 0.043651 0.024385 0.000000
vt 0.038902 0.031411 0.000000
vt 0.033034 0.037534 0.000000
vt 0.026215 0.042576 0.000000
vt 0.018643 0.046394 0.000000
vt 0.010534 0.048878 0.000000
vt 0.002122 0.049955 0.000000
vt -0.006351 0.049595 0.000000
vt -0.014641 0.047808 0.000000
vt -0.022510 0.044646 0.000000
vt -0.029732 0.040200 0.000000
vt -0.036098 0.034597 0.000000
vt -0.041425 0.027999 0.000000
vt -0.045561 -0.020595 0.000000
vt -0.045561 0.020595 0.000000
vt -0.048387 -0.012599 0.000000
vt -0.048387 0.012599 0.000000
vt -0.049820 -0.004240 0.000000
vt -0.049820 0.004240 0.000000
vt -0.036098 -0.034597 0.000000
vt 0.038902 -0.031411 0.000000
vt 0.043651 -0.024385 0.000000
vt 0.047144 -0.016657 0.000000
vt 0.033034 -0.037534 0.000000
vt -0.029732 -0.040200 0.000000
vt 0.026215 -0.042576 0.000000
vt -0.022510 -0.044646 0.000000
vt 0.018643 -0.046394 0.000000
vt -0.014641 -0.047808 0.000000
vt 0.010534 -0.048878 0.000000
vt -0.006351 -0.049595 0.000000
vt 0.002122 -0.049955 0.000000
vt 0.000000 0.028798 0.000000
vt 0.047324 0.028798 0.000000
vt 0.000000 0.031416 0.000000
vt 0.000000 0.023562 0.000000
vt 0.047324 0.023562 0.000000
vt 0.000000 0.026180 0.000000
vt 0.000000 0.018326 0.000000
vt 0.047324 0.018326 0.000000
vt 0.000000 0.020944 0.000000
vt 0.000000 0.013090 0.000000
vt 0.047324 0.013090 0.000000
vt 0.000000 0.015708 0.000000
vt 0.000000 0.007854 0.000000
vt 0.047324 0.007854 0.000000
vt 0.000000 0.010472 0.000000
vt 0.000000 0.002618 0.000000
vt 0.047324 0.002618 0.000000
vt 0.000000 0.005236 0.000000
vt 0.000000 -0.002618 0.000000
vt 0.047324 -0.002618 0.000000
vt 0.000000 0.000000 0.000000
vt 0.000000 -0.007854 0.000000
vt 0.047324 -0.007854 0.000000
vt 0.000000 -0.005236 0.000000
vt 0.000000 -0.013090 0.000000
vt 0.047324 -0.013090 0.000000
vt 0.000000 -0.010472 0.000000
vt -0.000000 -0.018326 0.000000
vt 0.047324 -0.018326 0.000000
vt 0.000000 -0.015708 0.000000
vt 0.000000 -0.023562 0.000000
vt 0.047324 -0.023562 0.000000
vt -0.000000 -0.020944 0.000000
vt 0.000000 -0.028798 0.000000
vt 0.047324 -0.028798 0.000000
vt 0.000000 -0.026180 0.000000
vt 0.000000 -0.031416 0.000000
vt 0.047324 -0.031416 0.000000
vt 0.047324 -0.010472 0.000000
vt 0.047324 0.010472 0.000000
vt 0.047324 -0.026180 0.000000
vt 0.047324 -0.020944 0.000000
vt 0.047324 -0.015708 0.000000
vt 0.047324 -0.005236 0.000000
vt 0.047324 0.000000 0.000000
vt 0.047324 0.005236 0.000000
vt 0.047324 0.015708 0.000000
vt 0.047324 0.020944 0.000000
vt 0.047324 0.026180 0.000000
vt -0.187574 -0.271890 0.000000
vt -0.187574 -0.281600 0.000000
vt -0.000000 -0.281600 0.000000
vt -0.000000 0.281600 0.000000
vt -0.187574 0.281600 0.000000
vt -0.187574 0.271890 0.000000
vt -0.000000 0.266379 0.000000
vt -0.187574 0.262180 0.000000
vt -0.000000 0.251157 0.000000
vt -0.187574 0.252469 0.000000
vt -0.187574 0.242759 0.000000
vt -0.000000 0.235935 0.000000
vt -0.187574 0.233049 0.000000
vt -0.000000 0.220714 0.000000
vt -0.187574 0.223338 0.000000
vt -0.187574 0.213628 0.000000
vt -0.000000 0.205492 0.000000
vt -0.187574 0.203917 0.000000
vt -0.187574 0.194207 0.000000
vt -0.000000 0.190270 0.000000
vt -0.187574 0.184497 0.000000
vt -0.000000 0.175049 0.000000
vt -0.187574 0.174786 0.000000
vt -0.187574 0.165076 0.000000
vt -0.000000 0.159827 0.000000
vt -0.187574 0.155366 0.000000
vt 0.000000 0.144606 0.000000
vt -0.187574 0.145655 0.000000
vt -0.187574 0.135945 0.000000
vt -0.000000 0.129384 0.000000
vt -0.187574 0.126235 0.000000
vt -0.000000 0.114162 0.000000
vt -0.187574 0.116524 0.000000
vt -0.187574 0.106814 0.000000
vt -0.000000 0.098941 0.000000
vt -0.187574 0.097104 0.000000
vt -0.187574 0.087393 0.000000
vt -0.000000 0.083719 0.000000
vt -0.187574 0.077683 0.000000
vt -0.000000 0.068497 0.000000
vt -0.187574 0.067972 0.000000
vt -0.187574 0.058262 0.000000
vt -0.000000 0.053276 0.000000
vt -0.187574 0.048552 0.000000
vt -0.000000 0.038054 0.000000
vt -0.187574 0.038841 0.000000
vt -0.187574 0.029131 0.000000
vt -0.000000 0.022832 0.000000
vt -0.187574 0.019421 0.000000
vt -0.000000 0.007611 0.000000
vt -0.187574 0.009710 0.000000
vt -0.187574 0.000000 0.000000
vt -0.000000 -0.007611 0.000000
vt -0.187574 -0.009710 0.000000
vt -0.187574 -0.019421 0.000000
vt -0.000000 -0.022832 0.000000
vt -0.187574 -0.029131 0.000000
vt -0.000000 -0.038054 0.000000
vt -0.187574 -0.038841 0.000000
vt -0.187574 -0.048552 0.000000
vt -0.000000 -0.053276 0.000000
vt -0.187574 -0.058262 0.000000
vt -0.000000 -0.068497 0.000000
vt -0.187574 -0.067972 0.000000
vt -0.187574 -0.077683 0.000000
vt -0.000000 -0.083719 0.000000
vt -0.187574 -0.087393 0.000000
vt -0.000000 -0.098941 0.000000
vt -0.187574 -0.097104 0.000000
vt -0.187574 -0.106814 0.000000
vt -0.000000 -0.114162 0.000000
vt -0.187574 -0.116524 0.000000
vt -0.187574 -0.126235 0.000000
vt -0.000000 -0.129384 0.000000
vt -0.187574 -0.135945 0.000000
vt 0.000000 -0.144606 0.000000
vt -0.187574 -0.145655 0.000000
vt -0.187574 -0.155366 0.000000
vt -0.000000 -0.159827 0.000000
vt -0.187574 -0.165076 0.000000
vt -0.000000 -0.175049 0.000000
vt -0.187574 -0.174786 0.000000
vt -0.187574 -0.184497 0.000000
vt -0.000000 -0.190270 0.000000
vt -0.187574 -0.194207 0.000000
vt -0.000000 -0.205492 0.000000
vt -0.187574 -0.203917 0.000000
vt -0.187574 -0.213628 0.000000
vt -0.000000 -0.220714 0.000000
vt -0.187574 -0.223338 0.000000
vt -0.187574 -0.233049 0.000000
vt -0.000000 -0.235935 0.000000
vt -0.187574 -0.242759 0.000000
vt -0.000000 -0.251157 0.000000
vt -0.187574 -0.252469 0.000000
vt -0.187574 -0.262180 0.000000
vt -0.000000 -0.266379 0.000000
vt 0.019319 -0.005176 0.000000
vt 0.049281 -0.008450 0.000000
vt 0.020000 -0.000000 0.000000
vt 0.050000 -0.000000 0.000000
vt 0.049281 0.008450 0.000000
vt 0.047144 -0.016657 0.000000
vt 0.017321 -0.010000 0.000000
vt 0.043651 -0.024385 0.000000
vt 0.038902 -0.031411 0.000000
vt 0.014142 -0.014142 0.000000
vt 0.033034 -0.037534 0.000000
vt 0.010000 -0.017321 0.000000
vt 0.026215 -0.042576 0.000000
vt 0.018643 -0.046394 0.000000
vt 0.005176 -0.019319 0.000000
vt 0.010534 -0.048878 0.000000
vt -0.000000 -0.020000 0.000000
vt 0.002122 -0.049955 0.000000
vt -0.006351 -0.049595 0.000000
vt -0.005176 -0.019319 0.000000
vt -0.014641 -0.047808 0.000000
vt -0.022510 -0.044646 0.000000
vt -0.010000 -0.017321 0.000000
vt -0.029732 -0.040200 0.000000
vt -0.014142 -0.014142 0.000000
vt -0.036098 -0.034597 0.000000
vt -0.041425 -0.027999 0.000000
vt -0.017321 -0.010000 0.000000
vt -0.045561 -0.020595 0.000000
vt -0.019319 -0.005176 0.000000
vt -0.048387 -0.012599 0.000000
vt -0.049820 -0.004240 0.000000
vt -0.020000 0.000000 0.000000
vt -0.049820 0.004240 0.000000
vt -0.019319 0.005176 0.000000
vt -0.048387 0.012599 0.000000
vt -0.045561 0.020595 0.000000
vt -0.017321 0.010000 0.000000
vt -0.041425 0.027999 0.000000
vt -0.014142 0.014142 0.000000
vt -0.036098 0.034597 0.000000
vt -0.029732 0.040200 0.000000
vt -0.010000 0.017321 0.000000
vt -0.022510 0.044646 0.000000
vt -0.005176 0.019319 0.000000
vt -0.014641 0.047808 0.000000
vt -0.006351 0.049595 0.000000
vt -0.000000 0.020000 0.000000
vt 0.002122 0.049955 0.000000
vt 0.010534 0.048878 0.000000
vt 0.005176 0.019319 0.000000
vt 0.018643 0.046394 0.000000
vt 0.010000 0.017321 0.000000
vt 0.026215 0.042576 0.000000
vt 0.033034 0.037534 0.000000
vt 0.014142 0.014142 0.000000
vt 0.038902 0.031411 0.000000
vt 0.017321 0.010000 0.000000
vt 0.043651 0.024385 0.000000
vt 0.047144 0.016657 0.000000
vt 0.019319 0.005176 0.000000
vn 0.086061 -0.001980 -0.050888
vn 0.083729 -0.001926 -0.054642
vn 0.086061 -0.001980 -0.050888
vn 0.083729 -0.001926 -0.054642
vn 0.075681 -0.001741 -0.065341
vn 0.075681 -0.001741 -0.065341
vn 0.067174 -0.001545 -0.074062
vn 0.067174 -0.001545 -0.074062
vn 0.064164 -0.001476 -0.076687
vn 0.064164 -0.001476 -0.076687
vn 0.053891 -0.001240 -0.084227
vn 0.049685 -0.001143 -0.086776
vn 0.053891 -0.001240 -0.084227
vn 0.049685 -0.001143 -0.086776
vn 0.036164 -0.000832 -0.093228
vn 0.036164 -0.000832 -0.093228
vn 0.023042 -0.000530 -0.097308
vn 0.023042 -0.000530 -0.097308
vn 0.018655 -0.000429 -0.098244
vn 0.018655 -0.000429 -0.098244
vn 0.011240 -0.000259 -0.099366
vn 0.009796 -0.000225 -0.099519
vn 0.011240 -0.000259 -0.099366
vn 0.009796 -0.000225 -0.099519
vn 0.005542 -0.000128 -0.099846
vn 0.005542 -0.000128 -0.099846
vn 0.001942 -0.000045 -0.099981
vn 0.001942 -0.000045 -0.099981
vn 0.000743 -0.000017 -0.099997
vn 0.000743 -0.000017 -0.099997
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000466 -0.000011 0.099999
vn 0.001046 -0.000024 0.099995
vn 0.000466 -0.000011 0.099999
vn 0.001046 -0.000024 0.099995
vn 0.002786 -0.000064 0.099961
vn 0.002786 -0.000064 0.099961
vn 0.004763 -0.000110 0.099886
vn 0.004763 -0.000110 0.099886
vn 0.005429 -0.000125 0.099852
vn 0.005429 -0.000125 0.099852
vn 0.009292 -0.000214 0.099567
vn 0.012107 -0.000279 0.099264
vn 0.009292 -0.000214 0.099567
vn 0.012107 -0.000279 0.099264
vn 0.020556 -0.000473 0.097863
vn 0.020556 -0.000473 0.097863
vn 0.029728 -0.000684 0.095476
vn 0.029728 -0.000684 0.095476
vn 0.032728 -0.000753 0.094490
vn 0.032728 -0.000753 0.094490
vn 0.041872 -0.000963 0.090806
vn 0.046881 -0.001079 0.088323
vn 0.041872 -0.000963 0.090806
vn 0.046881 -0.001079 0.088323
vn 0.061464 -0.001414 0.078868
vn 0.061464 -0.001414 0.078868
vn 0.075900 -0.001746 0.065086
vn 0.075900 -0.001746 0.065086
vn 0.079979 -0.001840 0.060000
vn 0.079979 -0.001840 0.060000
vn 0.090669 -0.002086 0.042128
vn 0.092694 -0.002133 0.037461
vn 0.090669 -0.002086 0.042128
vn 0.092694 -0.002133 0.037461
vn 0.097366 -0.002240 0.022692
vn 0.097366 -0.002240 0.022692
vn 0.099584 -0.002291 0.008814
vn 0.099584 -0.002291 0.008814
vn 0.099884 -0.002298 0.004241
vn 0.099884 -0.002298 0.004241
vn 0.099953 -0.002300 -0.002042
vn 0.099807 -0.002296 -0.005778
vn 0.099953 -0.002300 -0.002042
vn 0.099807 -0.002296 -0.005778
vn 0.098500 -0.002266 -0.017104
vn 0.098500 -0.002266 -0.017104
vn 0.095225 -0.002191 -0.030455
vn 0.095225 -0.002191 -0.030455
vn 0.093711 -0.002156 -0.034838
vn 0.093711 -0.002156 -0.034838
vn -0.047162 0.001085 0.088174
vn -0.050864 0.001170 0.086090
vn -0.047162 0.001085 0.088174
vn -0.050864 0.001170 0.086090
vn -0.061592 0.001417 0.078768
vn -0.061592 0.001417 0.078768
vn -0.072233 0.001662 0.069135
vn -0.072233 0.001662 0.069135
vn -0.075421 0.001735 0.065640
vn -0.075421 0.001735 0.065640
vn -0.086698 0.001995 0.049794
vn -0.089635 0.002062 0.044287
vn -0.086698 0.001995 0.049794
vn -0.089635 0.002062 0.044287
vn -0.096421 0.002218 0.026422
vn -0.096421 0.002218 0.026422
vn -0.099488 0.002289 0.009841
vn -0.099488 0.002289 0.009841
vn -0.099876 0.002298 0.004416
vn -0.099876 0.002298 0.004416
vn -0.099896 0.002298 -0.003929
vn -0.099593 0.002291 -0.008713
vn -0.099896 0.002298 -0.003929
vn -0.099593 0.002291 -0.008713
vn -0.097230 0.002237 -0.023268
vn -0.097230 0.002237 -0.023268
vn -0.092010 0.002117 -0.039112
vn -0.092010 0.002117 -0.039112
vn -0.089726 0.002064 -0.044102
vn -0.089726 0.002064 -0.044102
vn -0.081389 0.001872 -0.058072
vn -0.078698 0.001811 -0.061671
vn -0.081389 0.001872 -0.058072
vn -0.078698 0.001811 -0.061671
vn -0.069513 0.001599 -0.071871
vn -0.069513 0.001599 -0.071871
vn -0.059264 0.001363 -0.080535
vn -0.059264 0.001363 -0.080535
vn -0.055671 0.001281 -0.083061
vn -0.055671 0.001281 -0.083061
vn -0.047526 0.001093 -0.087977
vn -0.044336 0.001020 -0.089629
vn -0.047526 0.001093 -0.087977
vn -0.044336 0.001020 -0.089629
vn -0.034310 0.000789 -0.093927
vn -0.034310 0.000789 -0.093927
vn -0.023835 0.000548 -0.097116
vn -0.023835 0.000548 -0.097116
vn -0.020317 0.000467 -0.097913
vn -0.020317 0.000467 -0.097913
vn -0.012483 0.000287 -0.099217
vn -0.010931 0.000251 -0.099401
vn -0.012483 0.000287 -0.099217
vn -0.010931 0.000251 -0.099401
vn -0.006322 0.000145 -0.099800
vn -0.006322 0.000145 -0.099800
vn -0.002316 0.000053 -0.099973
vn -0.002316 0.000053 -0.099973
vn -0.000982 0.000023 -0.099995
vn -0.000982 0.000023 -0.099995
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.080290 -0.001847 0.059583
vn 0.080290 -0.001847 0.059583
vn 0.080290 -0.001847 0.059583
vn 0.080290 -0.001847 0.059583
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn -0.078868 0.001814 -0.061454
vn -0.078868 0.001814 -0.061454
vn -0.078868 0.001814 -0.061454
vn -0.078868 0.001814 -0.061454
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099973 -0.002300 -0.000220
vn 0.099972 -0.002300 -0.000638
vn 0.099973 -0.002300 -0.000220
vn 0.099972 -0.002300 -0.000638
vn 0.099956 -0.002300 -0.001890
vn 0.099956 -0.002300 -0.001890
vn 0.099916 -0.002299 -0.003403
vn 0.099916 -0.002299 -0.003403
vn 0.099897 -0.002298 -0.003921
vn 0.099897 -0.002298 -0.003921
vn 0.099549 -0.002290 -0.009210
vn 0.099161 -0.002281 -0.012727
vn 0.099549 -0.002290 -0.009210
vn 0.099161 -0.002281 -0.012727
vn 0.097223 -0.002237 -0.023298
vn 0.097223 -0.002237 -0.023298
vn 0.094013 -0.002163 -0.034014
vn 0.094013 -0.002163 -0.034014
vn 0.092695 -0.002133 -0.037459
vn 0.092695 -0.002133 -0.037459
vn 0.085457 -0.001966 -0.051897
vn 0.081991 -0.001886 -0.057218
vn 0.085457 -0.001966 -0.051897
vn 0.081991 -0.001886 -0.057218
vn 0.069198 -0.001592 -0.072174
vn 0.069198 -0.001592 -0.072174
vn 0.054828 -0.001261 -0.083620
vn 0.054828 -0.001261 -0.083620
vn 0.049798 -0.001146 -0.086711
vn 0.049798 -0.001146 -0.086711
vn 0.033800 -0.000778 -0.094111
vn 0.029330 -0.000675 -0.095600
vn 0.033800 -0.000778 -0.094111
vn 0.029330 -0.000675 -0.095600
vn 0.015918 -0.000366 -0.098724
vn 0.015918 -0.000366 -0.098724
vn 0.004973 -0.000114 -0.099876
vn 0.004973 -0.000114 -0.099876
vn 0.001365 -0.000031 -0.099991
vn 0.001365 -0.000031 -0.099991
vn -0.001389 0.000032 -0.099990
vn -0.003775 0.000087 -0.099929
vn -0.001389 0.000032 -0.099990
vn -0.003775 0.000087 -0.099929
vn -0.010964 0.000252 -0.099397
vn -0.010964 0.000252 -0.099397
vn -0.019476 0.000448 -0.098084
vn -0.019476 0.000448 -0.098084
vn -0.022336 0.000514 -0.097472
vn -0.022336 0.000514 -0.097472
vn -0.029303 0.000674 -0.095608
vn -0.029913 0.000688 -0.095419
vn -0.029303 0.000674 -0.095608
vn -0.029913 0.000688 -0.095419
vn -0.031734 0.000730 -0.094828
vn -0.031734 0.000730 -0.094828
vn -0.033594 0.000773 -0.094185
vn -0.033594 0.000773 -0.094185
vn -0.034212 0.000787 -0.093962
vn -0.034212 0.000787 -0.093962
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.099974 -0.002300 0.000000
vn 0.017666 -0.000406 0.098426
vn 0.016520 -0.000380 0.098625
vn 0.017666 -0.000406 0.098426
vn 0.016520 -0.000380 0.098625
vn 0.013102 -0.000301 0.099138
vn 0.013102 -0.000301 0.099138
vn 0.010056 -0.000231 0.099493
vn 0.010056 -0.000231 0.099493
vn 0.009039 -0.000208 0.099590
vn 0.009039 -0.000208 0.099590
vn 0.006942 -0.000160 0.099759
vn 0.006154 -0.000142 0.099810
vn 0.006942 -0.000160 0.099759
vn 0.006154 -0.000142 0.099810
vn 0.003791 -0.000087 0.099928
vn 0.003791 -0.000087 0.099928
vn 0.001560 -0.000036 0.099988
vn 0.001560 -0.000036 0.099988
vn 0.000816 -0.000019 0.099997
vn 0.000816 -0.000019 0.099997
vn -0.001881 0.000043 0.099982
vn -0.004603 0.000106 0.099894
vn -0.001881 0.000043 0.099982
vn -0.004603 0.000106 0.099894
vn -0.012812 0.000295 0.099175
vn -0.012812 0.000295 0.099175
vn -0.022270 0.000512 0.097487
vn -0.022270 0.000512 0.097487
vn -0.025412 0.000585 0.096716
vn -0.025412 0.000585 0.096716
vn -0.035332 0.000813 0.093547
vn -0.038594 0.000888 0.092248
vn -0.035332 0.000813 0.093547
vn -0.038594 0.000888 0.092248
vn -0.048195 0.001109 0.087613
vn -0.048195 0.001109 0.087613
vn -0.057783 0.001329 0.081605
vn -0.057783 0.001329 0.081605
vn -0.060791 0.001399 0.079388
vn -0.060791 0.001399 0.079388
vn -0.069391 0.001596 0.071989
vn -0.072520 0.001668 0.068833
vn -0.069391 0.001596 0.071989
vn -0.072520 0.001668 0.068833
vn -0.081175 0.001868 0.058371
vn -0.081175 0.001868 0.058371
vn -0.088273 0.002031 0.046943
vn -0.088273 0.002031 0.046943
vn -0.090254 0.002076 0.043010
vn -0.090254 0.002076 0.043010
vn -0.094395 0.002172 0.032938
vn -0.095543 0.002198 0.029439
vn -0.094395 0.002172 0.032938
vn -0.095543 0.002198 0.029439
vn -0.098230 0.002260 0.018593
vn -0.098230 0.002260 0.018593
vn -0.099665 0.002293 0.007845
vn -0.099665 0.002293 0.007845
vn -0.099882 0.002298 0.004281
vn -0.099882 0.002298 0.004281
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.099974 0.002300 -0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.098562 0.016900 0.000000
vn -0.100000 0.000000 0.000000
vn -0.100000 0.000000 0.000000
vn -0.098562 -0.016900 0.000000
vn -0.098481 -0.017365 0.000000
vn -0.094288 -0.033314 0.000000
vn -0.093969 -0.034202 0.000000
vn -0.087301 -0.048769 0.000000
vn -0.086603 -0.050000 0.000000
vn -0.077804 -0.062822 0.000000
vn -0.076604 -0.064279 0.000000
vn -0.066067 -0.075067 0.000000
vn -0.064279 -0.076604 0.000000
vn -0.052431 -0.085153 0.000000
vn -0.050000 -0.086603 0.000000
vn -0.037286 -0.092789 0.000000
vn -0.034202 -0.093969 0.000000
vn -0.021068 -0.097756 0.000000
vn -0.017365 -0.098481 0.000000
vn -0.004244 -0.099910 0.000000
vn 0.000000 -0.100000 0.000000
vn 0.012702 -0.099190 0.000000
vn 0.017365 -0.098481 0.000000
vn 0.029282 -0.095617 0.000000
vn 0.034202 -0.093969 0.000000
vn 0.045020 -0.089293 0.000000
vn 0.050000 -0.086603 0.000000
vn 0.059463 -0.080400 0.000000
vn 0.064279 -0.076604 0.000000
vn 0.072196 -0.069194 0.000000
vn 0.076604 -0.064279 0.000000
vn 0.082851 -0.055997 0.000000
vn 0.086603 -0.050000 0.000000
vn 0.091123 -0.041190 0.000000
vn 0.093969 -0.034202 0.000000
vn 0.096773 -0.025198 0.000000
vn 0.098481 -0.017365 0.000000
vn 0.099640 -0.008481 0.000000
vn 0.100000 0.000000 0.000000
vn 0.099640 0.008481 0.000000
vn 0.098481 0.017365 0.000000
vn 0.096773 0.025198 0.000000
vn 0.093969 0.034202 0.000000
vn 0.091123 0.041190 0.000000
vn 0.086603 0.050000 0.000000
vn 0.082851 0.055997 0.000000
vn 0.076604 0.064279 0.000000
vn 0.072196 0.069194 0.000000
vn 0.064279 0.076604 0.000000
vn 0.059463 0.080400 0.000000
vn 0.050000 0.086603 0.000000
vn 0.045020 0.089293 0.000000
vn 0.034202 0.093969 0.000000
vn 0.029282 0.095617 0.000000
vn 0.017365 0.098481 0.000000
vn 0.012702 0.099190 0.000000
vn 0.000000 0.100000 0.000000
vn -0.004244 0.099910 0.000000
vn -0.017365 0.098481 0.000000
vn -0.021068 0.097756 0.000000
vn -0.034202 0.093969 0.000000
vn -0.037286 0.092789 0.000000
vn -0.050000 0.086603 0.000000
vn -0.052431 0.085153 0.000000
vn -0.064279 0.076604 0.000000
vn -0.066067 0.075067 0.000000
vn -0.076604 0.064279 0.000000
vn -0.077804 0.062822 0.000000
vn -0.086603 0.050000 0.000000
vn -0.087301 0.048769 0.000000
vn -0.093969 0.034202 0.000000
vn -0.094288 0.033314 0.000000
vn -0.098481 0.017365 0.000000
vn -0.098562 -0.016900 0.000000
vn -0.100000 -0.000000 0.000000
vn -0.100000 -0.000000 0.000000
vn -0.098562 0.016900 0.000000
vn -0.098481 0.017365 0.000000
vn -0.094288 0.033314 0.000000
vn -0.093969 0.034202 0.000000
vn -0.087301 0.048769 0.000000
vn -0.086603 0.050000 0.000000
vn -0.077804 0.062822 0.000000
vn -0.076604 0.064279 0.000000
vn -0.066067 0.075067 0.000000
vn -0.064279 0.076604 0.000000
vn -0.052431 0.085153 0.000000
vn -0.050000 0.086603 0.000000
vn -0.037286 0.092789 0.000000
vn -0.034202 0.093969 0.000000
vn -0.021068 0.097756 0.000000
vn -0.017365 0.098481 0.000000
vn -0.004244 0.099910 0.000000
vn 0.000000 0.100000 0.000000
vn 0.012702 0.099190 0.000000
vn 0.017365 0.098481 0.000000
vn 0.029282 0.095617 0.000000
vn 0.034202 0.093969 0.000000
vn 0.045020 0.089293 0.000000
vn 0.050000 0.086603 0.000000
vn 0.059463 0.080400 0.000000
vn 0.064279 0.076604 0.000000
vn 0.072196 0.069194 0.000000
vn 0.076604 0.064279 0.000000
vn 0.082851 0.055997 0.000000
vn 0.086603 0.050000 0.000000
vn 0.091123 0.041190 0.000000
vn 0.093969 0.034202 0.000000
vn 0.096773 0.025198 0.000000
vn 0.098481 0.017365 0.000000
vn 0.099640 0.008481 0.000000
vn 0.100000 0.000000 0.000000
vn 0.099640 -0.008481 0.000000
vn 0.098481 -0.017365 0.000000
vn 0.096773 -0.025198 0.000000
vn 0.093969 -0.034202 0.000000
vn 0.091123 -0.041190 0.000000
vn 0.086603 -0.050000 0.000000
vn 0.082851 -0.055997 0.000000
vn 0.076604 -0.064279 0.000000
vn 0.072196 -0.069194 0.000000
vn 0.064279 -0.076604 0.000000
vn 0.059463 -0.080400 0.000000
vn 0.050000 -0.086603 0.000000
vn 0.045020 -0.089293 0.000000
vn 0.034202 -0.093969 0.000000
vn 0.029282 -0.095617 0.000000
vn 0.017365 -0.098481 0.000000
vn 0.012702 -0.099190 0.000000
vn 0.000000 -0.100000 0.000000
vn -0.004244 -0.099910 0.000000
vn -0.017365 -0.098481 0.000000
vn -0.021068 -0.097756 0.000000
vn -0.034202 -0.093969 0.000000
vn -0.037286 -0.092789 0.000000
vn -0.050000 -0.086603 0.000000
vn -0.052431 -0.085153 0.000000
vn -0.064279 -0.076604 0.000000
vn -0.066067 -0.075067 0.000000
vn -0.076604 -0.064279 0.000000
vn -0.077804 -0.062822 0.000000
vn -0.086603 -0.050000 0.000000
vn -0.087301 -0.048769 0.000000
vn -0.093969 -0.034202 0.000000
vn -0.094288 -0.033314 0.000000
vn -0.098481 -0.017365 0.000000
vn 0.099414 -0.010812 0.000000
vn 0.099414 -0.010812 0.000000
vn 0.100000 -0.000000 0.000000
vn 0.100000 -0.000000 0.000000
vn 0.099414 0.010812 0.000000
vn 0.099414 0.010812 0.000000
vn 0.097662 0.021497 0.000000
vn 0.097662 0.021497 0.000000
vn 0.094765 0.031930 0.000000
vn 0.094765 0.031930 0.000000
vn 0.090758 0.041989 0.000000
vn 0.090758 0.041989 0.000000
vn 0.085686 0.051555 0.000000
vn 0.085686 0.051555 0.000000
vn 0.079609 0.060517 0.000000
vn 0.079609 0.060517 0.000000
vn 0.072600 0.068770 0.000000
vn 0.072600 0.068770 0.000000
vn 0.064739 0.076216 0.000000
vn 0.064739 0.076216 0.000000
vn 0.056119 0.082769 0.000000
vn 0.056119 0.082769 0.000000
vn 0.046841 0.088351 0.000000
vn 0.046841 0.088351 0.000000
vn 0.037014 0.092898 0.000000
vn 0.037014 0.092898 0.000000
vn 0.026753 0.096355 0.000000
vn 0.026753 0.096355 0.000000
vn 0.016178 0.098683 0.000000
vn 0.016178 0.098683 0.000000
vn 0.005414 0.099853 0.000000
vn 0.005414 0.099853 0.000000
vn -0.005414 0.099853 -0.000000
vn -0.005414 0.099853 -0.000000
vn -0.016178 0.098683 -0.000000
vn -0.016178 0.098683 -0.000000
vn -0.026753 0.096355 -0.000000
vn -0.026753 0.096355 -0.000000
vn -0.037014 0.092898 -0.000000
vn -0.037014 0.092898 -0.000000
vn -0.046841 0.088351 -0.000000
vn -0.046841 0.088351 -0.000000
vn -0.056119 0.082769 -0.000000
vn -0.056119 0.082769 -0.000000
vn -0.064739 0.076216 -0.000000
vn -0.064739 0.076216 -0.000000
vn -0.072600 0.068770 -0.000000
vn -0.072600 0.068770 -0.000000
vn -0.079609 0.060517 -0.000000
vn -0.079609 0.060517 -0.000000
vn -0.085686 0.051555 -0.000000
vn -0.085686 0.051555 -0.000000
vn -0.090758 0.041989 -0.000000
vn -0.090758 0.041989 -0.000000
vn -0.094765 0.031930 -0.000000
vn -0.094765 0.031930 -0.000000
vn -0.097662 0.021497 -0.000000
vn -0.097662 0.021497 -0.000000
vn -0.099414 0.010812 -0.000000
vn -0.099414 0.010812 -0.000000
vn -0.100000 0.000000 0.000000
vn -0.100000 0.000000 0.000000
vn -0.099414 -0.010812 0.000000
vn -0.099414 -0.010812 0.000000
vn -0.097662 -0.021497 0.000000
vn -0.097662 -0.021497 0.000000
vn -0.094765 -0.031930 0.000000
vn -0.094765 -0.031930 0.000000
vn -0.090758 -0.041989 0.000000
vn -0.090758 -0.041989 0.000000
vn -0.085686 -0.051555 0.000000
vn -0.085686 -0.051555 0.000000
vn -0.079609 -0.060517 0.000000
vn -0.079609 -0.060517 0.000000
vn -0.072600 -0.068770 0.000000
vn -0.072600 -0.068770 0.000000
vn -0.064739 -0.076216 0.000000
vn -0.064739 -0.076216 0.000000
vn -0.056119 -0.082769 0.000000
vn -0.056119 -0.082769 0.000000
vn -0.046841 -0.088351 0.000000
vn -0.046841 -0.088351 0.000000
vn -0.037014 -0.092898 0.000000
vn -0.037014 -0.092898 0.000000
vn -0.026753 -0.096355 0.000000
vn -0.026753 -0.096355 0.000000
vn -0.016178 -0.098683 0.000000
vn -0.016178 -0.098683 0.000000
vn -0.005414 -0.099853 0.000000
vn -0.005414 -0.099853 0.000000
vn 0.005414 -0.099853 0.000000
vn 0.005414 -0.099853 0.000000
vn 0.016178 -0.098683 0.000000
vn 0.016178 -0.098683 0.000000
vn 0.026753 -0.096355 0.000000
vn 0.026753 -0.096355 0.000000
vn 0.037014 -0.092898 0.000000
vn 0.037014 -0.092898 0.000000
vn 0.046841 -0.088351 0.000000
vn 0.046841 -0.088351 0.000000
vn 0.056119 -0.082769 0.000000
vn 0.056119 -0.082769 0.000000
vn 0.064739 -0.076216 0.000000
vn 0.064739 -0.076216 0.000000
vn 0.072600 -0.068770 0.000000
vn 0.072600 -0.068770 0.000000
vn 0.079609 -0.060517 0.000000
vn 0.079609 -0.060517 0.000000
vn 0.085686 -0.051555 0.000000
vn 0.085686 -0.051555 0.000000
vn 0.090758 -0.041989 0.000000
vn 0.090758 -0.041989 0.000000
vn 0.094765 -0.031930 0.000000
vn 0.094765 -0.031930 0.000000
vn 0.097662 -0.021497 0.000000
vn 0.097662 -0.021497 0.000000
vn 0.099414 0.010812 0.000000
vn 0.100000 0.000000 0.000000
vn 0.099414 -0.010812 0.000000
vn 0.097662 -0.021497 0.000000
vn 0.094765 -0.031930 0.000000
vn 0.090758 -0.041989 0.000000
vn 0.085686 -0.051555 0.000000
vn 0.079609 -0.060517 0.000000
vn 0.072600 -0.068770 0.000000
vn 0.064739 -0.076216 0.000000
vn 0.056119 -0.082769 0.000000
vn 0.046841 -0.088351 0.000000
vn 0.037014 -0.092898 0.000000
vn 0.026753 -0.096355 0.000000
vn 0.016178 -0.098683 0.000000
vn 0.005414 -0.099853 0.000000
vn -0.005414 -0.099853 0.000000
vn -0.016178 -0.098683 0.000000
vn -0.026753 -0.096355 0.000000
vn -0.037014 -0.092898 0.000000
vn -0.046841 -0.088351 0.000000
vn -0.056119 -0.082769 0.000000
vn -0.064739 -0.076216 0.000000
vn -0.072600 -0.068770 0.000000
vn -0.079609 -0.060517 0.000000
vn -0.085686 -0.051555 0.000000
vn -0.090758 -0.041989 0.000000
vn -0.094765 -0.031930 0.000000
vn -0.097662 -0.021497 0.000000
vn -0.099414 -0.010812 0.000000
vn -0.100000 0.000000 0.000000
vn -0.099414 0.010812 -0.000000
vn -0.097662 0.021497 -0.000000
vn -0.094765 0.031930 -0.000000
vn -0.090758 0.041989 -0.000000
vn -0.085686 0.051555 -0.000000
vn -0.079609 0.060517 -0.000000
vn -0.072600 0.068770 -0.000000
vn -0.064739 0.076216 -0.000000
vn -0.056119 0.082769 -0.000000
vn -0.046841 0.088351 -0.000000
vn -0.037014 0.092898 -0.000000
vn -0.026753 0.096355 -0.000000
vn -0.016178 0.098683 -0.000000
vn -0.005414 0.099853 -0.000000
vn 0.005414 0.099853 0.000000
vn 0.016178 0.098683 0.000000
vn 0.026753 0.096355 0.000000
vn 0.037014 0.092898 0.000000
vn 0.046841 0.088351 0.000000
vn 0.056119 0.082769 0.000000
vn 0.064739 0.076216 0.000000
vn 0.072600 0.068770 0.000000
vn 0.079609 0.060517 0.000000
vn 0.085686 0.051555 0.000000
vn 0.090758 0.041989 0.000000
vn 0.094765 0.031930 0.000000
vn 0.097662 0.021497 0.000000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.085430 -0.051979 0.000000
vn 0.085430 -0.051979 0.000000
vn 0.085430 -0.051979 0.000000
vn 0.085430 -0.051979 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.002300 -0.099974 0.000000
vn -0.087730 -0.047995 0.000000
vn -0.087730 -0.047995 0.000000
vn -0.087730 -0.047995 0.000000
vn -0.087730 -0.047995 0.000000
vn -0.085430 0.051979 0.000000
vn -0.085430 0.051979 0.000000
vn -0.085430 0.051979 0.000000
vn -0.085430 0.051979 0.000000
vn 0.002300 0.099974 0.000000
vn 0.002300 0.099974 0.000000
vn 0.002300 0.099974 0.000000
vn 0.002300 0.099974 0.000000
vn 0.087730 0.047995 0.000000
vn 0.087730 0.047995 0.000000
vn 0.087730 0.047995 0.000000
vn 0.087730 0.047995 0.000000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.000000 0.000000 0.100000
vn 0.087543 -0.023457 -0.042262
vn 0.087543 -0.023457 -0.042262
vn 0.090631 -0.000000 -0.042262
vn 0.064086 -0.064086 -0.042262
vn 0.064086 -0.064086 -0.042262
vn 0.078489 -0.045315 -0.042262
vn 0.023457 -0.087543 -0.042262
vn 0.023457 -0.087543 -0.042262
vn 0.045315 -0.078489 -0.042262
vn -0.023457 -0.087543 -0.042262
vn -0.023457 -0.087543 -0.042262
vn -0.000000 -0.090631 -0.042262
vn -0.064086 -0.064086 -0.042262
vn -0.064086 -0.064086 -0.042262
vn -0.045315 -0.078489 -0.042262
vn -0.087543 -0.023457 -0.042262
vn -0.087543 -0.023457 -0.042262
vn -0.078489 -0.045315 -0.042262
vn -0.087543 0.023457 -0.042262
vn -0.087543 0.023457 -0.042262
vn -0.090631 0.000000 -0.042262
vn -0.064086 0.064086 -0.042262
vn -0.064086 0.064086 -0.042262
vn -0.078489 0.045315 -0.042262
vn -0.023457 0.087543 -0.042262
vn -0.023457 0.087543 -0.042262
vn -0.045315 0.078489 -0.042262
vn 0.023457 0.087543 -0.042262
vn 0.023457 0.087543 -0.042262
vn -0.000000 0.090631 -0.042262
vn 0.064086 0.064086 -0.042262
vn 0.064086 0.064086 -0.042262
vn 0.045315 0.078489 -0.042262
vn 0.087543 0.023457 -0.042262
vn 0.087543 0.023457 -0.042262
vn 0.078489 0.045315 -0.042262
vn 0.090631 0.000000 -0.042262
vn -0.045315 0.078489 -0.042262
vn -0.045315 -0.078489 -0.042262
vn 0.078489 0.045315 -0.042262
vn 0.045315 0.078489 -0.042262
vn -0.000000 0.090631 -0.042262
vn -0.078489 0.045315 -0.042262
vn -0.090631 0.000000 -0.042262
vn -0.078489 -0.045315 -0.042262
vn -0.000000 -0.090631 -0.042262
vn 0.045315 -0.078489 -0.042262
vn 0.078489 -0.045315 -0.042262
vn -0.090099 -0.009799 -0.042262
vn -0.090631 -0.000000 -0.042262
vn -0.090631 -0.000000 -0.042262
vn -0.090099 0.009799 -0.042262
vn -0.089327 0.015317 -0.042262
vn -0.088512 0.019483 -0.042262
vn -0.085454 0.030193 -0.042262
vn -0.085887 0.028939 -0.042262
vn -0.082254 0.038055 -0.042262
vn -0.079122 0.044200 -0.042262
vn -0.077658 0.046725 -0.042262
vn -0.070514 0.056936 -0.042262
vn -0.072151 0.054847 -0.042262
vn -0.065798 0.062327 -0.042262
vn -0.059877 0.068034 -0.042262
vn -0.058673 0.069075 -0.042262
vn -0.050861 0.075014 -0.042262
vn -0.047518 0.077175 -0.042262
vn -0.042452 0.080073 -0.042262
vn -0.033792 0.084095 -0.042262
vn -0.033546 0.084194 -0.042262
vn -0.024246 0.087327 -0.042262
vn -0.019094 0.088597 -0.042262
vn -0.014662 0.089437 -0.042262
vn -0.003846 0.090549 -0.042262
vn -0.004907 0.090498 -0.042262
vn 0.004907 0.090498 -0.042262
vn 0.011512 0.089897 -0.042262
vn 0.014662 0.089437 -0.042262
vn 0.026539 0.086658 -0.042262
vn 0.024246 0.087327 -0.042262
vn 0.033546 0.084194 -0.042262
vn 0.040802 0.080927 -0.042262
vn 0.042452 0.080073 -0.042262
vn 0.050861 0.075014 -0.042262
vn 0.053892 0.072867 -0.042262
vn 0.058673 0.069075 -0.042262
vn 0.065431 0.062711 -0.042262
vn 0.065798 0.062327 -0.042262
vn 0.072151 0.054847 -0.042262
vn 0.075088 0.050751 -0.042262
vn 0.077658 0.046725 -0.042262
vn 0.082585 0.037331 -0.042262
vn 0.082254 0.038055 -0.042262
vn 0.085887 0.028939 -0.042262
vn 0.087706 0.022837 -0.042262
vn 0.088512 0.019483 -0.042262
vn 0.090304 0.007686 -0.042262
vn 0.090099 0.009799 -0.042262
vn 0.090631 0.000000 -0.042262
vn 0.090304 -0.007686 -0.042262
vn 0.090099 -0.009799 -0.042262
vn 0.088512 -0.019483 -0.042262
vn 0.087706 -0.022837 -0.042262
vn 0.085887 -0.028939 -0.042262
vn 0.082585 -0.037331 -0.042262
vn 0.082254 -0.038055 -0.042262
vn 0.077658 -0.046725 -0.042262
vn 0.075088 -0.050751 -0.042262
vn 0.072151 -0.054847 -0.042262
vn 0.065431 -0.062711 -0.042262
vn 0.065798 -0.062327 -0.042262
vn 0.058673 -0.069075 -0.042262
vn 0.053892 -0.072867 -0.042262
vn 0.050861 -0.075014 -0.042262
vn 0.040802 -0.080927 -0.042262
vn 0.042452 -0.080073 -0.042262
vn 0.033546 -0.084194 -0.042262
vn 0.026539 -0.086658 -0.042262
vn 0.024246 -0.087327 -0.042262
vn 0.014662 -0.089437 -0.042262
vn 0.011512 -0.089897 -0.042262
vn 0.004907 -0.090498 -0.042262
vn -0.003846 -0.090549 -0.042262
vn -0.004907 -0.090498 -0.042262
vn -0.014662 -0.089437 -0.042262
vn -0.019094 -0.088597 -0.042262
vn -0.024246 -0.087327 -0.042262
vn -0.033792 -0.084095 -0.042262
vn -0.033546 -0.084194 -0.042262
vn -0.042452 -0.080073 -0.042262
vn -0.047518 -0.077175 -0.042262
vn -0.050861 -0.075014 -0.042262
vn -0.059877 -0.068034 -0.042262
vn -0.058673 -0.069075 -0.042262
vn -0.065798 -0.062327 -0.042262
vn -0.070514 -0.056936 -0.042262
vn -0.072151 -0.054847 -0.042262
vn -0.077658 -0.046725 -0.042262
vn -0.079122 -0.044200 -0.042262
vn -0.082254 -0.038055 -0.042262
vn -0.085454 -0.030193 -0.042262
vn -0.085887 -0.028939 -0.042262
vn -0.088512 -0.019483 -0.042262
vn -0.089327 -0.015317 -0.042262
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
vn 0.000000 0.000000 -0.100000
usemtl Brass_-_Polished
f 1/1/1 2/2/2 10/3/3
f 10/3/3 2/2/2 9/4/4
f 9/4/4 2/2/2 3/5/5
f 9/4/4 3/5/5 8/6/6
f 8/6/6 3/5/5 4/7/7
f 8/6/6 4/7/7 7/8/8
f 7/8/8 4/7/7 5/9/9
f 7/8/8 5/9/9 6/10/10
f 5/11/11 11/12/12 6/13/13
f 6/13/13 11/12/12 18/14/14
f 18/14/14 11/12/12 12/15/15
f 18/14/14 12/15/15 17/16/16
f 17/16/16 12/15/15 13/17/17
f 17/16/16 13/17/17 16/18/18
f 16/18/18 13/17/17 14/19/19
f 16/18/18 14/19/19 15/20/20
f 14/21/21 19/22/22 15/23/23
f 15/23/23 19/22/22 26/24/24
f 26/24/24 19/22/22 20/25/25
f 26/24/24 20/25/25 25/26/26
f 25/26/26 20/25/25 21/27/27
f 25/26/26 21/27/27 24/28/28
f 24/28/28 21/27/27 22/29/29
f 24/28/28 22/29/29 23/30/30
f 22/31/31 27/32/32 23/33/33
f 23/33/33 27/32/32 28/34/34
f 27/35/35 29/36/36 28/37/37
f 28/37/37 29/36/36 30/38/38
f 29/39/39 31/40/40 30/41/41
f 30/41/41 31/40/40 32/42/42
f 31/43/43 33/44/44 32/45/45
f 32/45/45 33/44/44 40/46/46
f 40/46/46 33/44/44 34/47/47
f 40/46/46 34/47/47 39/48/48
f 39/48/48 34/47/47 35/49/49
f 39/48/48 35/49/49 38/50/50
f 38/50/50 35/49/49 36/51/51
f 38/50/50 36/51/51 37/52/52
f 36/53/53 41/54/54 37/55/55
f 37/55/55 41/54/54 48/56/56
f 48/56/56 41/54/54 42/57/57
f 48/56/56 42/57/57 47/58/58
f 47/58/58 42/57/57 43/59/59
f 47/58/58 43/59/59 46/60/60
f 46/60/60 43/59/59 44/61/61
f 46/60/60 44/61/61 45/62/62
f 44/63/63 49/64/64 45/65/65
f 45/65/65 49/64/64 56/66/66
f 56/66/66 49/64/64 50/67/67
f 56/66/66 50/67/67 55/68/68
f 55/68/68 50/67/67 51/69/69
f 55/68/68 51/69/69 54/70/70
f 54/70/70 51/69/69 52/71/71
f 54/70/70 52/71/71 53/72/72
f 52/73/73 57/74/74 53/75/75
f 53/75/75 57/74/74 64/76/76
f 64/76/76 57/74/74 58/77/77
f 64/76/76 58/77/77 63/78/78
f 63/78/78 58/77/77 59/79/79
f 63/78/78 59/79/79 62/80/80
f 62/80/80 59/79/79 60/81/81
f 62/80/80 60/81/81 61/82/82
f 60/83/83 65/84/84 61/85/85
f 61/85/85 65/84/84 70/86/86
f 70/86/86 65/84/84 66/87/87
f 70/86/86 66/87/87 69/88/88
f 69/88/88 66/87/87 67/89/89
f 69/88/88 67/89/89 68/90/90
f 68/90/90 67/89/89 1/91/91
f 68/90/90 1/91/91 10/92/92
f 71/93/93 72/94/94 80/95/95
f 80/95/95 72/94/94 79/96/96
f 79/96/96 72/94/94 73/97/97
f 79/96/96 73/97/97 78/98/98
f 78/98/98 73/97/97 74/99/99
f 78/98/98 74/99/99 77/100/100
f 77/100/100 74/99/99 75/101/101
f 77/100/100 75/101/101 76/102/102
f 75/103/103 81/104/104 76/105/105
f 76/105/105 81/104/104 88/106/106
f 88/106/106 81/104/104 82/107/107
f 88/106/106 82/107/107 87/108/108
f 87/108/108 82/107/107 83/109/109
f 87/108/108 83/109/109 86/110/110
f 86/110/110 83/109/109 84/111/111
f 86/110/110 84/111/111 85/112/112
f 84/113/113 89/114/114 85/115/115
f 85/115/115 89/114/114 96/116/116
f 96/116/116 89/114/114 90/117/117
f 96/116/116 90/117/117 95/118/118
f 95/118/118 90/117/117 91/119/119
f 95/118/118 91/119/119 94/120/120
f 94/120/120 91/119/119 92/121/121
f 94/120/120 92/121/121 93/122/122
f 92/123/123 97/124/124 93/125/125
f 93/125/125 97/124/124 104/126/126
f 104/126/126 97/124/124 98/127/127
f 104/126/126 98/127/127 103/128/128
f 103/128/128 98/127/127 99/129/129
f 103/128/128 99/129/129 102/130/130
f 102/130/130 99/129/129 100/131/131
f 102/130/130 100/131/131 101/132/132
f 100/133/133 105/134/134 101/135/135
f 101/135/135 105/134/134 112/136/136
f 112/136/136 105/134/134 106/137/137
f 112/136/136 106/137/137 111/138/138
f 111/138/138 106/137/137 107/139/139
f 111/138/138 107/139/139 110/140/140
f 110/140/140 107/139/139 108/141/141
f 110/140/140 108/141/141 109/142/142
f 108/143/143 113/144/144 109/145/145
f 109/145/145 113/144/144 120/146/146
f 120/146/146 113/144/144 114/147/147
f 120/146/146 114/147/147 119/148/148
f 119/148/148 114/147/147 115/149/149
f 119/148/148 115/149/149 118/150/150
f 118/150/150 115/149/149 116/151/151
f 118/150/150 116/151/151 117/152/152
f 116/153/153 121/154/154 117/155/155
f 117/155/155 121/154/154 122/156/156
f 121/157/157 123/158/158 122/159/159
f 122/159/159 123/158/158 124/160/160
f 123/161/161 125/162/162 124/163/163
f 124/163/163 125/162/162 126/164/164
f 125/165/165 127/166/166 126/167/167
f 126/167/167 127/166/166 128/168/168
f 127/169/169 129/170/170 128/171/171
f 128/171/171 129/170/170 130/172/172
f 129/173/173 131/174/174 130/175/175
f 130/175/175 131/174/174 132/176/176
f 131/177/177 133/178/178 132/179/179
f 132/179/179 133/178/178 134/180/180
f 133/181/181 71/182/182 134/183/183
f 134/183/183 71/182/182 80/184/184
f 134/185/185 80/186/186 132/187/187
f 132/187/187 80/186/186 130/188/188
f 130/188/188 80/186/186 25/189/189
f 130/188/188 25/189/189 24/190/190
f 80/186/186 79/191/191 25/189/189
f 25/189/189 79/191/191 26/192/192
f 26/192/192 79/191/191 15/193/193
f 15/193/193 79/191/191 16/194/194
f 16/194/194 79/191/191 17/195/195
f 17/195/195 79/191/191 18/196/196
f 18/196/196 79/191/191 6/197/197
f 6/197/197 79/191/191 7/198/198
f 7/198/198 79/191/191 8/199/199
f 8/199/199 79/191/191 9/200/200
f 9/200/200 79/191/191 78/201/201
f 9/200/200 78/201/201 10/202/202
f 10/202/202 78/201/201 77/203/203
f 10/202/202 77/203/203 68/204/204
f 68/204/204 77/203/203 76/205/205
f 68/204/204 76/205/205 69/206/206
f 69/206/206 76/205/205 88/207/207
f 69/206/206 88/207/207 70/208/208
f 70/208/208 88/207/207 87/209/209
f 70/208/208 87/209/209 86/210/210
f 70/208/208 86/210/210 61/211/211
f 61/211/211 86/210/210 85/212/212
f 61/211/211 85/212/212 62/213/213
f 62/213/213 85/212/212 96/214/214
f 62/213/213 96/214/214 63/215/215
f 63/215/215 96/214/214 95/216/216
f 63/215/215 95/216/216 94/217/217
f 63/215/215 94/217/217 64/218/218
f 64/218/218 94/217/217 93/219/219
f 64/218/218 93/219/219 104/220/220
f 104/220/220 103/221/221 64/218/218
f 64/218/218 103/221/221 53/222/222
f 53/222/222 103/221/221 102/223/223
f 53/222/222 102/223/223 101/224/224
f 101/224/224 112/225/225 53/222/222
f 53/222/222 112/225/225 54/226/226
f 54/226/226 112/225/225 111/227/227
f 54/226/226 111/227/227 55/228/228
f 55/228/228 111/227/227 110/229/229
f 55/228/228 110/229/229 109/230/230
f 55/228/228 109/230/230 56/231/231
f 56/231/231 109/230/230 120/232/232
f 56/231/231 120/232/232 45/233/233
f 45/233/233 120/232/232 119/234/234
f 45/233/233 119/234/234 46/235/235
f 46/235/235 119/234/234 47/236/236
f 47/236/236 119/234/234 118/237/237
f 47/236/236 118/237/237 48/238/238
f 48/238/238 118/237/237 117/239/239
f 48/238/238 117/239/239 37/240/240
f 37/240/240 117/239/239 38/241/241
f 38/241/241 117/239/239 39/242/242
f 39/242/242 117/239/239 40/243/243
f 40/243/243 117/239/239 32/244/244
f 32/244/244 117/239/239 30/245/245
f 30/245/245 117/239/239 122/246/246
f 30/245/245 122/246/246 28/247/247
f 28/247/247 122/246/246 124/248/248
f 28/247/247 124/248/248 128/249/249
f 128/249/249 124/248/248 126/250/250
f 28/247/247 128/249/249 23/251/251
f 23/251/251 128/249/249 130/188/188
f 23/251/251 130/188/188 24/190/190
f 135/252/252 136/253/253 138/254/254
f 138/254/254 136/253/253 137/255/255
f 136/256/256 139/257/257 137/258/258
f 137/258/258 139/257/257 140/259/259
f 139/260/260 141/261/261 140/262/262
f 140/262/262 141/261/261 142/263/263
f 141/264/264 143/265/265 142/266/266
f 142/266/266 143/265/265 144/267/267
f 143/268/268 145/269/269 144/270/270
f 144/270/270 145/269/269 152/271/271
f 152/271/271 145/269/269 146/272/272
f 152/271/271 146/272/272 151/273/273
f 151/273/273 146/272/272 147/274/274
f 151/273/273 147/274/274 150/275/275
f 150/275/275 147/274/274 148/276/276
f 150/275/275 148/276/276 149/277/277
f 148/278/278 153/279/279 149/280/280
f 149/280/280 153/279/279 160/281/281
f 160/281/281 153/279/279 154/282/282
f 160/281/281 154/282/282 159/283/283
f 159/283/283 154/282/282 155/284/284
f 159/283/283 155/284/284 158/285/285
f 158/285/285 155/284/284 156/286/286
f 158/285/285 156/286/286 157/287/287
f 156/288/288 161/289/289 157/290/290
f 157/290/290 161/289/289 168/291/291
f 168/291/291 161/289/289 162/292/292
f 168/291/291 162/292/292 167/293/293
f 167/293/293 162/292/292 163/294/294
f 167/293/293 163/294/294 166/295/295
f 166/295/295 163/294/294 164/296/296
f 166/295/295 164/296/296 165/297/297
f 164/298/298 169/299/299 165/300/300
f 165/300/300 169/299/299 176/301/301
f 176/301/301 169/299/299 170/302/302
f 176/301/301 170/302/302 175/303/303
f 175/303/303 170/302/302 171/304/304
f 175/303/303 171/304/304 174/305/305
f 174/305/305 171/304/304 172/306/306
f 174/305/305 172/306/306 173/307/307
f 172/308/308 177/309/309 173/310/310
f 173/310/310 177/309/309 184/311/311
f 184/311/311 177/309/309 178/312/312
f 184/311/311 178/312/312 183/313/313
f 183/313/313 178/312/312 179/314/314
f 183/313/313 179/314/314 182/315/315
f 182/315/315 179/314/314 180/316/316
f 182/315/315 180/316/316 181/317/317
f 180/318/318 185/319/319 181/320/320
f 181/320/320 185/319/319 192/321/321
f 192/321/321 185/319/319 186/322/322
f 192/321/321 186/322/322 191/323/323
f 191/323/323 186/322/322 187/324/324
f 191/323/323 187/324/324 190/325/325
f 190/325/325 187/324/324 188/326/326
f 190/325/325 188/326/326 189/327/327
f 188/328/328 193/329/329 189/330/330
f 189/330/330 193/329/329 194/331/331
f 193/332/332 195/333/333 194/334/334
f 194/334/334 195/333/333 196/335/335
f 195/336/336 197/337/337 196/338/338
f 196/338/338 197/337/337 204/339/339
f 204/339/339 197/337/337 198/340/340
f 204/339/339 198/340/340 203/341/341
f 203/341/341 198/340/340 199/342/342
f 203/341/341 199/342/342 202/343/343
f 202/343/343 199/342/342 200/344/344
f 202/343/343 200/344/344 201/345/345
f 200/346/346 205/347/347 201/348/348
f 201/348/348 205/347/347 212/349/349
f 212/349/349 205/347/347 206/350/350
f 212/349/349 206/350/350 211/351/351
f 211/351/351 206/350/350 207/352/352
f 211/351/351 207/352/352 210/353/353
f 210/353/353 207/352/352 208/354/354
f 210/353/353 208/354/354 209/355/355
f 208/356/356 213/357/357 209/358/358
f 209/358/358 213/357/357 220/359/359
f 220/359/359 213/357/357 214/360/360
f 220/359/359 214/360/360 219/361/361
f 219/361/361 214/360/360 215/362/362
f 219/361/361 215/362/362 218/363/363
f 218/363/363 215/362/362 216/364/364
f 218/363/363 216/364/364 217/365/365
f 216/366/366 221/367/367 217/368/368
f 217/368/368 221/367/367 228/369/369
f 228/369/369 221/367/367 222/370/370
f 228/369/369 222/370/370 227/371/371
f 227/371/371 222/370/370 223/372/372
f 227/371/371 223/372/372 226/373/373
f 226/373/373 223/372/372 224/374/374
f 226/373/373 224/374/374 225/375/375
f 224/376/376 229/377/377 225/378/378
f 225/378/378 229/377/377 236/379/379
f 236/379/379 229/377/377 230/380/380
f 236/379/379 230/380/380 235/381/381
f 235/381/381 230/380/380 231/382/382
f 235/381/381 231/382/382 234/383/383
f 234/383/383 231/382/382 232/384/384
f 234/383/383 232/384/384 233/385/385
f 232/386/386 237/387/387 233/388/388
f 233/388/388 237/387/387 244/389/389
f 244/389/389 237/387/387 238/390/390
f 244/389/389 238/390/390 243/391/391
f 243/391/391 238/390/390 239/392/392
f 243/391/391 239/392/392 242/393/393
f 242/393/393 239/392/392 240/394/394
f 242/393/393 240/394/394 241/395/395
f 240/396/396 135/397/397 241/398/398
f 241/398/398 135/397/397 138/399/399
f 138/400/400 142/401/401 241/402/402
f 241/402/402 142/401/401 144/403/403
f 241/402/402 144/403/403 152/404/404
f 138/400/400 137/405/405 142/401/401
f 142/401/401 137/405/405 140/406/406
f 152/404/404 151/407/407 241/402/402
f 241/402/402 151/407/407 150/408/408
f 241/402/402 150/408/408 149/409/409
f 160/410/410 235/411/411 149/409/409
f 149/409/409 235/411/411 234/412/412
f 149/409/409 234/412/412 233/413/413
f 159/414/414 225/415/415 160/410/410
f 160/410/410 225/415/415 236/416/416
f 160/410/410 236/416/416 235/411/411
f 158/417/417 227/418/418 159/414/414
f 159/414/414 227/418/418 226/419/419
f 159/414/414 226/419/419 225/415/415
f 227/418/418 158/417/417 228/420/420
f 228/420/420 158/417/417 157/421/421
f 228/420/420 157/421/421 217/422/422
f 217/422/422 157/421/421 168/423/423
f 217/422/422 168/423/423 218/424/424
f 218/424/424 168/423/423 167/425/425
f 218/424/424 167/425/425 166/426/426
f 218/424/424 166/426/426 219/427/427
f 219/427/427 166/426/426 165/428/428
f 219/427/427 165/428/428 220/429/429
f 220/429/429 165/428/428 176/430/430
f 220/429/429 176/430/430 175/431/431
f 220/429/429 175/431/431 209/432/432
f 209/432/432 175/431/431 174/433/433
f 209/432/432 174/433/433 210/434/434
f 210/434/434 174/433/433 173/435/435
f 210/434/434 173/435/435 211/436/436
f 211/436/436 173/435/435 184/437/437
f 211/436/436 184/437/437 212/438/438
f 212/438/438 184/437/437 183/439/439
f 212/438/438 183/439/439 201/440/440
f 201/440/440 183/439/439 182/441/441
f 201/440/440 182/441/441 202/442/442
f 202/442/442 182/441/441 181/443/443
f 202/442/442 181/443/443 192/444/444
f 202/442/442 192/444/444 203/445/445
f 203/445/445 192/444/444 191/446/446
f 203/445/445 191/446/446 204/447/447
f 204/447/447 191/446/446 190/448/448
f 204/447/447 190/448/448 196/449/449
f 196/449/449 190/448/448 189/450/450
f 196/449/449 189/450/450 194/451/451
f 233/413/413 244/452/452 149/409/409
f 149/409/409 244/452/452 243/453/453
f 149/409/409 243/453/453 242/454/454
f 242/454/454 241/402/402 149/409/409
f 246/455/455 123/456/456 245/457/457
f 245/457/457 123/456/456 214/458/458
f 245/457/457 214/458/458 213/459/459
f 247/460/460 133/461/461 246/455/455
f 246/455/455 133/461/461 131/462/462
f 246/455/455 131/462/462 125/463/463
f 125/463/463 131/462/462 129/464/464
f 125/463/463 129/464/464 127/465/465
f 248/466/466 121/467/467 247/460/460
f 247/460/460 121/467/467 116/468/468
f 247/460/460 116/468/468 115/469/469
f 245/457/457 193/470/470 248/466/466
f 248/466/466 193/470/470 139/471/471
f 248/466/466 139/471/471 136/472/472
f 136/472/472 135/473/473 248/466/466
f 248/466/466 135/473/473 121/467/467
f 135/473/473 240/474/474 121/467/467
f 121/467/467 240/474/474 123/456/456
f 123/456/456 240/474/474 239/475/475
f 123/456/456 239/475/475 238/476/476
f 238/476/476 237/477/477 123/456/456
f 123/456/456 237/477/477 232/478/478
f 123/456/456 232/478/478 231/479/479
f 231/479/479 230/480/480 123/456/456
f 123/456/456 230/480/480 229/481/481
f 123/456/456 229/481/481 224/482/482
f 224/482/482 223/483/483 123/456/456
f 123/456/456 223/483/483 222/484/484
f 123/456/456 222/484/484 221/485/485
f 221/485/485 216/486/486 123/456/456
f 123/456/456 216/486/486 215/487/487
f 123/456/456 215/487/487 214/458/458
f 213/459/459 208/488/488 245/457/457
f 245/457/457 208/488/488 207/489/489
f 245/457/457 207/489/489 206/490/490
f 206/490/490 205/491/491 245/457/457
f 245/457/457 205/491/491 200/492/492
f 245/457/457 200/492/492 199/493/493
f 199/493/493 198/494/494 245/457/457
f 245/457/457 198/494/494 197/495/495
f 245/457/457 197/495/495 195/496/496
f 195/496/496 193/470/470 245/457/457
f 139/471/471 193/470/470 143/497/497
f 143/497/497 193/470/470 188/498/498
f 143/497/497 188/498/498 145/499/499
f 145/499/499 188/498/498 146/500/500
f 146/500/500 188/498/498 147/501/501
f 147/501/501 188/498/498 148/502/502
f 148/502/502 188/498/498 153/503/503
f 153/503/503 188/498/498 187/504/504
f 153/503/503 187/504/504 154/505/505
f 154/505/505 187/504/504 186/506/506
f 154/505/505 186/506/506 155/507/507
f 155/507/507 186/506/506 185/508/508
f 155/507/507 185/508/508 180/509/509
f 180/509/509 179/510/510 155/507/507
f 155/507/507 179/510/510 178/511/511
f 155/507/507 178/511/511 177/512/512
f 155/507/507 177/512/512 156/513/513
f 156/513/513 177/512/512 172/514/514
f 156/513/513 172/514/514 161/515/515
f 161/515/515 172/514/514 171/516/516
f 161/515/515 171/516/516 162/517/517
f 162/517/517 171/516/516 170/518/518
f 162/517/517 170/518/518 169/519/519
f 164/520/520 163/521/521 169/519/519
f 169/519/519 163/521/521 162/517/517
f 143/497/497 141/522/522 139/471/471
f 81/523/523 75/524/524 133/461/461
f 133/461/461 75/524/524 74/525/525
f 133/461/461 74/525/525 73/526/526
f 73/526/526 72/527/527 133/461/461
f 133/461/461 72/527/527 71/528/528
f 125/463/463 123/456/456 246/455/455
f 115/469/469 114/529/529 247/460/460
f 247/460/460 114/529/529 113/530/530
f 247/460/460 113/530/530 108/531/531
f 108/531/531 107/532/532 247/460/460
f 247/460/460 107/532/532 106/533/533
f 247/460/460 106/533/533 105/534/534
f 105/534/534 100/535/535 247/460/460
f 247/460/460 100/535/535 99/536/536
f 247/460/460 99/536/536 98/537/537
f 98/537/537 97/538/538 247/460/460
f 247/460/460 97/538/538 92/539/539
f 247/460/460 92/539/539 91/540/540
f 91/540/540 90/541/541 247/460/460
f 247/460/460 90/541/541 89/542/542
f 247/460/460 89/542/542 84/543/543
f 84/543/543 83/544/544 247/460/460
f 247/460/460 83/544/544 82/545/545
f 247/460/460 82/545/545 133/461/461
f 133/461/461 82/545/545 81/523/523
f 285/546/546 249/547/547 323/548/548
f 323/549/548 249/550/547 250/551/549
f 323/549/548 250/551/549 325/552/550
f 325/552/550 250/551/549 251/553/551
f 325/552/550 251/553/551 327/554/552
f 327/554/552 251/553/551 252/555/553
f 327/554/552 252/555/553 329/556/554
f 329/556/554 252/555/553 253/557/555
f 329/556/554 253/557/555 331/558/556
f 331/558/556 253/557/555 254/559/557
f 331/558/556 254/559/557 333/560/558
f 333/560/558 254/559/557 255/561/559
f 333/560/558 255/561/559 335/562/560
f 335/562/560 255/561/559 256/563/561
f 335/562/560 256/563/561 337/564/562
f 337/564/562 256/563/561 257/565/563
f 337/564/562 257/565/563 339/566/564
f 339/566/564 257/565/563 258/567/565
f 339/566/564 258/567/565 341/568/566
f 341/568/566 258/567/565 259/569/567
f 341/568/566 259/569/567 343/570/568
f 343/570/568 259/569/567 260/571/569
f 343/570/568 260/571/569 345/572/570
f 345/572/570 260/571/569 261/573/571
f 345/572/570 261/573/571 347/574/572
f 347/574/572 261/573/571 262/575/573
f 347/574/572 262/575/573 349/576/574
f 349/576/574 262/575/573 263/577/575
f 349/576/574 263/577/575 351/578/576
f 351/578/576 263/577/575 264/579/577
f 351/578/576 264/579/577 353/580/578
f 353/580/578 264/579/577 265/581/579
f 353/580/578 265/581/579 355/582/580
f 355/582/580 265/581/579 266/583/581
f 355/582/580 266/583/581 357/584/582
f 357/584/582 266/583/581 267/585/583
f 357/584/582 267/585/583 359/586/584
f 359/586/584 267/585/583 268/587/585
f 359/586/584 268/587/585 361/588/586
f 361/588/586 268/587/585 269/589/587
f 361/588/586 269/589/587 363/590/588
f 363/590/588 269/589/587 270/591/589
f 363/590/588 270/591/589 365/592/590
f 365/592/590 270/591/589 271/593/591
f 365/592/590 271/593/591 367/594/592
f 367/594/592 271/593/591 272/595/593
f 367/594/592 272/595/593 369/596/594
f 369/596/594 272/595/593 273/597/595
f 369/596/594 273/597/595 371/598/596
f 371/598/596 273/597/595 274/599/597
f 371/598/596 274/599/597 373/600/598
f 373/600/598 274/599/597 275/601/599
f 373/600/598 275/601/599 375/602/600
f 375/602/600 275/601/599 276/603/601
f 375/602/600 276/603/601 377/604/602
f 377/604/602 276/603/601 277/605/603
f 377/604/602 277/605/603 379/606/604
f 379/606/604 277/605/603 278/607/605
f 379/606/604 278/607/605 381/608/606
f 381/608/606 278/607/605 279/609/607
f 381/608/606 279/609/607 383/610/608
f 383/610/608 279/609/607 280/611/609
f 383/610/608 280/611/609 385/612/610
f 385/612/610 280/611/609 281/613/611
f 385/612/610 281/613/611 387/614/612
f 387/614/612 281/613/611 282/615/613
f 387/614/612 282/615/613 389/616/614
f 389/616/614 282/615/613 283/617/615
f 389/616/614 283/617/615 391/618/616
f 391/618/616 283/617/615 284/619/617
f 391/618/616 284/619/617 393/620/618
f 393/620/618 284/619/617 285/546/546
f 393/620/618 285/546/546 323/548/548
f 322/621/619 286/622/620 324/623/621
f 324/624/621 286/625/620 287/626/622
f 324/624/621 287/626/622 394/627/623
f 394/627/623 287/626/622 288/628/624
f 394/627/623 288/628/624 392/629/625
f 392/629/625 288/628/624 289/630/626
f 392/629/625 289/630/626 390/631/627
f 390/631/627 289/630/626 290/632/628
f 390/631/627 290/632/628 388/633/629
f 388/633/629 290/632/628 291/634/630
f 388/633/629 291/634/630 386/635/631
f 386/635/631 291/634/630 292/636/632
f 386/635/631 292/636/632 384/637/633
f 384/637/633 292/636/632 293/638/634
f 384/637/633 293/638/634 382/639/635
f 382/639/635 293/638/634 294/640/636
f 382/639/635 294/640/636 380/641/637
f 380/641/637 294/640/636 295/642/638
f 380/641/637 295/642/638 378/643/639
f 378/643/639 295/642/638 296/644/640
f 378/643/639 296/644/640 376/645/641
f 376/645/641 296/644/640 297/646/642
f 376/645/641 297/646/642 374/647/643
f 374/647/643 297/646/642 298/648/644
f 374/647/643 298/648/644 372/649/645
f 372/649/645 298/648/644 299/650/646
f 372/649/645 299/650/646 370/651/647
f 370/651/647 299/650/646 300/652/648
f 370/651/647 300/652/648 368/653/649
f 368/653/649 300/652/648 301/654/650
f 368/653/649 301/654/650 366/655/651
f 366/655/651 301/654/650 302/656/652
f 366/655/651 302/656/652 364/657/653
f 364/657/653 302/656/652 303/658/654
f 364/657/653 303/658/654 362/659/655
f 362/659/655 303/658/654 304/660/656
f 362/659/655 304/660/656 360/661/657
f 360/661/657 304/660/656 305/662/658
f 360/661/657 305/662/658 358/663/659
f 358/663/659 305/662/658 306/664/660
f 358/663/659 306/664/660 356/665/661
f 356/665/661 306/664/660 307/666/662
f 356/665/661 307/666/662 354/667/663
f 354/667/663 307/666/662 308/668/664
f 354/667/663 308/668/664 352/669/665
f 352/669/665 308/668/664 309/670/666
f 352/669/665 309/670/666 350/671/667
f 350/671/667 309/670/666 310/672/668
f 350/671/667 310/672/668 348/673/669
f 348/673/669 310/672/668 311/674/670
f 348/673/669 311/674/670 346/675/671
f 346/675/671 311/674/670 312/676/672
f 346/675/671 312/676/672 344/677/673
f 344/677/673 312/676/672 313/678/674
f 344/677/673 313/678/674 342/679/675
f 342/679/675 313/678/674 314/680/676
f 342/679/675 314/680/676 340/681/677
f 340/681/677 314/680/676 315/682/678
f 340/681/677 315/682/678 338/683/679
f 338/683/679 315/682/678 316/684/680
f 338/683/679 316/684/680 336/685/681
f 336/685/681 316/684/680 317/686/682
f 336/685/681 317/686/682 334/687/683
f 334/687/683 317/686/682 318/688/684
f 334/687/683 318/688/684 332/689/685
f 332/689/685 318/688/684 319/690/686
f 332/689/685 319/690/686 330/691/687
f 330/691/687 319/690/686 320/692/688
f 330/691/687 320/692/688 328/693/689
f 328/693/689 320/692/688 321/694/690
f 328/693/689 321/694/690 326/695/691
f 326/695/691 321/694/690 322/621/619
f 326/695/691 322/621/619 324/623/621
f 323/548/548 324/624/621 393/620/618
f 393/620/618 324/624/621 394/627/623
f 393/620/618 394/627/623 391/618/616
f 391/618/616 394/627/623 392/629/625
f 391/618/616 392/629/625 389/616/614
f 389/616/614 392/629/625 390/631/627
f 389/616/614 390/631/627 387/614/612
f 387/614/612 390/631/627 388/633/629
f 387/614/612 388/633/629 385/612/610
f 385/612/610 388/633/629 386/635/631
f 385/612/610 386/635/631 383/610/608
f 383/610/608 386/635/631 384/637/633
f 383/610/608 384/637/633 381/608/606
f 381/608/606 384/637/633 382/639/635
f 381/608/606 382/639/635 379/606/604
f 379/606/604 382/639/635 380/641/637
f 379/606/604 380/641/637 377/604/602
f 377/604/602 380/641/637 378/643/639
f 377/604/602 378/643/639 375/602/600
f 375/602/600 378/643/639 376/645/641
f 375/602/600 376/645/641 373/600/598
f 373/600/598 376/645/641 374/647/643
f 373/600/598 374/647/643 371/598/596
f 371/598/596 374/647/643 372/649/645
f 371/598/596 372/649/645 369/596/594
f 369/596/594 372/649/645 370/651/647
f 369/596/594 370/651/647 367/594/592
f 367/594/592 370/651/647 368/653/649
f 367/594/592 368/653/649 365/592/590
f 365/592/590 368/653/649 366/655/651
f 365/592/590 366/655/651 363/590/588
f 363/590/588 366/655/651 364/657/653
f 363/590/588 364/657/653 361/588/586
f 361/588/586 364/657/653 362/659/655
f 361/588/586 362/659/655 359/586/584
f 359/586/584 362/659/655 360/661/657
f 359/586/584 360/661/657 357/584/582
f 357/584/582 360/661/657 358/663/659
f 357/584/582 358/663/659 355/582/580
f 355/582/580 358/663/659 356/665/661
f 355/582/580 356/665/661 353/580/578
f 353/580/578 356/665/661 354/667/663
f 353/580/578 354/667/663 351/578/576
f 351/578/576 354/667/663 352/669/665
f 351/578/576 352/669/665 349/576/574
f 349/576/574 352/669/665 350/671/667
f 349/576/574 350/671/667 347/574/572
f 347/574/572 350/671/667 348/673/669
f 347/574/572 348/673/669 345/572/570
f 345/572/570 348/673/669 346/675/671
f 345/572/570 346/675/671 343/570/568
f 343/570/568 346/675/671 344/677/673
f 343/570/568 344/677/673 341/568/566
f 341/568/566 344/677/673 342/679/675
f 341/568/566 342/679/675 339/566/564
f 339/566/564 342/679/675 340/681/677
f 339/566/564 340/681/677 337/564/562
f 337/564/562 340/681/677 338/683/679
f 337/564/562 338/683/679 335/562/560
f 335/562/560 338/683/679 336/685/681
f 335/562/560 336/685/681 333/560/558
f 333/560/558 336/685/681 334/687/683
f 333/560/558 334/687/683 331/558/556
f 331/558/556 334/687/683 332/689/685
f 331/558/556 332/689/685 329/556/554
f 329/556/554 332/689/685 330/691/687
f 329/556/554 330/691/687 327/554/552
f 327/554/552 330/691/687 328/693/689
f 327/554/552 328/693/689 325/552/550
f 325/552/550 328/693/689 326/695/691
f 325/552/550 326/695/691 323/549/548
f 323/549/548 326/695/691 324/623/621
f 396/696/692 512/697/693 395/698/694
f 395/698/694 512/697/693 511/699/695
f 395/700/694 511/701/695 452/702/696
f 452/702/696 511/701/695 568/703/697
f 452/702/696 568/703/697 451/704/698
f 451/704/698 568/703/697 567/705/699
f 451/704/698 567/705/699 450/706/700
f 450/706/700 567/705/699 566/707/701
f 450/706/700 566/707/701 449/708/702
f 449/708/702 566/707/701 565/709/703
f 449/708/702 565/709/703 448/710/704
f 448/710/704 565/709/703 564/711/705
f 448/710/704 564/711/705 447/712/706
f 447/712/706 564/711/705 563/713/707
f 447/712/706 563/713/707 446/714/708
f 446/714/708 563/713/707 562/715/709
f 446/714/708 562/715/709 445/716/710
f 445/716/710 562/715/709 561/717/711
f 445/716/710 561/717/711 444/718/712
f 444/718/712 561/717/711 560/719/713
f 444/718/712 560/719/713 443/720/714
f 443/720/714 560/719/713 559/721/715
f 443/720/714 559/721/715 442/722/716
f 442/722/716 559/721/715 558/723/717
f 442/722/716 558/723/717 441/724/718
f 441/724/718 558/723/717 557/725/719
f 441/724/718 557/725/719 440/726/720
f 440/726/720 557/725/719 556/727/721
f 440/726/720 556/727/721 439/728/722
f 439/728/722 556/727/721 555/729/723
f 439/728/722 555/729/723 438/730/724
f 438/730/724 555/729/723 554/731/725
f 438/730/724 554/731/725 437/732/726
f 437/732/726 554/731/725 553/733/727
f 437/732/726 553/733/727 436/734/728
f 436/734/728 553/733/727 552/735/729
f 436/734/728 552/735/729 435/736/730
f 435/736/730 552/735/729 551/737/731
f 435/736/730 551/737/731 434/738/732
f 434/738/732 551/737/731 550/739/733
f 434/738/732 550/739/733 433/740/734
f 433/740/734 550/739/733 549/741/735
f 433/740/734 549/741/735 432/742/736
f 432/742/736 549/741/735 548/743/737
f 432/742/736 548/743/737 431/744/738
f 431/744/738 548/743/737 547/745/739
f 431/744/738 547/745/739 430/746/740
f 430/746/740 547/745/739 546/747/741
f 430/746/740 546/747/741 429/748/742
f 429/748/742 546/747/741 545/749/743
f 429/748/742 545/749/743 428/750/744
f 428/750/744 545/749/743 544/751/745
f 428/750/744 544/751/745 427/752/746
f 427/752/746 544/751/745 543/753/747
f 427/752/746 543/753/747 426/754/748
f 426/754/748 543/753/747 542/755/749
f 426/754/748 542/755/749 425/756/750
f 425/756/750 542/755/749 541/757/751
f 425/756/750 541/757/751 424/758/752
f 424/758/752 541/757/751 540/759/753
f 424/758/752 540/759/753 423/760/754
f 423/760/754 540/759/753 539/761/755
f 423/760/754 539/761/755 422/762/756
f 422/762/756 539/761/755 538/763/757
f 422/762/756 538/763/757 421/764/758
f 421/764/758 538/763/757 537/765/759
f 421/764/758 537/765/759 420/766/760
f 420/766/760 537/765/759 536/767/761
f 420/766/760 536/767/761 419/768/762
f 419/768/762 536/767/761 535/769/763
f 419/768/762 535/769/763 418/770/764
f 418/770/764 535/769/763 534/771/765
f 418/770/764 534/771/765 417/772/766
f 417/772/766 534/771/765 533/773/767
f 417/772/766 533/773/767 416/774/768
f 416/774/768 533/773/767 532/775/769
f 416/774/768 532/775/769 415/776/770
f 415/776/770 532/775/769 531/777/771
f 415/776/770 531/777/771 414/778/772
f 414/778/772 531/777/771 530/779/773
f 414/778/772 530/779/773 413/780/774
f 413/780/774 530/779/773 529/781/775
f 413/780/774 529/781/775 412/782/776
f 412/782/776 529/781/775 528/783/777
f 412/782/776 528/783/777 411/784/778
f 411/784/778 528/783/777 527/785/779
f 411/784/778 527/785/779 410/786/780
f 410/786/780 527/785/779 526/787/781
f 410/786/780 526/787/781 409/788/782
f 409/788/782 526/787/781 525/789/783
f 409/788/782 525/789/783 408/790/784
f 408/790/784 525/789/783 524/791/785
f 408/790/784 524/791/785 407/792/786
f 407/792/786 524/791/785 523/793/787
f 407/792/786 523/793/787 406/794/788
f 406/794/788 523/793/787 522/795/789
f 406/794/788 522/795/789 405/796/790
f 405/796/790 522/795/789 521/797/791
f 405/796/790 521/797/791 404/798/792
f 404/798/792 521/797/791 520/799/793
f 404/798/792 520/799/793 403/800/794
f 403/800/794 520/799/793 519/801/795
f 403/800/794 519/801/795 402/802/796
f 402/802/796 519/801/795 518/803/797
f 402/802/796 518/803/797 401/804/798
f 401/804/798 518/803/797 517/805/799
f 401/804/798 517/805/799 400/806/800
f 400/806/800 517/805/799 516/807/801
f 400/806/800 516/807/801 399/808/802
f 399/808/802 516/807/801 515/809/803
f 399/808/802 515/809/803 398/810/804
f 398/810/804 515/809/803 514/811/805
f 398/810/804 514/811/805 397/812/806
f 397/812/806 514/811/805 513/813/807
f 397/812/806 513/813/807 396/696/692
f 396/696/692 513/813/807 512/697/693
f 454/814/808 568/703/697 453/815/809
f 453/815/809 568/703/697 511/701/695
f 453/816/809 511/699/695 510/817/810
f 510/817/810 511/699/695 512/697/693
f 510/817/810 512/697/693 509/818/811
f 509/818/811 512/697/693 513/813/807
f 509/818/811 513/813/807 508/819/812
f 508/819/812 513/813/807 514/811/805
f 508/819/812 514/811/805 507/820/813
f 507/820/813 514/811/805 515/809/803
f 507/820/813 515/809/803 506/821/814
f 506/821/814 515/809/803 516/807/801
f 506/821/814 516/807/801 505/822/815
f 505/822/815 516/807/801 517/805/799
f 505/822/815 517/805/799 504/823/816
f 504/823/816 517/805/799 518/803/797
f 504/823/816 518/803/797 503/824/817
f 503/824/817 518/803/797 519/801/795
f 503/824/817 519/801/795 502/825/818
f 502/825/818 519/801/795 520/799/793
f 502/825/818 520/799/793 501/826/819
f 501/826/819 520/799/793 521/797/791
f 501/826/819 521/797/791 500/827/820
f 500/827/820 521/797/791 522/795/789
f 500/827/820 522/795/789 499/828/821
f 499/828/821 522/795/789 523/793/787
f 499/828/821 523/793/787 498/829/822
f 498/829/822 523/793/787 524/791/785
f 498/829/822 524/791/785 497/830/823
f 497/830/823 524/791/785 525/789/783
f 497/830/823 525/789/783 496/831/824
f 496/831/824 525/789/783 526/787/781
f 496/831/824 526/787/781 495/832/825
f 495/832/825 526/787/781 527/785/779
f 495/832/825 527/785/779 494/833/826
f 494/833/826 527/785/779 528/783/777
f 494/833/826 528/783/777 493/834/827
f 493/834/827 528/783/777 529/781/775
f 493/834/827 529/781/775 492/835/828
f 492/835/828 529/781/775 530/779/773
f 492/835/828 530/779/773 491/836/829
f 491/836/829 530/779/773 531/777/771
f 491/836/829 531/777/771 490/837/830
f 490/837/830 531/777/771 532/775/769
f 490/837/830 532/775/769 489/838/831
f 489/838/831 532/775/769 533/773/767
f 489/838/831 533/773/767 488/839/832
f 488/839/832 533/773/767 534/771/765
f 488/839/832 534/771/765 487/840/833
f 487/840/833 534/771/765 535/769/763
f 487/840/833 535/769/763 486/841/834
f 486/841/834 535/769/763 536/767/761
f 486/841/834 536/767/761 485/842/835
f 485/842/835 536/767/761 537/765/759
f 485/842/835 537/765/759 484/843/836
f 484/843/836 537/765/759 538/763/757
f 484/843/836 538/763/757 483/844/837
f 483/844/837 538/763/757 539/761/755
f 483/844/837 539/761/755 482/845/838
f 482/845/838 539/761/755 540/759/753
f 482/845/838 540/759/753 481/846/839
f 481/846/839 540/759/753 541/757/751
f 481/846/839 541/757/751 480/847/840
f 480/847/840 541/757/751 542/755/749
f 480/847/840 542/755/749 479/848/841
f 479/848/841 542/755/749 543/753/747
f 479/848/841 543/753/747 478/849/842
f 478/849/842 543/753/747 544/751/745
f 478/849/842 544/751/745 477/850/843
f 477/850/843 544/751/745 545/749/743
f 477/850/843 545/749/743 476/851/844
f 476/851/844 545/749/743 546/747/741
f 476/851/844 546/747/741 475/852/845
f 475/852/845 546/747/741 547/745/739
f 475/852/845 547/745/739 474/853/846
f 474/853/846 547/745/739 548/743/737
f 474/853/846 548/743/737 473/854/847
f 473/854/847 548/743/737 549/741/735
f 473/854/847 549/741/735 472/855/848
f 472/855/848 549/741/735 550/739/733
f 472/855/848 550/739/733 471/856/849
f 471/856/849 550/739/733 551/737/731
f 471/856/849 551/737/731 470/857/850
f 470/857/850 551/737/731 552/735/729
f 470/857/850 552/735/729 469/858/851
f 469/858/851 552/735/729 553/733/727
f 469/858/851 553/733/727 468/859/852
f 468/859/852 553/733/727 554/731/725
f 468/859/852 554/731/725 467/860/853
f 467/860/853 554/731/725 555/729/723
f 467/860/853 555/729/723 466/861/854
f 466/861/854 555/729/723 556/727/721
f 466/861/854 556/727/721 465/862/855
f 465/862/855 556/727/721 557/725/719
f 465/862/855 557/725/719 464/863/856
f 464/863/856 557/725/719 558/723/717
f 464/863/856 558/723/717 463/864/857
f 463/864/857 558/723/717 559/721/715
f 463/864/857 559/721/715 462/865/858
f 462/865/858 559/721/715 560/719/713
f 462/865/858 560/719/713 461/866/859
f 461/866/859 560/719/713 561/717/711
f 461/866/859 561/717/711 460/867/860
f 460/867/860 561/717/711 562/715/709
f 460/867/860 562/715/709 459/868/861
f 459/868/861 562/715/709 563/713/707
f 459/868/861 563/713/707 458/869/862
f 458/869/862 563/713/707 564/711/705
f 458/869/862 564/711/705 457/870/863
f 457/870/863 564/711/705 565/709/703
f 457/870/863 565/709/703 456/871/864
f 456/871/864 565/709/703 566/707/701
f 456/871/864 566/707/701 455/872/865
f 455/872/865 566/707/701 567/705/699
f 455/872/865 567/705/699 454/814/808
f 454/814/808 567/705/699 568/703/697
f 285/873/866 396/874/867 249/875/868
f 249/875/868 396/874/867 395/876/869
f 249/875/868 395/876/869 452/877/870
f 396/874/867 285/873/866 397/878/871
f 397/878/871 285/873/866 284/879/872
f 397/878/871 284/879/872 398/880/873
f 398/880/873 284/879/872 399/881/874
f 399/881/874 284/879/872 283/882/875
f 399/881/874 283/882/875 400/883/876
f 400/883/876 283/882/875 282/884/877
f 400/883/876 282/884/877 401/885/878
f 401/885/878 282/884/877 402/886/879
f 402/886/879 282/884/877 281/887/880
f 402/886/879 281/887/880 403/888/881
f 403/888/881 281/887/880 404/889/882
f 404/889/882 281/887/880 280/890/883
f 404/889/882 280/890/883 405/891/884
f 405/891/884 280/890/883 279/892/885
f 405/891/884 279/892/885 406/893/886
f 406/893/886 279/892/885 407/894/887
f 407/894/887 279/892/885 278/895/888
f 407/894/887 278/895/888 408/896/889
f 408/896/889 278/895/888 277/897/890
f 408/896/889 277/897/890 409/898/891
f 409/898/891 277/897/890 410/899/892
f 410/899/892 277/897/890 276/900/893
f 410/899/892 276/900/893 411/901/894
f 411/901/894 276/900/893 275/902/895
f 411/901/894 275/902/895 412/903/896
f 412/903/896 275/902/895 413/904/897
f 413/904/897 275/902/895 274/905/898
f 413/904/897 274/905/898 414/906/899
f 414/906/899 274/905/898 415/907/900
f 415/907/900 274/905/898 273/908/901
f 415/907/900 273/908/901 416/909/902
f 416/909/902 273/908/901 272/910/903
f 416/909/902 272/910/903 417/911/904
f 417/911/904 272/910/903 418/912/905
f 418/912/905 272/910/903 271/913/906
f 418/912/905 271/913/906 419/914/907
f 419/914/907 271/913/906 270/915/908
f 419/914/907 270/915/908 420/916/909
f 420/916/909 270/915/908 421/917/910
f 421/917/910 270/915/908 269/918/911
f 421/917/910 269/918/911 422/919/912
f 422/919/912 269/918/911 268/920/913
f 422/919/912 268/920/913 423/921/914
f 423/921/914 268/920/913 424/922/915
f 424/922/915 268/920/913 267/923/916
f 424/922/915 267/923/916 425/924/917
f 425/924/917 267/923/916 426/925/918
f 426/925/918 267/923/916 266/926/919
f 426/925/918 266/926/919 427/927/920
f 427/927/920 266/926/919 265/928/921
f 427/927/920 265/928/921 428/929/922
f 428/929/922 265/928/921 429/930/923
f 429/930/923 265/928/921 264/931/924
f 429/930/923 264/931/924 430/932/925
f 430/932/925 264/931/924 263/933/926
f 430/932/925 263/933/926 431/934/927
f 431/934/927 263/933/926 432/935/928
f 432/935/928 263/933/926 262/936/929
f 432/935/928 262/936/929 433/937/930
f 433/937/930 262/936/929 261/938/931
f 433/937/930 261/938/931 434/939/932
f 434/939/932 261/938/931 435/940/933
f 435/940/933 261/938/931 260/941/934
f 435/940/933 260/941/934 436/942/935
f 436/942/935 260/941/934 437/943/936
f 437/943/936 260/941/934 259/944/937
f 437/943/936 259/944/937 438/945/938
f 438/945/938 259/944/937 258/946/939
f 438/945/938 258/946/939 439/947/940
f 439/947/940 258/946/939 440/948/941
f 440/948/941 258/946/939 257/949/942
f 440/948/941 257/949/942 441/950/943
f 441/950/943 257/949/942 256/951/944
f 441/950/943 256/951/944 442/952/945
f 442/952/945 256/951/944 443/953/946
f 443/953/946 256/951/944 255/954/947
f 443/953/946 255/954/947 444/955/948
f 444/955/948 255/954/947 254/956/949
f 444/955/948 254/956/949 445/957/950
f 445/957/950 254/956/949 446/958/951
f 446/958/951 254/956/949 253/959/952
f 446/958/951 253/959/952 447/960/953
f 447/960/953 253/959/952 448/961/954
f 448/961/954 253/959/952 252/962/955
f 448/961/954 252/962/955 449/963/956
f 449/963/956 252/962/955 251/964/957
f 449/963/956 251/964/957 450/965/958
f 450/965/958 251/964/957 451/966/959
f 451/966/959 251/964/957 250/967/960
f 451/966/959 250/967/960 452/877/870
f 452/877/870 250/967/960 249/875/868
f 570/968/961 458/969/962 569/970/963
f 569/970/963 458/969/962 457/971/964
f 569/970/963 457/971/964 456/972/965
f 571/973/966 467/974/967 570/968/961
f 570/968/961 467/974/967 466/975/968
f 570/968/961 466/975/968 465/976/969
f 572/977/970 476/978/971 571/973/966
f 571/973/966 476/978/971 475/979/972
f 571/973/966 475/979/972 474/980/973
f 248/981/974 487/982/975 572/977/970
f 572/977/970 487/982/975 486/983/976
f 572/977/970 486/983/976 485/984/977
f 247/985/978 496/986/979 248/981/974
f 248/981/974 496/986/979 495/987/980
f 248/981/974 495/987/980 494/988/981
f 569/970/963 505/989/982 247/985/978
f 247/985/978 505/989/982 504/990/983
f 247/985/978 504/990/983 503/991/984
f 454/992/985 453/993/986 569/970/963
f 569/970/963 453/993/986 510/994/987
f 569/970/963 510/994/987 509/995/988
f 509/995/988 508/996/989 569/970/963
f 569/970/963 508/996/989 507/997/990
f 569/970/963 507/997/990 506/998/991
f 506/998/991 505/989/982 569/970/963
f 503/991/984 502/999/992 247/985/978
f 247/985/978 502/999/992 501/1000/993
f 247/985/978 501/1000/993 500/1001/994
f 500/1001/994 499/1002/995 247/985/978
f 247/985/978 499/1002/995 498/1003/996
f 247/985/978 498/1003/996 497/1004/997
f 497/1004/997 496/986/979 247/985/978
f 494/988/981 493/1005/998 248/981/974
f 248/981/974 493/1005/998 492/1006/999
f 248/981/974 492/1006/999 491/1007/1000
f 491/1007/1000 490/1008/1001 248/981/974
f 248/981/974 490/1008/1001 489/1009/1002
f 248/981/974 489/1009/1002 488/1010/1003
f 488/1010/1003 487/982/975 248/981/974
f 485/984/977 484/1011/1004 572/977/970
f 572/977/970 484/1011/1004 483/1012/1005
f 572/977/970 483/1012/1005 482/1013/1006
f 482/1013/1006 481/1014/1007 572/977/970
f 572/977/970 481/1014/1007 480/1015/1008
f 572/977/970 480/1015/1008 479/1016/1009
f 479/1016/1009 478/1017/1010 572/977/970
f 572/977/970 478/1017/1010 477/1018/1011
f 572/977/970 477/1018/1011 476/978/971
f 474/980/973 473/1019/1012 571/973/966
f 571/973/966 473/1019/1012 472/1020/1013
f 571/973/966 472/1020/1013 471/1021/1014
f 471/1021/1014 470/1022/1015 571/973/966
f 571/973/966 470/1022/1015 469/1023/1016
f 571/973/966 469/1023/1016 468/1024/1017
f 468/1024/1017 467/974/967 571/973/966
f 465/976/969 464/1025/1018 570/968/961
f 570/968/961 464/1025/1018 463/1026/1019
f 570/968/961 463/1026/1019 462/1027/1020
f 462/1027/1020 461/1028/1021 570/968/961
f 570/968/961 461/1028/1021 460/1029/1022
f 570/968/961 460/1029/1022 459/1030/1023
f 459/1030/1023 458/969/962 570/968/961
f 456/972/965 455/1031/1024 569/970/963
f 569/970/963 455/1031/1024 454/992/985
f 574/1032/1025 611/1033/1026 573/1034/1027
f 573/1034/1027 611/1033/1026 612/1035/1028
f 573/1034/1027 612/1035/1028 613/1036/1029
f 246/1037/1030 600/1038/1031 574/1032/1025
f 574/1032/1025 600/1038/1031 601/1039/1032
f 574/1032/1025 601/1039/1032 602/1040/1033
f 245/1041/1034 591/1042/1035 246/1037/1030
f 246/1037/1030 591/1042/1035 592/1043/1036
f 246/1037/1030 592/1043/1036 593/1044/1037
f 575/1045/1038 582/1046/1039 245/1041/1034
f 245/1041/1034 582/1046/1039 583/1047/1040
f 245/1041/1034 583/1047/1040 584/1048/1041
f 576/1049/1042 629/1050/1043 575/1045/1038
f 575/1045/1038 629/1050/1043 630/1051/1044
f 575/1045/1038 630/1051/1044 631/1052/1045
f 573/1034/1027 620/1053/1046 576/1049/1042
f 576/1049/1042 620/1053/1046 621/1054/1047
f 576/1049/1042 621/1054/1047 622/1055/1048
f 634/1056/1049 577/1057/1050 575/1045/1038
f 575/1045/1038 577/1057/1050 578/1058/1051
f 575/1045/1038 578/1058/1051 579/1059/1052
f 579/1059/1052 580/1060/1053 575/1045/1038
f 575/1045/1038 580/1060/1053 581/1061/1054
f 575/1045/1038 581/1061/1054 582/1046/1039
f 584/1048/1041 585/1062/1055 245/1041/1034
f 245/1041/1034 585/1062/1055 586/1063/1056
f 245/1041/1034 586/1063/1056 587/1064/1057
f 587/1064/1057 588/1065/1058 245/1041/1034
f 245/1041/1034 588/1065/1058 589/1066/1059
f 245/1041/1034 589/1066/1059 590/1067/1060
f 590/1067/1060 591/1042/1035 245/1041/1034
f 593/1044/1037 594/1068/1061 246/1037/1030
f 246/1037/1030 594/1068/1061 595/1069/1062
f 246/1037/1030 595/1069/1062 596/1070/1063
f 596/1070/1063 597/1071/1064 246/1037/1030
f 246/1037/1030 597/1071/1064 598/1072/1065
f 246/1037/1030 598/1072/1065 599/1073/1066
f 599/1073/1066 600/1038/1031 246/1037/1030
f 602/1040/1033 603/1074/1067 574/1032/1025
f 574/1032/1025 603/1074/1067 604/1075/1068
f 574/1032/1025 604/1075/1068 605/1076/1069
f 605/1076/1069 606/1077/1070 574/1032/1025
f 574/1032/1025 606/1077/1070 607/1078/1071
f 574/1032/1025 607/1078/1071 608/1079/1072
f 608/1079/1072 609/1080/1073 574/1032/1025
f 574/1032/1025 609/1080/1073 610/1081/1074
f 574/1032/1025 610/1081/1074 611/1033/1026
f 613/1036/1029 614/1082/1075 573/1034/1027
f 573/1034/1027 614/1082/1075 615/1083/1076
f 573/1034/1027 615/1083/1076 616/1084/1077
f 616/1084/1077 617/1085/1078 573/1034/1027
f 573/1034/1027 617/1085/1078 618/1086/1079
f 573/1034/1027 618/1086/1079 619/1087/1080
f 619/1087/1080 620/1053/1046 573/1034/1027
f 622/1055/1048 623/1088/1081 576/1049/1042
f 576/1049/1042 623/1088/1081 624/1089/1082
f 576/1049/1042 624/1089/1082 625/1090/1083
f 625/1090/1083 626/1091/1084 576/1049/1042
f 576/1049/1042 626/1091/1084 627/1092/1085
f 576/1049/1042 627/1092/1085 628/1093/1086
f 628/1093/1086 629/1050/1043 576/1049/1042
f 631/1052/1045 632/1094/1087 575/1045/1038
f 575/1045/1038 632/1094/1087 633/1095/1088
f 575/1045/1038 633/1095/1088 634/1056/1049
f 246/1096/1089 574/1097/1090 247/1098/1091
f 247/1098/1091 574/1097/1090 569/1099/1092
f 11/1100/1093 5/1101/1094 35/1102/1095
f 35/1102/1095 5/1101/1094 4/1103/1096
f 35/1102/1095 4/1103/1096 3/1104/1097
f 3/1104/1097 2/1105/1098 35/1102/1095
f 35/1102/1095 2/1105/1098 67/1106/1099
f 35/1102/1095 67/1106/1099 66/1107/1100
f 2/1105/1098 1/1108/1101 67/1106/1099
f 66/1107/1100 65/1109/1102 35/1102/1095
f 35/1102/1095 65/1109/1102 36/1110/1103
f 36/1110/1103 65/1109/1102 60/1111/1104
f 36/1110/1103 60/1111/1104 41/1112/1105
f 41/1112/1105 60/1111/1104 59/1113/1106
f 41/1112/1105 59/1113/1106 42/1114/1107
f 42/1114/1107 59/1113/1106 43/1115/1108
f 43/1115/1108 59/1113/1106 58/1116/1109
f 43/1115/1108 58/1116/1109 44/1117/1110
f 44/1117/1110 58/1116/1109 57/1118/1111
f 44/1117/1110 57/1118/1111 49/1119/1112
f 49/1119/1112 57/1118/1111 51/1120/1113
f 49/1119/1112 51/1120/1113 50/1121/1114
f 57/1118/1111 52/1122/1115 51/1120/1113
f 34/1123/1116 19/1124/1117 35/1102/1095
f 35/1102/1095 19/1124/1117 14/1125/1118
f 35/1102/1095 14/1125/1118 13/1126/1119
f 19/1124/1117 34/1123/1116 20/1127/1120
f 20/1127/1120 34/1123/1116 33/1128/1121
f 20/1127/1120 33/1128/1121 21/1129/1122
f 21/1129/1122 33/1128/1121 31/1130/1123
f 21/1129/1122 31/1130/1123 22/1131/1124
f 22/1131/1124 31/1130/1123 29/1132/1125
f 22/1131/1124 29/1132/1125 27/1133/1126
f 13/1126/1119 12/1134/1127 35/1102/1095
f 35/1102/1095 12/1134/1127 11/1100/1093
f 575/1135/1128 245/1136/1129 572/1137/1130
f 572/1137/1130 245/1136/1129 248/1138/1131
f 576/1139/1132 575/1140/1133 571/1141/1134
f 571/1141/1134 575/1140/1133 572/1142/1135
f 573/1143/1136 576/1144/1137 570/1145/1138
f 570/1145/1138 576/1144/1137 571/1146/1139
f 574/1147/1140 573/1148/1141 569/1149/1142
f 569/1149/1142 573/1148/1141 570/1150/1143
f 287/1151/1144 286/1152/1145 301/1153/1146
f 301/1153/1146 286/1152/1145 322/1154/1147
f 301/1153/1146 322/1154/1147 321/1155/1148
f 321/1155/1148 320/1156/1149 301/1153/1146
f 301/1153/1146 320/1156/1149 319/1157/1150
f 301/1153/1146 319/1157/1150 318/1158/1151
f 318/1158/1151 317/1159/1152 301/1153/1146
f 301/1153/1146 317/1159/1152 316/1160/1153
f 301/1153/1146 316/1160/1153 315/1161/1154
f 315/1161/1154 314/1162/1155 301/1153/1146
f 301/1153/1146 314/1162/1155 313/1163/1156
f 301/1153/1146 313/1163/1156 312/1164/1157
f 312/1164/1157 311/1165/1158 301/1153/1146
f 301/1153/1146 311/1165/1158 310/1166/1159
f 301/1153/1146 310/1166/1159 309/1167/1160
f 309/1167/1160 308/1168/1161 301/1153/1146
f 301/1153/1146 308/1168/1161 302/1169/1162
f 302/1169/1162 308/1168/1161 307/1170/1163
f 302/1169/1162 307/1170/1163 303/1171/1164
f 303/1171/1164 307/1170/1163 306/1172/1165
f 303/1171/1164 306/1172/1165 304/1173/1166
f 304/1173/1166 306/1172/1165 305/1174/1167
f 300/1175/1168 290/1176/1169 301/1153/1146
f 301/1153/1146 290/1176/1169 289/1177/1170
f 301/1153/1146 289/1177/1170 288/1178/1171
f 290/1176/1169 300/1175/1168 291/1179/1172
f 291/1179/1172 300/1175/1168 299/1180/1173
f 291/1179/1172 299/1180/1173 292/1181/1174
f 292/1181/1174 299/1180/1173 298/1182/1175
f 292/1181/1174 298/1182/1175 293/1183/1176
f 293/1183/1176 298/1182/1175 297/1184/1177
f 293/1183/1176 297/1184/1177 294/1185/1178
f 294/1185/1178 297/1184/1177 296/1186/1179
f 294/1185/1178 296/1186/1179 295/1187/1180
f 288/1178/1171 287/1151/1144 301/1153/1146
f 636/1188/1181 659/1189/1182 635/1190/1183
f 638/1191/1184 659/1192/1185 637/1193/1186
f 640/1194/1187 659/1195/1188 639/1196/1189
f 642/1197/1190 659/1198/1191 641/1199/1192
f 644/1200/1193 659/1201/1194 643/1202/1195
f 646/1203/1196 659/1204/1197 645/1205/1198
f 648/1206/1199 659/1207/1200 647/1208/1201
f 650/1209/1202 659/1210/1203 649/1211/1204
f 652/1212/1205 659/1213/1206 651/1214/1207
f 654/1215/1208 659/1216/1209 653/1217/1210
f 656/1218/1211 659/1219/1212 655/1220/1213
f 658/1221/1214 659/1222/1215 657/1223/1216
f 635/1224/1183 659/1225/1217 658/1221/1214
f 651/1214/1207 659/1226/1218 650/1209/1202
f 643/1202/1195 659/1227/1219 642/1197/1190
f 657/1223/1216 659/1228/1220 656/1218/1211
f 655/1220/1213 659/1229/1221 654/1215/1208
f 653/1217/1210 659/1230/1222 652/1212/1205
f 649/1211/1204 659/1231/1223 648/1206/1199
f 647/1208/1201 659/1232/1224 646/1203/1196
f 645/1205/1198 659/1233/1225 644/1200/1193
f 641/1199/1192 659/1234/1226 640/1194/1187
f 639/1196/1189 659/1235/1227 638/1191/1184
f 637/1193/1186 659/1236/1228 636/1188/1181
f 578/1237/1229 577/1238/1230 660/1239/1231
f 660/1240/1231 577/1241/1230 634/1242/1232
f 660/1240/1231 634/1242/1232 696/1243/1233
f 696/1243/1233 634/1242/1232 633/1244/1234
f 696/1243/1233 633/1244/1234 695/1245/1235
f 695/1245/1235 633/1244/1234 632/1246/1236
f 695/1245/1235 632/1246/1236 631/1247/1237
f 695/1245/1235 631/1247/1237 694/1248/1238
f 694/1248/1238 631/1247/1237 630/1249/1239
f 694/1248/1238 630/1249/1239 693/1250/1240
f 693/1250/1240 630/1249/1239 629/1251/1241
f 693/1250/1240 629/1251/1241 628/1252/1242
f 693/1250/1240 628/1252/1242 692/1253/1243
f 692/1253/1243 628/1252/1242 627/1254/1244
f 692/1253/1243 627/1254/1244 626/1255/1245
f 692/1253/1243 626/1255/1245 691/1256/1246
f 691/1256/1246 626/1255/1245 625/1257/1247
f 691/1256/1246 625/1257/1247 690/1258/1248
f 690/1258/1248 625/1257/1247 624/1259/1249
f 690/1258/1248 624/1259/1249 623/1260/1250
f 690/1258/1248 623/1260/1250 689/1261/1251
f 689/1261/1251 623/1260/1250 622/1262/1252
f 689/1261/1251 622/1262/1252 688/1263/1253
f 688/1263/1253 622/1262/1252 621/1264/1254
f 688/1263/1253 621/1264/1254 620/1265/1255
f 688/1263/1253 620/1265/1255 687/1266/1256
f 687/1266/1256 620/1265/1255 619/1267/1257
f 687/1266/1256 619/1267/1257 686/1268/1258
f 686/1268/1258 619/1267/1257 618/1269/1259
f 686/1268/1258 618/1269/1259 617/1270/1260
f 686/1268/1258 617/1270/1260 685/1271/1261
f 685/1271/1261 617/1270/1260 616/1272/1262
f 685/1271/1261 616/1272/1262 615/1273/1263
f 685/1271/1261 615/1273/1263 684/1274/1264
f 684/1274/1264 615/1273/1263 614/1275/1265
f 684/1274/1264 614/1275/1265 683/1276/1266
f 683/1276/1266 614/1275/1265 613/1277/1267
f 683/1276/1266 613/1277/1267 612/1278/1268
f 683/1276/1266 612/1278/1268 682/1279/1269
f 682/1279/1269 612/1278/1268 611/1280/1270
f 682/1279/1269 611/1280/1270 681/1281/1271
f 681/1281/1271 611/1280/1270 610/1282/1272
f 681/1281/1271 610/1282/1272 609/1283/1273
f 681/1281/1271 609/1283/1273 680/1284/1274
f 680/1284/1274 609/1283/1273 608/1285/1275
f 680/1284/1274 608/1285/1275 679/1286/1276
f 679/1286/1276 608/1285/1275 607/1287/1277
f 679/1286/1276 607/1287/1277 606/1288/1278
f 679/1286/1276 606/1288/1278 678/1289/1279
f 678/1289/1279 606/1288/1278 605/1290/1280
f 678/1289/1279 605/1290/1280 604/1291/1281
f 678/1289/1279 604/1291/1281 677/1292/1282
f 677/1292/1282 604/1291/1281 603/1293/1283
f 677/1292/1282 603/1293/1283 676/1294/1284
f 676/1294/1284 603/1293/1283 602/1295/1285
f 676/1294/1284 602/1295/1285 601/1296/1286
f 676/1294/1284 601/1296/1286 675/1297/1287
f 675/1297/1287 601/1296/1286 600/1298/1288
f 675/1297/1287 600/1298/1288 674/1299/1289
f 674/1299/1289 600/1298/1288 599/1300/1290
f 674/1299/1289 599/1300/1290 598/1301/1291
f 674/1299/1289 598/1301/1291 673/1302/1292
f 673/1302/1292 598/1301/1291 597/1303/1293
f 673/1302/1292 597/1303/1293 672/1304/1294
f 672/1304/1294 597/1303/1293 596/1305/1295
f 672/1304/1294 596/1305/1295 595/1306/1296
f 672/1304/1294 595/1306/1296 671/1307/1297
f 671/1307/1297 595/1306/1296 594/1308/1298
f 671/1307/1297 594/1308/1298 593/1309/1299
f 671/1307/1297 593/1309/1299 670/1310/1300
f 670/1310/1300 593/1309/1299 592/1311/1301
f 670/1310/1300 592/1311/1301 669/1312/1302
f 669/1312/1302 592/1311/1301 591/1313/1303
f 669/1312/1302 591/1313/1303 590/1314/1304
f 669/1312/1302 590/1314/1304 668/1315/1305
f 668/1315/1305 590/1314/1304 589/1316/1306
f 668/1315/1305 589/1316/1306 667/1317/1307
f 667/1317/1307 589/1316/1306 588/1318/1308
f 667/1317/1307 588/1318/1308 587/1319/1309
f 667/1317/1307 587/1319/1309 666/1320/1310
f 666/1320/1310 587/1319/1309 586/1321/1311
f 666/1320/1310 586/1321/1311 665/1322/1312
f 665/1322/1312 586/1321/1311 585/1323/1313
f 665/1322/1312 585/1323/1313 584/1324/1314
f 665/1322/1312 584/1324/1314 664/1325/1315
f 664/1325/1315 584/1324/1314 583/1326/1316
f 664/1325/1315 583/1326/1316 582/1327/1317
f 664/1325/1315 582/1327/1317 663/1328/1318
f 663/1328/1318 582/1327/1317 581/1329/1319
f 663/1328/1318 581/1329/1319 662/1330/1320
f 662/1330/1320 581/1329/1319 580/1331/1321
f 662/1330/1320 580/1331/1321 579/1332/1322
f 662/1330/1320 579/1332/1322 661/1333/1323
f 661/1333/1323 579/1332/1322 578/1237/1229
f 661/1333/1323 578/1237/1229 660/1239/1231
f 658/1334/1324 661/1335/1325 635/1336/1326
f 635/1336/1326 661/1335/1325 660/1337/1327
f 635/1336/1326 660/1337/1327 696/1338/1328
f 661/1335/1325 658/1334/1324 662/1339/1329
f 662/1339/1329 658/1334/1324 657/1340/1330
f 662/1339/1329 657/1340/1330 663/1341/1331
f 663/1341/1331 657/1340/1330 664/1342/1332
f 664/1342/1332 657/1340/1330 656/1343/1333
f 664/1342/1332 656/1343/1333 665/1344/1334
f 665/1344/1334 656/1343/1333 655/1345/1335
f 665/1344/1334 655/1345/1335 666/1346/1336
f 666/1346/1336 655/1345/1335 667/1347/1337
f 667/1347/1337 655/1345/1335 654/1348/1338
f 667/1347/1337 654/1348/1338 668/1349/1339
f 668/1349/1339 654/1348/1338 653/1350/1340
f 668/1349/1339 653/1350/1340 669/1351/1341
f 669/1351/1341 653/1350/1340 670/1352/1342
f 670/1352/1342 653/1350/1340 652/1353/1343
f 670/1352/1342 652/1353/1343 671/1354/1344
f 671/1354/1344 652/1353/1343 672/1355/1345
f 672/1355/1345 652/1353/1343 651/1356/1346
f 672/1355/1345 651/1356/1346 673/1357/1347
f 673/1357/1347 651/1356/1346 650/1358/1348
f 673/1357/1347 650/1358/1348 674/1359/1349
f 674/1359/1349 650/1358/1348 675/1360/1350
f 675/1360/1350 650/1358/1348 649/1361/1351
f 675/1360/1350 649/1361/1351 676/1362/1352
f 676/1362/1352 649/1361/1351 648/1363/1353
f 676/1362/1352 648/1363/1353 677/1364/1354
f 677/1364/1354 648/1363/1353 678/1365/1355
f 678/1365/1355 648/1363/1353 647/1366/1356
f 678/1365/1355 647/1366/1356 679/1367/1357
f 679/1367/1357 647/1366/1356 646/1368/1358
f 679/1367/1357 646/1368/1358 680/1369/1359
f 680/1369/1359 646/1368/1358 681/1370/1360
f 681/1370/1360 646/1368/1358 645/1371/1361
f 681/1370/1360 645/1371/1361 682/1372/1362
f 682/1372/1362 645/1371/1361 644/1373/1363
f 682/1372/1362 644/1373/1363 683/1374/1364
f 683/1374/1364 644/1373/1363 684/1375/1365
f 684/1375/1365 644/1373/1363 643/1376/1366
f 684/1375/1365 643/1376/1366 685/1377/1367
f 685/1377/1367 643/1376/1366 642/1378/1368
f 685/1377/1367 642/1378/1368 686/1379/1369
f 686/1379/1369 642/1378/1368 687/1380/1370
f 687/1380/1370 642/1378/1368 641/1381/1371
f 687/1380/1370 641/1381/1371 688/1382/1372
f 688/1382/1372 641/1381/1371 689/1383/1373
f 689/1383/1373 641/1381/1371 640/1384/1374
f 689/1383/1373 640/1384/1374 690/1385/1375
f 690/1385/1375 640/1384/1374 639/1386/1376
f 690/1385/1375 639/1386/1376 691/1387/1377
f 691/1387/1377 639/1386/1376 692/1388/1378
f 692/1388/1378 639/1386/1376 638/1389/1379
f 692/1388/1378 638/1389/1379 693/1390/1380
f 693/1390/1380 638/1389/1379 637/1391/1381
f 693/1390/1380 637/1391/1381 694/1392/1382
f 694/1392/1382 637/1391/1381 695/1393/1383
f 695/1393/1383 637/1391/1381 636/1394/1384
f 695/1393/1383 636/1394/1384 696/1338/1328
f 696/1338/1328 636/1394/1384 635/1336/1326
# 696 vertices
# 1394 texture params
# 1384 normals
# 1388 facets

# 1 groups
`,this.scene,void 0,void 0,void 0,".obj"),this.hqNozzle&&(this.toolCursorMesh=this.scene.getMeshByName("JRNozzle"),this.toolCursorMesh.parent=this.toolCursor,this.toolCursorMesh.rotate(ti.X,Math.PI/2,Ze.LOCAL),this.toolCursorMesh.rotate(ti.Y,Math.PI,Ze.LOCAL),this.toolCursorMesh.rotate(ti.Z,Math.PI,Ze.LOCAL),this.toolCursorMesh.scaling=new g(-1,1,1)),this.toolCursorMesh.isVisible=this.toolCursorVisible,this.toolCursorMesh.renderingGroupId=2,this.registerClipIgnore(this.toolCursorMesh);var s=new pe("nozzleMaterial",this.scene);this.toolCursorMesh.material=s,s.diffuseColor=new re(1,.766,.336)}}},{key:"updateRenderQuality",value:function(s){this.renderQuality=s,localStorage&&localStorage.setItem("renderQuality",s)}},{key:"registerClipIgnore",value:function(s){var r=this;s!=null&&(s.onBeforeRenderObservable.add(()=>{r.scene.clipPlane=null,r.scene.clipPlane2=null}),s.onAfterRenderObservable.add(()=>{r.scene.clipPlane=new Hi(0,1,0,r.zTopClipValue),r.scene.clipPlane2=new Hi(0,-1,0,r.zBottomClipValue)}))}},{key:"updateCameraInertiaProperties",value:function(){this.cameraInertia?(this.orbitCamera.speed=2,this.orbitCamera.inertia=.9,this.orbitCamera.panningInertia=.9,this.orbitCamera.inputs.attached.keyboard.angularSpeed=.005,this.orbitCamera.inputs.attached.keyboard.zoomingSensibility=2,this.orbitCamera.inputs.attached.keyboard.panningSensibility=2,this.orbitCamera.angularSensibilityX=1e3,this.orbitCamera.angularSensibilityY=1e3,this.orbitCamera.panningSensibility=10,this.orbitCamera.wheelPrecision=1):(this.orbitCamera.speed=500,this.orbitCamera.inertia=0,this.orbitCamera.panningInertia=0,this.orbitCamera.inputs.attached.keyboard.angularSpeed=.05,this.orbitCamera.inputs.attached.keyboard.zoomingSensibility=.5,this.orbitCamera.inputs.attached.keyboard.panningSensibility=.5,this.orbitCamera.angularSensibilityX=200,this.orbitCamera.angularSensibilityY=200,this.orbitCamera.panningSensibility=2,this.orbitCamera.wheelPrecision=.25)}},{key:"setCameraInertia",value:function(s){this.cameraInertia=s,localStorage.setItem("cameraInertia",s),this.updateCameraInertiaProperties()}},{key:"forceRender",value:function(){this.scene&&this.scene.render(!0)}},{key:"getLayers",value:function(){return this.gcodeProcessor.layerDictionary}},{key:"getGCodeLine",value:function(){var s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:5;try{var r=Math.max(0,this.gcodeProcessor.currentLineNumber-s),n=Math.min(this.gcodeProcessor.currentLineNumber,this.fileDataArray.length-1);return this.fileDataArray.slice(r,n).join(`\r
`).trim()}catch{return""}}},{key:"getGCodeLineNumber",value:function(){return this.gcodeProcessor.currentLineNumber}},{key:"goToGCodeLine",value:function(s){}},{key:"simulateToolPosition",value:function(){this.updateToolPosition(this.gcodeProcessor.nozzlePosition)}}]),a}(),Nw=Object.defineProperty,Fw=Object.getOwnPropertyDescriptor,Ot=(a,e,t,i)=>{for(var s=i>1?void 0:i?Fw(e,t):e,r=a.length-1,n;r>=0;r--)(n=a[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&Nw(e,t,s),s};let fe=null,Ct=class extends Hp(Xp){constructor(){super(...arguments);Gt(this,"mdiReloadAlert",Tg);Gt(this,"mdiCameraRetake",bg);Gt(this,"mdiToggleSwitch",Sg);Gt(this,"mdiToggleSwitchOffOutline",Eg);Gt(this,"mdiClose",Cg);Gt(this,"mdiCog",yg);Gt(this,"mdiVideo3d",Ag);Gt(this,"mdiPlay",Rg);Gt(this,"mdiPause",Ig);Gt(this,"mdiFastForward",Pg);Gt(this,"mdiBroom",Mg);Gt(this,"mdiSelectionRemove",Dg);Gt(this,"formatFilesize",Og);Gt(this,"isBusy",!1);Gt(this,"loading",!1);Gt(this,"loadingPercent",0);Gt(this,"tracking",!1);Gt(this,"loadedFile",null);Gt(this,"reloadRequired",!1);Gt(this,"fileSize",0);Gt(this,"renderQuality",this.renderQualities[2]);Gt(this,"scrubPosition",0);Gt(this,"scrubPlaying",!1);Gt(this,"scrubSpeed",1);Gt(this,"scrubInterval");Gt(this,"scrubFileSize",0);Gt(this,"downloadSnackbar",{status:!1,filename:"",percent:0,speed:0,total:0,cancelTokenSource:{},lastProgress:{time:0,loaded:0}});Gt(this,"excludeObject",{bool:!1,name:""});Gt(this,"colorModes",[{text:"Extruder",value:0},{text:"Feed Rate",value:1},{text:"Feature",value:2}])}get renderQualities(){return[{label:this.$t("GCodeViewer.Low"),value:2},{label:this.$t("GCodeViewer.Medium"),value:3},{label:this.$t("GCodeViewer.High"),value:4},{label:this.$t("GCodeViewer.Ultra"),value:5},{label:this.$t("GCodeViewer.Max"),value:6}]}async mounted(){var e,t,i,s;this.loadedFile=(t=(e=this.$store.state.gcodeviewer)==null?void 0:e.loadedFileBackup)!=null?t:null,fe=(s=(i=this.$store.state.gcodeviewer)==null?void 0:i.viewerBackup)!=null?s:null,await this.init(),this.loadedFile!==null&&(this.scrubFileSize=fe.fileSize)}beforeDestroy(){fe&&(fe.gcodeProcessor.loadingProgressCallback=null,this.$store.dispatch("gcodeviewer/setLoadedFileBackup",this.loadedFile),this.$store.dispatch("gcodeviewer/setViewerBackup",fe)),this.scrubPlaying=!1,this.scrubInterval&&(clearInterval(this.scrubInterval),this.scrubInterval=void 0)}handleResize(){this.$nextTick(()=>{fe==null||fe.resize()})}get panelTitle(){let e=this.$t("GCodeViewer.Title").toString();return this.loadedFile&&(e+=`: ${this.loadedFile}`),e}get filePosition(){return this.printerIsPrinting?this.$store.state.printer.virtual_sdcard.file_position:0}get sdCardFilePath(){var e,t;return(t=(e=this.$store.state.printer.print_stats)==null?void 0:e.filename)!=null?t:""}get currentPosition(){var e,t;return(t=(e=this.$store.state.printer.motion_report)==null?void 0:e.live_position)!=null?t:[0,0,0,0]}get showTrackingButton(){return this.printerIsPrinting&&this.sdCardFilePath===this.loadedFile}get printing_objects(){var e,t;return(t=(e=this.$store.state.printer.exclude_object)==null?void 0:e.objects)!=null?t:[]}printing_objectsChanged(){this.refreshPrintingObjects()}get excluded_objects(){var e,t;return(t=(e=this.$store.state.printer.exclude_object)==null?void 0:e.excluded_objects)!=null?t:[]}excluded_objectsChanged(){this.refreshPrintingObjects()}get nozzle_diameter(){var e,t,i,s;return(s=(i=(t=(e=this.$store.state.printer.configfile)==null?void 0:e.settings)==null?void 0:t.extruder)==null?void 0:i.nozzle_diameter)!=null?s:.4}async init(){var t,i,s,r,n;let e=(i=(t=this.$store.state.gcodeviewer)==null?void 0:t.canvasBackup)!=null?i:null;e===null?(e=document.createElement("canvas"),e.className="viewer",this.$refs.viewerCanvasContainer.appendChild(e),await this.$store.dispatch("gcodeviewer/setCanvasBackup",e)):(this.$refs.viewerCanvasContainer.appendChild(e),fe!=null&&fe.gcodeProcessor&&fe.gcodeProcessor.updateFilePosition(fe==null?void 0:fe.fileSize)),fe===null&&await this.viewerInit(e),this.registerProgressCallback(),((s=this.$route.query)==null?void 0:s.filename)&&this.loadedFile!==((n=(r=this.$route.query)==null?void 0:r.filename)==null?void 0:n.toString())&&(await this.sleep(1e3),await this.loadFile(this.$route.query.filename.toString()))}async viewerInit(e){fe=new ww(e),await fe.init(),fe.setBackgroundColor(this.backgroundColor),fe.bed.setBedColor(this.gridColor),fe.setCursorVisiblity(this.showCursor),fe.setZClipPlane(1e6,-1e6),fe.axes.show(this.showAxes),fe.bed.setDelta(this.kinematics.includes("delta")),this.bedMaxSize!==null&&(fe.bed.buildVolume.x.max=this.bedMaxSize[0],fe.bed.buildVolume.y.max=this.bedMaxSize[1],fe.bed.buildVolume.z.max=this.bedMaxSize[2]),this.bedMinSize!==null&&(fe.bed.buildVolume.x.min=this.bedMinSize[0],fe.bed.buildVolume.y.min=this.bedMinSize[1],fe.bed.buildVolume.z.min=this.bedMinSize[2]),fe.gcodeProcessor.useHighQualityExtrusion(this.hdRendering),fe.gcodeProcessor.updateForceWireMode(this.forceLineRendering),fe.gcodeProcessor.setAlpha(this.transparency),fe.gcodeProcessor.setVoxelMode(this.voxelMode),fe.gcodeProcessor.voxelWidth=this.voxelWidth,fe.gcodeProcessor.voxelHeight=this.voxelHeight,fe.gcodeProcessor.useSpecularColor(this.specularLighting),fe.gcodeProcessor.setLiveTracking(!1),fe.buildObjects.objectCallback=this.objectCallback,this.loadToolColors(this.extruderColors),fe.lastLoadFailed()&&(this.renderQuality=this.renderQualities[0],fe.updateRenderQuality(1),fe.clearLoadFlag())}registerProgressCallback(){fe&&(fe.gcodeProcessor.loadingProgressCallback=e=>{this.loadingPercent=Math.ceil(e*100),this.loading=this.loadingPercent<=99})}async cancelRendering(){fe&&(fe.gcodeProcessor.cancelLoad=!0,await this.sleep(1e3))}clearLoadedFile(){fe&&(this.scrubPlaying=!1,this.scrubFileSize=0,fe.clearScene(!0),this.loadedFile=null,this.tracking=!1)}chooseFile(){this.isBusy||this.fileInput.click()}finishLoad(){this.loading=!1,fe.setCursorVisiblity(this.showCursor),this.refreshPrintingObjects(),this.scrubFileSize=fe.fileSize,fe.gcodeProcessor.updateFilePosition(fe.fileSize)}refreshPrintingObjects(){let e=[];this.loadedFile===this.sdCardFilePath&&this.printing_objects.length&&this.printing_objects.forEach(t=>{const i=t.polygon.map(r=>r[0]),s=t.polygon.map(r=>r[1]);e.push({cancelled:this.excluded_objects.includes(t.name),name:t.name,x:[Math.min(...i),Math.max(...i)],y:[Math.min(...s),Math.max(...s)]})}),fe.buildObjects.loadObjectBoundaries(e),fe.buildObjects.showObjectSelection(this.showObjectSelection)}async fileSelected(e){var i,s;const t=new FileReader;t.addEventListener("load",async r=>{if(!r||!r.target)return;const n=r.target.result;typeof n=="string"&&(this.fileSize=n.length,await fe.processFile(n)),this.finishLoad()}),this.tracking=!1,(i=e.target.files)!=null&&i.length&&(this.loadedFile=(s=e==null?void 0:e.target)==null?void 0:s.files[0].name,t.readAsText(e.target.files[0])),e.target.value=""}async loadFile(e){this.downloadSnackbar.status=!0,this.downloadSnackbar.speed=0,this.downloadSnackbar.lastProgress.time=0,this.downloadSnackbar.filename=e.startsWith("gcodes/")?e.slice(7):e;const t=V0.CancelToken;this.downloadSnackbar.cancelTokenSource=t.source();const i=await V0.get(this.apiUrl+"/server/files/"+encodeURI(e),{cancelToken:this.downloadSnackbar.cancelTokenSource.token,responseType:"blob",onDownloadProgress:s=>{if(this.downloadSnackbar.percent=s.loaded*100/s.total,this.downloadSnackbar.lastProgress.time){const r=s.timeStamp-this.downloadSnackbar.lastProgress.time,n=s.loaded-this.downloadSnackbar.lastProgress.loaded;(r>1e3||this.downloadSnackbar.speed===0)&&(this.downloadSnackbar.speed=n/(r/1e3),this.downloadSnackbar.lastProgress.time=s.timeStamp,this.downloadSnackbar.lastProgress.loaded=s.loaded)}else this.downloadSnackbar.lastProgress.time=s.timeStamp;this.downloadSnackbar.total=s.total}}).then(s=>s.data.text()).catch(s=>{window.console.error(s.message)});this.downloadSnackbar.status=!1,this.loadedFile=this.downloadSnackbar.filename,fe.updateRenderQuality(this.renderQuality.value),await fe.processFile(i),this.loadingPercent=100,this.finishLoad(),this.scrubFileSize=fe.fileSize}cancelDownload(){this.downloadSnackbar.cancelTokenSource.cancel("User canceled download gcode file")}async sleep(e){await new Promise(t=>setTimeout(t,e))}async loadCurrentFile(){await this.loadFile("gcodes/"+this.sdCardFilePath),this.loadedFile=this.sdCardFilePath}async reloadViewer(){this.loading&&(fe.gcodeProcessor.cancelLoad=!0,await this.sleep(1e3)),this.reloadRequired=!1,this.loading=!0,this.loadingPercent=0,await fe.reload(),this.loadingPercent=100,this.finishLoad()}resetCamera(){fe.resetCamera()}setReloadRequiredFlag(){this.loadedFile&&this.loadedFile!=""&&(this.reloadRequired=!0)}async renderQualityChanged(e){fe&&fe.renderQuality!==e&&(fe.updateRenderQuality(e),await this.reloadViewer())}currentPositionChanged(e){if(fe){const t=[{axes:"X",position:e[0]},{axes:"Y",position:e[1]},{axes:"Z",position:e[2]}];fe.updateToolPosition(t)}}filePositionChanged(e){if(!fe)return;const t=350;e>0&&this.printerIsPrinting&&this.tracking&&e>t?fe.gcodeProcessor.updateFilePosition(e-t):fe.gcodeProcessor.updateFilePosition(fe.fileSize)}async trackingChanged(e){!fe||(e?(this.scrubPlaying=!1,fe.gcodeProcessor.updateFilePosition(0),fe==null||fe.forceRender()):(fe.gcodeProcessor.setLiveTracking(!1),await this.reloadViewer()))}printerIsPrintingChanged(){this.tracking=!1}get showCursor(){var e;return(e=this.$store.state.gui.gcodeViewer.showCursor)!=null?e:!1}set showCursor(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.showCursor",value:e})}showCursorChanged(e){fe==null||fe.setCursorVisiblity(e)}get showTravelMoves(){var e;return(e=this.$store.state.gui.gcodeViewer.showTravelMoves)!=null?e:!1}set showTravelMoves(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.showTravelMoves",value:e})}showTravelMovesChanged(e){fe==null||fe.toggleTravels(e)}get showObjectSelection(){var e;return(e=this.$store.state.gui.gcodeViewer.showObjectSelection)!=null?e:!1}set showObjectSelection(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.showObjectSelection",value:e})}showObjectSelectionChanged(e){fe==null||fe.buildObjects.showObjectSelection(e)}get hdRendering(){return this.$store.state.gui.gcodeViewer.hdRendering}set hdRendering(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.hdRendering",value:e})}async hdRenderingChanged(e){fe&&(fe.gcodeProcessor.useHighQualityExtrusion(e),await this.reloadViewer())}get forceLineRendering(){return this.$store.state.gui.gcodeViewer.forceLineRendering}set forceLineRendering(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.forceLineRendering",value:e})}async forceLineRenderingChanged(e){fe&&(fe.gcodeProcessor.updateForceWireMode(e),await this.reloadViewer())}get transparency(){return this.$store.state.gui.gcodeViewer.transparency}set transparency(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.transparency",value:e})}async transparencyChanged(e){fe&&(fe.gcodeProcessor.setAlpha(e),await this.reloadViewer())}get voxelMode(){return this.$store.state.gui.gcodeViewer.voxelMode}set voxelMode(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.voxelMode",value:e})}async voxelModeChanged(e){fe&&(fe.gcodeProcessor.setVoxelMode(e),fe.gcodeProcessor.voxelWidth=this.voxelWidth,fe.gcodeProcessor.voxelHeight=this.voxelHeight,await this.reloadViewer())}get voxelWidth(){var e;return(e=this.$store.state.gui.gcodeViewer.voxelWidth)!=null?e:1}set voxelWidth(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.voxelWidth",value:e})}get voxelHeight(){var e;return(e=this.$store.state.gui.gcodeViewer.voxelHeight)!=null?e:1}set voxelHeight(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.voxelHeight",value:e})}get specularLighting(){return this.$store.state.gui.gcodeViewer.specularLighting}set specularLighting(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.specularLighting",value:e})}async specularLightingChanged(e){fe&&fe.gcodeProcessor.useSpecularColor(e)}get extruderColors(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.extruderColors)!=null?t:!1}loadToolColors(e){fe&&e.length&&(fe.gcodeProcessor.resetTools(),e.forEach(t=>{fe.gcodeProcessor.addTool(t,this.nozzle_diameter)}),this.setReloadRequiredFlag())}extruderColorsChanged(e){fe&&e&&e.length&&(this.loadToolColors(e),this.setReloadRequiredFlag())}get colorMode(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.colorMode)!=null?t:2}set colorMode(e){this.$store.dispatch("gui/saveSetting",{name:"gcodeViewer.colorMode",value:e}),fe&&fe.gcodeProcessor.colorMode!==e&&(fe.gcodeProcessor.setColorMode(e),this.reloadViewer())}get backgroundColor(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.backgroundColor)!=null?t:"#121212"}backgroundColorChanged(e){!fe||fe.setBackgroundColor(e)}get gridColor(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.gridColor)!=null?t:"#B3B3B3"}gridColorChanged(e){!fe||fe.bed.setBedColor(e)}get showAxes(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.showAxes)!=null?t:!0}showAxesChanged(e){!fe||fe.axes.show(e)}get minFeed(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.minFeed)!=null?t:20}minFeedChanged(e){!fe||fe.gcodeProcessor.updateColorRate(e*60,this.maxFeed*60)}get maxFeed(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.maxFeed)!=null?t:100}maxFeedChanged(e){!fe||fe.gcodeProcessor.updateColorRate(this.minFeed*60,e*60)}get minFeedColor(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.minFeedColor)!=null?t:"#0000FF"}minFeedColorUpdated(e){!fe||(fe.gcodeProcessor.updateMinFeedColor(e),this.setReloadRequiredFlag())}get maxFeedColor(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.maxFeedColor)!=null?t:"#FF0000"}maxFeedColorUpdated(e){!fe||(fe.gcodeProcessor.updateMaxFeedColor(e),this.setReloadRequiredFlag())}get kinematics(){var e,t,i,s,r,n,o,l;return(l=(o=(i=(t=(e=this.$store.state.printer.configfile)==null?void 0:e.settings)==null?void 0:t.printer)==null?void 0:i.kinematics)!=null?o:(n=(r=(s=this.$store.state.gui)==null?void 0:s.gcodeViewer)==null?void 0:r.klipperCache)==null?void 0:n.kinematics)!=null?l:""}get bedMaxSize(){var e,t,i,s,r,n;return(n=(r=(e=this.$store.state.printer.toolhead)==null?void 0:e.axis_maximum)!=null?r:(s=(i=(t=this.$store.state.gui)==null?void 0:t.gcodeViewer)==null?void 0:i.klipperCache)==null?void 0:s.axis_maximum)!=null?n:null}get bedMinSize(){var e,t,i,s,r,n;return(n=(r=(e=this.$store.state.printer.toolhead)==null?void 0:e.axis_minimum)!=null?r:(s=(i=(t=this.$store.state.gui)==null?void 0:t.gcodeViewer)==null?void 0:i.klipperCache)==null?void 0:s.axis_minimum)!=null?n:null}kinematicsChanged(e){fe&&e&&fe.bed.setDelta(e.includes("delta"))}bedMinSizeChanged(e){fe&&e&&(fe.bed.buildVolume.x.min=e[0],fe.bed.buildVolume.y.min=e[1],fe.bed.buildVolume.z.min=e[2])}bedMaxSizeChanged(e){e&&fe&&(fe.bed.buildVolume.x.max=e[0],fe.bed.buildVolume.y.max=e[1],fe.bed.buildVolume.z.max=e[2])}get progressColor(){var e,t;return(t=(e=this.$store.state.gui.gcodeViewer)==null?void 0:e.progressColor)!=null?t:"#FFFFFF"}progressColorChanged(e){fe==null||fe.setProgressColor(e)}scrubPlayingChanged(e){e?(this.scrubInterval&&(clearInterval(this.scrubInterval),this.scrubInterval=void 0),this.scrubPlaying=!0,this.scrubPosition>=this.scrubFileSize&&(this.scrubPosition=0),fe.gcodeProcessor.updateFilePosition(this.scrubPosition-3e4),this.scrubInterval=setInterval(()=>{this.scrubPosition+=100*this.scrubSpeed,fe.gcodeProcessor.updateFilePosition(this.scrubPosition),(this.tracking||this.scrubPosition>=this.scrubFileSize)&&(this.scrubPlaying=!1)},200)):(this.scrubInterval&&clearInterval(this.scrubInterval),this.scrubPlaying=!1,this.scrubInterval=void 0)}get showScrubber(){return!this.tracking&&this.scrubFileSize>0}updateScrubPosition(e){this.tracking||fe.gcodeProcessor.updateFilePosition(e)}fastForward(){this.scrubPosition=this.scrubFileSize,fe.gcodeProcessor.updateFilePosition(this.scrubPosition)}objectCallback(e){var t;(e==null?void 0:e.cancelled)===!1&&(this.excludeObject.name=(t=e.name)!=null?t:"UNKNOWN",this.excludeObject.bool=!0)}cancelObject(){this.$socket.emit("printer.gcode.script",{script:"EXCLUDE_OBJECT NAME="+this.excludeObject.name}),this.excludeObject.bool=!1}};Ot([wg({type:String,default:"",required:!1})],Ct.prototype,"filename",2);Ot([jp("fileInput")],Ct.prototype,"fileInput",2);Ot([jp("viewerCanvasContainer")],Ct.prototype,"viewerCanvasContainer",2);Ot([Yp(200)],Ct.prototype,"handleResize",1);Ot([$t("printing_objects")],Ct.prototype,"printing_objectsChanged",1);Ot([$t("excluded_objects")],Ct.prototype,"excluded_objectsChanged",1);Ot([$t("renderQuality")],Ct.prototype,"renderQualityChanged",1);Ot([$t("currentPosition")],Ct.prototype,"currentPositionChanged",1);Ot([$t("filePosition")],Ct.prototype,"filePositionChanged",1);Ot([$t("tracking")],Ct.prototype,"trackingChanged",1);Ot([$t("printerIsPrinting")],Ct.prototype,"printerIsPrintingChanged",1);Ot([$t("showCursor")],Ct.prototype,"showCursorChanged",1);Ot([$t("showTravelMoves")],Ct.prototype,"showTravelMovesChanged",1);Ot([$t("showObjectSelection")],Ct.prototype,"showObjectSelectionChanged",1);Ot([$t("hdRendering")],Ct.prototype,"hdRenderingChanged",1);Ot([$t("forceLineRendering")],Ct.prototype,"forceLineRenderingChanged",1);Ot([$t("transparency")],Ct.prototype,"transparencyChanged",1);Ot([$t("voxelMode")],Ct.prototype,"voxelModeChanged",1);Ot([$t("specularLighting")],Ct.prototype,"specularLightingChanged",1);Ot([$t("extruderColors")],Ct.prototype,"extruderColorsChanged",1);Ot([$t("backgroundColor")],Ct.prototype,"backgroundColorChanged",1);Ot([$t("gridColor")],Ct.prototype,"gridColorChanged",1);Ot([$t("showAxes")],Ct.prototype,"showAxesChanged",1);Ot([$t("minFeed")],Ct.prototype,"minFeedChanged",1);Ot([$t("maxFeed")],Ct.prototype,"maxFeedChanged",1);Ot([$t("minFeedColor")],Ct.prototype,"minFeedColorUpdated",1);Ot([$t("maxFeedColor")],Ct.prototype,"maxFeedColorUpdated",1);Ot([$t("kinematics")],Ct.prototype,"kinematicsChanged",1);Ot([$t("bedMinSize",{deep:!0})],Ct.prototype,"bedMinSizeChanged",1);Ot([$t("bedMaxSize",{deep:!0})],Ct.prototype,"bedMaxSizeChanged",1);Ot([$t("progressColor")],Ct.prototype,"progressColorChanged",1);Ot([$t("scrubPlaying")],Ct.prototype,"scrubPlayingChanged",1);Ot([Yp(200),$t("scrubPosition")],Ct.prototype,"updateScrubPosition",1);Ct=Ot([Kp({components:{Panel:$p}})],Ct);var Lw=function(){var a=this,e=a.$createElement,t=a._self._c||e;return t("div",[t($p,{attrs:{title:a.panelTitle,icon:a.mdiVideo3d,"card-class":"gcode-viewer-panel","margin-bottom":!1},scopedSlots:a._u([{key:"buttons",fn:function(){return[t(ss,{directives:[{name:"show",rawName:"v-show",value:a.reloadRequired,expression:"reloadRequired"}],staticClass:"ml-3",attrs:{icon:a.$vuetify.breakpoint.xs,text:a.$vuetify.breakpoint.smAndUp,tile:"",color:"info"},on:{click:a.reloadViewer}},[t("span",{staticClass:"d-none d-sm-block"},[a._v(a._s(a.$t("GCodeViewer.ReloadRequired")))]),t(Sr,{staticClass:"d-sm-none"},[a._v(a._s(a.mdiReloadAlert))])],1),t(ss,{attrs:{icon:"",tile:""},on:{click:a.resetCamera}},[t(Sr,[a._v(a._s(a.mdiCameraRetake))])],1)]},proxy:!0}])},[t(k0,[t(dh,{class:a.showScrubber?"withScrubber":""},[t(pa,[t("div",{ref:"viewerCanvasContainer"})])],1),t(dh,{directives:[{name:"show",rawName:"v-show",value:a.showScrubber,expression:"showScrubber"}],staticClass:"scrubber"},[t(pa,{staticClass:"pt-0"},[t(Ng,{attrs:{hint:a.scrubPosition+"/"+a.scrubFileSize,max:a.scrubFileSize,dense:"",min:"0","persistent-hint":""},model:{value:a.scrubPosition,callback:function(i){a.scrubPosition=i},expression:"scrubPosition"}})],1),t(pa,{staticClass:"col-auto pt-0 text-center"},[t(ss,{staticClass:"px-2 minwidth-0",attrs:{color:"primary"},on:{click:function(i){a.scrubPlaying=!a.scrubPlaying}}},[a.scrubPlaying?t(Sr,[a._v(a._s(a.mdiPause))]):t(Sr,[a._v(a._s(a.mdiPlay))])],1),t(ss,{staticClass:"px-2 minwidth-0 mx-3",attrs:{color:"primary"},on:{click:a.fastForward}},[t(Sr,[a._v(a._s(a.mdiFastForward))])],1),t(Fg,{staticClass:"mt-3 mt-sm-0",attrs:{dense:"",mandatory:"",rounded:""},model:{value:a.scrubSpeed,callback:function(i){a.scrubSpeed=i},expression:"scrubSpeed"}},[t(ss,{attrs:{value:1}},[a._v("1x")]),t(ss,{attrs:{value:2}},[a._v("2x")]),t(ss,{attrs:{value:5}},[a._v("5x")]),t(ss,{attrs:{value:10}},[a._v("10x")]),t(ss,{attrs:{value:20}},[a._v("20x")])],1)],1)],1),t(dh,{staticClass:"mt-0 d-flex align-top"},[t(pa,[t(dh,[t(pa,{staticClass:"d-flex align-content-space-around justify-center flex-wrap flex-md-nowrap col-12 col-md-4",attrs:{"order-md":"2"}},[a.loadedFile===null?[a.sdCardFilePath!==""&&a.sdCardFilePath!==a.loadedFile?t(ss,{staticClass:"mr-3",on:{click:a.loadCurrentFile}},[a._v(" "+a._s(a.$t("GCodeViewer.LoadCurrentFile"))+" ")]):a._e(),t(ss,{on:{click:a.chooseFile}},[a._v(a._s(a.$t("GCodeViewer.LoadLocal")))])]:[a.showTrackingButton?t(ss,{staticClass:"mr-3",on:{click:function(i){a.tracking=!a.tracking}}},[t(Sr,{staticClass:"mr-2",domProps:{innerHTML:a._s(a.tracking?a.mdiToggleSwitch:a.mdiToggleSwitchOffOutline)}}),a._v(" "+a._s(a.$t("GCodeViewer.Tracking"))+" ")],1):a._e(),t(ss,{on:{click:a.clearLoadedFile}},[t(Sr,{attrs:{left:""}},[a._v(a._s(a.mdiBroom))]),a._v(" "+a._s(a.$t("GCodeViewer.ClearLoadedFile"))+" ")],1)]],2),t(pa,{staticClass:"col-12 col-sm-6 col-md-4"},[t(G0,{attrs:{items:a.colorModes,label:a.$t("GCodeViewer.ColorMode"),"item-text":"text",dense:"","hide-details":"",outlined:""},model:{value:a.colorMode,callback:function(i){a.colorMode=i},expression:"colorMode"}})],1),t(pa,{staticClass:"col-12 col-sm-6 col-md-4 d-flex",attrs:{"order-md":"3"}},[t(G0,{attrs:{items:a.renderQualities,label:a.$t("GCodeViewer.RenderQuality"),"item-text":"label",dense:"","hide-details":"",outlined:""},model:{value:a.renderQuality,callback:function(i){a.renderQuality=i},expression:"renderQuality"}}),t(Lg,{attrs:{"offset-y":!0,"offset-x":!0,top:"","close-on-content-click":!1,title:a.$t("Files.SetupCurrentList")},scopedSlots:a._u([{key:"activator",fn:function(i){var s=i.on,r=i.attrs;return[t(ss,a._g(a._b({staticClass:"minwidth-0 px-2 ml-3"},"v-btn",r,!1),s),[t(Sr,[a._v(a._s(a.mdiCog))])],1)]}}])},[t(Bg,[t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.ShowToolhead")},model:{value:a.showCursor,callback:function(i){a.showCursor=i},expression:"showCursor"}})],1),t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.ShowTravelMoves")},model:{value:a.showTravelMoves,callback:function(i){a.showTravelMoves=i},expression:"showTravelMoves"}})],1),a.loadedFile===a.sdCardFilePath&&a.printing_objects.length?t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.ShowObjectSelection")},model:{value:a.showObjectSelection,callback:function(i){a.showObjectSelection=i},expression:"showObjectSelection"}})],1):a._e(),t(Ug),t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.HDRendering")},model:{value:a.hdRendering,callback:function(i){a.hdRendering=i},expression:"hdRendering"}})],1),t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.ForceLineRendering")},model:{value:a.forceLineRendering,callback:function(i){a.forceLineRendering=i},expression:"forceLineRendering"}})],1),t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.Transparency")},model:{value:a.transparency,callback:function(i){a.transparency=i},expression:"transparency"}})],1),t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.VoxelMode")},model:{value:a.voxelMode,callback:function(i){a.voxelMode=i},expression:"voxelMode"}})],1),t(yn,{staticClass:"minHeight36"},[t(An,{staticClass:"mt-0",attrs:{"hide-details":"",label:a.$t("GCodeViewer.SpecularLighting")},model:{value:a.specularLighting,callback:function(i){a.specularLighting=i},expression:"specularLighting"}})],1)],1)],1)],1)],1)],1)],1),t("input",{ref:"fileInput",attrs:{accept:".g,.gcode,.gc,.gco,.nc,.ngc,.tap",hidden:"",multiple:"",type:"file"},on:{change:a.fileSelected}})],1),t("resize-observer",{on:{notify:a.handleResize}})],1),t(z0,{attrs:{timeout:-1,value:!0,fixed:"",right:"",bottom:"",dark:""},scopedSlots:a._u([{key:"action",fn:function(i){var s=i.attrs;return[t(ss,a._b({staticStyle:{"min-width":"auto"},attrs:{color:"red",text:""},on:{click:function(r){return a.cancelRendering()}}},"v-btn",s,!1),[t(Sr,{staticClass:"0"},[a._v(a._s(a.mdiClose))])],1)]}}]),model:{value:a.loading,callback:function(i){a.loading=i},expression:"loading"}},[t("div",[a._v(" "+a._s(a.$t("GCodeViewer.Rendering"))+" - "+a._s(a.loadingPercent)+"% "),t("br"),t("strong",[a._v(a._s(a.loadedFile))])]),t(Tu,{staticClass:"mt-2",attrs:{value:a.loadingPercent}})],1),t(z0,{attrs:{timeout:-1,value:!0,fixed:"",right:"",bottom:"",dark:""},scopedSlots:a._u([{key:"action",fn:function(i){var s=i.attrs;return[t(ss,a._b({staticStyle:{"min-width":"auto"},attrs:{color:"red",text:""},on:{click:a.cancelDownload}},"v-btn",s,!1),[t(Sr,{staticClass:"0"},[a._v(a._s(a.mdiClose))])],1)]}}]),model:{value:a.downloadSnackbar.status,callback:function(i){a.$set(a.downloadSnackbar,"status",i)},expression:"downloadSnackbar.status"}},[a.downloadSnackbar.total>0?[t("div",[a._v(" "+a._s(a.$t("GCodeViewer.Downloading"))+" - "+a._s(Math.round(a.downloadSnackbar.percent))+" % @ "+a._s(a.formatFilesize(Math.round(a.downloadSnackbar.speed)))+"/s "),t("br"),t("strong",[a._v(a._s(a.downloadSnackbar.filename))])]),t(Tu,{staticClass:"mt-2",attrs:{value:a.downloadSnackbar.percent}})]:[t("div",[a._v(" "+a._s(a.$t("GCodeViewer.Downloading"))+" "),t("br"),t("strong",[a._v(a._s(a.downloadSnackbar.filename))])]),t(Tu,{staticClass:"mt-2",attrs:{indeterminate:""}})]],2),t(Vg,{attrs:{"max-width":"400"},model:{value:a.excludeObject.bool,callback:function(i){a.$set(a.excludeObject,"bool",i)},expression:"excludeObject.bool"}},[t(kg,[t(Gg,{attrs:{flat:"",dense:""}},[t(zg,[t("span",{staticClass:"subheading"},[t(Sr,{attrs:{left:""}},[a._v(a._s(a.mdiSelectionRemove))]),a._v(" "+a._s(a.$t("Panels.StatusPanel.ExcludeObject.ExcludeObjectHeadline"))+" ")],1)])],1),t(k0,{staticClass:"mt-3"},[a._v(" "+a._s(a.$t("Panels.StatusPanel.ExcludeObject.ExcludeObjectText",{name:a.excludeObject.name}))+" ")]),t(Wg,[t(Hg),t(ss,{attrs:{text:""},on:{click:function(i){a.excludeObject.bool=!1}}},[a._v(" "+a._s(a.$t("Panels.StatusPanel.ExcludeObject.Cancel"))+" ")]),t(ss,{attrs:{color:"primary",text:""},on:{click:a.cancelObject}},[a._v(" "+a._s(a.$t("Panels.StatusPanel.ExcludeObject.ExcludeObject"))+" ")])],1)],1)],1)],1)},Bw=[];const zp={};var Uw=qp(Ct,Lw,Bw,!1,Vw,"7445942e",null,null);function Vw(a){for(let e in zp)this[e]=zp[e]}const gg=function(){return Uw.exports}();var kw=Object.defineProperty,Gw=Object.getOwnPropertyDescriptor,zw=(a,e,t,i)=>{for(var s=i>1?void 0:i?Gw(e,t):e,r=a.length-1,n;r>=0;r--)(n=a[r])&&(s=(i?n(e,t,s):n(s))||s);return i&&s&&kw(e,t,s),s};let Ed=class extends Hp(Xp){};Ed=zw([Kp({components:{Viewer:gg}})],Ed);var Ww=function(){var a=this,e=a.$createElement,t=a._self._c||e;return t(gg)},Hw=[];const Wp={};var Xw=qp(Ed,Ww,Hw,!1,Yw,null,null,null);function Yw(a){for(let e in Wp)this[e]=Wp[e]}const jw=function(){return Xw.exports}();export{jw as default};
